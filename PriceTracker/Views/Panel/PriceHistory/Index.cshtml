@using Newtonsoft.Json

@{
    ViewData["Title"] = "Historia Cen";
    var latestScrap = ViewBag.LatestScrap as PriceTracker.Models.ScrapHistoryClass;
    var storeId = ViewBag.StoreId;
    var categories = ViewBag.Categories as List<string>;
    var flags = ViewBag.Flags as List<PriceTracker.Models.FlagsClass>;
}

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="Vert">
    <div class="Page-Box">
        <div class="Page-Box-Container">
            <div class="Page-Box-Category">
                <div class="Category-Container-Title">Grupy cenowe</div>
                <div class="side-chart-box">
                    <canvas id="colorChart"></canvas>
                </div>
                <div class="store-section">
                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prToHighCheckbox" value="prToHigh">
                        <label class="form-check-label" for="prToHighCheckbox">Za wysoka cena</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prMidCheckbox" value="prMid">
                        <label class="form-check-label" for="prMidCheckbox">Mid cena</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prGoodCheckbox" value="prGood">
                        <label class="form-check-label" for="prGoodCheckbox">Top cena</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prIdealCheckbox" value="prIdeal">
                        <label class="form-check-label" for="prIdealCheckbox">Idealna cena</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prToLowCheckbox" value="prToLow">
                        <label class="form-check-label" for="prToLowCheckbox">Cena za niska</label>
                    </div>
                    <div class="price-range-settings">
                        <div class="color-circle prIdeal-circle"></div>
                        <label for="price1"></label>
                        <input type="number" id="price1" value="@ViewBag.SetPrice1" step="0.01" min="0.01"> PLN
                    </div>
                    <div class="price-range-settings">
                        <div class="color-circle prMid-circle"></div>
                        <label for="price2"></label>
                        <input type="number" id="price2" value="@ViewBag.SetPrice2" step="0.01" min="0.01"> PLN
                    </div>
                    <button class="Button-Page-Small" style="margin-top: 16px;" id="savePriceValues">Zapisz</button>
                </div>
                <div class="filterBox">

                    <div class="Category-Container-Select" style="margin-top:-2px;">Flagi  <a asp-controller="Flags" asp-action="List" asp-route-storeId="@ViewBag.StoreId" class="link-line">+ Dodaj Flage</a></div>
                    <div class="store-section">
                    
                        @foreach (var flag in flags)
                        {
                            <div class="form-check">
                                <input class="form-check-input flagFilter" type="checkbox" id="flagCheckbox_@flag.FlagId" value="@flag.FlagId">
                                <label class="form-check-label" for="flagCheckbox_@flag.FlagId">@flag.FlagName</label>
                            </div>
                        }

                    </div>

                    <div class="Category-Container-Select" >Bidowanie</div>
                    <div class="store-section">

                        <div class="form-check">
                            <input class="form-check-input bidFilter" type="checkbox" id="bidFilter">
                            <label class="form-check-label" for="bidFilter">Bid</label>
                        </div>

                    </div>
                    <div class="Category-Container-Select">Pozycja</div>
                    <div class="store-section">

                        <div class="form-check">
                            <input class="form-check-input positionFilter" type="checkbox" id="position1" value="1">
                            <label class="form-check-label" for="position1">1 miejsce</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input positionFilter" type="checkbox" id="position2" value="2">
                            <label class="form-check-label" for="position2">2 miejsce</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input positionFilter" type="checkbox" id="position3" value="3">
                            <label class="form-check-label" for="position3">3 miejsce</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input positionFilter" type="checkbox" id="position4" value="4">
                            <label class="form-check-label" for="position4">4 miejsce</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input positionFilter" type="checkbox" id="position5" value="5">
                            <label class="form-check-label" for="position5">5 miejsce</label>
                        </div>

                    </div>
                    <div class="Category-Container-Select">Wysyłka (ty)</div>
                    <div class="store-section">
                        <div class="filter-category">

                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery1MyStore" value="1">
                                <label class="form-check-label" for="delivery1MyStore">Wysyłka w 1 dzień</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery3MyStore" value="3">
                                <label class="form-check-label" for="delivery3MyStore">Wysyłka w 3 dni</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery7MyStore" value="7">
                                <label class="form-check-label" for="delivery7MyStore">Wysyłka w 7 dni</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery14MyStore" value="14">
                                <label class="form-check-label" for="delivery14MyStore">Wysyłka w 14 dni</label>
                            </div>
                        </div>
                        <div class="Category-Container-Select">Wysyłka (konkurencja)</div>
                        <div class="store-section">
                            <div class="filter-category">

                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery1Competitor" value="1">
                                    <label class="form-check-label" for="delivery1Competitor">Wysyłka w 1 dzień</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery3Competitor" value="3">
                                    <label class="form-check-label" for="delivery3Competitor">Wysyłka w 3 dni</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery7Competitor" value="7">
                                    <label class="form-check-label" for="delivery7Competitor">Wysyłka w 7 dni</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery14Competitor" value="14">
                                    <label class="form-check-label" for="delivery14Competitor">Wysyłka w 14 dni</label>
                                </div>
                            </div>
                        </div>
                        <div class="Category-Container-Select">Zmieniona cena</div>
                        <div class="store-section">
                            <div class="filter-category">
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="externalPriceYes" value="yes">
                                    <label class="form-check-label" for="externalPriceYes">Tak</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="externalPriceNo" value="no">
                                    <label class="form-check-label" for="externalPriceNo">Nie</label>
                                </div>
                            </div>
                        </div>


                    </div>


                </div>
               

            </div>
            <div class="Horizontal">
                <div class="order-upper-box">

                    <input type="text" id="productSearch" placeholder="Wyszukaj produkt">
                    <form id="filterForm">
                        <select id="category" name="category" class="DropDown">
                            <option value="">Wszystkie kategorie</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                    </form>
                    <div>

                        <select id="competitorStoreSelect" name="competitorStore" class="DropDown">
                            <option value="">Najlepsza cena</option>
                        </select>
                    </div>
                    <button class="Button-Page-Small-b" id="updatePricesButton">API</button>
                   

                    <div class="form-check-orders">
                        <div>
                            <p><strong>Sklep:</strong> <span>@ViewBag.StoreName</span></p>
                            <p><strong>Ceny:</strong> <span id="totalPriceCount">0</span></p>
                        </div>
                    </div>
                    <div class="form-check-orders">

                        <div>
                            <p><strong>Scrapowane:</strong> @ViewBag.ScrapedProducts</p>
                            <p><strong>Odrzucone:</strong> <span id="missedProductsCount">0</span></p>
                        </div>

                    </div>
                    <div class="form-check-orders">
                        <div>
                            <p><strong>ID Scrapowania:</strong> @latestScrap?.Id</p>
                            <p><strong>Wykonano:</strong> @latestScrap?.Date</p>

                        </div>
                    </div>

                  

                </div>

              
                <div class="price-box-column-category" id="displayedProductCount">
                </div>
            
                <div class="Vert-table">
                    <div id="priceContainer" class="price-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script> <!-- SignalR library -->
    <script>
        var storeId = '@storeId';
    </script>
    <script>
        var flags = @Html.Raw(JsonConvert.SerializeObject(ViewBag.Flags));
    </script>
    <script src="~/js/member/pricehistory.js"></script>
    <script>
        $(document).ready(function () {
            var connection = new signalR.HubConnectionBuilder().withUrl("/scrapingHub").build();

            connection.on("ReceiveProgressUpdate", function (processedCount, totalProducts, updatedCount, skippedCount) {
                var percentage = Math.round((processedCount / totalProducts) * 100);
                var progressBarInner = document.getElementById("progressBarInner");
                var progressText = document.getElementById("progressText");

                progressBarInner.style.width = percentage + "%";
                progressBarInner.innerHTML = percentage + "%";
                progressText.innerHTML = `Zaktualizowano ceny dla ${updatedCount}/${totalProducts} produktów. Pominęto ${skippedCount} produktów.`;
            });

            connection.start().then(function () {
                console.log("SignalR connected.");
            }).catch(function (err) {
                return console.error(err.toString());
            });

            $('#updatePricesButton').on('click', function () {
                $('#updatePricesModal').modal('show');
            });

            $('#confirmUpdatePrices').on('click', function () {
                $('#updateStatusMessage').hide();
                $('#updateProgress').show();
                $('#cancelUpdatePrices').hide();
                $('#confirmUpdatePrices').prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("UpdatePricesFromExternalStore", "PriceHistory")',
                    type: 'POST',
                    data: {
                        storeId: storeId
                    },
                    success: function (data) {
                        $('#updateProgress').hide();
                        $('#updateStatusMessage').show().text('Aktualizacja zakończona. Zaktualizowano ceny dla ' + data.updatedCount + ' produktów. Pominęto ' + data.skippedCount + ' produktów.');
                        $('#cancelUpdatePrices').show();
                        $('#confirmUpdatePrices').prop('disabled', false);
                    },
                    error: function () {
                        $('#updateProgress').hide();
                        $('#updateStatusMessage').show().text('Wystąpił błąd podczas aktualizacji cen.');
                        $('#cancelUpdatePrices').show();
                        $('#confirmUpdatePrices').prop('disabled', false);
                    }
                });
            });

            $('#cancelUpdatePrices').on('click', function () {
                $('#updatePricesModal').modal('hide');
            });
        });
    </script>
}

<div class="modal fade" id="updatePricesModal" tabindex="-1" role="dialog" aria-labelledby="updatePricesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="updatePricesModalLabel">Aktualizuj Ceny API</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="updateStatusMessage">Czy na pewno chcesz zaktualizować ceny produktów ze zewnętrznego sklepu?</p>
                <div id="updateProgress" style="display: none;">
                    <p>Proszę czekać, trwa aktualizacja...</p>
                    <div class="progress">
                        <div id="progressBarInner" class="progress-bar" role="progressbar" style="width: 0%; background-color: #004552;">
                            0%
                        </div>
                    </div>
                    <p id="progressText"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="Button-Page-Small-r" id="cancelUpdatePrices" data-dismiss="modal">Zamknij</button>
                <button type="button" class="Button-Page-Small-b" id="confirmUpdatePrices">Aktualizuj Ceny API</button>
            </div>
        </div>
    </div>
</div>








<div id="flagModal" class="modal">
    <div class="modal-content">
        <div class="price-box-space">
            <div class="price-box-column-name">Przypisz flagi do produktu</div>
            <span class="close">&times;</span>
        </div>
        <div id="flagCheckboxes">
            @if (flags != null)
            {
                @foreach (var flag in flags)
                {
                    <label><input type="checkbox" class="form-check-input flagCheckbox" value="@flag.FlagId"> @flag.FlagName</label>
                    <br />
                }
            }
        </div>
        <button class="Button-Page-Small" id="saveFlagsButton">Zapisz</button>
    </div>
</div>
