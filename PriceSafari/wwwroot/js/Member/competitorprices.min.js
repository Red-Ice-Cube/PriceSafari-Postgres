const loadedPrices = {}; let allProducts = {}; function loadScrapHistoryOptions(e, t) { fetch(`/Competitors/GetScrapHistoryIds?storeId=${e}`).then((e => { if (!e.ok) throw new Error(`B³¹d HTTP! Status: ${e.status}`); return e.json() })).then((o => { const r = document.getElementById("scrapHistoryCheckboxes"); if (!r) return void console.error("Kontener #scrapHistoryCheckboxes nie znaleziony."); r.innerHTML = ""; let n = null; o.sort(((e, t) => new Date(t.date) - new Date(e.date))), o.forEach(((o, d) => { const a = document.createElement("label"); a.className = "form-check-label", a.style.display = "block"; const c = document.createElement("input"); c.type = "checkbox", c.value = o.id, c.dataset.date = o.date, c.className = "form-check-input deliveryFilterCompetitor", c.addEventListener("change", (() => { c.checked ? loadCompetitorPrices([o.id], e, t) : (delete loadedPrices[o.id], renderPrices()) })); const i = new Date(o.date), s = `${i.getDate().toString().padStart(2, "0")}.${(i.getMonth() + 1).toString().padStart(2, "0")}.${i.getFullYear()}`; a.appendChild(c), a.appendChild(document.createTextNode(` ${s}`)), r.appendChild(a), 0 === d && (n = c) })), n && (n.checked = !0, loadCompetitorPrices([n.value], e, t)) })).catch((e => console.error("B³¹d ³adowania opcji historii analiz:", e))) } function loadCompetitorPrices(e, t, o) { e.forEach((e => { if ("loading" === loadedPrices[e]) return; loadedPrices[e] = "loading"; const r = { storeId: t, competitorStoreName: o, scrapHistoryId: parseInt(e) }; fetch("/Competitors/GetCompetitorPrices", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(r) }).then((t => t.ok ? t.json() : (delete loadedPrices[e], t.text().then((e => { throw new Error(`B³¹d HTTP! Status: ${t.status}, Wiadomoœæ: ${e}`) }))))).then((t => { loadedPrices[e] = t, renderPrices() })).catch((t => { console.error(`B³¹d ³adowania cen konkurenta dla scrapId ${e}:`, t), "loading" === loadedPrices[e] && delete loadedPrices[e], renderPrices() })) })) } function renderPrices() { const e = document.getElementById("priceTableBody"); if (!e) return; e.innerHTML = ""; const t = {}, o = Object.keys(loadedPrices).filter((e => loadedPrices[e] && "loading" !== loadedPrices[e])); o.forEach((e => { loadedPrices[e].forEach((o => { t[o.productId] || (t[o.productId] = { productName: o.productName, mainUrl: o.productMainUrl, data: {}, ourData: {} }), t[o.productId].data[e] = o.price, t[o.productId].ourData[e] = o.ourPrice })) })), allProducts = t; const r = e.closest("table"); if (!r) return; const n = r.querySelector("thead"); n || (n = r.insertBefore(document.createElement("thead"), r.firstChild)); let d = n.querySelector("tr"); d || (d = n.appendChild(document.createElement("tr"))), d.innerHTML = '<th class="sticky-col">Produkt</th>'; const a = o.sort(((e, t) => { const o = document.querySelector(`.deliveryFilterCompetitor[value="${e}"]`), r = document.querySelector(`.deliveryFilterCompetitor[value="${t}"]`); return o?.dataset?.date && r?.dataset?.date ? new Date(o.dataset.date) - new Date(r.dataset.date) : 0 })); a.forEach((e => { const t = document.createElement("th"), o = document.querySelector(`.deliveryFilterCompetitor[value="${e}"]`); if (o?.dataset?.date) { const e = new Date(o.dataset.date); t.textContent = `${e.getDate().toString().padStart(2, "0")}.${(e.getMonth() + 1).toString().padStart(2, "0")}.${e.getFullYear()}` } else t.textContent = `Dane (${e})`; d.appendChild(t) })), displayProducts(allProducts, a) } function filterProducts(e) { const t = e.toLowerCase(), o = {}; for (const [e, r] of Object.entries(allProducts)) r.productName && r.productName.toLowerCase().includes(t) && (o[e] = r); displayProducts(o, Object.keys(loadedPrices).filter((e => loadedPrices[e] && "loading" !== loadedPrices[e])).sort(((e, t) => { const o = document.querySelector(`.deliveryFilterCompetitor[value="${e}"]`), r = document.querySelector(`.deliveryFilterCompetitor[value="${t}"]`); return o?.dataset?.date && r?.dataset?.date ? new Date(o.dataset.date) - new Date(r.dataset.date) : 0 }))) } function displayProducts(e, t) { const o = document.getElementById("priceTableBody"); if (!o) return; o.innerHTML = ""; const r = document.getElementById("filterIncrease")?.checked || !1, n = document.getElementById("filterDecrease")?.checked || !1, d = document.getElementById("filterChange")?.checked || !1; let a = 0; for (const c of Object.keys(e)) { const i = e[c]; let s = !1, l = !1, u = !1; const p = document.createElement("tr"), m = document.createElement("td"), f = document.createElement("div"); f.className = "product-info-cell"; const y = document.createElement("img"); y.src = i.mainUrl ? i.mainUrl : "/images/placeholder.png", y.alt = i.productName || "Obrazek produktu", y.onerror = function () { this.src = "/images/placeholder.png", this.onerror = null }, f.appendChild(y); const h = document.createElement("span"); h.className = "product-name-text", h.textContent = i.productName || "Brak nazwy", f.appendChild(h), m.appendChild(f), p.appendChild(m), t.forEach(((e, o) => { const r = document.createElement("td"); r.classList.add("nowrap"); let n = '<div class="flex-row">'; const d = i.ourData[e], a = i.data[e]; let m = "number" == typeof d ? d.toFixed(2) : "B/D", f = `<div class="Price-box-content-o flex-column">\n                                    <div class="priceBox-style-o ${"B/D" === m ? "no-price" : ""}">`; if (o > 0 && "number" == typeof d) { const e = t[o - 1], r = i.ourData[e]; if ("number" == typeof r) { const e = d - r; if (0 !== e) { s = !0; const t = 0 === r ? e > 0 ? 100 : -100 : e / r * 100, o = e > 0; o ? l = !0 : u = !0; const n = o ? "&uarr;" : "&darr;"; f += `<div class="${o ? "priceBox-diff-down" : "priceBox-diff-up"}">${e.toFixed(2)} PLN (${t.toFixed(2)}%) ${n}</div>` } } } f += `<div class="PriceTagBox-o">${"B/D" !== m ? `${m} PLN` : m}</div></div>`, f += `<div class="Price-box-content-o-t">${"undefined" != typeof storeName ? storeName : "Nasz Sklep"}</div></div>`, n += f; let y = "number" == typeof a ? a.toFixed(2) : "B/D", h = `<div class="Price-box-content-c flex-column">\n                                            <div class="priceBox-style-c ${"B/D" === y ? "no-price" : ""}">`; if (h += `<div class="PriceTagBox-c">${"B/D" !== y ? `${y} PLN` : y}</div>`, o > 0 && "number" == typeof a) { const e = t[o - 1], r = i.data[e]; if ("number" == typeof r) { const e = a - r; if (0 !== e) { s = !0; const t = 0 === r ? e > 0 ? 100 : -100 : e / r * 100, o = e > 0; o ? l = !0 : u = !0; const n = o ? "&uarr;" : "&darr;"; h += `<div class="${o ? "priceBox-diff-down" : "priceBox-diff-up"}">${e.toFixed(2)} PLN (${t.toFixed(2)}%) ${n}</div>` } } } h += "</div>", h += `<div class="Price-box-content-c-t">${"undefined" != typeof competitorStoreName ? competitorStoreName : "Konkurent"}</div></div>`, n += h, n += "</div>", r.innerHTML = n, r.addEventListener("click", (t => { if ("A" === t.target.tagName || t.target.closest("a")) return; const o = `/PriceHistory/Details?productId=${c}&scrapId=${e}`; window.open(o, "_blank") })), p.appendChild(r) })); let P = !1; r || n || d ? (r && l && (P = !0), n && u && (P = !0), d && s && (P = !0)) : P = !0, P && (o.appendChild(p), a++) } const c = document.getElementById("scrapable-count"); c && (c.textContent = a) } document.addEventListener("DOMContentLoaded", (() => { if ("undefined" == typeof storeId || "undefined" == typeof competitorStoreName || "undefined" == typeof storeName) { console.error("Kluczowe zmienne globalne (storeId, competitorStoreName, storeName) nie s¹ zdefiniowane."); const e = document.querySelector(".table-container"); return void (e && (e.innerHTML = '<p style="color:red; text-align:center;">B³¹d konfiguracji: Brak niezbêdnych danych sklepu.</p>')) } loadScrapHistoryOptions(storeId, competitorStoreName); const e = document.getElementById("filterIncrease"), t = document.getElementById("filterDecrease"), o = document.getElementById("filterChange"); e && e.addEventListener("change", (() => renderPrices())), t && t.addEventListener("change", (() => renderPrices())), o && o.addEventListener("change", (() => renderPrices())); const r = document.getElementById("productSearch"); r && r.addEventListener("keyup", (function () { filterProducts(this.value) })) }));