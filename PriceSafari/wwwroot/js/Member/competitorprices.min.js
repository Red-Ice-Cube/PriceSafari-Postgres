function loadScrapHistoryOptions(e, t) { fetch(`/Competitors/GetScrapHistoryIds?storeId=${e}`).then((e => e.json())).then((o => { const c = document.getElementById("scrapHistoryCheckboxes"); let r = null; o.forEach(((o, d) => { const n = document.createElement("label"); n.className = "form-check-label", n.style.display = "block"; const a = document.createElement("input"); a.type = "checkbox", a.value = o.id, a.dataset.date = o.date, a.className = "form-check-input deliveryFilterCompetitor", a.addEventListener("change", (() => { a.checked ? loadCompetitorPrices([o.id], e, t) : (delete loadedPrices[o.id], renderPrices()) })); const i = new Date(o.date), s = `${i.getDate()}.${i.getMonth() + 1}.${i.getFullYear()}`; n.appendChild(a), n.appendChild(document.createTextNode(s)), c.appendChild(n), 0 === d && (r = a) })), r && (r.checked = !0, loadCompetitorPrices([r.value], e, t)) })).catch((e => console.error("Error loading scrap history options:", e))) } document.addEventListener("DOMContentLoaded", (() => { loadScrapHistoryOptions(storeId, competitorStoreName), document.querySelectorAll('input[type="checkbox"]').forEach((e => { e.addEventListener("change", renderPrices) })), document.getElementById("productSearch").addEventListener("keyup", (function () { filterProducts(this.value) })) })); const loadedPrices = {}; let allProducts = {}; function loadCompetitorPrices(e, t, o) { e.forEach((e => { const c = { storeId: t, competitorStoreName: o, scrapHistoryId: parseInt(e) }; fetch("/Competitors/GetCompetitorPrices", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(c) }).then((e => e.json())).then((t => { loadedPrices[e] = t, renderPrices() })).catch((e => console.error("Error loading competitor prices:", e))) })) } function renderPrices() { document.getElementById("priceTableBody").innerHTML = ""; const e = {}; for (const [t, o] of Object.entries(loadedPrices)) o.forEach((o => { e[o.productId] || (e[o.productId] = { productName: o.productName, scrapHistoryId: t, data: {}, ourData: {}, offerUrl: o.offerUrl }), e[o.productId].data[t] = o.price, e[o.productId].ourData[t] = o.ourPrice })); allProducts = e; const t = document.querySelector("table thead tr"); t.innerHTML = "<th>Produkt</th>"; Object.keys(loadedPrices).forEach((e => { const o = document.createElement("th"), c = document.querySelector(`input[type="checkbox"][value="${e}"]`); if (c) { const e = new Date(c.dataset.date), t = `${e.getDate()}.${e.getMonth() + 1}.${e.getFullYear()}`; o.textContent = `${t}` } else o.textContent = `Cena (${e})`; t.appendChild(o) })), displayProducts(e) } function filterProducts(e) { const t = {}; for (const [o, c] of Object.entries(allProducts)) c.productName.toLowerCase().includes(e.toLowerCase()) && (t[o] = c); displayProducts(t) } function displayProducts(e) { const t = document.getElementById("priceTableBody"); t.innerHTML = ""; const o = document.getElementById("filterIncrease").checked, c = document.getElementById("filterDecrease").checked, r = document.getElementById("filterChange").checked; let d = 0; for (const [n, a] of Object.entries(e)) { let e = !0, i = !1, s = !1, l = !1; const u = [], p = document.createElement("tr"); p.innerHTML = `<td><div class="price-box-column-name-com">${a.productName}</div></td>`; const m = Object.keys(loadedPrices); m.forEach(((e, t) => { const o = document.createElement("td"); let c = '<div class="flex-row">'; const r = a.ourData[e] ? a.ourData[e].toFixed(2) : "B/D"; let d = `<div class="priceBox-style-o ${"B/D" === r ? "no-price" : ""}">`; if (t > 0 && "B/D" !== r) { const o = m[t - 1], c = a.ourData[o] ? a.ourData[o] : null; if (null !== c) { const t = a.ourData[e] - c, o = (t / c * 100).toFixed(2); if (0 !== t) { const e = t > 0, c = e ? "increase" : "decrease"; d += `<div class="${e ? "priceBox-diff-down" : "priceBox-diff-up"}">\n                                ${t.toFixed(2)} PLN (${o}%) ${e ? "&uarr;" : "&darr;"}\n                            </div>`, i = !0, e ? s = !0 : l = !0, u.push({ change: c }) } } } d += `<div class="PriceTagBox-o">${"B/D" !== r ? `${r} PLN` : r}</div></div>`, d += `<div class="Price-box-content-o-t">${storeName}</div>`, c += `<div class="Price-box-content-o flex-column">${d}</div>`; const f = a.data[e] ? a.data[e].toFixed(2) : "B/D"; let h = `<div class="priceBox-style-c ${"B/D" === f ? "no-price" : ""}">`; if (h += `<div class="PriceTagBox-c">${"B/D" !== f ? `${f} PLN` : f}</div>`, t > 0 && "B/D" !== f) { const o = m[t - 1], c = a.data[o] ? a.data[o] : null; if (null !== c) { const t = a.data[e] - c, o = (t / c * 100).toFixed(2); if (0 !== t) { const e = t > 0; h += `<div class="${e ? "priceBox-diff-down" : "priceBox-diff-up"}">\n                                ${t.toFixed(2)} PLN (${o}%) ${e ? "&uarr;" : "&darr;"}\n                            </div>`, i = !0, e ? s = !0 : l = !0, u.push({ change: e ? "increase" : "decrease" }) } } } h += "</div>", h += `<div class="Price-box-content-c-t">${competitorStoreName}</div>`, c += `<div class="Price-box-content-c flex-column">${h}</div>`, o.innerHTML = c, o.classList.add("nowrap"), o.addEventListener("click", (() => { const t = `/PriceHistory/Details?productId=${n}&scrapId=${e}`; window.open(t, "_blank") })), p.appendChild(o) })), o && !s && (e = !1), c && !l && (e = !1), r && 0 === u.length && (e = !1), e && (t.appendChild(p), d++) } document.getElementById("scrapable-count").textContent = d }