document.addEventListener("DOMContentLoaded", (function () { function e(e, n) { const t = function (e) { return `hsl(${e / 100 * 120}, 70%, 45%)` }(e); return `\n        <div style="display: inline-block; margin: 8px 8px 0 0; text-align: center; vertical-align: middle;">\n            <div style="position: relative; display: inline-block; width: 80px; height: 80px;">\n\n                <div style="\n                    width: 80px;\n                    height: 80px;\n                    border-radius: 50%;\n                    border: 1px solid #e3e3e3;\n                    background: conic-gradient(${t} 0% ${e}%, #fff ${e}% 100%);\n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 10px;\n                    left: 10px;\n                    width: 60px;\n                    height: 60px;\n                    background: #fff;\n                    border: 1px solid #e3e3e3;\n                    border-radius: 50%;\n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    text-align: center;\n                ">\n                    <img src="${n}" alt="icon" style="width:16px; height:16px; vertical-align: middle; margin-bottom: 2px;" />\n                    <div style="\n                        font-size: 16px;\n                        font-weight: 400;\n                        color: #222222;\n                    ">\n                        ${Math.round(e)}\n                    </div>\n                </div>\n            </div>\n        </div>\n    ` } const n = "selectedPriceChanges_" + storeId; var t = [], r = null; const o = localStorage.getItem(n); if (o) try { const e = JSON.parse(o); e && e.scrapId && Array.isArray(e.changes) ? (t = e.changes, r = e.scrapId) : (console.warn("Wykryto stary format danych w LS. Zostanie on usunięty przy następnej zmianie."), localStorage.removeItem(n)) } catch (e) { console.error("Błąd parsowania storedChanges z Local Storage:", e), localStorage.removeItem(n) } let i = null, a = storeId || "Sklep", l = null, c = !1, s = {}, d = {}, u = []; function p() { return (new Date).toISOString().split("T")[0] } function g(e = !1) { e && (t = []); var n = t.filter((function (e) { return e.newPrice > e.currentPrice })).length, r = t.filter((function (e) { return e.newPrice < e.currentPrice })).length, o = t.length, i = document.getElementById("summaryText"); i && (i.innerHTML = "<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> " + n + "</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> " + r + "</div>"); var a = document.getElementById("simulateButton"); a && (a.disabled = 0 === o, a.style.opacity = 0 === o ? "0.5" : "1") } function f() { const e = { scrapId: r, changes: t }; localStorage.setItem(n, JSON.stringify(e)) } const m = document.getElementById("clearChangesButton"); function y(e) { if (!e || "-" === e) return { rank: null, isRange: !1, rangeSize: 1 }; const n = e.indexOf("/"); let t = -1 !== n ? e.substring(0, n).trim() : e.trim(), r = !1, o = 1, i = null; if (t.includes("-")) { r = !0; const e = t.split("-"); if (2 === e.length) { const n = parseFloat(e[0]), t = parseFloat(e[1]); isNaN(n) || isNaN(t) || (i = n, o = t - n + 1) } } else { const e = parseFloat(t); isNaN(e) || (i = e) } return { rank: i, isRange: r, rangeSize: o } } function h(e, n, t, r, o, i, a, l, c, s) { const d = "number" == typeof e ? e : null, u = "number" == typeof n ? n : null, p = "number" == typeof t ? t : null; let g = '<div class="price-info-box">'; if (g += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Cena oferty | ${null !== d ? d.toFixed(2) + " PLN" : "-"}\n             </div>`, r && null !== u && null !== p && (g += `\n                    <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-top: 5px; margin-bottom: 2px;">\n                        Cena z wysyłką | ${u.toFixed(2)} PLN\n                    </div>`, g += `\n                            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                             Składowe | ${null !== d ? d.toFixed(2) : "-"} PLN + ${p.toFixed(2)} PLN\n                            </div>`), a && l) { g += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Poz. cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px; vertical-align: middle;" />\n                 ${a} / ${l > 0 ? l : "-"}\n             </div>` } if (c && s) { g += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Poz. cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px; vertical-align: middle;" />\n                 ${c} / ${s > 0 ? s : "-"}\n             </div>` } if (null != o && null != i) { let e = parseFloat(i).toFixed(2), n = parseFloat(o).toFixed(2), t = parseFloat(i) >= 0 ? "+" : ""; g += `\n                            <div class="price-info-item">\n                                <div class="price-box-diff-margin ${parseFloat(i) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                                    <p>Narzut: ${t}${e} PLN (${t}${n}%)</p>\n                                </div>\n                            </div>` } return g += "</div>", g } function w() { document.getElementById("loadingOverlay").style.display = "flex"; var n = t.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: t.map((e => e.productId)) }) }).then((e => { if (!e.ok) throw new Error(`HTTP error! status: ${e.status}`); return e.json() })).then((e => { var t = e.some((e => e.imageUrl && "" !== e.imageUrl.trim())); return fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }).then((e => { if (!e.ok) throw new Error(`HTTP error! status: ${e.status}`); return e.json() })).then((n => ({ productDetails: e, data: n, hasImage: t }))) })).then((({ productDetails: n, data: r, hasImage: o }) => { c = r.usePriceWithDelivery, r.ourStoreName && (a = r.ourStoreName), r.latestScrapId && (l = r.latestScrapId); var i = r.simulationResults || []; s = {}, d = {}, i.forEach((e => { const n = parseInt(e.productId), t = e.ean ? String(e.ean) : ""; s[n] = t; const r = e.externalId ? String(e.externalId) : ""; d[n] = r })); let p = '<table class="table-orders" id="simulationTable"><thead><tr>'; o && (p += "<th>Produkt</th>"), p += "<th></th>", p += "<th>Obecne</th>", p += "<th>Zmiana</th>", p += "<th>Po zmianie</th>", p += "<th>Opłacalność zmiany</th>", p += "<th>Usuń</th>", p += '</tr></thead><tbody id="simulationTbody"></tbody></table>'; const g = document.getElementById("simulationModalBody"); g && (g.innerHTML = p); let f = []; t.forEach((function (t, r) { const a = n.find((e => parseInt(e.productId) === parseInt(t.productId))), s = a ? a.productName : t.productName, d = a ? a.imageUrl : "", u = i.find((e => parseInt(e.productId) === parseInt(t.productId))), p = e => "-" === e || null == e ? null : e; let g = ""; u && u.ean ? g = String(u.ean) : a && a.ean && (g = String(a.ean)); let m = ""; u && u.externalId ? m = String(u.externalId) : a && a.externalId && (m = String(a.externalId)); let w = t.newPrice - t.currentPrice, b = w > 0 ? '<span style="color: red;">▲</span>' : w < 0 ? '<span style="color: green;">▼</span>' : '<span style="color: gray;">●</span>', x = 0; t.currentPrice > 0 && (x = w / t.currentPrice * 100); let k = h(u ? u.baseCurrentPrice : null, t.currentPrice, u ? u.ourStoreShippingCost : null, c, u ? u.currentMargin : null, u ? u.currentMarginValue : null, u ? u.currentGoogleRanking : null, u ? u.totalGoogleOffers : null, u ? u.currentCeneoRanking : null, u ? u.totalCeneoOffers : null), S = h(u ? u.baseNewPrice : null, t.newPrice, u ? u.ourStoreShippingCost : null, c, u ? u.newMargin : null, u ? u.newMarginValue : null, u ? u.newGoogleRanking : null, u ? u.totalGoogleOffers : null, u ? u.newCeneoRanking : null, u ? u.totalCeneoOffers : null), v = function (e, n) { if (!n) return { cost: 0, costFrac: 0, googleGained: 0, ceneoGained: 0, googleFinalScore: null, ceneoFinalScore: null, basePriceChangeType: "unknown" }; const t = (n.baseNewPrice ?? 0) - (n.baseCurrentPrice ?? 0); let r = "none"; t > 0 ? r = "increase" : t < 0 && (r = "decrease"); let o = y(String(n.currentGoogleRanking)), i = y(String(n.newGoogleRanking)), a = n.totalGoogleOffers ? parseInt(n.totalGoogleOffers, 10) : 0, l = y(String(n.currentCeneoRanking)), c = y(String(n.newCeneoRanking)), s = n.totalCeneoOffers ? parseInt(n.totalCeneoOffers, 10) : 0, d = e.newPrice - e.currentPrice, u = Math.abs(d), p = 0; function g(e, n, t) { if (null === e.rank || null === n.rank || t < 1) return null; let r = e.rank, o = !1; e.isRange && e.rangeSize > 1 && (r = e.rank + e.rangeSize - 1, n.rank < r && (o = !0)); let i = r - n.rank; if (i <= 0) return null; let a = i * Math.log10(t + 1); o && (a *= .8); let l = 1 === (c = Math.round(n.rank)) ? .5 : 2 === c ? .2 : 3 === c ? .1 : 0; var c; n.isRange && n.rangeSize > 1 && (l *= .4); let s = p < 1e-6 ? 1e-6 : p, d = (a + l) / (Math.pow(s, .5) + 1e-4), u = 35 * Math.log10(d + 1); return u = Math.max(0, Math.min(100, u)), u } e.currentPrice > 0 && (p = u / e.currentPrice); const f = g(o, i, a), m = g(l, c, s); let h = 0; if (null !== o.rank && null !== i.rank) { let e = o.rank; o.isRange && o.rangeSize > 1 && (e = o.rank + o.rangeSize - 1), h = e - i.rank } let w = 0; if (null !== l.rank && null !== c.rank) { let e = l.rank; l.isRange && l.rangeSize > 1 && (e = l.rank + l.rangeSize - 1), w = e - c.rank } return { cost: u, costFrac: p, googleGained: h > 0 ? h : 0, ceneoGained: w > 0 ? w : 0, googleFinalScore: f, ceneoFinalScore: m, basePriceChangeType: r } }(t, u), C = v && null != v.googleFinalScore ? v.googleFinalScore : 0, P = v && null != v.ceneoFinalScore ? v.ceneoFinalScore : 0, I = Math.max(C, P), N = ""; if ("decrease" === v.basePriceChangeType) { const n = v.googleGained <= 0 && v.ceneoGained <= 0 && null == v.googleFinalScore && null == v.ceneoFinalScore; n ? N += '<div>\n                                           <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                           <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka krk. ceno.</span>\n                                          </div>' : (null != v.googleFinalScore && (N += e(v.googleFinalScore, "/images/GoogleShopping.png")), null != v.ceneoFinalScore && (N += e(v.ceneoFinalScore, "/images/Ceneo.png")), null != v.googleFinalScore || null != v.ceneoFinalScore || n || (N += '<div>\n                                           <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                           <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka</span>\n                                          </div>')) } else "increase" === v.basePriceChangeType ? N += '<div>\n                                           <span style="color: red; font-weight: 400; font-size: 16px;">▲</span>\n                                           <span style="color: #222222; font-weight: 400; font-size: 16px;"> Podwyżka ceny</span>\n                                          </div>' : N += '<div>\n                                           <span style="color: gray; font-weight: 400; font-size: 16px;">●</span>\n                                           <span style="color: #222222; font-weight: 400; font-size: 16px;"> Bez zmian</span>\n                                          </div>'; f.push({ index: r, hasImage: o, imageUrl: d, productName: s, ean: g, externalId: m, producerCode: u ? u.producerCode : null, diff: w, diffPercent: x, arrow: b, currentBlock: k, newBlock: S, finalScore: I, effectDetails: N, productId: t.productId, scrapId: l, baseCurrentPrice: u ? u.baseCurrentPrice : null, baseNewPrice: u ? u.baseNewPrice : null, effectiveCurrentPrice: u ? u.effectiveCurrentPrice : null, effectiveNewPrice: u ? u.effectiveNewPrice : null, ourStoreShippingCost: u ? u.ourStoreShippingCost : null, currentMargin: u ? u.currentMargin : null, currentMarginValue: u ? u.currentMarginValue : null, newMargin: u ? u.newMargin : null, newMarginValue: u ? u.newMarginValue : null, currentGoogleRanking: u ? p(u.currentGoogleRanking) : null, newGoogleRanking: u ? p(u.newGoogleRanking) : null, totalGoogleOffers: u ? u.totalGoogleOffers : null, currentCeneoRanking: u ? p(u.currentCeneoRanking) : null, newCeneoRanking: u ? p(u.newCeneoRanking) : null, totalCeneoOffers: u ? u.totalCeneoOffers : null }) })), u = f, b(f); var m = document.getElementById("simulationModal"); m && (m.style.display = "block", m.classList.add("show")) })).catch((function (e) { console.error("Błąd pobierania danych produktu / symulacji:", e); const n = document.getElementById("simulationModalBody"); n && (n.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px; color: red;">Wystąpił błąd podczas ładowania symulacji. Spróbuj ponownie.</p>') })).finally((function () { document.getElementById("loadingOverlay").style.display = "none" })) } function b(e) { const n = document.getElementById("simulationTbody"); if (!n) return; let t = ""; e.forEach((e => { let n = ""; e.hasImage && (n = e.imageUrl && "" !== e.imageUrl.trim() ? `\n                        <td>\n                            <div class="price-info-item" style="padding:4px;">\n                                <img\n                                    data-src="${e.imageUrl}"\n                                    alt="${e.productName}"\n                                    class="lazy-load loaded"\n                                    style="width: 114px; height: 114px; margin-right: 5px; margin-left: 5px; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 10px; display: block;"\n                                    src="${e.imageUrl}"\n                                >\n                            </div>\n                        </td>` : "<td></td>"); let r = e.ean ? `<div class="price-info-item">EAN: ${e.ean}</div>` : "", o = e.externalId ? `<div class="price-info-item">ID: ${e.externalId}</div>` : "", i = e.producerCode ? `<div class="price-info-item">Kod: ${e.producerCode}</div>` : ""; t += `<tr>\n                         ${n}\n                            <td>\n                                <a\n                                    href="/PriceHistory/Details?scrapId=${e.scrapId}&productId=${e.productId}"\n                                    target="_blank"\n                                    rel="noopener noreferrer"\n                                    class="simulationProductTitle"\n                                >\n                                    <div class="price-info-item" style="font-size:120%; margin-bottom:12px;">\n                                        ${e.productName}\n                                    </div>\n                                </a>\n                            ${r}\n                            ${o}\n                            ${i}\n                            </td>\n                            <td>${e.currentBlock}</td>\n                            <td style="font-size:16px; white-space: nowrap;">\n                                ${e.arrow} ${Math.abs(e.diff).toFixed(2)} PLN\n                                (${Math.abs(e.diffPercent).toFixed(2)}%)\n                            </td>\n                            <td>${e.newBlock}</td>\n                            <td style="white-space: nowrap;">\n                                ${e.effectDetails}\n                            </td>\n                            <td>\n                                <button class="remove-change-btn"\n                                        data-product-id="${e.productId}"\n                                        style="background: none; border: none; padding: 5px; display: flex; align-items: center; margin-left:8px; justify-content: center; cursor: pointer;">\n                                    <i class="fa fa-trash" style="font-size: 19px; color: rgb(51, 51, 51);"></i>\n                                </button>\n                            </td>\n                        </tr>` })), n.innerHTML = t, document.querySelectorAll("#simulationTbody .remove-change-btn").forEach((e => { e.addEventListener("click", (function (e) { e.stopPropagation(); const n = this.getAttribute("data-product-id"), t = new CustomEvent("priceBoxChangeRemove", { detail: { productId: n } }); document.dispatchEvent(t) })) })) } m && m.addEventListener("click", (function () { !function () { t = [], r = null, f(), g(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>'); const n = document.getElementById("simulationTable"); n && n.remove() }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: o, currentPrice: i, newPrice: a, scrapId: l } = e.detail; 0 === t.length && (r = l); var c = t.findIndex((function (e) { return parseInt(e.productId) === parseInt(n) })); c > -1 ? t[c] = { productId: n, productName: o, currentPrice: i, newPrice: a } : t.push({ productId: n, productName: o, currentPrice: i, newPrice: a }), f(), g() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail; t = t.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), f(), g(); const r = document.querySelector(`#simulationTbody tr button[data-product-id='${n}']`)?.closest("tr"); if (r && r.remove(), u = u.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), 0 === t.length) { const e = document.getElementById("simulationModalBody"), n = document.getElementById("simulationTable"); e && n && (n.remove(), e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>') } })); const x = document.getElementById("bestScoreButton"); function k(e) { i = e; const n = document.getElementById("exportDisclaimerModal"); n && (n.style.display = "block", n.classList.add("show")) } function S() { const e = document.getElementById("exportDisclaimerModal"); e && (e.style.display = "none", e.classList.remove("show")) } x && x.addEventListener("click", (function () { if (!document.getElementById("simulationTbody") || 0 === u.length) return; b([...u].sort(((e, n) => { const t = null !== e.finalScore ? e.finalScore : -1; return (null !== n.finalScore ? n.finalScore : -1) - t }))) })); const v = document.getElementById("disclaimerConfirmButton"); v && v.addEventListener("click", (function () { S(); const e = document.getElementById("extendedExportCheckbox").checked; "csv" === i ? function (e = !1) { let n = "", t = ""; const r = p(); if (e) { const e = ["Obecny koszt wysyłki", "Obecna cena z wysyłką"], o = ["Obecny narzut (%)", "Obecny narzut (PLN)"], i = ["Nowa cena oferty"], l = ["Nowy koszt wysyłki", "Nowa cena z wysyłką"], s = ["Nowy narzut (%)", "Nowy narzut (PLN)"], d = ["Nowa pozycja Google", "Nowa liczba ofert Google", "Nowa pozycja Ceneo", "Nowa liczba ofert Ceneo"]; let p = [...["ID", "EAN", "KOD", "Nazwa produktu", "Obecna pozycja Google", "Całkowita liczba ofert Google", "Obecna pozycja Ceneo", "Całkowita liczba ofert Ceneo", "Obecna cena oferty"]]; c && p.push(...e), p.push(...o, ...i), c && p.push(...l), p.push(...s, ...d), n += p.map((e => `"${e}"`)).join(";") + "\n", u.forEach((e => { const t = null !== e.currentGoogleRanking ? String(e.currentGoogleRanking) : "", r = null !== e.totalGoogleOffers ? String(e.totalGoogleOffers) : "", o = null !== e.currentCeneoRanking ? String(e.currentCeneoRanking) : "", i = null !== e.totalCeneoOffers ? String(e.totalCeneoOffers) : "", a = null !== e.newGoogleRanking ? String(e.newGoogleRanking) : "", l = null !== e.newCeneoRanking ? String(e.newCeneoRanking) : "", s = "number" == typeof e.baseCurrentPrice ? e.baseCurrentPrice.toFixed(2).replace(".", ",") : "", d = "number" == typeof e.currentMargin ? e.currentMargin.toFixed(2).replace(".", ",") : "", u = "number" == typeof e.currentMarginValue ? e.currentMarginValue.toFixed(2).replace(".", ",") : "", p = "number" == typeof e.baseNewPrice ? e.baseNewPrice.toFixed(2).replace(".", ",") : "", g = "number" == typeof e.newMargin ? e.newMargin.toFixed(2).replace(".", ",") : "", f = "number" == typeof e.newMarginValue ? e.newMarginValue.toFixed(2).replace(".", ",") : ""; let m = [`="${String(e.externalId || "")}"`, `="${String(e.ean || "")}"`, `="${String(e.producerCode || "")}"`, `"${e.productName}"`, `"${t}"`, `"${r}"`, `"${o}"`, `"${i}"`, `"${s}"`]; if (c) { const n = "number" == typeof e.ourStoreShippingCost ? e.ourStoreShippingCost.toFixed(2).replace(".", ",") : "", t = "number" == typeof e.effectiveCurrentPrice ? e.effectiveCurrentPrice.toFixed(2).replace(".", ",") : ""; m.push(`"${n}"`, `"${t}"`) } if (m.push(`"${d}"`, `"${u}"`, `"${p}"`), c) { const n = "number" == typeof e.ourStoreShippingCost ? e.ourStoreShippingCost.toFixed(2).replace(".", ",") : "", t = "number" == typeof e.effectiveNewPrice ? e.effectiveNewPrice.toFixed(2).replace(".", ",") : ""; m.push(`"${n}"`, `"${t}"`) } m.push(`"${g}"`, `"${f}"`, `"${a}"`, `"${r}"`, `"${l}"`, `"${i}"`), n += m.join(";") + "\n" })), t = `PriceSafari-${r}-${a}-rozszerzony.csv` } else n = "ID;EAN;KOD;CENA\n", u.forEach((e => { const t = "number" == typeof e.baseNewPrice ? e.baseNewPrice.toFixed(2).replace(".", ",") : "", r = e.ean ? `="${String(e.ean)}"` : "", o = e.producerCode ? `="${String(e.producerCode)}"` : "", i = e.externalId ? `="${String(e.externalId)}"` : ""; n += `${i};${r};${o};"${t}"\n` })), t = `PriceSafari-${r}-${a}-bazowa.csv`; const o = new Blob(["\ufeff" + n], { type: "text/csv;charset=utf-8;" }), i = document.createElement("a"); i.href = URL.createObjectURL(o), i.download = t, i.click(), setTimeout((() => { URL.revokeObjectURL(i.href) }), 1e3) }(e) : "excel" === i && async function (e = !1) { const n = new ExcelJS.Workbook, t = n.addWorksheet("Zmiany Cen"), r = p(); let o = ""; if (e) { let e = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "KOD", key: "producerCode", width: 20, style: { numFmt: "@" } }, { header: "Nazwa produktu", key: "productName", width: 40 }, { header: "Obecna poz. Google", key: "currentGoogleRanking", width: 20 }, { header: "Obecna liczba ofert Google", key: "totalGoogleOffers", width: 25 }, { header: "Obecna poz. Ceneo", key: "currentCeneoRanking", width: 20 }, { header: "Obecna liczba ofert Ceneo", key: "totalCeneoOffers", width: 25 }, { header: "Obecna cena oferty", key: "baseCurrentPrice", width: 20, style: { numFmt: "#,##0.00" } }]; c && e.push({ header: "Obecny koszt wysyłki", key: "ourStoreShippingCost", width: 22, style: { numFmt: "#,##0.00" } }, { header: "Obecna cena z wysyłką", key: "effectiveCurrentPrice", width: 25, style: { numFmt: "#,##0.00" } }), e.push({ header: "Obecny narzut (%)", key: "currentMargin", width: 18, style: { numFmt: "#,##0.00" } }, { header: "Obecny narzut (PLN)", key: "currentMarginValue", width: 18, style: { numFmt: "#,##0.00" } }, { header: "Nowa cena oferty", key: "baseNewPrice", width: 20, style: { numFmt: "#,##0.00" } }), c && e.push({ header: "Nowy koszt wysyłki", key: "newShippingCost", width: 22, style: { numFmt: "#,##0.00" } }, { header: "Nowa cena z wysyłką", key: "effectiveNewPrice", width: 25, style: { numFmt: "#,##0.00" } }), e.push({ header: "Nowy narzut (%)", key: "newMargin", width: 18, style: { numFmt: "#,##0.00" } }, { header: "Nowy narzut (PLN)", key: "newMarginValue", width: 18, style: { numFmt: "#,##0.00" } }, { header: "Nowa poz. Google", key: "newGoogleRanking", width: 20 }, { header: "Nowa liczba ofert Google", key: "newTotalGoogleOffers", width: 25 }, { header: "Nowa poz. Ceneo", key: "newCeneoRanking", width: 20 }, { header: "Nowa liczba ofert Ceneo", key: "newTotalCeneoOffers", width: 25 }), t.columns = e, u.forEach((e => { let n = { externalId: String(e.externalId || ""), ean: String(e.ean || ""), producerCode: String(e.producerCode || ""), productName: e.productName, currentGoogleRanking: e.currentGoogleRanking, totalGoogleOffers: e.totalGoogleOffers, currentCeneoRanking: e.currentCeneoRanking, totalCeneoOffers: e.totalCeneoOffers, baseCurrentPrice: "number" == typeof e.baseCurrentPrice ? parseFloat(e.baseCurrentPrice.toFixed(2)) : null, currentMargin: "number" == typeof e.currentMargin ? parseFloat(e.currentMargin.toFixed(2)) : null, currentMarginValue: "number" == typeof e.currentMarginValue ? parseFloat(e.currentMarginValue.toFixed(2)) : null, baseNewPrice: "number" == typeof e.baseNewPrice ? parseFloat(e.baseNewPrice.toFixed(2)) : null, newMargin: "number" == typeof e.newMargin ? parseFloat(e.newMargin.toFixed(2)) : null, newMarginValue: "number" == typeof e.newMarginValue ? parseFloat(e.newMarginValue.toFixed(2)) : null, newGoogleRanking: e.newGoogleRanking, newTotalGoogleOffers: e.totalGoogleOffers, newCeneoRanking: e.newCeneoRanking, newTotalCeneoOffers: e.totalCeneoOffers }; c ? (n.ourStoreShippingCost = "number" == typeof e.ourStoreShippingCost ? parseFloat(e.ourStoreShippingCost.toFixed(2)) : null, n.effectiveCurrentPrice = "number" == typeof e.effectiveCurrentPrice ? parseFloat(e.effectiveCurrentPrice.toFixed(2)) : null, n.newShippingCost = "number" == typeof e.ourStoreShippingCost ? parseFloat(e.ourStoreShippingCost.toFixed(2)) : null, n.effectiveNewPrice = "number" == typeof e.effectiveNewPrice ? parseFloat(e.effectiveNewPrice.toFixed(2)) : null) : (n.ourStoreShippingCost = null, n.effectiveCurrentPrice = null, n.newShippingCost = null, n.effectiveNewPrice = null), t.addRow(n) })), o = `PriceSafari-${r}-${a}-rozszerzony.xlsx` } else t.columns = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "KOD", key: "producerCode", width: 20, style: { numFmt: "@" } }, { header: "CENA", key: "newPrice", width: 15, style: { numFmt: "#,##0.00" } }], u.forEach((e => { const n = "number" == typeof e.baseNewPrice ? parseFloat(e.baseNewPrice.toFixed(2)) : null, r = String(e.ean || ""), o = String(e.producerCode || ""), i = String(e.externalId || ""); t.addRow({ externalId: i, ean: r, producerCode: o, newPrice: n }) })), o = `PriceSafari-${r}-${a}-bazowa.xlsx`; const i = await n.xlsx.writeBuffer(), l = new Blob([i], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), s = document.createElement("a"); s.href = URL.createObjectURL(l), s.download = o, s.click(), setTimeout((() => { URL.revokeObjectURL(s.href) }), 1e3) }(e), i = null })); var C = document.getElementById("simulateButton"); C && C.addEventListener("click", (function () { w() })); const P = document.getElementById("exportToCsvButton"); P && P.addEventListener("click", (function () { t.length > 0 && k("csv") })); const I = document.getElementById("exportNewPriceToExcelButton"); I && I.addEventListener("click", (function () { if ("undefined" == typeof ExcelJS) return console.error("Biblioteka ExcelJS nie jest załadowana."), void alert("Wystąpił błąd: Biblioteka eksportu do Excela nie jest dostępna."); t.length > 0 && k("excel") })), g(), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e && (e.style.display = "none", e.classList.remove("show")), "function" == typeof window.refreshPriceBoxStates ? window.refreshPriceBoxStates() : "function" == typeof window.loadPrices ? (console.warn("Funkcja refreshPriceBoxStates nie została znaleziona. Rozważam fallback do loadPrices()."), window.loadPrices()) : console.error("Brak funkcji odświeżającej stany cen na liście.") })) })), document.querySelectorAll('#exportDisclaimerModal .close, #exportDisclaimerModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { S() })) })) }));