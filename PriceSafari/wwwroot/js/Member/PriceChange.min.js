document.addEventListener("DOMContentLoaded", (function () { function e(e, n) { const t = function (e) { return `hsl(${e / 100 * 120}, 70%, 45%)` }(e); return `\n        <div style="display: inline-block; margin: 8px 8px 0 0; text-align: center; vertical-align: middle;">\n            <div style="position: relative; display: inline-block; width: 80px; height: 80px;">\n        \n                <div style="\n                    width: 80px;\n                    height: 80px;\n                    border-radius: 50%;\n                    border: 1px solid #e3e3e3;\n                    background: conic-gradient(${t} 0% ${e}%, #fff ${e}% 100%);\n                "></div>\n             \n                <div style="\n                    position: absolute;\n                    top: 10px;\n                    left: 10px;\n                    width: 60px;\n                    height: 60px;\n                    background: #fff;\n                    border: 1px solid #e3e3e3;\n                    border-radius: 50%;\n                "></div>\n            \n                <div style="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    text-align: center;\n                ">\n                    <img src="${n}" alt="icon" style="width:16px; height:16px; vertical-align: middle; margin-bottom: 2px;" />\n                    <div style="\n                        font-size: 16px;\n                        font-weight: 400;\n                        color: #222222;\n                    ">\n                        ${Math.round(e)}\n                    </div>\n                </div>\n            </div>\n        </div>\n    ` } const n = "selectedPriceChanges_" + storeId; var t = []; const r = localStorage.getItem(n); if (r) try { t = JSON.parse(r) } catch (e) { } let o = null, i = storeId || "Sklep", a = {}, c = {}, l = []; function d() { return (new Date).toISOString().split("T")[0] } function s() { var e = t.filter((function (e) { return e.newPrice > e.currentPrice })).length, n = t.filter((function (e) { return e.newPrice < e.currentPrice })).length, r = t.length, o = document.getElementById("summaryText"); o && (o.innerHTML = "<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> " + e + "</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> " + n + "</div>"); var i = document.getElementById("simulateButton"); i && (i.disabled = 0 === r, i.style.opacity = 0 === r ? "0.5" : "1") } function u() { localStorage.setItem(n, JSON.stringify(t)) } const p = document.getElementById("clearChangesButton"); function g(e) { if (!e) return { rank: null, isRange: !1, rangeSize: 1 }; const n = e.indexOf("/"); let t = -1 !== n ? e.substring(0, n).trim() : e.trim(), r = !1, o = 1, i = null; if (t.includes("-")) { r = !0; const e = t.split("-"); if (2 === e.length) { const n = parseFloat(e[0]), t = parseFloat(e[1]); isNaN(n) || isNaN(t) || (i = (n + t) / 2, o = t - n + 1) } } else { const e = parseFloat(t); isNaN(e) || (i = e) } return { rank: i, isRange: r, rangeSize: o } } function f(e, n, t, r, o, i, a) { let c = '<div class="price-info-box">'; if (c += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Cena produktu | ${e.toFixed(2)} PLN\n            </div>`, r && o && (c += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Pozycja cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px;" />\n                ${r} / ${o}\n            </div>`), i && a && (c += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Pozycja cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px;" />\n                ${i} / ${a}\n            </div>`), null != n && null != t) { let e = parseFloat(t).toFixed(2), r = parseFloat(n).toFixed(2), o = parseFloat(t) >= 0 ? "+" : ""; c += `\n                <div class="price-info-item">\n                    <div class="price-box-diff-margin ${parseFloat(t) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                        <p>Marża: ${o}${e} PLN (${o}${r}%)</p>\n                    </div>\n                </div>` } return c += "</div>", c } function m() { document.getElementById("loadingOverlay").style.display = "flex"; var n = t.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails?productIds=" + encodeURIComponent(JSON.stringify(t.map((function (e) { return e.productId }))))).then((function (e) { return e.json() })).then((function (e) { var t = e.some((function (e) { return e.imageUrl && "" !== e.imageUrl.trim() })); return fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }).then((function (e) { return e.json() })).then((function (n) { return { productDetails: e, data: n, hasImage: t } })) })).then((function ({ productDetails: n, data: r, hasImage: o }) { r.ourStoreName && (i = r.ourStoreName); var d = r.simulationResults || []; a = {}, c = {}, d.forEach((e => { const n = parseInt(e.productId), t = e.ean ? String(e.ean) : ""; a[n] = t; const r = e.externalId ? String(e.externalId) : ""; c[n] = r })); let s = '<table class="table-orders" id="simulationTable"><thead><tr>'; o && (s += "<th>Produkt</th>"), s += "<th></th>", s += "<th>Obecne</th>", s += "<th>Zmiana</th>", s += "<th>Po zmianie</th>", s += "<th>Opłacalność zmiany</th>", s += "<th>Usuń</th>", s += '</tr></thead><tbody id="simulationTbody"></tbody></table>'; const u = document.getElementById("simulationModalBody"); u && (u.innerHTML = s); let p = []; t.forEach((function (t, r) { const i = n.find((e => parseInt(e.productId) === parseInt(t.productId))), a = i ? i.productName : t.productName, c = i ? i.imageUrl : "", l = d.find((e => parseInt(e.productId) === parseInt(t.productId))); let s = ""; l && l.ean ? s = String(l.ean) : i && i.ean && (s = String(i.ean)); let u = ""; l && l.externalId ? u = String(l.externalId) : i && i.externalId && (u = String(i.externalId)); let m = t.newPrice - t.currentPrice, h = m > 0 ? '<span style="color: red;">▲</span>' : m < 0 ? '<span style="color: green;">▼</span>' : '<span style="color: gray;">●</span>', y = 0; t.currentPrice > 0 && (y = m / t.currentPrice * 100); let x = f(t.currentPrice, l && l.currentMargin, l && l.currentMarginValue, l && l.currentGoogleRanking, l && l.totalGoogleOffers, l && l.currentCeneoRanking, l && l.totalCeneoOffers), v = f(t.newPrice, l && l.newMargin, l && l.newMarginValue, l && l.newGoogleRanking, l && l.totalGoogleOffers, l && l.newCeneoRanking, l && l.totalCeneoOffers), I = function (e, n) { if (!n) return { cost: 0, costFrac: 0, googleGained: 0, ceneoGained: 0, googleFinalScore: null, ceneoFinalScore: null }; let t = n.currentGoogleRanking ? g(String(n.currentGoogleRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, r = n.newGoogleRanking ? g(String(n.newGoogleRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, o = n.totalGoogleOffers ? parseInt(n.totalGoogleOffers, 10) : 0, i = n.currentCeneoRanking ? g(String(n.currentCeneoRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, a = n.newCeneoRanking ? g(String(n.newCeneoRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, c = n.totalCeneoOffers ? parseInt(n.totalCeneoOffers, 10) : 0, l = 0; if (null !== t.rank && null !== r.rank && o > 0) { const e = t.rank - r.rank; e > 0 && (l = e) } let d = 0; if (null !== i.rank && null !== a.rank && c > 0) { const e = i.rank - a.rank; e > 0 && (d = e) } let s = Math.abs(e.newPrice - e.currentPrice), u = 0; function p(e, n, t) { if (!e || !n || t < 1) return null; if (null == e.rank || null == n.rank) return null; let r = e.rank - n.rank; if (r <= 0) return null; let o = r * Math.log10(t + 1), i = 1 === (a = Math.round(n.rank)) ? .5 : 2 === a ? .2 : 3 === a ? .1 : 0; var a; n.isRange && n.rangeSize > 1 && (i *= .4); let c = u < 1e-6 ? 1e-6 : u, l = (o + i) / (Math.pow(c, .5) + 1e-4), d = 35 * Math.log10(l + 1); return d < 0 && (d = 0), d > 100 && (d = 100), d } e.currentPrice > 0 && (u = s / e.currentPrice); const f = p(t, r, o), m = p(i, a, c); return { cost: s, costFrac: u, googleGained: l, ceneoGained: d, googleFinalScore: f, ceneoFinalScore: m } }(t, l), k = null != I.googleFinalScore ? I.googleFinalScore : 0, w = null != I.ceneoFinalScore ? I.ceneoFinalScore : 0, b = Math.max(k, w), S = ""; m < 0 ? (null != I.googleFinalScore && (S += e(I.googleFinalScore, "/images/GoogleShopping.png")), null != I.ceneoFinalScore && (S += e(I.ceneoFinalScore, "/images/Ceneo.png"))) : S += '<div>\n                          <span style="color: red; font-weight: 400; font-size: 16px;">▲</span>\n                          <span style="color: #222222; font-weight: 400; font-size: 16px;"> Podwyżka</span>\n                        </div>', p.push({ index: r, hasImage: o, imageUrl: c, productName: a, ean: s, externalId: u, diff: m, diffPercent: y, arrow: h, currentBlock: x, newBlock: v, finalScore: b, effectDetails: S, productId: t.productId }) })), l = [...p], h(p); var m = document.getElementById("simulationModal"); m.style.display = "block", m.classList.add("show") })).catch((function (e) { console.error("Błąd pobierania danych produktu / symulacji:", e) })).finally((function () { document.getElementById("loadingOverlay").style.display = "none" })) } function h(e) { const n = document.getElementById("simulationTbody"); if (!n) return; let t = ""; e.forEach((e => { let n = ""; e.hasImage && (n = e.imageUrl && "" !== e.imageUrl.trim() ? `\n                        <td>\n                            <div class="price-info-item" style="padding:4px;">\n                                <img\n                                    data-src="${e.imageUrl}"\n                                    alt="${e.productName}"\n                                    class="lazy-load loaded"\n                                    style="width: 114px; height: 114px; margin-right: 5px; margin-left: 5px; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 10px; display: block;"\n                                    src="${e.imageUrl}"\n                                >\n                            </div>\n                        </td>` : "<td></td>"); let r = e.ean ? `<div class="price-info-item">EAN: ${e.ean}</div>` : "", o = e.externalId ? `<div class="price-info-item">ID: ${e.externalId}</div>` : ""; t += `<tr>\n                ${n}\n                <td>\n                    <div class="price-info-item" style="font-size:125%;">${e.productName}</div>\n                    ${r}\n                    ${o}\n                </td>\n                <td>${e.currentBlock}</td>\n             <td style="font-size:16px; white-space: nowrap;">\n                ${e.arrow} ${Math.abs(e.diff).toFixed(2)} PLN\n                (${Math.abs(e.diffPercent).toFixed(2)}%)\n            </td>\n\n                <td>${e.newBlock}</td>\n                <td style="white-space: nowrap;">\n                    ${e.effectDetails}\n                </td>\n                <td>\n                    <button class="remove-change-btn"\n                        data-product-id="${e.productId}"\n                        style="background: none; border: none; padding: 5px; display: flex; align-items: center; margin-left:8px; justify-content: center;">\n                        <i class="fa fa-trash" style="font-size: 19px; color: red;"></i>\n                    </button>\n                </td>\n            </tr>` })), n.innerHTML = t, document.querySelectorAll(".remove-change-btn").forEach((e => { e.addEventListener("click", (function (e) { e.stopPropagation(); var n = this.getAttribute("data-product-id"); const t = new CustomEvent("priceBoxChangeRemove", { detail: { productId: n } }); document.dispatchEvent(t), m() })) })) } p && p.addEventListener("click", (function () { !function () { t = [], u(), s(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = "") }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: r, currentPrice: o, newPrice: i } = e.detail; var a = t.findIndex((function (e) { return e.productId === n })); a > -1 ? t[a] = { productId: n, productName: r, currentPrice: o, newPrice: i } : t.push({ productId: n, productName: r, currentPrice: o, newPrice: i }), u(), s() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail; t = t.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), u(), s() })); const y = document.getElementById("bestScoreButton"); function x(e) { o = e; const n = document.getElementById("exportDisclaimerModal"); n.style.display = "block", n.classList.add("show") } function v() { const e = document.getElementById("exportDisclaimerModal"); e.style.display = "none", e.classList.remove("show") } y && y.addEventListener("click", (function () { if (!document.getElementById("simulationTbody")) return; h(sortRowsByScoreDesc([...l])) })); const I = document.getElementById("disclaimerConfirmButton"); I && I.addEventListener("click", (function () { v(), "csv" === o ? function () { let e = "ID,EAN,Nowa cena\n"; t.forEach((n => { const t = parseInt(n.productId), r = a[t] || "", o = c[t] || "", i = o ? `="${o}"` : "", l = r ? `="${r}"` : "", d = null != n.newPrice ? n.newPrice.toFixed(2).replace(".", ",") : ""; e += `${i},${l},${d}\n` })); const n = `PriceSafari-${d()}-${i}.csv`, r = new Blob([e], { type: "text/csv;charset=utf-8;" }), o = document.createElement("a"); o.href = URL.createObjectURL(r), o.download = n, o.click(), setTimeout((() => { URL.revokeObjectURL(o.href) }), 1e3) }() : "excel" === o && async function () { const e = new ExcelJS.Workbook, n = e.addWorksheet("Zmiany Cen"); n.columns = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "Nowa Cena", key: "newPrice", width: 15, style: { numFmt: "#,##0.00" } }], t.forEach((e => { const t = parseInt(e.productId), r = a[t] || "", o = c[t] || "", i = String(r), l = String(o), d = null != e.newPrice ? parseFloat(e.newPrice.toFixed(2)) : null; n.addRow({ externalId: l, ean: i, newPrice: d }) })); const r = `PriceSafari-${d()}-${i}.xlsx`, o = await e.xlsx.writeBuffer(), l = new Blob([o], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), s = document.createElement("a"); s.href = URL.createObjectURL(l), s.download = r, s.click(), setTimeout((() => { URL.revokeObjectURL(s.href) }), 1e3) }() })); var k = document.getElementById("simulateButton"); k && k.addEventListener("click", (function () { m() })); const w = document.getElementById("exportToCsvButton"); w && w.addEventListener("click", (function () { x("csv") })); const b = document.getElementById("exportNewPriceToExcelButton"); function v() { const e = document.getElementById("exportDisclaimerModal"); e.style.display = "none", e.classList.remove("show") } b && b.addEventListener("click", (function () { x("excel") })), s(), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e.style.display = "none", e.classList.remove("show"), loadPrices() })) })), document.querySelectorAll('#exportDisclaimerModal .close, #exportDisclaimerModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { v() })) })) }));