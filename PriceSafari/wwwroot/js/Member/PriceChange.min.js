document.addEventListener("DOMContentLoaded", (function () { function e(e, n = !0) { if (null == e || isNaN(parseFloat(e))) return "-"; const t = parseFloat(e).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); return n ? t + " PLN" : t } function n(e, n) { const t = function (e) { return `hsl(${e / 100 * 120}, 70%, 45%)` }(e); return `\n        <div style="display: inline-block; margin: 8px 8px 0 0; text-align: center; vertical-align: middle;">\n            <div style="position: relative; display: inline-block; width: 80px; height: 80px;">\n\n                <div style="\n                    width: 80px;\n                    height: 80px;\n                    border-radius: 50%;\n                    border: 1px solid #e3e3e3;\n                    background: conic-gradient(${t} 0% ${e}%, #f0f0f0 ${e}% 100%); \n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 10px;\n                    left: 10px; \n                    width: 60px; \n                    height: 60px; \n                    background: #fff;\n                    border: 1px solid #e3e3e3;\n                    border-radius: 50%;\n\n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    text-align: center;\n                ">\n                    <img src="${n}" alt="icon" style="width:16px; height:16px; vertical-align: middle; margin-bottom: 2px;" />\n                    <div style="\n                        font-size: 16px;\n                        font-weight: 400; \n                        color: #222222;\n                    ">\n                        ${Math.round(e)}\n                    </div>\n                </div>\n            </div>\n\n        </div>\n        ` } const t = "selectedPriceChanges_" + storeId; var o = [], r = null; const i = localStorage.getItem(t); if (i) try { const e = JSON.parse(i); e && e.scrapId && Array.isArray(e.changes) ? e.changes.length > 0 && void 0 === e.changes[0].stepPriceApplied ? (console.warn("Wykryto stary format danych w LS (bez kroku cenowego). Zostanie on usunięty przy następnej zmianie."), o = e.changes, r = e.scrapId) : (o = e.changes, r = e.scrapId) : (console.warn("Nieznany lub stary format danych w LS. Zostanie on usunięty przy następnej zmianie."), localStorage.removeItem(t)) } catch (e) { console.error("Błąd parsowania storedChanges z Local Storage:", e), localStorage.removeItem(t) } let a = null, l = storeId || "Sklep", c = null, s = !1, d = {}, u = {}, p = []; function g() { return (new Date).toISOString().split("T")[0] } function f(e = !1) { e && (o = []); var n = o.filter((function (e) { return parseFloat(e.newPrice) > parseFloat(e.currentPrice) })).length, t = o.filter((function (e) { return parseFloat(e.newPrice) < parseFloat(e.currentPrice) })).length, r = o.length, i = document.getElementById("summaryText"); i && (i.innerHTML = `<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> ${n}</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> ${t}</div>`); var a = document.getElementById("simulateButton"); a && (a.disabled = 0 === r, a.style.opacity = 0 === r ? "0.5" : "1", a.style.cursor = 0 === r ? "not-allowed" : "pointer") } function m() { const e = { scrapId: r, changes: o }; localStorage.setItem(t, JSON.stringify(e)) } const y = document.getElementById("clearChangesButton"); function h() { const e = document.getElementById("loadingOverlay"); e && (e.style.display = "none") } function w(e) { if (!e || "-" === e) return { rank: null, isRange: !1, rangeSize: 1 }; const n = e.indexOf("/"); let t = -1 !== n ? e.substring(0, n).trim() : e.trim(), o = !1, r = 1, i = null; if (t.includes("-")) { o = !0; const e = t.split("-"); if (2 === e.length) { const n = parseFloat(e[0]), t = parseFloat(e[1]); isNaN(n) || isNaN(t) || (i = n, r = t - n + 1) } } else { const e = parseFloat(t); isNaN(e) || (i = e) } return { rank: i, isRange: o, rangeSize: r } } function k(n, t, o, r, i, a, l, c, s, d) { const u = e(n), p = e(t); e(o); let g = '<div class="price-info-box">'; if (g += `\n              <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-bottom: 5px;">\n                  Cena oferty | ${u}\n              </div>`, r && null !== t && null !== o && null !== n && (g += `\n                          <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-bottom: 5px;">\n                                Cena z wysyłką | ${p}\n                          </div>`, g += `\n                          <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-bottom: 5px;">\n                                Składowe | ${e(n, !1)} PLN + ${e(o, !1)} PLN\n                          </div>`), l && "-" !== l) { g += `\n              <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-bottom: 5px;">\n                  Poz. cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px; vertical-align: middle; margin-right: 3px;" />\n                  ${l} / ${c > 0 ? c : "-"}\n              </div>` } if (s && "-" !== s) { g += `\n                  <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px; margin-bottom: 5px;">\n                      Poz. cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px; vertical-align: middle; margin-right: 3px;" />\n                      ${s} / ${d > 0 ? d : "-"}\n                  </div>` } if (null != i && null != a) { const n = e(a), t = parseFloat(i).toFixed(2), o = parseFloat(a) >= 0 ? "+" : ""; g += `\n                      <div class="price-info-item"> <div class="price-box-diff-margin ${parseFloat(a) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}" style="margin-top: 5px;"> <p>Narzut: ${n} (${o}${t}%)</p>\n                          </div>\n                      </div>` } return g += "</div>", g } function x() { if (0 !== o.length) { !function () { const e = document.getElementById("loadingOverlay"); e && (e.style.display = "flex") }(); var e = o.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: o.map((e => e.productId)) }) }).then((e => { if (!e.ok) throw new Error(`HTTP error! status: ${e.status} fetching product details`); return e.json() })).then((n => { var t = n.some((e => e.imageUrl && "" !== e.imageUrl.trim())); return fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }).then((e => e.ok ? e.json() : e.text().then((n => { throw new Error(`HTTP error! status: ${e.status}, message: ${n}`) })))).then((e => ({ productDetails: n, data: e, hasImage: t }))) })).then((({ productDetails: e, data: t, hasImage: r }) => { s = !0 === t.usePriceWithDelivery, t.ourStoreName && (l = t.ourStoreName), t.latestScrapId && (c = t.latestScrapId); var i = t.simulationResults || []; d = {}, u = {}, i.forEach((e => { const n = String(e.productId); d[n] = e.ean ? String(e.ean) : "", u[n] = e.externalId ? String(e.externalId) : "" })); let a = '<table class="table-orders" id="simulationTable"><thead><tr>'; r && (a += "<th>Produkt</th>"), a += "<th></th>", a += "<th>Obecne</th>", a += "<th>Zmiana</th>", a += "<th>Po zmianie</th>", a += "<th>Opłacalność zmiany</th>", a += "<th>Usuń</th>", a += '</tr></thead><tbody id="simulationTbody"></tbody></table>'; const g = document.getElementById("simulationModalBody"); g && (g.innerHTML = a), p = o.map((function (t, o) { const a = String(t.productId), l = e.find((e => String(e.productId) === a)), p = i.find((e => String(e.productId) === a)), g = l ? l.productName : t.productName || "Brak nazwy", f = l ? l.imageUrl : "", m = d[a] || (l ? String(l.ean || "") : ""), y = u[a] || (l ? String(l.externalId || "") : ""), h = p ? p.producerCode : l ? l.producerCode : null, x = parseFloat(t.currentPrice); let b = parseFloat(t.newPrice) - x, S = 0; x > 0 && (S = b / x * 100); let v = '<span style="color: gray;">●</span>'; b > .005 ? v = '<span style="color: red;">▲</span>' : b < -.005 && (v = '<span style="color: green;">▼</span>'); let C = k(p ? p.baseCurrentPrice : null, t.currentPrice, p ? p.ourStoreShippingCost : null, s, p ? p.currentMargin : null, p ? p.currentMarginValue : null, p ? p.currentGoogleRanking : null, p ? p.totalGoogleOffers : null, p ? p.currentCeneoRanking : null, p ? p.totalCeneoOffers : null), z = k(p ? p.baseNewPrice : null, t.newPrice, p ? p.ourStoreShippingCost : null, s, p ? p.newMargin : null, p ? p.newMarginValue : null, p ? p.newGoogleRanking : null, p ? p.totalGoogleOffers : null, p ? p.newCeneoRanking : null, p ? p.totalCeneoOffers : null), P = function (e, n) { if (!n) return { cost: 0, costFrac: 0, googleGained: 0, ceneoGained: 0, googleFinalScore: null, ceneoFinalScore: null, basePriceChangeType: "unknown" }; const t = (n.baseNewPrice ?? 0) - (n.baseCurrentPrice ?? 0); let o = "none"; t > .005 ? o = "increase" : t < -.005 && (o = "decrease"); let r = w(String(n.currentGoogleRanking)), i = w(String(n.newGoogleRanking)), a = n.totalGoogleOffers ? parseInt(n.totalGoogleOffers, 10) : 0, l = w(String(n.currentCeneoRanking)), c = w(String(n.newCeneoRanking)), s = n.totalCeneoOffers ? parseInt(n.totalCeneoOffers, 10) : 0, d = e.newPrice - e.currentPrice, u = Math.abs(d), p = 0; function g(e, n, t) { if (null === e.rank || null === n.rank || t < 1) return null; let o = e.rank, r = !1; e.isRange && e.rangeSize > 1 && (o = e.rank + e.rangeSize - 1, n.rank < e.rank && (r = !0)); let i = o - n.rank; if (i <= 0 && !r) return null; i <= 0 && r && (i = .5); let a = i * Math.log10(t + 1); r && i > 0 && (a *= .8); let l = 1 === (c = Math.round(n.rank)) ? .5 : 2 === c ? .2 : 3 === c ? .1 : 0; var c; n.isRange && n.rangeSize > 1 && (l *= .4); let s = p < 1e-6 ? 1e-6 : p, d = (a + l) / (Math.pow(s, .5) + 1e-4), u = 35 * Math.log10(d + 1); return u = Math.max(0, Math.min(100, u)), u } e.currentPrice > 0 && (p = u / e.currentPrice); const f = g(r, i, a), m = g(l, c, s); let y = 0; if (null !== r.rank && null !== i.rank) { let e = r.rank; r.isRange && r.rangeSize > 1 && (e = r.rank + r.rangeSize - 1), y = e - i.rank } let h = 0; if (null !== l.rank && null !== c.rank) { let e = l.rank; l.isRange && l.rangeSize > 1 && (e = l.rank + l.rangeSize - 1), h = e - c.rank } return { cost: u, costFrac: p, googleGained: y > 0 ? y : 0, ceneoGained: h > 0 ? h : 0, googleFinalScore: f, ceneoFinalScore: m, basePriceChangeType: o } }(t, p), I = P && null != P.googleFinalScore ? P.googleFinalScore : 0, $ = P && null != P.ceneoFinalScore ? P.ceneoFinalScore : 0, E = Math.max(I, $), N = ""; if ("decrease" === P.basePriceChangeType) { const e = P.googleGained <= 0 && P.ceneoGained <= 0 && null == P.googleFinalScore && null == P.ceneoFinalScore; e && Math.abs(b) < .05 ? N += '<div>\n                                            <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                            <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka krk. ceno.</span>\n                                            </div>' : (null != P.googleFinalScore && (N += n(P.googleFinalScore, "/images/GoogleShopping.png")), null != P.ceneoFinalScore && (N += n(P.ceneoFinalScore, "/images/Ceneo.png")), null != P.googleFinalScore || null != P.ceneoFinalScore || e || (N += '<div>\n                                                    <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                                    <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka</span>\n                                                    </div>')) } else "increase" === P.basePriceChangeType ? N += '<div>\n                                            <span style="color: red; font-weight: 400; font-size: 16px;">▲</span>\n                                            <span style="color: #222222; font-weight: 400; font-size: 16px;"> Podwyżka ceny</span>\n                                            </div>' : N += '<div>\n                                            <span style="color: gray; font-weight: 400; font-size: 16px;">●</span>\n                                            <span style="color: #222222; font-weight: 400; font-size: 16px;"> Bez zmian</span>\n                                            </div>'; return { index: o, hasImage: r, imageUrl: f, productName: g, ean: m, externalId: y, producerCode: h, diff: b, diffPercent: S, arrow: v, currentBlock: C, newBlock: z, finalScore: E, effectDetails: N, productId: a, scrapId: c, baseCurrentPrice: p ? p.baseCurrentPrice : null, baseNewPrice: p ? p.baseNewPrice : null, effectiveCurrentPrice: t.currentPrice, effectiveNewPrice: t.newPrice, ourStoreShippingCost: p ? p.ourStoreShippingCost : null, currentMargin: p ? p.currentMargin : null, currentMarginValue: p ? p.currentMarginValue : null, newMargin: p ? p.newMargin : null, newMarginValue: p ? p.newMarginValue : null, currentGoogleRanking: p ? p.currentGoogleRanking : null, newGoogleRanking: p ? p.newGoogleRanking : null, totalGoogleOffers: p ? p.totalGoogleOffers : null, currentCeneoRanking: p ? p.currentCeneoRanking : null, newCeneoRanking: p ? p.newCeneoRanking : null, totalCeneoOffers: p ? p.totalCeneoOffers : null } })), b(p); const f = document.getElementById("simulationModal"); f && (f.style.display = "block", f.classList.add("show")) })).catch((function (e) { console.error("Błąd pobierania danych produktu / symulacji:", e), h(); const n = document.getElementById("simulationModalBody"); if (n) { n.innerHTML = `<p style="text-align: center; padding: 20px; font-size: 16px; color: red;">Wystąpił błąd podczas ładowania symulacji: ${e.message}. Spróbuj ponownie.</p>`; const t = document.getElementById("simulationModal"); t && (t.style.display = "block", t.classList.add("show")) } })).finally((function () { h() })) } else { const e = document.getElementById("simulationModalBody"); if (e) { e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>'; const n = document.getElementById("simulationModal"); n && (n.style.display = "block", n.classList.add("show")) } } } function b(n) { const t = document.getElementById("simulationTbody"); if (!t) return; let o = ""; n.forEach((n => { let t = ""; if (n.hasImage) { const e = n.imageUrl && "" !== n.imageUrl.trim() ? n.imageUrl : "/images/placeholder.png"; t = `\n                    <td>\n                        <div class="price-info-item" style="padding:4px; text-align: center;"> <img\n                                data-src="${e}" alt="${n.productName}"\n                                class="lazy-load" style="width: 114px; height: 114px; object-fit: contain; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 5px; display: inline-block;"\n                                src="${e}" >\n                        </div>\n                    </td>` } let r = n.ean ? `<div class="price-info-item">EAN: ${n.ean}</div>` : "", i = n.externalId ? `<div class="price-info-item">ID: ${n.externalId}</div>` : "", a = n.producerCode ? `<div class="price-info-item">Kod: ${n.producerCode}</div>` : ""; const l = e(Math.abs(n.diff), !1), c = Math.abs(n.diffPercent).toFixed(2); o += `<tr data-product-id="${n.productId}"> ${t}\n                                <td class="align-middle"> <a\n                                        href="/PriceHistory/Details?scrapId=${n.scrapId}&productId=${n.productId}"\n                                        target="_blank"\n                                        rel="noopener noreferrer"\n                                        class="simulationProductTitle"\n                                        title="Zobacz szczegóły produktu"\n                                        style="text-decoration: none; color: inherit;"\n                                    >\n                                        <div class="price-info-item" style="font-size:110%; margin-bottom:8px; font-weight: 500;"> ${n.productName}\n                                        </div>\n                                    </a>\n                                    ${r}\n                                    ${i}\n                                    ${a}\n                                </td>\n                                <td class="align-middle">${n.currentBlock}</td> <td class="align-middle" style="font-size: 1em; white-space: nowrap; text-align: center;"> <div>${n.arrow} ${l} PLN</div>\n                                    <div style="font-size: 0.9em; color: #555;">(${c}%)</div>\n                                </td>\n                                <td class="align-middle">${n.newBlock}</td> <td class="align-middle" style="white-space: normal; text-align: center;"> ${n.effectDetails}\n                                </td>\n                                <td class="align-middle text-center"> <button class="remove-change-btn"\n                                        data-product-id="${n.productId}"\n                                        title="Usuń tę zmianę z symulacji"\n                                        style="background: none; border: none; padding: 5px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;">\n                                    <i class="fa fa-trash" style="font-size: 19px; color: #555;"></i> </button>\n                                </td>\n                            </tr>` })), t.innerHTML = o, t.querySelectorAll(".remove-change-btn").forEach((e => { e.addEventListener("click", (function (e) { e.stopPropagation(); const n = this.getAttribute("data-product-id"), t = new CustomEvent("priceBoxChangeRemove", { detail: { productId: n } }); document.dispatchEvent(t) })) })) } y && y.addEventListener("click", (function () { !function () { o = [], r = null, m(), f(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>'); const n = document.getElementById("simulationTable"); n && n.remove(), p = [], "function" == typeof window.refreshPriceBoxStates && window.refreshPriceBoxStates() }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: t, currentPrice: i, newPrice: a, scrapId: l, stepPriceApplied: c, stepUnitApplied: s } = e.detail; 0 === o.length ? r = l : r !== l && (console.warn(`ScrapId w sesji (${r}) różni się od scrapId eventu (${l}). Czyszczenie starych zmian.`), o = [], r = l); var d = o.findIndex((function (e) { return String(e.productId) === String(n) })); const u = { productId: String(n), productName: t, currentPrice: parseFloat(i), newPrice: parseFloat(a), stepPriceApplied: parseFloat(c), stepUnitApplied: s }; d > -1 ? o[d] = u : o.push(u), m(), f() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail, t = String(n); o = o.filter((function (e) { return e.productId !== t })), m(), f(); const i = document.querySelector(`#simulationTbody tr button[data-product-id='${t}']`)?.closest("tr"); if (i && i.remove(), p = p.filter((function (e) { return String(e.productId) !== t })), 0 === o.length) { const e = document.getElementById("simulationModalBody"), n = document.getElementById("simulationTable"); e && n && (n.remove(), e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>'), r = null } })); const S = document.getElementById("bestScoreButton"); function v(e) { a = e; const n = document.getElementById("exportDisclaimerModal"); n && (n.style.display = "block", n.classList.add("show"), n.setAttribute("aria-hidden", "false")) } function C() { a = null; const e = document.getElementById("exportDisclaimerModal"); e && (e.style.display = "none", e.classList.remove("show"), e.setAttribute("aria-hidden", "true")) } S && S.addEventListener("click", (function () { if (!document.getElementById("simulationTbody") || 0 === p.length) return; b([...p].sort(((e, n) => { const t = null !== e.finalScore ? e.finalScore : -1; return (null !== n.finalScore ? n.finalScore : -1) - t }))) })); const z = document.getElementById("disclaimerConfirmButton"); z && z.addEventListener("click", (function () { console.log("[DEBUG] Kliknięto 'Kontynuuj' w modalu ostrzeżenia."); const n = !0 === document.getElementById("extendedExportCheckbox")?.checked, t = a; console.log(`[DEBUG] Zmienne przed sprawdzeniem typu: currentExportType = ${t}, isExtendedExport = ${n}`), "csv" === t ? (console.log("[DEBUG] Wywołuję exportToCsv..."), function (n = !1) { let t = "", o = ""; const r = g(); if (n) { const n = ["Obecny koszt wysyłki", "Obecna cena z wysyłką"], i = ["Obecny narzut (%)", "Obecny narzut (PLN)"], a = ["Nowa cena oferty"], c = ["Nowy koszt wysyłki", "Nowa cena z wysyłką"], d = ["Nowy narzut (%)", "Nowy narzut (PLN)"], u = ["Nowa poz. Google", "Nowa liczba ofert Google", "Nowa poz. Ceneo", "Nowa liczba ofert Ceneo"]; let g = [...["ID", "EAN", "KOD", "Nazwa produktu", "Obecna poz. Google", "Oferty Google", "Obecna poz. Ceneo", "Oferty Ceneo", "Obecna cena oferty"]]; s && g.push(...n), g.push(...i, ...a), s && g.push(...c), g.push(...d, ...u), t = "\ufeff" + g.map((e => `"${e}"`)).join(";") + "\n", p.forEach((n => { const o = n => "number" == typeof n ? e(n, !1) : "", r = e => "number" == typeof e ? e.toFixed(2).replace(".", ",") : "", i = e => null != e ? String(e) : ""; let a = [`="${String(n.externalId || "")}"`, `="${String(n.ean || "")}"`, `="${String(n.producerCode || "")}"`, `"${n.productName.replace(/"/g, '""')}"`, `"${i(n.currentGoogleRanking)}"`, `"${i(n.totalGoogleOffers)}"`, `"${i(n.currentCeneoRanking)}"`, `"${i(n.totalCeneoOffers)}"`, `"${o(n.baseCurrentPrice)}"`]; s && a.push(`"${o(n.ourStoreShippingCost)}"`, `"${o(n.effectiveCurrentPrice)}"`), a.push(`"${r(n.currentMargin)}"`, `"${o(n.currentMarginValue)}"`, `"${o(n.baseNewPrice)}"`), s && a.push(`"${o(n.ourStoreShippingCost)}"`, `"${o(n.effectiveNewPrice)}"`), a.push(`"${r(n.newMargin)}"`, `"${o(n.newMarginValue)}"`, `"${i(n.newGoogleRanking)}"`, `"${i(n.totalGoogleOffers)}"`, `"${i(n.newCeneoRanking)}"`, `"${i(n.totalCeneoOffers)}"`), t += a.join(";") + "\n" })), o = `PriceSafari-${r}-${l}-rozszerzony.csv` } else t = "\ufeffID;EAN;KOD;CENA\n", p.forEach((n => { const o = e(n.baseNewPrice, !1), r = n.ean ? `="${String(n.ean)}"` : "", i = n.producerCode ? `="${String(n.producerCode)}"` : "", a = n.externalId ? `="${String(n.externalId)}"` : ""; t += `${a};${r};${i};"${o}"\n` })), o = `PriceSafari-${r}-${l}-bazowa.csv`; const i = new Blob([t], { type: "text/csv;charset=utf-8;" }), a = document.createElement("a"); a.href = URL.createObjectURL(i), a.download = o, a.style.display = "none", document.body.appendChild(a), a.click(), document.body.removeChild(a), setTimeout((() => { URL.revokeObjectURL(a.href) }), 1e3) }(n)) : "excel" === t ? (console.log("[DEBUG] Wywołuję exportToExcelXLSX..."), async function (e = !1) { if ("undefined" == typeof ExcelJS) return console.error("Biblioteka ExcelJS nie jest załadowana."), void alert("Wystąpił błąd: Biblioteka eksportu do Excela nie jest dostępna."); try { const n = new ExcelJS.Workbook, t = n.addWorksheet("Zmiany Cen"), o = g(); let r = ""; const i = "#,##0.00"; if (e) { let e = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "KOD", key: "producerCode", width: 20, style: { numFmt: "@" } }, { header: "Nazwa produktu", key: "productName", width: 40 }, { header: "Obecna poz. Google", key: "currentGoogleRanking", width: 20 }, { header: "Oferty Google", key: "totalGoogleOffers", width: 15, style: { numFmt: "0" } }, { header: "Obecna poz. Ceneo", key: "currentCeneoRanking", width: 20 }, { header: "Oferty Ceneo", key: "totalCeneoOffers", width: 15, style: { numFmt: "0" } }, { header: "Obecna cena oferty", key: "baseCurrentPrice", width: 20, style: { numFmt: i } }]; s && e.push({ header: "Obecny koszt wysyłki", key: "ourStoreShippingCost", width: 22, style: { numFmt: i } }, { header: "Obecna cena z wysyłką", key: "effectiveCurrentPrice", width: 25, style: { numFmt: i } }), e.push({ header: "Obecny narzut (%)", key: "currentMargin", width: 18, style: { numFmt: i } }, { header: "Obecny narzut (PLN)", key: "currentMarginValue", width: 18, style: { numFmt: i } }, { header: "Nowa cena oferty", key: "baseNewPrice", width: 20, style: { numFmt: i } }), s && e.push({ header: "Nowy koszt wysyłki", key: "newShippingCost", width: 22, style: { numFmt: i } }, { header: "Nowa cena z wysyłką", key: "effectiveNewPrice", width: 25, style: { numFmt: i } }), e.push({ header: "Nowy narzut (%)", key: "newMargin", width: 18, style: { numFmt: i } }, { header: "Nowy narzut (PLN)", key: "newMarginValue", width: 18, style: { numFmt: i } }, { header: "Nowa poz. Google", key: "newGoogleRanking", width: 20 }, { header: "Nowa liczba ofert Google", key: "newTotalGoogleOffers", width: 25, style: { numFmt: "0" } }, { header: "Nowa poz. Ceneo", key: "newCeneoRanking", width: 20 }, { header: "Nowa liczba ofert Ceneo", key: "newTotalCeneoOffers", width: 25, style: { numFmt: "0" } }), t.columns = e, p.forEach((e => { const n = e => { const n = parseFloat(e); return isNaN(n) ? null : n }, o = e => { const n = parseInt(e, 10); return isNaN(n) ? null : n }; let r = { externalId: String(e.externalId || ""), ean: String(e.ean || ""), producerCode: String(e.producerCode || ""), productName: e.productName, currentGoogleRanking: null !== e.currentGoogleRanking ? String(e.currentGoogleRanking) : "", totalGoogleOffers: o(e.totalGoogleOffers), currentCeneoRanking: null !== e.currentCeneoRanking ? String(e.currentCeneoRanking) : "", totalCeneoOffers: o(e.totalCeneoOffers), baseCurrentPrice: n(e.baseCurrentPrice), currentMargin: n(e.currentMargin), currentMarginValue: n(e.currentMarginValue), baseNewPrice: n(e.baseNewPrice), newMargin: n(e.newMargin), newMarginValue: n(e.newMarginValue), newGoogleRanking: null !== e.newGoogleRanking ? String(e.newGoogleRanking) : "", newTotalGoogleOffers: o(e.totalGoogleOffers), newCeneoRanking: null !== e.newCeneoRanking ? String(e.newCeneoRanking) : "", newTotalCeneoOffers: o(e.totalCeneoOffers) }; s && (r.ourStoreShippingCost = n(e.ourStoreShippingCost), r.effectiveCurrentPrice = n(e.effectiveCurrentPrice), r.newShippingCost = n(e.ourStoreShippingCost), r.effectiveNewPrice = n(e.effectiveNewPrice)), t.addRow(r) })), r = `PriceSafari-${o}-${l}-rozszerzony.xlsx` } else t.columns = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "KOD", key: "producerCode", width: 20, style: { numFmt: "@" } }, { header: "CENA", key: "newPrice", width: 15, style: { numFmt: i } }], p.forEach((e => { const n = e => { const n = parseFloat(e); return isNaN(n) ? null : n }; t.addRow({ externalId: String(e.externalId || ""), ean: String(e.ean || ""), producerCode: String(e.producerCode || ""), newPrice: n(e.baseNewPrice) }) })), r = `PriceSafari-${o}-${l}-bazowa.xlsx`; const a = await n.xlsx.writeBuffer(), c = new Blob([a], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), d = document.createElement("a"); d.href = URL.createObjectURL(c), d.download = r, d.style.display = "none", document.body.appendChild(d), d.click(), document.body.removeChild(d), setTimeout((() => { URL.revokeObjectURL(d.href) }), 1e3) } catch (e) { console.error("Błąd podczas generowania pliku Excel:", e), alert("Wystąpił błąd podczas generowania pliku Excel: " + e.message) } }(n)) : console.warn("[DEBUG] Nieznany lub pusty currentExportType:", t), C() })); var P = document.getElementById("simulateButton"); P && P.addEventListener("click", (function () { x() })); const I = document.getElementById("exportToCsvButton"); I && I.addEventListener("click", (function () { p.length > 0 ? (console.log("Kliknięto Eksport CSV w modalu. Dane:", p), v("csv")) : alert("Brak danych do wyeksportowania. (Musisz najpierw uruchomić symulację)") })); const $ = document.getElementById("exportNewPriceToExcelButton"); $ && $.addEventListener("click", (function () { if ("undefined" == typeof ExcelJS) return console.error("Biblioteka ExcelJS nie jest załadowana."), void alert("Wystąpił błąd: Biblioteka eksportu do Excela nie jest dostępna."); p.length > 0 ? (console.log("Kliknięto Eksport Excel w modalu. Dane:", p), v("excel")) : alert("Brak danych do wyeksportowania. (Musisz najpierw uruchomić symulację)") })), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e && (e.style.display = "none", e.classList.remove("show")), "function" == typeof window.refreshPriceBoxStates ? window.refreshPriceBoxStates() : console.warn("Funkcja refreshPriceBoxStates nie została znaleziona do odświeżenia widoku.") })) })), document.querySelectorAll('#exportDisclaimerModal .close, #exportDisclaimerModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { C() })) })), window.addEventListener("click", (function (e) { const n = document.getElementById("exportDisclaimerModal"); e.target == n && C(); const t = document.getElementById("simulationModal"); e.target == t && t && (t.style.display = "none", t.classList.remove("show"), "function" == typeof window.refreshPriceBoxStates && window.refreshPriceBoxStates()) })), f() }));