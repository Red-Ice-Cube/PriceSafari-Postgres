document.addEventListener("DOMContentLoaded", (function () { function e(e, n) { const t = function (e) { return `hsl(${e / 100 * 120}, 70%, 45%)` }(e); return `\n        <div style="display: inline-block; margin: 8px 8px 0 0; text-align: center; vertical-align: middle;">\n            <div style="position: relative; display: inline-block; width: 80px; height: 80px;">\n\n                <div style="\n                    width: 80px;\n                    height: 80px;\n                    border-radius: 50%;\n                    border: 1px solid #e3e3e3;\n                    background: conic-gradient(${t} 0% ${e}%, #fff ${e}% 100%);\n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 10px;\n                    left: 10px;\n                    width: 60px;\n                    height: 60px;\n                    background: #fff;\n                    border: 1px solid #e3e3e3;\n                    border-radius: 50%;\n                "></div>\n\n                <div style="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    text-align: center;\n                ">\n                    <img src="${n}" alt="icon" style="width:16px; height:16px; vertical-align: middle; margin-bottom: 2px;" />\n                    <div style="\n                        font-size: 16px;\n                        font-weight: 400;\n                        color: #222222;\n                    ">\n                        ${Math.round(e)}\n                    </div>\n                </div>\n            </div>\n        </div>\n    ` } const n = "selectedPriceChanges_" + storeId; var t = []; const o = localStorage.getItem(n); if (o) try { t = JSON.parse(o) } catch (e) { console.error("Błąd parsowania storedChanges z Local Storage:", e) } let r = null, i = storeId || "Sklep", a = null, l = !1, c = {}, d = {}, s = []; function u() { return (new Date).toISOString().split("T")[0] } function p() { var e = t.filter((function (e) { return e.newPrice > e.currentPrice })).length, n = t.filter((function (e) { return e.newPrice < e.currentPrice })).length, o = t.length, r = document.getElementById("summaryText"); r && (r.innerHTML = "<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> " + e + "</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> " + n + "</div>"); var i = document.getElementById("simulateButton"); i && (i.disabled = 0 === o, i.style.opacity = 0 === o ? "0.5" : "1") } function f() { localStorage.setItem(n, JSON.stringify(t)) } const g = document.getElementById("clearChangesButton"); function m(e) { if (!e || "-" === e) return { rank: null, isRange: !1, rangeSize: 1 }; const n = e.indexOf("/"); let t = -1 !== n ? e.substring(0, n).trim() : e.trim(), o = !1, r = 1, i = null; if (t.includes("-")) { o = !0; const e = t.split("-"); if (2 === e.length) { const n = parseFloat(e[0]), t = parseFloat(e[1]); isNaN(n) || isNaN(t) || (i = n, r = t - n + 1) } } else { const e = parseFloat(t); isNaN(e) || (i = e) } return { rank: i, isRange: o, rangeSize: r } } function y(e, n, t, o, r, i, a, l, c, d) { const s = "number" == typeof e ? e : null, u = "number" == typeof n ? n : null, p = "number" == typeof t ? t : null; let f = '<div class="price-info-box">'; if (f += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Cena oferty | ${null !== s ? s.toFixed(2) + " PLN" : "-"}\n             </div>`, o && null !== u && null !== p && (f += `\n                 <div class="price-info-item" style="padding: 4px 12px; background: #e5f5e5; border: 1px solid #c3e3c3; border-radius: 5px; margin-top: 5px; margin-bottom: 2px;">\n                     Cena z wysyłką | ${u.toFixed(2)} PLN\n                 </div>`, f += `\n                  <div class="price-info-item" style="padding: 4px 12px; background: #e5f5e5; border: 1px solid #c3e3c3; border-radius: 5px;">\n                    Koszt | ${null !== s ? s.toFixed(2) : "-"} PLN + ${p.toFixed(2)} PLN\n                  </div>`), a && l) { f += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Poz. cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px; vertical-align: middle;" />\n                 ${a} / ${l > 0 ? l : "-"}\n             </div>` } if (c && d) { f += `\n             <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                 Poz. cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px; vertical-align: middle;" />\n                 ${c} / ${d > 0 ? d : "-"}\n             </div>` } if (null != r && null != i) { let e = parseFloat(i).toFixed(2), n = parseFloat(r).toFixed(2), t = parseFloat(i) >= 0 ? "+" : ""; f += `\n                 <div class="price-info-item">\n                     <div class="price-box-diff-margin ${parseFloat(i) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                         <p>Marża: ${t}${e} PLN (${t}${n}%)</p>\n                     </div>\n                 </div>` } return f += "</div>", f } function h() { document.getElementById("loadingOverlay").style.display = "flex"; var n = t.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: t.map((e => e.productId)) }) }).then((e => { if (!e.ok) throw new Error(`HTTP error! status: ${e.status}`); return e.json() })).then((e => { var t = e.some((e => e.imageUrl && "" !== e.imageUrl.trim())); return fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }).then((e => { if (!e.ok) throw new Error(`HTTP error! status: ${e.status}`); return e.json() })).then((n => ({ productDetails: e, data: n, hasImage: t }))) })).then((({ productDetails: n, data: o, hasImage: r }) => { l = o.usePriceWithDelivery, o.ourStoreName && (i = o.ourStoreName), o.latestScrapId && (a = o.latestScrapId); var u = o.simulationResults || []; c = {}, d = {}, u.forEach((e => { const n = parseInt(e.productId), t = e.ean ? String(e.ean) : ""; c[n] = t; const o = e.externalId ? String(e.externalId) : ""; d[n] = o })); let p = '<table class="table-orders" id="simulationTable"><thead><tr>'; r && (p += "<th>Produkt</th>"), p += "<th></th>", p += "<th>Obecne</th>", p += "<th>Zmiana</th>", p += "<th>Po zmianie</th>", p += "<th>Opłacalność zmiany</th>", p += "<th>Usuń</th>", p += '</tr></thead><tbody id="simulationTbody"></tbody></table>'; const f = document.getElementById("simulationModalBody"); f && (f.innerHTML = p); let g = []; t.forEach((function (t, o) { const i = n.find((e => parseInt(e.productId) === parseInt(t.productId))), c = i ? i.productName : t.productName, d = i ? i.imageUrl : "", s = u.find((e => parseInt(e.productId) === parseInt(t.productId))); let p = ""; s && s.ean ? p = String(s.ean) : i && i.ean && (p = String(i.ean)); let f = ""; s && s.externalId ? f = String(s.externalId) : i && i.externalId && (f = String(i.externalId)); let h = t.newPrice - t.currentPrice, x = h > 0 ? '<span style="color: red;">▲</span>' : h < 0 ? '<span style="color: green;">▼</span>' : '<span style="color: gray;">●</span>', b = 0; t.currentPrice > 0 && (b = h / t.currentPrice * 100); let v = y(s ? s.baseCurrentPrice : null, t.currentPrice, s ? s.ourStoreShippingCost : null, l, s ? s.currentMargin : null, s ? s.currentMarginValue : null, s ? s.currentGoogleRanking : null, s ? s.totalGoogleOffers : null, s ? s.currentCeneoRanking : null, s ? s.totalCeneoOffers : null), w = y(s ? s.baseNewPrice : null, t.newPrice, s ? s.ourStoreShippingCost : null, l, s ? s.newMargin : null, s ? s.newMarginValue : null, s ? s.newGoogleRanking : null, s ? s.totalGoogleOffers : null, s ? s.newCeneoRanking : null, s ? s.totalCeneoOffers : null), I = function (e, n) { if (!n) return { cost: 0, costFrac: 0, googleGained: 0, ceneoGained: 0, googleFinalScore: null, ceneoFinalScore: null, basePriceChangeType: "unknown" }; const t = (n.baseNewPrice ?? 0) - (n.baseCurrentPrice ?? 0); let o = "none"; t > 0 ? o = "increase" : t < 0 && (o = "decrease"); let r = m(String(n.currentGoogleRanking)), i = m(String(n.newGoogleRanking)), a = n.totalGoogleOffers ? parseInt(n.totalGoogleOffers, 10) : 0, l = m(String(n.currentCeneoRanking)), c = m(String(n.newCeneoRanking)), d = n.totalCeneoOffers ? parseInt(n.totalCeneoOffers, 10) : 0, s = e.newPrice - e.currentPrice, u = Math.abs(s), p = 0; function f(e, n, t) { if (null === e.rank || null === n.rank || t < 1) return null; let o = e.rank - n.rank; if (o <= 0) return null; let r = o * Math.log10(t + 1), i = 1 === (a = Math.round(n.rank)) ? .5 : 2 === a ? .2 : 3 === a ? .1 : 0; var a; n.isRange && n.rangeSize > 1 && (i *= .4); let l = p < 1e-6 ? 1e-6 : p, c = (r + i) / (Math.pow(l, .5) + 1e-4), d = 35 * Math.log10(c + 1); return d = Math.max(0, Math.min(100, d)), d } e.currentPrice > 0 && (p = u / e.currentPrice); const g = f(r, i, a), y = f(l, c, d); return { cost: u, costFrac: p, googleGained: null !== r.rank && null !== i.rank ? r.rank - i.rank : 0, ceneoGained: null !== l.rank && null !== c.rank ? l.rank - c.rank : 0, googleFinalScore: g, ceneoFinalScore: y, basePriceChangeType: o } }(t, s), k = I && null != I.googleFinalScore ? I.googleFinalScore : 0, P = I && null != I.ceneoFinalScore ? I.ceneoFinalScore : 0, S = Math.max(k, P), E = ""; if ("decrease" === I.basePriceChangeType) { const n = I.googleGained <= 0 && I.ceneoGained <= 0 && null == I.googleFinalScore && null == I.ceneoFinalScore; n ? E += '<div>\n                                 <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                 <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka krk. ceno.</span>\n                             </div>' : (null != I.googleFinalScore && (E += e(I.googleFinalScore, "/images/GoogleShopping.png")), null != I.ceneoFinalScore && (E += e(I.ceneoFinalScore, "/images/Ceneo.png")), null != I.googleFinalScore || null != I.ceneoFinalScore || n || (E += '<div>\n                                 <span style="color: green; font-weight: 400; font-size: 16px;">▼</span>\n                                 <span style="color: #222222; font-weight: 400; font-size: 16px;"> Obniżka</span>\n                             </div>')) } else "increase" === I.basePriceChangeType ? E += '<div>\n                             <span style="color: red; font-weight: 400; font-size: 16px;">▲</span>\n                             <span style="color: #222222; font-weight: 400; font-size: 16px;"> Podwyżka ceny</span>\n                         </div>' : E += '<div>\n                             <span style="color: gray; font-weight: 400; font-size: 16px;">●</span>\n                             <span style="color: #222222; font-weight: 400; font-size: 16px;"> Bez zmian</span>\n                         </div>'; g.push({ index: o, hasImage: r, imageUrl: d, productName: c, ean: p, externalId: f, diff: h, diffPercent: b, arrow: x, currentBlock: v, newBlock: w, finalScore: S, effectDetails: E, productId: t.productId, scrapId: a, baseCurrentPrice: s ? s.baseCurrentPrice : null, baseNewPrice: s ? s.baseNewPrice : null, effectiveCurrentPrice: s ? s.effectiveCurrentPrice : null, effectiveNewPrice: s ? s.effectiveNewPrice : null, ourStoreShippingCost: s ? s.ourStoreShippingCost : null }) })), s = g, x(g); var h = document.getElementById("simulationModal"); h && (h.style.display = "block", h.classList.add("show")) })).catch((function (e) { console.error("Błąd pobierania danych produktu / symulacji:", e); const n = document.getElementById("simulationModalBody"); n && (n.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px; color: red;">Wystąpił błąd podczas ładowania symulacji. Spróbuj ponownie.</p>') })).finally((function () { document.getElementById("loadingOverlay").style.display = "none" })) } function x(e) { const n = document.getElementById("simulationTbody"); if (!n) return; let t = ""; e.forEach((e => { let n = ""; e.hasImage && (n = e.imageUrl && "" !== e.imageUrl.trim() ? `\n                        <td>\n                            <div class="price-info-item" style="padding:4px;">\n                                <img\n                                    data-src="${e.imageUrl}"\n                                    alt="${e.productName}"\n                                    class="lazy-load loaded"\n                                    style="width: 114px; height: 114px; margin-right: 5px; margin-left: 5px; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 10px; display: block;"\n                                    src="${e.imageUrl}"\n                                >\n                            </div>\n                        </td>` : "<td></td>"); let o = e.ean ? `<div class="price-info-item">EAN: ${e.ean}</div>` : "", r = e.externalId ? `<div class="price-info-item">ID: ${e.externalId}</div>` : ""; t += `<tr>\n                 ${n}\n                 <td>\n                    <a\n                      href="/PriceHistory/Details?scrapId=${e.scrapId}&productId=${e.productId}"\n                      target="_blank"\n                      rel="noopener noreferrer"\n                      class="simulationProductTitle"\n                    >\n                      <div class="price-info-item" style="font-size:125%;">\n                        ${e.productName}\n                      </div>\n                    </a>\n                    ${o}\n                    ${r}\n                </td>\n                <td>${e.currentBlock}</td>\n                <td style="font-size:16px; white-space: nowrap;">\n                    ${e.arrow} ${Math.abs(e.diff).toFixed(2)} PLN\n                    (${Math.abs(e.diffPercent).toFixed(2)}%)\n                </td>\n                <td>${e.newBlock}</td>\n                <td style="white-space: nowrap;">\n                    ${e.effectDetails}\n                </td>\n                <td>\n                    <button class="remove-change-btn"\n                         data-product-id="${e.productId}"\n                         style="background: none; border: none; padding: 5px; display: flex; align-items: center; margin-left:8px; justify-content: center; cursor: pointer;">\n                        <i class="fa fa-trash" style="font-size: 19px; color: rgb(51, 51, 51);"></i>\n                    </button>\n                </td>\n            </tr>` })), n.innerHTML = t, document.querySelectorAll("#simulationTbody .remove-change-btn").forEach((e => { e.addEventListener("click", (function (e) { e.stopPropagation(); const n = this.getAttribute("data-product-id"), t = new CustomEvent("priceBoxChangeRemove", { detail: { productId: n } }); document.dispatchEvent(t) })) })) } g && g.addEventListener("click", (function () { !function () { t = [], f(), p(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>'); const n = document.getElementById("simulationTable"); n && n.remove() }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: o, currentPrice: r, newPrice: i } = e.detail; var a = t.findIndex((function (e) { return parseInt(e.productId) === parseInt(n) })); a > -1 ? t[a] = { productId: n, productName: o, currentPrice: r, newPrice: i } : t.push({ productId: n, productName: o, currentPrice: r, newPrice: i }), f(), p() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail; t = t.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), f(), p(); const o = document.querySelector(`#simulationTbody tr button[data-product-id='${n}']`)?.closest("tr"); if (o && o.remove(), s = s.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), 0 === t.length) { const e = document.getElementById("simulationModalBody"), n = document.getElementById("simulationTable"); e && n && (n.remove(), e.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 16px;">Brak produktów do symulacji.</p>') } })); const b = document.getElementById("bestScoreButton"); function v(e) { r = e; const n = document.getElementById("exportDisclaimerModal"); n && (n.style.display = "block", n.classList.add("show")) } function w() { const e = document.getElementById("exportDisclaimerModal"); e && (e.style.display = "none", e.classList.remove("show")) } b && b.addEventListener("click", (function () { if (!document.getElementById("simulationTbody") || 0 === s.length) return; x([...s].sort(((e, n) => { const t = null !== e.finalScore ? e.finalScore : -1; return (null !== n.finalScore ? n.finalScore : -1) - t }))) })); const I = document.getElementById("disclaimerConfirmButton"); I && I.addEventListener("click", (function () { w(), "csv" === r ? function () { let e = "ID,EAN,CENA\n"; s.forEach((n => { const t = "number" == typeof n.baseNewPrice ? n.baseNewPrice.toFixed(2).replace(".", ",") : "", o = n.ean ? `="${n.ean}"` : "", r = n.externalId ? `="${n.externalId}"` : ""; e += `${r},${o},${t}\n` })); const n = `PriceSafari-${u()}-${i}-bazowa.csv`, t = new Blob([e], { type: "text/csv;charset=utf-8;" }), o = document.createElement("a"); o.href = URL.createObjectURL(t), o.download = n, o.click(), setTimeout((() => { URL.revokeObjectURL(o.href) }), 1e3) }() : "excel" === r && async function () { const e = new ExcelJS.Workbook, n = e.addWorksheet("Zmiany Cen Bazowych"); n.columns = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "CENA", key: "newPrice", width: 15, style: { numFmt: "#,##0.00" } }], s.forEach((e => { const t = "number" == typeof e.baseNewPrice ? parseFloat(e.baseNewPrice.toFixed(2)) : null, o = String(e.ean || ""), r = String(e.externalId || ""); n.addRow({ externalId: r, ean: o, newPrice: t }) })); const t = `PriceSafari-${u()}-${i}-bazowa.xlsx`, o = await e.xlsx.writeBuffer(), r = new Blob([o], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), a = document.createElement("a"); a.href = URL.createObjectURL(r), a.download = t, a.click(), setTimeout((() => { URL.revokeObjectURL(a.href) }), 1e3) }(), r = null })); var k = document.getElementById("simulateButton"); k && k.addEventListener("click", (function () { h() })); const P = document.getElementById("exportToCsvButton"); P && P.addEventListener("click", (function () { t.length > 0 && v("csv") })); const S = document.getElementById("exportNewPriceToExcelButton"); S && S.addEventListener("click", (function () { if ("undefined" == typeof ExcelJS) return console.error("Biblioteka ExcelJS nie jest załadowana."), void alert("Wystąpił błąd: Biblioteka eksportu do Excela nie jest dostępna."); t.length > 0 && v("excel") })), p(), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e && (e.style.display = "none", e.classList.remove("show")), "function" == typeof window.refreshPriceBoxStates ? window.refreshPriceBoxStates() : "function" == typeof window.loadPrices ? (console.warn("Funkcja refreshPriceBoxStates nie została znaleziona. Rozważam fallback do loadPrices()."), window.loadPrices()) : console.error("Brak funkcji odświeżającej stany cen na liście.") })) })), document.querySelectorAll('#exportDisclaimerModal .close, #exportDisclaimerModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { w() })) })) }));