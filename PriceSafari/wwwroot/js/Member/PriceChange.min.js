document.addEventListener("DOMContentLoaded", (function () { function e(e, n) { const t = function (e) { return `hsl(${e / 100 * 120}, 70%, 45%)` }(e); return `\n        <div style="display: inline-block; margin: 8px 8px 0 0; text-align: center; vertical-align: middle;">\n            <div style="position: relative; display: inline-block; width: 80px; height: 80px;">\n        \n                <div style="\n                    width: 80px;\n                    height: 80px;\n                    border-radius: 50%;\n                    border: 1px solid #e3e3e3;\n                    background: conic-gradient(${t} 0% ${e}%, #fff ${e}% 100%);\n                "></div>\n             \n                <div style="\n                    position: absolute;\n                    top: 10px;\n                    left: 10px;\n                    width: 60px;\n                    height: 60px;\n                    background: #fff;\n                    border: 1px solid #e3e3e3;\n                    border-radius: 50%;\n                "></div>\n            \n                <div style="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    text-align: center;\n                ">\n                    <img src="${n}" alt="icon" style="width:16px; height:16px; vertical-align: middle; margin-bottom: 2px;" />\n                    <div style="\n                        font-size: 16px;\n                        font-weight: 400;\n                        color: #222222;\n                    ">\n                        ${Math.round(e)}\n                    </div>\n                </div>\n            </div>\n        </div>\n    ` } const n = "selectedPriceChanges_" + storeId; var t = []; const o = localStorage.getItem(n); if (o) try { t = JSON.parse(o) } catch (e) { } let r = null, i = storeId || "Sklep", a = {}, l = {}, c = []; function d() { return (new Date).toISOString().split("T")[0] } function s() { var e = t.filter((function (e) { return e.newPrice > e.currentPrice })).length, n = t.filter((function (e) { return e.newPrice < e.currentPrice })).length, o = t.length, r = document.getElementById("summaryText"); r && (r.innerHTML = "<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> " + e + "</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> " + n + "</div>"); var i = document.getElementById("simulateButton"); i && (i.disabled = 0 === o, i.style.opacity = 0 === o ? "0.5" : "1") } function u() { localStorage.setItem(n, JSON.stringify(t)) } const p = document.getElementById("clearChangesButton"); function g(e) { if (!e) return { rank: null, isRange: !1, rangeSize: 1 }; const n = e.indexOf("/"); let t = -1 !== n ? e.substring(0, n).trim() : e.trim(), o = !1, r = 1, i = null; if (t.includes("-")) { o = !0; const e = t.split("-"); if (2 === e.length) { const n = parseFloat(e[0]), t = parseFloat(e[1]); isNaN(n) || isNaN(t) || (i = (n + t) / 2, r = t - n + 1) } } else { const e = parseFloat(t); isNaN(e) || (i = e) } return { rank: i, isRange: o, rangeSize: r } } function f(e, n, t, o, r, i, a) { let l = '<div class="price-info-box">'; if (l += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Cena produktu | ${e.toFixed(2)} PLN\n            </div>`, o && r && (l += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Pozycja cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px;" />\n                ${o} / ${r}\n            </div>`), i && a && (l += `\n            <div class="price-info-item" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #e3e3e3; border-radius: 5px;">\n                Pozycja cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px;" />\n                ${i} / ${a}\n            </div>`), null != n && null != t) { let e = parseFloat(t).toFixed(2), o = parseFloat(n).toFixed(2), r = parseFloat(t) >= 0 ? "+" : ""; l += `\n                <div class="price-info-item">\n                    <div class="price-box-diff-margin ${parseFloat(t) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                        <p>Marża: ${r}${e} PLN (${r}${o}%)</p>\n                    </div>\n                </div>` } return l += "</div>", l } function m() { document.getElementById("loadingOverlay").style.display = "flex"; var n = t.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: t.map((e => e.productId)) }) }).then((function (e) { return e.json() })).then((function (e) { var t = e.some((function (e) { return e.imageUrl && "" !== e.imageUrl.trim() })); return fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }).then((function (e) { return e.json() })).then((function (n) { return { productDetails: e, data: n, hasImage: t } })) })).then((function ({ productDetails: n, data: o, hasImage: r }) { o.ourStoreName && (i = o.ourStoreName); var d = o.simulationResults || []; a = {}, l = {}, d.forEach((e => { const n = parseInt(e.productId), t = e.ean ? String(e.ean) : ""; a[n] = t; const o = e.externalId ? String(e.externalId) : ""; l[n] = o })); let s = '<table class="table-orders" id="simulationTable"><thead><tr>'; r && (s += "<th>Produkt</th>"), s += "<th></th>", s += "<th>Obecne</th>", s += "<th>Zmiana</th>", s += "<th>Po zmianie</th>", s += "<th>Opłacalność zmiany</th>", s += "<th>Usuń</th>", s += '</tr></thead><tbody id="simulationTbody"></tbody></table>'; const u = document.getElementById("simulationModalBody"); u && (u.innerHTML = s); let p = []; t.forEach((function (t, o) { const i = n.find((e => parseInt(e.productId) === parseInt(t.productId))), a = i ? i.productName : t.productName, l = i ? i.imageUrl : "", c = d.find((e => parseInt(e.productId) === parseInt(t.productId))); let s = ""; c && c.ean ? s = String(c.ean) : i && i.ean && (s = String(i.ean)); let u = ""; c && c.externalId ? u = String(c.externalId) : i && i.externalId && (u = String(i.externalId)); let m = t.newPrice - t.currentPrice, h = m > 0 ? '<span style="color: red;">▲</span>' : m < 0 ? '<span style="color: green;">▼</span>' : '<span style="color: gray;">●</span>', y = 0; t.currentPrice > 0 && (y = m / t.currentPrice * 100); let x = f(t.currentPrice, c && c.currentMargin, c && c.currentMarginValue, c && c.currentGoogleRanking, c && c.totalGoogleOffers, c && c.currentCeneoRanking, c && c.totalCeneoOffers), v = f(t.newPrice, c && c.newMargin, c && c.newMarginValue, c && c.newGoogleRanking, c && c.totalGoogleOffers, c && c.newCeneoRanking, c && c.totalCeneoOffers), I = function (e, n) { if (!n) return { cost: 0, costFrac: 0, googleGained: 0, ceneoGained: 0, googleFinalScore: null, ceneoFinalScore: null }; let t = n.currentGoogleRanking ? g(String(n.currentGoogleRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, o = n.newGoogleRanking ? g(String(n.newGoogleRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, r = n.totalGoogleOffers ? parseInt(n.totalGoogleOffers, 10) : 0, i = n.currentCeneoRanking ? g(String(n.currentCeneoRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, a = n.newCeneoRanking ? g(String(n.newCeneoRanking)) : { rank: null, isRange: !1, rangeSize: 1 }, l = n.totalCeneoOffers ? parseInt(n.totalCeneoOffers, 10) : 0, c = 0; if (null !== t.rank && null !== o.rank && r > 0) { const e = t.rank - o.rank; e > 0 && (c = e) } let d = 0; if (null !== i.rank && null !== a.rank && l > 0) { const e = i.rank - a.rank; e > 0 && (d = e) } let s = Math.abs(e.newPrice - e.currentPrice), u = 0; function p(e, n, t) { if (!e || !n || t < 1) return null; if (null == e.rank || null == n.rank) return null; let o = e.rank - n.rank; if (o <= 0) return null; let r = o * Math.log10(t + 1), i = 1 === (a = Math.round(n.rank)) ? .5 : 2 === a ? .2 : 3 === a ? .1 : 0; var a; n.isRange && n.rangeSize > 1 && (i *= .4); let l = u < 1e-6 ? 1e-6 : u, c = (r + i) / (Math.pow(l, .5) + 1e-4), d = 35 * Math.log10(c + 1); return d < 0 && (d = 0), d > 100 && (d = 100), d } e.currentPrice > 0 && (u = s / e.currentPrice); const f = p(t, o, r), m = p(i, a, l); return { cost: s, costFrac: u, googleGained: c, ceneoGained: d, googleFinalScore: f, ceneoFinalScore: m } }(t, c), k = null != I.googleFinalScore ? I.googleFinalScore : 0, w = null != I.ceneoFinalScore ? I.ceneoFinalScore : 0, b = Math.max(k, w), S = ""; m < 0 ? (null != I.googleFinalScore && (S += e(I.googleFinalScore, "/images/GoogleShopping.png")), null != I.ceneoFinalScore && (S += e(I.ceneoFinalScore, "/images/Ceneo.png"))) : S += '<div>\n                          <span style="color: red; font-weight: 400; font-size: 16px;">▲</span>\n                          <span style="color: #222222; font-weight: 400; font-size: 16px;"> Podwyżka</span>\n                        </div>', p.push({ index: o, hasImage: r, imageUrl: l, productName: a, ean: s, externalId: u, diff: m, diffPercent: y, arrow: h, currentBlock: x, newBlock: v, finalScore: b, effectDetails: S, productId: t.productId }) })), c = [...p], h(p); var m = document.getElementById("simulationModal"); m.style.display = "block", m.classList.add("show") })).catch((function (e) { console.error("Błąd pobierania danych produktu / symulacji:", e) })).finally((function () { document.getElementById("loadingOverlay").style.display = "none" })) } function h(e) { const n = document.getElementById("simulationTbody"); if (!n) return; let t = ""; e.forEach((e => { let n = ""; e.hasImage && (n = e.imageUrl && "" !== e.imageUrl.trim() ? `\n                        <td>\n                            <div class="price-info-item" style="padding:4px;">\n                                <img\n                                    data-src="${e.imageUrl}"\n                                    alt="${e.productName}"\n                                    class="lazy-load loaded"\n                                    style="width: 114px; height: 114px; margin-right: 5px; margin-left: 5px; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 10px; display: block;"\n                                    src="${e.imageUrl}"\n                                >\n                            </div>\n                        </td>` : "<td></td>"); let o = e.ean ? `<div class="price-info-item">EAN: ${e.ean}</div>` : "", r = e.externalId ? `<div class="price-info-item">ID: ${e.externalId}</div>` : ""; t += `<tr>\n                ${n}\n                <td>\n                    <div class="price-info-item" style="font-size:125%;">${e.productName}</div>\n                    ${o}\n                    ${r}\n                </td>\n                <td>${e.currentBlock}</td>\n             <td style="font-size:16px; white-space: nowrap;">\n                ${e.arrow} ${Math.abs(e.diff).toFixed(2)} PLN\n                (${Math.abs(e.diffPercent).toFixed(2)}%)\n            </td>\n\n                <td>${e.newBlock}</td>\n                <td style="white-space: nowrap;">\n                    ${e.effectDetails}\n                </td>\n                <td>\n                    <button class="remove-change-btn"\n                        data-product-id="${e.productId}"\n                        style="background: none; border: none; padding: 5px; display: flex; align-items: center; margin-left:8px; justify-content: center;">\n                        <i class="fa fa-trash" style="font-size: 19px; color: red;"></i>\n                    </button>\n                </td>\n            </tr>` })), n.innerHTML = t, document.querySelectorAll(".remove-change-btn").forEach((e => { e.addEventListener("click", (function (e) { e.stopPropagation(); var n = this.getAttribute("data-product-id"); const t = new CustomEvent("priceBoxChangeRemove", { detail: { productId: n } }); document.dispatchEvent(t), m() })) })) } p && p.addEventListener("click", (function () { !function () { t = [], u(), s(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = "") }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: o, currentPrice: r, newPrice: i } = e.detail; var a = t.findIndex((function (e) { return e.productId === n })); a > -1 ? t[a] = { productId: n, productName: o, currentPrice: r, newPrice: i } : t.push({ productId: n, productName: o, currentPrice: r, newPrice: i }), u(), s() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail; t = t.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), u(), s() })); const y = document.getElementById("bestScoreButton"); function x(e) { r = e; const n = document.getElementById("exportDisclaimerModal"); n.style.display = "block", n.classList.add("show") } function v() { const e = document.getElementById("exportDisclaimerModal"); e.style.display = "none", e.classList.remove("show") } y && y.addEventListener("click", (function () { if (!document.getElementById("simulationTbody")) return; h(sortRowsByScoreDesc([...c])) })); const I = document.getElementById("disclaimerConfirmButton"); I && I.addEventListener("click", (function () { v(), "csv" === r ? function () { let e = "ID,EAN,Nowa cena\n"; t.forEach((n => { const t = parseInt(n.productId), o = a[t] || "", r = l[t] || "", i = r ? `="${r}"` : "", c = o ? `="${o}"` : "", d = null != n.newPrice ? n.newPrice.toFixed(2).replace(".", ",") : ""; e += `${i},${c},${d}\n` })); const n = `PriceSafari-${d()}-${i}.csv`, o = new Blob([e], { type: "text/csv;charset=utf-8;" }), r = document.createElement("a"); r.href = URL.createObjectURL(o), r.download = n, r.click(), setTimeout((() => { URL.revokeObjectURL(r.href) }), 1e3) }() : "excel" === r && async function () { const e = new ExcelJS.Workbook, n = e.addWorksheet("Zmiany Cen"); n.columns = [{ header: "ID", key: "externalId", width: 18, style: { numFmt: "@" } }, { header: "EAN", key: "ean", width: 18, style: { numFmt: "@" } }, { header: "Nowa Cena", key: "newPrice", width: 15, style: { numFmt: "#,##0.00" } }], t.forEach((e => { const t = parseInt(e.productId), o = a[t] || "", r = l[t] || "", i = String(o), c = String(r), d = null != e.newPrice ? parseFloat(e.newPrice.toFixed(2)) : null; n.addRow({ externalId: c, ean: i, newPrice: d }) })); const o = `PriceSafari-${d()}-${i}.xlsx`, r = await e.xlsx.writeBuffer(), c = new Blob([r], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), s = document.createElement("a"); s.href = URL.createObjectURL(c), s.download = o, s.click(), setTimeout((() => { URL.revokeObjectURL(s.href) }), 1e3) }() })); var k = document.getElementById("simulateButton"); k && k.addEventListener("click", (function () { m() })); const w = document.getElementById("exportToCsvButton"); w && w.addEventListener("click", (function () { x("csv") })); const b = document.getElementById("exportNewPriceToExcelButton"); function v() { const e = document.getElementById("exportDisclaimerModal"); e.style.display = "none", e.classList.remove("show") } b && b.addEventListener("click", (function () { x("excel") })), s(), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e.style.display = "none", e.classList.remove("show"), loadPrices() })) })), document.querySelectorAll('#exportDisclaimerModal .close, #exportDisclaimerModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { v() })) })) }));