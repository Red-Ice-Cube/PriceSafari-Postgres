document.addEventListener("DOMContentLoaded", (function () { const e = "selectedPriceChanges_" + storeId; var t = []; const n = localStorage.getItem(e); if (n) try { t = JSON.parse(n) } catch (e) { console.error("Błąd parsowania danych z localStorage:", e) } let o = null, r = storeId || "Sklep", i = {}; function a() { return (new Date).toISOString().split("T")[0] } function c() { var e = t.filter((function (e) { return e.newPrice > e.currentPrice })).length, n = t.filter((function (e) { return e.newPrice < e.currentPrice })).length, o = t.length, r = document.getElementById("summaryText"); r && (r.innerHTML = "<div class='price-change-up' style='display: inline-block;'><span style='color: red;'>▲</span> " + e + "</div><div class='price-change-down' style='display: inline-block;'><span style='color: green;'>▼</span> " + n + "</div>"); var i = document.getElementById("simulateButton"); i && (i.disabled = 0 === o, i.style.opacity = 0 === o ? "0.5" : "1") } function d() { localStorage.setItem(e, JSON.stringify(t)) } const l = document.getElementById("clearChangesButton"); function s() { var e = t.map((function (e) { return { ProductId: e.productId, CurrentPrice: e.currentPrice, NewPrice: e.newPrice, StoreId: storeId } })); fetch("/PriceHistory/GetPriceChangeDetails?productIds=" + encodeURIComponent(JSON.stringify(t.map((function (e) { return e.productId }))))).then((function (e) { return e.json() })).then((function (n) { console.log("Pobrane productDetails:", n); var o = n.some((function (e) { return e.imageUrl && "" !== e.imageUrl.trim() })); fetch("/PriceHistory/SimulatePriceChange", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }).then((function (e) { return e.json() })).then((function (e) { e.ourStoreName && (r = e.ourStoreName); var a = e.simulationResults || []; console.log("Otrzymane simulationResults:", a), i = {}, a.forEach((e => { const t = parseInt(e.productId), n = e.ean ? String(e.ean) : ""; i[t] = n, console.log("[openSimulationModal] Ustawiam eanMapGlobal[", t, "] =", n) })); var c = '<table class="table-orders"><thead><tr>'; o && (c += "<th>Produkt</th>"), c += "<th></th>", c += "<th>Obecne</th>", c += "<th>Zmiana</th>", c += "<th>Po zmianie</th>", c += "<th>Usuń</th>", c += "</tr></thead><tbody>", t.forEach((function (e) { var t = n.find((function (t) { return parseInt(t.productId) === parseInt(e.productId) })), r = t ? t.productName : e.productName, i = t ? t.imageUrl : "", d = a.find((function (t) { return parseInt(t.productId) === parseInt(e.productId) })); let l = ""; d && d.ean ? l = String(d.ean) : t && t.ean && (l = String(t.ean)), console.log("Product ID:", e.productId, " ==> EAN:", l); var s = e.newPrice - e.currentPrice, u = s > 0 ? '<span style="color: red;">▲</span>' : s < 0 ? '<span style="color: green;">▼</span>' : '<span style="color: gray;">●</span>', p = ""; d && d.totalGoogleOffers && (p = '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;"> Pozycja cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px;" /> ' + d.currentGoogleRanking + " / " + d.totalGoogleOffers + "</div>"); var g = ""; d && d.totalCeneoOffers && (g = '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;"> Pozycja cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px;" /> ' + d.currentCeneoRanking + " / " + d.totalCeneoOffers + "</div>"); var m = ""; d && d.totalGoogleOffers && (m = '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;"> Pozycja cenowa | <img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px;" /> ' + d.newGoogleRanking + " / " + d.totalGoogleOffers + "</div>"); var f = ""; d && d.totalCeneoOffers && (f = '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;"> Pozycja cenowa | <img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px;" /> ' + d.newCeneoRanking + " / " + d.totalCeneoOffers + "</div>"); let y = '<div class="price-info-box">'; if (y += '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;">Cena produktu | ' + e.currentPrice.toFixed(2) + " PLN</div>", p && (y += p), g && (y += g), d && null != d.currentMargin && null != d.currentMarginValue) { let e = parseFloat(d.currentMarginValue).toFixed(2), t = parseFloat(d.currentMargin).toFixed(2), n = parseFloat(d.currentMarginValue) >= 0 ? "+" : ""; y += `\n                                <div class="price-info-item">\n                                    <div class="price-box-diff-margin ${parseFloat(d.currentMarginValue) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                                        <p>Marża: ${n}${e} PLN (${n}${t}%)</p>\n                                    </div>\n                                </div>` } y += "</div>"; let h = '<div class="price-info-box">'; if (h += '<div class="price-info-item" style="padding: 4px 12px; background: rgb(245, 245, 245); border: 1px solid #e3e3e3; border-radius: 5px;">Cena produktu | ' + e.newPrice.toFixed(2) + " PLN</div>", m && (h += m), f && (h += f), d && null != d.newMargin && null != d.newMarginValue) { let e = parseFloat(d.newMarginValue).toFixed(2), t = parseFloat(d.newMargin).toFixed(2), n = parseFloat(d.newMarginValue) >= 0 ? "+" : ""; h += `\n                                <div class="price-info-item">\n                                    <div class="price-box-diff-margin ${parseFloat(d.newMarginValue) >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"}">\n                                        <p>Marża: ${n}${e} PLN (${n}${t}%)</p>\n                                    </div>\n                                </div>` } h += "</div>", c += "<tr>", o && (i && "" !== i.trim() ? c += `\n                                    <td>\n                                        <div class="price-info-item" style="padding:4px;">\n                                            <img\n                                                data-src="${i}"\n                                                alt="${r}"\n                                                class="lazy-load loaded"\n                                                style="width: 114px; height: 114px; margin-right: 5px; margin-left: 5px; background-color: #fff; border: 1px solid #e3e3e3; border-radius: 4px; padding: 10px; display: block;"\n                                                src="${i}"\n                                            >\n                                        </div>\n                                    </td>` : c += "<td></td>"), c += '<td><div class="price-info-item" style="font-size:125%;">' + r + "</div>" + (l ? '<div class="price-info-item">EAN: ' + l + "</div>" : "") + "</td>", c += "<td>" + y + "</td>", c += '<td style="font-size:16px; white-space: nowrap;">' + u + " " + Math.abs(s).toFixed(2) + " PLN</td>", c += "<td>" + h + "</td>", c += '<td><button class="remove-change-btn" data-product-id="' + e.productId + '" style="background: none; border: none; padding: 5px; display: flex; align-items: center; margin-left:8px; justify-content: center;"><i class="fa fa-trash-o" style="font-size: 19px; color: red;"></i></button></td>', c += "</tr>" })), c += "</tbody></table>"; var d = document.getElementById("simulationModalBody"); d && (d.innerHTML = c), document.querySelectorAll(".remove-change-btn").forEach((function (e) { e.addEventListener("click", (function (e) { e.stopPropagation(); var t = this.getAttribute("data-product-id"); const n = new CustomEvent("priceBoxChangeRemove", { detail: { productId: t } }); document.dispatchEvent(n), s() })) })); var l = document.getElementById("simulationModal"); l.style.display = "block", l.classList.add("show") })).catch((function (e) { console.error("Błąd symulacji zmian:", e) })) })).catch((function (e) { console.error("Błąd pobierania danych produktu:", e) })) } function u(e) { o = e; const t = document.getElementById("exportDisclaimerModal"); t.style.display = "block", t.classList.add("show") } l && l.addEventListener("click", (function () { !function () { t = [], d(), c(); const e = document.getElementById("simulationModalBody"); e && (e.innerHTML = "") }() })), document.addEventListener("priceBoxChange", (function (e) { const { productId: n, productName: o, currentPrice: r, newPrice: i } = e.detail; console.log("Dodano zmianę ceny:", { productId: n, productName: o, currentPrice: r, newPrice: i }); var a = t.findIndex((function (e) { return e.productId === n })); a > -1 ? t[a] = { productId: n, productName: o, currentPrice: r, newPrice: i } : t.push({ productId: n, productName: o, currentPrice: r, newPrice: i }), d(), c() })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: n } = e.detail; console.log("Usunięto zmianę ceny dla produktu:", n), t = t.filter((function (e) { return parseInt(e.productId) !== parseInt(n) })), d(), c() })); const p = document.getElementById("disclaimerConfirmButton"); p && p.addEventListener("click", (function () { !function () { const e = document.getElementById("exportDisclaimerModal"); e.style.display = "none", e.classList.remove("show") }(), "csv" === o ? function () { console.log("Eksport CSV - używamy eanMapGlobal:", i); let e = "EAN;Nowa cena\n"; t.forEach((t => { const n = parseInt(t.productId), o = i[n] || "", r = null != t.newPrice ? t.newPrice.toFixed(2) : ""; console.log("CSV => PID:", n, "EAN:", o, "NowaCena:", r), e += `${o};${r}\n` })); const n = `PriceSafari-${a()}-${r}.csv`, o = new Blob([e], { type: "text/csv;charset=utf-8;" }), c = document.createElement("a"); c.href = URL.createObjectURL(o), c.download = n, c.click(), setTimeout((() => { URL.revokeObjectURL(c.href) }), 1e3) }() : "excel" === o && async function () { console.log("Eksport XLSX - używamy eanMapGlobal:", i); const e = new ExcelJS.Workbook, n = e.addWorksheet("Zmiany Cen"); n.addRow(["EAN", "Nowa Cena"]), t.forEach((e => { const t = parseInt(e.productId), o = i[t] || "", r = null != e.newPrice ? e.newPrice.toFixed(2) : ""; console.log("XLSX => PID:", t, "EAN:", o, "NowaCena:", r), n.addRow([o, r]) })), n.columns = [{ key: "ean", width: 18 }, { key: "newPrice", width: 15 }]; const o = `PriceSafari-${a()}-${r}.xlsx`, c = await e.xlsx.writeBuffer(), d = new Blob([c], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), l = document.createElement("a"); l.href = URL.createObjectURL(d), l.download = o, l.click(), setTimeout((() => { URL.revokeObjectURL(l.href) }), 1e3) }() })); var g = document.getElementById("simulateButton"); g && g.addEventListener("click", (function () { s() })); const m = document.getElementById("exportToCsvButton"); m && m.addEventListener("click", (function () { u("csv") })); const f = document.getElementById("exportNewPriceToExcelButton"); f && f.addEventListener("click", (function () { u("excel") })), c(), document.querySelectorAll('#simulationModal .close, #simulationModal [data-dismiss="modal"]').forEach((function (e) { e.addEventListener("click", (function () { var e = document.getElementById("simulationModal"); e.style.display = "none", e.classList.remove("show"), loadPrices() })) })) }));