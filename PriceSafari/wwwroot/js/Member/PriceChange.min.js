document.addEventListener("DOMContentLoaded", (function () { let e, t, n = [], i = null, o = "", a = 2, r = 2, c = 2, s = document.getElementById("usePriceDifference").checked, l = null, d = "", m = new Set, u = { sortName: null, sortPrice: null, sortRaiseAmount: null, sortRaisePercentage: null, sortLowerAmount: null, sortLowerPercentage: null, sortMarginAmount: null, sortMarginPercentage: null, showRejected: null }; function p(e, t) { let n; return function (...i) { const o = this; clearTimeout(n), n = setTimeout((() => e.apply(o, i)), t) } } e = document.getElementById("positionRangeSlider"); var g = document.getElementById("positionRange"); function h(e, t, n) { let i = parseFloat(e.value.replace(",", ".")); isNaN(i) || (e.value = i < t ? t.toFixed(2) : i > n ? n.toFixed(2) : i.toFixed(2)) } noUiSlider.create(e, { start: [1, 60], connect: !0, range: { min: 1, max: 60 }, step: 1, format: wNumb({ decimals: 0 }) }); const f = document.getElementById("price1"), L = document.getElementById("price2"), y = document.getElementById("stepPrice"); f.addEventListener("blur", (() => { h(f, .01, 100), parseFloat(y.value.replace(",", ".")) > parseFloat(f.value.replace(",", ".")) && (y.value = f.value), h(y, .01, parseFloat(f.value.replace(",", "."))), C() })), L.addEventListener("blur", (() => { h(L, .01, 100), C() })), y.addEventListener("blur", (() => { h(y, .01, parseFloat(f.value.replace(",", "."))), C() })), e.noUiSlider.on("update", (function (e, t) { const n = e.map((e => 60 === parseInt(e) ? "Schowany" : "Pozycja " + e)); g.textContent = n.join(" - ") })), e.noUiSlider.on("change", (function () { H() })), e.noUiSlider.on("change", (function () { H() })), t = document.getElementById("offerRangeSlider"); var P = document.getElementById("offerRange"); noUiSlider.create(t, { start: [1, 1], connect: !0, range: { min: 1, max: 1 }, step: 1, format: wNumb({ decimals: 0 }) }), t.noUiSlider.on("update", (function (e, t) { const n = e.map((e => { const t = parseInt(e); let n = " Ofert"; return 1 === t ? n = " Oferta" : t >= 2 && t <= 4 && (n = " Oferty"), t + n })); P.textContent = n.join(" - ") })), t.noUiSlider.on("change", (function () { H() })); const C = p((function () { const e = document.getElementById("usePriceDifference").checked; n.forEach((t => { t.valueToUse = e ? null !== t.savings ? t.savings : t.priceDifference : t.percentageDifference, t.colorClass = B(t.valueToUse, t.isUniqueBestPrice, t.isSharedBestPrice) })), H() }), 300); function v() { fetch(`/PriceHistory/GetStores?storeId=${storeId}`).then((e => e.json())).then((e => { const t = document.getElementById("competitorStoreSelect"); e.forEach((e => { const n = document.createElement("option"); n.value = e, n.text = e, t.appendChild(n) })), t.addEventListener("change", (function () { d = this.value, M() })) })).catch((e => console.error("Error fetching stores:", e))) } const E = document.getElementById("usePriceDifference"), x = document.getElementById("unitLabel1"), N = document.getElementById("unitLabel2"), I = document.getElementById("unitLabelStepPrice"); function b(e) { e ? (x.textContent = "PLN", N.textContent = "PLN", I.textContent = "PLN") : (x.textContent = "%", N.textContent = "%", I.textContent = "%") } function M() { const e = document.getElementById("sourceSelect").value; fetch(`/PriceHistory/GetPrices?storeId=${storeId}&competitorStore=${encodeURIComponent(d)}&source=${encodeURIComponent(e)}`).then((e => e.json())).then((e => { o = e.myStoreName, a = e.setPrice1, r = e.setPrice2, c = e.stepPrice, missedProductsCount = e.missedProductsCount, s = e.usePriceDiff, document.getElementById("usePriceDifference").checked = s, b(s), n = e.prices.map((e => { const t = e.isRejected, n = !0 === e.onlyMe; let i = null, o = ""; n ? o = "prOnlyMe" : t ? o = "prRejected" : (i = s ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, o = B(i, e.isUniqueBestPrice, e.isSharedBestPrice)); const a = null == e.marginPrice || isNaN(e.marginPrice) ? null : parseFloat(e.marginPrice), r = null == e.myPrice || isNaN(e.myPrice) ? null : parseFloat(e.myPrice); let c = null, l = null, d = "", m = ""; return t || null == a || null == r || (c = r - a, l = 0 !== a ? c / a * 100 : null, d = c >= 0 ? "+" : "-", m = c >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"), { ...e, isRejected: e.isRejected || !1, onlyMe: n, valueToUse: n ? null : i, colorClass: o, marginPrice: a, myPrice: r, marginAmount: c, marginPercentage: l, marginSign: d, marginClass: m } })); const i = n.map((e => e.storeCount)), l = Math.max(...i), d = Math.max(l, 1); t.noUiSlider.updateOptions({ range: { min: 1, max: d } }), t.noUiSlider.set([1, d]), document.getElementById("totalPriceCount").textContent = e.priceCount, document.getElementById("price1").value = a, document.getElementById("price2").value = r, document.getElementById("stepPrice").value = c, document.getElementById("missedProductsCount").textContent = missedProductsCount, F(n); const m = document.getElementById("productSearch").value; let u = n; m && (u = u.filter((e => { const t = m.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); return (e.productName || "").toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(t) }))), u = w(u), S(u), A(u), k(u), function () { const e = n.some((e => null !== e.marginAmount && null !== e.marginPercentage)), t = document.getElementById("sortMarginAmount"), i = document.getElementById("sortMarginPercentage"); e ? (t.style.display = "", i.style.display = "") : (t.style.display = "none", i.style.display = "none") }() })) } function F(e) { const t = {}; let n = 0; e.forEach((e => { 0 === e.flagIds.length && n++, e.flagIds.forEach((e => { t[e] || (t[e] = 0), t[e]++ })) })); const i = document.getElementById("flagContainer"); i.innerHTML = "", flags.forEach((e => { const n = t[e.FlagId] || 0, o = `\n            <div class="form-check">\n                <input class="form-check-input flagFilter" type="checkbox" id="flagCheckbox_${e.FlagId}" value="${e.FlagId}" ${m.has(e.FlagId.toString()) ? "checked" : ""}>\n                <label class="form-check-label" for="flagCheckbox_${e.FlagId}">${e.FlagName} (${n})</label>\n            </div>\n        `; i.innerHTML += o })); const o = `\n        <div class="form-check">\n            <input class="form-check-input flagFilter" type="checkbox" id="noFlagCheckbox" value="noFlag" ${m.has("noFlag") ? "checked" : ""}>\n            <label class="form-check-label" for="noFlagCheckbox">Brak flagi (${n})</label>\n        </div>\n        `; i.innerHTML += o, document.querySelectorAll(".flagFilter").forEach((e => { e.addEventListener("change", (function () { const e = this.value; this.checked ? m.add(e) : m.delete(e), H() })) })) } function w(n) { const i = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), o = document.getElementById("bidFilter").checked, a = document.getElementById("suspiciouslyLowFilter").checked, r = Array.from(document.querySelectorAll(".deliveryFilterMyStore:checked")).map((e => parseInt(e.value))), c = Array.from(document.querySelectorAll(".deliveryFilterCompetitor:checked")).map((e => parseInt(e.value))), s = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)), l = e.noUiSlider.get(), d = parseInt(l[0]), u = parseInt(l[1]), p = t.noUiSlider.get(), g = parseInt(p[0]), h = parseInt(p[1]); let f = n; return f = f.filter((e => { const t = e.myPosition; if (null == t) return !0; const n = parseInt(t), i = n >= d && n <= u; return i })), f = f.filter((e => { const t = e.storeCount; return t >= g && t <= h })), a && (f = f.filter((e => null !== e.singleBestCheaperDiffPerc && e.singleBestCheaperDiffPerc > 25)), f.sort(((e, t) => t.singleBestCheaperDiffPerc - e.singleBestCheaperDiffPerc))), i.length && (f = f.filter((e => i.includes(e.colorClass)))), m.has("noFlag") ? f = f.filter((e => 0 === e.flagIds.length)) : m.size > 0 && (f = f.filter((e => Array.from(m).some((t => e.flagIds.includes(parseInt(t))))))), o && (f = f.filter((e => "1" === e.myIsBidding))), r.length && (f = f.filter((e => r.includes(e.myDelivery)))), c.length && (f = f.filter((e => c.includes(e.delivery)))), s.includes("yes") ? f = f.filter((e => null !== e.externalPrice)) : s.includes("no") && (f = f.filter((e => null === e.externalPrice))), f } function B(e, t = !1, n = !1) { return t && e <= a ? "prIdeal" : t ? "prToLow" : n || e <= 0 ? "prGood" : e < r ? "prMid" : "prToHigh" } function D(e, t) { if (!t) return e; const n = t.replace(/[^a-zA-Z0-9]/g, "").toLowerCase(), i = e.replace(/[^a-zA-Z0-9]/g, "").toLowerCase().indexOf(n); if (-1 === i) return e; let o = [], a = 0; for (let t = 0; t < e.length; t++)/[a-zA-Z0-9]/.test(e[t]) && (o[a] = t, a++); const r = o[i], c = o[i + n.length - 1]; return e.substring(0, r) + '<span class="highlighted-text">' + e.substring(r, c + 1) + "</span>" + e.substring(c + 1) } function S(e) { const t = document.getElementById("priceContainer"), n = document.getElementById("productSearch").value.trim(), i = document.getElementById("storeSearch").value.trim(); t.innerHTML = "", e.forEach((e => { const a = e.isRejected, r = D(e.productName, n), d = D(e.storeName, i), m = "1" === e.isBidding, u = T(e.delivery); let p = null, g = null, h = null, f = null, L = null, y = null, P = null, C = "", v = "", E = null, x = null, N = null, I = null; a || (p = null != e.percentageDifference ? e.percentageDifference.toFixed(2) : "N/A", g = null != e.priceDifference ? e.priceDifference.toFixed(2) : "N/A", h = null != e.savings ? e.savings.toFixed(2) : "N/A", f = "1" === e.myIsBidding, L = T(e.myDelivery), y = e.marginAmount, P = e.marginPercentage, C = e.marginSign, v = e.marginClass, E = e.marginPrice, x = null != e.myPrice ? parseFloat(e.myPrice) : null, N = e.myPosition, I = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null); const b = document.createElement("div"); b.className = "price-box " + e.colorClass, b.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId, b.dataset.productId = e.productId, b.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })); const M = document.createElement("div"); M.className = "price-box-space"; const F = document.createElement("div"); F.className = "price-box-column-name", F.innerHTML = r; const w = document.createElement("div"); if (w.className = "price-box-column-category", e.externalId) { const t = document.createElement("span"); t.className = "ApiBox", t.innerHTML = "API ID " + e.externalId, w.appendChild(t) } const B = U(e), S = document.createElement("button"); S.className = "assign-flag-button", S.dataset.productId = e.productId, S.innerHTML = "+ Przypisz flagi", S.style.pointerEvents = "auto", S.addEventListener("click", (function (e) { e.stopPropagation(), l = this.dataset.productId, G.style.display = "block", fetch(`/ProductFlags/GetFlagsForProduct?productId=${l}`).then((e => e.json())).then((e => { document.querySelectorAll(".flagCheckbox").forEach((t => { t.checked = e.includes(parseInt(t.value)) })) })).catch((e => console.error("Błąd pobierania flag dla produktu:", e))) })), M.appendChild(F), M.appendChild(B), M.appendChild(S), M.appendChild(w); const A = document.createElement("div"); A.className = "price-box-externalInfo"; const k = document.createElement("div"); if (k.className = "price-box-column-offers", k.innerHTML = (e.sourceGoogle || e.sourceCeneo ? '<span class="data-channel">' + (e.sourceGoogle ? '<img src="/images/GoogleShopping.png" alt="Google Icon" style="width:15px; height:15px;" />' : "") + (e.sourceCeneo ? '<img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:15px; height:15px;" />' : "") + "</span>" : "") + '<div class="offer-count-box">' + e.storeCount + " Ofert</div>", A.appendChild(k), null != E) { const e = E.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = document.createElement("div"); if (t.className = "price-box-diff-margin " + v, t.innerHTML = "<p>Cena zakupu: " + e + "</p>", A.appendChild(t), null != x) { const e = C + Math.abs(y).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = "(" + C + Math.abs(P).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", n = document.createElement("div"); n.className = "price-box-diff-margin " + v, n.innerHTML = "<p>Marża: " + e + " " + t + "</p>", A.appendChild(n) } } M.appendChild(A); const H = document.createElement("div"); H.className = "price-box-data"; const R = document.createElement("div"); R.className = "color-bar " + e.colorClass; const q = document.createElement("div"); q.className = "price-box-column"; const j = document.createElement("div"); j.className = "price-box-column-text"; const O = document.createElement("div"); O.style.display = "flex"; const z = document.createElement("div"); if (z.style.fontWeight = "500", z.style.fontSize = "17px", z.textContent = e.lowestPrice.toFixed(2) + " PLN", O.appendChild(z), void 0 !== e.externalBestPriceCount && null !== e.externalBestPriceCount) if (1 === e.externalBestPriceCount) { const e = document.createElement("div"); e.className = "uniqueBestPriceBox", e.textContent = "★ TOP", e.style.marginLeft = "8px", O.appendChild(e) } else if (e.externalBestPriceCount > 1) { const t = document.createElement("div"); t.className = "shareBestPriceBox", t.textContent = e.externalBestPriceCount + " TOP", t.style.marginLeft = "8px", O.appendChild(t) } if (null !== e.singleBestCheaperDiffPerc && void 0 !== e.singleBestCheaperDiffPerc) { const t = document.createElement("div"); t.style.marginLeft = "4px", e.singleBestCheaperDiffPerc > 25 ? t.className = "singlePriceDiffBoxHigh" : t.className = "singlePriceDiffBox"; const n = document.createElement("span"); n.textContent = e.singleBestCheaperDiffPerc.toFixed(2) + "%", t.appendChild(n), O.appendChild(t) } j.appendChild(O); const $ = document.createElement("div"); $.textContent = d, j.appendChild($); const Z = document.createElement("div"); Z.className = "price-box-column-text", Z.innerHTML = (null != e.isGoogle ? '<span class="data-channel"><img src="' + (e.isGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== e.position ? e.isGoogle ? '<span class="Position-Google">Poz. Google ' + e.position + "</span>" : '<span class="Position">Poz. Ceneo ' + e.position + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (m ? '<span class="Bidding">Bid</span>' : "") + (null != e.delivery ? '<span class="' + u + '">Wysyłka w ' + (1 == e.delivery ? "1 dzień" : e.delivery + " dni") + "</span>" : ""), q.appendChild(j), q.appendChild(Z); const W = document.createElement("div"); if (W.className = "price-box-column", a || null == x) { const e = document.createElement("div"); e.className = "price-box-column-text", e.innerHTML = '<span style="font-weight: 500;">Brak ceny</span><br>' + o, W.appendChild(e) } else { const t = document.createElement("div"); if (t.className = "price-box-column-text", null !== e.externalPrice) { const n = (e.externalPrice - x).toFixed(2), i = e.externalPrice < x, a = document.createElement("div"); a.style.display = "flex", a.style.justifyContent = "space-between", a.style.alignItems = "center"; const r = document.createElement("span"); r.style.fontWeight = "500", r.style.marginRight = "20px", r.textContent = o; const c = document.createElement("span"); c.style.fontWeight = "500"; const s = '<span class="' + (i ? "arrow-down" : "arrow-up") + '"></span>'; c.innerHTML = s + (i ? "-" : "+") + Math.abs(n) + " PLN ", a.appendChild(r), a.appendChild(c); const l = document.createElement("div"); l.style.display = "flex", l.style.justifyContent = "space-between", l.style.alignItems = "center"; const d = document.createElement("span"); d.style.fontWeight = "500", d.style.textDecoration = "line-through", d.style.marginRight = "10px", d.textContent = x.toFixed(2) + " PLN"; const m = document.createElement("span"); m.style.fontWeight = "500", m.textContent = e.externalPrice.toFixed(2) + " PLN", l.appendChild(d), l.appendChild(m), t.appendChild(l), t.appendChild(a) } else t.innerHTML = '<span style="font-weight: 500; font-size:17px;">' + x.toFixed(2) + " PLN</span><br>" + o; const n = document.createElement("div"); n.className = "price-box-column-text", n.innerHTML = (null != e.myIsGoogle ? '<span class="data-channel"><img src="' + (e.myIsGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== N ? e.myIsGoogle ? '<span class="Position-Google">Poz. Google ' + N + "</span>" : '<span class="Position">Poz. Ceneo ' + N + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (f ? '<span class="Bidding">Bid</span>' : "") + (null != e.myDelivery ? '<span class="' + L + '">Wysyłka w ' + (1 == e.myDelivery ? "1 dzień" : e.myDelivery + " dni") + "</span>" : ""), W.appendChild(t), W.appendChild(n) } const J = document.createElement("div"); if (J.className = "price-box-column-action", J.innerHTML = "", a) J.innerHTML += '<div class="rejected-product">Produkt odrzucony</div>'; else if ("prOnlyMe" === e.colorClass) { const t = e.colorClass + " priceBox-diff-top"; J.innerHTML += '<div class="' + t + '">Brak ofert konkurencji</div>' } else if ("prToLow" === e.colorClass || "prIdeal" === e.colorClass) if (null != x && null != h) { const t = parseFloat(h.replace(",", ".")), n = "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise", i = x + t, o = t / x * 100; let a, r, l, d = n; if (s) t < 1 ? (a = i - c, r = a - x, l = r / x * 100, r < 0 && (d = "arrow-down-turquoise")) : (a = i - c, r = t - c, l = r / x * 100, r < 0 && (d = "arrow-down-turquoise")); else { const e = c / 100; t < 1 ? (a = i * (1 - e), r = a - x, l = r / x * 100, r < 0 && (d = "arrow-down-turquoise")) : (a = i * (1 - e), r = t - x * e, l = r / x * 100, r < 0 && (d = "arrow-down-turquoise")) } const m = (t >= 0 ? "+" : "") + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(" + (o >= 0 ? "+" : "") + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", p = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", g = (r >= 0 ? "+" : "") + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", f = "(" + (l >= 0 ? "+" : "") + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", L = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", y = document.createElement("div"); y.className = "price-box-column"; const P = document.createElement("div"); P.className = "price-action-line"; const C = document.createElement("span"); C.className = n; const v = document.createElement("span"); v.innerHTML = m + " " + u; const E = document.createElement("div"); E.innerHTML = "= " + p; const N = document.createElement("span"); N.className = "color-square-green", P.appendChild(C), P.appendChild(v), P.appendChild(E), P.appendChild(N), y.appendChild(P); const I = document.createElement("div"); I.className = "price-box-column"; const b = document.createElement("div"); b.className = "price-action-line"; const M = document.createElement("span"); M.className = d; const F = document.createElement("span"); F.innerHTML = g + " " + f; const w = document.createElement("div"); w.innerHTML = "= " + L; const B = document.createElement("span"); B.className = "color-square-turquoise", b.appendChild(M), b.appendChild(F), b.appendChild(w), b.appendChild(B), I.appendChild(b), J.appendChild(y), J.appendChild(I) } else { const t = e.colorClass + " priceBox-diff"; J.innerHTML += '<div class="' + t + '">Podnieś: N/A</div>' } else if ("prMid" === e.colorClass) if (null != x && null != I) { const e = x - I, t = e / x * 100; let n; n = s ? I - c : I * (1 - c / 100); const i = x - n, o = i / x * 100, a = e.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", r = "(-" + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", l = I.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", d = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = "(-" + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", u = n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", p = document.createElement("div"); p.className = "price-box-column"; const g = document.createElement("div"); g.className = "price-action-line"; const h = document.createElement("span"); h.className = "arrow-down-yellow"; const f = document.createElement("span"); f.innerHTML = "-" + a + " " + r; const L = document.createElement("div"); L.innerHTML = "= " + l; const y = document.createElement("span"); y.className = "color-square-green", g.appendChild(h), g.appendChild(f), g.appendChild(L), g.appendChild(y), p.appendChild(g); const P = document.createElement("div"); P.className = "price-box-column"; const C = document.createElement("div"); C.className = "price-action-line"; const v = document.createElement("span"); v.className = "arrow-down-yellow"; const E = document.createElement("span"); E.innerHTML = "-" + d + " " + m; const N = document.createElement("div"); N.innerHTML = "= " + u; const b = document.createElement("span"); b.className = "color-square-turquoise", C.appendChild(v), C.appendChild(E), C.appendChild(N), C.appendChild(b), P.appendChild(C), J.appendChild(p), J.appendChild(P) } else { const t = e.colorClass + " priceBox-diff"; J.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prToHigh" === e.colorClass) if (null != x && null != I) { const e = x - I, t = e / x * 100; let n; n = s ? I - c : I * (1 - c / 100); const i = x - n, o = i / x * 100, a = e.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", r = "(-" + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", l = I.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", d = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = "(-" + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", u = n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", p = document.createElement("div"); p.className = "price-box-column"; const g = document.createElement("div"); g.className = "price-action-line"; const h = document.createElement("span"); h.className = "arrow-down-red"; const f = document.createElement("span"); f.innerHTML = "-" + a + " " + r; const L = document.createElement("div"); L.innerHTML = "= " + l; const y = document.createElement("span"); y.className = "color-square-green", g.appendChild(h), g.appendChild(f), g.appendChild(L), g.appendChild(y), p.appendChild(g); const P = document.createElement("div"); P.className = "price-box-column"; const C = document.createElement("div"); C.className = "price-action-line"; const v = document.createElement("span"); v.className = "arrow-down-red"; const E = document.createElement("span"); E.innerHTML = "-" + d + " " + m; const N = document.createElement("div"); N.innerHTML = "= " + u; const b = document.createElement("span"); b.className = "color-square-turquoise", C.appendChild(v), C.appendChild(E), C.appendChild(N), C.appendChild(b), P.appendChild(C), J.appendChild(p), J.appendChild(P) } else { const t = e.colorClass + " priceBox-diff"; J.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prGood" === e.colorClass) if (null != x) { const t = "+0,00 PLN", n = "(+0,00%)", i = "= " + x.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN"; let o, a, r, l, d, m, u, p; if (1 === e.storeCount) o = 0, a = 0, r = x, l = "+0,00 PLN", d = "(+0,00%)", m = "= " + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "no-change-icon-turquoise", p = "color-square-turquoise"; else { if (s) o = -c, r = x + o, a = o / x * 100; else { const e = c / 100; o = -x * e, r = x * (1 - e), a = -c } l = (o >= 0 ? "+" : "") + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", d = "(" + (a >= 0 ? "+" : "") + a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", m = "= " + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "arrow-down-green", p = "color-square-turquoise" } const g = document.createElement("div"); g.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line"; const f = document.createElement("span"); f.className = "no-change-icon"; const L = document.createElement("span"); L.innerHTML = t + " " + n; const y = document.createElement("div"); y.innerHTML = i; const P = document.createElement("span"); P.className = "color-square-green", h.appendChild(f), h.appendChild(L), h.appendChild(y), h.appendChild(P), g.appendChild(h); const C = document.createElement("div"); C.className = "price-box-column"; const v = document.createElement("div"); v.className = "price-action-line"; const E = document.createElement("span"); E.className = u; const N = document.createElement("span"); N.innerHTML = l + " " + d; const I = document.createElement("div"); I.innerHTML = m; const b = document.createElement("span"); b.className = p, v.appendChild(E), v.appendChild(N), v.appendChild(I), v.appendChild(b), C.appendChild(v), J.appendChild(g), J.appendChild(C) } else { const t = e.colorClass + " priceBox-diff-top"; J.innerHTML += '<div class="' + t + '">Jesteś w najlepszych cenach</div>' } if (H.appendChild(R), e.imgUrl) { const t = document.createElement("img"); t.dataset.src = e.imgUrl, t.alt = e.productName, t.className = "lazy-load", t.style.width = "110px", t.style.height = "110px", t.style.marginRight = "5px", t.style.marginLeft = "5px", t.style.backgroundColor = "#ffffff", t.style.border = "1px solid #e3e3e3", t.style.borderRadius = "4px", t.style.padding = "10px", t.style.display = "block", H.appendChild(t) } H.appendChild(q), H.appendChild(W), H.appendChild(J), b.appendChild(M), b.appendChild(w), b.appendChild(A), b.appendChild(H), t.appendChild(b) })); const a = document.querySelectorAll('.price-box:not([style*="display: none"])'); document.getElementById("displayedProductCount").textContent = a.length; Array.from(a).map((e => parseInt(e.dataset.index))); const r = document.querySelectorAll(".lazy-load"), d = new Map, m = new IntersectionObserver(((e, t) => { e.forEach((e => { const n = e.target, i = [...r].indexOf(n); if (e.isIntersecting) { const e = setTimeout((() => { !function (e) { const t = 6, n = Math.max(0, e - t), i = Math.min(r.length - 1, e + t); for (let e = n; e <= i; e++) { const t = r[e]; t.src || (t.src = t.dataset.src, t.onload = () => { t.classList.add("loaded") }) } }(i), t.unobserve(n), d.delete(n) }), 100); d.set(n, e) } else d.has(n) && (clearTimeout(d.get(n)), d.delete(n)) })) }), { root: null, rootMargin: "50px", threshold: .01 }); r.forEach((e => { m.observe(e) })) } function T(e) { return e <= 1 ? "Availability1Day" : e <= 3 ? "Availability3Days" : e <= 7 ? "Availability7Days" : "Availability14Days" } E.addEventListener("change", (function () { s = this.checked, b(s), C() })); const A = p((function (e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { e.isRejected || (t[e.colorClass] = (t[e.colorClass] || 0) + 1) })); const n = [t.prOnlyMe, t.prToHigh, t.prMid, t.prGood, t.prIdeal, t.prToLow]; if (i) i.data.datasets[0].data = n, i.update(); else { const e = document.getElementById("colorChart").getContext("2d"); i = new Chart(e, { type: "doughnut", data: { labels: ["Nieporównywalna", "Zawyżona", "Suboptymalna", "Konkurencyjna", "Strategiczna", "Zaniżona"], datasets: [{ data: n, backgroundColor: ["rgba(180, 180, 180, 0.8)", "rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(0, 145, 123, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(180, 180, 180, 1)", "rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(0, 145, 123, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, cutout: "60%", plugins: { legend: { display: !1 }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } }), 600); function k(e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })), document.querySelector('label[for="prOnlyMeCheckbox"]').textContent = `Nieporównywalna (${t.prOnlyMe})`, document.querySelector('label[for="prToHighCheckbox"]').textContent = `Zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Zaniżona (${t.prToLow})` } function H() { const e = document.getElementById("productSearch").value.toLowerCase().replace(/\s+/g, "").trim(), t = document.getElementById("storeSearch").value.toLowerCase().replace(/\s+/g, "").trim(), i = e.replace(/[^a-zA-Z0-9\s/.-]/g, "").toLowerCase().replace(/\s+/g, ""), o = t.replace(/[^a-zA-Z0-9\s/.-]/g, "").toLowerCase().replace(/\s+/g, ""); let a = n.filter((e => { const t = (e.productName || "").toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), n = (e.storeName || "").toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), a = t.includes(i), r = n.includes(o); return ("" === i || a) && ("" === o || r) })); a.sort(((e, t) => { const n = e.productName.toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), o = t.productName.toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), a = j(n, i), r = j(o, i); if (a !== r) return a - r; const c = O(n, i), s = O(o, i); return c !== s ? s - c : e.productName.localeCompare(t.productName) })), a = w(a), a = u.showRejected ? a.filter((e => e.isRejected)) : a.filter((e => !e.isRejected)), null !== u.sortName ? "asc" === u.sortName ? a.sort(((e, t) => e.productName.localeCompare(t.productName))) : a.sort(((e, t) => t.productName.localeCompare(e.productName))) : null !== u.sortPrice ? "asc" === u.sortPrice ? a.sort(((e, t) => e.lowestPrice - t.lowestPrice)) : a.sort(((e, t) => t.lowestPrice - e.lowestPrice)) : null !== u.sortRaiseAmount ? (a = a.filter((e => !e.isRejected && null !== e.savings)), "asc" === u.sortRaiseAmount ? a.sort(((e, t) => e.savings - t.savings)) : a.sort(((e, t) => t.savings - e.savings))) : null !== u.sortRaisePercentage ? (a = a.filter((e => !e.isRejected && null !== e.savings)), "asc" === u.sortRaisePercentage ? a.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : a.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== u.sortLowerAmount ? (a = a.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === u.sortLowerAmount ? a.sort(((e, t) => e.priceDifference - t.priceDifference)) : a.sort(((e, t) => t.priceDifference - e.priceDifference))) : null !== u.sortLowerPercentage ? (a = a.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === u.sortLowerPercentage ? a.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : a.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== u.sortMarginAmount ? (a = a.filter((e => null !== e.marginAmount)), "asc" === u.sortMarginAmount ? a.sort(((e, t) => e.marginAmount - t.marginAmount)) : a.sort(((e, t) => t.marginAmount - e.marginAmount))) : null !== u.sortMarginPercentage && (a = a.filter((e => null !== e.marginPercentage)), "asc" === u.sortMarginPercentage ? a.sort(((e, t) => e.marginPercentage - t.marginPercentage)) : a.sort(((e, t) => t.marginPercentage - e.marginPercentage))), S(a), A(a), k(a), F(a) } function R(e) { for (let t in u) if (t !== e) if ("showRejected" === t) { u[t] = !1; let e = document.getElementById("showRejectedButton"); e && e.classList.remove("active") } else { u[t] = null; let e = document.getElementById(t); e && (e.innerHTML = q(t), e.classList.remove("active")) } } function q(e) { switch (e) { case "sortName": return "A-Z"; case "sortPrice": return "Cena"; case "sortRaiseAmount": return "Podnieś PLN"; case "sortRaisePercentage": return "Podnieś %"; case "sortLowerAmount": return "Obniż PLN"; case "sortLowerPercentage": return "Obniż %"; case "sortMarginAmount": return "Marża PLN"; case "sortMarginPercentage": return "Marża %"; case "showRejected": return "Pokaż Odrzucone"; default: return "" } } function j(e, t) { return e.indexOf(t) } function O(e, t) { let n = 0; for (let i = 0; i < e.length; i++)for (let o = i; o <= e.length; o++) { const a = e.slice(i, o); t.includes(a) && a.length > n && (n = a.length) } return n } document.getElementById("showRejectedButton").addEventListener("click", (function () { u.showRejected = !u.showRejected, u.showRejected ? this.classList.add("active") : this.classList.remove("active"), R("showRejected"), H() })); const z = p((function () { H() }), 300); document.getElementById("productSearch").addEventListener("input", z), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .deliveryFilterMyStore, .deliveryFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { H() })) })), document.getElementById("bidFilter").addEventListener("change", (function () { H() })), document.getElementById("suspiciouslyLowFilter").addEventListener("change", (function () { H() })), document.getElementById("sortName").addEventListener("click", (function () { null === u.sortName ? (u.sortName = "asc", this.innerHTML = "A-Z ↑", this.classList.add("active")) : "asc" === u.sortName ? (u.sortName = "desc", this.innerHTML = "A-Z ↓", this.classList.add("active")) : (u.sortName = null, this.innerHTML = "A-Z", this.classList.remove("active")), R("sortName"), H() })), document.getElementById("sortPrice").addEventListener("click", (function () { null === u.sortPrice ? (u.sortPrice = "asc", this.innerHTML = "Cena ↑", this.classList.add("active")) : "asc" === u.sortPrice ? (u.sortPrice = "desc", this.innerHTML = "Cena ↓", this.classList.add("active")) : (u.sortPrice = null, this.innerHTML = "Cena", this.classList.remove("active")), R("sortPrice"), H() })), document.getElementById("sortRaiseAmount").addEventListener("click", (function () { null === u.sortRaiseAmount ? (u.sortRaiseAmount = "asc", this.innerHTML = "Podnieś PLN ↑", this.classList.add("active")) : "asc" === u.sortRaiseAmount ? (u.sortRaiseAmount = "desc", this.innerHTML = "Podnieś PLN ↓", this.classList.add("active")) : (u.sortRaiseAmount = null, this.innerHTML = "Podnieś PLN", this.classList.remove("active")), R("sortRaiseAmount"), H() })), document.getElementById("sortRaisePercentage").addEventListener("click", (function () { null === u.sortRaisePercentage ? (u.sortRaisePercentage = "asc", this.innerHTML = "Podnieś % ↑", this.classList.add("active")) : "asc" === u.sortRaisePercentage ? (u.sortRaisePercentage = "desc", this.innerHTML = "Podnieś % ↓", this.classList.add("active")) : (u.sortRaisePercentage = null, this.innerHTML = "Podnieś %", this.classList.remove("active")), R("sortRaisePercentage"), H() })), document.getElementById("sortLowerAmount").addEventListener("click", (function () { null === u.sortLowerAmount ? (u.sortLowerAmount = "asc", this.innerHTML = "Obniż PLN ↑", this.classList.add("active")) : "asc" === u.sortLowerAmount ? (u.sortLowerAmount = "desc", this.innerHTML = "Obniż PLN ↓", this.classList.add("active")) : (u.sortLowerAmount = null, this.innerHTML = "Obniż PLN", this.classList.remove("active")), R("sortLowerAmount"), H() })), document.getElementById("sortLowerPercentage").addEventListener("click", (function () { null === u.sortLowerPercentage ? (u.sortLowerPercentage = "asc", this.innerHTML = "Obniż % ↑", this.classList.add("active")) : "asc" === u.sortLowerPercentage ? (u.sortLowerPercentage = "desc", this.innerHTML = "Obniż % ↓", this.classList.add("active")) : (u.sortLowerPercentage = null, this.innerHTML = "Obniż %", this.classList.remove("active")), R("sortLowerPercentage"), H() })), document.getElementById("sortMarginAmount").addEventListener("click", (function () { null === u.sortMarginAmount ? (u.sortMarginAmount = "asc", this.innerHTML = "Marża PLN ↑", this.classList.add("active")) : "asc" === u.sortMarginAmount ? (u.sortMarginAmount = "desc", this.innerHTML = "Marża PLN ↓", this.classList.add("active")) : (u.sortMarginAmount = null, this.innerHTML = "Marża PLN", this.classList.remove("active")), R("sortMarginAmount"), H() })), document.getElementById("sortMarginPercentage").addEventListener("click", (function () { null === u.sortMarginPercentage ? (u.sortMarginPercentage = "asc", this.innerHTML = "Marża % ↑", this.classList.add("active")) : "asc" === u.sortMarginPercentage ? (u.sortMarginPercentage = "desc", this.innerHTML = "Marża % ↓", this.classList.add("active")) : (u.sortMarginPercentage = null, this.innerHTML = "Marża %", this.classList.remove("active")), R("sortMarginPercentage"), H() })), document.getElementById("usePriceDifference").addEventListener("change", (function () { const e = this.checked; n.forEach((t => { t.valueToUse = e ? null !== t.savings ? t.savings : t.priceDifference : t.percentageDifference, t.colorClass = B(t.valueToUse, t.isUniqueBestPrice, t.isSharedBestPrice) })), H() })), document.getElementById("storeSearch").addEventListener("input", z), document.getElementById("price1").addEventListener("input", (function () { a = parseFloat(this.value), C() })), document.getElementById("price2").addEventListener("input", (function () { r = parseFloat(this.value), C() })), document.getElementById("stepPrice").addEventListener("input", (function () { c = parseFloat(this.value), C() })), document.getElementById("sourceSelect").addEventListener("change", (function () { v(), M() })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = parseFloat(document.getElementById("stepPrice").value), i = document.getElementById("usePriceDifference").checked, o = { StoreId: storeId, SetPrice1: e, SetPrice2: t, PriceStep: n, UsePriceDiff: i }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }).then((e => e.json())).then((o => { o.success ? (a = e, r = t, c = n, usePriceDifferenceGlobal = i, M()) : alert("Błąd zapisu wartości: " + o.message) })).catch((e => console.error("Błąd zapisu wartości:", e))) })); const G = document.getElementById("flagModal"); function U(e) { const t = document.createElement("div"); return t.className = "flags-container", e.flagIds && e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const n = flags.find((function (t) { return t.FlagId === e })); if (n) { const e = document.createElement("span"); e.className = "flag", e.style.color = n.FlagColor, e.style.border = "2px solid " + n.FlagColor, e.style.backgroundColor = function (e, t) { let n = 0, i = 0, o = 0; return 4 == e.length ? (n = parseInt(e[1] + e[1], 16), i = parseInt(e[2] + e[2], 16), o = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), i = parseInt(e[3] + e[4], 16), o = parseInt(e[5] + e[6], 16)), `rgba(${n}, ${i}, ${o}, ${t})` }(n.FlagColor, .3), e.innerHTML = n.FlagName, t.appendChild(e) } })), t } document.getElementsByClassName("close")[0].onclick = function () { G.style.display = "none" }, window.onclick = function (e) { e.target == G && (G.style.display = "none") }, document.getElementById("saveFlagsButton").addEventListener("click", (function () { const e = Array.from(document.querySelectorAll(".flagCheckbox:checked")).map((e => parseInt(e.value))), t = { productId: l, flagIds: e }; fetch("/ProductFlags/AssignFlagsToProduct", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((e => { e.success ? (G.style.display = "none", fetch(`/ProductFlags/GetFlagsForProduct?productId=${l}`).then((e => e.json())).then((e => { const t = parseInt(l), i = n.find((e => e.productId === t)); i ? i.flagIds = e : console.error("Product not found in allPrices:", l), function (e) { const t = parseInt(e), i = document.querySelector(`.price-box[data-product-id='${e}']`); if (i) { const o = i.querySelector(".flags-container"), a = n.find((e => e.productId === t)); if (a) { const e = U(a); o ? o.parentNode.replaceChild(e, o) : i.appendChild(e) } else console.error("Product not found in allPrices:", e) } }(l), F(n) })).catch((e => console.error("Error fetching updated flags for product:", e)))) : alert("Error assigning flags: " + e.message) })).catch((e => console.error("Error assigning flags:", e))) })), v(), M() }));