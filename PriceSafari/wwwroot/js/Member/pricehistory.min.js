document.addEventListener("DOMContentLoaded", (function () { let e, t, n = [], i = null, a = "", o = 2, r = 2, s = 2, c = document.getElementById("usePriceDifference").checked, l = { useEanForSimulation: !0, useMarginForSimulation: !0, usePriceWithDelivery: !0, enforceMinimalMargin: !0, minimalMarginPercent: 0 }, d = null, m = new Set, u = new Set, p = { sortName: null, sortPrice: null, sortRaiseAmount: null, sortRaisePercentage: null, sortLowerAmount: null, sortLowerPercentage: null, sortMarginAmount: null, sortMarginPercentage: null, showRejected: null }; const g = document.getElementById("openMassChangeModalBtn"), y = document.getElementById("massChangeModal"), f = document.querySelector("#massChangeModal .close"); g.addEventListener("click", (function () { $("#massChangeModal").modal("show") })), f.addEventListener("click", (function () { $("#massChangeModal").modal("hide") })), window.addEventListener("click", (function (e) { e.target === y && $("#massChangeModal").modal("hide") })); const h = document.getElementById("massMatchBtn"), P = document.getElementById("massStrategicBtn"); function v(e) { Array.from(document.querySelectorAll("#priceContainer .price-box")).forEach((t => { const n = t.querySelectorAll(".simulate-change-btn"); if (!n || 0 === n.length) return; let i; "match" === e && n[0] ? i = n[0] : "strategic" === e && n[1] && (i = n[1]), i && i.click() })), setTimeout((() => { const e = Array.from(document.querySelectorAll("#priceContainer .price-box")); let t = 0, n = 0; e.forEach((e => { e.classList.contains("price-changed") ? t++ : n++ })), E(`<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Masowa zmiana zakończona!</p>\n             <p>Dodano: <strong>${t}</strong> SKU</p>\n             <p>Odrzucono: <strong>${n}</strong> SKU</p>`) }), 500) } let L, C; function x(e) { const t = document.getElementById("globalNotification"), n = document.getElementById("globalUpdate"); t && (n && "block" === n.style.display && (n.style.display = "none", C && (clearTimeout(C), C = null)), L && clearTimeout(L), t.innerHTML = e, t.style.display = "block", L = setTimeout((() => { t.style.display = "none" }), 4e3)) } function E(e) { const t = document.getElementById("globalUpdate"), n = document.getElementById("globalNotification"); t && (n && "block" === n.style.display && (n.style.display = "none", L && (clearTimeout(L), L = null)), C && clearTimeout(C), t.innerHTML = e, t.style.display = "block", C = setTimeout((() => { t.style.display = "none" }), 4e3)) } h.addEventListener("click", (function () { v("match"), $("#massChangeModal").modal("hide") })), P.addEventListener("click", (function () { v("strategic"), $("#massChangeModal").modal("hide") })), "undefined" != typeof storeId ? function () { const e = localStorage.getItem("priceHistorySortingState_" + storeId); if (e) try { const t = JSON.parse(e); p = { ...p, ...t }, Object.keys(p).forEach((e => { const t = p[e], n = document.getElementById(e); if (n && null !== t && !1 !== t) switch (n.classList.add("active"), e) { case "sortName": n.innerHTML = "asc" === t ? "A-Z ↑" : "A-Z ↓"; break; case "sortPrice": n.innerHTML = "asc" === t ? "Cena ↑" : "Cena ↓"; break; case "sortRaiseAmount": n.innerHTML = "asc" === t ? "Podnieś PLN ↑" : "Podnieś PLN ↓"; break; case "sortRaisePercentage": n.innerHTML = "asc" === t ? "Podnieś % ↑" : "Podnieś % ↓"; break; case "sortLowerAmount": n.innerHTML = "asc" === t ? "Obniż PLN ↑" : "Obniż PLN ↓"; break; case "sortLowerPercentage": n.innerHTML = "asc" === t ? "Obniż % ↑" : "Obniż % ↓"; break; case "sortMarginAmount": n.innerHTML = "asc" === t ? "Marża PLN ↑" : "Marża PLN ↓"; break; case "sortMarginPercentage": n.innerHTML = "asc" === t ? "Marża % ↑" : "Marża % ↓"; break; case "showRejected": t || n.classList.remove("active") } else n && "showRejected" !== e ? (n.classList.remove("active"), n.innerHTML = Q(e)) : n && "showRejected" === e && n.classList.remove("active") })) } catch (e) { console.error("Błąd parsowania stanu sortowania z localStorage:", e), localStorage.removeItem("priceHistorySortingState_" + storeId) } }() : console.warn("storeId nie jest zdefiniowane podczas próby odtworzenia stanu sortowania."); let w = 1; const I = 1e3; function N(e, t) { let n; return function (...i) { const a = this; clearTimeout(n), n = setTimeout((() => e.apply(a, i)), t) } } window.refreshPriceBoxStates = function () { const e = localStorage.getItem("selectedPriceChanges_" + storeId); let t = new Set; if (e) try { JSON.parse(e).forEach((e => t.add(String(e.productId)))) } catch (e) { console.error("Błąd parsowania selectedPriceChanges w refreshPriceBoxStates:", e) } document.querySelectorAll("#priceContainer .price-box").forEach((e => { const n = e.dataset.productId; if (!n) return; const i = t.has(String(n)); if (e.classList.contains("price-changed") && !i) { e.classList.remove("price-changed"); e.querySelectorAll(".simulate-change-btn.active").forEach((e => { for (e.classList.remove("active"), e.style.backgroundColor = "", e.style.color = ""; e.firstChild;)e.removeChild(e.firstChild); e.textContent = e.dataset.originalText || "Zmień cenę" })) } else e.classList.contains("price-changed") })) }, e = document.getElementById("positionRangeSlider"); var M = document.getElementById("positionRange"); function F(e, t, n) { let i = parseFloat(e.value.replace(",", ".")); isNaN(i) || (e.value = i < t ? t.toFixed(2) : i > n ? n.toFixed(2) : i.toFixed(2)) } noUiSlider.create(e, { start: [1, 60], connect: !0, range: { min: 1, max: 60 }, step: 1, format: wNumb({ decimals: 0 }) }); const S = document.getElementById("price1"), b = document.getElementById("price2"), k = document.getElementById("stepPrice"); S.addEventListener("blur", (() => { F(S, .01), parseFloat(k.value.replace(",", ".")) > parseFloat(S.value.replace(",", ".")) && (k.value = S.value), F(k, .01, parseFloat(S.value.replace(",", "."))) })), b.addEventListener("blur", (() => { F(b, .01) })), k.addEventListener("blur", (() => { F(k, .01, parseFloat(S.value.replace(",", "."))) })), e.noUiSlider.on("update", (function (e, t) { const n = e.map((e => 60 === parseInt(e) ? "Schowany" : "Pozycja " + e)); M.textContent = n.join(" - ") })), e.noUiSlider.on("change", (function () { J() })), t = document.getElementById("offerRangeSlider"); var D = document.getElementById("offerRange"); noUiSlider.create(t, { start: [1, 1], connect: !0, range: { min: 1, max: 1 }, step: 1, format: wNumb({ decimals: 0 }) }), t.noUiSlider.on("update", (function (e, t) { const n = e.map((e => { const t = parseInt(e); let n = " Ofert"; return 1 === t ? n = " Oferta" : t >= 2 && t <= 4 && (n = " Oferty"), t + n })); D.textContent = n.join(" - ") })), t.noUiSlider.on("change", (function () { J() })); N((function () { const e = document.getElementById("usePriceDifference").checked; n.forEach((t => { const n = function (e, t) { if (e.onlyMe) return { valueToUse: null, colorClass: "prOnlyMe" }; { let n, i; return t ? (n = null !== e.savings ? e.savings : e.priceDifference, i = n) : (i = e.percentageDifference, n = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != n && (n = parseFloat(n.toFixed(2))), null != i && (i = parseFloat(i.toFixed(2))), { valueToUse: i, colorClass: Z(n, e.isUniqueBestPrice, e.isSharedBestPrice) } } }(t, e); t.valueToUse = n.valueToUse, t.colorClass = n.colorClass })), J() }), 300); const B = document.getElementById("usePriceDifference"), T = document.getElementById("unitLabel1"), z = document.getElementById("unitLabel2"), H = document.getElementById("unitLabelStepPrice"); function A(e) { e ? (T.textContent = "PLN", z.textContent = "PLN", H.textContent = "PLN") : (T.textContent = "%", z.textContent = "%", H.textContent = "%") } function j() { ae(), fetch(`/PriceHistory/GetPrices?storeId=${storeId}`).then((e => e.json())).then((e => { a = e.myStoreName, o = e.setPrice1, r = e.setPrice2, s = e.stepPrice, missedProductsCount = e.missedProductsCount, c = e.usePriceDiff, document.getElementById("usePriceDifference").checked = c, A(c), l.useMarginForSimulation = e.useMarginForSimulation, l.enforceMinimalMargin = e.enforceMinimalMargin, l.minimalMarginPercent = e.minimalMarginPercent, l.useEanForSimulation = e.useEanForSimulation, l.usePriceWithDelivery = e.usePriceWithDelivery, e.presetName && ("PriceSafari" === e.presetName ? document.getElementById("presetButton").textContent = "Presety - Widok standardowy PriceSafari" : document.getElementById("presetButton").textContent = "Presety - " + e.presetName), n = e.prices.map((e => { const t = e.isRejected, n = !0 === e.onlyMe; let i, a; n ? (colorClass = "prOnlyMe", i = null, a = null) : t ? (colorClass = "prRejected", i = null, a = null) : (c ? (i = null !== e.savings ? e.savings : e.priceDifference, a = i) : (a = e.percentageDifference, i = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != i && (i = parseFloat(i.toFixed(2))), null != a && (a = parseFloat(a.toFixed(2))), colorClass = Z(i, e.isUniqueBestPrice, e.isSharedBestPrice)); const o = null == e.marginPrice || isNaN(e.marginPrice) ? null : parseFloat(e.marginPrice), r = null == e.myPrice || isNaN(e.myPrice) ? null : parseFloat(e.myPrice); let s = null, d = null, m = "", u = ""; if (!t && null != o && null != r) { let t = r; if (l.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = r - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } s = t - o, d = 0 !== o ? s / o * 100 : null, m = s >= 0 ? "+" : "-", u = s >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus" } return { ...e, isRejected: e.isRejected || !1, onlyMe: n, valueToUse: n ? null : a, colorClass: colorClass, marginPrice: o, myPrice: r, marginAmount: s, marginPercentage: d, marginSign: m, marginClass: u } })); const i = n.map((e => e.storeCount)), d = Math.max(...i), m = Math.max(d, 1); t.noUiSlider.updateOptions({ range: { min: 1, max: m } }), t.noUiSlider.set([1, m]), document.getElementById("totalPriceCount").textContent = e.priceCount, document.getElementById("price1").value = o, document.getElementById("price2").value = r, document.getElementById("stepPrice").value = s, document.getElementById("missedProductsCount").textContent = missedProductsCount, R(n); const u = document.getElementById("productSearch").value; let p = n; u && (p = p.filter((e => { const t = u.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); let n; n = l.useEanForSimulation ? e.ean || "" : e.externalId ? e.externalId.toString() : ""; return ((e.productName || "") + " " + n).toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(t) }))), p = O(p), G(p), _(p), function () { const e = n.some((e => null !== e.marginAmount && null !== e.marginPercentage)), t = document.getElementById("sortMarginAmount"), i = document.getElementById("sortMarginPercentage"); e ? (t.style.display = "", i.style.display = "") : (t.style.display = "none", i.style.display = "none") }(), function () { const e = document.getElementById("producerFilterDropdown"), t = n.reduce(((e, t) => (t.producer && (e[t.producer] = (e[t.producer] || 0) + 1), e)), {}), i = Object.keys(t).sort(((e, t) => e.localeCompare(t))); e.innerHTML = '<option value="">Wszystkie marki</option>', i.forEach((n => { const i = document.createElement("option"); i.value = n, i.textContent = `${n} (${t[n]})`, e.appendChild(i) })), e.addEventListener("change", J) }(), J() })).finally((() => { oe() })), window.loadPrices = j } function R(e) { const t = {}; let n = 0; e.forEach((e => { 0 === e.flagIds.length && n++, e.flagIds.forEach((e => { t[e] || (t[e] = 0), t[e]++ })) })); const i = document.getElementById("flagContainer"); i.innerHTML = "", flags.forEach((e => { const n = t[e.FlagId] || 0, a = m.has(String(e.FlagId)) ? "checked" : "", o = u.has(String(e.FlagId)) ? "checked" : "", r = `\n          <div class="flag-filter-group">\n            \x3c!-- Checkbox "Pokaż" --\x3e\n            <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n              <input class="form-check-input flagFilterInclude"\n                     type="checkbox"\n                     id="flagCheckboxInclude_${e.FlagId}"\n                     value="${e.FlagId}"\n                     ${a}\n                     title="Pokaż wszystkie produkty z tą flagą" />\n            </div>\n\n            \x3c!-- Checkbox "Ukryj" --\x3e\n            <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n              <input class="form-check-input flagFilterExclude"\n                     type="checkbox"\n                     id="flagCheckboxExclude_${e.FlagId}"\n                     value="${e.FlagId}"\n                     ${o}\n                     title="Ukryj wszystkie produkty z tą flagą" />\n            </div>\n\n            \x3c!-- Nazwa flagi i liczba --\x3e\n            <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n              ${e.FlagName} (${n})\n            </span>\n          </div>\n        `; i.innerHTML += r })); const a = `\n      <div class="flag-filter-group">\n        <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n          <input class="form-check-input flagFilterInclude"\n                 type="checkbox"\n                 id="flagCheckboxInclude_noFlag"\n                 value="noFlag"\n                 ${m.has("noFlag") ? "checked" : ""}\n                 title="Pokaż wszystkie produkty z tą flagą (brak flagi)" />\n        </div>\n\n        <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n          <input class="form-check-input flagFilterExclude"\n                 type="checkbox"\n                 id="flagCheckboxExclude_noFlag"\n                 value="noFlag"\n                 ${u.has("noFlag") ? "checked" : ""}\n                 title="Ukryj wszystkie produkty z tą flagą (brak flagi)" />\n        </div>\n\n        <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n          Brak flagi (${n})\n        </span>\n      </div>\n    `; i.innerHTML += a, document.querySelectorAll(".flagFilterInclude").forEach((e => { e.addEventListener("change", (function () { const e = this.value; if (this.checked) { const t = document.getElementById(`flagCheckboxExclude_${e}`); t && t.checked && (t.checked = !1, u.delete(e)), m.add(e) } else m.delete(e); J() })) })), document.querySelectorAll(".flagFilterExclude").forEach((e => { e.addEventListener("change", (function () { const e = this.value; if (this.checked) { const t = document.getElementById(`flagCheckboxInclude_${e}`); t && t.checked && (t.checked = !1, m.delete(e)), u.add(e) } else u.delete(e); J() })) })) } function O(n) { const i = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), a = document.getElementById("bidFilter").checked, o = document.getElementById("suspiciouslyLowFilter").checked, r = Array.from(document.querySelectorAll(".deliveryFilterMyStore:checked")).map((e => parseInt(e.value))), s = Array.from(document.querySelectorAll(".deliveryFilterCompetitor:checked")).map((e => parseInt(e.value))), c = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)), l = e.noUiSlider.get(), d = parseInt(l[0]), p = parseInt(l[1]), g = t.noUiSlider.get(), y = parseInt(g[0]), f = parseInt(g[1]); let h = n; return h = h.filter((e => { const t = e.myPosition; if (null == t) return !0; const n = parseInt(t), i = n >= d && n <= p; return i })), h = h.filter((e => { const t = e.storeCount; return t >= y && t <= f })), o && (h = h.filter((e => null !== e.singleBestCheaperDiffPerc && e.singleBestCheaperDiffPerc > 25)), h.sort(((e, t) => t.singleBestCheaperDiffPerc - e.singleBestCheaperDiffPerc))), i.length && (h = h.filter((e => i.includes(e.colorClass)))), u.size > 0 && (h = h.filter((e => { if (u.has("noFlag") && 0 === e.flagIds.length) return !1; for (const t of u) if ("noFlag" !== t && e.flagIds.includes(parseInt(t))) return !1; return !0 }))), m.size > 0 && (h = h.filter((e => !(!m.has("noFlag") || 0 !== e.flagIds.length) || e.flagIds.some((e => m.has(e.toString())))))), a && (h = h.filter((e => "1" === e.myIsBidding))), r.length && (h = h.filter((e => r.includes(e.myDelivery)))), s.length && (h = h.filter((e => s.includes(e.delivery)))), c.includes("yes") ? h = h.filter((e => null !== e.externalPrice)) : c.includes("no") && (h = h.filter((e => null === e.externalPrice))), h } function Z(e, t = !1, n = !1) { return n ? "prGood" : t ? e <= o ? "prIdeal" : "prToLow" : e < r ? "prMid" : "prToHigh" } function q(e) { const t = localStorage.getItem("selectedPriceChanges_" + storeId); if (t) try { selectedPriceChanges = JSON.parse(t) } catch (e) { console.error("Błąd parsowania danych z localStorage:", e), selectedPriceChanges = [] } else selectedPriceChanges = []; const n = document.getElementById("priceContainer"), i = document.getElementById("productSearch").value.trim(), o = document.getElementById("storeSearch").value.trim(); n.innerHTML = ""; const r = (w - 1) * I, m = w * I; function u(e, t, n) { e.classList.add("active"), e.style.backgroundColor = "#333333", e.style.color = "#f5f5f5", e.textContent = "Dodano |"; const i = document.createElement("span"); i.innerHTML = " <i class='fa fa-trash' style='font-size:14px; display:flex; color:white; margin-left:4px; margin-top:3px;'></i>", i.style.textDecoration = "none", i.style.cursor = "pointer", i.addEventListener("click", (function (n) { n.stopPropagation(), e.classList.remove("active"), e.style.backgroundColor = "", e.style.color = "", e.textContent = "Zmień cenę", t.classList.remove("price-changed"); const i = t ? t.dataset.productId : null, a = new CustomEvent("priceBoxChangeRemove", { detail: { productId: i } }); document.dispatchEvent(a) })), e.appendChild(i), t.classList.add("price-changed") } function p(e, t, n, i, a, o, r) { const s = l.useEanForSimulation, c = s ? r.ean : r.externalId, d = s ? "EAN" : "ID"; if (!c || "" === c.toString().trim()) return e.disabled = !0, void (e.title = `Produkt musi mieć zmapowany ${d}`); e.addEventListener("click", (function (s) { if (s.stopPropagation(), l.useMarginForSimulation) { if (null == r.marginPrice) return void x('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Symulacja cenowa z marżą jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = o; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const t = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = o - t } let n = t; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); n = t - e } let i = (e - r.marginPrice) / r.marginPrice * 100, a = (n - r.marginPrice) / r.marginPrice * 100; if (i = parseFloat(i.toFixed(2)), a = parseFloat(a.toFixed(2)), l.useMarginForSimulation) { if (null == r.marginPrice) return void x('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Symulacja cenowa z marżą jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = o; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const t = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = o - t } let n = t; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); n = t - e } let i = (e - r.marginPrice) / r.marginPrice * 100, a = (n - r.marginPrice) / r.marginPrice * 100; i = parseFloat(i.toFixed(2)), a = parseFloat(a.toFixed(2)); let s = t.toFixed(2) + " PLN"; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost), n = t - e; s = `${t.toFixed(2)} PLN (z dostawą) | ${n.toFixed(2)} PLN (bez dostawy)` } if (l.minimalMarginPercent > 0 && a < l.minimalMarginPercent && !(a > i && i < l.minimalMarginPercent)) { let e = ""; return e = i >= l.minimalMarginPercent ? `Zmiana obniża marżę z <strong>${i}%</strong> (która spełniała minimum) do <strong>${a}%</strong>, czyli poniżej wymaganego progu <strong>${l.minimalMarginPercent}%</strong>.` : a <= i ? `Nowa marża (<strong>${a}%</strong>) jest poniżej wymaganego minimum (<strong>${l.minimalMarginPercent}%</strong>) i nie stanowi poprawy (lub jest pogorszeniem) poprzedniej, już niskiej marży (<strong>${i}%</strong>).` : `Nowa marża (<strong>${a}%</strong>) jest poniżej wymaganego minimum (<strong>${l.minimalMarginPercent}%</strong>), a warunki poprawy nie zostały spełnione (poprzednia marża: <strong>${i}%</strong>).`, void x(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                 <p>${e}</p>\n                                 <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>.</p>\n                                   <p>Sugerowana cena: <strong>${s}</strong>.</p>`) } if (l.enforceMinimalMargin) { if (a < 0 && !(i < 0 && a > i)) return void x(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                 <p>Nowa cena <strong>${s}</strong> spowoduje ujemną marżę (nowa marża: <strong>${a}%</strong>).</p>\n                                 <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>. Zmiana nie może zostać zastosowana.</p>`); if (l.minimalMarginPercent < 0 && a > l.minimalMarginPercent) return void x(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                             <p>Nowa cena <strong>${s}</strong> ustawi marżę (<strong>${a}%</strong>), która jest powyżej dopuszczalnego progu straty (<strong>${l.minimalMarginPercent}%</strong>).</p>\n                             <p>Nowa marża wynosi <strong>${a}%</strong>.</p>`) } } if (l.enforceMinimalMargin) { if (a < 0 && !(i < 0 && a > i)) return void x(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                 <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> spowoduje ujemną marżę (nowa marża: <strong>${a}%</strong>).</p>\n                                 <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>. Zmiana nie może zostać zastosowana.</p>`); if (l.minimalMarginPercent < 0 && a > l.minimalMarginPercent) return void x(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                             <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> ustawi marżę (<strong>${a}%</strong>), która jest powyżej dopuszczalnego progu straty (<strong>${l.minimalMarginPercent}%</strong>).</p>\n                             <p>Nowa marża wynosi <strong>${a}%</strong>.</p>`) } } if (n.classList.contains("price-changed") || e.classList.contains("active")) return void console.log("Zmiana ceny już aktywna dla produktu", i); const c = new CustomEvent("priceBoxChange", { detail: { productId: i, productName: a, currentPrice: o, newPrice: t, storeId: storeId } }); document.dispatchEvent(c), u(e, n); let d = '<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Zmiana ceny dodana</p>'; d += `<p style="margin:4px 0;"><strong>Produkt:</strong> ${a}</p>`; let m = "Nowa cena", p = t; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { m = "Nowa cena (z dostawą)"; const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); p = t - e } if (d += `<p style="margin:4px 0;"><strong>${m}:</strong> ${t.toFixed(2)} PLN</p>`, l.usePriceWithDelivery && r.myPriceIncludesDelivery && (d += `<p style="margin:4px 0;"><strong>Nowa cena (bez dostawy):</strong> ${p.toFixed(2)} PLN</p>`), l.useMarginForSimulation) { let e = t; if (l.usePriceWithDelivery && r.myPriceIncludesDelivery) { const n = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = t - n } let n = (e - r.marginPrice) / r.marginPrice * 100; n = parseFloat(n.toFixed(2)), d += `<p style="margin:4px 0;"><strong>Nowa marża:</strong> ${n}%</p>`, d += `<p style="margin:4px 0;"><strong>Cena zakupu:</strong> ${r.marginPrice.toFixed(2)} PLN</p>`, l.enforceMinimalMargin && (l.minimalMarginPercent > 0 ? d += `<p style="margin:4px 0;"><strong>Minimalna wymagana marża:</strong> ${l.minimalMarginPercent}%</p>` : l.minimalMarginPercent < 0 && (d += `<p style="margin:4px 0;"><strong>Maksymalne obniżenie marży:</strong> ${l.minimalMarginPercent}%</p>`)) } E(d) })); selectedPriceChanges.find((e => parseInt(e.productId) === parseInt(i) && parseFloat(e.newPrice) === parseFloat(t))) && u(e, n) } e.slice(r, m).forEach((e => { const t = e.isRejected, r = K(e.productName, i), m = K(e.storeName, o), u = "1" === e.isBidding, g = U(e.delivery); let y = null, f = null, h = null, P = null, v = null, L = null, C = null, E = "", w = "", I = null, N = null, M = null, F = null; t || (y = null != e.percentageDifference ? e.percentageDifference.toFixed(2) : "N/A", f = null != e.priceDifference ? e.priceDifference.toFixed(2) : "N/A", h = null != e.savings ? e.savings.toFixed(2) : "N/A", P = "1" === e.myIsBidding, v = U(e.myDelivery), L = e.marginAmount, C = e.marginPercentage, E = e.marginSign, w = e.marginClass, I = e.marginPrice, N = null != e.myPrice ? parseFloat(e.myPrice) : null, M = e.myPosition, F = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null); const S = document.createElement("div"); S.className = "price-box " + e.colorClass, S.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId, S.dataset.productId = e.productId, S.dataset.productName = e.productName, S.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })); const b = document.createElement("div"); b.className = "price-box-space"; const k = document.createElement("div"); k.className = "price-box-column-name", k.innerHTML = r; const D = document.createElement("div"); D.className = "price-box-column-category"; const B = l.useEanForSimulation, T = document.createElement("span"); if (T.className = "ApiBox", B) if (e.ean && "" !== e.ean.trim()) { const t = K(e.ean, i, "highlighted-text-yellow"); T.innerHTML = "EAN " + t } else T.innerHTML = "Brak EAN"; else if (e.externalId) { const t = K(e.externalId.toString(), i, "highlighted-text-yellow"); T.innerHTML = "ID " + t } else T.innerHTML = "Brak ID"; D.appendChild(T); const z = ie(e), H = document.createElement("button"); H.className = "assign-flag-button", H.dataset.productId = e.productId, H.innerHTML = "+ Przypisz flagi", H.style.pointerEvents = "auto", H.addEventListener("click", (function (e) { e.stopPropagation(), d = this.dataset.productId, ne.style.display = "block", fetch(`/ProductFlags/GetFlagsForProduct?productId=${d}`).then((e => e.json())).then((e => { document.querySelectorAll(".flagCheckbox").forEach((t => { t.checked = e.includes(parseInt(t.value)) })) })).catch((e => console.error("Błąd pobierania flag dla produktu:", e))) })), b.appendChild(k), b.appendChild(z), b.appendChild(H), b.appendChild(D); const A = document.createElement("div"); A.className = "price-box-externalInfo"; const $ = document.createElement("div"); if ($.className = "price-box-column-offers", $.innerHTML = (e.sourceGoogle || e.sourceCeneo ? '<span class="data-channel">' + (e.sourceGoogle ? '<img src="/images/GoogleShopping.png" alt="Google Icon" style="width:15px; height:15px;" />' : "") + (e.sourceCeneo ? '<img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:15px; height:15px;" />' : "") + "</span>" : "") + '<div class="offer-count-box">' + e.storeCount + " Ofert</div>", A.appendChild($), null != I) { const e = I.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = document.createElement("div"); if (t.className = "price-box-diff-margin " + w, t.innerHTML = "<p>Cena zakupu: " + e + "</p>", A.appendChild(t), null != N) { const e = E + Math.abs(L).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = "(" + E + Math.abs(C).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", n = document.createElement("div"); n.className = "price-box-diff-margin " + w, n.innerHTML = "<p>Marża: " + e + " " + t + "</p>", A.appendChild(n) } } b.appendChild(A); const j = document.createElement("div"); j.className = "price-box-data"; const R = document.createElement("div"); R.className = "color-bar " + e.colorClass; const O = document.createElement("div"); O.className = "price-box-column"; const Z = document.createElement("div"); Z.className = "price-box-column-text"; const q = document.createElement("div"); q.style.display = "flex", q.style.alignItems = "center"; const G = document.createElement("span"); if (G.style.fontWeight = "500", G.style.fontSize = "17px", G.textContent = e.lowestPrice.toFixed(2) + " PLN", q.appendChild(G), void 0 !== e.externalBestPriceCount && null !== e.externalBestPriceCount) if (1 === e.externalBestPriceCount) { const e = document.createElement("div"); e.className = "uniqueBestPriceBox", e.textContent = "★ TOP", e.style.marginLeft = "4px", q.appendChild(e) } else if (e.externalBestPriceCount > 1) { const t = document.createElement("div"); t.className = "shareBestPriceBox", t.textContent = e.externalBestPriceCount + " TOP", t.style.marginLeft = "4px", q.appendChild(t) } if (null !== e.singleBestCheaperDiffPerc && void 0 !== e.singleBestCheaperDiffPerc) { const t = document.createElement("div"); t.style.marginLeft = "4px", t.className = e.singleBestCheaperDiffPerc > 25 ? "singlePriceDiffBoxHigh" : "singlePriceDiffBox"; const n = document.createElement("span"); n.textContent = e.singleBestCheaperDiffPerc.toFixed(2) + "%", t.appendChild(n), q.appendChild(t) } if (Z.appendChild(q), l.usePriceWithDelivery) { const t = W(e.lowestPrice, e.bestPriceDeliveryCost, e.bestPriceIncludesDelivery); t && Z.insertBefore(t, Z.children[1]) } const _ = document.createElement("div"); _.innerHTML = m, Z.appendChild(_); const J = document.createElement("div"); J.className = "price-box-column-text", J.innerHTML = (null != e.isGoogle ? '<span class="data-channel"><img src="' + (e.isGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== e.position ? e.isGoogle ? '<span class="Position-Google">Poz. Google ' + e.position + "</span>" : '<span class="Position">Poz. Ceneo ' + e.position + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (u ? '<span class="Bidding">Bid</span>' : "") + (null != e.delivery ? '<span class="' + g + '">Wysyłka w ' + (1 == e.delivery ? "1 dzień" : e.delivery + " dni") + "</span>" : ""), O.appendChild(Z), O.appendChild(J); const V = document.createElement("div"); if (V.className = "price-box-column", t || null == N) { const e = document.createElement("div"); e.className = "price-box-column-text", e.innerHTML = '<span style="font-weight: 500;">Brak ceny</span><br>' + a, V.appendChild(e) } else { const t = document.createElement("div"); if (t.className = "price-box-column-text", null !== e.externalPrice) { const n = (e.externalPrice - N).toFixed(2), i = e.externalPrice < N, o = document.createElement("div"); o.style.display = "flex", o.style.justifyContent = "space-between", o.style.alignItems = "center"; const r = document.createElement("span"); r.style.fontWeight = "500", r.style.marginRight = "20px", r.textContent = a; const s = document.createElement("span"); s.style.fontWeight = "500"; const c = '<span class="' + (i ? "arrow-down" : "arrow-up") + '"></span>'; s.innerHTML = c + (i ? "-" : "+") + Math.abs(n) + " PLN ", o.appendChild(r), o.appendChild(s); const d = document.createElement("div"); d.style.display = "flex", d.style.justifyContent = "space-between", d.style.alignItems = "center"; const m = document.createElement("span"); m.style.fontWeight = "500", m.style.textDecoration = "line-through", m.style.marginRight = "10px", m.textContent = N.toFixed(2) + " PLN"; const u = document.createElement("span"); if (u.style.fontWeight = "500", u.textContent = e.externalPrice.toFixed(2) + " PLN", d.appendChild(m), d.appendChild(u), t.appendChild(d), t.appendChild(o), l.usePriceWithDelivery) { const n = W(N, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); n && t.insertBefore(n, t.children[1]) } } else { const n = document.createElement("div"); n.style.display = "flex", n.style.alignItems = "center"; const i = document.createElement("span"); i.style.fontWeight = "500", i.style.fontSize = "17px", i.textContent = N.toFixed(2) + " PLN", n.appendChild(i); const o = document.createElement("div"); if (o.textContent = a, t.appendChild(n), l.usePriceWithDelivery) { const n = W(N, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); n && t.insertBefore(n, t.children[1]) } t.appendChild(o) } const n = document.createElement("div"); n.className = "price-box-column-text", n.innerHTML = (null != e.myIsGoogle ? '<span class="data-channel"><img src="' + (e.myIsGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== M ? e.myIsGoogle ? '<span class="Position-Google">Poz. Google ' + M + "</span>" : '<span class="Position">Poz. Ceneo ' + M + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (P ? '<span class="Bidding">Bid</span>' : "") + (null != e.myDelivery ? '<span class="' + v + '">Wysyłka w ' + (1 == e.myDelivery ? "1 dzień" : e.myDelivery + " dni") + "</span>" : ""), V.appendChild(t), V.appendChild(n) } const Q = document.createElement("div"); Q.className = "price-box-column-action", Q.innerHTML = ""; const X = l.useEanForSimulation ? e.ean : e.externalId, Y = l.useEanForSimulation ? "kod EAN" : "ID"; if (t) Q.innerHTML += '<div class="rejected-product">Produkt odrzucony</div>'; else if ("prOnlyMe" === e.colorClass) { const t = e.colorClass + " priceBox-diff-top"; Q.innerHTML += '<div class="' + t + '">Brak ofert konkurencji</div>' } else if ("prToLow" === e.colorClass || "prIdeal" === e.colorClass) if (null != N && null != h) { const t = parseFloat(h.replace(",", ".")), n = "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise", i = N + t, a = t / N * 100; let o, r, l, d = n; if (c) t < 1 ? (o = i - s, r = o - N, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) : (o = i - s, r = t - s, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")); else { const e = s / 100; t < 1 ? (o = i * (1 - e), r = o - N, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) : (o = i * (1 - e), r = t - N * e, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) } const m = (t >= 0 ? "+" : "") + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(" + (a >= 0 ? "+" : "") + a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", y = (r >= 0 ? "+" : "") + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", f = "(" + (l >= 0 ? "+" : "") + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", P = o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", v = document.createElement("div"); v.className = "price-box-column"; const L = document.createElement("div"); L.className = "price-action-line"; const C = document.createElement("span"); C.className = n; const E = document.createElement("span"); E.innerHTML = m + " " + u; const w = document.createElement("div"); w.innerHTML = "= " + g; const I = document.createElement("span"); I.className = "color-square-green", L.appendChild(C), L.appendChild(E), L.appendChild(w), L.appendChild(I); const M = document.createElement("button"); M.className = "simulate-change-btn", M.textContent = "Zmień cenę", M.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(M, i, S, e.productId, e.productName, N, e) : M.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), L.appendChild(M), v.appendChild(L); const F = document.createElement("div"); F.className = "price-box-column"; const b = document.createElement("div"); b.className = "price-action-line"; const k = document.createElement("span"); k.className = d; const D = document.createElement("span"); D.innerHTML = y + " " + f; const B = document.createElement("div"); B.innerHTML = "= " + P; const T = document.createElement("span"); T.className = "color-square-turquoise", b.appendChild(k), b.appendChild(D), b.appendChild(B), b.appendChild(T); const z = document.createElement("button"); z.className = "simulate-change-btn", z.textContent = "Zmień cenę", z.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(z, o, S, e.productId, e.productName, N, e) : z.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), b.appendChild(z), F.appendChild(b), Q.appendChild(v), Q.appendChild(F) } else { const t = e.colorClass + " priceBox-diff"; Q.innerHTML += '<div class="' + t + '">Podnieś: N/A</div>' } else if ("prMid" === e.colorClass) if (null != N && null != F) { const t = N - F, n = t / N * 100; let i; i = c ? F - s : F * (1 - s / 100); const a = N - i, o = a / N * 100, r = t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", l = "(-" + n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", d = F.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(-" + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", y = document.createElement("div"); y.className = "price-box-column"; const f = document.createElement("div"); f.className = "price-action-line"; const h = document.createElement("span"); h.className = "arrow-down-yellow"; const P = document.createElement("span"); P.innerHTML = "-" + r + " " + l; const v = document.createElement("div"); v.innerHTML = "= " + d; const L = document.createElement("span"); L.className = "color-square-green", f.appendChild(h), f.appendChild(P), f.appendChild(v), f.appendChild(L); const C = document.createElement("button"); C.className = "simulate-change-btn", C.textContent = "Zmień cenę", C.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(C, F, S, e.productId, e.productName, N, e) : C.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), f.appendChild(C), y.appendChild(f); const E = document.createElement("div"); E.className = "price-box-column"; const w = document.createElement("div"); w.className = "price-action-line"; const I = document.createElement("span"); I.className = "arrow-down-yellow"; const M = document.createElement("span"); M.innerHTML = "-" + m + " " + u; const b = document.createElement("div"); b.innerHTML = "= " + g; const k = document.createElement("span"); k.className = "color-square-turquoise", w.appendChild(I), w.appendChild(M), w.appendChild(b), w.appendChild(k); const D = document.createElement("button"); D.className = "simulate-change-btn", D.textContent = "Zmień cenę", D.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(D, i, S, e.productId, e.productName, N, e) : D.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), w.appendChild(D), E.appendChild(w), Q.appendChild(y), Q.appendChild(E) } else { const t = e.colorClass + " priceBox-diff"; Q.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prToHigh" === e.colorClass) if (null != N && null != F) { const t = N - F, n = t / N * 100; let i; i = c ? F - s : F * (1 - s / 100); const a = N - i, o = a / N * 100, r = t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", l = "(-" + n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", d = F.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(-" + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", y = document.createElement("div"); y.className = "price-box-column"; const f = document.createElement("div"); f.className = "price-action-line"; const h = document.createElement("span"); h.className = "arrow-down-red"; const P = document.createElement("span"); P.innerHTML = "-" + r + " " + l; const v = document.createElement("div"); v.innerHTML = "= " + d; const L = document.createElement("span"); L.className = "color-square-green", f.appendChild(h), f.appendChild(P), f.appendChild(v), f.appendChild(L); const C = document.createElement("button"); C.className = "simulate-change-btn", C.textContent = "Zmień cenę", C.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(C, F, S, e.productId, e.productName, N, e) : C.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), f.appendChild(C), y.appendChild(f); const E = document.createElement("div"); E.className = "price-box-column"; const w = document.createElement("div"); w.className = "price-action-line"; const I = document.createElement("span"); I.className = "arrow-down-red"; const M = document.createElement("span"); M.innerHTML = "-" + m + " " + u; const b = document.createElement("div"); b.innerHTML = "= " + g; const k = document.createElement("span"); k.className = "color-square-turquoise", w.appendChild(I), w.appendChild(M), w.appendChild(b), w.appendChild(k); const D = document.createElement("button"); D.className = "simulate-change-btn", D.textContent = "Zmień cenę", D.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(D, i, S, e.productId, e.productName, N, e) : D.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), w.appendChild(D), E.appendChild(w), Q.appendChild(y), Q.appendChild(E) } else { const t = e.colorClass + " priceBox-diff"; Q.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prGood" === e.colorClass) if (null != N) { const t = N, n = "+0,00 PLN", i = "(+0,00%)", a = "= " + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN"; let o, r, l, d, m, u, g, y; if (1 === e.storeCount) o = 0, r = 0, l = N, d = "+0,00 PLN", m = "(+0,00%)", u = "= " + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", g = "no-change-icon-turquoise", y = "color-square-turquoise"; else { if (c) o = -s, l = N + o, r = o / N * 100; else { o = -N * (s / 100), Math.abs(o) < .01 && (o = -.01), l = N + o, r = o / N * 100 } d = (o >= 0 ? "+" : "") + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = "(" + (r >= 0 ? "+" : "") + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", u = "= " + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", g = "arrow-down-green", y = "color-square-turquoise" } const f = document.createElement("div"); f.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line"; const P = document.createElement("span"); P.className = "no-change-icon"; const v = document.createElement("span"); v.innerHTML = n + " " + i; const L = document.createElement("div"); L.innerHTML = a; const C = document.createElement("span"); C.className = "color-square-green", h.appendChild(P), h.appendChild(v), h.appendChild(L), h.appendChild(C); const E = document.createElement("button"); E.className = "simulate-change-btn", E.textContent = "Zmień cenę", E.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(E, t, S, e.productId, e.productName, N, e) : E.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), h.appendChild(E), f.appendChild(h); const w = document.createElement("div"); w.className = "price-box-column"; const I = document.createElement("div"); I.className = "price-action-line"; const M = document.createElement("span"); M.className = g; const F = document.createElement("span"); F.innerHTML = d + " " + m; const b = document.createElement("div"); b.innerHTML = u; const k = document.createElement("span"); k.className = y, I.appendChild(M), I.appendChild(F), I.appendChild(b), I.appendChild(k); const D = document.createElement("button"); D.className = "simulate-change-btn", D.textContent = "Zmień cenę", D.dataset.originalText = "Zmień cenę", X && "" !== X.toString().trim() ? p(D, l, S, e.productId, e.productName, N, e) : D.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), x(`Produkt musi mieć zmapowany ${Y}`) })), I.appendChild(D), w.appendChild(I), Q.appendChild(f), Q.appendChild(w) } else { const t = e.colorClass + " priceBox-diff-top"; Q.innerHTML += '<div class="' + t + '">Jesteś w najlepszych cenach</div>' } else Q.innerHTML += '<div class="rejected-product">Produkt odrzucony</div>'; if (j.appendChild(R), e.imgUrl) { const t = document.createElement("img"); t.dataset.src = e.imgUrl, t.alt = e.productName, t.className = "lazy-load", t.style.width = "114px", t.style.height = "114px", t.style.marginRight = "5px", t.style.marginLeft = "5px", t.style.backgroundColor = "#ffffff", t.style.border = "1px solid #e3e3e3", t.style.borderRadius = "4px", t.style.padding = "10px", t.style.display = "block", j.appendChild(t) } j.appendChild(O), j.appendChild(V), j.appendChild(Q), S.appendChild(b), S.appendChild(D), S.appendChild(A), S.appendChild(j), n.appendChild(S) })), function (e) { const t = Math.ceil(e / I), n = document.getElementById("paginationContainer"); n.innerHTML = ""; const i = document.createElement("button"); i.innerHTML = '<i class="fa fa-chevron-circle-left" aria-hidden="true"></i>', i.disabled = 1 === w, i.addEventListener("click", (() => { w > 1 && (w--, J(!1)) })), n.appendChild(i); for (let e = 1; e <= t; e++) { const t = document.createElement("button"); t.textContent = e, e === w && t.classList.add("active"), t.addEventListener("click", (() => { w = e, J(!1) })), n.appendChild(t) } const a = document.createElement("button"); a.innerHTML = '<i class="fa fa-chevron-circle-right" aria-hidden="true"></i>', a.disabled = w === t, a.addEventListener("click", (() => { w < t && (w++, J(!1)) })), n.appendChild(a) }(e.length); const g = document.querySelectorAll(".lazy-load"), y = new Map, f = new IntersectionObserver(((e, t) => { e.forEach((e => { const n = e.target, i = [...g].indexOf(n); if (e.isIntersecting) { const e = setTimeout((() => { !function (e) { const t = 6, n = Math.max(0, e - t), i = Math.min(g.length - 1, e + t); for (let e = n; e <= i; e++) { const t = g[e]; t.src || (t.src = t.dataset.src, t.onload = () => { t.classList.add("loaded") }) } }(i), t.unobserve(n), y.delete(n) }), 100); y.set(n, e) } else y.has(n) && (clearTimeout(y.get(n)), y.delete(n)) })) }), { root: null, rootMargin: "50px", threshold: .01 }); g.forEach((e => { f.observe(e) })), document.getElementById("displayedProductCount").textContent = e.length } function U(e) { return e <= 1 ? "Availability1Day" : e <= 3 ? "Availability3Days" : e <= 7 ? "Availability7Days" : "Availability14Days" } function W(e, t, n) { if (null == e) return null; const i = parseFloat(e); let a = null != t && !isNaN(parseFloat(t)), o = a ? parseFloat(t) : 0; const r = !0 === n && a ? "#21a73e" : "#f44336"; let s = !0 === n && a ? "Cena zawiera dostawę" : "Cena NIE zawiera dostawy"; const c = document.createElement("div"); c.className = "delivery-info-line"; const l = document.createElement("i"); l.className = "fa fa-truck", l.style.marginRight = "4px", l.style.marginLeft = "1px", l.style.fontSize = "12px", l.title = s, l.style.color = r; const d = document.createElement("span"); if (d.style.fontSize = "12px", d.style.color = "#555", a) { const e = i - o; d.textContent = `${e.toFixed(2)} PLN | ${o.toFixed(2)} PLN` } else d.textContent = `${i.toFixed(2)} PLN | Brak danych o wysyłce`; return c.appendChild(l), c.appendChild(d), c } B.addEventListener("change", (function () { c = this.checked, A(c) })); const G = N((function (e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { e.isRejected || (t[e.colorClass] = (t[e.colorClass] || 0) + 1) })); const n = [t.prOnlyMe, t.prToHigh, t.prMid, t.prGood, t.prIdeal, t.prToLow]; if (i) i.data.datasets[0].data = n, i.update(); else { const e = document.getElementById("colorChart").getContext("2d"); i = new Chart(e, { type: "doughnut", data: { labels: ["Solo", "Zawyżona", "Suboptymalna", "Konkurencyjna", "Strategiczna", "Zaniżona"], datasets: [{ data: n, backgroundColor: ["rgba(180, 180, 180, 0.8)", "rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(13, 110, 253, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(180, 180, 180, 1)", "rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(13, 110, 253, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, cutout: "60%", plugins: { legend: { display: !1 }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } }), 600); function _(e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })), document.querySelector('label[for="prOnlyMeCheckbox"]').textContent = `Solo (${t.prOnlyMe})`, document.querySelector('label[for="prToHighCheckbox"]').textContent = `Zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Zaniżona (${t.prToLow})` } function J(e = !0) { e && (w = 1, window.scrollTo(0, 0)), ae(), setTimeout((() => { let e = [...n]; const t = document.getElementById("productSearch").value.trim(), i = document.getElementById("storeSearch").value.trim(); if (t) { const n = t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => { let t; t = l.useEanForSimulation ? e.ean || "" : e.externalId ? e.externalId.toString() : ""; return ((e.productName || "") + " " + t).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(n) })) } if (i) { const t = i.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => (e.storeName || "").toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(t))) } const a = t ? t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, "") : ""; "" !== a && e.sort(((e, t) => { const n = ((e.productName || "") + " " + (e.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), i = ((t.productName || "") + " " + (t.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), o = X(n, a), r = X(i, a); if (o !== r) return o - r; const s = Y(n, a), c = Y(i, a); return s !== c ? c - s : e.productName.localeCompare(t.productName) })), e = O(e), e = p.showRejected ? e.filter((e => e.isRejected)) : e.filter((e => !e.isRejected)), null !== p.sortName ? "asc" === p.sortName ? e.sort(((e, t) => e.productName.localeCompare(t.productName))) : e.sort(((e, t) => t.productName.localeCompare(e.productName))) : null !== p.sortPrice ? "asc" === p.sortPrice ? e.sort(((e, t) => e.lowestPrice - t.lowestPrice)) : e.sort(((e, t) => t.lowestPrice - e.lowestPrice)) : null !== p.sortRaiseAmount ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === p.sortRaiseAmount ? e.sort(((e, t) => e.savings - t.savings)) : e.sort(((e, t) => t.savings - e.savings))) : null !== p.sortRaisePercentage ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === p.sortRaisePercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== p.sortLowerAmount ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === p.sortLowerAmount ? e.sort(((e, t) => e.priceDifference - t.priceDifference)) : e.sort(((e, t) => t.priceDifference - e.priceDifference))) : null !== p.sortLowerPercentage ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === p.sortLowerPercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== p.sortMarginAmount ? (e = e.filter((e => null !== e.marginAmount)), "asc" === p.sortMarginAmount ? e.sort(((e, t) => e.marginAmount - t.marginAmount)) : e.sort(((e, t) => t.marginAmount - e.marginAmount))) : null !== p.sortMarginPercentage && (e = e.filter((e => null !== e.marginPercentage)), "asc" === p.sortMarginPercentage ? e.sort(((e, t) => e.marginPercentage - t.marginPercentage)) : e.sort(((e, t) => t.marginPercentage - e.marginPercentage))); const o = document.getElementById("producerFilterDropdown").value; o && (e = e.filter((e => e.producer === o))), q(e), G(e), _(e), R(e), oe() }), 0) } function K(e, t, n) { if (!t) return e; const i = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), a = new RegExp(i, "gi"), o = n || "highlighted-text"; return e.replace(a, (e => `<span class="${o}">${e}</span>`)) } function V(e) { for (let t in p) if (t !== e) if ("showRejected" === t) { p[t] = !1; let e = document.getElementById("showRejectedButton"); e && e.classList.remove("active") } else { p[t] = null; let e = document.getElementById(t); e && (e.innerHTML = Q(t), e.classList.remove("active")) } } function Q(e) { switch (e) { case "sortName": return "A-Z"; case "sortPrice": return "Cena"; case "sortRaiseAmount": return "Podnieś PLN"; case "sortRaisePercentage": return "Podnieś %"; case "sortLowerAmount": return "Obniż PLN"; case "sortLowerPercentage": return "Obniż %"; case "sortMarginAmount": return "Marża PLN"; case "sortMarginPercentage": return "Marża %"; case "showRejected": return "Pokaż Odrzucone"; default: return "" } } function X(e, t) { return e.indexOf(t) } function Y(e, t) { let n = 0; for (let i = 0; i < e.length; i++)for (let a = i; a <= e.length; a++) { const o = e.slice(i, a); t.includes(o) && o.length > n && (n = o.length) } return n } document.getElementById("openMarginSettingsBtn").addEventListener("click", (function () { document.getElementById("useEanForSimulationInput").value = l.useEanForSimulation.toString(), document.getElementById("useMarginForSimulationInput").value = l.useMarginForSimulation.toString(), document.getElementById("usePriceWithDeliveryInput").value = l.usePriceWithDelivery.toString(), document.getElementById("enforceMinimalMarginInput").value = l.enforceMinimalMargin.toString(), document.getElementById("minimalMarginPercentInput").value = l.minimalMarginPercent, $("#marginSettingsModal").modal("show") })), document.getElementById("saveMarginSettingsBtn").addEventListener("click", (function () { const e = l.usePriceWithDelivery, t = { StoreId: storeId, useEanForSimulation: "true" === document.getElementById("useEanForSimulationInput").value, UseMarginForSimulation: "true" === document.getElementById("useMarginForSimulationInput").value, UsePriceWithDelivery: "true" === document.getElementById("usePriceWithDeliveryInput").value, EnforceMinimalMargin: "true" === document.getElementById("enforceMinimalMarginInput").value, MinimalMarginPercent: parseFloat(document.getElementById("minimalMarginPercentInput").value) }; fetch("/PriceHistory/SaveMarginSettings", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((n => { n.success ? e !== t.UsePriceWithDelivery ? (localStorage.removeItem("selectedPriceChanges_" + storeId), "undefined" != typeof selectedPriceChanges && (selectedPriceChanges = [], console.log("Zmiany symulacji cenowej usunięte z Local Storage i pamięci, ponieważ zmieniono ustawienie 'Uwzględniaj koszt wysyłki'. Przeładowuję stronę.")), E('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p><p>Zmiana opcji "Uwzględniaj koszt wysyłki" spowodowała usunięcie wprowadzonych zmian symulacji cenowej. Przeładowuję stronę...</p>'), setTimeout((function () { window.location.reload() }), 2e3)) : (E('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p>'), l = t, $("#marginSettingsModal").modal("hide"), j()) : alert("Błąd zapisu ustawień: " + n.message) })).catch((e => { console.error("Błąd zapisu ustawień marży:", e), x('<p style="margin-bottom:8px; font-weight:bold;">Błąd zapisu ustawień</p><p>Wystąpił błąd podczas zapisywania ustawień marży.</p>') })) })), document.getElementById("showRejectedButton").addEventListener("click", (function () { p.showRejected = !p.showRejected, p.showRejected ? this.classList.add("active") : this.classList.remove("active"), V("showRejected"), J() })); const ee = N((function () { J() }), 300); document.getElementById("productSearch").addEventListener("input", ee), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .deliveryFilterMyStore, .deliveryFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { ae(), J() })) })), document.getElementById("bidFilter").addEventListener("change", (function () { J() })), document.getElementById("suspiciouslyLowFilter").addEventListener("change", (function () { J() })), document.getElementById("sortName").addEventListener("click", (function () { null === p.sortName ? (p.sortName = "asc", this.innerHTML = "A-Z ↑", this.classList.add("active")) : "asc" === p.sortName ? (p.sortName = "desc", this.innerHTML = "A-Z ↓", this.classList.add("active")) : (p.sortName = null, this.innerHTML = "A-Z", this.classList.remove("active")), V("sortName"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortPrice").addEventListener("click", (function () { null === p.sortPrice ? (p.sortPrice = "asc", this.innerHTML = "Cena ↑", this.classList.add("active")) : "asc" === p.sortPrice ? (p.sortPrice = "desc", this.innerHTML = "Cena ↓", this.classList.add("active")) : (p.sortPrice = null, this.innerHTML = "Cena", this.classList.remove("active")), V("sortPrice"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortRaiseAmount").addEventListener("click", (function () { null === p.sortRaiseAmount ? (p.sortRaiseAmount = "asc", this.innerHTML = "Podnieś PLN ↑", this.classList.add("active")) : "asc" === p.sortRaiseAmount ? (p.sortRaiseAmount = "desc", this.innerHTML = "Podnieś PLN ↓", this.classList.add("active")) : (p.sortRaiseAmount = null, this.innerHTML = "Podnieś PLN", this.classList.remove("active")), V("sortRaiseAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortRaisePercentage").addEventListener("click", (function () { null === p.sortRaisePercentage ? (p.sortRaisePercentage = "asc", this.innerHTML = "Podnieś % ↑", this.classList.add("active")) : "asc" === p.sortRaisePercentage ? (p.sortRaisePercentage = "desc", this.innerHTML = "Podnieś % ↓", this.classList.add("active")) : (p.sortRaisePercentage = null, this.innerHTML = "Podnieś %", this.classList.remove("active")), V("sortRaisePercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortLowerAmount").addEventListener("click", (function () { null === p.sortLowerAmount ? (p.sortLowerAmount = "asc", this.innerHTML = "Obniż PLN ↑", this.classList.add("active")) : "asc" === p.sortLowerAmount ? (p.sortLowerAmount = "desc", this.innerHTML = "Obniż PLN ↓", this.classList.add("active")) : (p.sortLowerAmount = null, this.innerHTML = "Obniż PLN", this.classList.remove("active")), V("sortLowerAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortLowerPercentage").addEventListener("click", (function () { null === p.sortLowerPercentage ? (p.sortLowerPercentage = "asc", this.innerHTML = "Obniż % ↑", this.classList.add("active")) : "asc" === p.sortLowerPercentage ? (p.sortLowerPercentage = "desc", this.innerHTML = "Obniż % ↓", this.classList.add("active")) : (p.sortLowerPercentage = null, this.innerHTML = "Obniż %", this.classList.remove("active")), V("sortLowerPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortMarginAmount").addEventListener("click", (function () { null === p.sortMarginAmount ? (p.sortMarginAmount = "asc", this.innerHTML = "Marża PLN ↑", this.classList.add("active")) : "asc" === p.sortMarginAmount ? (p.sortMarginAmount = "desc", this.innerHTML = "Marża PLN ↓", this.classList.add("active")) : (p.sortMarginAmount = null, this.innerHTML = "Marża PLN", this.classList.remove("active")), V("sortMarginAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("sortMarginPercentage").addEventListener("click", (function () { null === p.sortMarginPercentage ? (p.sortMarginPercentage = "asc", this.innerHTML = "Marża % ↑", this.classList.add("active")) : "asc" === p.sortMarginPercentage ? (p.sortMarginPercentage = "desc", this.innerHTML = "Marża % ↓", this.classList.add("active")) : (p.sortMarginPercentage = null, this.innerHTML = "Marża %", this.classList.remove("active")), V("sortMarginPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(p)), J() })), document.getElementById("usePriceDifference").addEventListener("change", (function () { c = this.checked, A(c) })), document.getElementById("storeSearch").addEventListener("input", ee), document.getElementById("price1").addEventListener("input", (function () { o = parseFloat(this.value) })), document.getElementById("price2").addEventListener("input", (function () { r = parseFloat(this.value) })), document.getElementById("stepPrice").addEventListener("input", (function () { s = parseFloat(this.value) })), document.getElementById("productSearch").addEventListener("input", (function () { w = 1, window.scrollTo(0, 0), ee() })); const te = document.getElementById("exportToExcelButton"); te && te.addEventListener("click", (function () { const e = new ExcelJS.Workbook, t = e.addWorksheet("Dane"); t.addRow(["ID", "Nazwa Produktu", "EAN", "Ilość ofert", "Najniższa Konkurencyjna Cena", "Twoja Cena"]); const i = { color: { argb: "FFAA0000" } }, a = { color: { argb: "FF006400" } }, o = { color: { argb: "FF7E7E7E" } }; n.forEach((e => { const n = [e.externalId || "", e.productName || "", e.ean || "", e.storeCount || "", e.lowestPrice || "", e.myPrice || ""], r = t.addRow(n), s = r.getCell(5), c = r.getCell(6), l = parseFloat(e.lowestPrice) || 0, d = parseFloat(e.myPrice) || 0; l > 0 && d > 0 ? d < l ? (s.font = i, c.font = a) : d > l ? (s.font = a, c.font = i) : (s.font = a, c.font = a) : (s.font = o, c.font = o) })), e.xlsx.writeBuffer().then((e => { const t = new Blob([e], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), n = `PriceSafari-${scrapDateJS}-${myStoreNameJS}.xlsx`, i = document.createElement("a"); i.href = URL.createObjectURL(t), i.download = n, i.click(), setTimeout((() => { URL.revokeObjectURL(i.href) }), 1e3) })) })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = parseFloat(document.getElementById("stepPrice").value), i = document.getElementById("usePriceDifference").checked, a = { StoreId: storeId, SetPrice1: e, SetPrice2: t, PriceStep: n, UsePriceDiff: i }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }).then((e => e.json())).then((a => { a.success ? (o = e, r = t, s = n, usePriceDifferenceGlobal = i, j()) : alert("Błąd zapisu wartości: " + a.message) })).catch((e => console.error("Błąd zapisu wartości:", e))) })); const ne = document.getElementById("flagModal"); function ie(e) { const t = document.createElement("div"); return t.className = "flags-container", e.flagIds && e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const n = flags.find((function (t) { return t.FlagId === e })); if (n) { const e = document.createElement("span"); e.className = "flag", e.style.color = n.FlagColor, e.style.border = "2px solid " + n.FlagColor, e.style.backgroundColor = function (e, t) { let n = 0, i = 0, a = 0; return 4 == e.length ? (n = parseInt(e[1] + e[1], 16), i = parseInt(e[2] + e[2], 16), a = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), i = parseInt(e[3] + e[4], 16), a = parseInt(e[5] + e[6], 16)), `rgba(${n}, ${i}, ${a}, ${t})` }(n.FlagColor, .3), e.innerHTML = n.FlagName, t.appendChild(e) } })), t } function ae() { document.getElementById("loadingOverlay").style.display = "flex" } function oe() { document.getElementById("loadingOverlay").style.display = "none" } document.getElementsByClassName("close")[0].onclick = function () { ne.style.display = "none" }, window.onclick = function (e) { e.target == ne && (ne.style.display = "none") }, document.getElementById("saveFlagsButton").addEventListener("click", (function () { const e = Array.from(document.querySelectorAll(".flagCheckbox:checked")).map((e => parseInt(e.value))), t = { productId: d, flagIds: e }; fetch("/ProductFlags/AssignFlagsToProduct", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((e => { e.success ? (ne.style.display = "none", fetch(`/ProductFlags/GetFlagsForProduct?productId=${d}`).then((e => e.json())).then((e => { const t = parseInt(d), i = n.find((e => e.productId === t)); i ? i.flagIds = e : console.error("Product not found in allPrices:", d), function (e) { const t = parseInt(e), i = document.querySelector(`.price-box[data-product-id='${e}']`); if (i) { const a = i.querySelector(".flags-container"), o = n.find((e => e.productId === t)); if (o) { const e = ie(o); a ? a.parentNode.replaceChild(e, a) : i.appendChild(e) } else console.error("Product not found in allPrices:", e) } }(d), R(n) })).catch((e => console.error("Error fetching updated flags for product:", e)))) : alert("Error assigning flags: " + e.message) })).catch((e => console.error("Error assigning flags:", e))) })), j() }));