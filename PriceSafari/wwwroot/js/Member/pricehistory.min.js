document.addEventListener("DOMContentLoaded", (function () { const e = `selectedProducts_${storeId}`; function t(t) { localStorage.setItem(e, JSON.stringify(Array.from(t))) } let n = [], a = null, i = [], o = null, r = "", s = 2, c = 2, l = 2, d = document.getElementById("usePriceDifference").checked, u = { identifierForSimulation: "EAN", useMarginForSimulation: !0, usePriceWithDelivery: !0, enforceMinimalMargin: !0, minimalMarginPercent: 0 }, m = new Set, p = new Set, g = function () { const t = localStorage.getItem(e); return t ? new Set(JSON.parse(t)) : new Set }(), f = [], y = !1; const h = document.getElementById("selectAllVisibleBtn"), P = document.getElementById("deselectAllVisibleBtn"); function v() { document.querySelectorAll("#priceContainer .select-product-btn").forEach((e => { const t = e.dataset.productId; g.has(t) ? (e.textContent = "Wybrano", e.classList.add("selected")) : (e.textContent = "Zaznacz", e.classList.remove("selected")) })) } h.addEventListener("click", (function () { 0 !== i.length && (i.forEach((e => { g.add(e.productId.toString()) })), t(g), pe(), v()) })), P.addEventListener("click", (function () { 0 !== i.length && (i.forEach((e => { g.delete(e.productId.toString()) })), t(g), pe(), v()) })); let C, x, L = { sortName: null, sortPrice: null, sortRaiseAmount: null, sortRaisePercentage: null, sortLowerAmount: null, sortLowerPercentage: null, sortMarginAmount: null, sortMarginPercentage: null }; const I = document.getElementById("openMassChangeModalBtn"), E = document.getElementById("massChangeModal"), b = document.querySelector("#massChangeModal .close"); I.addEventListener("click", (function () { $("#massChangeModal").modal("show") })), b.addEventListener("click", (function () { $("#massChangeModal").modal("hide") })), window.addEventListener("click", (function (e) { e.target === E && $("#massChangeModal").modal("hide") })); const w = document.getElementById("massMatchBtn"), N = document.getElementById("massStrategicBtn"); function S() { Object.keys(L).forEach((e => { const t = L[e], n = document.getElementById(e); if (n && null !== t && !1 !== t) switch (n.classList.add("active"), e) { case "sortName": n.innerHTML = "asc" === t ? "A-Z ↑" : "A-Z ↓"; break; case "sortPrice": n.innerHTML = "asc" === t ? "Cena ↑" : "Cena ↓"; break; case "sortRaiseAmount": n.innerHTML = "asc" === t ? "Podnieś PLN ↑" : "Podnieś PLN ↓"; break; case "sortRaisePercentage": n.innerHTML = "asc" === t ? "Podnieś % ↑" : "Podnieś % ↓"; break; case "sortLowerAmount": n.innerHTML = "asc" === t ? "Obniż PLN ↑" : "Obniż PLN ↓"; break; case "sortLowerPercentage": n.innerHTML = "asc" === t ? "Obniż % ↑" : "Obniż % ↓"; break; case "sortMarginAmount": n.innerHTML = "asc" === t ? "Narzut PLN ↑" : "Narzut PLN ↓"; break; case "sortMarginPercentage": n.innerHTML = "asc" === t ? "Narzut % ↑" : "Narzut % ↓" } else n && "showRejected" !== e ? (n.classList.remove("active"), n.innerHTML = function (e) { switch (e) { case "sortName": return "A-Z"; case "sortPrice": return "Cena"; case "sortRaiseAmount": return "Podnieś PLN"; case "sortRaisePercentage": return "Podnieś %"; case "sortLowerAmount": return "Obniż PLN"; case "sortLowerPercentage": return "Obniż %"; case "sortMarginAmount": return "Narzut PLN"; case "sortMarginPercentage": return "Narzut %"; default: return "" } }(e)) : n && "showRejected" === e && n.classList.remove("active") })) } function k(e) { Array.from(document.querySelectorAll("#priceContainer .price-box")).forEach((t => { const n = t.querySelectorAll(".simulate-change-btn"); if (!n || 0 === n.length) return; let a; "match" === e && n[0] ? a = n[0] : "strategic" === e && n[1] && (a = n[1]), a && a.click() })), setTimeout((() => { const e = Array.from(document.querySelectorAll("#priceContainer .price-box")); let t = 0, n = 0; e.forEach((e => { e.classList.contains("price-changed") ? t++ : n++ })), B(`<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Masowa zmiana zakończona!</p>\n                  <p>Dodano: <strong>${t}</strong> SKU</p>\n                  <p>Odrzucono: <strong>${n}</strong> SKU</p>`) }), 500) } let M, F; function z(e) { const t = document.getElementById("globalNotification"), n = document.getElementById("globalUpdate"); t && (n && "block" === n.style.display && (n.style.display = "none", F && (clearTimeout(F), F = null)), M && clearTimeout(M), t.innerHTML = e, t.style.display = "block", M = setTimeout((() => { t.style.display = "none" }), 4e3)) } function B(e) { const t = document.getElementById("globalUpdate"), n = document.getElementById("globalNotification"); t && (n && "block" === n.style.display && (n.style.display = "none", M && (clearTimeout(M), M = null)), F && clearTimeout(F), t.innerHTML = e, t.style.display = "block", F = setTimeout((() => { t.style.display = "none" }), 4e3)) } w.addEventListener("click", (function () { k("match"), $("#massChangeModal").modal("hide") })), N.addEventListener("click", (function () { k("strategic"), $("#massChangeModal").modal("hide") })), "undefined" != typeof storeId ? function () { const e = localStorage.getItem("priceHistorySortingState_" + storeId); if (e) try { const t = JSON.parse(e); L = { ...L, ...t }, S() } catch (e) { console.error("Błąd parsowania stanu sortowania z localStorage:", e), localStorage.removeItem("priceHistorySortingState_" + storeId) } }() : console.warn("storeId nie jest zdefiniowane podczas próby odtworzenia stanu sortowania."); let D = 1; const T = 1e3; function A(e, t) { let n; return function (...a) { const i = this; clearTimeout(n), n = setTimeout((() => e.apply(i, a)), t) } } window.refreshPriceBoxStates = function () { const e = localStorage.getItem("selectedPriceChanges_" + storeId); let t = new Set; if (e) try { JSON.parse(e).forEach((e => t.add(String(e.productId)))) } catch (e) { console.error("Błąd parsowania selectedPriceChanges w refreshPriceBoxStates:", e) } document.querySelectorAll("#priceContainer .price-box").forEach((e => { const n = e.dataset.productId; if (!n) return; const a = t.has(String(n)); if (e.classList.contains("price-changed") && !a) { e.classList.remove("price-changed"); e.querySelectorAll(".simulate-change-btn.active").forEach((e => { for (e.classList.remove("active"), e.style.backgroundColor = "", e.style.color = ""; e.firstChild;)e.removeChild(e.firstChild); e.textContent = e.dataset.originalText || "Zmień cenę" })) } else e.classList.contains("price-changed") })) }, C = document.getElementById("positionRangeSlider"); var H = document.getElementById("positionRange"); function j(e, t, n) { let a = parseFloat(e.value.replace(",", ".")); isNaN(a) || (e.value = a < t ? t.toFixed(2) : a > n ? n.toFixed(2) : a.toFixed(2)) } noUiSlider.create(C, { start: [1, 200], connect: !0, range: { min: 1, max: 200 }, step: 1, format: wNumb({ decimals: 0 }) }); const O = document.getElementById("price1"), q = document.getElementById("price2"), R = document.getElementById("stepPrice"); O.addEventListener("blur", (() => { j(O, .01), parseFloat(R.value.replace(",", ".")) > parseFloat(O.value.replace(",", ".")) && (R.value = O.value), j(R, .01, parseFloat(O.value.replace(",", "."))) })), q.addEventListener("blur", (() => { j(q, .01) })), R.addEventListener("blur", (() => { j(R, .01, parseFloat(O.value.replace(",", "."))) })), C.noUiSlider.on("update", (function (e, t) { const n = e.map((e => 60 === parseInt(e) ? "Schowany" : "Pozycja " + e)); H.textContent = n.join(" - ") })), C.noUiSlider.on("change", (function () { oe() })), x = document.getElementById("offerRangeSlider"); var U = document.getElementById("offerRange"); noUiSlider.create(x, { start: [1, 1], connect: !0, range: { min: 1, max: 1 }, step: 1, format: wNumb({ decimals: 0 }) }), x.noUiSlider.on("update", (function (e, t) { const n = e.map((e => { const t = parseInt(e); let n = " Ofert"; return 1 === t ? n = " Oferta" : t >= 2 && t <= 4 && (n = " Oferty"), t + n })); U.textContent = n.join(" - ") })), x.noUiSlider.on("change", (function () { oe() })); A((function () { const e = document.getElementById("usePriceDifference").checked; n.forEach((t => { const n = function (e, t) { if (e.onlyMe) return { valueToUse: null, colorClass: "prOnlyMe" }; { let n, a; return t ? (n = null !== e.savings ? e.savings : e.priceDifference, a = n) : (a = e.percentageDifference, n = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != n && (n = parseFloat(n.toFixed(2))), null != a && (a = parseFloat(a.toFixed(2))), { valueToUse: a, colorClass: X(n, e.isUniqueBestPrice, e.isSharedBestPrice) } } }(t, e); t.valueToUse = n.valueToUse, t.colorClass = n.colorClass })), oe() }), 300); const W = document.getElementById("usePriceDifference"), Z = document.getElementById("unitLabel1"), G = document.getElementById("unitLabel2"), _ = document.getElementById("unitLabelStepPrice"); function J(e) { e ? (Z.textContent = "PLN", G.textContent = "PLN", _.textContent = "PLN") : (Z.textContent = "%", G.textContent = "%", _.textContent = "%") } function K() { ge(), fetch(`/PriceHistory/GetPrices?storeId=${storeId}`).then((e => e.json())).then((e => { a = e.latestScrapId, function () { const e = "selectedPriceChanges_" + storeId, t = localStorage.getItem(e); if (t) try { const n = JSON.parse(t); n.scrapId && n.scrapId === a || (console.warn(`Wykryto przestarzałe dane symulacji. Zapisany scrapId: ${n.scrapId}, Obecny scrapId: ${a}. Czyszczenie localStorage.`), localStorage.removeItem(e), "function" == typeof updatePriceChangeSummary && updatePriceChangeSummary(!0)) } catch (t) { console.error("Błąd parsowania danych z localStorage. Czyszczenie...", t), localStorage.removeItem(e) } }(), r = e.myStoreName, s = e.setPrice1, c = e.setPrice2, l = e.stepPrice, missedProductsCount = e.missedProductsCount, d = e.usePriceDiff, document.getElementById("usePriceDifference").checked = d, J(d), u.useMarginForSimulation = e.useMarginForSimulation, u.enforceMinimalMargin = e.enforceMinimalMargin, u.minimalMarginPercent = e.minimalMarginPercent, u.identifierForSimulation = e.identifierForSimulation, u.usePriceWithDelivery = e.usePriceWithDelivery, e.presetName && ("PriceSafari" === e.presetName ? document.getElementById("presetButton").textContent = "Presety - Widok standardowy PriceSafari" : document.getElementById("presetButton").textContent = "Presety - " + e.presetName), n = e.prices.map((e => { let t = "", n = null, a = null, i = null, o = "", r = ""; const s = !0 === e.onlyMe, c = null != e.myPrice ? parseFloat(e.myPrice) : null, l = null != e.marginPrice ? parseFloat(e.marginPrice) : null; if (e.isRejected) t = "prNoOffer"; else if (s) { if (t = "prOnlyMe", null != l && null != c) { let t = c; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = c - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } a = t - l, i = 0 !== l ? a / l * 100 : null, r = "priceBox-diff-margin-neutral" } } else { let s; if (d ? (s = null !== e.savings ? e.savings : e.priceDifference, n = s) : (n = e.percentageDifference, s = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != s && (s = parseFloat(s.toFixed(2))), null != n && (n = parseFloat(n.toFixed(2))), t = X(s, e.isUniqueBestPrice, e.isSharedBestPrice), null != l && null != c) { let t = c; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = c - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } a = t - l, i = 0 !== l ? a / l * 100 : null, o = a >= 0 ? "+" : "-", r = a >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus" } } return { ...e, isRejected: e.isRejected || !1, onlyMe: s, valueToUse: n, colorClass: t, marginPrice: l, myPrice: c, marginAmount: a, marginPercentage: i, marginSign: o, marginClass: r } })); const t = n.map((e => e.storeCount)), i = Math.max(...t), o = Math.max(i, 1); x.noUiSlider.updateOptions({ range: { min: 1, max: o } }), x.noUiSlider.set([1, o]); const m = n.map((e => e.myPosition)).filter((e => null !== e && !isNaN(e))), p = m.length > 0 ? Math.max(...m) : 60; C.noUiSlider.updateOptions({ range: { min: 1, max: p } }), C.noUiSlider.set([1, p]), document.getElementById("totalPriceCount").textContent = e.priceCount, document.getElementById("price1").value = s, document.getElementById("price2").value = c, document.getElementById("stepPrice").value = l, document.getElementById("missedProductsCount").textContent = missedProductsCount, V(n); const g = document.getElementById("productSearch").value; let f = n; g && (f = f.filter((e => { const t = g.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); let n = ""; switch (u.identifierForSimulation) { case "ID": n = e.externalId ? e.externalId.toString() : ""; break; case "ProducerCode": n = e.producerCode || ""; break; default: n = e.ean || "" }return ((e.productName || "") + " " + n).toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(t) }))), f = Q(f), ae(f), ie(f), function () { const e = n.some((e => null !== e.marginAmount && null !== e.marginPercentage)), t = document.getElementById("sortMarginAmount"), a = document.getElementById("sortMarginPercentage"); e ? (t.style.display = "", a.style.display = "") : (t.style.display = "none", a.style.display = "none") }(), function () { const e = document.getElementById("producerFilterDropdown"), t = n.reduce(((e, t) => (t.producer && (e[t.producer] = (e[t.producer] || 0) + 1), e)), {}), a = Object.keys(t).sort(((e, t) => e.localeCompare(t))); e.innerHTML = '<option value="">Wszystkie marki</option>', a.forEach((n => { const a = document.createElement("option"); a.value = n, a.textContent = `${n} (${t[n]})`, e.appendChild(a) })), e.addEventListener("change", oe) }(), oe() })).finally((() => { fe() })), window.loadPrices = K } function V(e) { const t = {}; let n = 0; e.forEach((e => { e.flagIds && 0 !== e.flagIds.length ? e.flagIds.forEach((e => { t[e] = (t[e] || 0) + 1 })) : n++ })); const a = document.getElementById("flagContainer"); if (!a) return; a.innerHTML = "", "undefined" != typeof flags && flags && flags.forEach((e => { const n = t[e.flagId] || 0, i = m.has(String(e.flagId)) ? "checked" : "", o = p.has(String(e.flagId)) ? "checked" : "", r = `\n                <div class="flag-filter-group">\n                    <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n                        <input class="form-check-input flagFilterInclude" type="checkbox" id="flagCheckboxInclude_${e.flagId}" value="${e.flagId}" ${i} title="Pokaż wszystkie produkty z tą flagą">\n                    </div>\n                    <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n                        <input class="form-check-input flagFilterExclude" type="checkbox" id="flagCheckboxExclude_${e.flagId}" value="${e.flagId}" ${o} title="Ukryj wszystkie produkty z tą flagą">\n                    </div>\n                    <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n                        ${e.flagName} (${n})\n                    </span>\n                </div>`; a.insertAdjacentHTML("beforeend", r) })); const i = `\n        <div class="flag-filter-group">\n            <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n                <input class="form-check-input flagFilterInclude" type="checkbox" id="flagCheckboxInclude_noFlag" value="noFlag" ${m.has("noFlag") ? "checked" : ""} title="Pokaż wszystkie produkty bez flagi">\n            </div>\n            <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n                <input class="form-check-input flagFilterExclude" type="checkbox" id="flagCheckboxExclude_noFlag" value="noFlag" ${p.has("noFlag") ? "checked" : ""} title="Ukryj wszystkie produkty bez flagi">\n            </div>\n            <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n                Brak flagi (${n})\n            </span>\n        </div>`; a.insertAdjacentHTML("beforeend", i), document.querySelectorAll(".flagFilterInclude, .flagFilterExclude").forEach((e => { const t = e.cloneNode(!0); e.parentNode.replaceChild(t, e), t.addEventListener("change", (function () { const e = this.value; if (this.classList.contains("flagFilterInclude")) if (this.checked) { const t = document.getElementById(`flagCheckboxExclude_${e}`); t && (t.checked = !1, p.delete(e)), m.add(e) } else m.delete(e); else if (this.checked) { const t = document.getElementById(`flagCheckboxInclude_${e}`); t && (t.checked = !1, m.delete(e)), p.add(e) } else p.delete(e); oe() })) })) } function Q(e) { const t = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), n = document.getElementById("bidFilter").checked, a = document.getElementById("suspiciouslyLowFilter").checked, i = Array.from(document.querySelectorAll(".deliveryFilterMyStore:checked")).map((e => parseInt(e.value))), o = Array.from(document.querySelectorAll(".deliveryFilterCompetitor:checked")).map((e => parseInt(e.value))), r = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)), s = C.noUiSlider.get(), c = parseInt(s[0]), l = parseInt(s[1]), d = x.noUiSlider.get(), u = parseInt(d[0]), g = parseInt(d[1]); let f = e; return f = f.filter((e => { const t = e.myPosition; if (null == t) return !0; const n = parseInt(t), a = n >= c && n <= l; return a })), f = f.filter((e => { const t = e.storeCount; return t >= u && t <= g })), a && (f = f.filter((e => null !== e.singleBestCheaperDiffPerc && e.singleBestCheaperDiffPerc > 25)), f.sort(((e, t) => t.singleBestCheaperDiffPerc - e.singleBestCheaperDiffPerc))), t.length && (f = f.filter((e => t.includes(e.colorClass)))), p.size > 0 && (f = f.filter((e => { if (p.has("noFlag") && 0 === e.flagIds.length) return !1; for (const t of p) if ("noFlag" !== t && e.flagIds.includes(parseInt(t))) return !1; return !0 }))), m.size > 0 && (f = f.filter((e => !(!m.has("noFlag") || 0 !== e.flagIds.length) || e.flagIds.some((e => m.has(e.toString())))))), n && (f = f.filter((e => "1" === e.myIsBidding))), i.length && (f = f.filter((e => i.includes(e.myDelivery)))), o.length && (f = f.filter((e => o.includes(e.delivery)))), r.includes("yes") ? f = f.filter((e => null !== e.externalPrice)) : r.includes("no") && (f = f.filter((e => null === e.externalPrice))), f } function X(e, t = !1, n = !1) { return n ? "prGood" : t ? e <= s ? "prIdeal" : "prToLow" : e < c ? "prMid" : "prToHigh" } function Y(e) { const n = localStorage.getItem("selectedPriceChanges_" + storeId); if (n) try { const e = JSON.parse(n); Array.isArray(e) ? f = e : (console.warn("Dane 'selectedPriceChanges' w localStorage nie są tablicą. Używam pustej tablicy."), f = []) } catch (e) { console.error("Błąd parsowania danych z localStorage:", e), f = [] } else f = []; const a = document.getElementById("priceContainer"), i = document.getElementById("productSearch").value.trim(), o = document.getElementById("storeSearch").value.trim(); a.innerHTML = ""; const s = (D - 1) * T, c = D * T; function m(e, t, n) { const a = e.querySelector('span[class^="color-square-"]'), i = a ? a.outerHTML : ""; e.classList.add("active"), e.style.backgroundColor = "#333333", e.style.color = "#f5f5f5", e.innerHTML = i + " Dodano"; const o = document.createElement("span"); o.innerHTML = " <i class='fa fa-trash' style='font-size:12px; display:flex; color:white; margin-left:4px; margin-top:3px;'></i>", o.style.textDecoration = "none", o.style.cursor = "pointer", o.addEventListener("click", (function (n) { n.stopPropagation(), e.classList.remove("active"), e.style.backgroundColor = "", e.style.color = "", e.innerHTML = e.dataset.originalText || "Zmień cenę", t.classList.remove("price-changed"); const a = t ? t.dataset.productId : null, i = new CustomEvent("priceBoxChangeRemove", { detail: { productId: a } }); document.dispatchEvent(i) })), e.appendChild(o), t.classList.add("price-changed") } function p(e, t, n, a, i, o, r) { let s = "", c = ""; switch (u.identifierForSimulation) { case "ID": s = r.externalId, c = "ID"; break; case "ProducerCode": s = r.producerCode, c = "Kod producenta"; break; default: s = r.ean, c = "EAN" }if (!s || "" === s.toString().trim()) return e.disabled = !0, void (e.title = `Produkt musi mieć zmapowany ${c}`); e.addEventListener("click", (function (s) { if (s.stopPropagation(), u.useMarginForSimulation) { if (null == r.marginPrice) return void z('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Symulacja cenowa z narzutem jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = o; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const t = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = o - t } let n = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); n = t - e } let a = (e - r.marginPrice) / r.marginPrice * 100, i = (n - r.marginPrice) / r.marginPrice * 100; if (a = parseFloat(a.toFixed(2)), i = parseFloat(i.toFixed(2)), u.useMarginForSimulation) { if (null == r.marginPrice) return void z('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                     <p>Symulacja cenowa z narzutem jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = o; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const t = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = o - t } let n = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); n = t - e } let a = (e - r.marginPrice) / r.marginPrice * 100, i = (n - r.marginPrice) / r.marginPrice * 100; a = parseFloat(a.toFixed(2)), i = parseFloat(i.toFixed(2)); let s = t.toFixed(2) + " PLN"; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost), n = t - e; s = `${t.toFixed(2)} PLN (z dostawą) | ${n.toFixed(2)} PLN (bez dostawy)` } if (u.minimalMarginPercent > 0 && i < u.minimalMarginPercent && !(i > a && a < u.minimalMarginPercent)) { let e = ""; return e = a >= u.minimalMarginPercent ? `Zmiana obniża narzut z <strong>${a}%</strong> (który spełniał minimum) do <strong>${i}%</strong>, czyli poniżej wymaganego progu <strong>${u.minimalMarginPercent}%</strong>.` : i <= a ? `Nowy narzut (<strong>${i}%</strong>) jest poniżej wymaganego minimum (<strong>${u.minimalMarginPercent}%</strong>) i nie stanowi poprawy (lub jest pogorszeniem) poprzedniego, już niskiego narzutu (<strong>${a}%</strong>).` : `Nowy narzut (<strong>${i}%</strong>) jest poniżej wymaganego minimum (<strong>${u.minimalMarginPercent}%</strong>), a warunki poprawy nie zostały spełnione (poprzedni narzut: <strong>${a}%</strong>).`, void z(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                    <p>${e}</p>\n                                    <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>.</p>\n                                     <p>Sugerowana cena: <strong>${s}</strong>.</p>`) } if (u.enforceMinimalMargin) { if (i < 0 && !(a < 0 && i > a)) return void z(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                    <p>Nowa cena <strong>${s}</strong> spowoduje ujemny narzut (nowy narzut: <strong>${i}%</strong>).</p>\n                                    <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>. Zmiana nie może zostać zastosowana.</p>`); if (u.minimalMarginPercent < 0 && i > u.minimalMarginPercent) return void z(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                  <p>Nowa cena <strong>${s}</strong> ustawi narzut (<strong>${i}%</strong>), który jest powyżej dopuszczalnego progu straty (<strong>${u.minimalMarginPercent}%</strong>).</p>\n                                  <p>Nowy narzut wynosi <strong>${i}%</strong>.</p>`) } } if (u.enforceMinimalMargin) { if (i < 0 && !(a < 0 && i > a)) return void z(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                    <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> spowoduje ujemny narzut (nowy narzut: <strong>${i}%</strong>).</p>\n                                    <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>. Zmiana nie może zostać zastosowana.</p>`); if (u.minimalMarginPercent < 0 && i > u.minimalMarginPercent) return void z(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                                  <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> ustawi narzut (<strong>${i}%</strong>), który jest powyżej dopuszczalnego progu straty (<strong>${u.minimalMarginPercent}%</strong>).</p>\n                                  <p>Nowy narzut wynosi <strong>${i}%</strong>.</p>`) } } if (n.classList.contains("price-changed") || e.classList.contains("active")) return void console.log("Zmiana ceny już aktywna dla produktu", a); const c = new CustomEvent("priceBoxChange", { detail: { productId: a, productName: i, currentPrice: o, newPrice: t, storeId: storeId, scrapId: r.scrapId } }); document.dispatchEvent(c), m(e, n); let l = '<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Zmiana ceny dodana</p>'; l += `<p style="margin:4px 0;"><strong>Produkt:</strong> ${i}</p>`; let d = "Nowa cena", p = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { d = "Nowa cena (z dostawą)"; const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); p = t - e } if (l += `<p style="margin:4px 0;"><strong>${d}:</strong> ${t.toFixed(2)} PLN</p>`, u.usePriceWithDelivery && r.myPriceIncludesDelivery && (l += `<p style="margin:4px 0;"><strong>Nowa cena (bez dostawy):</strong> ${p.toFixed(2)} PLN</p>`), u.useMarginForSimulation) { let e = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const n = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = t - n } let n = (e - r.marginPrice) / r.marginPrice * 100; n = parseFloat(n.toFixed(2)), l += `<p style="margin:4px 0;"><strong>Nowy narzut:</strong> ${n}%</p>`, l += `<p style="margin:4px 0;"><strong>Cena zakupu:</strong> ${r.marginPrice.toFixed(2)} PLN</p>`, u.enforceMinimalMargin && (u.minimalMarginPercent > 0 ? l += `<p style="margin:4px 0;"><strong>Minimalny wymagany narzut:</strong> ${u.minimalMarginPercent}%</p>` : u.minimalMarginPercent < 0 && (l += `<p style="margin:4px 0;"><strong>Maksymalne obniżenie narzutu:</strong> ${u.minimalMarginPercent}%</p>`)) } B(l) })); f.find((e => parseInt(e.productId) === parseInt(a) && parseFloat(e.newPrice) === parseFloat(t))) && m(e, n) } e.slice(s, c).forEach((e => { const n = re(e.productName, i), s = re(e.storeName, o), c = ee(e.delivery), m = null != e.myPrice ? parseFloat(e.myPrice) : null, f = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null, y = null != e.savings ? e.savings.toFixed(2) : "N/A", h = e.myPosition, P = ee(e.myDelivery), v = e.marginAmount, C = e.marginPercentage, x = e.marginSign, L = e.marginClass, I = e.marginPrice, E = document.createElement("div"); E.className = "price-box " + e.colorClass, E.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId, E.dataset.productId = e.productId, E.dataset.productName = e.productName, E.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })); const b = document.createElement("div"); b.className = "price-box-space"; const w = document.createElement("div"); w.className = "price-box-column-name", w.innerHTML = n; const N = document.createElement("div"); N.className = "price-box-column-category"; const S = document.createElement("span"); let k, M, F; switch (S.className = "ApiBox", u.identifierForSimulation) { case "ID": k = e.externalId ? e.externalId.toString() : null, M = "ID"; break; case "ProducerCode": k = e.producerCode || null, M = "KOD"; break; default: k = e.ean || null, M = "EAN" }k ? (F = re(k, i, "highlighted-text-yellow"), S.innerHTML = `${M} ${F}`) : S.innerHTML = `Brak ${M}`, N.appendChild(S); const z = function (e) { const t = document.createElement("div"); t.className = "flags-container", e.flagIds && e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const n = flags.find((t => t.flagId === e)); if (n) { const e = document.createElement("span"); e.className = "flag", e.style.color = n.flagColor, e.style.border = "2px solid " + n.flagColor, e.style.backgroundColor = ne(n.flagColor, .3), e.innerHTML = n.flagName, t.appendChild(e) } })); return t }(e); b.appendChild(w), b.appendChild(z); const B = document.createElement("button"); B.className = "select-product-btn", B.dataset.productId = e.productId, B.style.pointerEvents = "auto", g.has(e.productId.toString()) ? (B.textContent = "Wybrano", B.classList.add("selected")) : B.textContent = "Zaznacz", B.addEventListener("click", (function (e) { e.stopPropagation(); const n = this.dataset.productId; g.has(n) ? (g.delete(n), this.textContent = "Zaznacz", this.classList.remove("selected")) : (g.add(n), this.textContent = "Wybrano", this.classList.add("selected")), t(g), pe() })), b.appendChild(B), b.appendChild(N); const D = document.createElement("div"); if (D.className = "price-box-externalInfo", null != I) { const e = I.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = document.createElement("div"); if (t.className = null != m ? "price-box-diff-margin " + L : "priceBox-diff-margin-neutral", t.innerHTML = "<p>Cena zakupu: " + e + "</p>", D.appendChild(t), null != m) { const e = x + Math.abs(v).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = "(" + x + Math.abs(C).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", n = document.createElement("div"); n.className = "price-box-diff-margin " + L, n.innerHTML = "<p>Narzut: " + e + " " + t + "</p>", D.appendChild(n) } else { const e = document.createElement("div"); e.className = "priceBox-diff-margin-neutral", e.innerHTML = "<p>Narzut: Brak informacji</p>", D.appendChild(e) } } b.appendChild(D); const $ = document.createElement("div"); $.className = "price-box-data"; const T = document.createElement("div"); T.className = "color-bar " + e.colorClass; const A = document.createElement("div"); if (A.className = "price-box-column", "prOnlyMe" === e.colorClass) { const e = document.createElement("div"); e.className = "price-box-column-text"; const t = document.createElement("span"); t.style.fontWeight = "500", t.style.fontSize = "17px", t.textContent = "Brak ofert konkurencji", e.appendChild(t); const n = document.createElement("div"); n.textContent = r, e.appendChild(n); const a = document.createElement("div"); a.className = "price-box-column-text"; const i = document.createElement("span"); i.className = "Position", i.style.backgroundColor = "#9C9C9C", i.style.color = "white", i.textContent = "Brak ofert konkurencji - Produkt solo", a.appendChild(i), A.appendChild(e), A.appendChild(a) } else if (null != e.lowestPrice) { const t = document.createElement("div"); t.className = "price-box-column-text"; const n = document.createElement("div"); n.style.display = "flex", n.style.alignItems = "center"; const a = document.createElement("span"); if (a.style.fontWeight = "500", a.style.fontSize = "17px", a.textContent = e.lowestPrice.toFixed(2) + " PLN", n.appendChild(a), void 0 !== e.externalBestPriceCount && null !== e.externalBestPriceCount) if (1 === e.externalBestPriceCount) { const e = document.createElement("div"); e.className = "uniqueBestPriceBox", e.textContent = "★ TOP", e.style.marginLeft = "4px", n.appendChild(e) } else if (e.externalBestPriceCount > 1) { const t = document.createElement("div"); t.className = "shareBestPriceBox", t.textContent = e.externalBestPriceCount + " TOP", t.style.marginLeft = "4px", n.appendChild(t) } if (null !== e.singleBestCheaperDiffPerc && void 0 !== e.singleBestCheaperDiffPerc) { const t = document.createElement("div"); t.style.marginLeft = "4px", t.className = e.singleBestCheaperDiffPerc > 25 ? "singlePriceDiffBoxHigh" : "singlePriceDiffBox"; const a = document.createElement("span"); a.textContent = e.singleBestCheaperDiffPerc.toFixed(2) + "%", t.appendChild(a), n.appendChild(t) } if (t.appendChild(n), u.usePriceWithDelivery) { const n = te(e.lowestPrice, e.bestPriceDeliveryCost, e.bestPriceIncludesDelivery); n && t.insertBefore(n, t.children[1]) } const i = document.createElement("div"); i.innerHTML = s, t.appendChild(i); const o = document.createElement("div"); o.className = "price-box-column-text", o.innerHTML = (null != e.isGoogle ? '<span class="data-channel"><img src="' + (e.isGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== e.position ? e.isGoogle ? '<span class="Position-Google">Poz. Google ' + e.position + "</span>" : '<span class="Position">Poz. Ceneo ' + e.position + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + ("1" === e.isBidding ? '<span class="Bidding">Bid</span>' : "") + (null != e.delivery ? '<span class="' + c + '">Wysyłka w ' + (1 == e.delivery ? "1 dzień" : e.delivery + " dni") + "</span>" : ""), A.appendChild(t), A.appendChild(o) } const H = document.createElement("div"); if (H.className = "price-box-column", "prNoOffer" !== e.colorClass && null != m) { const t = document.createElement("div"); if (t.className = "price-box-column-text", null !== e.externalPrice) { const n = (e.externalPrice - m).toFixed(2), a = e.externalPrice < m, i = document.createElement("div"); i.style.display = "flex", i.style.justifyContent = "space-between", i.style.alignItems = "center"; const o = document.createElement("span"); o.style.fontWeight = "500", o.style.marginRight = "20px", o.textContent = r; const s = document.createElement("span"); s.style.fontWeight = "500"; const c = '<span class="' + (a ? "arrow-down" : "arrow-up") + '"></span>'; s.innerHTML = c + (a ? "-" : "+") + Math.abs(n) + " PLN ", i.appendChild(o), i.appendChild(s); const l = document.createElement("div"); l.style.display = "flex", l.style.justifyContent = "space-between", l.style.alignItems = "center"; const d = document.createElement("span"); d.style.fontWeight = "500", d.style.textDecoration = "line-through", d.style.marginRight = "10px", d.textContent = m.toFixed(2) + " PLN"; const p = document.createElement("span"); if (p.style.fontWeight = "500", p.textContent = e.externalPrice.toFixed(2) + " PLN", l.appendChild(d), l.appendChild(p), t.appendChild(l), t.appendChild(i), u.usePriceWithDelivery) { const n = te(m, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); n && t.insertBefore(n, t.children[1]) } } else { const n = document.createElement("div"); n.style.display = "flex", n.style.alignItems = "center"; const a = document.createElement("span"); a.style.fontWeight = "500", a.style.fontSize = "17px", a.textContent = m.toFixed(2) + " PLN", n.appendChild(a); const i = document.createElement("div"); if (i.textContent = r, t.appendChild(n), u.usePriceWithDelivery) { const n = te(m, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); n && t.insertBefore(n, t.children[1]) } t.appendChild(i) } const n = document.createElement("div"); n.className = "price-box-column-text", n.innerHTML = (null != e.myIsGoogle ? '<span class="data-channel"><img src="' + (e.myIsGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== h ? e.myIsGoogle ? '<span class="Position-Google">Poz. Google ' + h + "</span>" : '<span class="Position">Poz. Ceneo ' + h + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + ("1" === e.myIsBidding ? '<span class="Bidding">Bid</span>' : "") + (null != e.myDelivery ? '<span class="' + P + '">Wysyłka w ' + (1 == e.myDelivery ? "1 dzień" : e.myDelivery + " dni") + "</span>" : ""), H.appendChild(t), H.appendChild(n) } else { const e = document.createElement("div"); e.className = "price-box-column-text"; const t = document.createElement("span"); t.style.fontWeight = "500", t.textContent = "Brak Twojej oferty", t.style.fontSize = "17px", e.appendChild(t); const n = document.createElement("div"); n.textContent = r, e.appendChild(n); const a = document.createElement("div"); a.className = "price-box-column-text"; const i = document.createElement("span"); i.className = "Position", i.style.backgroundColor = "#9C9C9C", i.textContent = "Brak Twojej oferty - Cena niedostępna", a.appendChild(i), H.appendChild(e), H.appendChild(a) } const j = document.createElement("div"); if (j.className = "price-box-column-action", j.innerHTML = "", "prNoOffer" !== e.colorClass) if ("prToLow" === e.colorClass || "prIdeal" === e.colorClass) { if (null != m && null != y) { const t = parseFloat(y.replace(",", ".")), n = "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise", a = m + t, i = t, o = m > 0 ? i / m * 100 : 0; let r, s, c, u = n; r = d ? a - l : a * (1 - l / 100), s = r - m, c = m > 0 ? s / m * 100 : 0, s < 0 && (u = "arrow-down-turquoise"); const g = document.createElement("div"); g.className = "price-box-column"; const f = document.createElement("div"); f.className = "price-action-line", f.innerHTML = `\n                        <span class="${n}"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">${i >= 0 ? "+" : ""}${i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">${o >= 0 ? "+" : ""}${o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const h = document.createElement("button"); h.className = "simulate-change-btn"; const P = '<span class="color-square-green"></span> Zmień cenę'; h.innerHTML = P, h.dataset.originalText = P, p(h, a, E, e.productId, e.productName, m, e), f.appendChild(h), g.appendChild(f); const v = document.createElement("div"); v.className = "price-box-column"; const C = document.createElement("div"); C.className = "price-action-line", C.innerHTML = `\n                        <span class="${u}"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">${s >= 0 ? "+" : ""}${s.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">${c >= 0 ? "+" : ""}${c.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const x = document.createElement("button"); x.className = "simulate-change-btn"; const L = '<span class="color-square-turquoise"></span> Zmień cenę'; x.innerHTML = L, x.dataset.originalText = L, p(x, r, E, e.productId, e.productName, m, e), C.appendChild(x), v.appendChild(C), j.appendChild(g), j.appendChild(v) } } else if ("prMid" === e.colorClass || "prToHigh" === e.colorClass) { if (null != m && null != f) { const t = m - f, n = m > 0 ? t / m * 100 : 0; let a, i, o; a = d ? f - l : f * (1 - l / 100), i = m - a, o = m > 0 ? i / m * 100 : 0; const r = "prMid" === e.colorClass ? "arrow-down-yellow" : "arrow-down-red", s = document.createElement("div"); s.className = "price-box-column"; const c = document.createElement("div"); c.className = "price-action-line", c.innerHTML = `\n                        <span class="${r}"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">-${t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">-${n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${f.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const u = document.createElement("button"); u.className = "simulate-change-btn"; const g = '<span class="color-square-green"></span> Zmień cenę'; u.innerHTML = g, u.dataset.originalText = g, p(u, f, E, e.productId, e.productName, m, e), c.appendChild(u), s.appendChild(c); const y = document.createElement("div"); y.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line", h.innerHTML = `\n                        <span class="${r}"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">-${i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">-${o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const P = document.createElement("button"); P.className = "simulate-change-btn"; const v = '<span class="color-square-turquoise"></span> Zmień cenę'; P.innerHTML = v, P.dataset.originalText = v, p(P, a, E, e.productId, e.productName, m, e), h.appendChild(P), y.appendChild(h), j.appendChild(s), j.appendChild(y) } } else if ("prGood" === e.colorClass && null != m) { const t = 0, n = 0, a = m; let i, o, r, s = "arrow-down-green"; if (e.storeCount > 1) { if (d) r = m - l; else { let e = m * (l / 100); e < .01 && (e = .01), r = m - e } i = r - m, o = m > 0 ? i / m * 100 : 0 } else r = m, i = 0, o = 0, s = "no-change-icon-turquoise"; const c = document.createElement("div"); c.className = "price-box-column"; const u = document.createElement("div"); u.className = "price-action-line", u.innerHTML = `\n                        <span class="no-change-icon"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">+${t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">+${n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const g = document.createElement("button"); g.className = "simulate-change-btn"; const f = '<span class="color-square-green"></span> Zmień cenę'; g.innerHTML = f, g.dataset.originalText = f, p(g, a, E, e.productId, e.productName, m, e), u.appendChild(g), c.appendChild(u); const y = document.createElement("div"); y.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line", h.innerHTML = `\n                        <span class="${s}"></span>\n                        <div class="price-diff-stack">\n                            <span class="diff-amount small-font">${i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></span>\n                            <span class="diff-percentage small-font">${o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">%</span></span>\n                        </div>\n                        <div class="small-font">= ${r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="unit">PLN</span></div>\n                    `; const P = document.createElement("button"); P.className = "simulate-change-btn"; const v = '<span class="color-square-turquoise"></span> Zmień cenę'; P.innerHTML = v, P.dataset.originalText = v, p(P, r, E, e.productId, e.productName, m, e), h.appendChild(P), y.appendChild(h), j.appendChild(c), j.appendChild(y) } if ($.appendChild(T), e.imgUrl) { const t = document.createElement("img"); t.dataset.src = e.imgUrl, t.alt = e.productName, t.className = "lazy-load", t.style.width = "112px", t.style.height = "112px", t.style.marginRight = "3px", t.style.marginLeft = "3px", t.style.backgroundColor = "#ffffff", t.style.border = "1px solid #e3e3e3", t.style.borderRadius = "4px", t.style.padding = "6px", t.style.display = "block", $.appendChild(t) } const O = document.createElement("div"); O.className = "price-box-stats-container"; let q = `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    ${e.sourceGoogle ? '<img src="/images/GoogleShopping.png" alt="Google Icon" style="width:15px; height:15px;" />' : ""}\n                    ${e.sourceCeneo ? '<img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:15px; height:15px;" />' : ""}\n                </span>\n                <div class="offer-count-box">${R = e.storeCount, 1 === R ? `${R} Oferta` : R > 10 && R < 20 ? `${R} Ofert` : [2, 3, 4].includes(R % 10) ? `${R} Oferty` : `${R} Ofert`}</div>\n            </div>`; var R; const U = "Ilość zakupionych produktów przez ostatnie 90 dni na Ceneo"; let W = ""; W = e.ceneoSalesCount > 0 ? `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    <i class="fas fa-shopping-cart" style="font-size: 15px; color: grey; margin-top:1px;" title="${U}"></i>\n                </span>\n                <div class="offer-count-box">\n                    <p>${e.ceneoSalesCount} osb. kupiło</p>\n                </div>\n            </div>` : `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    <i class="fas fa-shopping-cart" style="font-size: 15px; color: grey; margin-top:1px;" title="${U}"></i>\n                </span>\n                <div class="offer-count-box">\n                    <p>Brak danych</p>\n                </div>\n            </div>`; let Z = function (e) { const t = e.salesTrendStatus; if ("NoData" === t || null === t) return '\n        <div class="price-box-column-offers-a">\n            <span class="data-channel">\n                <i class="fas fa-chart-line" style="font-size: 15px; color: grey; margin-top:1px;" title="Trend sprzedaży"></i>\n            </span>\n            <div class="offer-count-box">\n                <p>Brak danych</p>\n            </div>\n        </div>'; const n = `Flag-${t}.svg`; let a = ""; if (0 !== e.salesDifference && null !== e.salesDifference) { const t = e.salesDifference > 0 ? "+" : "", n = null !== e.salesPercentageChange ? ` (${t}${e.salesPercentageChange.toFixed(2)}%)` : ""; a = `<p>${t}${e.salesDifference}${n}</p>` } else a = "<p>Bez zmian</p>"; return `\n    <div class="price-box-column-offers-a">\n        <span class="data-channel" title="Trend sprzedaży">\n             <img src="/images/${n}" alt="${t}" style="width:18px; height:18px;" />\n        </span>\n        <div class="offer-count-box">\n            ${a}\n        </div>\n    </div>` }(e); O.innerHTML = q + W + Z, $.appendChild(O), $.appendChild(A), $.appendChild(H), $.appendChild(j), E.appendChild(b), E.appendChild(N), E.appendChild(D), E.appendChild($), a.appendChild(E) })), function (e) { const t = Math.ceil(e / T), n = document.getElementById("paginationContainer"); n.innerHTML = ""; const a = document.createElement("button"); a.innerHTML = '<i class="fa fa-chevron-circle-left" aria-hidden="true"></i>', a.disabled = 1 === D, a.addEventListener("click", (() => { D > 1 && (D--, oe(!1)) })), n.appendChild(a); for (let e = 1; e <= t; e++) { const t = document.createElement("button"); t.textContent = e, e === D && t.classList.add("active"), t.addEventListener("click", (() => { D = e, oe(!1) })), n.appendChild(t) } const i = document.createElement("button"); i.innerHTML = '<i class="fa fa-chevron-circle-right" aria-hidden="true"></i>', i.disabled = D === t, i.addEventListener("click", (() => { D < t && (D++, oe(!1)) })), n.appendChild(i) }(e.length); const y = document.querySelectorAll(".lazy-load"), h = new Map, P = new IntersectionObserver(((e, t) => { e.forEach((e => { const n = e.target, a = [...y].indexOf(n); if (e.isIntersecting) { const e = setTimeout((() => { !function (e) { const t = 6, n = Math.max(0, e - t), a = Math.min(y.length - 1, e + t); for (let e = n; e <= a; e++) { const t = y[e]; t.src || (t.src = t.dataset.src, t.onload = () => { t.classList.add("loaded") }) } }(a), t.unobserve(n), h.delete(n) }), 100); h.set(n, e) } else h.has(n) && (clearTimeout(h.get(n)), h.delete(n)) })) }), { root: null, rootMargin: "50px", threshold: .01 }); y.forEach((e => { P.observe(e) })), document.getElementById("displayedProductCount").textContent = e.length } function ee(e) { return e <= 1 ? "Availability1Day" : e <= 3 ? "Availability3Days" : e <= 7 ? "Availability7Days" : "Availability14Days" } function te(e, t, n) { if (null == e) return null; const a = parseFloat(e); let i = null != t && !isNaN(parseFloat(t)), o = i ? parseFloat(t) : 0; const r = !0 === n && i ? "#21a73e" : "#f44336"; let s = !0 === n && i ? "Cena zawiera dostawę" : "Cena NIE zawiera dostawy"; const c = document.createElement("div"); c.className = "delivery-info-line"; const l = document.createElement("i"); l.className = "fa fa-truck", l.style.marginRight = "4px", l.style.marginLeft = "1px", l.style.fontSize = "12px", l.title = s, l.style.color = r; const d = document.createElement("span"); if (d.style.fontSize = "12px", d.style.color = "#555", i) { const e = a - o; d.textContent = `${e.toFixed(2)} PLN | ${o.toFixed(2)} PLN` } else d.textContent = `${a.toFixed(2)} PLN | Brak danych o wysyłce`; return c.appendChild(l), c.appendChild(d), c } function ne(e, t) { let n = 0, a = 0, i = 0; return 4 == e.length ? (n = parseInt(e[1] + e[1], 16), a = parseInt(e[2] + e[2], 16), i = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), a = parseInt(e[3] + e[4], 16), i = parseInt(e[5] + e[6], 16)), `rgba(${n}, ${a}, ${i}, ${t})` } W.addEventListener("change", (function () { d = this.checked, J(d) })); const ae = A((function (e) { const t = { prNoOffer: 0, prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })); const n = [t.prNoOffer, t.prOnlyMe, t.prToHigh, t.prMid, t.prGood, t.prIdeal, t.prToLow]; if (o) o.data.datasets[0].data = n, o.update(); else { const e = document.getElementById("colorChart").getContext("2d"); o = new Chart(e, { type: "doughnut", data: { labels: ["Cena niedostępna", "Cena solo", "Cena zawyżona", "Cena suboptymalna", "Cena konkurencyjna", "Cena strategiczna", "Cena zaniżona"], datasets: [{ data: n, backgroundColor: ["rgba(230, 230, 230, 1)", "rgba(180, 180, 180, 0.8)", "rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(13, 110, 253, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(230, 230, 230, 1)", "rgba(180, 180, 180, 1)", "rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(13, 110, 253, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, cutout: "65%", layout: { padding: 4 }, plugins: { legend: { display: !1 }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } }), 600); function ie(e) { const t = { prNoOffer: 0, prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })), document.querySelector('label[for="prNoOfferCheckbox"]').textContent = `Cena niedostępna (${t.prNoOffer})`, document.querySelector('label[for="prOnlyMeCheckbox"]').textContent = `Cena solo (${t.prOnlyMe})`, document.querySelector('label[for="prToHighCheckbox"]').textContent = `Cena zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Cena suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Cena konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Cena strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Cena zaniżona (${t.prToLow})` } function oe(e = !0) { e && (D = 1, window.scrollTo(0, 0)), ge(), setTimeout((() => { let e = [...n]; const t = document.getElementById("productSearch").value.trim(), a = document.getElementById("storeSearch").value.trim(); if (t) { const n = t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => { let t = ""; switch (u.identifierForSimulation) { case "ID": t = e.externalId ? e.externalId.toString() : ""; break; case "ProducerCode": t = e.producerCode || ""; break; default: t = e.ean || "" }return ((e.productName || "") + " " + t).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(n) })) } if (a) { const t = a.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => (e.storeName || "").toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(t))) } const o = t ? t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, "") : ""; "" !== o && e.sort(((e, t) => { const n = ((e.productName || "") + " " + (e.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), a = ((t.productName || "") + " " + (t.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), i = ce(n, o), r = ce(a, o); if (i !== r) return i - r; const s = le(n, o), c = le(a, o); return s !== c ? c - s : e.productName.localeCompare(t.productName) })), e = Q(e), null !== L.sortName ? "asc" === L.sortName ? e.sort(((e, t) => e.productName.localeCompare(t.productName))) : e.sort(((e, t) => t.productName.localeCompare(e.productName))) : null !== L.sortPrice ? "asc" === L.sortPrice ? e.sort(((e, t) => e.lowestPrice - t.lowestPrice)) : e.sort(((e, t) => t.lowestPrice - e.lowestPrice)) : null !== L.sortRaiseAmount ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === L.sortRaiseAmount ? e.sort(((e, t) => e.savings - t.savings)) : e.sort(((e, t) => t.savings - e.savings))) : null !== L.sortRaisePercentage ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === L.sortRaisePercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== L.sortLowerAmount ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === L.sortLowerAmount ? e.sort(((e, t) => e.priceDifference - t.priceDifference)) : e.sort(((e, t) => t.priceDifference - e.priceDifference))) : null !== L.sortLowerPercentage ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === L.sortLowerPercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== L.sortMarginAmount ? (e = e.filter((e => null !== e.marginAmount)), "asc" === L.sortMarginAmount ? e.sort(((e, t) => e.marginAmount - t.marginAmount)) : e.sort(((e, t) => t.marginAmount - e.marginAmount))) : null !== L.sortMarginPercentage && (e = e.filter((e => null !== e.marginPercentage)), "asc" === L.sortMarginPercentage ? e.sort(((e, t) => e.marginPercentage - t.marginPercentage)) : e.sort(((e, t) => t.marginPercentage - e.marginPercentage))); const r = document.getElementById("producerFilterDropdown").value; r && (e = e.filter((e => e.producer === r))), i = [...e], Y(e), ae(e), ie(e), V(e), fe() }), 0) } function re(e, t, n) { if (!t) return e; const a = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), i = new RegExp(a, "gi"), o = n || "highlighted-text"; return e.replace(i, (e => `<span class="${o}">${e}</span>`)) } function se(e) { Object.keys(L).forEach((t => { t !== e && (L[t] = null) })), S() } function ce(e, t) { return e.indexOf(t) } function le(e, t) { let n = 0; for (let a = 0; a < e.length; a++)for (let i = a; i <= e.length; i++) { const o = e.slice(a, i); t.includes(o) && o.length > n && (n = o.length) } return n } document.getElementById("openMarginSettingsBtn").addEventListener("click", (function () { document.getElementById("identifierForSimulationInput").value = u.identifierForSimulation, document.getElementById("useMarginForSimulationInput").value = u.useMarginForSimulation.toString(), document.getElementById("usePriceWithDeliveryInput").value = u.usePriceWithDelivery.toString(), document.getElementById("enforceMinimalMarginInput").value = u.enforceMinimalMargin.toString(), document.getElementById("minimalMarginPercentInput").value = u.minimalMarginPercent, $("#marginSettingsModal").modal("show") })), document.getElementById("saveMarginSettingsBtn").addEventListener("click", (function () { const e = u.usePriceWithDelivery, t = { StoreId: storeId, IdentifierForSimulation: document.getElementById("identifierForSimulationInput").value, UseMarginForSimulation: "true" === document.getElementById("useMarginForSimulationInput").value, UsePriceWithDelivery: "true" === document.getElementById("usePriceWithDeliveryInput").value, EnforceMinimalMargin: "true" === document.getElementById("enforceMinimalMarginInput").value, MinimalMarginPercent: parseFloat(document.getElementById("minimalMarginPercentInput").value) }; fetch("/PriceHistory/SaveMarginSettings", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((n => { n.success ? e !== t.UsePriceWithDelivery ? (localStorage.removeItem("selectedPriceChanges_" + storeId), void 0 !== f && (f = [], console.log("Zmiany symulacji cenowej usunięte z Local Storage i pamięci, ponieważ zmieniono ustawienie 'Uwzględniaj koszt wysyłki'. Przeładowuję stronę.")), B('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p><p>Zmiana opcji "Uwzględniaj koszt wysyłki" spowodowała usunięcie wprowadzonych zmian symulacji cenowej. Przeładowuję stronę...</p>'), setTimeout((function () { window.location.reload() }), 2e3)) : (B('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p>'), u = t, $("#marginSettingsModal").modal("hide"), K()) : alert("Błąd zapisu ustawień: " + n.message) })).catch((e => { console.error("Błąd zapisu ustawień narzutu:", e), z('<p style="margin-bottom:8px; font-weight:bold;">Błąd zapisu ustawień</p><p>Wystąpił błąd podczas zapisywania ustawień narzutu.</p>') })) })); const de = A((function () { oe() }), 300); document.getElementById("productSearch").addEventListener("input", de), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .deliveryFilterMyStore, .deliveryFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { ge(), oe() })) })), document.getElementById("bidFilter").addEventListener("change", (function () { oe() })), document.getElementById("suspiciouslyLowFilter").addEventListener("change", (function () { oe() })), document.getElementById("sortName").addEventListener("click", (function () { null === L.sortName ? (L.sortName = "asc", this.innerHTML = "A-Z ↑", this.classList.add("active")) : "asc" === L.sortName ? (L.sortName = "desc", this.innerHTML = "A-Z ↓", this.classList.add("active")) : (L.sortName = null, this.innerHTML = "A-Z", this.classList.remove("active")), se("sortName"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortPrice").addEventListener("click", (function () { null === L.sortPrice ? (L.sortPrice = "asc", this.innerHTML = "Cena ↑", this.classList.add("active")) : "asc" === L.sortPrice ? (L.sortPrice = "desc", this.innerHTML = "Cena ↓", this.classList.add("active")) : (L.sortPrice = null, this.innerHTML = "Cena", this.classList.remove("active")), se("sortPrice"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortRaiseAmount").addEventListener("click", (function () { null === L.sortRaiseAmount ? (L.sortRaiseAmount = "asc", this.innerHTML = "Podnieś PLN ↑", this.classList.add("active")) : "asc" === L.sortRaiseAmount ? (L.sortRaiseAmount = "desc", this.innerHTML = "Podnieś PLN ↓", this.classList.add("active")) : (L.sortRaiseAmount = null, this.innerHTML = "Podnieś PLN", this.classList.remove("active")), se("sortRaiseAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortRaisePercentage").addEventListener("click", (function () { null === L.sortRaisePercentage ? (L.sortRaisePercentage = "asc", this.innerHTML = "Podnieś % ↑", this.classList.add("active")) : "asc" === L.sortRaisePercentage ? (L.sortRaisePercentage = "desc", this.innerHTML = "Podnieś % ↓", this.classList.add("active")) : (L.sortRaisePercentage = null, this.innerHTML = "Podnieś %", this.classList.remove("active")), se("sortRaisePercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortLowerAmount").addEventListener("click", (function () { null === L.sortLowerAmount ? (L.sortLowerAmount = "asc", this.innerHTML = "Obniż PLN ↑", this.classList.add("active")) : "asc" === L.sortLowerAmount ? (L.sortLowerAmount = "desc", this.innerHTML = "Obniż PLN ↓", this.classList.add("active")) : (L.sortLowerAmount = null, this.innerHTML = "Obniż PLN", this.classList.remove("active")), se("sortLowerAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortLowerPercentage").addEventListener("click", (function () { null === L.sortLowerPercentage ? (L.sortLowerPercentage = "asc", this.innerHTML = "Obniż % ↑", this.classList.add("active")) : "asc" === L.sortLowerPercentage ? (L.sortLowerPercentage = "desc", this.innerHTML = "Obniż % ↓", this.classList.add("active")) : (L.sortLowerPercentage = null, this.innerHTML = "Obniż %", this.classList.remove("active")), se("sortLowerPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortMarginAmount").addEventListener("click", (function () { null === L.sortMarginAmount ? (L.sortMarginAmount = "asc", this.innerHTML = "Narzut PLN ↑", this.classList.add("active")) : "asc" === L.sortMarginAmount ? (L.sortMarginAmount = "desc", this.innerHTML = "Narzut PLN ↓", this.classList.add("active")) : (L.sortMarginAmount = null, this.innerHTML = "Narzut PLN", this.classList.remove("active")), se("sortMarginAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("sortMarginPercentage").addEventListener("click", (function () { null === L.sortMarginPercentage ? (L.sortMarginPercentage = "asc", this.innerHTML = "Narzut % ↑", this.classList.add("active")) : "asc" === L.sortMarginPercentage ? (L.sortMarginPercentage = "desc", this.innerHTML = "Narzut % ↓", this.classList.add("active")) : (L.sortMarginPercentage = null, this.innerHTML = "Narzut %", this.classList.remove("active")), se("sortMarginPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(L)), oe() })), document.getElementById("usePriceDifference").addEventListener("change", (function () { d = this.checked, J(d) })), document.getElementById("storeSearch").addEventListener("input", de), document.getElementById("price1").addEventListener("input", (function () { s = parseFloat(this.value) })), document.getElementById("price2").addEventListener("input", (function () { c = parseFloat(this.value) })), document.getElementById("stepPrice").addEventListener("input", (function () { l = parseFloat(this.value) })), document.getElementById("productSearch").addEventListener("input", (function () { D = 1, window.scrollTo(0, 0), de() })); const ue = document.getElementById("exportToExcelButton"); ue && ue.addEventListener("click", (function () { !function (e) { if (!e || 0 === e.length) return void alert("Brak danych do wyeksportowania po zastosowaniu filtrów."); const t = new ExcelJS.Workbook, n = t.addWorksheet("Dane"); n.addRow(["ID", "Nazwa Produktu", "EAN", "Ilość ofert", "Najniższa Konkurencyjna Cena", "Twoja Cena"]); const a = { color: { argb: "FFAA0000" } }, i = { color: { argb: "FF006400" } }, o = { color: { argb: "FF7E7E7E" } }; e.forEach((e => { const t = [e.externalId || "", e.productName || "", e.ean || "", e.storeCount || "", e.lowestPrice || "", e.myPrice || ""], r = n.addRow(t), s = r.getCell(5), c = r.getCell(6), l = parseFloat(e.lowestPrice) || 0, d = parseFloat(e.myPrice) || 0; l > 0 && d > 0 ? d < l ? (s.font = a, c.font = i) : d > l ? (s.font = i, c.font = a) : (s.font = i, c.font = i) : (s.font = o, c.font = o) })), t.xlsx.writeBuffer().then((e => { const t = new Blob([e], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), n = `PriceSafari-${scrapDateJS}-${myStoreNameJS}.xlsx`, a = document.createElement("a"); a.href = URL.createObjectURL(t), a.download = n, a.click(), setTimeout((() => { URL.revokeObjectURL(a.href) }), 1e3) })) }(i) })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = parseFloat(document.getElementById("stepPrice").value), a = document.getElementById("usePriceDifference").checked, i = { StoreId: storeId, SetPrice1: e, SetPrice2: t, PriceStep: n, UsePriceDiff: a }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(i) }).then((e => e.json())).then((i => { i.success ? (s = e, c = t, l = n, usePriceDifferenceGlobal = a, K()) : alert("Błąd zapisu wartości: " + i.message) })).catch((e => console.error("Błąd zapisu wartości:", e))) })); const me = document.getElementById("flagModal"); function pe() { const e = document.getElementById("selectionContainer"), t = document.getElementById("selectedProductsCounter"), a = document.getElementById("selectedProductsModalCounter"), i = document.getElementById("selectedProductsList"), o = g.size; if (e.style.display = "flex", t.textContent = `Wybrano: ${o}`, a && (a.textContent = o), i.innerHTML = "", 0 === o) return void (i.innerHTML = '<div class="alert alert-info text-center">Nie zaznaczono żadnych produktów.</div>'); const r = document.createElement("table"); r.className = "table-orders", r.innerHTML = '\n        <thead class="thead-light">\n            <tr>\n                <th style="width: 65%;">Nazwa Produktu</th>\n                <th>EAN/ID</th>\n                <th class="text-center">Akcja</th>\n            </tr>\n        </thead>'; const s = document.createElement("tbody"); g.forEach((e => { const t = n.find((t => t.productId.toString() === e)); if (t) { const n = document.createElement("tr"); let a = t.ean || t.externalId || "Brak ID"; n.innerHTML = `\n                <td class="align-middle">${t.productName}</td>\n                <td class="align-middle">${a}</td>\n                <td class="text-center align-middle">\n                    <button class="btn btn-danger btn-sm remove-selection-btn" data-product-id="${e}" title="Usuń z zaznaczonych">\n                        <i class="fa-solid fa-trash-can"></i>\n                    </button>\n                </td>\n            `, s.appendChild(n) } })), r.appendChild(s), i.appendChild(r) } function ge() { document.getElementById("loadingOverlay").style.display = "flex" } function fe() { document.getElementById("loadingOverlay").style.display = "none" } document.getElementsByClassName("close")[0].onclick = function () { me.style.display = "none" }, window.onclick = function (e) { e.target == me && (me.style.display = "none") }, document.getElementById("openBulkFlagModalBtn").addEventListener("click", (function () { if (0 === g.size) return void alert("Nie zaznaczono żadnych produktów."); y = !0, $("#selectedProductsModal").modal("hide"), ge(); const e = Array.from(g); fetch("/ProductFlags/GetFlagCountsForProducts", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: e }) }).then((e => e.json())).then((e => { !function (e) { const t = document.getElementById("flagModalBody"), n = document.querySelector("#flagModal .price-box-column-name"), a = g.size; n.textContent = `Zarządzaj flagami dla ${a} produktów`, t.innerHTML = "", flags.forEach((n => { const i = e[n.flagId] || 0, o = document.createElement("div"); o.className = "bulk-flag-item", o.dataset.flagId = n.flagId; const r = document.createElement("div"); r.className = "flag-label", r.innerHTML = `\n                <span class="flag-name" style="border-color: ${n.flagColor}; color: ${n.flagColor}; background-color: ${ne(n.flagColor, .3)};">${n.flagName}</span>\n                <span class="flag-count">(${i} / ${a})</span>\n            `; const s = document.createElement("div"); s.className = "flag-actions", s.innerHTML = `\n            <div class="action-group">\n                <label>\n                    <input type="checkbox" class="bulk-flag-action" data-action="add" ${i === a ? "disabled" : ""}> Dodaj\n                </label>\n                <span class="change-indicator add-indicator">${i} → ${a}</span>\n            </div>\n            <div class="action-group">\n                <label>\n                    <input type="checkbox" class="bulk-flag-action" data-action="remove" ${0 === i ? "disabled" : ""}> Odepnij\n                </label>\n                <span class="change-indicator remove-indicator">${i} → 0</span>\n            </div>\n        `, o.appendChild(r), o.appendChild(s), t.appendChild(o) })), t.querySelectorAll(".bulk-flag-action").forEach((e => { e.addEventListener("change", (function () { const e = this.closest(".bulk-flag-item"), t = this.dataset.action; this.checked && ("add" === t ? e.querySelector('.bulk-flag-action[data-action="remove"]').checked = !1 : e.querySelector('.bulk-flag-action[data-action="add"]').checked = !1), e.querySelector(".add-indicator").style.display = e.querySelector('.bulk-flag-action[data-action="add"]').checked ? "inline" : "none", e.querySelector(".remove-indicator").style.display = e.querySelector('.bulk-flag-action[data-action="remove"]').checked ? "inline" : "none" })) })) }(e), fe(), $("#flagModal").modal("show") })).catch((e => { console.error("Błąd pobierania liczników flag:", e), fe(), alert("Nie udało się pobrać danych o flagach.") })) })), document.getElementById("saveFlagsButton").addEventListener("click", (function () { const t = [], n = []; if (document.querySelectorAll("#flagModalBody .bulk-flag-item").forEach((e => { const a = parseInt(e.dataset.flagId, 10), i = e.querySelector('.bulk-flag-action[data-action="add"]'), o = e.querySelector('.bulk-flag-action[data-action="remove"]'); i && i.checked && t.push(a), o && o.checked && n.push(a) })), 0 === t.length && 0 === n.length) return void alert("Nie wybrano żadnych akcji do wykonania."); const a = { productIds: Array.from(g).map((e => parseInt(e))), flagsToAdd: t, flagsToRemove: n }; ge(), fetch("/ProductFlags/UpdateFlagsForMultipleProducts", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }).then((e => e.json())).then((t => { t.success ? ($("#flagModal").modal("hide"), B(`<p>Pomyślnie zaktualizowano flagi dla ${a.productIds.length} produktów.</p>`), g.clear(), localStorage.removeItem(e), pe(), K()) : alert("Błąd: " + t.message) })).catch((e => console.error("Błąd masowej aktualizacji flag:", e))).finally((() => fe())) })), document.getElementById("selectedProductsList").addEventListener("click", (function (e) { const n = e.target.closest(".remove-selection-btn"); if (n) { const e = n.dataset.productId; g.delete(e), t(g); const a = document.querySelector(`.select-product-btn[data-product-id='${e}']`); a && (a.textContent = "Zaznacz", a.classList.remove("selected")), pe() } })), document.getElementById("showSelectedProductsBtn").addEventListener("click", (function () { pe(), $("#selectedProductsModal").modal("show") })), K(), pe() }));