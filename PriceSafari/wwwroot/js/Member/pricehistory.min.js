document.addEventListener("DOMContentLoaded", (function () { const e = `selectedProducts_${storeId}`; function t(t) { localStorage.setItem(e, JSON.stringify(Array.from(t))) } let n = [], a = null, o = [], i = null, r = "", s = 2, c = 2, l = 2, d = document.getElementById("usePriceDifference").checked, u = { identifierForSimulation: "EAN", useMarginForSimulation: !0, usePriceWithDelivery: !0, enforceMinimalMargin: !0, minimalMarginPercent: 0 }; function p(e, t = !0) { if (null == e || isNaN(parseFloat(e))) return "N/A"; const n = parseFloat(e).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); return t ? n + " PLN" : n } function m(e) { return !0 === e ? '<span class="stock-available">Dostępny</span>' : !1 === e ? '<span class="stock-unavailable">Niedostępny</span>' : '<span class="BD">Brak danych</span>' } let g = new Set, f = new Set, y = function () { const t = localStorage.getItem(e); return t ? new Set(JSON.parse(t)) : new Set }(), h = [], P = !1; const v = document.getElementById("selectAllVisibleBtn"), C = document.getElementById("deselectAllVisibleBtn"); function x() { document.querySelectorAll("#priceContainer .select-product-btn").forEach((e => { const t = e.dataset.productId; y.has(t) ? (e.textContent = "Wybrano", e.classList.add("selected")) : (e.textContent = "Zaznacz", e.classList.remove("selected")) })) } v.addEventListener("click", (function () { 0 !== o.length && (o.forEach((e => { y.add(e.productId.toString()) })), t(y), Ce(), x()) })), C.addEventListener("click", (function () { 0 !== o.length && (o.forEach((e => { y.delete(e.productId.toString()) })), t(y), Ce(), x()) })); let I, b, w = { sortName: null, sortPrice: null, sortRaiseAmount: null, sortRaisePercentage: null, sortLowerAmount: null, sortLowerPercentage: null, sortMarginAmount: null, sortMarginPercentage: null }; const L = document.getElementById("openMassChangeModalBtn"), k = document.getElementById("massChangeModal"), E = document.querySelector("#massChangeModal .close"); L.addEventListener("click", (function () { $("#massChangeModal").modal("show") })), E.addEventListener("click", (function () { $("#massChangeModal").modal("hide") })), window.addEventListener("click", (function (e) { e.target === k && $("#massChangeModal").modal("hide") })); function S() { Object.keys(w).forEach((e => { const t = w[e], n = document.getElementById(e); if (n && null !== t && !1 !== t) switch (n.classList.add("active"), e) { case "sortName": n.innerHTML = "asc" === t ? "A-Z ↑" : "A-Z ↓"; break; case "sortPrice": n.innerHTML = "asc" === t ? "Cena ↑" : "Cena ↓"; break; case "sortRaiseAmount": n.innerHTML = "asc" === t ? "Podnieś PLN ↑" : "Podnieś PLN ↓"; break; case "sortRaisePercentage": n.innerHTML = "asc" === t ? "Podnieś % ↑" : "Podnieś % ↓"; break; case "sortLowerAmount": n.innerHTML = "asc" === t ? "Obniż PLN ↑" : "Obniż PLN ↓"; break; case "sortLowerPercentage": n.innerHTML = "asc" === t ? "Obniż % ↑" : "Obniż % ↓"; break; case "sortMarginAmount": n.innerHTML = "asc" === t ? "Narzut PLN ↑" : "Narzut PLN ↓"; break; case "sortMarginPercentage": n.innerHTML = "asc" === t ? "Narzut % ↑" : "Narzut % ↓" } else n && "showRejected" !== e ? (n.classList.remove("active"), n.innerHTML = function (e) { switch (e) { case "sortName": return "A-Z"; case "sortPrice": return "Cena"; case "sortRaiseAmount": return "Podnieś PLN"; case "sortRaisePercentage": return "Podnieś %"; case "sortLowerAmount": return "Obniż PLN"; case "sortLowerPercentage": return "Obniż %"; case "sortMarginAmount": return "Narzut PLN"; case "sortMarginPercentage": return "Narzut %"; default: return "" } }(e)) : n && "showRejected" === e && n.classList.remove("active") })) } let z, N; function M(e) { const t = document.getElementById("globalNotification"), n = document.getElementById("globalUpdate"); t && (n && "block" === n.style.display && (n.style.display = "none", N && (clearTimeout(N), N = null)), z && clearTimeout(z), t.innerHTML = e, t.style.display = "block", z = setTimeout((() => { t.style.display = "none" }), 4e3)) } function B(e) { const t = document.getElementById("globalUpdate"), n = document.getElementById("globalNotification"); t && (n && "block" === n.style.display && (n.style.display = "none", z && (clearTimeout(z), z = null)), N && clearTimeout(N), t.innerHTML = e, t.style.display = "block", N = setTimeout((() => { t.style.display = "none" }), 4e3)) } document.getElementById("massStrategicBtn").addEventListener("click", (function () { !function (e) { const t = o; if (!t || 0 === t.length) return void B("<p>Brak produktów do zmiany po filtracji.</p>"); let n = 0, a = 0, i = {}; const r = l, s = document.getElementById("usePriceDifference").checked ? "PLN" : "%"; t.forEach((e => { if (h.some((t => String(t.productId) === String(e.productId)))) return void n++; const t = ie(e); if (!t) return a++, void (i["Brak sugestii"] = (i["Brak sugestii"] || 0) + 1); const o = t.suggestedPrice, c = null != e.myPrice ? parseFloat(e.myPrice) : null; let l = "", d = ""; switch (u.identifierForSimulation) { case "ID": l = e.externalId, d = "ID"; break; case "ProducerCode": l = e.producerCode, d = "Kod producenta"; break; default: l = e.ean, d = "EAN" }if (!l || "" === l.toString().trim()) return a++, void (i[`Brak identyfikatora (${d})`] = (i[`Brak identyfikatora (${d})`] || 0) + 1); if (u.useMarginForSimulation) { if (null == e.marginPrice) return a++, void (i["Brak ceny zakupu"] = (i["Brak ceny zakupu"] || 0) + 1); let t = c; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = c - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } let n = o; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { n = o - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } let r = 0 !== e.marginPrice ? (t - e.marginPrice) / e.marginPrice * 100 : 1 / 0, s = 0 !== e.marginPrice ? (n - e.marginPrice) / e.marginPrice * 100 : 1 / 0; if (r = parseFloat(r.toFixed(2)), s = parseFloat(s.toFixed(2)), u.minimalMarginPercent > 0) { if (s < u.minimalMarginPercent && !(r < u.minimalMarginPercent && s > r)) return a++, void (i["Zbyt niski narzut"] = (i["Zbyt niski narzut"] || 0) + 1) } else if (u.enforceMinimalMargin) { if (s < 0 && !(r < 0 && s > r)) return a++, void (i["Ujemny narzut"] = (i["Ujemny narzut"] || 0) + 1); if (u.minimalMarginPercent < 0 && s < u.minimalMarginPercent) return a++, void (i["Przekroczona strata"] = (i["Przekroczona strata"] || 0) + 1) } } const p = new CustomEvent("priceBoxChange", { detail: { productId: e.productId, productName: e.productName, currentPrice: c, newPrice: o, storeId: storeId, scrapId: e.scrapId, stepPriceApplied: r, stepUnitApplied: s } }); document.dispatchEvent(p), n++ })), D(); let c = `<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Masowa zmiana zakończona!</p>\n                         <p>Przeanalizowano: <strong>${t.length}</strong> SKU</p>\n                         <p>Dodano/Zaktualizowano: <strong>${n}</strong> SKU</p>\n                         <p>Odrzucono: <strong>${a}</strong> SKU</p>`; if (a > 0) { c += '<p style="font-size:12px; margin-top:8px; border-top:1px solid #ccc; padding-top:5px;"><u>Powody odrzucenia:</u><br/>'; for (const [e, t] of Object.entries(i)) c += `&bull; ${e}: ${t}<br/>`; c += "</p>" } B(c) }(), $("#massChangeModal").modal("hide") })), "undefined" != typeof storeId ? function () { const e = localStorage.getItem("priceHistorySortingState_" + storeId); if (e) try { const t = JSON.parse(e); w = { ...w, ...t }, S() } catch (e) { console.error("Błąd parsowania stanu sortowania z localStorage:", e), localStorage.removeItem("priceHistorySortingState_" + storeId) } }() : console.warn("storeId nie jest zdefiniowane podczas próby odtworzenia stanu sortowania."); let T = 1; const F = 1e3; function D() { const e = localStorage.getItem("selectedPriceChanges_" + storeId); let t = new Map; if (e) try { const n = JSON.parse(e); n && n.scrapId && Array.isArray(n.changes) ? (h = n.changes, n.changes.forEach((e => t.set(String(e.productId), e)))) : (h = [], console.warn("Niepoprawny format danych w localStorage, czyszczenie selectedPriceChanges.")) } catch (e) { console.error("Błąd parsowania selectedPriceChanges na początku refreshPriceBoxStates:", e), h = [] } else h = []; document.querySelectorAll("#priceContainer .price-box").forEach((e => { const a = e.dataset.productId; if (!a) return; const o = t.get(String(a)); if (o) { e.classList.contains("price-changed") || e.classList.add("price-changed"); if (!e.querySelector(".simulate-change-btn.active")) { const t = e.querySelector(".simulate-change-btn"); if (t) { const n = t.closest(".price-action-line"); n ? ne(t, n, e, o.stepPriceApplied, o.stepUnitApplied) : console.error("Nie znaleziono actionLine dla przycisku w refreshPriceBoxStates (stan aktywny). ProductId:", a) } else console.error("Nie znaleziono przycisku .simulate-change-btn w refreshPriceBoxStates (stan aktywny). ProductId:", a) } } else if (e.classList.contains("price-changed")) { e.classList.remove("price-changed"); const t = n.find((e => String(e.productId) === String(a))), o = e.querySelector(".price-box-column-action"); if (t && o) { const n = ie(t); if (n) { const i = re(t, n); o.innerHTML = i.html; const r = o.querySelector(i.actionLineSelector); if (r) { const a = null != t.myPrice ? parseFloat(t.myPrice) : null; ae(r, n.suggestedPrice, e, t.productId, t.productName, a, t) } else console.error("Nie znaleziono .price-action-line po re-renderowaniu sugestii (w refreshPriceBoxStates - reset) dla ID:", a) } else o.innerHTML = "", console.warn("Nie udało się obliczyć nowej sugestii (w refreshPriceBoxStates - reset) dla ID:", a) } else { console.warn("Nie znaleziono itemu lub priceBoxColumnInfo (w refreshPriceBoxStates - reset) dla ID:", a, ". Resetuję tylko przyciski."); e.querySelectorAll(".simulate-change-btn.active").forEach((e => { e.classList.remove("active"); const t = e.dataset.originalText || '<span class="color-square-turquoise"></span> Dodaj zmianę ceny'; e.innerHTML = t })) } } })) } function A(e, t) { let n; return function (...a) { const o = this; clearTimeout(n), n = setTimeout((() => e.apply(o, a)), t) } } window.refreshPriceBoxStates = D, I = document.getElementById("positionRangeSlider"); var H = document.getElementById("positionRange"); function j(e, t, n) { let a = parseFloat(e.value.replace(",", ".")); isNaN(a) ? e.value = void 0 !== t ? t.toFixed(2) : "0.00" : e.value = void 0 !== t && a < t ? t.toFixed(2) : void 0 !== n && a > n ? n.toFixed(2) : a.toFixed(2) } noUiSlider.create(I, { start: [1, 200], connect: !0, range: { min: 1, max: 200 }, step: 1, format: wNumb({ decimals: 0 }) }); const O = document.getElementById("price1"), q = document.getElementById("price2"), U = document.getElementById("stepPrice"); O.addEventListener("blur", (() => { j(O, .01) })), q.addEventListener("blur", (() => { j(q, .01) })), U.addEventListener("blur", (() => { j(U, -100, 1e3) })); const R = document.getElementById("stepPrice"), W = document.getElementById("stepPriceIndicator"); function Z() { if (!R || !W) return; const e = R.value.replace(",", "."), t = parseFloat(e); let n = "", a = ""; isNaN(t) || (t < 0 ? (n = "fa-solid fa-minus", a = "Obniżka (cena < konkurenta)") : t > 0 ? (n = "fa-solid fa-plus", a = "Podwyżka (cena > konkurenta)") : (n = "fa-solid fa-equals", a = "Wyrównanie ceny (cena = konkurenta)")), W.innerHTML = n ? `<i class="${n}"></i>` : "", W.title = a } R.addEventListener("input", Z), R.addEventListener("change", Z), setTimeout(Z, 0), I.noUiSlider.on("update", (function (e, t) { const n = e.map((e => 60 === parseInt(e) ? "Schowany" : "Pozycja " + e)); H.textContent = n.join(" - ") })), I.noUiSlider.on("change", (function () { pe() })), b = document.getElementById("offerRangeSlider"); var _ = document.getElementById("offerRange"); noUiSlider.create(b, { start: [1, 1], connect: !0, range: { min: 1, max: 1 }, step: 1, format: wNumb({ decimals: 0 }) }), b.noUiSlider.on("update", (function (e, t) { const n = e.map((e => { const t = parseInt(e); let n = " Ofert"; return 1 === t ? n = " Oferta" : t >= 2 && t <= 4 && (n = " Oferty"), t + n })); _.textContent = n.join(" - ") })), b.noUiSlider.on("change", (function () { pe() })); A((function () { const e = document.getElementById("usePriceDifference").checked; n.forEach((t => { const n = function (e, t) { if (e.onlyMe) return { valueToUse: null, colorClass: "prOnlyMe" }; { let n, a; return t ? (n = null !== e.savings ? e.savings : e.priceDifference, a = n) : (a = e.percentageDifference, n = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != n && (n = parseFloat(n.toFixed(2))), null != a && (a = parseFloat(a.toFixed(2))), { valueToUse: a, colorClass: te(n, e.isUniqueBestPrice, e.isSharedBestPrice) } } }(t, e); t.valueToUse = n.valueToUse, t.colorClass = n.colorClass })), pe() }), 300); const G = document.getElementById("usePriceDifference"), J = document.getElementById("unitLabel1"), K = document.getElementById("unitLabel2"), V = document.getElementById("unitLabelStepPrice"); function Q(e) { e ? (J.textContent = "PLN", K.textContent = "PLN", V.textContent = "PLN") : (J.textContent = "%", K.textContent = "%", V.textContent = "%") } function X() { xe(), fetch(`/PriceHistory/GetPrices?storeId=${storeId}`).then((e => e.json())).then((e => { a = e.latestScrapId, function () { const e = "selectedPriceChanges_" + storeId, t = localStorage.getItem(e); if (t) try { const n = JSON.parse(t); n.scrapId && n.scrapId === a || (console.warn(`Wykryto przestarzałe dane symulacji. Zapisany scrapId: ${n.scrapId}, Obecny scrapId: ${a}. Czyszczenie localStorage.`), localStorage.removeItem(e), "function" == typeof updatePriceChangeSummary && updatePriceChangeSummary(!0)) } catch (t) { console.error("Błąd parsowania danych z localStorage. Czyszczenie...", t), localStorage.removeItem(e) } }(), r = e.myStoreName, s = e.setPrice1, c = e.setPrice2, l = e.stepPrice, missedProductsCount = e.missedProductsCount, d = e.usePriceDiff, document.getElementById("usePriceDifference").checked = d, Q(d), u.useMarginForSimulation = e.useMarginForSimulation, u.enforceMinimalMargin = e.enforceMinimalMargin, u.minimalMarginPercent = e.minimalMarginPercent, u.identifierForSimulation = e.identifierForSimulation, u.usePriceWithDelivery = e.usePriceWithDelivery, e.presetName && ("PriceSafari" === e.presetName ? document.getElementById("presetButton").textContent = "Presety - Widok standardowy PriceSafari" : document.getElementById("presetButton").textContent = "Presety - " + e.presetName), n = e.prices.map((e => { let t = "", n = null, a = null, o = null, i = "", r = ""; const s = !0 === e.onlyMe, c = null != e.myPrice ? parseFloat(e.myPrice) : null, l = null != e.marginPrice ? parseFloat(e.marginPrice) : null; if (e.isRejected) t = "prNoOffer"; else if (s) { if (t = "prOnlyMe", null != l && null != c) { let t = c; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = c - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } a = t - l, o = 0 !== l ? a / l * 100 : null, r = "priceBox-diff-margin-neutral-ins" } } else { let s; if (d ? (s = null !== e.savings ? e.savings : e.priceDifference, n = s) : (n = e.percentageDifference, s = e.myPrice && e.lowestPrice && parseFloat(e.myPrice) > parseFloat(e.lowestPrice) && !e.isUniqueBestPrice && !e.isSharedBestPrice ? (parseFloat(e.myPrice) - parseFloat(e.lowestPrice)) / parseFloat(e.myPrice) * 100 : e.percentageDifference), null != s && (s = parseFloat(s.toFixed(2))), null != n && (n = parseFloat(n.toFixed(2))), t = te(s, e.isUniqueBestPrice, e.isSharedBestPrice), null != l && null != c) { let t = c; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = c - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } a = t - l, o = 0 !== l ? a / l * 100 : null, i = a >= 0 ? "+" : "-", r = a >= 0 ? "priceBox-diff-margin-ins" : "priceBox-diff-margin-minus-ins" } } return { ...e, isRejected: e.isRejected || !1, onlyMe: s, valueToUse: n, colorClass: t, marginPrice: l, myPrice: c, marginAmount: a, marginPercentage: o, marginSign: i, marginClass: r } })); const t = n.map((e => e.storeCount)), o = Math.max(...t), i = Math.max(o, 1); b.noUiSlider.updateOptions({ range: { min: 1, max: i } }), b.noUiSlider.set([1, i]); const p = n.map((e => e.myPosition)).filter((e => null !== e && !isNaN(e))), m = p.length > 0 ? Math.max(...p) : 60; I.noUiSlider.updateOptions({ range: { min: 1, max: m } }), I.noUiSlider.set([1, m]), document.getElementById("totalPriceCount").textContent = e.priceCount, document.getElementById("price1").value = s, document.getElementById("price2").value = c, document.getElementById("stepPrice").value = l, Z(), document.getElementById("missedProductsCount").textContent = missedProductsCount, Y(n); const g = document.getElementById("productSearch").value; let f = n; g && (f = f.filter((e => { const t = g.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); let n = ""; switch (u.identifierForSimulation) { case "ID": n = e.externalId ? e.externalId.toString() : ""; break; case "ProducerCode": n = e.producerCode || ""; break; default: n = e.ean || "" }return ((e.productName || "") + " " + n).toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(t) }))), f = ee(f), de(f), ue(f), function () { const e = n.some((e => null !== e.marginAmount && null !== e.marginPercentage)), t = document.getElementById("sortMarginAmount"), a = document.getElementById("sortMarginPercentage"); e ? (t.style.display = "", a.style.display = "") : (t.style.display = "none", a.style.display = "none") }(), function () { const e = document.getElementById("producerFilterDropdown"), t = n.reduce(((e, t) => (t.producer && (e[t.producer] = (e[t.producer] || 0) + 1), e)), {}), a = Object.keys(t).sort(((e, t) => e.localeCompare(t))); e.innerHTML = '<option value="">Wszystkie marki</option>', a.forEach((n => { const a = document.createElement("option"); a.value = n, a.textContent = `${n} (${t[n]})`, e.appendChild(a) })), e.addEventListener("change", pe) }(), pe() })).finally((() => { Ie() })), window.loadPrices = X } function Y(e) { const t = {}; let n = 0; e.forEach((e => { e.flagIds && 0 !== e.flagIds.length ? e.flagIds.forEach((e => { t[e] = (t[e] || 0) + 1 })) : n++ })); const a = document.getElementById("flagContainer"); if (!a) return; a.innerHTML = "", "undefined" != typeof flags && flags && flags.forEach((e => { const n = t[e.flagId] || 0, o = g.has(String(e.flagId)) ? "checked" : "", i = f.has(String(e.flagId)) ? "checked" : "", r = `\n                <div class="flag-filter-group">\n                    <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n                        <input class="form-check-input flagFilterInclude" type="checkbox" id="flagCheckboxInclude_${e.flagId}" value="${e.flagId}" ${o} title="Pokaż wszystkie produkty z tą flagą">\n                    </div>\n                    <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n                        <input class="form-check-input flagFilterExclude" type="checkbox" id="flagCheckboxExclude_${e.flagId}" value="${e.flagId}" ${i} title="Ukryj wszystkie produkty z tą flagą">\n                    </div>\n                    <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n                        ${e.flagName} (${n})\n                    </span>\n                </div>`; a.insertAdjacentHTML("beforeend", r) })); const o = `\n        <div class="flag-filter-group">\n            <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n                <input class="form-check-input flagFilterInclude" type="checkbox" id="flagCheckboxInclude_noFlag" value="noFlag" ${g.has("noFlag") ? "checked" : ""} title="Pokaż wszystkie produkty bez flagi">\n            </div>\n            <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n                <input class="form-check-input flagFilterExclude" type="checkbox" id="flagCheckboxExclude_noFlag" value="noFlag" ${f.has("noFlag") ? "checked" : ""} title="Ukryj wszystkie produkty bez flagi">\n            </div>\n            <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n                Brak flagi (${n})\n            </span>\n        </div>`; a.insertAdjacentHTML("beforeend", o), document.querySelectorAll(".flagFilterInclude, .flagFilterExclude").forEach((e => { const t = e.cloneNode(!0); e.parentNode.replaceChild(t, e), t.addEventListener("change", (function () { const e = this.value; if (this.classList.contains("flagFilterInclude")) if (this.checked) { const t = document.getElementById(`flagCheckboxExclude_${e}`); t && (t.checked = !1, f.delete(e)), g.add(e) } else g.delete(e); else if (this.checked) { const t = document.getElementById(`flagCheckboxInclude_${e}`); t && (t.checked = !1, g.delete(e)), f.add(e) } else f.delete(e); pe() })) })) } function ee(e) { const t = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), n = document.getElementById("bidFilter").checked, a = document.getElementById("suspiciouslyLowFilter").checked, o = Array.from(document.querySelectorAll(".stockFilterMyStore:checked")).map((e => "null" === e.value ? null : "true" === e.value)), i = Array.from(document.querySelectorAll(".stockFilterCompetitor:checked")).map((e => "null" === e.value ? null : "true" === e.value)), r = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)), s = I.noUiSlider.get(), c = parseInt(s[0]), l = parseInt(s[1]), d = b.noUiSlider.get(), u = parseInt(d[0]), p = parseInt(d[1]); let m = e; return m = m.filter((e => { const t = e.myPosition; if (null == t) return !0; const n = parseInt(t), a = n >= c && n <= l; return a })), m = m.filter((e => { const t = e.storeCount; return t >= u && t <= p })), a && (m = m.filter((e => null !== e.singleBestCheaperDiffPerc && e.singleBestCheaperDiffPerc > 25)), m.sort(((e, t) => t.singleBestCheaperDiffPerc - e.singleBestCheaperDiffPerc))), t.length && (m = m.filter((e => t.includes(e.colorClass)))), f.size > 0 && (m = m.filter((e => { if (f.has("noFlag") && 0 === e.flagIds.length) return !1; for (const t of f) if ("noFlag" !== t && e.flagIds.includes(parseInt(t))) return !1; return !0 }))), g.size > 0 && (m = m.filter((e => !(!g.has("noFlag") || 0 !== e.flagIds.length) || e.flagIds.some((e => g.has(e.toString())))))), n && (m = m.filter((e => "1" === e.myIsBidding))), o.length && (m = m.filter((e => o.includes(e.myEntryInStock)))), i.length && (m = m.filter((e => i.includes(e.bestEntryInStock)))), r.includes("yes") ? m = m.filter((e => null !== e.externalPrice)) : r.includes("no") && (m = m.filter((e => null === e.externalPrice))), m } function te(e, t = !1, n = !1) { return n ? "prGood" : t ? e <= s ? "prIdeal" : "prToLow" : e < c ? "prMid" : "prToHigh" } function ne(e, t, a, o, i) { if (!e) return void console.error("Próba aktywacji nieistniejącego przycisku w priceBox:", a); let r = ""; if (null != o && void 0 !== i) { r = ` Krok cenowy ${o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${i}` } e.classList.add("active"), e.innerHTML = r + " | Dodano"; const s = document.createElement("span"); s.innerHTML = " <i class='fa fa-trash' style='font-size:12px; display:flex; color:white; margin-top:3px;'></i>", s.style.textDecoration = "none", s.style.cursor = "pointer", s.style.pointerEvents = "auto", s.addEventListener("click", (function (e) { e.stopPropagation(); const o = a.dataset.productId; h = h.filter((e => String(e.productId) !== String(o))); const i = new CustomEvent("priceBoxChangeRemove", { detail: { productId: o } }); document.dispatchEvent(i); const r = n.find((e => String(e.productId) === String(o))); if (!r) { console.error("Nie znaleziono danych produktu dla ID:", o, "podczas usuwania zmiany."), a.classList.remove("price-changed"); const e = t.querySelector(".simulate-change-btn"); return void (e && (e.classList.remove("active"), e.innerHTML = e.dataset.originalText || "Dodaj zmianę ceny")) } const s = null != r.myPrice ? parseFloat(r.myPrice) : null, c = a.querySelector(".price-box-column-action"); if (!c) return console.error("Nie znaleziono kontenera .price-box-column-action dla ID:", o, "podczas usuwania zmiany."), void a.classList.remove("price-changed"); const l = ie(r); if (l) { const e = re(r, l); c.innerHTML = e.html; const t = c.querySelector(e.actionLineSelector); if (t) { ae(t, l.suggestedPrice, a, r.productId, r.productName, s, r) } else console.error("Nie znaleziono .price-action-line po re-renderowaniu sugestii dla ID:", o) } else c.innerHTML = "", console.warn("Nie udało się obliczyć nowej sugestii po usunięciu dla ID:", o); a.classList.remove("price-changed") })), e.appendChild(s), a.classList.contains("price-changed") || a.classList.add("price-changed") } function ae(e, t, n, a, o, i, r) { let s = "", c = ""; switch (u.identifierForSimulation) { case "ID": s = r.externalId, c = "ID"; break; case "ProducerCode": s = r.producerCode, c = "Kod producenta"; break; default: s = r.ean, c = "EAN" }const d = e.querySelector(".simulate-change-btn"); if (!s || "" === s.toString().trim()) return d && (d.disabled = !0), e.title = `Produkt musi mieć zmapowany ${c}`, e.style.cursor = "not-allowed", void (e.style.opacity = "0.6"); e.addEventListener("click", (function (e) { e.stopPropagation(); const s = this.querySelector(".simulate-change-btn"); if (n.classList.contains("price-changed") || s && s.classList.contains("active")) return void console.log("Zmiana ceny już aktywna dla produktu", a); if (u.useMarginForSimulation) { if (null == r.marginPrice) return void M('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                     <p>Symulacja cenowa z narzutem jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = i; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const t = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = i - t } let n = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); n = t - e } let a = 0 !== r.marginPrice ? (e - r.marginPrice) / r.marginPrice * 100 : 1 / 0, o = 0 !== r.marginPrice ? (n - r.marginPrice) / r.marginPrice * 100 : 1 / 0; a = parseFloat(a.toFixed(2)), o = parseFloat(o.toFixed(2)); let s = p(t), c = ""; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); c = p(t - e), s = `${p(t)} (z dostawą) | ${c} (bez dostawy)` } if (u.minimalMarginPercent > 0) { if (o < u.minimalMarginPercent && !(a < u.minimalMarginPercent && o > a)) { let e = ""; return e = a >= u.minimalMarginPercent ? `Zmiana obniża narzut z <strong>${a}%</strong> (który spełniał minimum) do <strong>${o}%</strong>, czyli poniżej wymaganego progu <strong>${u.minimalMarginPercent}%</strong>.` : `Nowy narzut (<strong>${o}%</strong>) jest poniżej wymaganego minimum (<strong>${u.minimalMarginPercent}%</strong>) i nie stanowi poprawy (lub jest pogorszeniem) poprzedniego, już niskiego narzutu (<strong>${a}%</strong>).`, void M(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                             <p>${e}</p>\n                             <p>Cena zakupu wynosi <strong>${p(r.marginPrice)}</strong>.</p>\n                             <p>Sugerowana cena: <strong>${s}</strong>.</p>`) } } else if (u.enforceMinimalMargin) { if (o < 0 && !(a < 0 && o > a)) return void M(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                             <p>Nowa cena <strong>${s}</strong> spowoduje ujemny narzut (nowy narzut: <strong>${o}%</strong>).</p>\n                             <p>Cena zakupu wynosi <strong>${p(r.marginPrice)}</strong>. Zmiana nie może zostać zastosowana.</p>`); if (u.minimalMarginPercent < 0 && o < u.minimalMarginPercent) return void M(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Nowa cena <strong>${s}</strong> ustawi narzut (<strong>${o}%</strong>), który jest poniżej dopuszczalnego progu straty (<strong>${u.minimalMarginPercent}%</strong>).</p>\n                         <p>Nowy narzut wynosi <strong>${o}%</strong>.</p>`) } } const c = l, d = document.getElementById("usePriceDifference").checked ? "PLN" : "%", m = new CustomEvent("priceBoxChange", { detail: { productId: a, productName: o, currentPrice: i, newPrice: t, storeId: storeId, scrapId: r.scrapId, stepPriceApplied: c, stepUnitApplied: d } }); document.dispatchEvent(m), ne(s, this, n, c, d); let g = '<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Zmiana ceny dodana</p>'; g += `<p style="margin:4px 0;"><strong>Produkt:</strong> ${o}</p>`; let f = "Nowa cena", y = p(t); if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { f = "Nowa cena (z dostawą)"; const e = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); y = p(t - e) } if (g += `<p style="margin:4px 0;"><strong>${f}:</strong> ${p(t)}</p>`, u.usePriceWithDelivery && r.myPriceIncludesDelivery && (g += `<p style="margin:4px 0;"><strong>Nowa cena (bez dostawy):</strong> ${y}</p>`), u.useMarginForSimulation && null != r.marginPrice) { let e = t; if (u.usePriceWithDelivery && r.myPriceIncludesDelivery) { const n = null == r.myPriceDeliveryCost || isNaN(parseFloat(r.myPriceDeliveryCost)) ? 0 : parseFloat(r.myPriceDeliveryCost); e = t - n } g += `<p style="margin:4px 0;"><strong>Nowy narzut:</strong> ${(0 !== r.marginPrice ? (e - r.marginPrice) / r.marginPrice * 100 : 1 / 0).toFixed(2)}%</p>`, g += `<p style="margin:4px 0;"><strong>Cena zakupu:</strong> ${p(r.marginPrice)}</p>`, u.enforceMinimalMargin && (u.minimalMarginPercent > 0 ? g += `<p style="margin:4px 0;"><strong>Minimalny wymagany narzut:</strong> ${u.minimalMarginPercent}%</p>` : u.minimalMarginPercent < 0 && (g += `<p style="margin:4px 0;"><strong>Maksymalna dopuszczalna strata:</strong> ${u.minimalMarginPercent}%</p>`)) } B(g) })); const m = h.find((e => String(e.productId) === String(a))); m && ne(d, e, n, m.stepPriceApplied, m.stepUnitApplied) } function oe(e) { switch (e) { case "priceBox-diff-margin-ins": return "price-badge-positive"; case "priceBox-diff-margin-minus-ins": return "price-badge-negative"; default: return "price-badge-neutral" } } function ie(e) { const t = null != e.myPrice ? parseFloat(e.myPrice) : null, n = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null, a = null != e.savings ? e.savings.toFixed(2) : "N/A", o = l, i = document.getElementById("usePriceDifference").checked; let r = null, s = null, c = null; if ("prToLow" === e.colorClass || "prIdeal" === e.colorClass) { if (null != t && "N/A" !== a) { s = t + parseFloat(a.replace(",", ".")), c = "raise" } } else "prMid" === e.colorClass || "prToHigh" === e.colorClass ? null != t && null != n && (s = n, c = "lower") : "prGood" === e.colorClass && null != t && (s = t, c = e.storeCount > 1 || o > 0 ? "good_step" : "good_no_step"); if (null !== s && null !== c && ("good_no_step" === c ? r = s : (r = i ? s + o : s * (1 + o / 100), r < .01 && (r = .01))), null === r) return null; const d = r - (t || 0), u = null != t && t > 0 ? d / t * 100 : 0; let p = ""; return "raise" === c ? p = d > 0 ? "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise" : d < 0 ? "arrow-down-turquoise" : "no-change-icon-turquoise" : "lower" === c ? p = d > 0 ? "prMid" === e.colorClass ? "arrow-up-yellow" : "arrow-up-red" : d < 0 ? "prMid" === e.colorClass ? "arrow-down-yellow" : "arrow-down-red" : "no-change-icon" : "good_step" !== c && "good_no_step" !== c || (p = d > 0 ? "arrow-up-green" : d < 0 ? "arrow-down-green" : "no-change-icon-turquoise"), { suggestedPrice: r, totalChangeAmount: d, percentageChange: u, arrowClass: p, priceType: c } } function re(e, t) { if (!t) return { html: "", actionLineSelector: null, suggestedPrice: null, myPrice: null }; const { suggestedPrice: n, totalChangeAmount: a, percentageChange: o, arrowClass: i, priceType: r } = t, s = null != e.myPrice ? parseFloat(e.myPrice) : null, c = null != e.marginPrice ? parseFloat(e.marginPrice) : null; let l = "color-square-turquoise"; ("raise" === r || "lower" === r || r && r.startsWith("good")) && (l = "color-square-turquoise"); const d = document.createElement("div"); d.className = "price-box-column"; const m = document.createElement("div"); m.className = "price-box-column-text"; const g = document.createElement("div"); g.style.display = "flex", g.style.alignItems = "center", g.innerHTML = `<span class="${i}" style="margin-right: 8px;"></span><div><span style="font-weight: 500; font-size: 17px;">${p(n)}</span></div>`; const f = document.createElement("div"); f.textContent = "Zmiana ceny Twojej oferty", f.style.fontSize = "14px", f.style.color = "#212529"; const y = document.createElement("div"); y.style.marginTop = "3px"; let h = ""; h = a > 0 ? "Podwyżka ceny" : a < 0 ? "Obniżka ceny" : "Brak zmiany"; const P = `<div class="price-diff-stack-badge">${h}</div>`; if (y.innerHTML = `<div class="price-diff-stack" style="text-align: left;">${P}<span class="diff-amount small-font">${a > 0 ? "+" : ""}${p(a, !1)} PLN</span>&nbsp;<span class="diff-percentage small-font">(${o > 0 ? "+" : ""}${o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%)</span></div>`, m.appendChild(g), m.appendChild(f), m.appendChild(y), null !== c && null !== n) { let t = n; if (u.usePriceWithDelivery && e.myPriceIncludesDelivery) { t = n - (null == e.myPriceDeliveryCost || isNaN(parseFloat(e.myPriceDeliveryCost)) ? 0 : parseFloat(e.myPriceDeliveryCost)) } const a = t - c, o = 0 !== c ? a / c * 100 : null; if (null !== o) { const e = a >= 0 ? "+" : "-", t = a >= 0 ? "priceBox-diff-margin-ins" : "priceBox-diff-margin-minus-ins", n = oe(t); let i = "price-box-diff-margin-ib-neutral"; "priceBox-diff-margin-ins" === t ? i = "price-box-diff-margin-ib-positive" : "priceBox-diff-margin-minus-ins" === t && (i = "price-box-diff-margin-ib-negative"); const r = e + p(Math.abs(a), !1) + " PLN", s = "(" + e + Math.abs(o).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", c = document.createElement("div"); c.className = "price-box-diff-margin-ib " + i, c.style.marginTop = "3px", c.innerHTML = `<span class="price-badge ${n}">Nowy narzut</span><p>${r} ${s}</p>`, m.appendChild(c) } } const v = document.createElement("div"); v.className = "price-action-line", v.style.marginTop = "8px"; const C = document.createElement("button"); C.className = "simulate-change-btn"; const x = `<span class="${l}"></span> Dodaj zmianę ceny`; return C.innerHTML = x, C.dataset.originalText = x, v.appendChild(C), d.appendChild(m), d.appendChild(v), { html: d.outerHTML, actionLineSelector: ".price-action-line", suggestedPrice: n, myPrice: s } } function se(e) { const n = localStorage.getItem("selectedPriceChanges_" + storeId); if (n) try { const e = JSON.parse(n); e && e.scrapId && Array.isArray(e.changes) ? h = e.changes : (console.warn("Nieznany lub stary format danych 'selectedPriceChanges' w localStorage. Czyszczenie."), h = [], localStorage.removeItem("selectedPriceChanges_" + storeId)) } catch (e) { console.error("Błąd parsowania danych z localStorage:", e), h = [] } else h = []; const a = document.getElementById("priceContainer"), o = document.getElementById("productSearch").value.trim(), i = document.getElementById("storeSearch").value.trim(); a.innerHTML = ""; const s = (T - 1) * F, c = T * F; e.slice(s, c).forEach((e => { const n = me(e.productName, o), s = me(e.storeName, i), c = null != e.myPrice ? parseFloat(e.myPrice) : null, l = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null, d = null != e.savings ? e.savings.toFixed(2) : "N/A", g = e.myPosition, f = e.marginAmount, P = e.marginPercentage, v = e.marginSign, C = e.marginClass, x = e.marginPrice, I = document.createElement("div"); I.className = "price-box " + e.colorClass, I.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId, I.dataset.productId = e.productId, I.dataset.productName = e.productName, I.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })); const b = document.createElement("div"); b.className = "price-box-space"; const w = document.createElement("div"); w.className = "price-box-left-column"; const L = document.createElement("div"); L.className = "price-box-column-name", L.innerHTML = n; const k = function (e) { const t = document.createElement("div"); t.className = "flags-container", e.flagIds && e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const n = flags.find((t => t.flagId === e)); if (n) { const e = document.createElement("span"); e.className = "flag", e.style.color = n.flagColor, e.style.border = "2px solid " + n.flagColor, e.style.backgroundColor = le(n.flagColor, .3), e.innerHTML = n.flagName, t.appendChild(e) } })); return t }(e); w.appendChild(L), w.appendChild(k); const E = document.createElement("div"); E.className = "price-box-right-column"; const S = document.createElement("button"); S.className = "select-product-btn", S.dataset.productId = e.productId, S.style.pointerEvents = "auto", y.has(e.productId.toString()) ? (S.textContent = "Wybrano", S.classList.add("selected")) : S.textContent = "Zaznacz", S.addEventListener("click", (function (e) { e.stopPropagation(); const n = this.dataset.productId; y.has(n) ? (y.delete(n), this.textContent = "Zaznacz", this.classList.remove("selected")) : (y.add(n), this.textContent = "Wybrano", this.classList.add("selected")), t(y), Ce() })); const z = document.createElement("span"); let N, M, B; switch (z.className = "ApiBox", u.identifierForSimulation) { case "ID": N = e.externalId ? e.externalId.toString() : null, M = "ID"; break; case "ProducerCode": N = e.producerCode || null, M = "KOD"; break; default: N = e.ean || null, M = "EAN" }N ? (B = me(N, o, "highlighted-text-yellow"), z.innerHTML = `${M} ${B}`) : z.innerHTML = `Brak ${M}`, E.appendChild(S), E.appendChild(z), b.appendChild(w), b.appendChild(E); const T = document.createElement("div"); T.className = "price-box-data"; const F = document.createElement("div"); F.className = "color-bar " + e.colorClass; const $ = document.createElement("div"); if ($.className = "price-box-column", "prOnlyMe" === e.colorClass) { const e = document.createElement("div"); e.className = "price-box-column-text"; const t = document.createElement("span"); t.style.fontWeight = "500", t.style.fontSize = "17px", t.textContent = "Brak ofert konkurencji", e.appendChild(t); const n = document.createElement("div"); n.textContent = r, e.appendChild(n); const a = document.createElement("div"); a.className = "price-box-column-text"; const o = document.createElement("span"); o.className = "Position", o.style.backgroundColor = "#9C9C9C", o.style.color = "white", o.textContent = "Brak ofert konkurencji - Produkt solo", a.appendChild(o), $.appendChild(e), $.appendChild(a) } else if (null != e.lowestPrice) { const t = document.createElement("div"); t.className = "price-box-column-text"; const n = document.createElement("div"); n.style.display = "flex", n.style.alignItems = "center"; const a = document.createElement("span"); if (a.style.fontWeight = "500", a.style.fontSize = "17px", a.textContent = p(l), n.appendChild(a), void 0 !== e.externalBestPriceCount && null !== e.externalBestPriceCount) if (1 === e.externalBestPriceCount) { const e = document.createElement("div"); e.className = "uniqueBestPriceBox", e.textContent = "★ TOP", e.style.marginLeft = "4px", n.appendChild(e) } else if (e.externalBestPriceCount > 1) { const t = document.createElement("div"); t.className = "shareBestPriceBox", t.textContent = e.externalBestPriceCount + " TOP", t.style.marginLeft = "4px", n.appendChild(t) } if (null !== e.singleBestCheaperDiffPerc && void 0 !== e.singleBestCheaperDiffPerc) { const t = document.createElement("div"); t.style.marginLeft = "4px", t.className = e.singleBestCheaperDiffPerc > 25 ? "singlePriceDiffBoxHigh" : "singlePriceDiffBox"; const a = document.createElement("span"); a.textContent = e.singleBestCheaperDiffPerc.toFixed(2) + "%", t.appendChild(a), n.appendChild(t) } t.appendChild(n); const o = null != e.isGoogle ? '<span class="data-channel" style="display: inline-block; vertical-align: middle;"><img src="' + (e.isGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:14px; height:14px; margin-right:4px;" /></span>' : "", i = document.createElement("div"); if (i.style.display = "flex", i.style.alignItems = "center", i.innerHTML = o + `<span style="display: inline-block; vertical-align: middle;">${s}</span>`, t.appendChild(i), u.usePriceWithDelivery) { const n = ce(e.lowestPrice, e.bestPriceDeliveryCost, e.bestPriceIncludesDelivery); n && t.appendChild(n) } const r = document.createElement("div"); r.className = "price-box-column-text", r.innerHTML = (null !== e.position ? e.isGoogle ? '<span class="Position-Google">Poz. Google ' + e.position + "</span>" : '<span class="Position">Poz. Ceneo ' + e.position + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + ("1" === e.isBidding ? ' <span class="Bidding">Bid</span>' : "") + " " + m(e.bestEntryInStock), $.appendChild(t), $.appendChild(r) } const D = document.createElement("div"); if (D.className = "price-box-column", "prNoOffer" !== e.colorClass && null != c) { const t = null != e.myIsGoogle ? '<span class="data-channel" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><img src="' + (e.myIsGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:14px; height:14px; margin-right:4px;" /></span>' : "", n = document.createElement("div"); if (n.className = "price-box-column-text", null !== e.externalPrice) { const a = (e.externalPrice - c).toFixed(2), o = e.externalPrice < c, i = document.createElement("div"); i.style.display = "flex", i.style.justifyContent = "space-between", i.style.alignItems = "center"; const s = document.createElement("span"); s.style.fontWeight = "500", s.style.marginRight = "20px", s.style.display = "flex", s.style.alignItems = "center", s.innerHTML = t + `<span style="display: inline-block; vertical-align: middle;">${r}</span>`; const l = document.createElement("span"); l.style.fontWeight = "500"; const d = '<span class="' + (o ? "arrow-down" : "arrow-up") + '"></span>'; l.innerHTML = d + (o ? "-" : "") + parseFloat(a).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN ", i.appendChild(s), i.appendChild(l); const m = document.createElement("div"); m.style.display = "flex", m.style.justifyContent = "space-between", m.style.alignItems = "center"; const g = document.createElement("span"); g.style.fontWeight = "500", g.style.textDecoration = "line-through", g.style.marginRight = "10px", g.textContent = p(c); const y = document.createElement("span"); if (y.style.fontWeight = "500", y.textContent = p(e.externalPrice), m.appendChild(g), m.appendChild(y), n.appendChild(m), n.appendChild(i), u.usePriceWithDelivery) { const t = ce(c, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); t && n.appendChild(t) } if (null != x) { const e = p(x), t = oe(C); let a = "price-box-diff-margin-ib-neutral"; "priceBox-diff-margin-ins" === C ? a = "price-box-diff-margin-ib-positive" : "priceBox-diff-margin-minus-ins" === C && (a = "price-box-diff-margin-ib-negative"); const o = document.createElement("div"); o.className = "price-box-diff-margin-ib " + a, o.style.marginTop = "4px", o.innerHTML = `<span class="price-badge ${t}">Cena zakupu</span><p>${e}</p>`; const i = v + p(Math.abs(f), !1) + " PLN", r = "(" + v + Math.abs(P).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", s = document.createElement("div"); s.className = "price-box-diff-margin-ib " + a, s.style.marginTop = "3px", s.innerHTML = `<span class="price-badge ${t}">Zysk (narzut)</span><p>${i} ${r}</p>`, n.appendChild(o), n.appendChild(s) } } else { const a = document.createElement("div"); a.style.display = "flex", a.style.alignItems = "center"; const o = document.createElement("span"); o.style.fontWeight = "500", o.style.fontSize = "17px", o.textContent = p(c), a.appendChild(o); const i = document.createElement("div"); if (i.style.display = "flex", i.style.alignItems = "center", i.innerHTML = t + `<span style="display: inline-block; vertical-align: middle;">${r}</span>`, n.appendChild(a), n.appendChild(i), u.usePriceWithDelivery) { const t = ce(c, e.myPriceDeliveryCost, e.myPriceIncludesDelivery); t && n.appendChild(t) } if (null != x) { const e = p(x), t = oe(C); let a = "price-box-diff-margin-ib-neutral"; "priceBox-diff-margin-ins" === C ? a = "price-box-diff-margin-ib-positive" : "priceBox-diff-margin-minus-ins" === C && (a = "price-box-diff-margin-ib-negative"); const o = document.createElement("div"); o.className = "price-box-diff-margin-ib " + a, o.style.marginTop = "4px", o.innerHTML = `<span class="price-badge ${t}">Cena zakupu</span><p>${e}</p>`; const i = v + p(Math.abs(f), !1) + " PLN", r = "(" + v + Math.abs(P).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", s = document.createElement("div"); s.className = "price-box-diff-margin-ib " + a, s.style.marginTop = "3px", s.innerHTML = `<span class="price-badge ${t}">Zysk (narzut)</span><p>${i} ${r}</p>`, n.appendChild(o), n.appendChild(s) } } const a = document.createElement("div"); a.className = "price-box-column-text"; let o = []; null !== g ? e.myIsGoogle ? o.push(`<span class="Position-Google">Poz. Google ${g}</span>`) : o.push(`<span class="Position">Poz. Ceneo ${g}</span>`) : o.push('<span class="Position" style="background-color: #414141;">Schowany</span>'), "1" === e.myIsBidding && o.push('<span class="Bidding">Bid</span>'), o.push(m(e.myEntryInStock)), a.innerHTML = o.join(" "), D.appendChild(n), D.appendChild(a) } else { const e = document.createElement("div"); e.className = "price-box-column-text"; const t = document.createElement("span"); t.style.fontWeight = "500", t.textContent = "Brak Twojej oferty", t.style.fontSize = "17px", e.appendChild(t); const n = document.createElement("div"); if (n.textContent = r, e.appendChild(n), null != x) { const t = p(x), n = oe("priceBox-diff-margin-neutral-ins"), a = "price-box-diff-margin-ib-neutral", o = document.createElement("div"); o.className = "price-box-diff-margin-ib " + a, o.style.marginTop = "4px", o.innerHTML = `<span class="price-badge ${n}">Cena zakupu</span><p>${t}</p>`; const i = document.createElement("div"); i.className = "price-box-diff-margin-ib " + a, i.style.marginTop = "3px", i.innerHTML = `<span class="price-badge ${n}">Zysk (narzut)</span><p>Brak informacji</p>`, e.appendChild(o), e.appendChild(i) } const a = document.createElement("div"); a.className = "price-box-column-text"; const o = document.createElement("span"); o.className = "Position", o.style.backgroundColor = "#9C9C9C", o.textContent = "Brak Twojej oferty - Cena niedostępna", a.appendChild(o), D.appendChild(e), D.appendChild(a) } const A = document.createElement("div"); A.className = "price-box-column-action", A.innerHTML = ""; const H = h.find((t => String(t.productId) === String(e.productId))); if ("prNoOffer" !== e.colorClass) { let t = null; if (H && (t = H.newPrice), "prToLow" === e.colorClass || "prIdeal" === e.colorClass) { if (null != c && null != d) { let n; if (H) n = t; else { const t = ie(e); n = t ? t.suggestedPrice : null } if (null !== n) { const t = n - c, a = c > 0 ? t / c * 100 : 0; let o; o = t > 0 ? "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise" : t < 0 ? "arrow-down-turquoise" : "no-change-icon-turquoise"; const i = re(e, { suggestedPrice: n, totalChangeAmount: t, percentageChange: a, arrowClass: o, priceType: "raise" }); A.innerHTML = i.html; const r = A.querySelector(i.actionLineSelector); if (r) { const t = ie(e); ae(r, t ? t.suggestedPrice : n, I, e.productId, e.productName, c, e) } } } } else if ("prMid" === e.colorClass || "prToHigh" === e.colorClass) { if (null != c && null != l) { let n; if (H) n = t; else { const t = ie(e); n = t ? t.suggestedPrice : null } if (null !== n) { const t = n - c, a = c > 0 ? t / c * 100 : 0; let o; o = t > 0 ? "prMid" === e.colorClass ? "arrow-up-yellow" : "arrow-up-red" : t < 0 ? "prMid" === e.colorClass ? "arrow-down-yellow" : "arrow-down-red" : "no-change-icon"; const i = re(e, { suggestedPrice: n, totalChangeAmount: t, percentageChange: a, arrowClass: o, priceType: "lower" }); A.innerHTML = i.html; const r = A.querySelector(i.actionLineSelector); if (r) { const t = ie(e); ae(r, t ? t.suggestedPrice : n, I, e.productId, e.productName, c, e) } } } } else if ("prGood" === e.colorClass && null != c) { let n; if (H) n = t; else { const t = ie(e); n = t ? t.suggestedPrice : null } if (null !== n) { const t = n - c; let a; a = t > 0 ? "arrow-up-green" : t < 0 ? "arrow-down-green" : "no-change-icon-turquoise"; const o = re(e, { suggestedPrice: n, totalChangeAmount: t, percentageChange: c > 0 ? t / c * 100 : 0, arrowClass: a, priceType: "good" }); A.innerHTML = o.html; const i = A.querySelector(o.actionLineSelector); if (i) { const t = ie(e); ae(i, t ? t.suggestedPrice : n, I, e.productId, e.productName, c, e) } } } } if (T.appendChild(F), e.imgUrl) { const t = document.createElement("img"); t.dataset.src = e.imgUrl, t.alt = e.productName, t.className = "lazy-load", t.style.width = "142px", t.style.height = "182px", t.style.objectFit = "contain", t.style.objectPosition = "center", t.style.marginRight = "3px", t.style.marginLeft = "3px", t.style.backgroundColor = "#ffffff", t.style.border = "1px solid #e3e3e3", t.style.borderRadius = "4px", t.style.padding = "8px", t.style.display = "block", T.appendChild(t) } const j = document.createElement("div"); j.className = "price-box-stats-container"; let O = `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    ${e.sourceGoogle ? '<img src="/images/GoogleShopping.png" alt="Google Icon" style="width:15px; height:15px;" />' : ""}\n                    ${e.sourceCeneo ? '<img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:15px; height:15px;" />' : ""}\n                </span>\n                <div class="offer-count-box">${q = e.storeCount, 1 === q ? `${q} Oferta` : q > 10 && q < 20 ? `${q} Ofert` : [2, 3, 4].includes(q % 10) ? `${q} Oferty` : `${q} Ofert`}</div>\n            </div>`; var q; let U = `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel" title="Pozycja cenowa twojej oferty">\n                    <i class="fas fa-trophy" style="font-size: 15px; color: grey; margin-top:1px;"></i>\n                </span>\n                <div class="offer-count-box">\n                    <p>${e.myPricePosition}</p>\n                </div>\n            </div>`; const R = "Ilość zakupionych produktów przez ostatnie 90 dni na Ceneo"; let W = ""; W = e.ceneoSalesCount > 0 ? `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    <i class="fas fa-shopping-cart" style="font-size: 15px; color: grey; margin-top:1px;" title="${R}"></i>\n                </span>\n                <div class="offer-count-box">\n                    <p>${e.ceneoSalesCount} osb. kupiło</p>\n                </div>\n            </div>` : `\n            <div class="price-box-column-offers-a">\n                <span class="data-channel">\n                    <i class="fas fa-shopping-cart" style="font-size: 15px; color: grey; margin-top:1px;" title="${R}"></i>\n                </span>\n                <div class="offer-count-box">\n                    <p>Brak danych</p>\n                </div>\n            </div>`; let Z = function (e) { const t = e.salesTrendStatus; if ("NoData" === t || null === t) return '\n        <div class="price-box-column-offers-a">\n            <span class="data-channel">\n                <i class="fas fa-chart-line" style="font-size: 15px; color: grey; margin-top:1px;" title="Trend sprzedaży"></i>\n            </span>\n            <div class="offer-count-box">\n                <p>Brak danych</p>\n            </div>\n        </div>'; const n = `Flag-${t}.svg`; let a = ""; if (0 !== e.salesDifference && null !== e.salesDifference) { const t = e.salesDifference > 0 ? "+" : "", n = null !== e.salesPercentageChange ? ` (${t}${e.salesPercentageChange.toFixed(2)}%)` : ""; a = `<p>${t}${e.salesDifference}${n}</p>` } else a = "<p>Bez zmian</p>"; return `\n    <div class="price-box-column-offers-a">\n        <span class="data-channel" title="Trend sprzedaży">\n             <img src="/images/${n}" alt="${t}" style="width:18px; height:18px;" />\n        </span>\n        <div class="offer-count-box">\n            ${a}\n        </div>\n    </div>` }(e); j.innerHTML = O + U + W + Z, T.appendChild(j), T.appendChild($), T.appendChild(D), T.appendChild(A), I.appendChild(b), I.appendChild(T), a.appendChild(I) })), function (e) { const t = Math.ceil(e / F), n = document.getElementById("paginationContainer"); n.innerHTML = ""; const a = document.createElement("button"); a.innerHTML = '<i class="fa fa-chevron-circle-left" aria-hidden="true"></i>', a.disabled = 1 === T, a.addEventListener("click", (() => { T > 1 && (T--, pe(!1)) })), n.appendChild(a); for (let e = 1; e <= t; e++) { const t = document.createElement("button"); t.textContent = e, e === T && t.classList.add("active"), t.addEventListener("click", (() => { T = e, pe(!1) })), n.appendChild(t) } const o = document.createElement("button"); o.innerHTML = '<i class="fa fa-chevron-circle-right" aria-hidden="true"></i>', o.disabled = T === t, o.addEventListener("click", (() => { T < t && (T++, pe(!1)) })), n.appendChild(o) }(e.length); const l = document.querySelectorAll(".lazy-load"), d = new Map, g = new IntersectionObserver(((e, t) => { e.forEach((e => { const n = e.target, a = [...l].indexOf(n); if (e.isIntersecting) { const e = setTimeout((() => { !function (e) { const t = 6, n = Math.max(0, e - t), a = Math.min(l.length - 1, e + t); for (let e = n; e <= a; e++) { const t = l[e]; t.src || (t.src = t.dataset.src, t.onload = () => { t.classList.add("loaded") }) } }(a), t.unobserve(n), d.delete(n) }), 100); d.set(n, e) } else d.has(n) && (clearTimeout(d.get(n)), d.delete(n)) })) }), { root: null, rootMargin: "50px", threshold: .01 }); l.forEach((e => { g.observe(e) })), document.getElementById("displayedProductCount").textContent = e.length } function ce(e, t, n) { if (null == e) return null; const a = parseFloat(e); let o = null != t && !isNaN(parseFloat(t)), i = o ? parseFloat(t) : 0; const r = !0 === n && o ? "#21a73e" : "#f44336"; let s = !0 === n && o ? "Cena zawiera dostawę" : "Cena NIE zawiera dostawy"; const c = document.createElement("div"); c.className = "delivery-info-line"; const l = document.createElement("i"); l.className = "fa fa-truck", l.style.marginRight = "4px", l.style.marginLeft = "1px", l.style.fontSize = "12px", l.title = s, l.style.color = r; const d = document.createElement("span"); if (d.style.fontSize = "12px", d.style.color = "#555", o) { const e = a - i; d.textContent = `${p(e, !1)} PLN | ${p(i, !1)} PLN` } else d.textContent = `${p(a, !1)} PLN | Brak danych o wysyłce`; return c.appendChild(l), c.appendChild(d), c } function le(e, t) { let n = 0, a = 0, o = 0; return 4 == e.length ? (n = parseInt(e[1] + e[1], 16), a = parseInt(e[2] + e[2], 16), o = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), a = parseInt(e[3] + e[4], 16), o = parseInt(e[5] + e[6], 16)), `rgba(${n}, ${a}, ${o}, ${t})` } G.addEventListener("change", (function () { d = this.checked, Q(d) })), document.addEventListener("priceBoxChangeRemove", (function (e) { const { productId: t } = e.detail; if (!t) return; const a = document.querySelector(`#priceContainer .price-box[data-product-id="${t}"]`); if (a) { console.log(`Natychmiastowe resetowanie UI dla productId: ${t} po zdarzeniu priceBoxChangeRemove.`), a.classList.remove("price-changed"); a.querySelectorAll(".simulate-change-btn.active").forEach((e => { e.classList.remove("active"), e.innerHTML = e.dataset.originalText || '<span class="color-square-turquoise"></span> Dodaj zmianę ceny'; const t = e.querySelector("span > i.fa-trash"); t && t.parentElement.remove() })); const e = n.find((e => String(e.productId) === String(t))), o = a.querySelector(".price-box-column-action"); if (e && o) { const t = ie(e); if (t) { const n = re(e, t); o.innerHTML = n.html; const i = o.querySelector(n.actionLineSelector); if (i) { const n = null != e.myPrice ? parseFloat(e.myPrice) : null; ae(i, t.suggestedPrice, a, e.productId, e.productName, n, e) } } else o.innerHTML = "" } } else console.warn(`Nie znaleziono priceBox dla productId: ${t} do zresetowania UI po priceBoxChangeRemove.`) })); const de = A((function (e) { const t = { prNoOffer: 0, prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })); const n = [t.prNoOffer, t.prOnlyMe, t.prToHigh, t.prMid, t.prGood, t.prIdeal, t.prToLow]; if (i) i.data.datasets[0].data = n, i.update(); else { const e = document.getElementById("colorChart").getContext("2d"); i = new Chart(e, { type: "doughnut", data: { labels: ["Cena niedostępna", "Cena solo", "Cena zawyżona", "Cena suboptymalna", "Cena konkurencyjna", "Cena strategiczna", "Cena zaniżona"], datasets: [{ data: n, backgroundColor: ["rgba(230, 230, 230, 1)", "rgba(180, 180, 180, 0.8)", "rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(13, 110, 253, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(230, 230, 230, 1)", "rgba(180, 180, 180, 1)", "rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(13, 110, 253, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, cutout: "65%", layout: { padding: 4 }, plugins: { legend: { display: !1 }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } }), 600); function ue(e) { const t = { prNoOffer: 0, prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })), document.querySelector('label[for="prNoOfferCheckbox"]').textContent = `Cena niedostępna (${t.prNoOffer})`, document.querySelector('label[for="prOnlyMeCheckbox"]').textContent = `Cena solo (${t.prOnlyMe})`, document.querySelector('label[for="prToHighCheckbox"]').textContent = `Cena zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Cena suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Cena konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Cena strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Cena zaniżona (${t.prToLow})` } function pe(e = !0) { e && (T = 1, window.scrollTo(0, 0)), xe(), setTimeout((() => { let e = [...n]; const t = document.getElementById("productSearch").value.trim(), a = document.getElementById("storeSearch").value.trim(); if (t) { const n = t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => { let t = ""; switch (u.identifierForSimulation) { case "ID": t = e.externalId ? e.externalId.toString() : ""; break; case "ProducerCode": t = e.producerCode || ""; break; default: t = e.ean || "" }return ((e.productName || "") + " " + t).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(n) })) } if (a) { const t = a.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => (e.storeName || "").toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(t))) } const i = t ? t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, "") : ""; "" !== i && e.sort(((e, t) => { const n = ((e.productName || "") + " " + (e.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), a = ((t.productName || "") + " " + (t.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), o = fe(n, i), r = fe(a, i); if (o !== r) return o - r; const s = ye(n, i), c = ye(a, i); return s !== c ? c - s : e.productName.localeCompare(t.productName) })), e = ee(e), e.forEach((e => { const t = ie(e); t ? (e.calculatedPercentageChange = t.percentageChange, e.calculatedTotalChangeAmount = t.totalChangeAmount) : (e.calculatedPercentageChange = null, e.calculatedTotalChangeAmount = null) })), null !== w.sortName ? "asc" === w.sortName ? e.sort(((e, t) => e.productName.localeCompare(t.productName))) : e.sort(((e, t) => t.productName.localeCompare(e.productName))) : null !== w.sortPrice ? "asc" === w.sortPrice ? e.sort(((e, t) => e.lowestPrice - t.lowestPrice)) : e.sort(((e, t) => t.lowestPrice - e.lowestPrice)) : null !== w.sortRaiseAmount ? (e = e.filter((e => null !== e.calculatedTotalChangeAmount && e.calculatedTotalChangeAmount > 0)), "asc" === w.sortRaiseAmount ? e.sort(((e, t) => (e.calculatedTotalChangeAmount ?? 1 / 0) - (t.calculatedTotalChangeAmount ?? 1 / 0))) : e.sort(((e, t) => (t.calculatedTotalChangeAmount ?? -1 / 0) - (e.calculatedTotalChangeAmount ?? -1 / 0)))) : null !== w.sortRaisePercentage ? (e = e.filter((e => null !== e.calculatedPercentageChange && e.calculatedPercentageChange > 0)), "asc" === w.sortRaisePercentage ? e.sort(((e, t) => (e.calculatedPercentageChange ?? 1 / 0) - (t.calculatedPercentageChange ?? 1 / 0))) : e.sort(((e, t) => (t.calculatedPercentageChange ?? -1 / 0) - (e.calculatedPercentageChange ?? -1 / 0)))) : null !== w.sortLowerAmount ? (e = e.filter((e => null !== e.calculatedTotalChangeAmount && e.calculatedTotalChangeAmount < 0)), "asc" === w.sortLowerAmount ? e.sort(((e, t) => (e.calculatedTotalChangeAmount ?? 1 / 0) - (t.calculatedTotalChangeAmount ?? 1 / 0))) : e.sort(((e, t) => (t.calculatedTotalChangeAmount ?? -1 / 0) - (e.calculatedTotalChangeAmount ?? -1 / 0)))) : null !== w.sortLowerPercentage ? (e = e.filter((e => null !== e.calculatedPercentageChange && e.calculatedPercentageChange < 0)), "asc" === w.sortLowerPercentage ? e.sort(((e, t) => (e.calculatedPercentageChange ?? 1 / 0) - (t.calculatedPercentageChange ?? 1 / 0))) : e.sort(((e, t) => (t.calculatedPercentageChange ?? -1 / 0) - (e.calculatedPercentageChange ?? -1 / 0)))) : null !== w.sortMarginAmount ? (e = e.filter((e => null !== e.marginAmount)), "asc" === w.sortMarginAmount ? e.sort(((e, t) => e.marginAmount - t.marginAmount)) : e.sort(((e, t) => t.marginAmount - e.marginAmount))) : null !== w.sortMarginPercentage && (e = e.filter((e => null !== e.marginPercentage)), "asc" === w.sortMarginPercentage ? e.sort(((e, t) => e.marginPercentage - t.marginPercentage)) : e.sort(((e, t) => t.marginPercentage - e.marginPercentage))); const r = document.getElementById("producerFilterDropdown").value; r && (e = e.filter((e => e.producer === r))), o = [...e], se(e), de(e), ue(e), Y(e), Ie() }), 0) } function me(e, t, n) { if (!t) return e; const a = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), o = new RegExp(a, "gi"), i = n || "highlighted-text"; return e.replace(o, (e => `<span class="${i}">${e}</span>`)) } function ge(e) { Object.keys(w).forEach((t => { t !== e && (w[t] = null) })), S() } function fe(e, t) { return e.indexOf(t) } function ye(e, t) { let n = 0; for (let a = 0; a < e.length; a++)for (let o = a; o <= e.length; o++) { const i = e.slice(a, o); t.includes(i) && i.length > n && (n = i.length) } return n } document.getElementById("openMarginSettingsBtn").addEventListener("click", (function () { document.getElementById("identifierForSimulationInput").value = u.identifierForSimulation, document.getElementById("useMarginForSimulationInput").value = u.useMarginForSimulation.toString(), document.getElementById("usePriceWithDeliveryInput").value = u.usePriceWithDelivery.toString(), document.getElementById("enforceMinimalMarginInput").value = u.enforceMinimalMargin.toString(), document.getElementById("minimalMarginPercentInput").value = u.minimalMarginPercent, $("#marginSettingsModal").modal("show") })), document.getElementById("saveMarginSettingsBtn").addEventListener("click", (function () { const e = u.usePriceWithDelivery, t = { StoreId: storeId, IdentifierForSimulation: document.getElementById("identifierForSimulationInput").value, UseMarginForSimulation: "true" === document.getElementById("useMarginForSimulationInput").value, UsePriceWithDelivery: "true" === document.getElementById("usePriceWithDeliveryInput").value, EnforceMinimalMargin: "true" === document.getElementById("enforceMinimalMarginInput").value, MinimalMarginPercent: parseFloat(document.getElementById("minimalMarginPercentInput").value) }; fetch("/PriceHistory/SaveMarginSettings", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((n => { n.success ? e !== t.UsePriceWithDelivery ? (localStorage.removeItem("selectedPriceChanges_" + storeId), void 0 !== h && (h = [], console.log("Zmiany symulacji cenowej usunięte z Local Storage i pamięci, ponieważ zmieniono ustawienie 'Uwzględniaj koszt wysyłki'. Przeładowuję stronę.")), B('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p><p>Zmiana opcji "Uwzględniaj koszt wysyłki" spowodowała usunięcie wprowadzonych zmian symulacji cenowej. Przeładowuję stronę...</p>'), setTimeout((function () { window.location.reload() }), 2e3)) : (B('<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Ustawienia zapisane</p>'), u = t, $("#marginSettingsModal").modal("hide"), X()) : alert("Błąd zapisu ustawień: " + n.message) })).catch((e => { console.error("Błąd zapisu ustawień narzutu:", e), M('<p style="margin-bottom:8px; font-weight:bold;">Błąd zapisu ustawień</p><p>Wystąpił błąd podczas zapisywania ustawień narzutu.</p>') })) })); const he = A((function () { pe() }), 300); document.getElementById("productSearch").addEventListener("input", he), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .stockFilterMyStore, .stockFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { xe(), pe() })) })), document.getElementById("bidFilter").addEventListener("change", (function () { pe() })), document.getElementById("suspiciouslyLowFilter").addEventListener("change", (function () { pe() })), document.getElementById("sortName").addEventListener("click", (function () { null === w.sortName ? (w.sortName = "asc", this.innerHTML = "A-Z ↑", this.classList.add("active")) : "asc" === w.sortName ? (w.sortName = "desc", this.innerHTML = "A-Z ↓", this.classList.add("active")) : (w.sortName = null, this.innerHTML = "A-Z", this.classList.remove("active")), ge("sortName"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortPrice").addEventListener("click", (function () { null === w.sortPrice ? (w.sortPrice = "asc", this.innerHTML = "Cena ↑", this.classList.add("active")) : "asc" === w.sortPrice ? (w.sortPrice = "desc", this.innerHTML = "Cena ↓", this.classList.add("active")) : (w.sortPrice = null, this.innerHTML = "Cena", this.classList.remove("active")), ge("sortPrice"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortRaiseAmount").addEventListener("click", (function () { null === w.sortRaiseAmount ? (w.sortRaiseAmount = "asc", this.innerHTML = "Podnieś PLN ↑", this.classList.add("active")) : "asc" === w.sortRaiseAmount ? (w.sortRaiseAmount = "desc", this.innerHTML = "Podnieś PLN ↓", this.classList.add("active")) : (w.sortRaiseAmount = null, this.innerHTML = "Podnieś PLN", this.classList.remove("active")), ge("sortRaiseAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortRaisePercentage").addEventListener("click", (function () { null === w.sortRaisePercentage ? (w.sortRaisePercentage = "asc", this.innerHTML = "Podnieś % ↑", this.classList.add("active")) : "asc" === w.sortRaisePercentage ? (w.sortRaisePercentage = "desc", this.innerHTML = "Podnieś % ↓", this.classList.add("active")) : (w.sortRaisePercentage = null, this.innerHTML = "Podnieś %", this.classList.remove("active")), ge("sortRaisePercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortLowerAmount").addEventListener("click", (function () { null === w.sortLowerAmount ? (w.sortLowerAmount = "asc", this.innerHTML = "Obniż PLN ↑", this.classList.add("active")) : "asc" === w.sortLowerAmount ? (w.sortLowerAmount = "desc", this.innerHTML = "Obniż PLN ↓", this.classList.add("active")) : (w.sortLowerAmount = null, this.innerHTML = "Obniż PLN", this.classList.remove("active")), ge("sortLowerAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortLowerPercentage").addEventListener("click", (function () { null === w.sortLowerPercentage ? (w.sortLowerPercentage = "asc", this.innerHTML = "Obniż % ↑", this.classList.add("active")) : "asc" === w.sortLowerPercentage ? (w.sortLowerPercentage = "desc", this.innerHTML = "Obniż % ↓", this.classList.add("active")) : (w.sortLowerPercentage = null, this.innerHTML = "Obniż %", this.classList.remove("active")), ge("sortLowerPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortMarginAmount").addEventListener("click", (function () { null === w.sortMarginAmount ? (w.sortMarginAmount = "asc", this.innerHTML = "Narzut PLN ↑", this.classList.add("active")) : "asc" === w.sortMarginAmount ? (w.sortMarginAmount = "desc", this.innerHTML = "Narzut PLN ↓", this.classList.add("active")) : (w.sortMarginAmount = null, this.innerHTML = "Narzut PLN", this.classList.remove("active")), ge("sortMarginAmount"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("sortMarginPercentage").addEventListener("click", (function () { null === w.sortMarginPercentage ? (w.sortMarginPercentage = "asc", this.innerHTML = "Narzut % ↑", this.classList.add("active")) : "asc" === w.sortMarginPercentage ? (w.sortMarginPercentage = "desc", this.innerHTML = "Narzut % ↓", this.classList.add("active")) : (w.sortMarginPercentage = null, this.innerHTML = "Narzut %", this.classList.remove("active")), ge("sortMarginPercentage"), localStorage.setItem("priceHistorySortingState_" + storeId, JSON.stringify(w)), pe() })), document.getElementById("usePriceDifference").addEventListener("change", (function () { d = this.checked, Q(d) })), document.getElementById("storeSearch").addEventListener("input", he), document.getElementById("price1").addEventListener("input", (function () { s = parseFloat(this.value) })), document.getElementById("price2").addEventListener("input", (function () { c = parseFloat(this.value) })), document.getElementById("productSearch").addEventListener("input", (function () { T = 1, window.scrollTo(0, 0), he() })); const Pe = document.getElementById("exportToExcelButton"); Pe && Pe.addEventListener("click", (function () { !function (e) { if (!e || 0 === e.length) return void alert("Brak danych do wyeksportowania po zastosowaniu filtrów."); const t = new ExcelJS.Workbook, n = t.addWorksheet("Dane"); n.addRow(["ID", "Nazwa Produktu", "EAN", "Ilość ofert", "Najniższa Konkurencyjna Cena", "Twoja Cena"]); const a = { color: { argb: "FFAA0000" } }, o = { color: { argb: "FF006400" } }, i = { color: { argb: "FF7E7E7E" } }; e.forEach((e => { const t = [e.externalId || "", e.productName || "", e.ean || "", e.storeCount || "", e.lowestPrice || "", e.myPrice || ""], r = n.addRow(t), s = r.getCell(5), c = r.getCell(6), l = parseFloat(e.lowestPrice) || 0, d = parseFloat(e.myPrice) || 0; l > 0 && d > 0 ? d < l ? (s.font = a, c.font = o) : d > l ? (s.font = o, c.font = a) : (s.font = o, c.font = o) : (s.font = i, c.font = i) })), t.xlsx.writeBuffer().then((e => { const t = new Blob([e], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), n = `PriceSafari-${scrapDateJS}-${myStoreNameJS}.xlsx`, a = document.createElement("a"); a.href = URL.createObjectURL(t), a.download = n, a.click(), setTimeout((() => { URL.revokeObjectURL(a.href) }), 1e3) })) }(o) })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = parseFloat(document.getElementById("stepPrice").value), a = document.getElementById("usePriceDifference").checked, o = { StoreId: storeId, SetPrice1: e, SetPrice2: t, PriceStep: n, UsePriceDiff: a }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }).then((e => e.json())).then((o => { o.success ? (s = e, c = t, l = n, usePriceDifferenceGlobal = a, X()) : alert("Błąd zapisu wartości: " + o.message) })).catch((e => console.error("Błąd zapisu wartości:", e))) })); const ve = document.getElementById("flagModal"); function Ce() { const e = document.getElementById("selectionContainer"), t = document.getElementById("selectedProductsCounter"), a = document.getElementById("selectedProductsModalCounter"), o = document.getElementById("selectedProductsList"), i = y.size; if (e.style.display = "flex", t.textContent = `Wybrano: ${i}`, a && (a.textContent = i), o.innerHTML = "", 0 === i) return void (o.innerHTML = '<div class="alert alert-info text-center">Nie zaznaczono żadnych produktów.</div>'); const r = document.createElement("table"); r.className = "table-orders", r.innerHTML = '\n        <thead class="thead-light">\n            <tr>\n                <th style="width: 65%;">Nazwa Produktu</th>\n                <th>EAN/ID</th>\n                <th class="text-center">Akcja</th>\n            </tr>\n        </thead>'; const s = document.createElement("tbody"); y.forEach((e => { const t = n.find((t => t.productId.toString() === e)); if (t) { const n = document.createElement("tr"); let a = t.ean || t.externalId || "Brak ID"; n.innerHTML = `\n                <td class="align-middle">${t.productName}</td>\n                <td class="align-middle">${a}</td>\n                <td class="text-center align-middle">\n                    <button class="btn btn-danger btn-sm remove-selection-btn" data-product-id="${e}" title="Usuń z zaznaczonych">\n                        <i class="fa-solid fa-trash-can"></i>\n                    </button>\n                </td>\n            `, s.appendChild(n) } })), r.appendChild(s), o.appendChild(r) } function xe() { document.getElementById("loadingOverlay").style.display = "flex" } function Ie() { document.getElementById("loadingOverlay").style.display = "none" } document.getElementsByClassName("close")[0].onclick = function () { ve.style.display = "none" }, window.onclick = function (e) { e.target == ve && (ve.style.display = "none") }, document.getElementById("openBulkFlagModalBtn").addEventListener("click", (function () { if (0 === y.size) return void alert("Nie zaznaczono żadnych produktów."); P = !0, $("#selectedProductsModal").modal("hide"), xe(); const e = Array.from(y); fetch("/ProductFlags/GetFlagCountsForProducts", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ productIds: e }) }).then((e => e.json())).then((e => { !function (e) { const t = document.getElementById("flagModalBody"), n = document.querySelector("#flagModal .price-box-column-name"), a = y.size; n.textContent = `Zarządzaj flagami dla ${a} produktów`, t.innerHTML = "", flags.forEach((n => { const o = e[n.flagId] || 0, i = document.createElement("div"); i.className = "bulk-flag-item", i.dataset.flagId = n.flagId; const r = document.createElement("div"); r.className = "flag-label", r.innerHTML = `\n                <span class="flag-name" style="border-color: ${n.flagColor}; color: ${n.flagColor}; background-color: ${le(n.flagColor, .3)};">${n.flagName}</span>\n                <span class="flag-count">(${o} / ${a})</span>\n            `; const s = document.createElement("div"); s.className = "flag-actions", s.innerHTML = `\n            <div class="action-group">\n                <label>\n                    <input type="checkbox" class="bulk-flag-action" data-action="add" ${o === a ? "disabled" : ""}> Dodaj\n                </label>\n                <span class="change-indicator add-indicator">${o} → ${a}</span>\n            </div>\n            <div class="action-group">\n                <label>\n                    <input type="checkbox" class="bulk-flag-action" data-action="remove" ${0 === o ? "disabled" : ""}> Odepnij\n                </label>\n                <span class="change-indicator remove-indicator">${o} → 0</span>\n            </div>\n        `, i.appendChild(r), i.appendChild(s), t.appendChild(i) })), t.querySelectorAll(".bulk-flag-action").forEach((e => { e.addEventListener("change", (function () { const e = this.closest(".bulk-flag-item"), t = this.dataset.action; this.checked && ("add" === t ? e.querySelector('.bulk-flag-action[data-action="remove"]').checked = !1 : e.querySelector('.bulk-flag-action[data-action="add"]').checked = !1), e.querySelector(".add-indicator").style.display = e.querySelector('.bulk-flag-action[data-action="add"]').checked ? "inline" : "none", e.querySelector(".remove-indicator").style.display = e.querySelector('.bulk-flag-action[data-action="remove"]').checked ? "inline" : "none" })) })) }(e), Ie(), $("#flagModal").modal("show") })).catch((e => { console.error("Błąd pobierania liczników flag:", e), Ie(), alert("Nie udało się pobrać danych o flagach.") })) })), document.getElementById("saveFlagsButton").addEventListener("click", (function () { const t = [], n = []; if (document.querySelectorAll("#flagModalBody .bulk-flag-item").forEach((e => { const a = parseInt(e.dataset.flagId, 10), o = e.querySelector('.bulk-flag-action[data-action="add"]'), i = e.querySelector('.bulk-flag-action[data-action="remove"]'); o && o.checked && t.push(a), i && i.checked && n.push(a) })), 0 === t.length && 0 === n.length) return void alert("Nie wybrano żadnych akcji do wykonania."); const a = { productIds: Array.from(y).map((e => parseInt(e))), flagsToAdd: t, flagsToRemove: n }; xe(), fetch("/ProductFlags/UpdateFlagsForMultipleProducts", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(a) }).then((e => e.json())).then((t => { t.success ? ($("#flagModal").modal("hide"), B(`<p>Pomyślnie zaktualizowano flagi dla ${a.productIds.length} produktów.</p>`), y.clear(), localStorage.removeItem(e), Ce(), X()) : alert("Błąd: " + t.message) })).catch((e => console.error("Błąd masowej aktualizacji flag:", e))).finally((() => Ie())) })), document.getElementById("selectedProductsList").addEventListener("click", (function (e) { const n = e.target.closest(".remove-selection-btn"); if (n) { const e = n.dataset.productId; y.delete(e), t(y); const a = document.querySelector(`.select-product-btn[data-product-id='${e}']`); a && (a.textContent = "Zaznacz", a.classList.remove("selected")), Ce() } })), document.getElementById("showSelectedProductsBtn").addEventListener("click", (function () { Ce(), $("#selectedProductsModal").modal("show") })), X(), Ce() }));