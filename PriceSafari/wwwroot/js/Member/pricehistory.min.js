document.addEventListener("DOMContentLoaded", (function () { let e = [], t = null, n = "", r = 2, c = 2, o = null, l = "", a = new Set, i = null, s = null; function d() { fetch(`/PriceHistory/GetPrices?storeId=${storeId}&competitorStore=${l}`).then((e => e.json())).then((t => { n = t.myStoreName, r = t.setPrice1, c = t.setPrice2, missedProductsCount = t.missedProductsCount; const o = document.getElementById("usePriceDifference").checked; e = t.prices.map((e => { let t; return t = o ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, { ...e, valueToUse: t, colorClass: f(t, e.isUniqueBestPrice, e.isSharedBestPrice) } })), document.getElementById("totalPriceCount").textContent = t.priceCount, document.getElementById("price1").value = r, document.getElementById("price2").value = c, document.getElementById("missedProductsCount").textContent = missedProductsCount, u(e); const l = document.getElementById("productSearch").value; let a = e; l && (a = a.filter((e => { const t = l.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); return e.productName.toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(t) }))), a = p(a), i && s && (a = i(a)), m(a), h(a), y(a) })).catch((e => console.error("Error fetching prices:", e))) } function u(e) { const t = {}; let n = 0; e.forEach((e => { 0 === e.flagIds.length && n++, e.flagIds.forEach((e => { t[e] || (t[e] = 0), t[e]++ })) })); const r = document.getElementById("flagContainer"); r.innerHTML = "", flags.forEach((e => { const n = t[e.FlagId] || 0, c = `\n            <div class="form-check">\n                <input class="form-check-input flagFilter" type="checkbox" id="flagCheckbox_${e.FlagId}" value="${e.FlagId}" ${a.has(e.FlagId.toString()) ? "checked" : ""}>\n                <label class="form-check-label" for="flagCheckbox_${e.FlagId}">${e.FlagName} (${n})</label>\n            </div>\n        `; r.innerHTML += c })); const c = `\n        <div class="form-check">\n            <input class="form-check-input flagFilter" type="checkbox" id="noFlagCheckbox" value="noFlag" ${a.has("noFlag") ? "checked" : ""}>\n            <label class="form-check-label" for="noFlagCheckbox">Brak flagi (${n})</label>\n        </div>\n        `; r.innerHTML += c, document.querySelectorAll(".flagFilter").forEach((e => { e.addEventListener("change", (function () { const e = this.value; this.checked ? a.add(e) : a.delete(e), A() })) })) } function p(e) { const t = document.getElementById("category").value, n = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), r = document.getElementById("bidFilter").checked, c = Array.from(document.querySelectorAll(".positionFilter:checked")).map((e => parseInt(e.value))), o = Array.from(document.querySelectorAll(".deliveryFilterMyStore:checked")).map((e => parseInt(e.value))), l = Array.from(document.querySelectorAll(".deliveryFilterCompetitor:checked")).map((e => parseInt(e.value))), i = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)); let s = t ? e.filter((e => e.category === t)) : e; return n.length && (s = s.filter((e => n.includes(e.colorClass)))), a.has("noFlag") ? s = s.filter((e => 0 === e.flagIds.length)) : a.size > 0 && (s = s.filter((e => Array.from(a).some((t => e.flagIds.includes(parseInt(t))))))), r && (s = s.filter((e => "1" === e.myIsBidding))), c.length && (s = s.filter((e => c.includes(parseInt(e.myPosition))))), o.length && (s = s.filter((e => o.includes(e.myDelivery)))), l.length && (s = s.filter((e => l.includes(e.delivery)))), i.includes("yes") ? s = s.filter((e => null !== e.externalPrice)) : i.includes("no") && (s = s.filter((e => null === e.externalPrice))), s } function f(e, t = !1, n = !1) { return t && e <= r ? "prIdeal" : t ? "prToLow" : n || e <= 0 ? "prGood" : e < c ? "prMid" : "prToHigh" } function m(e) { const t = document.getElementById("priceContainer"), r = document.getElementById("productSearch").value.trim(); t.innerHTML = "", e.forEach((e => { const c = function (e, t) { if (!t) return e; const n = t.replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""); let r = 0, c = ""; for (let t = 0; t < e.length; t++) { const o = e[t].toLowerCase(); if (n[r] === o.replace(/\s+/g, "") || n[r] === e[t].replace(/\s+/g, "") ? (c += `<span style="color: #9400D3;font-weight: 600;">${e[t]}</span>`, r++) : c += e[t], r >= n.length) { c += e.slice(t + 1); break } } return c }(e.productName, r), l = null != e.percentageDifference ? e.percentageDifference.toFixed(2) : "N/A", a = null != e.priceDifference ? e.priceDifference.toFixed(2) : "N/A", i = null != e.savings ? e.savings.toFixed(2) : "N/A", s = "1" === e.isBidding, d = "1" === e.myIsBidding, u = g(e.delivery), p = g(e.myDelivery), f = document.createElement("div"); f.className = "price-box " + e.colorClass, f.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId; const m = document.createElement("div"); m.className = "price-box-space"; const h = document.createElement("div"); h.className = "price-box-column-name", h.innerHTML = c; const y = document.createElement("button"); y.className = "assign-flag-button", y.dataset.productId = e.productId, y.innerHTML = "+ Przypisz flagi", m.appendChild(h), m.appendChild(y); const v = document.createElement("div"); if (v.className = "price-box-column-category", v.innerHTML = e.category, e.externalId) { const t = document.createElement("span"); t.className = "ApiBox", t.innerHTML = "API ID " + e.externalId, v.appendChild(t) } const E = document.createElement("div"); E.className = "price-box-data"; const I = document.createElement("div"); I.className = "color-bar " + e.colorClass; const b = document.createElement("div"); b.className = "price-box-column", b.innerHTML = '<div class="price-box-column-text">' + e.lowestPrice.toFixed(2) + ' zł</div><div class="price-box-column-text">' + e.storeName + " " + (s ? '<span class="Bidding">Bid</span>' : "") + '<span class="Position">Msc ' + e.position + "</span>" + (null != e.delivery ? '<span class="' + u + '">Wysyłka w ' + (1 == e.delivery ? "1 dzień" : e.delivery + " dni") + "</span>" : "") + "</div>"; const C = document.createElement("div"); C.className = "price-box-column", C.innerHTML = '<div class="price-box-column-text">' + e.myPrice.toFixed(2) + ' zł</div><div class="price-box-column-text">' + n + " " + (d ? '<span class="Bidding">Bid</span>' : "") + '<span class="Position">Msc ' + e.myPosition + "</span>" + (null != e.myDelivery ? '<span class="' + p + '">Wysyłka w ' + (1 == e.myDelivery ? "1 dzień" : e.myDelivery + " dni") + "</span>" : "") + "</div>"; const k = document.createElement("div"); k.className = "price-box-column-action", "prToLow" === e.colorClass || "prIdeal" === e.colorClass ? k.innerHTML = "<p>Podnieś: " + i + " zł</p><p>Podnieś: " + l + " %</p>" : "prMid" === e.colorClass || "prToHigh" === e.colorClass ? k.innerHTML = "<p>Obniż: " + a + " zł</p><p>Obniż: " + l + " %</p>" : "prGood" === e.colorClass && (k.innerHTML = "<p>Brak działań</p>"); const P = document.createElement("div"); if (P.className = "price-box-column-api", null !== e.externalPrice) { const t = (e.externalPrice - e.myPrice).toFixed(2), n = (e.externalPrice > e.myPrice ? "+" : "") + t; P.innerHTML = '<div class="price-box-column-text-api">Nowa cena: ' + e.externalPrice.toFixed(2) + ' zł</div><div class="price-box-column-text-api">Zmiana: ' + n + " zł</div>" } const x = document.createElement("div"); x.className = "flags-container", e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const t = flags.find((function (t) { return t.FlagId === e })), n = document.createElement("span"); n.className = "flag", n.style.color = t.FlagColor, n.style.border = "2px solid " + t.FlagColor, n.style.backgroundColor = function (e, t) { let n = 0, r = 0, c = 0; 4 == e.length ? (n = parseInt(e[1] + e[1], 16), r = parseInt(e[2] + e[2], 16), c = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), r = parseInt(e[3] + e[4], 16), c = parseInt(e[5] + e[6], 16)); return `rgba(${n}, ${r}, ${c}, ${t})` }(t.FlagColor, .3), n.innerHTML = t.FlagName, x.appendChild(n) })), E.appendChild(I), E.appendChild(b), E.appendChild(C), E.appendChild(k), null !== e.externalPrice && E.appendChild(P), E.appendChild(x), f.appendChild(m), f.appendChild(v), f.appendChild(E), f.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })), t.appendChild(f), y.addEventListener("click", (function (e) { e.stopPropagation(), o = this.dataset.productId, N.style.display = "block", fetch("/ProductFlags/GetFlagsForProduct?productId=" + o).then((e => e.json())).then((e => { document.querySelectorAll(".flagCheckbox").forEach((function (t) { t.checked = e.includes(parseInt(t.value)) })) })).catch((e => console.error("Error fetching flags for product:", e))) })) })), document.getElementById("displayedProductCount").textContent = e.length } function g(e) { return e <= 1 ? "Availability1Day" : e <= 3 ? "Availability3Days" : e <= 7 ? "Availability7Days" : "Availability14Days" } function h(e) { const n = { prGood: 0, prMid: 0, prToHigh: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { n[e.colorClass]++ })); const r = document.getElementById("colorChart").getContext("2d"); t && t.destroy(), t = new Chart(r, { type: "doughnut", data: { labels: ["Zawyżona", "Suboptymalna", "Konkurencyjna", "Strategiczna", "Zaniżona"], datasets: [{ data: [n.prToHigh, n.prMid, n.prGood, n.prIdeal, n.prToLow], backgroundColor: ["rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(0, 145, 123, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(0, 145, 123, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, plugins: { legend: { display: !1, position: "right", labels: { usePointStyle: !0, padding: 16, generateLabels: function (e) { const t = Chart.overrides.doughnut.plugins.legend.labels.generateLabels.call(this, e); return t.forEach((e => { e.text = "   " + e.text })), t } } }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } function y(e) { const t = { prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass]++ })), document.querySelector('label[for="prToHighCheckbox"]').textContent = `Zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Zaniżona (${t.prToLow})` } function v(e) { return e.sort(((e, t) => e.productName.localeCompare(t.productName))) } function E(e) { return e.sort(((e, t) => t.productName.localeCompare(e.productName))) } function I(e) { return e.sort(((e, t) => e.lowestPrice - t.lowestPrice)) } function b(e) { return e.sort(((e, t) => t.lowestPrice - e.lowestPrice)) } function C(e) { return e.filter((e => null !== e.savings)).sort(((e, t) => e.savings - t.savings)) } function k(e) { return e.filter((e => null !== e.savings)).sort(((e, t) => t.savings - e.savings)) } function P(e) { return e.filter((e => null !== e.savings)).sort(((e, t) => e.percentageDifference - t.percentageDifference)) } function x(e) { return e.filter((e => null !== e.savings)).sort(((e, t) => t.percentageDifference - e.percentageDifference)) } function L(e) { return e.filter((e => null === e.savings && 0 !== e.priceDifference)).sort(((e, t) => e.priceDifference - t.priceDifference)) } function B(e) { return e.filter((e => null === e.savings && 0 !== e.priceDifference)).sort(((e, t) => t.priceDifference - e.priceDifference)) } function F(e) { return e.filter((e => null === e.savings && 0 !== e.priceDifference)).sort(((e, t) => e.percentageDifference - t.percentageDifference)) } function D(e) { return e.filter((e => null === e.savings && 0 !== e.priceDifference)).sort(((e, t) => t.percentageDifference - e.percentageDifference)) } function A(t = null) { const n = document.getElementById("productSearch").value.toLowerCase().replace(/\s+/g, "").trim(); let r = e.filter((e => e.productName.toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(n))); var c; r.sort(((e, t) => { const r = e.productName.toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), c = t.productName.toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, ""), o = S(r, n), l = S(c, n); if (o !== l) return o - l; const a = w(r, n), i = w(c, n); return a !== i ? i - a : e.productName.localeCompare(t.productName) })), r = p(r), t && (i === t ? (t = null, i = null, T()) : (i = t, c = this, T(), c.classList.add("active"), s = c, s = this)), i && (r = i(r)), m(r), h(r), y(r), u(r) } function S(e, t) { return e.indexOf(t) } function w(e, t) { let n = 0; for (let r = 0; r < e.length; r++)for (let c = r; c <= e.length; c++) { const o = e.slice(r, c); t.includes(o) && o.length > n && (n = o.length) } return n } function T() { s && s.classList.remove("active") } document.querySelectorAll("#sortingButtons button").forEach((e => { e.addEventListener("click", (function () { const e = this.getAttribute("id"), t = window[e].bind(null); A.call(this, t) })) })), document.getElementById("productSearch").addEventListener("input", (function () { A(i) })), document.getElementById("category").addEventListener("change", (function () { A(i) })), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .deliveryFilterMyStore, .deliveryFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { A(i) })) })), document.getElementById("bidFilter").addEventListener("change", (function () { A(i) })), document.getElementById("sortNameAZ").addEventListener("click", (function () { A.call(this, v) })), document.getElementById("sortNameZA").addEventListener("click", (function () { A.call(this, E) })), document.getElementById("sortPriceAsc").addEventListener("click", (function () { A.call(this, I) })), document.getElementById("sortPriceDesc").addEventListener("click", (function () { A.call(this, b) })), document.getElementById("sortRaiseAmountAsc").addEventListener("click", (function () { A.call(this, C) })), document.getElementById("sortRaiseAmountDesc").addEventListener("click", (function () { A.call(this, k) })), document.getElementById("sortRaisePercentageAsc").addEventListener("click", (function () { A.call(this, P) })), document.getElementById("sortRaisePercentageDesc").addEventListener("click", (function () { A.call(this, x) })), document.getElementById("sortLowerAmountAsc").addEventListener("click", (function () { A.call(this, L) })), document.getElementById("sortLowerAmountDesc").addEventListener("click", (function () { A.call(this, B) })), document.getElementById("sortLowerPercentageAsc").addEventListener("click", (function () { A.call(this, F) })), document.getElementById("sortLowerPercentageDesc").addEventListener("click", (function () { A.call(this, D) })), document.getElementById("usePriceDifference").addEventListener("change", (function () { const t = this.checked; e.forEach((e => { e.valueToUse = t ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, e.colorClass = f(e.valueToUse, e.isUniqueBestPrice, e.isSharedBestPrice) })), A() })), document.getElementById("price1").addEventListener("input", (function () { r = parseFloat(this.value); const t = document.getElementById("usePriceDifference").checked; e.forEach((e => { e.valueToUse = t ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, e.colorClass = f(e.valueToUse, e.isUniqueBestPrice, e.isSharedBestPrice) })), A() })), document.getElementById("price2").addEventListener("input", (function () { c = parseFloat(this.value); const t = document.getElementById("usePriceDifference").checked; e.forEach((e => { e.valueToUse = t ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, e.colorClass = f(e.valueToUse, e.isUniqueBestPrice, e.isSharedBestPrice) })), A() })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = { StoreId: storeId, SetPrice1: e, SetPrice2: t }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(n) }).then((e => e.json())).then((n => { n.success ? (r = e, c = t, d()) : alert("Error updating price values: " + n.message) })).catch((e => console.error("Błąd w aktualizowaniu wartości:", e))) })); const N = document.getElementById("flagModal"); document.getElementsByClassName("close")[0].onclick = function () { N.style.display = "none" }, window.onclick = function (e) { e.target == N && (N.style.display = "none") }, document.querySelectorAll(".assign-flag-button").forEach((e => { e.addEventListener("click", (function () { o = this.dataset.productId, N.style.display = "block", fetch(`/ProductFlags/GetFlagsForProduct?productId=${o}`).then((e => e.json())).then((e => { document.querySelectorAll(".flagCheckbox").forEach((t => { t.checked = e.includes(parseInt(t.value)) })) })).catch((e => console.error("Błąd dodawania flagi:", e))) })) })), document.getElementById("saveFlagsButton").addEventListener("click", (function () { const e = Array.from(document.querySelectorAll(".flagCheckbox:checked")).map((e => parseInt(e.value))), t = { productId: o, flagIds: e }; fetch("/ProductFlags/AssignFlagsToProduct", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((e => { e.success ? (N.style.display = "none", d()) : alert("Błąd przypisywania flagi: " + e.message) })).catch((e => console.error("Błąd przypisywania flagi:", e))) })), fetch(`/PriceHistory/GetStores?storeId=${storeId}`).then((e => e.json())).then((e => { const t = document.getElementById("competitorStoreSelect"); e.forEach((e => { const n = document.createElement("option"); n.value = e, n.text = e, t.appendChild(n) })), t.addEventListener("change", (function () { l = this.value, d() })) })).catch((e => console.error("Error fetching stores:", e))), d() }));