document.addEventListener("DOMContentLoaded", (function () { let e, t, n = [], a = null, o = "", i = 2, r = 2, c = 2, s = document.getElementById("usePriceDifference").checked, l = { useEanForSimulation: !0, useMarginForSimulation: !0, enforceMinimalMargin: !0, minimalMarginPercent: 0 }, d = null, m = new Set, u = new Set, p = { sortName: null, sortPrice: null, sortRaiseAmount: null, sortRaisePercentage: null, sortLowerAmount: null, sortLowerPercentage: null, sortMarginAmount: null, sortMarginPercentage: null, showRejected: null }; const g = document.getElementById("openMassChangeModalBtn"), f = document.getElementById("massChangeModal"), h = document.querySelector("#massChangeModal .close"); g.addEventListener("click", (function () { $("#massChangeModal").modal("show") })), h.addEventListener("click", (function () { $("#massChangeModal").modal("hide") })), window.addEventListener("click", (function (e) { e.target === f && $("#massChangeModal").modal("hide") })); const y = document.getElementById("massMatchBtn"), P = document.getElementById("massStrategicBtn"); function L(e) { Array.from(document.querySelectorAll("#priceContainer .price-box")).forEach((t => { const n = t.querySelectorAll(".simulate-change-btn"); if (!n || 0 === n.length) return; let a; "match" === e && n[0] ? a = n[0] : "strategic" === e && n[1] && (a = n[1]), a && a.click() })), setTimeout((() => { const e = Array.from(document.querySelectorAll("#priceContainer .price-box")); let t = 0, n = 0; e.forEach((e => { e.classList.contains("price-changed") ? t++ : n++ })), x(`<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Masowa zmiana zakończona!</p>\n             <p>Dodano: <strong>${t}</strong> SKU</p>\n             <p>Odrzucono: <strong>${n}</strong> SKU</p>`) }), 500) } let v, E; function C(e) { const t = document.getElementById("globalNotification"), n = document.getElementById("globalUpdate"); t && (n && "block" === n.style.display && (n.style.display = "none", E && (clearTimeout(E), E = null)), v && clearTimeout(v), t.innerHTML = e, t.style.display = "block", v = setTimeout((() => { t.style.display = "none" }), 4e3)) } function x(e) { const t = document.getElementById("globalUpdate"), n = document.getElementById("globalNotification"); t && (n && "block" === n.style.display && (n.style.display = "none", v && (clearTimeout(v), v = null)), E && clearTimeout(E), t.innerHTML = e, t.style.display = "block", E = setTimeout((() => { t.style.display = "none" }), 4e3)) } y.addEventListener("click", (function () { L("match"), $("#massChangeModal").modal("hide") })), P.addEventListener("click", (function () { L("strategic"), $("#massChangeModal").modal("hide") })); let I = 1; const M = 1e3; function N(e, t) { let n; return function (...a) { const o = this; clearTimeout(n), n = setTimeout((() => e.apply(o, a)), t) } } e = document.getElementById("positionRangeSlider"); var w = document.getElementById("positionRange"); function b(e, t, n) { let a = parseFloat(e.value.replace(",", ".")); isNaN(a) || (e.value = a < t ? t.toFixed(2) : a > n ? n.toFixed(2) : a.toFixed(2)) } noUiSlider.create(e, { start: [1, 60], connect: !0, range: { min: 1, max: 60 }, step: 1, format: wNumb({ decimals: 0 }) }); const F = document.getElementById("price1"), k = document.getElementById("price2"), S = document.getElementById("stepPrice"); F.addEventListener("blur", (() => { b(F, .01), parseFloat(S.value.replace(",", ".")) > parseFloat(F.value.replace(",", ".")) && (S.value = F.value), b(S, .01, parseFloat(F.value.replace(",", "."))) })), k.addEventListener("blur", (() => { b(k, .01) })), S.addEventListener("blur", (() => { b(S, .01, parseFloat(F.value.replace(",", "."))) })), e.noUiSlider.on("update", (function (e, t) { const n = e.map((e => 60 === parseInt(e) ? "Schowany" : "Pozycja " + e)); w.textContent = n.join(" - ") })), e.noUiSlider.on("change", (function () { J() })), t = document.getElementById("offerRangeSlider"); var B = document.getElementById("offerRange"); noUiSlider.create(t, { start: [1, 1], connect: !0, range: { min: 1, max: 1 }, step: 1, format: wNumb({ decimals: 0 }) }), t.noUiSlider.on("update", (function (e, t) { const n = e.map((e => { const t = parseInt(e); let n = " Ofert"; return 1 === t ? n = " Oferta" : t >= 2 && t <= 4 && (n = " Oferty"), t + n })); B.textContent = n.join(" - ") })), t.noUiSlider.on("change", (function () { J() })); N((function () { const e = document.getElementById("usePriceDifference").checked; n.forEach((t => { const n = function (e, t) { if (e.onlyMe) return { valueToUse: null, colorClass: "prOnlyMe" }; { let n = t ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference; return null != n && (n = parseFloat(n.toFixed(2))), { valueToUse: n, colorClass: O(n, e.isUniqueBestPrice, e.isSharedBestPrice) } } }(t, e); t.valueToUse = n.valueToUse, t.colorClass = n.colorClass })), J() }), 300); const D = document.getElementById("usePriceDifference"), T = document.getElementById("unitLabel1"), A = document.getElementById("unitLabel2"), H = document.getElementById("unitLabelStepPrice"); function z(e) { e ? (T.textContent = "PLN", A.textContent = "PLN", H.textContent = "PLN") : (T.textContent = "%", A.textContent = "%", H.textContent = "%") } function R() { ae(), fetch(`/PriceHistory/GetPrices?storeId=${storeId}`).then((e => e.json())).then((e => { o = e.myStoreName, i = e.setPrice1, r = e.setPrice2, c = e.stepPrice, missedProductsCount = e.missedProductsCount, s = e.usePriceDiff, document.getElementById("usePriceDifference").checked = s, z(s), l.useMarginForSimulation = e.useMarginForSimulation, l.enforceMinimalMargin = e.enforceMinimalMargin, l.minimalMarginPercent = e.minimalMarginPercent, l.useEanForSimulation = e.useEanForSimulation, e.presetName && ("PriceSafari" === e.presetName ? document.getElementById("presetButton").textContent = "Presety - Widok standardowy PriceSafari" : document.getElementById("presetButton").textContent = "Presety - " + e.presetName), n = e.prices.map((e => { const t = e.isRejected, n = !0 === e.onlyMe; let a = null, o = ""; n ? o = "prOnlyMe" : t ? o = "prRejected" : (a = s ? null !== e.savings ? e.savings : e.priceDifference : e.percentageDifference, o = O(a, e.isUniqueBestPrice, e.isSharedBestPrice)); const i = null == e.marginPrice || isNaN(e.marginPrice) ? null : parseFloat(e.marginPrice), r = null == e.myPrice || isNaN(e.myPrice) ? null : parseFloat(e.myPrice); let c = null, l = null, d = "", m = ""; return t || null == i || null == r || (c = r - i, l = 0 !== i ? c / i * 100 : null, d = c >= 0 ? "+" : "-", m = c >= 0 ? "priceBox-diff-margin" : "priceBox-diff-margin-minus"), { ...e, isRejected: e.isRejected || !1, onlyMe: n, valueToUse: n ? null : a, colorClass: o, marginPrice: i, myPrice: r, marginAmount: c, marginPercentage: l, marginSign: d, marginClass: m } })); const a = n.map((e => e.storeCount)), d = Math.max(...a), m = Math.max(d, 1); t.noUiSlider.updateOptions({ range: { min: 1, max: m } }), t.noUiSlider.set([1, m]), document.getElementById("totalPriceCount").textContent = e.priceCount, document.getElementById("price1").value = i, document.getElementById("price2").value = r, document.getElementById("stepPrice").value = c, document.getElementById("missedProductsCount").textContent = missedProductsCount, j(n); const u = document.getElementById("productSearch").value; let p = n; u && (p = p.filter((e => { const t = u.replace(/[^a-zA-Z0-9\s.-]/g, "").trim().toLowerCase().replace(/\s+/g, ""); let n; n = l.useEanForSimulation ? e.ean || "" : e.externalId ? e.externalId.toString() : ""; return ((e.productName || "") + " " + n).toLowerCase().replace(/[^a-zA-Z0-9\s/.-]/g, "").replace(/\s+/g, "").includes(t) }))), p = q(p), U(p), G(p), W(p), function () { const e = n.some((e => null !== e.marginAmount && null !== e.marginPercentage)), t = document.getElementById("sortMarginAmount"), a = document.getElementById("sortMarginPercentage"); e ? (t.style.display = "", a.style.display = "") : (t.style.display = "none", a.style.display = "none") }(), function () { const e = document.getElementById("producerFilterDropdown"), t = n.reduce(((e, t) => (t.producer && (e[t.producer] = (e[t.producer] || 0) + 1), e)), {}), a = Object.keys(t).sort(((e, t) => e.localeCompare(t))); e.innerHTML = '<option value="">Wszystkie marki</option>', a.forEach((n => { const a = document.createElement("option"); a.value = n, a.textContent = `${n} (${t[n]})`, e.appendChild(a) })), e.addEventListener("change", J) }() })).finally((() => { oe() })), window.loadPrices = R } function j(e) { const t = {}; let n = 0; e.forEach((e => { 0 === e.flagIds.length && n++, e.flagIds.forEach((e => { t[e] || (t[e] = 0), t[e]++ })) })); const a = document.getElementById("flagContainer"); a.innerHTML = "", flags.forEach((e => { const n = t[e.FlagId] || 0, o = m.has(String(e.FlagId)) ? "checked" : "", i = u.has(String(e.FlagId)) ? "checked" : "", r = `\n          <div class="flag-filter-group">\n            \x3c!-- Checkbox "Pokaż" --\x3e\n            <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n              <input class="form-check-input flagFilterInclude"\n                     type="checkbox"\n                     id="flagCheckboxInclude_${e.FlagId}"\n                     value="${e.FlagId}"\n                     ${o}\n                     title="Pokaż wszystkie produkty z tą flagą" />\n            </div>\n\n            \x3c!-- Checkbox "Ukryj" --\x3e\n            <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n              <input class="form-check-input flagFilterExclude"\n                     type="checkbox"\n                     id="flagCheckboxExclude_${e.FlagId}"\n                     value="${e.FlagId}"\n                     ${i}\n                     title="Ukryj wszystkie produkty z tą flagą" />\n            </div>\n\n            \x3c!-- Nazwa flagi i liczba --\x3e\n            <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n              ${e.FlagName} (${n})\n            </span>\n          </div>\n        `; a.innerHTML += r })); const o = `\n      <div class="flag-filter-group">\n        <div class="form-check form-check-inline check-include" style="margin-right:0px;">\n          <input class="form-check-input flagFilterInclude"\n                 type="checkbox"\n                 id="flagCheckboxInclude_noFlag"\n                 value="noFlag"\n                 ${m.has("noFlag") ? "checked" : ""}\n                 title="Pokaż wszystkie produkty z tą flagą (brak flagi)" />\n        </div>\n\n        <div class="form-check form-check-inline check-exclude" style="margin-right:0px; padding-left:16px;">\n          <input class="form-check-input flagFilterExclude"\n                 type="checkbox"\n                 id="flagCheckboxExclude_noFlag"\n                 value="noFlag"\n                 ${u.has("noFlag") ? "checked" : ""}\n                 title="Ukryj wszystkie produkty z tą flagą (brak flagi)" />\n        </div>\n\n        <span class="flag-name-count" style="font-size:14px; font-weight: 400;">\n          Brak flagi (${n})\n        </span>\n      </div>\n    `; a.innerHTML += o, document.querySelectorAll(".flagFilterInclude").forEach((e => { e.addEventListener("change", (function () { const e = this.value; if (this.checked) { const t = document.getElementById(`flagCheckboxExclude_${e}`); t && t.checked && (t.checked = !1, u.delete(e)), m.add(e) } else m.delete(e); J() })) })), document.querySelectorAll(".flagFilterExclude").forEach((e => { e.addEventListener("change", (function () { const e = this.value; if (this.checked) { const t = document.getElementById(`flagCheckboxInclude_${e}`); t && t.checked && (t.checked = !1, m.delete(e)), u.add(e) } else u.delete(e); J() })) })) } function q(n) { const a = Array.from(document.querySelectorAll(".colorFilter:checked")).map((e => e.value)), o = document.getElementById("bidFilter").checked, i = document.getElementById("suspiciouslyLowFilter").checked, r = Array.from(document.querySelectorAll(".deliveryFilterMyStore:checked")).map((e => parseInt(e.value))), c = Array.from(document.querySelectorAll(".deliveryFilterCompetitor:checked")).map((e => parseInt(e.value))), s = Array.from(document.querySelectorAll(".externalPriceFilter:checked")).map((e => e.value)), l = e.noUiSlider.get(), d = parseInt(l[0]), p = parseInt(l[1]), g = t.noUiSlider.get(), f = parseInt(g[0]), h = parseInt(g[1]); let y = n; return y = y.filter((e => { const t = e.myPosition; if (null == t) return !0; const n = parseInt(t), a = n >= d && n <= p; return a })), y = y.filter((e => { const t = e.storeCount; return t >= f && t <= h })), i && (y = y.filter((e => null !== e.singleBestCheaperDiffPerc && e.singleBestCheaperDiffPerc > 25)), y.sort(((e, t) => t.singleBestCheaperDiffPerc - e.singleBestCheaperDiffPerc))), a.length && (y = y.filter((e => a.includes(e.colorClass)))), u.size > 0 && (y = y.filter((e => { if (u.has("noFlag") && 0 === e.flagIds.length) return !1; for (const t of u) if ("noFlag" !== t && e.flagIds.includes(parseInt(t))) return !1; return !0 }))), m.size > 0 && (y = y.filter((e => !(!m.has("noFlag") || 0 !== e.flagIds.length) || e.flagIds.some((e => m.has(e.toString())))))), o && (y = y.filter((e => "1" === e.myIsBidding))), r.length && (y = y.filter((e => r.includes(e.myDelivery)))), c.length && (y = y.filter((e => c.includes(e.delivery)))), s.includes("yes") ? y = y.filter((e => null !== e.externalPrice)) : s.includes("no") && (y = y.filter((e => null === e.externalPrice))), y } function O(e, t = !1, n = !1) { return n ? "prGood" : t ? e <= i ? "prIdeal" : "prToLow" : e < r ? "prMid" : "prToHigh" } function U(e) { const t = localStorage.getItem("selectedPriceChanges_" + storeId); if (t) try { selectedPriceChanges = JSON.parse(t) } catch (e) { console.error("Błąd parsowania danych z localStorage:", e), selectedPriceChanges = [] } else selectedPriceChanges = []; const n = document.getElementById("priceContainer"), a = document.getElementById("productSearch").value.trim(), i = document.getElementById("storeSearch").value.trim(); n.innerHTML = ""; const r = (I - 1) * M, m = I * M; function u(e, t, n) { e.classList.add("active"), e.style.backgroundColor = "#333333", e.style.color = "#f5f5f5", e.textContent = "Dodano |"; const a = document.createElement("span"); a.innerHTML = " <i class='fa fa-trash' style='font-size:14px; display:flex; color:white; margin-left:4px; margin-top:3px;'></i>", a.style.textDecoration = "none", a.style.cursor = "pointer", a.addEventListener("click", (function (n) { n.stopPropagation(), e.classList.remove("active"), e.style.backgroundColor = "", e.style.color = "", e.textContent = "Zmień cenę", t.classList.remove("price-changed"); const a = t ? t.dataset.productId : null, o = new CustomEvent("priceBoxChangeRemove", { detail: { productId: a } }); document.dispatchEvent(o) })), e.appendChild(a), t.classList.add("price-changed") } function p(e, t, n, a, o, i, r) { const c = l.useEanForSimulation, s = c ? r.ean : r.externalId, d = c ? "EAN" : "ID"; if (!s || "" === s.toString().trim()) return e.disabled = !0, void (e.title = `Produkt musi mieć zmapowany ${d}`); e.addEventListener("click", (function (c) { if (c.stopPropagation(), l.useMarginForSimulation) { if (null == r.marginPrice) return void C('<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                     <p>Symulacja cenowa z marżą jest włączona – produkt musi posiadać cenę zakupu.</p>'); let e = (i - r.marginPrice) / r.marginPrice * 100, n = (t - r.marginPrice) / r.marginPrice * 100; if (e = parseFloat(e.toFixed(2)), n = parseFloat(n.toFixed(2)), l.enforceMinimalMargin) { if (n < 0 && !(e < 0 && n > e)) return void C(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                             <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> spowoduje ujemną marżę (nowa marża: <strong>${n}%</strong>).</p>\n                             <p>Cena zakupu wynosi <strong>${r.marginPrice.toFixed(2)} PLN</strong>. Zmiana nie może zostać zastosowana.</p>`); if (l.minimalMarginPercent > 0 && n < l.minimalMarginPercent) return void C(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> obniży marżę poniżej ustalonego minimum (<strong>${l.minimalMarginPercent}%</strong>).</p>\n                         <p>Nowa marża wynosi <strong>${n}%</strong>, a cena zakupu to <strong>${r.marginPrice.toFixed(2)} PLN</strong>.</p>`); if (l.minimalMarginPercent < 0 && n > l.minimalMarginPercent) return void C(`<p style="margin:8px 0; font-weight:bold;">Zmiana ceny nie została dodana</p>\n                         <p>Nowa cena <strong>${t.toFixed(2)} PLN</strong> podniesie marżę powyżej dozwolonego poziomu (<strong>${l.minimalMarginPercent}%</strong>).</p>\n                         <p>Nowa marża wynosi <strong>${n}%</strong>.</p>`) } } if (n.classList.contains("price-changed") || e.classList.contains("active")) return void console.log("Zmiana ceny już aktywna dla produktu", a); const s = new CustomEvent("priceBoxChange", { detail: { productId: a, productName: o, currentPrice: i, newPrice: t, storeId: storeId } }); document.dispatchEvent(s), u(e, n); let d = '<p style="margin-bottom:8px; font-size:16px; font-weight:bold;">Zmiana ceny dodana</p>'; if (d += `<p style="margin:4px 0;"><strong>Produkt:</strong> ${o}</p>`, d += `<p style="margin:4px 0;"><strong>Nowa cena:</strong> ${t.toFixed(2)} PLN</p>`, l.useMarginForSimulation) { let e = (t - r.marginPrice) / r.marginPrice * 100; e = parseFloat(e.toFixed(2)), d += `<p style="margin:4px 0;"><strong>Nowa marża:</strong> ${e}%</p>`, d += `<p style="margin:4px 0;"><strong>Cena zakupu:</strong> ${r.marginPrice.toFixed(2)} PLN</p>`, l.enforceMinimalMargin && (l.minimalMarginPercent > 0 ? d += `<p style="margin:4px 0;"><strong>Minimalna wymagana marża:</strong> ${l.minimalMarginPercent}%</p>` : l.minimalMarginPercent < 0 && (d += `<p style="margin:4px 0;"><strong>Maksymalne obniżenie marży:</strong> ${l.minimalMarginPercent}%</p>`)) } x(d) })); selectedPriceChanges.find((e => parseInt(e.productId) === parseInt(a) && parseFloat(e.newPrice) === parseFloat(t))) && u(e, n) } e.slice(r, m).forEach((e => { const t = e.isRejected, r = _(e.productName, a), m = _(e.storeName, i), u = "1" === e.isBidding, g = Z(e.delivery); let f = null, h = null, y = null, P = null, L = null, v = null, E = null, x = "", I = "", M = null, N = null, w = null, b = null; t || (f = null != e.percentageDifference ? e.percentageDifference.toFixed(2) : "N/A", h = null != e.priceDifference ? e.priceDifference.toFixed(2) : "N/A", y = null != e.savings ? e.savings.toFixed(2) : "N/A", P = "1" === e.myIsBidding, L = Z(e.myDelivery), v = e.marginAmount, E = e.marginPercentage, x = e.marginSign, I = e.marginClass, M = e.marginPrice, N = null != e.myPrice ? parseFloat(e.myPrice) : null, w = e.myPosition, b = null != e.lowestPrice ? parseFloat(e.lowestPrice) : null); const F = document.createElement("div"); F.className = "price-box " + e.colorClass, F.dataset.detailsUrl = "/PriceHistory/Details?scrapId=" + e.scrapId + "&productId=" + e.productId, F.dataset.productId = e.productId, F.dataset.productName = e.productName, F.addEventListener("click", (function () { window.open(this.dataset.detailsUrl, "_blank") })); const k = document.createElement("div"); k.className = "price-box-space"; const S = document.createElement("div"); S.className = "price-box-column-name", S.innerHTML = r; const B = document.createElement("div"); B.className = "price-box-column-category"; const D = l.useEanForSimulation, T = document.createElement("span"); if (T.className = "ApiBox", D) if (e.ean && "" !== e.ean.trim()) { const t = _(e.ean, a, "highlighted-text-yellow"); T.innerHTML = "EAN " + t } else T.innerHTML = "Brak EAN"; else if (e.externalId) { const t = _(e.externalId.toString(), a, "highlighted-text-yellow"); T.innerHTML = "ID " + t } else T.innerHTML = "Brak ID"; B.appendChild(T); const A = ne(e), H = document.createElement("button"); H.className = "assign-flag-button", H.dataset.productId = e.productId, H.innerHTML = "+ Przypisz flagi", H.style.pointerEvents = "auto", H.addEventListener("click", (function (e) { e.stopPropagation(), d = this.dataset.productId, te.style.display = "block", fetch(`/ProductFlags/GetFlagsForProduct?productId=${d}`).then((e => e.json())).then((e => { document.querySelectorAll(".flagCheckbox").forEach((t => { t.checked = e.includes(parseInt(t.value)) })) })).catch((e => console.error("Błąd pobierania flag dla produktu:", e))) })), k.appendChild(S), k.appendChild(A), k.appendChild(H), k.appendChild(B); const z = document.createElement("div"); z.className = "price-box-externalInfo"; const $ = document.createElement("div"); if ($.className = "price-box-column-offers", $.innerHTML = (e.sourceGoogle || e.sourceCeneo ? '<span class="data-channel">' + (e.sourceGoogle ? '<img src="/images/GoogleShopping.png" alt="Google Icon" style="width:15px; height:15px;" />' : "") + (e.sourceCeneo ? '<img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:15px; height:15px;" />' : "") + "</span>" : "") + '<div class="offer-count-box">' + e.storeCount + " Ofert</div>", z.appendChild($), null != M) { const e = M.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = document.createElement("div"); if (t.className = "price-box-diff-margin " + I, t.innerHTML = "<p>Cena zakupu: " + e + "</p>", z.appendChild(t), null != N) { const e = x + Math.abs(v).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", t = "(" + x + Math.abs(E).toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", n = document.createElement("div"); n.className = "price-box-diff-margin " + I, n.innerHTML = "<p>Marża: " + e + " " + t + "</p>", z.appendChild(n) } } k.appendChild(z); const R = document.createElement("div"); R.className = "price-box-data"; const j = document.createElement("div"); j.className = "color-bar " + e.colorClass; const q = document.createElement("div"); q.className = "price-box-column"; const O = document.createElement("div"); O.className = "price-box-column-text"; const U = document.createElement("div"); U.style.display = "flex"; const G = document.createElement("div"); if (G.style.fontWeight = "500", G.style.fontSize = "17px", G.textContent = e.lowestPrice.toFixed(2) + " PLN", U.appendChild(G), void 0 !== e.externalBestPriceCount && null !== e.externalBestPriceCount) if (1 === e.externalBestPriceCount) { const e = document.createElement("div"); e.className = "uniqueBestPriceBox", e.textContent = "★ TOP", e.style.marginLeft = "8px", U.appendChild(e) } else if (e.externalBestPriceCount > 1) { const t = document.createElement("div"); t.className = "shareBestPriceBox", t.textContent = e.externalBestPriceCount + " TOP", t.style.marginLeft = "8px", U.appendChild(t) } if (null !== e.singleBestCheaperDiffPerc && void 0 !== e.singleBestCheaperDiffPerc) { const t = document.createElement("div"); t.style.marginLeft = "4px", t.className = e.singleBestCheaperDiffPerc > 25 ? "singlePriceDiffBoxHigh" : "singlePriceDiffBox"; const n = document.createElement("span"); n.textContent = e.singleBestCheaperDiffPerc.toFixed(2) + "%", t.appendChild(n), U.appendChild(t) } O.appendChild(U); const W = document.createElement("div"); W.innerHTML = m, O.appendChild(W); const J = document.createElement("div"); J.className = "price-box-column-text", J.innerHTML = (null != e.isGoogle ? '<span class="data-channel"><img src="' + (e.isGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== e.position ? e.isGoogle ? '<span class="Position-Google">Poz. Google ' + e.position + "</span>" : '<span class="Position">Poz. Ceneo ' + e.position + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (u ? '<span class="Bidding">Bid</span>' : "") + (null != e.delivery ? '<span class="' + g + '">Wysyłka w ' + (1 == e.delivery ? "1 dzień" : e.delivery + " dni") + "</span>" : ""), q.appendChild(O), q.appendChild(J); const K = document.createElement("div"); if (K.className = "price-box-column", t || null == N) { const e = document.createElement("div"); e.className = "price-box-column-text", e.innerHTML = '<span style="font-weight: 500;">Brak ceny</span><br>' + o, K.appendChild(e) } else { const t = document.createElement("div"); if (t.className = "price-box-column-text", null !== e.externalPrice) { const n = (e.externalPrice - N).toFixed(2), a = e.externalPrice < N, i = document.createElement("div"); i.style.display = "flex", i.style.justifyContent = "space-between", i.style.alignItems = "center"; const r = document.createElement("span"); r.style.fontWeight = "500", r.style.marginRight = "20px", r.textContent = o; const c = document.createElement("span"); c.style.fontWeight = "500"; const s = '<span class="' + (a ? "arrow-down" : "arrow-up") + '"></span>'; c.innerHTML = s + (a ? "-" : "+") + Math.abs(n) + " PLN ", i.appendChild(r), i.appendChild(c); const l = document.createElement("div"); l.style.display = "flex", l.style.justifyContent = "space-between", l.style.alignItems = "center"; const d = document.createElement("span"); d.style.fontWeight = "500", d.style.textDecoration = "line-through", d.style.marginRight = "10px", d.textContent = N.toFixed(2) + " PLN"; const m = document.createElement("span"); m.style.fontWeight = "500", m.textContent = e.externalPrice.toFixed(2) + " PLN", l.appendChild(d), l.appendChild(m), t.appendChild(l), t.appendChild(i) } else t.innerHTML = '<span style="font-weight: 500; font-size:17px;">' + N.toFixed(2) + " PLN</span><br>" + o; const n = document.createElement("div"); n.className = "price-box-column-text", n.innerHTML = (null != e.myIsGoogle ? '<span class="data-channel"><img src="' + (e.myIsGoogle ? "/images/GoogleShopping.png" : "/images/Ceneo.png") + '" alt="Channel Icon" style="width:20px; height:20px; margin-right:4px;" /></div>' : "") + (null !== w ? e.myIsGoogle ? '<span class="Position-Google">Poz. Google ' + w + "</span>" : '<span class="Position">Poz. Ceneo ' + w + "</span>" : '<span class="Position" style="background-color: #414141;">Schowany</span>') + (P ? '<span class="Bidding">Bid</span>' : "") + (null != e.myDelivery ? '<span class="' + L + '">Wysyłka w ' + (1 == e.myDelivery ? "1 dzień" : e.myDelivery + " dni") + "</span>" : ""), K.appendChild(t), K.appendChild(n) } const V = document.createElement("div"); V.className = "price-box-column-action", V.innerHTML = ""; const Q = l.useEanForSimulation ? e.ean : e.externalId, X = l.useEanForSimulation ? "kod EAN" : "ID"; if (t) V.innerHTML += '<div class="rejected-product">Produkt odrzucony</div>'; else if ("prOnlyMe" === e.colorClass) { const t = e.colorClass + " priceBox-diff-top"; V.innerHTML += '<div class="' + t + '">Brak ofert konkurencji</div>' } else if ("prToLow" === e.colorClass || "prIdeal" === e.colorClass) if (null != N && null != y) { const t = parseFloat(y.replace(",", ".")), n = "prToLow" === e.colorClass ? "arrow-up-black" : "arrow-up-turquoise", a = N + t, o = t / N * 100; let i, r, l, d = n; if (s) t < 1 ? (i = a - c, r = i - N, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) : (i = a - c, r = t - c, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")); else { const e = c / 100; t < 1 ? (i = a * (1 - e), r = i - N, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) : (i = a * (1 - e), r = t - N * e, l = r / N * 100, r < 0 && (d = "arrow-down-turquoise")) } const m = (t >= 0 ? "+" : "") + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(" + (o >= 0 ? "+" : "") + o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", f = (r >= 0 ? "+" : "") + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", h = "(" + (l >= 0 ? "+" : "") + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", P = i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", L = document.createElement("div"); L.className = "price-box-column"; const v = document.createElement("div"); v.className = "price-action-line"; const E = document.createElement("span"); E.className = n; const x = document.createElement("span"); x.innerHTML = m + " " + u; const I = document.createElement("div"); I.innerHTML = "= " + g; const M = document.createElement("span"); M.className = "color-square-green", v.appendChild(E), v.appendChild(x), v.appendChild(I), v.appendChild(M); const w = document.createElement("button"); w.className = "simulate-change-btn", w.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(w, a, F, e.productId, e.productName, N, e) : w.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), v.appendChild(w), L.appendChild(v); const b = document.createElement("div"); b.className = "price-box-column"; const k = document.createElement("div"); k.className = "price-action-line"; const S = document.createElement("span"); S.className = d; const B = document.createElement("span"); B.innerHTML = f + " " + h; const D = document.createElement("div"); D.innerHTML = "= " + P; const T = document.createElement("span"); T.className = "color-square-turquoise", k.appendChild(S), k.appendChild(B), k.appendChild(D), k.appendChild(T); const A = document.createElement("button"); A.className = "simulate-change-btn", A.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(A, i, F, e.productId, e.productName, N, e) : A.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), k.appendChild(A), b.appendChild(k), V.appendChild(L), V.appendChild(b) } else { const t = e.colorClass + " priceBox-diff"; V.innerHTML += '<div class="' + t + '">Podnieś: N/A</div>' } else if ("prMid" === e.colorClass) if (null != N && null != b) { const t = N - b, n = t / N * 100; let a; a = s ? b - c : b * (1 - c / 100); const o = N - a, i = o / N * 100, r = t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", l = "(-" + n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", d = b.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(-" + i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", f = document.createElement("div"); f.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line"; const y = document.createElement("span"); y.className = "arrow-down-yellow"; const P = document.createElement("span"); P.innerHTML = "-" + r + " " + l; const L = document.createElement("div"); L.innerHTML = "= " + d; const v = document.createElement("span"); v.className = "color-square-green", h.appendChild(y), h.appendChild(P), h.appendChild(L), h.appendChild(v); const E = document.createElement("button"); E.className = "simulate-change-btn", E.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(E, b, F, e.productId, e.productName, N, e) : E.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), h.appendChild(E), f.appendChild(h); const x = document.createElement("div"); x.className = "price-box-column"; const I = document.createElement("div"); I.className = "price-action-line"; const M = document.createElement("span"); M.className = "arrow-down-yellow"; const w = document.createElement("span"); w.innerHTML = "-" + m + " " + u; const k = document.createElement("div"); k.innerHTML = "= " + g; const S = document.createElement("span"); S.className = "color-square-turquoise", I.appendChild(M), I.appendChild(w), I.appendChild(k), I.appendChild(S); const B = document.createElement("button"); B.className = "simulate-change-btn", B.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(B, a, F, e.productId, e.productName, N, e) : B.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), I.appendChild(B), x.appendChild(I), V.appendChild(f), V.appendChild(x) } else { const t = e.colorClass + " priceBox-diff"; V.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prToHigh" === e.colorClass) if (null != N && null != b) { const t = N - b, n = t / N * 100; let a; a = s ? b - c : b * (1 - c / 100); const o = N - a, i = o / N * 100, r = t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", l = "(-" + n.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", d = b.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = o.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", u = "(-" + i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", g = a.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", f = document.createElement("div"); f.className = "price-box-column"; const h = document.createElement("div"); h.className = "price-action-line"; const y = document.createElement("span"); y.className = "arrow-down-red"; const P = document.createElement("span"); P.innerHTML = "-" + r + " " + l; const L = document.createElement("div"); L.innerHTML = "= " + d; const v = document.createElement("span"); v.className = "color-square-green", h.appendChild(y), h.appendChild(P), h.appendChild(L), h.appendChild(v); const E = document.createElement("button"); E.className = "simulate-change-btn", E.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(E, b, F, e.productId, e.productName, N, e) : E.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), h.appendChild(E), f.appendChild(h); const x = document.createElement("div"); x.className = "price-box-column"; const I = document.createElement("div"); I.className = "price-action-line"; const M = document.createElement("span"); M.className = "arrow-down-red"; const w = document.createElement("span"); w.innerHTML = "-" + m + " " + u; const k = document.createElement("div"); k.innerHTML = "= " + g; const S = document.createElement("span"); S.className = "color-square-turquoise", I.appendChild(M), I.appendChild(w), I.appendChild(k), I.appendChild(S); const B = document.createElement("button"); B.className = "simulate-change-btn", B.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(B, a, F, e.productId, e.productName, N, e) : B.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), I.appendChild(B), x.appendChild(I), V.appendChild(f), V.appendChild(x) } else { const t = e.colorClass + " priceBox-diff"; V.innerHTML += '<div class="' + t + '">Obniż: N/A</div>' } else if ("prGood" === e.colorClass) if (null != N) { const t = N, n = "+0,00 PLN", a = "(+0,00%)", o = "= " + t.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN"; let i, r, l, d, m, u, g, f; if (1 === e.storeCount) i = 0, r = 0, l = N, d = "+0,00 PLN", m = "(+0,00%)", u = "= " + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", g = "no-change-icon-turquoise", f = "color-square-turquoise"; else { if (s) i = -c, l = N + i, r = i / N * 100; else { i = -N * (c / 100), Math.abs(i) < .01 && (i = -.01), l = N + i, r = i / N * 100 } d = (i >= 0 ? "+" : "") + i.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", m = "(" + (r >= 0 ? "+" : "") + r.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%)", u = "= " + l.toLocaleString("pl-PL", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " PLN", g = "arrow-down-green", f = "color-square-turquoise" } const h = document.createElement("div"); h.className = "price-box-column"; const y = document.createElement("div"); y.className = "price-action-line"; const P = document.createElement("span"); P.className = "no-change-icon"; const L = document.createElement("span"); L.innerHTML = n + " " + a; const v = document.createElement("div"); v.innerHTML = o; const E = document.createElement("span"); E.className = "color-square-green", y.appendChild(P), y.appendChild(L), y.appendChild(v), y.appendChild(E); const x = document.createElement("button"); x.className = "simulate-change-btn", x.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(x, t, F, e.productId, e.productName, N, e) : x.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), y.appendChild(x), h.appendChild(y); const I = document.createElement("div"); I.className = "price-box-column"; const M = document.createElement("div"); M.className = "price-action-line"; const w = document.createElement("span"); w.className = g; const b = document.createElement("span"); b.innerHTML = d + " " + m; const k = document.createElement("div"); k.innerHTML = u; const S = document.createElement("span"); S.className = f, M.appendChild(w), M.appendChild(b), M.appendChild(k), M.appendChild(S); const B = document.createElement("button"); B.className = "simulate-change-btn", B.textContent = "Zmień cenę", Q && "" !== Q.toString().trim() ? p(B, l, F, e.productId, e.productName, N, e) : B.addEventListener("click", (function (e) { e.preventDefault(), e.stopPropagation(), C(`Produkt musi mieć zmapowany ${X}`) })), M.appendChild(B), I.appendChild(M), V.appendChild(h), V.appendChild(I) } else { const t = e.colorClass + " priceBox-diff-top"; V.innerHTML += '<div class="' + t + '">Jesteś w najlepszych cenach</div>' } else V.innerHTML += '<div class="rejected-product">Produkt odrzucony</div>'; if (R.appendChild(j), e.imgUrl) { const t = document.createElement("img"); t.dataset.src = e.imgUrl, t.alt = e.productName, t.className = "lazy-load", t.style.width = "114px", t.style.height = "114px", t.style.marginRight = "5px", t.style.marginLeft = "5px", t.style.backgroundColor = "#ffffff", t.style.border = "1px solid #e3e3e3", t.style.borderRadius = "4px", t.style.padding = "10px", t.style.display = "block", R.appendChild(t) } R.appendChild(q), R.appendChild(K), R.appendChild(V), F.appendChild(k), F.appendChild(B), F.appendChild(z), F.appendChild(R), n.appendChild(F) })), function (e) { const t = Math.ceil(e / M), n = document.getElementById("paginationContainer"); n.innerHTML = ""; const a = document.createElement("button"); a.innerHTML = '<i class="fa fa-chevron-circle-left" aria-hidden="true"></i>', a.disabled = 1 === I, a.addEventListener("click", (() => { I > 1 && (I--, J(!1)) })), n.appendChild(a); for (let e = 1; e <= t; e++) { const t = document.createElement("button"); t.textContent = e, e === I && t.classList.add("active"), t.addEventListener("click", (() => { I = e, J(!1) })), n.appendChild(t) } const o = document.createElement("button"); o.innerHTML = '<i class="fa fa-chevron-circle-right" aria-hidden="true"></i>', o.disabled = I === t, o.addEventListener("click", (() => { I < t && (I++, J(!1)) })), n.appendChild(o) }(e.length); const g = document.querySelectorAll(".lazy-load"), f = new Map, h = new IntersectionObserver(((e, t) => { e.forEach((e => { const n = e.target, a = [...g].indexOf(n); if (e.isIntersecting) { const e = setTimeout((() => { !function (e) { const t = 6, n = Math.max(0, e - t), a = Math.min(g.length - 1, e + t); for (let e = n; e <= a; e++) { const t = g[e]; t.src || (t.src = t.dataset.src, t.onload = () => { t.classList.add("loaded") }) } }(a), t.unobserve(n), f.delete(n) }), 100); f.set(n, e) } else f.has(n) && (clearTimeout(f.get(n)), f.delete(n)) })) }), { root: null, rootMargin: "50px", threshold: .01 }); g.forEach((e => { h.observe(e) })), document.getElementById("displayedProductCount").textContent = e.length } function Z(e) { return e <= 1 ? "Availability1Day" : e <= 3 ? "Availability3Days" : e <= 7 ? "Availability7Days" : "Availability14Days" } D.addEventListener("change", (function () { s = this.checked, z(s) })); const G = N((function (e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { e.isRejected || (t[e.colorClass] = (t[e.colorClass] || 0) + 1) })); const n = [t.prOnlyMe, t.prToHigh, t.prMid, t.prGood, t.prIdeal, t.prToLow]; if (a) a.data.datasets[0].data = n, a.update(); else { const e = document.getElementById("colorChart").getContext("2d"); a = new Chart(e, { type: "doughnut", data: { labels: ["Solo", "Zawyżona", "Suboptymalna", "Konkurencyjna", "Strategiczna", "Zaniżona"], datasets: [{ data: n, backgroundColor: ["rgba(180, 180, 180, 0.8)", "rgba(171, 37, 32, 0.8)", "rgba(224, 168, 66, 0.8)", "rgba(117, 152, 112, 0.8)", "rgba(13, 110, 253, 0.8)", "rgba(6, 6, 6, 0.8)"], borderColor: ["rgba(180, 180, 180, 1)", "rgba(171, 37, 32, 1)", "rgba(224, 168, 66, 1)", "rgba(117, 152, 112, 1)", "rgba(13, 110, 253, 1)", "rgba(6, 6, 6, 1)"], borderWidth: 1 }] }, options: { aspectRatio: 1, cutout: "60%", plugins: { legend: { display: !1 }, tooltip: { callbacks: { label: function (e) { return "Produkty: " + e.parsed } } } } } }) } }), 600); function W(e) { const t = { prOnlyMe: 0, prToHigh: 0, prMid: 0, prGood: 0, prIdeal: 0, prToLow: 0 }; e.forEach((e => { t[e.colorClass] = (t[e.colorClass] || 0) + 1 })), document.querySelector('label[for="prOnlyMeCheckbox"]').textContent = `Solo (${t.prOnlyMe})`, document.querySelector('label[for="prToHighCheckbox"]').textContent = `Zawyżona (${t.prToHigh})`, document.querySelector('label[for="prMidCheckbox"]').textContent = `Suboptymalna (${t.prMid})`, document.querySelector('label[for="prGoodCheckbox"]').textContent = `Konkurencyjna (${t.prGood})`, document.querySelector('label[for="prIdealCheckbox"]').textContent = `Strategiczna (${t.prIdeal})`, document.querySelector('label[for="prToLowCheckbox"]').textContent = `Zaniżona (${t.prToLow})` } function J(e = !0) { e && (I = 1, window.scrollTo(0, 0)), ae(), setTimeout((() => { let e = [...n]; const t = document.getElementById("productSearch").value.trim(), a = document.getElementById("storeSearch").value.trim(); if (t) { const n = t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => { let t; t = l.useEanForSimulation ? e.ean || "" : e.externalId ? e.externalId.toString() : ""; return ((e.productName || "") + " " + t).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(n) })) } if (a) { const t = a.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, ""); e = e.filter((e => (e.storeName || "").toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, "").includes(t))) } const o = t ? t.replace(/[^a-zA-Z0-9\s.-]/g, "").toLowerCase().replace(/\s+/g, "") : ""; "" !== o && e.sort(((e, t) => { const n = ((e.productName || "") + " " + (e.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), a = ((t.productName || "") + " " + (t.ean || "")).toLowerCase().replace(/[^a-zA-Z0-9\s.-]/g, "").replace(/\s+/g, ""), i = Q(n, o), r = Q(a, o); if (i !== r) return i - r; const c = X(n, o), s = X(a, o); return c !== s ? s - c : e.productName.localeCompare(t.productName) })), e = q(e), e = p.showRejected ? e.filter((e => e.isRejected)) : e.filter((e => !e.isRejected)), null !== p.sortName ? "asc" === p.sortName ? e.sort(((e, t) => e.productName.localeCompare(t.productName))) : e.sort(((e, t) => t.productName.localeCompare(e.productName))) : null !== p.sortPrice ? "asc" === p.sortPrice ? e.sort(((e, t) => e.lowestPrice - t.lowestPrice)) : e.sort(((e, t) => t.lowestPrice - e.lowestPrice)) : null !== p.sortRaiseAmount ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === p.sortRaiseAmount ? e.sort(((e, t) => e.savings - t.savings)) : e.sort(((e, t) => t.savings - e.savings))) : null !== p.sortRaisePercentage ? (e = e.filter((e => !e.isRejected && null !== e.savings)), "asc" === p.sortRaisePercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== p.sortLowerAmount ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === p.sortLowerAmount ? e.sort(((e, t) => e.priceDifference - t.priceDifference)) : e.sort(((e, t) => t.priceDifference - e.priceDifference))) : null !== p.sortLowerPercentage ? (e = e.filter((e => !e.isRejected && null === e.savings && 0 !== e.priceDifference)), "asc" === p.sortLowerPercentage ? e.sort(((e, t) => e.percentageDifference - t.percentageDifference)) : e.sort(((e, t) => t.percentageDifference - e.percentageDifference))) : null !== p.sortMarginAmount ? (e = e.filter((e => null !== e.marginAmount)), "asc" === p.sortMarginAmount ? e.sort(((e, t) => e.marginAmount - t.marginAmount)) : e.sort(((e, t) => t.marginAmount - e.marginAmount))) : null !== p.sortMarginPercentage && (e = e.filter((e => null !== e.marginPercentage)), "asc" === p.sortMarginPercentage ? e.sort(((e, t) => e.marginPercentage - t.marginPercentage)) : e.sort(((e, t) => t.marginPercentage - e.marginPercentage))); const i = document.getElementById("producerFilterDropdown").value; i && (e = e.filter((e => e.producer === i))), U(e), G(e), W(e), j(e), oe() }), 0) } function _(e, t, n) { if (!t) return e; const a = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), o = new RegExp(a, "gi"), i = n || "highlighted-text"; return e.replace(o, (e => `<span class="${i}">${e}</span>`)) } function K(e) { for (let t in p) if (t !== e) if ("showRejected" === t) { p[t] = !1; let e = document.getElementById("showRejectedButton"); e && e.classList.remove("active") } else { p[t] = null; let e = document.getElementById(t); e && (e.innerHTML = V(t), e.classList.remove("active")) } } function V(e) { switch (e) { case "sortName": return "A-Z"; case "sortPrice": return "Cena"; case "sortRaiseAmount": return "Podnieś PLN"; case "sortRaisePercentage": return "Podnieś %"; case "sortLowerAmount": return "Obniż PLN"; case "sortLowerPercentage": return "Obniż %"; case "sortMarginAmount": return "Marża PLN"; case "sortMarginPercentage": return "Marża %"; case "showRejected": return "Pokaż Odrzucone"; default: return "" } } function Q(e, t) { return e.indexOf(t) } function X(e, t) { let n = 0; for (let a = 0; a < e.length; a++)for (let o = a; o <= e.length; o++) { const i = e.slice(a, o); t.includes(i) && i.length > n && (n = i.length) } return n } document.getElementById("openMarginSettingsBtn").addEventListener("click", (function () { document.getElementById("useEanForSimulationInput").value = l.useEanForSimulation.toString(), document.getElementById("useMarginForSimulationInput").value = l.useMarginForSimulation.toString(), document.getElementById("enforceMinimalMarginInput").value = l.enforceMinimalMargin.toString(), document.getElementById("minimalMarginPercentInput").value = l.minimalMarginPercent, $("#marginSettingsModal").modal("show") })), document.getElementById("saveMarginSettingsBtn").addEventListener("click", (function () { const e = { StoreId: storeId, useEanForSimulation: "true" === document.getElementById("useEanForSimulationInput").value, UseMarginForSimulation: "true" === document.getElementById("useMarginForSimulationInput").value, EnforceMinimalMargin: "true" === document.getElementById("enforceMinimalMarginInput").value, MinimalMarginPercent: parseFloat(document.getElementById("minimalMarginPercentInput").value) }; fetch("/PriceHistory/SaveMarginSettings", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }).then((e => e.json())).then((t => { t.success ? (l = e, $("#marginSettingsModal").modal("hide"), R()) : alert("Błąd zapisu ustawień: " + t.message) })).catch((e => console.error("Błąd zapisu ustawień marży:", e))) })), document.getElementById("showRejectedButton").addEventListener("click", (function () { p.showRejected = !p.showRejected, p.showRejected ? this.classList.add("active") : this.classList.remove("active"), K("showRejected"), J() })); const Y = N((function () { J() }), 300); document.getElementById("productSearch").addEventListener("input", Y), document.querySelectorAll(".colorFilter, .flagFilter, .positionFilter, .deliveryFilterMyStore, .deliveryFilterCompetitor, .externalPriceFilter").forEach((function (e) { e.addEventListener("change", (function () { ae(), J() })) })), document.getElementById("bidFilter").addEventListener("change", (function () { J() })), document.getElementById("suspiciouslyLowFilter").addEventListener("change", (function () { J() })), document.getElementById("sortName").addEventListener("click", (function () { null === p.sortName ? (p.sortName = "asc", this.innerHTML = "A-Z ↑", this.classList.add("active")) : "asc" === p.sortName ? (p.sortName = "desc", this.innerHTML = "A-Z ↓", this.classList.add("active")) : (p.sortName = null, this.innerHTML = "A-Z", this.classList.remove("active")), K("sortName"), J() })), document.getElementById("sortPrice").addEventListener("click", (function () { null === p.sortPrice ? (p.sortPrice = "asc", this.innerHTML = "Cena ↑", this.classList.add("active")) : "asc" === p.sortPrice ? (p.sortPrice = "desc", this.innerHTML = "Cena ↓", this.classList.add("active")) : (p.sortPrice = null, this.innerHTML = "Cena", this.classList.remove("active")), K("sortPrice"), J() })), document.getElementById("sortRaiseAmount").addEventListener("click", (function () { null === p.sortRaiseAmount ? (p.sortRaiseAmount = "asc", this.innerHTML = "Podnieś PLN ↑", this.classList.add("active")) : "asc" === p.sortRaiseAmount ? (p.sortRaiseAmount = "desc", this.innerHTML = "Podnieś PLN ↓", this.classList.add("active")) : (p.sortRaiseAmount = null, this.innerHTML = "Podnieś PLN", this.classList.remove("active")), K("sortRaiseAmount"), J() })), document.getElementById("sortRaisePercentage").addEventListener("click", (function () { null === p.sortRaisePercentage ? (p.sortRaisePercentage = "asc", this.innerHTML = "Podnieś % ↑", this.classList.add("active")) : "asc" === p.sortRaisePercentage ? (p.sortRaisePercentage = "desc", this.innerHTML = "Podnieś % ↓", this.classList.add("active")) : (p.sortRaisePercentage = null, this.innerHTML = "Podnieś %", this.classList.remove("active")), K("sortRaisePercentage"), J() })), document.getElementById("sortLowerAmount").addEventListener("click", (function () { null === p.sortLowerAmount ? (p.sortLowerAmount = "asc", this.innerHTML = "Obniż PLN ↑", this.classList.add("active")) : "asc" === p.sortLowerAmount ? (p.sortLowerAmount = "desc", this.innerHTML = "Obniż PLN ↓", this.classList.add("active")) : (p.sortLowerAmount = null, this.innerHTML = "Obniż PLN", this.classList.remove("active")), K("sortLowerAmount"), J() })), document.getElementById("sortLowerPercentage").addEventListener("click", (function () { null === p.sortLowerPercentage ? (p.sortLowerPercentage = "asc", this.innerHTML = "Obniż % ↑", this.classList.add("active")) : "asc" === p.sortLowerPercentage ? (p.sortLowerPercentage = "desc", this.innerHTML = "Obniż % ↓", this.classList.add("active")) : (p.sortLowerPercentage = null, this.innerHTML = "Obniż %", this.classList.remove("active")), K("sortLowerPercentage"), J() })), document.getElementById("sortMarginAmount").addEventListener("click", (function () { null === p.sortMarginAmount ? (p.sortMarginAmount = "asc", this.innerHTML = "Marża PLN ↑", this.classList.add("active")) : "asc" === p.sortMarginAmount ? (p.sortMarginAmount = "desc", this.innerHTML = "Marża PLN ↓", this.classList.add("active")) : (p.sortMarginAmount = null, this.innerHTML = "Marża PLN", this.classList.remove("active")), K("sortMarginAmount"), J() })), document.getElementById("sortMarginPercentage").addEventListener("click", (function () { null === p.sortMarginPercentage ? (p.sortMarginPercentage = "asc", this.innerHTML = "Marża % ↑", this.classList.add("active")) : "asc" === p.sortMarginPercentage ? (p.sortMarginPercentage = "desc", this.innerHTML = "Marża % ↓", this.classList.add("active")) : (p.sortMarginPercentage = null, this.innerHTML = "Marża %", this.classList.remove("active")), K("sortMarginPercentage"), J() })), document.getElementById("usePriceDifference").addEventListener("change", (function () { s = this.checked, z(s) })), document.getElementById("storeSearch").addEventListener("input", Y), document.getElementById("price1").addEventListener("input", (function () { i = parseFloat(this.value) })), document.getElementById("price2").addEventListener("input", (function () { r = parseFloat(this.value) })), document.getElementById("stepPrice").addEventListener("input", (function () { c = parseFloat(this.value) })), document.getElementById("productSearch").addEventListener("input", (function () { I = 1, window.scrollTo(0, 0), Y() })); const ee = document.getElementById("exportToExcelButton"); ee && ee.addEventListener("click", (function () { const e = new ExcelJS.Workbook, t = e.addWorksheet("Dane"); t.addRow(["ID", "Nazwa Produktu", "EAN", "Ilość ofert", "Najniższa Konkurencyjna Cena", "Twoja Cena"]); const a = { color: { argb: "FFAA0000" } }, o = { color: { argb: "FF006400" } }, i = { color: { argb: "FF7E7E7E" } }; n.forEach((e => { const n = [e.externalId || "", e.productName || "", e.ean || "", e.storeCount || "", e.lowestPrice || "", e.myPrice || ""], r = t.addRow(n), c = r.getCell(5), s = r.getCell(6), l = parseFloat(e.lowestPrice) || 0, d = parseFloat(e.myPrice) || 0; l > 0 && d > 0 ? d < l ? (c.font = a, s.font = o) : d > l ? (c.font = o, s.font = a) : (c.font = o, s.font = o) : (c.font = i, s.font = i) })), e.xlsx.writeBuffer().then((e => { const t = new Blob([e], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), n = `PriceSafari-${scrapDateJS}-${myStoreNameJS}.xlsx`, a = document.createElement("a"); a.href = URL.createObjectURL(t), a.download = n, a.click(), setTimeout((() => { URL.revokeObjectURL(a.href) }), 1e3) })) })), document.getElementById("savePriceValues").addEventListener("click", (function () { const e = parseFloat(document.getElementById("price1").value), t = parseFloat(document.getElementById("price2").value), n = parseFloat(document.getElementById("stepPrice").value), a = document.getElementById("usePriceDifference").checked, o = { StoreId: storeId, SetPrice1: e, SetPrice2: t, PriceStep: n, UsePriceDiff: a }; fetch("/PriceHistory/SavePriceValues", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(o) }).then((e => e.json())).then((o => { o.success ? (i = e, r = t, c = n, usePriceDifferenceGlobal = a, R()) : alert("Błąd zapisu wartości: " + o.message) })).catch((e => console.error("Błąd zapisu wartości:", e))) })); const te = document.getElementById("flagModal"); function ne(e) { const t = document.createElement("div"); return t.className = "flags-container", e.flagIds && e.flagIds.length > 0 && e.flagIds.forEach((function (e) { const n = flags.find((function (t) { return t.FlagId === e })); if (n) { const e = document.createElement("span"); e.className = "flag", e.style.color = n.FlagColor, e.style.border = "2px solid " + n.FlagColor, e.style.backgroundColor = function (e, t) { let n = 0, a = 0, o = 0; return 4 == e.length ? (n = parseInt(e[1] + e[1], 16), a = parseInt(e[2] + e[2], 16), o = parseInt(e[3] + e[3], 16)) : 7 == e.length && (n = parseInt(e[1] + e[2], 16), a = parseInt(e[3] + e[4], 16), o = parseInt(e[5] + e[6], 16)), `rgba(${n}, ${a}, ${o}, ${t})` }(n.FlagColor, .3), e.innerHTML = n.FlagName, t.appendChild(e) } })), t } function ae() { document.getElementById("loadingOverlay").style.display = "flex" } function oe() { document.getElementById("loadingOverlay").style.display = "none" } document.getElementsByClassName("close")[0].onclick = function () { te.style.display = "none" }, window.onclick = function (e) { e.target == te && (te.style.display = "none") }, document.getElementById("saveFlagsButton").addEventListener("click", (function () { const e = Array.from(document.querySelectorAll(".flagCheckbox:checked")).map((e => parseInt(e.value))), t = { productId: d, flagIds: e }; fetch("/ProductFlags/AssignFlagsToProduct", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) }).then((e => e.json())).then((e => { e.success ? (te.style.display = "none", fetch(`/ProductFlags/GetFlagsForProduct?productId=${d}`).then((e => e.json())).then((e => { const t = parseInt(d), a = n.find((e => e.productId === t)); a ? a.flagIds = e : console.error("Product not found in allPrices:", d), function (e) { const t = parseInt(e), a = document.querySelector(`.price-box[data-product-id='${e}']`); if (a) { const o = a.querySelector(".flags-container"), i = n.find((e => e.productId === t)); if (i) { const e = ne(i); o ? o.parentNode.replaceChild(e, o) : a.appendChild(e) } else console.error("Product not found in allPrices:", e) } }(d), j(n) })).catch((e => console.error("Error fetching updated flags for product:", e)))) : alert("Error assigning flags: " + e.message) })).catch((e => console.error("Error assigning flags:", e))) })), R() }));