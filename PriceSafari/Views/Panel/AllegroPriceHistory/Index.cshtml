@using PriceSafari.Models.ViewModels

@{
    ViewData["Title"] = "Historia Cen Allegro";
    var latestScrap = ViewBag.LatestScrap as PriceSafari.Models.AllegroScrapeHistory;
    var storeId = ViewBag.StoreId;
    var storeLogo = ViewBag.StoreLogo;
    var storeName = ViewBag.StoreName;
    var scrapDate = latestScrap?.Date.ToString("dd.MM.yyyy");
    var flags = ViewBag.Flags as List<FlagViewModel>;
}

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="Vert">
    <div class="Page-Box">
        <div class="Page-Box-Container">
            <div class="Page-Box-Category">
                <div><img src="@storeLogo" class="img-container" /></div>
                <div class="side-chart-box">
                    <canvas id="colorChart"></canvas>
                </div>
                <div class="store-section">
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prNoOfferCheckbox" value="prNoOffer"><label for="prNoOfferCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prOnlyMeCheckbox" value="prOnlyMe"><label for="prOnlyMeCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prToHighCheckbox" value="prToHigh"><label for="prToHighCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prMidCheckbox" value="prMid"><label for="prMidCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prGoodCheckbox" value="prGood"><label for="prGoodCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prIdealCheckbox" value="prIdeal"><label for="prIdealCheckbox"></label></div>
                    <div class="form-check"><input class="form-check-input colorFilter" type="checkbox" id="prToLowCheckbox" value="prToLow"><label for="prToLowCheckbox"></label></div>
                    <div class="price-range-settings">
                        <div class="color-circle prMid-circle"></div>
                        <div class="legendBox">Próg c. subopt.</div>
                        <label for="price2"></label>
                        <input type="number" id="price2" value="2.00" step="0.01" min="0.01">
                        <span id="unitLabel2" style="display:flex; align-items:center;">PLN</span>
                    </div>
                    <div class="price-range-settings">
                        <div class="color-circle prIdeal-circle"></div>
                        <div class="legendBox">Próg c. strateg.</div>
                        <label for="price1"></label>
                        <input type="number" id="price1" value="2.00" step="0.01" min="0.01">
                        <span id="unitLabel1" style="display:flex; align-items:center;">PLN</span>
                    </div>
                    <div class="price-range-settings">
                        <div class="price-range-settings-stepPrice"></div>
                        <div class="legendBox">
                            Krok cenowy
                            <div id="stepPriceIndicator" class="step-indicator"></div>
                        </div>
                        <label for="stepPrice"></label>
                        <input type="number" id="stepPrice" value="@ViewBag.StepPrice?.ToString("F2")" step="0.01"> <span id="unitLabelStepPrice" style="display:flex; align-items:center;"></span>
                    </div>
                    <div>
                        <input class="diffCheckBox" style="margin-top: 10px;" type="checkbox" id="usePriceDifference" checked />
                    </div>
                    <button class="Button-Page-Small" style="margin-top: 4px;" id="savePriceValues">Zapisz progi</button>
                </div>
                <div class="filterBox">
                    <div class="Category-Container-Select" style="margin-top:-2px;">Flagi <a asp-controller="Flags" asp-action="List" asp-route-storeId="@ViewBag.StoreId" class="link-line">+ Dodaj Flage</a></div>
                    <div class="store-section" id="flagContainer">
                    </div>
                </div>
            </div>
            <div class="Horizontal">
                <div class="order-upper-box">
                    <input type="text" id="productSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj produkt">
                    <input type="text" id="storeSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj sklep">
                    <select id="producerFilterDropdown" class="DropDown" style="max-width:150px; height:33.99px;">
                        <option value="">Wszystkie marki</option>
                    </select>

                    <button type="button" class="Button-Page-Small" style="white-space: nowrap; height:33.99px;" id="presetButton" onclick="openCompetitorsModal()">
                        Presety
                    </button>

                    <button type="button" class="Button-Page-Small" style="justify-self:flex-end; margin-right:4px; height:33.99px;" data-toggle="modal" data-target="#infoModal">
                        <i class="fa fa-info-circle"></i>
                    </button>

                    <div class="SimpleSpace" style="justify-content:flex-end; margin-left: auto;">
                        <div id="selectionContainer" class="selection-container">
                            <span id="selectedProductsCounter" class="ProductCount" style="width:126px; height:33.99px;">Wybrano: 0</span>
                            <button id="selectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Zaznacz wszystkie widoczne produkty">
                                <i class="fa-solid fa-square-check"></i>
                            </button>
                            <button id="deselectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Odznacz wszystkie widoczne produkty">
                                <i class="fa-solid fa-square-xmark"></i>
                            </button>
                            <button id="showSelectedProductsBtn" class="Button-Page-Small" style="width:89.25px;">Akcje</button>
                        </div>
                    </div>

               
                </div>
                <div id="sortingButtons">
                    <div class="ProductCount" id="displayedProductCount" style="width:120px;"></div>
                    <div id="paginationContainer"></div>
                    <button id="linkOffers">Katalog</button>
                    <button id="sortName">A-Z</button>
                    <button id="sortPrice">Cena</button>
                    <button id="sortRaiseAmount">Podnieś PLN</button>
                    <button id="sortRaisePercentage">Podnieś %</button>
                    <button id="sortLowerAmount">Obniż PLN</button>
                    <button id="sortLowerPercentage">Obniż %</button>
                </div>
                <div class="Vert-table">
                    <div id="priceContainer" class="price-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content" style="width:auto;">
            <div class="modal-header">
                <h5 class="modal-title">Informacje</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <p><strong>Wykonanie analizy:</strong> @scrapDate</p>
                <p><strong>Ilość produktów:</strong> <span id="totalProductCount">0</span></p>
                <p><strong>Ilość zebranych cen:</strong> <span id="totalPriceCount">0</span></p>
            </div>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display: none;"><div class="loader"></div></div>

<div id="flagModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="flagModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="flagModalLabel">Zarządzaj flagami</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="flagModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="Button-Page-Small-r" data-dismiss="modal">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="saveFlagsButton">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="selectedProductsModal" tabindex="-1" role="dialog" aria-labelledby="selectedProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content" style="margin: 10% auto; width:860px;">
            <div class="modal-header">
                <div class="price-box-column-name" id="selectedProductsModalLabel">
                    Zaznaczone produkty (<span id="selectedProductsModalCounter">0</span>)
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4 p-3" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1rem; color: #333;">Dostępne akcje masowe:</strong>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button id="openBulkFlagModalBtn" class="Button-Page-Small-bl">
                                <i class="fa-solid fa-tags" style="margin-right: 5px;"></i> Zarządzaj flagami
                            </button>
                        </div>
                    </div>
                </div>
                <div id="selectedProductsList" class="table-scroll" style="max-height: 45vh; min-height: 40vh; overflow-y: auto;"> </div>
            </div>
        </div>
    </div>
</div>

<div id="globalNotification" style="display: none; position: fixed; width: 500px; top: 30px; left: 50%; transform: translateX(-50%); background: #F65063; color: white; padding: 24px; text-align: left; border-radius: 10px; z-index: 10000;"></div>
<div id="globalUpdate" style="display: none; position: fixed; width: 500px; top: 30px; left: 50%; transform: translateX(-50%); background: #006400; color: white; padding: 24px; text-align: left; border-radius: 10px; z-index: 10000;"></div>


<div class="modal-sim fade" id="competitorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog-sim" role="document">
        <div class="modal-simulation">

            <div class="modal-header">
                <div class="price-box-column-name">Presety - Allegro</div>
                <div style="display:flex; gap:10px;">
                    <button id="addNewPresetBtn" class="Button-Page-Small-bl">Dodaj nowy preset</button>
                    <button type="button" class="close" data-dismiss="modal" style="width:33px; height:33px;" aria-label="Zamknij">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>

            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; gap:24px;">

                    <div style="display:flex; flex-direction:column;">
                        <select id="presetSelect" style="width:460px;" class="DropDown"></select>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; width:460px;">
                            <div>
                                <span id="activateButtonContainer"></span>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <span id="editButtonContainer"></span>
                                <span id="deleteButtonContainer"></span>
                            </div>
                        </div>

                        <div id="newPresetSection" style="display:none; margin-bottom: 20px;"></div>

                        <div style="display:flex; flex-direction:column; width:460px; border: 1px solid #EDEDED; padding:16px; border-radius:4px; margin-top:12px;">
                            <input type="text" id="competitorSearchInput" class="storeSearch" placeholder="Wyszukaj sprzedawcę" />

                            <div style="display:flex; justify-content:space-between; margin-top: 10px;">
                                <div>
                                    <div class="Category-Container-Select">Niezdefiniowani sprzedawcy</div>
                                    <div class="store-section">
                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="useUnmarkedStoresCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="useUnmarkedStoresCheckbox">Wyświetlaj</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; flex-direction:column; width:460px; margin-top:24px;">
                            <p style="margin-bottom:24px; font-size:15px;">
                                <strong>Presety Allegro filtrują widocznych sprzedawców.</strong><br><br>
                                Aktywny preset wpływa na widok główny. Jeśli wykluczysz sprzedawcę, który ma najniższą cenę, system wskaże kolejnego najtańszego jako punkt odniesienia.
                            </p>
                        </div>
                    </div>

                    <div style="flex: 1;">
                        <div class="table-scroll" style="max-height: 80vh; min-height: 80vh; overflow: auto;">
                            <table class="table-orders" style="width: 100%; min-width: 500px; white-space: nowrap; table-layout: auto;">
                                <thead>
                                    <tr>
                                        <th>
                                            <img src="/images/AllegroIcon.png" alt="Allegro Icon" style="width:17px; height:17px; margin-right:6px; margin-bottom:4px;">
                                            Sprzedawcy Allegro
                                        </th>
                                        <th>Wspólne produkty</th>
                                        <th>Akcje</th>
                                    </tr>
                                </thead>
                                <tbody id="allegroCompetitorsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
       
        const storeId = @storeId;
        const presetTypeContext = 1; 
        const scrapDateJS = "@scrapDate";
        const myStoreNameJS = "@storeName";
        const flags = @Html.Raw(Json.Serialize(ViewBag.Flags ?? new List<FlagViewModel>()));
        const priceHistoryPageContext = 'index';

    </script>

    <script src="~/js/member/AllegroPriceHistory.js"></script>
    <script src="~/js/member/CompetitorModal.js"></script>
}