

@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization
@model PriceSafari.Models.ViewModels.StorePaymentsViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var safePaymentDataList = Model.PaymentDataList.Select(data => new
    {
        data.CompanyName,
        data.Address,
        data.PostalCode,
        data.City,
        data.NIP,
        data.InvoiceAutoMail,
        data.InvoiceAutoMailSend
    }).ToList();

    var jsonSettings = new JsonSerializerSettings
    {
        ContractResolver = new CamelCasePropertyNamesContractResolver()
    };

    var paymentDataListJson = JsonConvert.SerializeObject(safePaymentDataList, jsonSettings);

    string planImageFile = "";
    if (Model.IsTestPlan) planImageFile = "Free.png";
    else if (Model.ProductsToScrap <= 500) planImageFile = "Lite.png";
    else if (Model.ProductsToScrap <= 1000) planImageFile = "Basic.png";
    else if (Model.ProductsToScrap <= 4000) planImageFile = "Pro.png";
    else if (Model.ProductsToScrap <= 10000) planImageFile = "Ultimate.png";
    else planImageFile = "Enterprise.png";

    decimal discountedPrice = Model.PlanPrice;
    if (Model.DiscountValue.HasValue && Model.DiscountValue.Value > 0)
    {
        var discountAmount = Model.PlanPrice * (Model.DiscountValue.Value / 100);
        discountedPrice = Model.PlanPrice - discountAmount;
    }

    string defaultView = Model.IsRecurringActive ? "card" : "transfer";

    string formattedCardNumber = "**** **** **** ****";
    if (!string.IsNullOrEmpty(Model.CardMaskedNumber) && Model.CardMaskedNumber.Length >= 4)
    {
        string last4 = Model.CardMaskedNumber.Substring(Model.CardMaskedNumber.Length - 4);
        formattedCardNumber = $"**** **** **** {last4}";
    }
}

<style>

    .details-container {
        display: flex;
        gap: 20px;
        width: 100%;
        margin-top: 24px;
        align-items: stretch;
    }

    .details-sidebar {
        display: flex;
        min-width: 360px;
    }

    .details-middle {
        display: flex;
        min-width: 360px;
    }

    .details-main {
        display: flex;
        width: 100%;
    }

    .info-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        height: 400px;
    }

    .info-card-header {
        padding: 16px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-size: 17px;
        font-weight: 500;
    }

    .info-card-body {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .info-card-footer {
        padding: 20px;
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
        margin-top: auto;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid #f1f3f5;
    }

        .info-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .info-row:first-child {
            padding-top: 0;
        }

    .info-label {
        color: #6c757d;
    }

    .info-value {
        color: #212529;
        font-weight: 500;
        text-align: right;
    }

        .info-value img {
            height: 20px;
            width: 20px;
            margin-left: 5px;
        }

    .price-display {
        display: flex;
        align-items: baseline;
        margin-bottom: 8px;
    }

        .price-display .final-price-amount {
            color: #212529;
            font-weight: 600;
            font-size: 28px;
            line-height: 1;
        }

        .price-display .final-price-label {
            font-size: 16px;
            font-weight: 400;
            color: #6c757d;
            margin-left: 8px;
        }

        .price-display .original-price {
            text-decoration: line-through;
            font-size: 18px;
            color: #6c757d;
            margin-left: 12px;
        }

    .discount-info {
        font-weight: 500;
        color: #28a745;
    }

    .payment-switcher {
        display: flex;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 10px 15px 0 15px;
        gap: 5px;
        margin: -20px -20px 20px -20px;
    }

    .payment-tab {
        flex: 1;
        text-align: center;
        padding: 10px 5px;
        font-size: 0.85rem;
        cursor: pointer;
        border-radius: 6px 6px 0 0;
        border: 1px solid transparent;
        border-bottom: none;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.2s;
        position: relative;
    }

        .payment-tab:hover {
            background-color: #e9ecef;
        }

        .payment-tab.view-active {
            background-color: #fff;
            border-color: #e9ecef;
            color: #212529;
            font-weight: 600;
            box-shadow: 0 4px 0 0 #fff;
            margin-bottom: -1px;
            z-index: 1;
            border-top: 3px solid #28a745;
        }

    .active-method-tick {
        color: #28a745;
        margin-left: 5px;
        font-size: 1.1em;
        vertical-align: middle;
    }

    .card-view-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .credit-card-visual {
        width: 290px;
        height: 185px;
        background: linear-gradient(135deg, #222222 0%, #222222 100%);
        border-radius: 12px;
        padding: 20px;
        color: white;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.20);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        margin: 0 auto;
        font-family: 'Courier New', Courier, monospace;
    }

    .card-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .card-chip {
        width: 42px;
        height: 30px;
        background: linear-gradient(135deg, #bdc3c7 0%, #ecf0f1 50%, #bdc3c7 100%);
        border-radius: 5px;
        position: relative;
        overflow: hidden;
    }

        .card-chip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(0,0,0,0.15);
        }

        .card-chip::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            width: 1px;
            height: 100%;
            background: rgba(0,0,0,0.15);
        }

    .card-brand-logo {
        font-size: 32px;
        opacity: 0.9;
    }

    .card-number-visual {
        font-size: 18px;
        letter-spacing: 2px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        margin-top: 5px;
        text-align: center;
    }

    .card-bottom {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }

    .card-expiry-group {
        display: flex;
        flex-direction: column;
    }

    .card-label {
        font-size: 7px;
        text-transform: uppercase;
        color: #ccc;
        margin-bottom: 2px;
    }

    .card-expiry-value {
        font-size: 13px;
        font-weight: bold;
    }

    .btn-danger-outline {
        background-color: white;
        color: #dc3545;
        border: 1px solid #dc3545;
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 0.8em;
        transition: all 0.2s;
        cursor: pointer;
        margin-top: 20px;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
    }

        .btn-danger-outline:hover {
            background-color: #dc3545;
            color: white;
            text-decoration: none;
        }

    .modal-dialog {
        min-width: 1000px;
    }

    .modal-content {
        min-width: 1000px;
    }

    .modal-split {
        display: flex;
        gap: 24px;
        padding: 1rem;
    }

    .modal-split-left {
        flex: 5;
    }

    .modal-split-right {
        flex: 4;
    }

    .custom-info-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
    }

        .custom-info-table th, .custom-info-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #e9ecef;
        }

        .custom-info-table th {
            background-color: #f8f9fa;
            text-align: left;
            font-weight: normal;
            color: #6c757d;
            width: 140px;
        }

        .custom-info-table td {
            font-weight: 500;
        }

        .custom-info-table tr:last-child td, .custom-info-table tr:last-child th {
            border-bottom: none;
        }

    .status-box {
        display: flex;
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border-radius: 0.25rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

        .status-box.success {
            border: 1px solid #28a745;
            color: #155724;
            background-color: #d4edda;
        }

        .status-box.warning {
            border: 1px solid #ffc107;
            color: #856404;
            background-color: #fff3cd;
        }

    .btn-danger-custom {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: background-color 0.2s;
        cursor: pointer;
    }

        .btn-danger-custom:hover {
            background-color: #c82333;
            color: white;
            text-decoration: none;
        }

    #imoje-widget-container {
        display: none;
        margin-top: 15px;
    }
</style>

<div class="Vert">
    <div class="Vert-fluid">

        <div id="paymentSuccessAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none; margin-bottom: 20px;">
            <strong>Sukces!</strong> Twoja karta została pomyślnie zweryfikowana i podłączona. Subskrypcja jest aktywna.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div id="paymentFailureAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none; margin-bottom: 20px;">
            <strong>Błąd!</strong> Wystąpił problem z autoryzacją płatności. Spróbuj ponownie lub użyj innej karty.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="store-details">
            <h2 style="font-size: 26px; font-weight: 300;">Plan @Model.PlanName | <img src="~/images/@planImageFile" alt="@Model.PlanName" style="height:32px; margin-bottom:6px;" /></h2>

            <div class="details-container">

                <div class="details-sidebar info-card">
                    <div class="info-card-header">Koszt planu</div>
                    <div class="info-card-body">
                        <div class="price-display">
                            <span class="final-price-amount">@discountedPrice.ToString("C")</span>
                            <span class="final-price-label">netto</span>
                            @if (Model.DiscountValue.HasValue && Model.DiscountValue.Value > 0)
                            {
                                <span class="original-price">@Model.PlanPrice.ToString("C")</span>
                            }
                        </div>
                        @if (Model.DiscountValue.HasValue && Model.DiscountValue.Value > 0)
                        {
                            <div class="discount-info">Rabat: @Model.DiscountValue.Value.ToString("F2")%</div>
                        }

                        @if (!string.IsNullOrWhiteSpace(Model.Info))
                        {
                            <hr style="margin: 20px 0;">
                            <div class="info-description">
                                <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 0;">@Model.Info</p>
                            </div>
                        }
                    </div>
                    <div class="info-card-footer">
                        <button type="button" class="Button-Page-Small-bl" data-toggle="modal" data-target="#managePlanModal">
                            Zarządzaj moim planem
                        </button>
                    </div>
                </div>

                <div class="details-middle info-card">
                    <div class="info-card-header">Metoda płatności</div>

                    <div class="info-card-body">
                        <div class="payment-switcher">
                            <div class="payment-tab @(defaultView == "transfer" ? "view-active" : "")" data-target="transfer">
                                Przelew
                                @if (!Model.IsRecurringActive)
                                {
                                    <i class="fas fa-check-circle active-method-tick" title="Aktywna metoda"></i>
                                }
                            </div>
                            <div class="payment-tab @(defaultView == "card" ? "view-active" : "")" data-target="card">
                                Karta
                                @if (Model.IsRecurringActive)
                                {
                                    <i class="fas fa-check-circle active-method-tick" title="Aktywna metoda"></i>
                                }
                            </div>
                        </div>

                        <div id="view-transfer" style="display: @(defaultView == "transfer" ? "block" : "none"); height: 100%;">
                            @if (Model.IsRecurringActive)
                            {
                                <div class="card-view-container" style="color: #6c757d;">
                                    <i class="fas fa-lock fa-2x mb-3" style="color: #dee2e6;"></i>
                                    <p style="font-size: 0.9em;">
                                        <b>Płatności automatyczne są aktywne.</b>
                                        <br>
                                        Twoje faktury opłacane są automatycznie z podpiętej karty.
                                    </p>
                                    <p style="font-size: 0.8em; margin-top: 10px;">
                                        Aby wrócić do przelewów, usuń kartę w zakładce obok.
                                    </p>
                                </div>
                            }
                            else
                            {
                                <div class="card-view-container" style="color: #6c757d;">
                                    <i class="fas fa-university fa-3x mb-3" style="color: #e9ecef;"></i>
                                    <p style="font-size: 0.9em;">
                                        Faktury otrzymasz na e-mail. Opłacaj je tradycyjnym przelewem.
                                    </p>
                                </div>
                            }
                        </div>

                        <div id="view-card" style="display: @(defaultView == "card" ? "block" : "none"); height: 100%;">

                            @if (Model.IsRecurringActive)
                            {
                                <div class="card-view-container">

                                    <div class="credit-card-visual">
                                        <div class="card-top">
                                            <div class="card-chip"></div>

                                            <div class="card-brand-logo">
                                                @if (!string.IsNullOrEmpty(Model.CardBrand) && Model.CardBrand.ToLower().Contains("visa"))
                                                {
                                                    <i class="fab fa-cc-visa" style="color: #fff;"></i>
                                                }
                                                else if (!string.IsNullOrEmpty(Model.CardBrand) && Model.CardBrand.ToLower().Contains("master"))
                                                {
                                                    <i class="fab fa-cc-mastercard" style="color: #fff;"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-credit-card" style="color: #fff;"></i>
                                                }
                                            </div>
                                        </div>

                                        <div class="card-number-visual">
                                            @formattedCardNumber
                                        </div>

                                        <div class="card-bottom">
                                            <div class="card-expiry-group">
                                                <span class="card-label">Valid Thru</span>
                                                <span class="card-expiry-value">
                                                    @if (!string.IsNullOrEmpty(Model.CardExpMonth) && !string.IsNullOrEmpty(Model.CardExpYear))
                                                    {
                                                        @($"{Model.CardExpMonth}/{Model.CardExpYear.Substring(Model.CardExpYear.Length - 2)}")
                                                    }
                                                    else
                                                    {
                                                        <span>--/--</span>
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <button id="btnRemoveCard" type="button" class="btn-danger-outline">
                                        <i class="fas fa-trash-alt" style="margin-right: 6px;"></i> Usuń kartę
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div id="cardConnectContainer" class="card-view-container">

                                   
                                    @*
                                        <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                                            Włącz płatności automatyczne.
                                        </p>

                                        <button id="btnConnectCard" type="button" class="Button-Action-Small" style="width: 100%; justify-content: center;">
                                            <i class="fas fa-plus" style="margin-right: 6px;"></i> Podłącz kartę
                                        </button>

                                        <div id="imoje-widget-container"></div>
                                        *@
                                  


                                    @* ---  "JUŻ WKRÓTCE" --- *@
                                    <div style="text-align: center; color: #adb5bd;">
                                        <span class="fa-stack fa-2x" style="margin-bottom: 15px;">
                                            <i class="fas fa-circle fa-stack-2x" style="color: #f8f9fa;"></i>
                                            <i class="fas fa-clock fa-stack-1x" style="color: #dee2e6;"></i>
                                        </span>
                                        <h4 style="font-weight: 400; font-size: 1.2rem; color: #6c757d;">Już wkrótce</h4>
                                        <p style="font-size: 0.85em; max-width: 200px; margin: 0 auto;">
                                            Płatności kartą zostaną uruchomione niebawem.
                                        </p>
                                    </div>
                                    @* ---  "JUŻ WKRÓTCE" --- *@
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="details-main info-card">
                    <div class="info-card-header">Szczegóły planu</div>
                    <div class="info-card-body">

                        <div class="info-row">
                            <span class="info-label">Źródło danych</span>
                            <span class="info-value">
                                @if (Model.Ceneo)
                                {
                                    <img src="~/images/Ceneo.png" alt="Ceneo" title="Ceneo" />
                                }
                                @if (Model.GoogleShopping)
                                {
                                    <img src="~/images/GoogleShopping.png" alt="Google Shopping" title="Google Shopping" />
                                }
                                @if (Model.Allegro)
                                {
                                    <img src="~/images/AllegroIcon.png" alt="Allegro" title="Allegro" />
                                }
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Max produktów w porównywarkach</span>
                            <span class="info-value">@Model.ProductsToScrap SKU</span>
                        </div>

                        @if (Model.Allegro)
                        {
                            <div class="info-row">
                                <span class="info-label">Max produktów na marketplace</span>
                                <span class="info-value">@Model.ProductsToScrapAllegro SKU</span>
                            </div>
                        }

                        <div class="info-row">
                            <span class="info-label">Czas usługi</span>
                            <span class="info-value">@Model.ScrapesPerInvoice dni</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Dane historyczne</span>
                            <span class="info-value">30 analiz historycznych</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Status konta</span>
                            <span class="info-value">
                                @if (Model.UserWantsExit)
                                {
                                    <span style="color: #dc3545; font-weight: 600;">
                                        <i class="fas fa-times-circle"></i> Subskrypcja anulowana
                                    </span>
                                }
                                else
                                {
                                    <span style="color: #28a745; font-weight: 600;">
                                        <i class="fas fa-check-circle"></i> Konto aktywne
                                    </span>
                                }
                            </span>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade" id="managePlanModal" tabindex="-1" role="dialog" aria-labelledby="managePlanModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="managePlanModalLabel">Mój Plan i Dane Płatności</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-split">
                            <div class="modal-split-left">
                                <div id="paymentDataSection">
                                    <div id="existingDataHeader" class="status-box success" style="display:none;">
                                        <span><i class="fas fa-check-circle"></i> Dane do faktury przypisane</span>
                                    </div>

                                    <div id="noDataHeader" class="status-box warning" style="display:none;">
                                        <span><i class="fas fa-exclamation-circle"></i> Brak przypisanych danych</span>
                                        <span style="font-size: 0.8em;">Skontaktuj się z administratorem</span>
                                    </div>

                                    <div id="paymentDataDetails" style="display:none; margin-top: 20px;">
                                        <h6 style="color: #6c757d; margin-bottom: 10px;">Dane płatnika:</h6>
                                        <table class="custom-info-table">
                                            <tr><th>Nazwa firmy</th><td id="companyName"></td></tr>
                                            <tr><th>Adres</th><td id="address"></td></tr>
                                            <tr><th>Kod pocztowy</th><td id="postalCode"></td></tr>
                                            <tr><th>Miasto</th><td id="city"></td></tr>
                                            <tr><th>NIP</th><td id="nip"></td></tr>
                                            <tr><th>E-mail do faktur</th><td id="invoiceAutoMail"></td></tr>
                                            <tr><th>Automatyczna wysyłka</th><td id="invoiceAutoMailSend"></td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-split-right">
                                <div class="info-card" style="height: 100%;">
                                    <div class="info-card-header">Podsumowanie planu</div>
                                    <div class="info-card-body">
                                        <p style="font-weight: 500; font-size: 1.1em; margin-bottom: 14px;">Plan @Model.PlanName</p>
                                        <div class="price-display">
                                            <span class="final-price-amount">@discountedPrice.ToString("C")</span>
                                            <span class="final-price-label">netto</span>
                                        </div>
                                        <div style="margin-top: 20px; font-size: 0.9em; color: #6c757d;">
                                            <i class="fas fa-info-circle"></i> Jeśli potrzebujesz zaktualizować dane płatnika lub zmienić swój plan, skontaktuj się z nami, wysyłając wiadomość na adres <strong>biuro@pricesafari.pl</strong>.
                                            <br /><br />
                                            Faktury będą wystawiane i wysyłane automatycznie. Otrzymasz je z adresu biuro@pricesafari.pl.
                                            <br /><br />
                                            W przypadku chęci rezygnacji z usługi PriceSafari, możesz to zrobić za pomocą przycisku poniżej.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="justify-content: space-between;">
                        <button type="button" class="btn-danger-custom" id="openResignationModalBtn">
                            Zrezygnuj z usługi monitoringu cen
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="resignationConfirmModal" tabindex="-1" role="dialog" aria-labelledby="resignationConfirmLabel" aria-hidden="true" style="z-index: 1060;">
            <div class="modal-dialog modal-sm modal-dialog-centered" role="document" style="min-width: 450px;">
                <div class="modal-content" style="min-width: 450px;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resignationConfirmLabel">Rezygnacja z usługi</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body text-center" id="resignationModalBody">
                        <div class="mb-3"><i class="fas fa-sad-tear fa-3x text-muted" style="font-size: 3em; color: #6c757d; margin: 15px 0;"></i></div>
                        <p style="font-size: 1.1em; font-weight: 500;">Czy na pewno chcesz zrezygnować z usług monitoringu cen?</p>
                        <div style="margin-top: 20px;">
                            <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal" style="margin-right: 10px;">Anuluj</button>
                            <button type="button" class="btn btn-danger" id="confirmResignationBtn">Potwierdzam rezygnację</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="Vert-full">
        @if (Model.Invoices != null && Model.Invoices.Any())
        {
            <div class="Vert-table" style="margin-top: 30px;">
                <h3 style="font-weight: 400; margin-bottom: 20px;">Historia płatności</h3>
                <table class="table-orders">
                    <thead>
                        <tr><th>Numer</th><th>Wystawiono</th><th>Opłacono</th><th>Kwota Netto</th><th>Status</th><th>Pobierz</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var invoice in Model.Invoices)
                        {
                            <tr class="store-row">
                                <td>@invoice.InvoiceNumber</td>
                                <td>@invoice.IssueDate.ToString("yyyy-MM-dd")</td>
                                <td>@(invoice.PaymentDate?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                <td>@invoice.NetAmount.ToString("C")</td>
                                <td>
                                    @if (invoice.IsPaid)
                                    {
                                        <span class="Validation Validation-accepted">Opłacona</span>
                                    }
                                    else
                                    {
                                        <span class="Validation Validation-cancelled">Nieopłacona</span>
                                    }
                                </td>
                                <td>
                                    <a href="@Url.Action("InvoicePdf", "Payment", new { invoiceId = invoice.InvoiceId })" class="Button-Action-Small" target="_blank">Pobierz PDF</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="Vert-table" style="margin-top: 30px;">
                <h3 style="font-weight: 400; margin-bottom: 20px;">Historia płatności</h3>
                <div style="padding: 30px; text-align: center; color: #adb5bd; border: 1px solid #eee; border-radius: 8px;">
                    Brak faktur w historii.
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const storeId = '@Model.StoreId';

            $(".payment-tab").click(function() {
                $(".payment-tab").removeClass("view-active");
                $(this).addClass("view-active");

                var target = $(this).data("target");
                if(target === "transfer") {
                    $("#view-transfer").show();
                    $("#view-card").hide();
                } else {
                    $("#view-transfer").hide();
                    $("#view-card").show();
                }
            });

            $("#btnRemoveCard").click(function() {
                if(confirm("Czy na pewno chcesz odłączyć kartę płatniczą? System powróci do płatności przelewem.")) {
                    var btn = $(this);
                    var originalHtml = btn.html();
                    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Usuwanie...');

                    $.post("/Payment/RemoveCard", { storeId: storeId }, function(response) {
                        if(response.success) {
                             window.location.reload();
                        } else {
                            alert("Błąd podczas usuwania karty. Spróbuj ponownie.");
                            btn.prop('disabled', false).html(originalHtml);
                        }
                    }).fail(function() {
                        alert("Błąd połączenia z serwerem.");
                        btn.prop('disabled', false).html(originalHtml);
                    });
                }
            });

            if (status === 'success') {
                $("#paymentSuccessAlert")
                    .removeClass("alert-success")
                    .addClass("alert-warning")
                    .html('<strong>Weryfikacja...</strong> Czekamy na potwierdzenie z banku. Proszę czekać... <i class="fas fa-spinner fa-spin"></i>')
                    .show();

                $(".payment-tab[data-target='card']").click();
                $("#btnConnectCard").prop('disabled', true);

                let attempts = 0;
                const maxAttempts = 15;

                const checkInterval = setInterval(function () {
                    attempts++;
                    $.get("/Payment/CheckCardStatus?storeId=" + storeId, function (data) {
                        if (data.isConnected) {
                            clearInterval(checkInterval);
                            $("#paymentSuccessAlert")
                                .removeClass("alert-warning")
                                .addClass("alert-success")
                                .html('<strong>Sukces!</strong> Twoja karta została pomyślnie zweryfikowana. Odświeżam...');

                            setTimeout(function () {
                                window.location.href = window.location.pathname + "?storeId=" + storeId;
                            }, 1000);
                        }

                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            $("#paymentSuccessAlert")
                                .removeClass("alert-warning")
                                .addClass("alert-info")
                                .html('<strong>Info:</strong> Płatność jest przetwarzana dłużej niż zwykle. Odśwież stronę za chwilę.');
                             window.history.replaceState(null, null, window.location.pathname + "?storeId=" + storeId);
                        }
                    });
                }, 2000);

            } else if (status === 'failure') {
                $("#paymentFailureAlert").show();
                window.history.replaceState(null, null, window.location.pathname + "?storeId=" + storeId);
                $(".payment-tab[data-target='card']").click();
            }

            var paymentDataList = @Html.Raw(paymentDataListJson);
            var currentPaymentData = null;

            if (paymentDataList.length > 0) {
                currentPaymentData = paymentDataList[0];
                showData(currentPaymentData);
            } else {
                showEmpty();
            }

            function showData(data) {
                $("#existingDataHeader").css('display', 'flex');
                $("#noDataHeader").hide();
                $("#paymentDataDetails").show();
                $("#companyName").text(data.companyName);
                $("#address").text(data.address);
                $("#postalCode").text(data.postalCode);
                $("#city").text(data.city);
                $("#nip").text(data.nip);
                $("#invoiceAutoMail").text(data.invoiceAutoMail ? data.invoiceAutoMail : "-");
                if (data.invoiceAutoMailSend) {
                    $("#invoiceAutoMailSend").html('<span class="text-success font-weight-bold">Tak</span>');
                } else {
                    $("#invoiceAutoMailSend").html('<span class="text-muted">Nie</span>');
                }
            }

            function showEmpty() {
                $("#existingDataHeader").hide();
                $("#noDataHeader").css('display', 'flex');
                $("#paymentDataDetails").hide();
            }
                    $("#btnConnectCard").click(function () {
            var btn = $(this);
            var originalText = btn.html();

            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Przetwarzanie...');
            $("#imoje-widget-container").show();

            $.post("/Payment/GetImojeWidgetData", { storeId: storeId }, function (response) {
                if (response.success) {
                    if (!response.scriptUrl) {
                        alert("Błąd konfiguracji: Brak adresu URL widgetu imoje.");
                        btn.prop('disabled', false).html(originalText);
                        return;
                    }

                    var d = response.data;
                    $("#imoje-widget-container").empty();

                    var script = document.createElement('script');
                    script.type = "text/javascript";

                    script.id = "imoje-widget__script";

                    var attrs = {
                        "data-merchant-id": d.merchantId,
                        "data-service-id": d.serviceId,
                        "data-amount": d.amount,
                        "data-currency": d.currency,
                        "data-order-id": d.orderId,
                        "data-customer-id": d.customerId,
                        "data-customer-first-name": d.customerFirstName,
                        "data-customer-last-name": d.customerLastName,
                        "data-customer-email": d.customerEmail,
                        "data-widget-type": d.widgetType,
                        "data-url-notification": d.urlNotification,
                        "data-url-success": d.urlSuccess,
                        "data-url-failure": d.urlFailure,
                        "data-signature": response.signature,
                        "data-locale": "pl"
                    };

                    for(var k in attrs) {
                        if(attrs[k]) {
                            script.setAttribute(k, attrs[k]);
                        }
                    }

                    script.src = response.scriptUrl;

                    script.onerror = function() {
                        alert("Nie udało się załadować skryptu płatności. Wyłącz AdBlock.");
                        btn.prop('disabled', false).html(originalText);
                    };

                    document.getElementById("imoje-widget-container").appendChild(script);

                    setTimeout(function () {
                        btn.hide();
                    }, 500);

                } else {
                    alert("Błąd inicjalizacji danych płatności.");
                    btn.prop('disabled', false).html(originalText);
                }
            }).fail(function (xhr, status, error) {
                console.error(error);
                alert("Błąd połączenia z serwerem.");
                btn.prop('disabled', false).html(originalText);
            });
        });

            $("#openResignationModalBtn").click(function () {
                $("#managePlanModal").modal('hide');
                setTimeout(function () {
                    $("#resignationConfirmModal").modal('show');
                }, 300);
            });

            $("#confirmResignationBtn").click(function () {
                var btn = $(this);
                btn.prop('disabled', true).text('Przetwarzanie...');

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("RequestResignation", "Payment")",
                    data: { storeId: @Model.StoreId },
                    success: function (response) {
                        if (response.success) {
                            var successHtml = `
                                <div class="mb-3"><i class="fas fa-check-circle fa-3x text-success" style="font-size: 3em; color: #28a745; margin: 15px 0;"></i></div>
                                <h4 style="font-weight: 400;">Dziękujemy za informację.</h4>
                                <p class="mt-3" style="font-size: 1.1em;">Przykro nam, że odchodzisz.</p>
                                <p class="text-muted" style="font-size: 0.9em;">Skontaktujemy się z Tobą jak najszybciej.</p>
                            `;
                            $("#resignationModalBody").html(successHtml);
                        } else {
                            alert("Wystąpił błąd.");
                            btn.prop('disabled', false).text('Potwierdzam rezygnację');
                        }
                    },
                    error: function () {
                        alert("Wystąpił błąd połączenia.");
                        btn.prop('disabled', false).text('Potwierdzam rezygnację');
                    }
                });
            });
        });
    </script>
}