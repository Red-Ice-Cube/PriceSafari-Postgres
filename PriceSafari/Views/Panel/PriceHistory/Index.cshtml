@using Newtonsoft.Json
@using PriceSafari.Models.ViewModels

@{
    ViewData["Title"] = "Historia Cen";
    var latestScrap = ViewBag.LatestScrap as PriceSafari.Models.ScrapHistoryClass;
    var storeId = ViewBag.StoreId;

    var storeLogo = ViewBag.StoreLogo;
    var scrapId = ViewBag.ScrapId;
    var flags = ViewBag.Flags as List<FlagViewModel>;
}

<input type="hidden" id="initialScrapId" value="@scrapId" />

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

@{
    var scrapDate = latestScrap?.Date.ToString("dd.MM.yyyy");
    var store = ViewBag.StoreName as string;
}

<style>

    .simulationProductTitle {
        text-decoration: none;
        color: #222222;
    }

        .simulationProductTitle:hover {
            color: #41C7C7;
            cursor: pointer;
        }

    .delivery-indicator {
        display: inline-block;
        padding-left: 8px;
        padding-right: 8px;
        height: 20.5px;
        line-height: 17.5px;
        margin-left: 5px;
        margin-right: 2px;
        border-radius: 4px;
        vertical-align: middle;
        box-sizing: border-box;
    }

        .delivery-indicator i.fa-truck {
            color: white;
            font-size: 14px;
        }

    .delivery-included-green {
        background-color: #28a745;
    }

    .delivery-not-included-red {
        background-color: #dc3545;
    }








</style>

<div class="Vert">
    <div class="Page-Box">
        <div class="Page-Box-Container">
            <div class="Page-Box-Category">
                <div><img src="@storeLogo" class="img-container" /></div>

                <div class="mode-switch-container">
                    <button class="mode-switch-btn active" id="btn-mode-comp" title="Strategia maksymalizacji wolumenu sprzedaży">
                        <i class="fa-solid fa-bolt"></i> Lider Rynku
                    </button>

                    <button class="mode-switch-btn" id="btn-mode-profit" title="Strategia optymalizacji marży i zysku">
                        <i class="fa-solid fa-dollar-sign"></i> Rentowność
                    </button>
                </div>

                <div class="side-chart-box">
                    <canvas id="colorChart"></canvas>
                </div>

                <div class="store-section" id="filters-competitiveness">

                    <div class="form-check">
                        <span class="color-rect rect-no-offer"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prNoOfferCheckbox" value="prNoOffer">
                        <label class="form-check-label" for="prNoOfferCheckbox">Cena niedostępna</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-only-me"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prOnlyMeCheckbox" value="prOnlyMe">
                        <label class="form-check-label" for="prOnlyMeCheckbox">Cena solo</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-to-high"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prToHighCheckbox" value="prToHigh">
                        <label class="form-check-label" for="prToHighCheckbox">Cena zawyżona</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-mid"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prMidCheckbox" value="prMid">
                        <label class="form-check-label" for="prMidCheckbox">Cena suboptymalna</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-good"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prGoodCheckbox" value="prGood">
                        <label class="form-check-label" for="prGoodCheckbox">Cena konkurencyjna</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-ideal"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prIdealCheckbox" value="prIdeal">
                        <label class="form-check-label" for="prIdealCheckbox">Cena strategiczna</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-to-low"></span>
                        <input class="form-check-input colorFilter" type="checkbox" id="prToLowCheckbox" value="prToLow">
                        <label class="form-check-label" for="prToLowCheckbox">Cena zaniżona</label>
                    </div>

                    <div class="price-range-settings">
                        <div class="color-circle prMid-circle"></div>
                        <div class="legendBox">Próg c. subopt.</div>
                        <label for="price2"></label>
                        <input type="number" id="price2" value="@ViewBag.SetPrice2" step="0.01" min="0.01">
                        <span id="unitLabel2" style="display:flex; align-items:center;"></span>
                    </div>
                    <div class="price-range-settings">
                        <div class="color-circle prIdeal-circle"></div>
                        <div class="legendBox">Próg c. strateg.</div>
                        <label for="price1"></label>
                        <input type="number" id="price1" value="@ViewBag.SetPrice1" step="0.01" min="0.01">
                        <span id="unitLabel1" style="display:flex; align-items:center;"></span>
                    </div>
                    <div class="price-range-settings">
                        <div class="price-range-settings-stepPrice"></div>
                        <div class="legendBox">
                            Krok cenowy
                            <div id="stepPriceIndicator" class="step-indicator"></div>
                        </div>
                        <label for="stepPrice"></label>
                        <input type="number" id="stepPrice" value="@ViewBag.StepPrice" step="0.01" min="-100.00" max="100.00">
                        <span id="unitLabelStepPrice" style="display:flex; align-items:center;"></span>
                    </div>

                    <div>
                        <input class="diffCheckBox" style="margin-top: 10px;" type="checkbox" id="usePriceDifference" />
                    </div>
                    <button class="Button-Page-Small" style="margin-top: 4px;" id="savePriceValues">Przelicz i zapisz</button>
                </div>

                <div class="store-section" id="filters-profit" style="display: none;">

                    <div class="form-check">
                        <span class="color-rect rect-no-offer"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketUnavailable" value="market-unavailable">
                        <label class="form-check-label" for="bucketUnavailable">Cena niedostępna</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-only-me"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketSolo" value="market-solo">
                        <label class="form-check-label" for="bucketSolo">Cena solo</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-overpriced"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketOverpriced" value="market-overpriced">
                        <label class="form-check-label" for="bucketOverpriced">Cena przeszacowana</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-above-average"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketAboveAverage" value="market-above-average">
                        <label class="form-check-label" for="bucketAboveAverage">Cena powyżej średniej</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-ideal"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketAverage" value="market-average">
                        <label class="form-check-label" for="bucketAverage">Cena rynkowa</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-below-average"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketBelowAverage" value="market-below-average">
                        <label class="form-check-label" for="bucketBelowAverage">Cena poniżej średniej</label>
                    </div>

                    <div class="form-check">
                        <span class="color-rect rect-deep-discount"></span>
                        <input class="form-check-input bucketFilter" type="checkbox" id="bucketDeepDiscount" value="market-deep-discount">
                        <label class="form-check-label" for="bucketDeepDiscount">Cena okazyjna</label>
                    </div>


                    <div class="price-range-settings">
                        <div class="price-range-settings-indexTarget"></div>
                        <div class="legendBox" title="100% = Mediana. 95% = 5% taniej niż rynek.">
                            Index cenowy
                            <div id="priceIndexIndicator" class="step-indicator"></div>
                        </div>
                        <label for="priceIndexTargetInput"></label>
                        <input type="number" id="priceIndexTargetInput" value="100.00" step="0.5" min="1" max="500">
                        <span style="display:flex; align-items:center;">%</span>
                    </div>


                    <button class="Button-Page-Small" style="margin-top: 8px; width:100%;" id="savePriceValues_profit">Przelicz i zapisz</button>

                </div>

                <div class="filterBox">

                    <div class="Category-Container-Select" style="margin-top:-2px;">Flagi <a asp-controller="Flags" asp-action="List" asp-route-storeId="@ViewBag.StoreId" class="link-line">+ Dodaj Flage</a></div>
                    <div class="store-section" id="flagContainer">
                    </div>
                    <div class="Category-Container-Select">Automaty cenowe</div>
                    <div class="store-section" id="automationFilterContainer">
                    </div>
                   
                    <div class="Category-Container-Select">Pozycja</div>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css">

                    <div class="store-section">
                        <div class="position-slider-container">
                            <div id="positionRange" class="position-range-display" style="font-size:14px; font-weight:400;"></div>
                        </div>

                        <div id="positionRangeSlider"></div>
                    </div>

                    <div class="Category-Container-Select">Liczba ofert</div>
                    <div class="store-section">
                        <div class="offer-slider-container">
                            <div id="offerRange" class="offer-range-display" style="font-size:14px; font-weight:400;"></div>
                        </div>

                        <div id="offerRangeSlider"></div>
                    </div>
                    <div class="Category-Container-Select">Ceneo - Promowanie</div>
                    <div class="store-section">

                        <div class="form-check">
                            <input class="form-check-input bidFilter" type="checkbox" id="bidFilter">
                            <label class="form-check-label" for="bidFilter">Bid</label>
                        </div>

                    </div>
                    <div class="Category-Container-Select">Dostępność - Twój sklep</div>
                    <div class="store-section">
                        <div class="filter-category">
                            <div class="form-check">
                                <input class="form-check-input stockFilterMyStore" type="checkbox" id="stockAvailableMyStore" value="true">
                                <label class="form-check-label" for="stockAvailableMyStore">Dostępny</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input stockFilterMyStore" type="checkbox" id="stockUnavailableMyStore" value="false">
                                <label class="form-check-label" for="stockUnavailableMyStore">Niedostępny</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input stockFilterMyStore" type="checkbox" id="stockNoDataMyStore" value="null">
                                <label class="form-check-label" for="stockNoDataMyStore">Brak danych</label>
                            </div>
                        </div>
                    </div>
                    <div class="Category-Container-Select">Dostępność - konkurencja</div>
                    <div class="store-section">
                        <div class="filter-category">
                            <div class="form-check">
                                <input class="form-check-input stockFilterCompetitor" type="checkbox" id="stockAvailableCompetitor" value="true">
                                <label class="form-check-label" for="stockAvailableCompetitor">Dostępny</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input stockFilterCompetitor" type="checkbox" id="stockUnavailableCompetitor" value="false">
                                <label class="form-check-label" for="stockUnavailableCompetitor">Niedostępny</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input stockFilterCompetitor" type="checkbox" id="stockNoDataCompetitor" value="null">
                                <label class="form-check-label" for="stockNoDataCompetitor">Brak danych</label>
                            </div>
                        </div>
                    </div>

                        <div class="Category-Container-Select">Podejrzanie niska cena</div>
                        <div class="store-section">
                            <div class="filter-category">
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="suspiciouslyLowFilter" value="1">
                                    <label class="form-check-label" for="suspiciouslyLowFilter">Pow. 25% odchylenia</label>
                                </div>

                            </div>
                        </div>

                    <div class="Category-Container-Select">Sprzedaż Ceneo - Dane z 90 dni</div>
                    <div class="store-section">
                        <div id="salesSortingButtons">
                            <button id="sortCeneoSales">Sprzedaż - ilość</button>
                            <button id="sortSalesTrendAmount">Trend - ilość</button>
                            <button id="sortSalesTrendPercent">Trend - %</button>
                        </div>
                    </div>

                </div>

            </div>
            <div class="Horizontal">
                <div class="order-upper-box">

                    <input type="text" id="productSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj produkt">

                    <input type="text" id="storeSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj sklep">

                    <select id="producerFilterDropdown" class="DropDown" style="max-width:150px; height:33.99px;">
                        <option value="">Wszystkie marki</option>
                    </select>

                    <button type="button" class="Button-Page-Small" style="white-space: nowrap; height:33.99px;" id="presetButton" onclick="openCompetitorsModal()">
                        Presety
                    </button>

                    <button class="Button-Page-Small" style="white-space: nowrap;" id="exportToExcelButton"><i class="fa-solid fa-floppy-disk" style="margin-top:2px;"></i>Eksport</button>

                    <button type="button" class="Button-Page-Small" style="justify-self:flex-end; margin-right:4px;" data-toggle="modal" data-target="#infoModal">
                        <i class="fa fa-info-circle"></i>
                    </button>

                    <div class="SimpleSpace" style="justify-content:flex-end; margin-right: 12px;">
                        <div id="selectionContainer" class="selection-container">
                            <span id="selectedProductsCounter" class="ProductCount" style="width:126px; height:33.99px;">Wybrano: 0</span>

                            <button id="selectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Zaznacz wszystkie widoczne produkty">
                                <i class="fa-solid fa-square-check"></i>
                            </button>
                            <button id="deselectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Odznacz wszystkie widoczne produkty">
                                <i class="fa-solid fa-square-xmark"></i>
                            </button>
                            <button id="showSelectedProductsBtn" class="Button-Page-Small" style="width:89.25px;">Akcje</button>
                        </div>

                    </div>

                </div>

                <div id="sortingButtons">
                    <div class="ProductCount" id="displayedProductCount"></div>

                    <div id="paginationContainer"></div>

                    <button id="sortName">A-Z</button>
                    <button id="sortPrice">Cena</button>
                    <button id="sortRaiseAmount">Podnieś PLN</button>
                    <button id="sortRaisePercentage">Podnieś %</button>
                    <button id="sortLowerAmount">Obniż PLN</button>
                    <button id="sortLowerPercentage">Obniż %</button>
                    <button id="sortMarginAmount">Narzut PLN</button>
                    <button id="sortMarginPercentage">Narzut %</button>

                </div>

                <div class="buttonsContainer">
                    <div id="priceChangeSummary" class="priceChangeSummary">
                        <div id="summaryText"></div>
                        <button id="openMarginSettingsBtn" class="Button-Page-Small" style="width:48px;"><i class="fa fa-cog" aria-hidden="true"></i></button>
                        <button id="openMassChangeModalBtn" class="Button-Page-Small" style="width:48px;">
                            <i class="fa fa-cubes" aria-hidden="true"></i>
                        </button>
                        <button id="simulateButton">Symuluj ceny</button>
                    </div>

                </div>
                <div class="Vert-table">
                    <div id="priceContainer" class="price-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-sim fade" id="simulationModal" tabindex="-1" role="dialog" aria-labelledby="simulationModalLabel">
    <div class="modal-dialog-sim" role="document">
        <div class="modal-simulation">
            <div class="modal-header" style="border:none; flex-direction: column; align-items: stretch;">

                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="price-box-column-name" id="simulationModalLabel">Symuluj ceny</div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-tab-toggle" style="margin-top: 15px;">
                    <button id="showPriceChangeCart" class="button-active" type="button">
                        Obecne Zmiany (<span id="cartTabCounter">0</span>)
                    </button>
                    <button id="showPriceChangeHistory" class="button-inactive" type="button">
                        Historia Zmian (<span id="historyTabCounter">0</span>)
                    </button>
                </div>

            </div>

            <div class="modal-body">
                <div class="table-scroll" id="simulationModalBody"></div>

                <div class="table-scroll" id="historyModalBody" style="display: none;"></div>
            </div>

            <div class="modal-footer">
                <div style="display:flex; width:100%; justify-content:space-between; align-items: center;">
                    <div style="display:inline-flex;">
                        <button type="button" id="clearChangesButton" class="Button-Page-Small-r">Usuń wszystkie zmiany</button>
                    </div>

                    <div style="display:inline-flex; gap:10px; align-items: center;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="checkbox" id="extendedExportCheckbox">
                            <label for="extendedExportCheckbox" style="margin-bottom: 0;">Eksport rozszerzony</label>
                        </div>
                        <button id="exportToCsvButton" class="Button-Page-Small-bl"><i class="fa-solid fa-file-csv"></i>Eksportuj do CSV</button>
                        <button id="exportNewPriceToExcelButton" class="Button-Page-Small-gr"><i class="fas fa-file-excel"></i>Eksportuj do Excela</button>
                        <button id="executeStorePriceChangeBtn" class="Button-Page-Small" style="background-color: #6f42c1; color: white; border-color: #6f42c1;">
                            <i class="fas fa-store"></i> Wgraj do Sklepu (API)
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="exportDisclaimerModal" tabindex="-1" role="dialog" aria-labelledby="exportDisclaimerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:460px;">
            <div class="modal-header">
                <div class="price-box-column-name" id="exportDisclaimerModalLabel">Ostrzeżenie</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">
                    Nie ponosimy odpowiedzialności za możliwe błędne powiązania między produktami z programu PriceSafari
                    a dostarczonym feedem XML. Prosimy sprawdzić dokładność powiązań przed operacją.
                </p>

                <div style="background-color: #f9f9f9; padding: 10px; border-left: 4px solid #007bff; font-size: 14px;">
                    <strong>Skutki operacji:</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        <li style="margin-bottom: 5px;">
                            Dla <b>CSV / Excel</b>: Wygenerowany zostanie tylko plik raportu. Ceny w sklepie <u>nie ulegną zmianie</u>.
                        </li>
                        <li>
                            Dla <b>API</b>: Zmiany cen zostaną <b>automatycznie wgrane do sklepu</b> i będą widoczne dla klientów.
                        </li>
                    </ul>
                </div>

                <p style="margin-top: 15px; font-size: 13px; color: #666;">
                    Wprowadzasz zmiany na własną odpowiedzialność.
                </p>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small-r" data-dismiss="modal">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="disclaimerConfirmButton">Kontynuuj</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deliveryDisclaimerModal" tabindex="-1" role="dialog" aria-labelledby="deliveryDisclaimerModalLabel" aria-hidden="true" style="z-index: 8555;">
    <div class="modal-dialog" style="max-width:1000px;" role="document">
        <div class="modal-content" style="width:800px; margin: 5% auto;">
            <div class="modal-header">
                <div class="price-box-column-name" id="deliveryDisclaimerModalLabel">Uwaga dotycząca symulacji cen z kosztem wysyłki</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; line-height: 1.6;">

                    Włączenie opcji "Uwzględniaj koszt wysyłki w cenie produktu" może znacząco wpłynąć na wyniki symulacji cenowej. System będzie porównywał ceny produktów wraz z kosztem wysyłki, co może prowadzić do odmiennych sugestii cenowych niż w przypadku porównania samych cen bazowych produktów.
                    <br /><br />
                    Pamiętaj, że podany koszt wysyłki może się różnić w zależności od gabarytów, wagi produktu oraz wybranej metody dostawy przez klienta.
                    <br /><br />
                    Jeżeli chcesz wykorzystywać ceny wraz z kosztem wysyłki, upewnij się, że konkurenci, których wybrano podczas tworzenia presetu, podają prawdziwe dane dotyczące cen wysyłki do wybranych kanałów, takich jak Google Shopping i Ceneo. Zdarza się, że ceny wysyłki są podawane błędnie lub nie są podawane wcale. Model wykorzysta również ceny wysyłki z Twojego sklepu, które zostały zebrane z ofert.
                    <br /><br />
                    <span style="font-weight: bold; display: flex; align-items: center; margin-bottom: 5px;">
                        <i class="fa fa-truck" style="color: #21a73e; font-size: 18px; margin-right: 8px;"></i>
                        Zielona ikona ciężarówki:
                    </span>
                    Oznacza, że dany sklep podał cenę wysyłki, a jej koszt wynosi 0,00 PLN lub jest wyższą, określoną kwotą.
                    <br />
                    <span style="font-weight: bold; display: flex; align-items: center; margin-top: 10px; margin-bottom: 5px;">
                        <i class="fa fa-truck" style="color: #f44336; font-size: 18px; margin-right: 8px;"></i>
                        Czerwona ikona ciężarówki:
                    </span>
                    Oznacza, że dany sklep nie podał kosztów dostawy dla wybranego produktu lub dane są niekompletne.
                    <br /><br />
                    W przypadku, gdy w źródłach danych używasz zarówno danych z Ceneo, jak i Google Shopping, pierwszeństwo w danych dotyczących wysyłki będą miały dane z Ceneo. Oznacza to, że jeśli Twój sklep posiada dane z obu tych źródeł dla danego produktu, a ceny za dostawę są różne (np. z powodu błędnego podania), wykorzystane zostaną dane z Ceneo.
                    <br /><br />
                    <strong style="color: #d9534f;">Zmiana tej opcji spowoduje usunięcie wszystkich danych z obecnej symulacji cenowej i konieczność ponownego przeliczenia.</strong>
                </p>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small-r" data-dismiss="modal" id="deliveryDisclaimerCancelButton">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="deliveryDisclaimerConfirmButton">Kontynuuj</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="massChangeModal" tabindex="-1" role="dialog" aria-labelledby="massChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="max-width:1000px;">
        <div class="modal-content" style="width:900px;">
            <div class="modal-header">
                <div class="price-box-column-name" id="massChangeModalLabel">
                    Masowa zmiana cen <span id="massChangeModeBadge" style="font-weight:400; font-size:0.8em; margin-left:10px; padding:2px 8px; border-radius:4px; border:1px solid #ccc;"></span>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <p style="margin-bottom:20px; line-height:1.6;">
                    Ta operacja wykona symulację zmiany cen dla <strong>wszystkich obecnie przefiltrowanych i widocznych produktów</strong> (z uwzględnieniem ustawień oraz aktywnego presetu).
                    Zmiany są zapisywane tylko w PriceSafari – nie wpływają na sklep do momentu eksportu.
                </p>

                <hr style="margin-bottom: 20px;">

                <div id="massChangeInfo_Competitiveness" style="display:none;">
                    <h5 style="color: rgba(113, 96, 232, 1); margin-bottom: 15px;">
                        <i class="fa-solid fa-bolt"></i> Tryb Lider Rynku (Traffic Bringers)
                    </h5>
                    <p style="line-height:1.6; margin-bottom: 15px;">
                        Ta strategia służy do walki o jak najlepszą pozycję dla produktów typu <strong>Traffic Bringer</strong> – czyli tych, które przyciągają klienta do sklepu.
                        Twoim celem jest bycie tańszym od najtańszego konkurenta lub zrównanie się z nim.
                    </p>

                    <div style="display:flex; justify-content:space-between; align-items:flex-start; background-color: #f0f4f8; padding: 15px; border-radius: 6px;">
                        <div class="color-square-turquoise" style="margin-top:4px; flex-shrink:0;"></div>
                        <div style="width:100%; margin-left:12px;">
                            <p style="font-weight:bold; margin-bottom:5px;">Mechanizm: Krok cenowy</p>
                            <p style="line-height:1.5; font-size: 14px;">
                                Cena zostanie wyliczona względem <strong>najniższej ceny konkurencji</strong>.
                                <br><br>
                                <strong>Przykład:</strong> Konkurent sprzedaje za 1000 PLN.
                                <ul style="margin-bottom:0; padding-left: 20px;">
                                    <li>Krok <strong>-0.01 PLN</strong>: Twoja cena = 999.99 PLN (Jesteś liderem).</li>
                                    <li>Krok <strong>0.00 PLN</strong>: Twoja cena = 1000.00 PLN (Wyrównanie).</li>
                                    <li>Krok <strong>+0.01 PLN</strong>: Twoja cena = 1000.01 PLN (Minimalnie drożej).</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>

                <div id="massChangeInfo_Profit" style="display:none;">
                    <h5 style="color: #0d2c56; margin-bottom: 15px;"><i class="fa-solid fa-dollar-sign"></i> Tryb Rentowność (Basket Builders)</h5>
                    <p style="line-height:1.6; margin-bottom: 15px;">
                        Ta strategia dedykowana jest produktom budującym wartość koszyka (Upsell/Cross-sell). Klient, który już jest w sklepie, jest skłonny zaakceptować cenę rynkową (średnią), aby dokupić te produkty w jednym zamówieniu.
                        Nie musisz być najtańszy – Twoim celem jest <strong>Mediana Rynku</strong> (środkowa cena rynkowa).
                    </p>

                    <div style="display:flex; justify-content:space-between; align-items:flex-start; background-color: #f0f4f8; padding: 15px; border-radius: 6px;">
                        <div class="color-square-profit" style="margin-top:4px; flex-shrink:0;"></div>
                        <div style="width:100%; margin-left:12px;">
                            <p style="font-weight:bold; margin-bottom:5px;">Mechanizm: Indeks Cenowy (Cel %)</p>
                            <p style="line-height:1.5; font-size: 14px;">
                                Cena zostanie wyliczona jako procent od <strong>Mediany Rynku</strong>.
                                <br><br>
                                <strong>Przykład:</strong> Mediana rynku wynosi 100 PLN.
                                <ul style="margin-bottom:0; padding-left: 20px;">
                                    <li>Indeks <strong>100%</strong>: Twoja cena = 100 PLN (Równasz do środka rynku).</li>
                                    <li>Indeks <strong>95%</strong>: Twoja cena = 95 PLN (Jesteś o 5% tańszy od średniej).</li>
                                    <li>Indeks <strong>105%</strong>: Twoja cena = 105 PLN (Jesteś o 5% droższy od średniej - wysoka marża).</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666;">
                    <p style="margin-bottom: 0;">
                        <i class="fa-solid fa-circle-exclamation"></i> <strong>Ważna uwaga:</strong>
                        System pomija produkty, dla których zatwierdzono już zmianę ceny. Jeżeli wcześniej dodałeś zmiany w trybie
                        <span id="otherModeName" style="font-weight:bold;">[Inny Tryb]</span> dla tych samych produktów, musisz je najpierw usunąć ("Usuń wszystkie zmiany"), aby zastosować nową strategię.
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="justify-content:center; flex-direction: column;">
                <button id="massStrategicBtn" class="Button-Page-Small" style="width:100%; max-width: 550px; height: auto; padding: 10px;">
                </button>
                <div style="margin-top: 5px; font-size: 12px; color: #888;">
                    Kliknięcie zastosuje ustawienia z paska narzędzi (góra strony).
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="marginSettingsModal" tabindex="-1" role="dialog" aria-labelledby="marginSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:800px" role="document">
        <div class="modal-content" style="margin:10% auto;">
            <div class="modal-header">

                <div class="price-box-column-name" id="marginSettingsModalLabel">Konfiguracja symulacji cen</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:48px;">
                    Ustawienia symulacji cenowej pozwalają precyzyjnie określić, dla których produktów oraz w jaki sposób mają być modyfikowane ceny w oparciu o cenę zakupu. Jeśli chcesz, aby symulacja dotyczyła tylko produktów z określoną ceną zakupu, lub aby cena nie spadła poniżej ustalonego poziomu narzutu – skonfiguruj poniższe opcje.
                </p>
                <form id="marginSettingsForm">
                    <div style="display:flex; gap:6px; justify-content: space-between;">
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="identifierForSimulationInput">
                                Element nawigacyjny dla produktów
                            </label>
                            <select class="form-control" id="identifierForSimulationInput">
                                <option value="EAN">EAN</option>
                                <option value="ID">ID</option>
                                <option value="ProducerCode">Kod producenta</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:24px;  width:250px;">
                            <label for="useMarginForSimulationInput">
                                Symuluj tylko produkty posiadające cenę zakupu
                            </label>
                            <select class="form-control" id="useMarginForSimulationInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; justify-content: space-between;">
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="usePriceWithDeliveryInput">
                                Uwzględniaj koszt wysyłki w cenie produktu
                            </label>

                            <select class="form-control" id="usePriceWithDeliveryInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>

                        </div>
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="enforceMinimalMarginInput">
                                Zablokuj możliwość opuszczenia ceny, poniżej ceny zakupu
                            </label>
                            <select class="form-control" id="enforceMinimalMarginInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom:24px;">
                        <label for="minimalMarginPercentInput">
                            Minimalny narzut (%) – procent, poniżej którego cena nie może spaść
                        </label>
                        <input type="number" class="form-control" id="minimalMarginPercentInput" step="0.01" value="0.00">
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small" data-dismiss="modal">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="saveMarginSettingsBtn">Zapisz ustawienia</button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_PresetyPriceComparison.cshtml")

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content" style="width:auto;">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">Informacje</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="gap:10px;">

                <div class="form-check-orders">
                    <div>
                        <p><strong>Wykonanie analizy:</strong> @latestScrap?.Date.ToString("dd.MM.yyyy")</p>
                        <p><strong>Ilość produktów:</strong> @ViewBag.ScrapedProducts</p>
                        <p><strong>Ilość zebranych cen:</strong> <span id="totalPriceCount">0</span></p>
                        <p><strong>Ilość produktów odrzuconych:</strong> <span id="missedProductsCount">0</span></p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_MassAction.cshtml")

<div id="globalNotification" style="
    display: none;
    position: fixed;
    width: 500px;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #F65063;
    color: white;
    padding: 24px;
    text-align: left;

    border-radius: 10px;
    z-index: 1000;
">
</div>

<div id="globalUpdate" style="
    display: none;
    position: fixed;
    width: 500px;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #006400;
    color: white;
    padding: 24px;
    text-align: left;

    border-radius: 10px;
    z-index: 1000;
">
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <script>
        const storeId = @ViewBag.StoreId;
        const isStoreBridgeActive = @Json.Serialize(ViewBag.IsStorePriceBridgeActive ?? false);
        const presetTypeContext = 0; 
        const priceHistoryPageContext = 'index';
        const flags = @Html.Raw(Json.Serialize(ViewBag.Flags ?? new List<FlagViewModel>()));
        const scrapDateJS = "@scrapDate";
        const myStoreNameJS = "@store";
        const globalLatestScrapId = "@scrapId";

        $(document).ready(function () {
            var $usePriceWithDeliveryInput = $('#usePriceWithDeliveryInput');
            var $deliveryDisclaimerModal = $('#deliveryDisclaimerModal');
            var $deliveryDisclaimerConfirmButton = $('#deliveryDisclaimerConfirmButton');
            var $deliveryDisclaimerCancelButton = $('#deliveryDisclaimerCancelButton');
            var originalDeliverySetting = $usePriceWithDeliveryInput.val();

            $usePriceWithDeliveryInput.on('change', function () {
                var selectedValue = $(this).val();

                if (selectedValue === 'true' && originalDeliverySetting === 'false') {

                    $(this).val('false');
                    $deliveryDisclaimerModal.modal('show');
                } else {

                    originalDeliverySetting = selectedValue;
                }
            });

            $deliveryDisclaimerConfirmButton.on('click', function () {

                $usePriceWithDeliveryInput.val('true');
                originalDeliverySetting = 'true';
                $deliveryDisclaimerModal.modal('hide');
            });

            $deliveryDisclaimerCancelButton.on('click', function () {

                $deliveryDisclaimerModal.modal('hide');
            });

            $deliveryDisclaimerModal.on('hidden.bs.modal', function () {

                 if ($usePriceWithDeliveryInput.val() === 'true' && originalDeliverySetting === 'false') {
                     $usePriceWithDeliveryInput.val('false');
                 }
            });

            $('#marginSettingsModal').on('show.bs.modal', function() {
                 originalDeliverySetting = $usePriceWithDeliveryInput.val();
            });

        });

    </script>

    <script src="~/js/member/PriceChange.js" asp-append-version="true"></script>
    <script src="~/js/member/Presets.js" asp-append-version="true"></script>
    <script src="~/js/member/PriceHistory.js" asp-append-version="true"></script>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
    </div>


}