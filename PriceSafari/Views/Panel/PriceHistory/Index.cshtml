@using Newtonsoft.Json

@{
    ViewData["Title"] = "Historia Cen";
    var latestScrap = ViewBag.LatestScrap as PriceSafari.Models.ScrapHistoryClass;
    var storeId = ViewBag.StoreId;
    var storeLogo = ViewBag.StoreLogo;
    var scrapId = ViewBag.ScrapId;
    var flags = ViewBag.Flags as List<PriceSafari.Models.FlagsClass>;
}

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

@{
    var scrapDate = latestScrap?.Date.ToString("dd.MM.yyyy");
    var store = ViewBag.StoreName as string;
}

<style>

    .simulationProductTitle {
        text-decoration: none;
        color: #222222;
    }

        .simulationProductTitle:hover {
            color: #41C7C7;
            cursor: pointer;
        }

    .delivery-indicator {
        display: inline-block;
        padding-left: 8px;
        padding-right: 8px;
        height: 20.5px;
        line-height: 17.5px;
        margin-left: 5px;
        margin-right: 2px;
        border-radius: 4px;
        vertical-align: middle;
        box-sizing: border-box;
    }

        .delivery-indicator i.fa-truck {
            color: white;
            font-size: 14px;
        }

    .delivery-included-green {
        background-color: #28a745;
    }

    .delivery-not-included-red {
        background-color: #dc3545;
    }

</style>

<div class="Vert">
    <div class="Page-Box">
        <div class="Page-Box-Container">
            <div class="Page-Box-Category">
                <div><img src="@storeLogo" class="img-container" /></div>
                <div class="side-chart-box">
                    <canvas id="colorChart"></canvas>
                </div>

                <div class="store-section">

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prOnlyMeCheckbox" value="prOnlyMe">
                        <label class="form-check-label" for="prOnlyMeCheckbox">Solo</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prToHighCheckbox" value="prToHigh">
                        <label class="form-check-label" for="prToHighCheckbox">Zawyżona </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prMidCheckbox" value="prMid">
                        <label class="form-check-label" for="prMidCheckbox">Suboptymalna </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prGoodCheckbox" value="prGood">
                        <label class="form-check-label" for="prGoodCheckbox">Konkurencyjna </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prIdealCheckbox" value="prIdeal">
                        <label class="form-check-label" for="prIdealCheckbox">Strategiczna </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input colorFilter" type="checkbox" id="prToLowCheckbox" value="prToLow">
                        <label class="form-check-label" for="prToLowCheckbox">Zaniżona </label>
                    </div>

                    <div class="price-range-settings">
                        <div class="color-circle prMid-circle"></div>
                        <label for="price2"></label>
                        <input type="number" id="price2" value="@ViewBag.SetPrice2" step="0.01" min="0.01">
                        <span id="unitLabel2"></span>
                    </div>
                    <div class="price-range-settings">
                        <div class="color-circle prIdeal-circle"></div>
                        <label for="price1"></label>
                        <input type="number" id="price1" value="@ViewBag.SetPrice1" step="0.01" min="0.01">
                        <span id="unitLabel1"></span>
                    </div>
                    <div class="price-range-settings">
                        <div class="price-range-settings-stepPrice"></div>
                        <label for="stepPrice"></label>
                        <input type="number" id="stepPrice" value="@ViewBag.PriceStep" step="0.01" min="0.01">
                        <span id="unitLabelStepPrice"></span>
                    </div>

                    <div>
                        <input class="diffCheckBox" style="margin-top: 10px;" type="checkbox" id="usePriceDifference" />

                    </div>
                    <button class="Button-Page-Small" style="margin-top: 2px;" id="savePriceValues">Przelicz</button>
                </div>

                <div class="filterBox">

                    <div class="Category-Container-Select" style="margin-top:-2px;">Flagi <a asp-controller="Flags" asp-action="List" asp-route-storeId="@ViewBag.StoreId" class="link-line">+ Dodaj Flage</a></div>
                    <div class="store-section" id="flagContainer">
                    </div>

                    <div class="Category-Container-Select">Ceneo - Promowanie</div>
                    <div class="store-section">

                        <div class="form-check">
                            <input class="form-check-input bidFilter" type="checkbox" id="bidFilter">
                            <label class="form-check-label" for="bidFilter">Bid</label>
                        </div>

                    </div>
                    <div class="Category-Container-Select">Pozycja</div>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css">

                    <div class="store-section">
                        <div class="position-slider-container">
                            <div id="positionRange" class="position-range-display" style="font-size:14px; font-weight:400;"></div>
                        </div>

                        <div id="positionRangeSlider"></div>
                    </div>

                    <div class="Category-Container-Select">Liczba ofert</div>
                    <div class="store-section">
                        <div class="offer-slider-container">
                            <div id="offerRange" class="offer-range-display" style="font-size:14px; font-weight:400;"></div>
                        </div>

                        <div id="offerRangeSlider"></div>
                    </div>

                    <div class="Category-Container-Select">Ceneo - Twój sklep </div>
                    <div class="store-section">
                        <div class="filter-category">

                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery1MyStore" value="1">
                                <label class="form-check-label" for="delivery1MyStore">Wysyłka w 1 dzień</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery3MyStore" value="3">
                                <label class="form-check-label" for="delivery3MyStore">Wysyłka w 3 dni</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery7MyStore" value="7">
                                <label class="form-check-label" for="delivery7MyStore">Wysyłka w 7 dni</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input deliveryFilterMyStore" type="checkbox" id="delivery14MyStore" value="14">
                                <label class="form-check-label" for="delivery14MyStore">Wysyłka w 14 dni</label>
                            </div>
                        </div>
                        <div class="Category-Container-Select">Ceneo - konkurencja</div>
                        <div class="store-section">
                            <div class="filter-category">

                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery1Competitor" value="1">
                                    <label class="form-check-label" for="delivery1Competitor">Wysyłka w 1 dzień</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery3Competitor" value="3">
                                    <label class="form-check-label" for="delivery3Competitor">Wysyłka w 3 dni</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery7Competitor" value="7">
                                    <label class="form-check-label" for="delivery7Competitor">Wysyłka w 7 dni</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input deliveryFilterCompetitor" type="checkbox" id="delivery14Competitor" value="14">
                                    <label class="form-check-label" for="delivery14Competitor">Wysyłka w 14 dni</label>
                                </div>
                            </div>
                        </div>

                        <div class="Category-Container-Select">Podejrzanie niska cena</div>
                        <div class="store-section">
                            <div class="filter-category">
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="suspiciouslyLowFilter" value="1">
                                    <label class="form-check-label" for="suspiciouslyLowFilter">Pow. 25% odchylenia</label>
                                </div>

                            </div>
                        </div>

                        <div class="Category-Container-Select">Zmieniona cena</div>
                        <div class="store-section">
                            <div class="filter-category">
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="externalPriceYes" value="yes">
                                    <label class="form-check-label" for="externalPriceYes">Tak</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input externalPriceFilter" type="checkbox" id="externalPriceNo" value="no">
                                    <label class="form-check-label" for="externalPriceNo">Nie</label>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            </div>
            <div class="Horizontal">
                <div class="order-upper-box">

                    <input type="text" id="productSearch" style="max-width:150px;" placeholder="Wyszukaj produkt">

                    <input type="text" id="storeSearch" style="max-width:150px;" placeholder="Wyszukaj sklep">

                    <select id="producerFilterDropdown" class="DropDown" style="max-width:150px;">
                        <option value="">Wszystkie marki</option>
                    </select>

                    <button type="button" class="Button-Page-Small" style="white-space: nowrap;" id="presetButton" onclick="openCompetitorsModal()">
                        Presety
                    </button>

                    <button class="Button-Page-Small" style="white-space: nowrap;" id="exportToExcelButton"><i class="fa-solid fa-floppy-disk" style="margin-top:2px;"></i>Eksportuj widok</button>

                    <div class="SimpleSpace" style="justify-content:flex-end;">

                        <button type="button" class="btn-round" style="justify-self:flex-end; margin-right:4px;" data-toggle="modal" data-target="#infoModal">
                            <i class="fa fa-info-circle"></i>
                        </button>
                    </div>

                </div>

                <div id="sortingButtons">
                    <div class="ProductCount" id="displayedProductCount"></div>

                    <div id="paginationContainer"></div>

                    <button id="sortName">A-Z</button>
                    <button id="sortPrice">Cena</button>
                    <button id="sortRaiseAmount">Podnieś PLN</button>
                    <button id="sortRaisePercentage">Podnieś %</button>
                    <button id="sortLowerAmount">Obniż PLN</button>
                    <button id="sortLowerPercentage">Obniż %</button>
                    <button id="sortMarginAmount">Marża PLN</button>
                    <button id="sortMarginPercentage">Marża %</button>
                    <button id="showRejectedButton">Odrzucone</button>
                </div>

                <div class="buttonsContainer">
                    <div id="priceChangeSummary" class="priceChangeSummary">
                        <div id="summaryText"></div>
                        <button id="openMarginSettingsBtn" class="Button-Page-Small"><i class="fa fa-cog" aria-hidden="true"></i></button>
                        <button id="openMassChangeModalBtn" class="Button-Page-Small">
                            <i class="fa fa-cubes" aria-hidden="true"></i>
                        </button>
                        <button id="simulateButton">Symuluj ceny</button>
                    </div>

                </div>
                <div class="Vert-table">
                    <div id="priceContainer" class="price-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-sim fade" id="simulationModal" tabindex="-1" role="dialog" aria-labelledby="simulationModalLabel">
    <div class="modal-dialog-sim" role="document">
        <div class="modal-simulation">
            <div class="modal-header" style="border:none;">
                <div class="price-box-column-name" id="simulationModalLabel">Symuluj ceny</div>

                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-scroll" id="simulationModalBody"></div>
            </div>
            <div class="modal-footer">
                <div style="display:flex; width:100%; justify-content:space-between;">
                    <div style="display:inline-flex;">
                        <button type="button" id="clearChangesButton" class="Button-Page-Small-r">Usuń wszystkie zmiany</button>
                    </div>

                    <div style="display:inline-flex; gap:10px;">

                        <button id="exportToCsvButton" class="Button-Page-Small-bl"><i class="fa-solid fa-file-csv"></i>Eksportuj do CSV</button>
                        <button id="exportNewPriceToExcelButton" class="Button-Page-Small-gr"><i class="fas fa-file-excel"></i>Eksportuj do Excela</button>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exportDisclaimerModal" tabindex="-1" role="dialog" aria-labelledby="exportDisclaimerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:460px;">
            <div class="modal-header">
                <div class="price-box-column-name" id="exportDisclaimerModalLabel">Ostrzeżenie</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>
                    Nie ponosimy odpowiedzialności za możliwe błędne powiązania między produktami z programu PriceSafari
                    a dostarczonym feedem XML. Prosimy sprawdzić przed eksportem danych dokładność powiązań
                    i wprowadzać zmiany na własną odpowiedzialność. Wyeksportowanie zmian nie wprowadza żadnych zmian odnośnie
                    cen produktów w sklepie, dopóki użytkownik sam ich nie zaimportuje.
                </p>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small-r" data-dismiss="modal">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="disclaimerConfirmButton">Kontynuuj</button>
            </div>
        </div>
    </div>
</div>

@* --- START: NOWY MODAL DISCLAIMERA DLA WYSYŁKI --- *@
<div class="modal fade" id="deliveryDisclaimerModal" tabindex="-1" role="dialog" aria-labelledby="deliveryDisclaimerModalLabel" aria-hidden="true" style="z-index: 8555;">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:460px;">
            <div class="modal-header">
                <div class="price-box-column-name" id="deliveryDisclaimerModalLabel">Ważna informacja</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>
                    Włączenie opcji "Uwzględniaj koszt wysyłki w cenie produktu" może znacząco wpłynąć na wyniki symulacji cen.
                    System będzie porównywał ceny produktów wraz z kosztem wysyłki, co może prowadzić do innych sugestii cenowych niż przy porównaniu samych cen produktów.
                    <br /><br />
                    Pamiętaj, że koszt wysyłki jest wartością szacunkową i może się różnić w zależności od gabarytów, wagi produktu oraz wybranej metody dostawy przez klienta.
                    Symulacja z kosztem wysyłki jest przybliżona i służy celom poglądowym.
                    <br /><br />
                    [Tutaj możesz dodać swoją, bardziej szczegółową informację o konsekwencjach]
                </p>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small-r" data-dismiss="modal" id="deliveryDisclaimerCancelButton">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="deliveryDisclaimerConfirmButton">Kontynuuj</button>
            </div>
        </div>
    </div>
</div>
@* --- END: NOWY MODAL DISCLAIMERA DLA WYSYŁKI --- *@


<div class="modal fade" id="massChangeModal" tabindex="-1" role="dialog" aria-labelledby="massChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="massChangeModalLabel">Masowa zmiana cen</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:36px;">
                    Kliknięcie przycisku przeniesie wyświetlone obecnie produkty do wybranej grupy cenowej. Przeniesione zostaną jedynie produkty, które posiadają przynajmniej jedną ofertę konkurencyjną oraz kod EAN. Aby ograniczyć wyświetlaną grupę produktów, skorzystaj z filtrów.
                </p>

                <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
                    <div class="color-square-green" style="margin:0px;"></div>
                    <p style="width:500px;">
                        Cena konkurencyjna oznacza, że Twoja oferta zrówna się ceną z inną lub innymi najtańszymi ofertami.
                    </p>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    <div class="color-square-turquoise" style="margin:0px;"></div>
                    <p style="width:500px;">
                        Cena strategiczna oznacza, że Twoja oferta będzie najtańsza dla danego produktu oraz tańsza od konkurencji o określony krok cenowy.
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="justify-content:center;">
                <button id="massMatchBtn" class="Button-Page-Small" style="width:300px;">
                    Przenieś do ceny konkurencyjnej →<div class="color-square-green" style="margin:0px;"></div>
                </button>
                <button id="massStrategicBtn" class="Button-Page-Small" style="width:300px;">
                    Przenieś do ceny strategicznej →<div class="color-square-turquoise" style="margin:0px;"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="marginSettingsModal" tabindex="-1" role="dialog" aria-labelledby="marginSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">

                <div class="price-box-column-name" id="marginSettingsModalLabel">Konfiguracja symulacji cen</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:48px;">
                    Ustawienia symulacji marżowej umożliwiają precyzyjne określenie, dla których produktów oraz w jaki sposób mają być modyfikowane ceny w oparciu o cenę zakupu. Jeśli chcesz, aby symulacja dotyczyła tylko produktów z określoną ceną zakupu, lub aby cena nie spadła poniżej ustalonego poziomu marży – skonfiguruj poniższe opcje.
                </p>
                <form id="marginSettingsForm">
                    <div style="display:flex; gap:6px; justify-content: space-between;">
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="useEanForSimulation">
                                Element nawigacyjny dla produktów
                            </label>
                            <select class="form-control" id="useEanForSimulationInput">
                                <option value="true">EAN</option>
                                <option value="false">ID</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:24px;  width:250px;">
                            <label for="useMarginForSimulationInput">
                                Symuluj tylko produkty posiadające cenę zakupu
                            </label>
                            <select class="form-control" id="useMarginForSimulationInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; justify-content: space-between;">
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="usePriceWithDeliveryInput">
                                Uwzględniaj koszt wysyłki w cenie produktu
                            </label>
                            @* --- TEN SELECT BĘDZIE OBSŁUGIWANY PRZEZ JS DLA DISCLAIMERA --- *@
                            <select class="form-control" id="usePriceWithDeliveryInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                            @* ------------------------------------------------------------ *@
                        </div>
                        <div class="form-group" style="margin-bottom:24px; width:250px;">
                            <label for="enforceMinimalMarginInput">
                                Zablokuj możliwość opuszczenia ceny, poniżej ceny zakupu
                            </label>
                            <select class="form-control" id="enforceMinimalMarginInput">
                                <option value="true">Tak</option>
                                <option value="false">Nie</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom:24px;">
                        <label for="minimalMarginPercentInput">
                            Minimalna marża (%) – procent, poniżej którego cena nie może spaść
                        </label>
                        <input type="number" class="form-control" id="minimalMarginPercentInput" step="0.01" value="0.00">
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="justify-content:space-between;">
                <button type="button" class="Button-Page-Small" data-dismiss="modal">Anuluj</button>
                <button type="button" class="Button-Page-Small-bl" id="saveMarginSettingsBtn">Zapisz ustawienia</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-sim fade" id="competitorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog-sim" role="document">
        <div class="modal-simulation">

            <div class="modal-header">

                <div class="price-box-column-name">Presety</div>

                <div style="display:flex; gap:10px;">

                    <button id="addNewPresetBtn" class="Button-Page-Small-bl">Dodaj nowy preset</button>
                    <button type="button" class="close" data-dismiss="modal" style="width:33px; height:33px;" aria-label="Zamknij">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

            </div>

            <div class="modal-body">

                <div style="display:flex; justify-content:space-between; gap:24px;">

                    <div style="display:flex; flex-direction:column;">
                        <select id="presetSelect" style="width:460px;" class="DropDown"></select>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; width:460px;">
                            <div>

                                <span id="activateButtonContainer"></span>

                            </div>
                            <div style="display:flex; gap:5px;">
                                <span id="editButtonContainer"></span>
                                <span id="deleteButtonContainer"></span>
                            </div>
                        </div>

                        <div id="newPresetSection" style="display:none; margin-bottom: 20px;">
                        </div>

                        <div style="display:flex; flex-direction:column; width:460px; border: 1px solid #EDEDED; padding:16px; border-radius:4px; margin-top:12px;">

                            <input type="text" id="competitorSearchInput" class="storeSearch" placeholder="Wyszukaj sklep konkurenta" />

                            <div style="display:flex; justify-content:space-between">
                                <div>
                                    <div class="Category-Container-Select">Źródło danych</div>
                                    <div class="store-section">

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="googleCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="googleCheckbox"><img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px; align-self:center; margin-right:6px;">Google</label>
                                        </div>

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="ceneoCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="ceneoCheckbox"><img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px; align-self:center; margin-right:6px;">Ceneo</label>
                                        </div>
                                    </div>
                                </div>
                                <div>

                                    <div class="Category-Container-Select">Niezdefiniowane sklepy</div>
                                    <div class="store-section">

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="useUnmarkedStoresCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="useUnmarkedStoresCheckbox">Wyświetlaj</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div style="display:flex; flex-direction:column; width:460px; margin-top:24px;">

                            <p style="margin-bottom:24px; font-size:15px;">
                                <strong>Presety umożliwiają filtrowanie wyświetlanych sklepów na podstawie zaawansowanych filtrów.</strong><br><br>
                                Aktywny preset automatycznie wpływa na widok główny – ukrywa lub pokazuje wybrane sklepy.
                                Jeśli wykluczysz np. Allegro, to nawet jeśli oferuje najniższą cenę, nie zostanie pokazane. System wybierze kolejny najtańszy sklep.
                                Opcja "Niezdefiniowane sklepy" pozwala masowo ustawić, czy wyświetlać sklepy, które nie mają przypisanej widoczności.
                            </p>

                            <div style="display:flex; margin-bottom:12px; font-size:15px;">
                                <div class="filterCompetitors-true" style="margin-right:8px;"><i class="fas fa-check"></i></div>
                                <p>
                                    Kliknij aby wyświetlać dany sklep.
                                </p>
                            </div>
                            <div style="display:flex; margin-bottom:12px; font-size:15px;">
                                <div class="filterCompetitors-false" style="margin-right:8px;"><i class="fas fa-times"></i></div>
                                <p>
                                    Kliknij aby ukryć dany sklep.
                                </p>
                            </div>

                            <div style="display:flex; margin-bottom:0px; font-size:15px;">
                                <div class="filterCompetitors-back" style="margin-right:8px;"><i class="fas fa-undo"></i></div>
                                <p>
                                    Cofnij zmianę dla wybranego sklepu.
                                </p>
                            </div>

                            <p style="margin-top:24px; font-size:15px;">
                                Wszystkie sklepy oznaczone kolorem jasnozielonym lub zielonym będą wyświetlane.
                                Sklepy oznaczone kolorem jasnoczerwonym lub czerwonym będą ukryte.
                                Kolor szary oznacza, że sklepy z danego źródła danych nie będą wyświetlane.
                            </p>

                        </div>

                    </div>
                    <div style="display: flex;
           flex-wrap: nowrap;
           gap: 24px;
           width: 100%;
           align-items: stretch;
           justify-content: space-between;">

                        <div style="flex: 1;">
                            <div class="table-scroll"
                                 style="max-height: 80vh;
                   min-height: 80vh;
                   overflow: auto;">
                                <table class="table-orders"
                                       style="width: 100%;
                      min-width: 500px;
                      white-space: nowrap;
                      table-layout: auto;">
                                    <thead>
                                        <tr>
                                            <th>
                                                <img src="/images/GoogleShopping.png"
                                                     alt="Google Icon"
                                                     style="width:17px; height:17px; margin-right:6px; margin-bottom:4px;">
                                                Sklepy Google
                                            </th>
                                            <th>Produkty</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="googleCompetitorsTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div style="flex: 1;">
                            <div class="table-scroll"
                                 style="max-height: 80vh;
                   min-height: 80vh;
                   overflow: auto;">
                                <table class="table-orders"
                                       style="width: 100%;
                      min-width: 500px;
                      white-space: nowrap;
                      table-layout: auto;">
                                    <thead>
                                        <tr>
                                            <th>
                                                <img src="/images/Ceneo.png"
                                                     alt="Ceneo Icon"
                                                     style="width:17px; height:17px; margin-right:4px; margin-bottom:4px;">
                                                Sklepy Ceneo
                                            </th>
                                            <th>Produkty</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ceneoCompetitorsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content" style="width:auto;">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">Informacje</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="gap:10px;">

                <div class="form-check-orders">
                    <div>
                        <p><strong>Wykonanie analizy:</strong> @latestScrap?.Date.ToString("dd.MM.yyyy")</p>
                        <p><strong>Ilość produktów:</strong> @ViewBag.ScrapedProducts</p>
                        <p><strong>Ilość zebranych cen:</strong> <span id="totalPriceCount">0</span></p>
                        <p><strong>Ilość produktów odrzuconych:</strong> <span id="missedProductsCount">0</span></p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="globalNotification" style="
    display: none;
    position: fixed;
    width: 500px;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #F65063;
    color: white;
    padding: 24px;
    text-align: left;

    border-radius: 10px;
    z-index: 1000;
">
</div>

<div id="globalUpdate" style="
    display: none;
    position: fixed;
    width: 500px;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #006400;
    color: white;
    padding: 24px;
    text-align: left;

    border-radius: 10px;
    z-index: 1000;
">
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <script>
        var priceHistoryPageContext = 'index';
        var storeId = '@storeId';
        var flags = (function(){
            return @Html.Raw(JsonConvert.SerializeObject(ViewBag.Flags));
        })();
        var scrapDateJS = "@scrapDate";
        var myStoreNameJS = "@store";
        var globalLatestScrapId = "@scrapId";

        // --- NOWY KOD JS DLA DISCLAIMERA WYSYŁKI ---
        $(document).ready(function () {
            var $usePriceWithDeliveryInput = $('#usePriceWithDeliveryInput');
            var $deliveryDisclaimerModal = $('#deliveryDisclaimerModal');
            var $deliveryDisclaimerConfirmButton = $('#deliveryDisclaimerConfirmButton');
            var $deliveryDisclaimerCancelButton = $('#deliveryDisclaimerCancelButton');
            var originalDeliverySetting = $usePriceWithDeliveryInput.val(); // Zapamiętaj początkowe ustawienie

            $usePriceWithDeliveryInput.on('change', function () {
                var selectedValue = $(this).val();

                if (selectedValue === 'true' && originalDeliverySetting === 'false') {
                    // Użytkownik próbuje włączyć opcję
                    // Cofnij zmianę na chwilę, pokaż modal
                    $(this).val('false');
                    $deliveryDisclaimerModal.modal('show');
                } else {
                    // Użytkownik wyłącza opcję lub była już włączona, nie rób nic specjalnego
                    originalDeliverySetting = selectedValue; // Zaktualizuj stan
                }
            });

            // Obsługa przycisku "Kontynuuj" w modal disclaimera
            $deliveryDisclaimerConfirmButton.on('click', function () {
                // Zastosuj zmianę w selekcie ustawień
                $usePriceWithDeliveryInput.val('true');
                originalDeliverySetting = 'true'; // Zaktualizuj stan
                $deliveryDisclaimerModal.modal('hide'); // Zamknij modal disclaimera
            });

            // Obsługa przycisku "Anuluj" i zamknięcia modala disclaimera
            $deliveryDisclaimerCancelButton.on('click', function () {
                // Select już jest ustawiony na 'false' przez handler 'change'
                $deliveryDisclaimerModal.modal('hide'); // Zamknij modal disclaimera
            });

             // Dodatkowa obsługa zamknięcia modala disclaimera przyciskiem X
            $deliveryDisclaimerModal.on('hidden.bs.modal', function () {
                 // Upewnij się, że select wraca do 'false' jeśli modal został zamknięty bez potwierdzenia
                 if ($usePriceWithDeliveryInput.val() === 'true' && originalDeliverySetting === 'false') {
                     $usePriceWithDeliveryInput.val('false');
                 }
            });

             // Zapamiętaj stan przy otwarciu modala ustawień, żeby poprawnie działało cofanie
            $('#marginSettingsModal').on('show.bs.modal', function() {
                 originalDeliverySetting = $usePriceWithDeliveryInput.val();
            });

        });
        // --- KONIEC NOWEGO KODU JS ---

    </script>

    <script src="~/js/member/PriceChange.js"></script>
    <script src="~/js/member/CompetitorModal.js"></script>
    <script src="~/js/member/PriceHistory.js"></script>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <div id="flagModal" class="modal">
        <div class="modal-content">
            <div class="price-box-space">
                <div class="price-box-column-name">Przypisz flagi do produktu</div>

            </div>
            <div id="flagCheckboxes">
                @if (flags != null)
                {
                    @foreach (var flag in flags)
                    {
                        <label><input type="checkbox" class="form-check-input flagCheckbox" value="@flag.FlagId"> @flag.FlagName</label>
                        <br />
                    }
                }
            </div>
            <button class="Button-Page-Small" id="saveFlagsButton">Zapisz</button>
        </div>
    </div>
}