@* @model PriceSafari.Models.ProductClass
@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    ViewData["Title"] = "Historia ceny w czasie (AJAX) – oś category";
}

<h2>Historia cen w czasie - @Model.ProductName</h2>

<div id="chartContainer"></div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            let productId = @Model.ProductId;

            $.ajax({
                url: '@Url.Action("GetPriceTrendData", "PriceHistory")',
                type: 'GET',
                data: { productId: productId },
                success: function(response) {
                    // Zwraca: { productName, timelineData }
                    console.log("Otrzymane dane JSON:", response);
                    buildCategoryChart(response.timelineData);
                },
                error: function(err) {
                    console.error("Błąd przy pobieraniu danych:", err);
                }
            });

            function buildCategoryChart(timelineData) {
                // Usuwamy stary/placeholder i wstawiamy nasz canvas
                $("#chartContainer").html('<canvas id="timelineChart" width="1000" height="400"></canvas>');
                const ctx = document.getElementById('timelineChart').getContext('2d');

                // 1. Zbierzmy wszystkie daty
                let allDatesSet = new Set();
                timelineData.forEach(entry => {
                    allDatesSet.add(entry.scrapDate);
                });
                let allDates = Array.from(allDatesSet);
                // sortujemy alfabetycznie, bo to YYYY-MM-DD
                allDates.sort();

                // 2. Zbierzmy wszystkie sklepy
                let allStoresSet = new Set();
                timelineData.forEach(entry => {
                    entry.pricesByStore.forEach(ps => allStoresSet.add(ps.storeName));
                });
                let allStores = Array.from(allStoresSet);

                // 3. Zbudujmy mapę (date -> (store -> price))
                let priceMap = {};
                timelineData.forEach(entry => {
                    let date = entry.scrapDate;
                    if (!priceMap[date]) {
                        priceMap[date] = {};
                    }
                    entry.pricesByStore.forEach(ps => {
                        priceMap[date][ps.storeName] = ps.price;
                    });
                });

                // 4. Budujemy datasets: każdy sklep -> tablica cen w kolejności allDates
                let datasets = allStores.map(store => {
                    let dataArray = allDates.map(date => {
                        let mapForDate = priceMap[date] || {};
                        return (mapForDate[store] !== undefined) ? mapForDate[store] : null;
                    });
                    return {
                        label: store,
                        data: dataArray,
                        borderWidth: 2,
                        borderColor: getRandomColor(),
                        fill: false,
                        tension: 0.1
                    };
                });

                // 5. Inicjalizacja wykresu
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allDates,    // <= OŚ X jako kategorie
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'category',  // <=== klucz
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Cena PLN'
                                },
                                ticks: {
                                    callback: function (value) {
                                        return value + ' PLN';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) {
                                        let label = ctx.dataset.label || '';
                                        if (label) label += ': ';
                                        label += ctx.parsed.y + ' PLN';
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Generowanie losowych kolorów
            function getRandomColor() {
                const r = Math.floor(Math.random() * 255);
                const g = Math.floor(Math.random() * 255);
                const b = Math.floor(Math.random() * 255);
                return `rgba(${r}, ${g}, ${b}, 1)`;
            }
        });
    </script>
} *@
