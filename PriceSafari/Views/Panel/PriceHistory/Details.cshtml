@model IEnumerable<PriceSafari.Models.PriceHistoryClass>

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}
@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    ViewData["Title"] = "Szczegóły Cen";

    var scrapHistory = ViewBag.ScrapHistory as PriceSafari.Models.ScrapHistoryClass;
    var productName = ViewBag.ProductName as string;
    var storeName = ViewBag.StoreName as string;
    var url = ViewBag.Url;
    var googleUrl = ViewBag.GoogleUrl;
    var setPrice1 = ViewBag.SetPrice1;
    var setPrice2 = ViewBag.SetPrice2;
    var externalUrl = ViewBag.ExternalUrl as string;
    var img = ViewBag.Img as string;
    decimal basePrice = 0;

    var myStorePrice = Model.FirstOrDefault(p => string.Equals(p.StoreName, storeName, StringComparison.OrdinalIgnoreCase));
    if (myStorePrice != null)
    {
        basePrice = myStorePrice.Price;
    }
}



<div class="Vert" data-store-name="@storeName">
    <div class="Page-Box">
        <div style="font-weight: 300; font-size: 22px;">
            @productName
        </div>
      
        <div class="form-check-orders" style="margin-bottom:16px;">
            <div>
                <p><strong>Wykonano:</strong> @scrapHistory?.Date.ToString("dd.MM.yyyy")</p>
            </div>
        </div>
        <div class="price-box-space" style="gap:32px;">
            <div style="display:flex; width:100%; gap:48px; margin-bottom:8px;">
                @if (!string.IsNullOrEmpty(img))
                {
                    <div style="display:flex; ">
                        <img src="@img" style="height: 130px; width: 130px;" />
                    </div>
                }
                <div class="price-box-column-name" style="align-content:flex-end;">



                    <div class="store-section">
                        <div class="form-check">
                            <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPrice" value="price" checked>
                            <label class="form-check-label" for="sortPrice">Sortuj po cenie</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPosition" value="position">
                            <label class="form-check-label" for="sortPosition">Sortuj po pozycji Ceneo</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortGooglePosition" value="googlePosition">
                            <label class="form-check-label" for="sortGooglePosition">Sortuj po pozycji Google</label>
                        </div>


                    </div>
                    <div style="margin-top: 16px;">


                        @if (!string.IsNullOrEmpty(googleUrl))
                        {
                            <a href="@googleUrl" class="Button-Page-Small-bl" target="_blank">
                                Google
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(url))
                        {
                            <a href="@url" class="Button-Page-Small-o" target="_blank">
                                Ceneo
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(externalUrl))
                        {
                            <a href="@externalUrl" class="Button-Page-Small" target="_blank">
                                Twoja strona
                            </a>
                        }



                        <!-- Dwa przyciski do przełączania widoków -->
                        <button type="button" class="Button-Page-Small-r" style="margin-left:8px;" id="showTableBtn">
                            Pokaż ceny
                        </button>
                        <button type="button" class="Button-Page-Small-r" style="margin-left:8px;" id="showChartBtn">
                            Pokaż wykres
                        </button>

                        <button type="button" class="Button-Page-Small-r" id="editExternalIdButton">
                            API ID @ViewBag.ApiId
                        </button>

                    </div>

                </div>
               
            </div>
            <div style="display:flex; width:50%; height:130px; align-self:flex-end; margin-right:14px;">
                <canvas id="priceChart" width="100" height="100"></canvas>
            </div>

           
        </div>

        <!-- 1. Kontener z TABELĄ (domyślnie widoczny) -->
        <div id="priceTableContainer" class="Vert-table" style="display: block;">
            <table class="table-orders" id="priceTable">
                <thead>
                    <tr>
                        <th></th>
                        <th>Sklep (@Model.Count())</th>
                        <th>Cena</th>
                        <th>Różnica</th>
                        <th>Pozycja</th>
                        <th>Bid</th>
                        <th>Koszt wysyłki</th>
                        <th>Dostępność</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                   
                    @foreach (var item in Model)
                    {
                        var priceDifference = item.Price - Model.Min(m => m.Price);
                        var isUniqueBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) == 1;
                        var isSharedBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) > 1;
                        var savings = isUniqueBestPrice ? Model.Where(m => m.Price > item.Price).OrderBy(m => m.Price).FirstOrDefault()?.Price - item.Price : (decimal?)null;

                        decimal priceDifferencePLN = item.Price - basePrice;
                        decimal percentageDifference = (basePrice > 0) ? ((item.Price - basePrice) / basePrice) * 100 : 0;

                        string getColorClass(decimal priceDifference, bool isUniqueBestPrice, bool isSharedBestPrice, decimal? savings)
                        {
                            if (isUniqueBestPrice && savings >= 0.01m && savings <= setPrice1)
                            {
                                return "prIdeal";
                            }
                            if (isUniqueBestPrice)
                            {
                                return "prToLow";
                            }
                            if (isSharedBestPrice)
                            {
                                return "prGood";
                            }
                            if (priceDifference <= 0)
                            {
                                return "prGood";
                            }
                            else if (priceDifference < setPrice2)
                            {
                                return "prMid";
                            }
                            else
                            {
                                return "prToHigh";
                            }
                        }

                        var colorClass = getColorClass(priceDifference, isUniqueBestPrice, isSharedBestPrice, savings);
                        var shippingCost = item.ShippingCostNum == 0 ? "Free" : $"{item.ShippingCostNum - item.Price} PLN";

                        string getAvailabilityClass(int? availabilityNum)
                        {
                            if (availabilityNum == null)
                            {
                                return "BD";
                            }
                            if (availabilityNum == 1)
                            {
                                return "Availability1Day";
                            }
                            if (availabilityNum == 3)
                            {
                                return "Availability3Days";
                            }
                            if (availabilityNum == 7)
                            {
                                return "Availability7Days";
                            }
                            if (availabilityNum == 14)
                            {
                                return "Availability14Days";
                            }

                            return "";
                        }

                        var availabilityClass = getAvailabilityClass(item.AvailabilityNum);

                        <tr class="price-row @colorClass" data-store-name="@item.StoreName" data-price="@item.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)" data-position="@item.Position">
                            <td>
                                <div class="color-bar @colorClass"></div>
                            </td>

                            <td class="store-name">
                                @item.StoreName
                            </td>


                            <td class="store-price">@item.Price PLN</td>
                            <td>
                                @if (item.StoreName != storeName && priceDifferencePLN != 0)
                                {
                                    var priceDiffFormatted = priceDifferencePLN.ToString("+#,##0.00;-#,##0.00") + " PLN";
                                    var percentageDiffFormatted = percentageDifference.ToString("+#,##0.00;-#,##0.00") + " %";

                                    var diffText = $"{priceDiffFormatted} ({percentageDiffFormatted})";

                                    if (priceDifferencePLN < 0)
                                    {
                                        <div class="priceBox-diff-up">@diffText</div>
                                    }
                                    else if (priceDifferencePLN > 0)
                                    {
                                        <div class="priceBox-diff-down">@diffText</div>
                                    }
                                    else
                                    {
                                        <div class="priceBox-diff-neutral">@diffText</div>
                                    }
                                }
                                else
                                {
                                    <div class="priceBox-diff-neutral">0,00 PLN (0,00 %)</div>
                                }
                            </td>
                            <td>
                                @if (item.Position != null)
                                {
                                    @if (item.IsGoogle == true)
                                    {
                                        <div class="Position-Google">Poz. Google @item.Position</div>
                                    }
                                    else
                                    {
                                        <div class="Position">Poz. Ceneo @item.Position</div>
                                    }
                                }
                                else
                                {
                                    <div class="Position" style="background-color: #414141;">Schowany</div>
                                }
                            </td>



                            <td>
                                @if (item.IsBidding == "1")
                                {
                                    <div class="Bidding">Bid</div>
                                }
                            </td>
                            <td>
                                @if (item.ShippingCostNum == null)
                                {
                                    <div class="BD">Brak danych</div>
                                }
                                else if (item.ShippingCostNum == 0)
                                {
                                    <div class="FreeShipping">Free</div>
                                }
                                else
                                {
                                    <div class="PaidShipping">@shippingCost</div>
                                }
                            </td>
                            <td>
                                <div class="@availabilityClass">
                                    @if (item.AvailabilityNum == 1)
                                    {
                                        <div>Wysyłka w 1 dzień</div>
                                    }
                                    else if (item.AvailabilityNum == 3)
                                    {
                                        <div>Wysyłka w 3 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 7)
                                    {
                                        <div>Wysyłka w 7 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 14)
                                    {
                                        <div>Wysyłka w 14 dni</div>
                                    }
                                    else if (item.AvailabilityNum == null)
                                    {
                                        <div>Brak danych</div>
                                    }
                                </div>
                            </td>
                            <td class="data-chanel">
                                <img src="@Url.Content(item.IsGoogle ? "~/images/GoogleShopping.png" : "~/images/Ceneo.png")" alt="Channel Icon" style="width:24px; height:24px;" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
        <!-- Kontener WYKRESU + TOOLTIPA -->
        <div id="trendChartContainer"
             style="
       display: none;       /* na starcie ukryte */
       flex-direction: row;
       width: 100%;
       height: 600px;       /* lub 'max-height: 600px;' */
       gap: 48px;
       margin-top: 20px;
     ">
            <!-- Lewa kolumna: wykres -->
            <div style="
       max-width: 70%;
       min-width: 0;
       display: flex;
       flex-direction: column;
       height: 100%;
     ">
                <!-- Kontener z płynną wysokością na wykres -->
                <div style="
         flex: 1 1 auto;
         min-height: 0;
         /* background: #fafafa; (opcjonalne) */
       ">
                    <canvas id="trendChart"
                            style="
          max-width: 100%;
          height: 100%;
          border: 1px solid #ccc;
        "></canvas>
                </div>

                <!-- Suwak (przezroczystość) pod wykresem -->
                <div style="margin-top: 8px;">
                    <label for="grayAlphaRange">Przezroczystość linii:</label>
                    <input type="range"
                           id="grayAlphaRange"
                           min="0"
                           max="1"
                           step="0.1"
                           value="0.4"
                           style="width: 200px;">
                </div>
            </div>

            <!-- Prawa kolumna: tooltip -->
            <div id="customTrendTooltip"
                 style="
         width: 400px;
         height: 60vh;
         overflow-y: auto;
         padding: 8px;
         background: #fefefe;
         border: 1px solid #ccc;
         font-size: 0.9rem;
         display: none;
       ">
                <!-- tu wstawiasz tabelkę generowaną przez JS -->
            </div>
        </div>



    </div>
</div>

<div class="modal fade" id="editExternalIdModal" tabindex="-1" role="dialog" aria-labelledby="editExternalIdModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="editExternalIdModalLabel">Edytuj API ID produktu</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editExternalIdForm">
                    <div class="form-group" style="margin-bottom:16px;">
                        <label for="editExternalId" class="control-label">API Product ID</label>
                        <input type="text" id="editExternalId" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="Button-Page-Small-r" id="deleteExternalId">Usuń API ID</button>
                <button type="button" class="Button-Page-Small-b" id="saveExternalIdChanges">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
      // 2. Rejestrujemy plugin
      Chart.register(window['chartjs-plugin-annotation']);
    </script>



    <script>
        // Definicja zmiennej JS na podstawie ViewBag
        var pricesData = @Html.Raw(ViewBag.PricesDataJson ?? "[]");

        var chart;

        document.addEventListener("DOMContentLoaded", function () {
            const rows = Array.from(document.querySelectorAll(".price-row"));
            const observedStoreName = document.querySelector(".Vert").getAttribute("data-store-name").toLowerCase().trim();

            function highlightObservedStore() {
                rows.forEach(function (row) {
                    const storeName = row.getAttribute("data-store-name").toLowerCase().trim();
                    if (storeName === observedStoreName) {
                        row.querySelector(".store-name").style.fontWeight = "bold";
                        row.querySelector(".store-price").style.fontWeight = "bold";
                    } else {
                        row.querySelector(".store-name").style.fontWeight = "normal";
                        row.querySelector(".store-price").style.fontWeight = "normal";
                    }
                });
            }

            function sortRowsByPosition() {
                rows.sort((a, b) => {
                    const isGoogleA = a.querySelector(".Position-Google") !== null; // Sprawdzamy klasę `Position-Google`
                    const isGoogleB = b.querySelector(".Position-Google") !== null;

                    const posA = parseInt(a.getAttribute("data-position")) || Infinity; // Ukryte pozycje -> Infinity
                    const posB = parseInt(b.getAttribute("data-position")) || Infinity;

                    // 1. Najpierw sortujemy pozycje Ceneo (bez `Position-Google`)
                    if (!isGoogleA && isGoogleB) return -1; // Ceneo przed Google
                    if (isGoogleA && !isGoogleB) return 1;  // Google za Ceneo

                    // 2. Sortujemy schowane pozycje (null position) na końcu każdej grupy
                    if (posA === Infinity && posB !== Infinity) return 1;
                    if (posA !== Infinity && posB === Infinity) return -1;

                    // 3. Sortowanie wewnątrz grup według pozycji
                    return posA - posB;
                });

                const tbody = document.querySelector("#priceTable tbody");
                rows.forEach(row => tbody.appendChild(row));
                highlightObservedStore(); // Podświetlanie po sortowaniu
            }

                   function sortRowsByPrice() {
            rows.sort((a, b) => {
                let priceA = parseFloat(a.getAttribute("data-price"));
                let priceB = parseFloat(b.getAttribute("data-price"));

                if (isNaN(priceA)) priceA = Infinity;
                if (isNaN(priceB)) priceB = Infinity;

                // Sprawdzamy czy ceny są takie same
                if (priceA === priceB) {
                    const storeA = a.getAttribute("data-store-name").toLowerCase();
                    const storeB = b.getAttribute("data-store-name").toLowerCase();
                    return storeA.localeCompare(storeB); // Sortowanie alfabetyczne w przypadku remisu
                }

                return priceA - priceB; // Sortowanie po cenie
            });

            const tbody = document.querySelector("#priceTable tbody");
            rows.forEach(row => tbody.appendChild(row));
            highlightObservedStore();
        }


            function sortRowsByGooglePosition() {
                rows.sort((a, b) => {
                    const isGoogleA = a.querySelector(".Position-Google") !== null; // Sprawdzamy klasę `Position-Google`
                    const isGoogleB = b.querySelector(".Position-Google") !== null;

                    const posA = parseInt(a.getAttribute("data-position")) || Infinity;
                    const posB = parseInt(b.getAttribute("data-position")) || Infinity;

                    // 1. Najpierw sortujemy pozycje Google (`Position-Google`), potem Ceneo
                    if (!isGoogleA && isGoogleB) return 1;  // Ceneo za Google
                    if (isGoogleA && !isGoogleB) return -1; // Google przed Ceneo

                  
                    return posA - posB;
                });

                const tbody = document.querySelector("#priceTable tbody");
                rows.forEach(row => tbody.appendChild(row));
                highlightObservedStore(); 
            }

            function handleSortChange(event) {
                if (event.target.id === "sortPrice") {
                    sortRowsByPrice();
                } else if (event.target.id === "sortPosition") {
                    sortRowsByPosition();
                } else if (event.target.id === "sortGooglePosition") {
                    sortRowsByGooglePosition();
                }
            }

            // Obsługa kliknięć w przyciski sortowania
            document.getElementById("sortPrice").addEventListener("click", handleSortChange);
            document.getElementById("sortPosition").addEventListener("click", handleSortChange);
            document.getElementById("sortGooglePosition").addEventListener("click", handleSortChange);

            // Domyślne sortowanie po cenie
            sortRowsByPrice();
            highlightObservedStore(); // Podświetlanie po załadowaniu


       
            var myStoreName = "@storeName";

            createChart(pricesData, myStoreName);
        });


        function createChart(pricesData, myStore) {
            const sortedData = pricesData.sort((a, b) => b.price - a.price);
            const sortedPrices = sortedData.map(item => item.price);
            const sortedStores = sortedData.map(item => item.store);
            const myStoreNormalized = myStore.toLowerCase().trim();

            const barColors = sortedData.map(item => {
                const storeNormalized = item.store.toLowerCase().trim();
                if (storeNormalized === myStoreNormalized) {
                    if (item.isBidding === "Google") {
                        return 'rgba(72, 142, 255, 0.6)';
                    } else {
                        return 'rgba(255, 100, 0, 0.6)';
                    }
                }
                return 'rgba(34, 34, 34, 0.4)';
            });

            const borderColors = sortedData.map(item => {
                const storeNormalized = item.store.toLowerCase().trim();
                if (storeNormalized === myStoreNormalized) {
                    if (item.isBidding === "Google") {
                        return 'rgba(72, 142, 255, 1)';
                    } else {
                        return 'rgba(255, 100, 0, 1)';
                    }
                }
                return 'rgba(34, 34, 34, 1)';
            });

            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedStores,
                    datasets: [{
                        label: 'Cena PLN',
                        data: sortedPrices,
                        backgroundColor: barColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + ' PLN';
                                }
                            }
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

    </script>
    <script>
        $(document).ready(function () {
            $('#editExternalIdButton').on('click', function () {
                var externalId = '@(ViewBag.ExternalId ?? "")';
                $('#editExternalId').val(externalId);
                $('#editExternalIdModal').modal('show');
            });

            $('#saveExternalIdChanges').on('click', function () {
                var externalId = $('#editExternalId').val();
                $.ajax({
                    url: '@Url.Action("UpdateExternalId", "PriceHistory")',
                    type: 'POST',
                    data: {
                        productId: @ViewBag.ProductId,
                        externalId: externalId,
                    },
                    success: function () {
                        $('#editExternalIdModal').modal('hide');
                        location.reload();
                    },
                    error: function () {
                        alert('Error updating External Id');
                    }
                });
            });

            $('#deleteExternalId').on('click', function () {
                $.ajax({
                    url: '@Url.Action("DeleteExternalId", "PriceHistory")',
                    type: 'POST',
                    data: {
                        productId: @ViewBag.ProductId
                            },
                    success: function () {
                        $('#editExternalIdModal').modal('hide');
                        location.reload();
                    },
                    error: function () {
                        alert('Error deleting External Id');
                    }
                });
            });
        });
    </script>
    <script>
        // 1. Na starcie
        let productId = @ViewBag.ProductId;
        let myStoreLower = "@storeName".toLowerCase().trim();

        // Maksymalnie 6 highlightów
        let highlightedStores = [];
        let storeColorMap = {};

        // 6 kolorów:
        const highlightColors = [
          'rgba(54, 162, 235, 1)',   // niebieski
          'rgba(255, 128, 0, 1)',   // pomarańcz
          'rgba(153, 102, 255, 1)', // fiolet
          'rgba(100, 200, 100, 1)', // zieleń
          'rgba(255, 51, 153, 1)',  // róż
          'rgba(139, 0, 0, 1)'      // ciemnoczerwony
        ];

        // Domyślny alpha dla szarych linii
        let defaultGrayAlpha = 0.4;

        document.addEventListener("DOMContentLoaded", function() {
            const $showTableBtn = $('#showTableBtn');
            const $showChartBtn = $('#showChartBtn');
            const $tableContainer = $('#priceTableContainer');
            const $chartContainer = $('#trendChartContainer');

            $showTableBtn.on('click', function() {
                $chartContainer.hide();
                $tableContainer.show();
            });

            $showChartBtn.on('click', function() {
                $tableContainer.hide();
                $chartContainer.show();
                loadTrendDataAndDrawChart();
            });

            // Suwak do regulacji alpha dla szarych linii
            const grayAlphaRange = document.getElementById("grayAlphaRange");
            if (grayAlphaRange) {
                grayAlphaRange.addEventListener("input", function(e) {
                    defaultGrayAlpha = parseFloat(e.target.value);
                    // Odśwież linie z nową przezroczystością
                    updateHighlightedLines();
                });
            }

            $('#showOnlyMyStoreBtn').on('click', function() {
                if (window.trendChartRef) {
                    let myStore = "@storeName".toLowerCase().trim();
                    window.trendChartRef.data.datasets.forEach(ds => {
                        ds.hidden = (ds.label.toLowerCase().trim() !== myStore);
                    });
                    window.trendChartRef.update();
                }
            });

            $('#showAllStoresBtn').on('click', function() {
                if (window.trendChartRef) {
                    window.trendChartRef.data.datasets.forEach(ds => {
                        ds.hidden = false;
                    });
                    window.trendChartRef.update();
                }
            });
        });

        // 2. AJAX -> rysowanie wykresu
        function loadTrendDataAndDrawChart() {
            $.ajax({
                url: '@Url.Action("GetPriceTrendData", "PriceHistory")',
                type: 'GET',
                data: { productId: productId },
                success: function(response) {
                    drawTrendChart(response.timelineData);
                },
                error: function() {
                    alert("Błąd pobierania danych trendu!");
                }
            });
        }

        // 3. Funkcja tworząca wykres
        function drawTrendChart(timelineData) {
            const ctx = document.getElementById("trendChart").getContext("2d");
            if (window.trendChartRef) {
                window.trendChartRef.destroy();
            }

            let allDatesSet = new Set();
            timelineData.forEach(item => allDatesSet.add(item.scrapDate));
            let allDates = Array.from(allDatesSet).sort();

            let allStoresSet = new Set();
            timelineData.forEach(item => {
                item.pricesByStore.forEach(ps => allStoresSet.add(ps.storeName));
            });
            let allStores = Array.from(allStoresSet);

            let priceMap = {};
            timelineData.forEach(entry => {
                let date = entry.scrapDate;
                if (!priceMap[date]) {
                    priceMap[date] = {};
                }
                entry.pricesByStore.forEach(ps => {
                    priceMap[date][ps.storeName] = {
                        price: ps.price,
                        source: ps.source
                    };
                });
            });

            let myStore = "@storeName".toLowerCase().trim();

            // Budujemy datasets
            let datasets = allStores.map(store => {
                let dataArray = [];
                let sourceArray = [];

                allDates.forEach(date => {
                    let obj = priceMap[date][store];
                    if (obj) {
                        dataArray.push(obj.price);
                        sourceArray.push(obj.source);
                    } else {
                        dataArray.push(null);
                        sourceArray.push(null);
                    }
                });

                // Domyślna szara linia (z alpha)
                let lineColor = `rgba(128,128,128,${defaultGrayAlpha})`;
                let lineWidth = 2;

                // Jeśli to nasz sklep -> czarny
                if (store.toLowerCase().trim() === myStore) {
                    lineColor = 'rgba(0,0,0,1)';
                    lineWidth = 2;
                }

                return {
                    label: store,
                    data: dataArray,
                    sourceByIndex: sourceArray,
                    originalBorderColor: lineColor,
                    borderColor: lineColor,
                    borderWidth: lineWidth,
                    fill: false,
                
                    spanGaps: true,
                    pointRadius: 0,
                    pointHoverRadius: 0
                };
            });

            const defaultXValue = allDates[allDates.length - 1] || null;

            window.trendChartRef = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    animation: { duration: 0 },
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Data' },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.06)'
                            }
                        },
                        y: {
                            title: { display: true, text: 'Cena PLN' },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.06)'
                            }
                        }
                    },
                    onHover: function(e) {
                        e.native.target.style.cursor = 'crosshair';
                    },
                    onClick: function(evt, elements, chart) {
                        // Crosshair
                        if (!chart.data.labels.length) return;
                        const canvasPos = Chart.helpers.getRelativePosition(evt, chart);
                        const xScale = chart.scales.x;
                        const labels = chart.data.labels;

                        let floatIndex = xScale.getValueForPixel(canvasPos.x);
                        let nearestIndex = Math.round(floatIndex);
                        if (nearestIndex < 0) nearestIndex = 0;
                        if (nearestIndex >= labels.length) {
                            nearestIndex = labels.length - 1;
                        }
                        let xLabel = labels[nearestIndex] || null;
                        if (!xLabel) return;

                        chart.config.options.plugins.annotation.annotations.crosshairLine.value = nearestIndex;
                        chart.update();

                        refreshCustomTooltip(chart, xLabel);
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                        axis: 'x'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false,
                            external: externalTooltipHandler
                        },
                        annotation: {
                            annotations: {
                                crosshairLine: {
                                    type: 'line',
                                    mode: 'vertical',
                                    scaleID: 'x',
                                    value: null,
                                    borderColor: 'rgba(80,80,80,1)',
                                    borderWidth: 2,
                                    borderDash: [4,2],
                                    hitRadius: 8,
                                    draggable: true,
                                    adjustScaleRange: false,
                                    display: (ctx) => {
                                        return ctx.chart.config.options.plugins.annotation.annotations.crosshairLine.value != null;
                                    },
                                    enter: (ctx) => {
                                        ctx.chart.canvas.style.cursor = 'crosshair';
                                    },
                                    leave: (ctx) => {
                                        ctx.chart.canvas.style.cursor = 'default';
                                    },
                                    onDragStart: (ctx) => {
                                        ctx.chart.canvas.style.cursor = 'crosshair';
                                    },
                                    onDragEnd: (ctx) => {
                                        ctx.chart.canvas.style.cursor = 'default';
                                    },
                                    onDrag: (ctx) => {
                                        const chart = ctx.chart;
                                        const labels = chart.data.labels;
                                        let floatIndex = ctx.element.value;
                                        let nearestIndex = Math.round(floatIndex);
                                        if (nearestIndex < 0) nearestIndex = 0;
                                        if (nearestIndex >= labels.length) nearestIndex = labels.length - 1;

                                        let xLabel = labels[nearestIndex];
                                        if (!xLabel) return;

                                        refreshCustomTooltip(chart, xLabel);
                                        chart.update('none');
                                    }
                                }
                            }
                        }
                    }
                }
            });

            if (defaultXValue) {
                let idxDefault = window.trendChartRef.data.labels.indexOf(defaultXValue);
                if (idxDefault < 0) idxDefault = 0;
                window.trendChartRef.config.options.plugins.annotation.annotations.crosshairLine.value = idxDefault;
                window.trendChartRef.update();

                refreshCustomTooltip(window.trendChartRef, defaultXValue);
            }
        }

        // 4. Custom tooltip (klikalny)
              function refreshCustomTooltip(chart, xLabel) {
          window.currentTooltipDate = xLabel;

          const labels = chart.data.labels;
          const idx = labels.indexOf(xLabel);
          if (idx < 0) return;

          let items = [];
          chart.data.datasets.forEach(ds => {
            if (ds.hidden) return;
            const priceVal = ds.data[idx];
            const sourceVal = ds.sourceByIndex[idx];
            if (priceVal != null) {
              items.push({
                storeName: ds.label,
                price: priceVal,
                source: sourceVal
              });
            }
          });

          // Sortujemy dane w tooltipie
          items.sort((a, b) => {
            if (a.price !== b.price) return a.price - b.price;
            return a.storeName.localeCompare(b.storeName);
          });

          const tooltipEl = document.getElementById('customTrendTooltip');
          if (!tooltipEl) return;

          // Nagłówek z datą
          let html = `
            <div style="font-weight:bold; margin-bottom:4px;">
              Data: ${xLabel}
            </div>
            <table style="width:100%; border-collapse:collapse;">
          `;

          // Wypełniamy wiersze tabelki
          items.forEach(item => {
            const storeLower = item.storeName.toLowerCase().trim();
            const isHighlighted = (highlightedStores.indexOf(storeLower) >= 0);

            let colorText = 'black';
            if (isHighlighted && storeColorMap[storeLower] != null) {
              const cIndex = storeColorMap[storeLower];
              colorText = highlightColors[cIndex];
            }

            // Czy to nasz sklep?
            const isMyStore = (storeLower === myStoreLower);
            let fontWeight = (isMyStore || isHighlighted) ? 'bold' : 'normal';

            let iconHtml = (item.source === 'google')
              ? `<img src="/images/GoogleShopping.png" alt="Google" style="width:16px;height:16px;margin-right:4px;" />`
              : `<img src="/images/Ceneo.png" alt="Ceneo" style="width:16px;height:16px;margin-right:4px;" />`;

            html += `
              <tr style="border-bottom:1px solid #eee; cursor:pointer;"
                  onclick="toggleStoreHighlight('${item.storeName.replace("'", "\\'")}')">
                <td style="padding:2px; color:${colorText}; font-weight:${fontWeight};">
                  ${iconHtml} ${item.storeName}
                </td>
                <td style="padding:2px; text-align:right; color:${colorText}; font-weight:${fontWeight};">
                  ${item.price} PLN
                </td>
              </tr>
            `;
          });

          html += `</table>`;

          // Wstawiamy HTML do tooltipa
          tooltipEl.innerHTML = html;

          // Pokazujemy tooltip, jeżeli mamy jakieś elementy do wyświetlenia
          tooltipEl.style.display = items.length ? 'block' : 'none';
        }


        function externalTooltipHandler(context) {
            const { tooltip } = context;
            const tooltipEl = document.getElementById('customTrendTooltip');
            if (!tooltip || tooltip.opacity === 0) {
                return;
            }
        }

        // LOGIKA HIGHLIGHT (max 6 sklepów)
        function toggleStoreHighlight(storeName) {
            let sLower = storeName.toLowerCase().trim();
            let idx = highlightedStores.indexOf(sLower);

            if (idx >= 0) {
                // usuwamy
                highlightedStores.splice(idx, 1);
                storeColorMap[sLower] = null;
            } else {
                if (highlightedStores.length >= 6) {
                    alert("Możesz zaznaczyć maks. 6 sklepów do porównania!");
                    return;
                }
                let cIndex = findNextFreeColorIndex();
                if (cIndex === null) {
                    alert("Brak wolnych kolorów!");
                    return;
                }
                highlightedStores.push(sLower);
                storeColorMap[sLower] = cIndex;
            }

            updateHighlightedLines();

            if (window.trendChartRef && window.currentTooltipDate) {
                refreshCustomTooltip(window.trendChartRef, window.currentTooltipDate);
            }
        }

        function findNextFreeColorIndex() {
            for (let i = 0; i < highlightColors.length; i++) {
                let used = false;
                for (let s in storeColorMap) {
                    if (storeColorMap[s] === i) {
                        used = true;
                        break;
                    }
                }
                if (!used) {
                    return i;
                }
            }
            return null;
        }

        function updateHighlightedLines() {
            if (!window.trendChartRef) return;
            let chart = window.trendChartRef;

            chart.data.datasets.forEach(ds => {
                if (!ds.originalBorderColor) {
                    ds.originalBorderColor = ds.borderColor;
                }

                let storeLower = ds.label.toLowerCase().trim();
                let cIndex = storeColorMap[storeLower];
                let isHighlighted = (highlightedStores.indexOf(storeLower) >= 0);
                let isOurStore = (storeLower === myStoreLower);

                if (isHighlighted && cIndex != null) {
                    // Zaznaczone => pastelowy kolor + alpha=1
                    ds.borderColor = highlightColors[cIndex];
                } else if (isOurStore) {
                    // Nasz sklep => zawsze czarny, alpha=1
                    ds.borderColor = 'rgba(0,0,0,1)';
                } else {
                    // Inne szare => alpha = defaultGrayAlpha
                    // Zakładamy oryginalny kolor to np. szary, podmieniamy w nim alpha
                    ds.borderColor = `rgba(128,128,128,${defaultGrayAlpha})`;
                }
            });

            chart.update('none');
        }
    </script>




}

