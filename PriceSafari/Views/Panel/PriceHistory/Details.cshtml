@model IEnumerable<PriceSafari.Models.PriceHistoryClass>

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    ViewData["Title"] = "Szczegóły Cen";
    var storeId = ViewBag.StoreId;
    var scrapHistory = ViewBag.ScrapHistory as PriceSafari.Models.ScrapHistoryClass;
    var productName = ViewBag.ProductName as string;
    var storeName = ViewBag.StoreName as string;
    var url = ViewBag.Url;
    var googleUrl = ViewBag.GoogleUrl;
    var setPrice1 = ViewBag.SetPrice1;
    var setPrice2 = ViewBag.SetPrice2;
    var externalUrl = ViewBag.ExternalUrl as string;
    var img = ViewBag.Img as string;
    decimal basePrice = 0;

    var totalOffers = Model.Count();
    var googleOffers = Model.Count(x => x.IsGoogle == true);
    var ceneoOffers = totalOffers - googleOffers;

    var myStorePrice = Model.FirstOrDefault(p => string.Equals(p.StoreName, storeName, StringComparison.OrdinalIgnoreCase));
    if (myStorePrice != null)
    {
        basePrice = myStorePrice.Price;
    }
}

<style>

    .price-trend-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 25px;
    }

    .price-trend__main-panel {
        flex: 1;
        min-width: 480px;
        display: flex;
        flex-direction: column;
        height: 65vh;
    }

    .price-trend__chart-area {
        width: 100%;
        flex-grow: 1;
        min-height: 300px;
        position: relative;
        margin-bottom: 10px;
    }

    .price-trend__controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
        align-self: center;
        justify-self: center;
        width: 93%;
        box-sizing: border-box;
        flex-shrink: 0;
    }

    .price-trend__alpha-slider-wrapper {
        flex-grow: 1;
        margin-right: 20px;
        display: flex;
        align-items: center;
        max-width: 300px;
    }

        .price-trend__alpha-slider-wrapper input[type=range] {
            width: 100%;
            cursor: pointer;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
        }

            .price-trend__alpha-slider-wrapper input[type=range]:hover {
                opacity: 1;
            }

            .price-trend__alpha-slider-wrapper input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                background: #444;
                border-radius: 50%;
                cursor: pointer;
            }

            .price-trend__alpha-slider-wrapper input[type=range]::-moz-range-thumb {
                width: 18px;
                height: 18px;
                background: #444;
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }

    #exportExcelBtn {
        white-space: nowrap;
        flex-shrink: 0;
    }

    .price-trend__tooltip-panel {
        flex-basis: 340px;
        flex-shrink: 0;
        border-left: 1px solid #e0e0e0;
        padding-left: 20px;
        overflow-y: auto;
    }
</style>

<div class="Vert" data-store-name="@storeName">
    <div class="Page-Box">
        <div style="display:flex; width:100%; justify-content:space-between;">
            <div style="font-weight: 300; font-size: 22px;">
                @productName
            </div>
            <div style="margin-top:4px;">
                <button type="button" id="showTableBtn" class="button-active">
                    Ranking
                </button>
                <button type="button" id="showChartBtn" class="button-inactive">
                    Wykres
                </button>
            </div>
        </div>

        <div class="form-check-orders" style="margin-bottom:16px;">

            <div>
                <p><strong>Wykonano:</strong> @scrapHistory?.Date.ToString("dd.MM.yyyy")</p>
            </div>
        </div>
        <div class="price-box-space" style="gap:32px;">
            <div style="display:flex; width:100%; gap:48px; margin-bottom:8px;">
                @if (!string.IsNullOrEmpty(img))
                {
                    <div style="display:flex;">
                        <img src="@img" style="height: 130px; width: 130px;" />
                    </div>
                }

                <div class="price-box-column-name" style="align-content:flex-end;">
                    <div class="store-section">
                        <!-- Zawsze wyświetlamy sortowanie po cenie -->
                        <div class="form-check">
                            <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPrice" value="price" checked>
                            <label class="form-check-label" for="sortPrice">Sortuj po cenie</label>
                        </div>
                        @if (googleOffers > 0 && ceneoOffers > 0)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPosition" value="position">
                                <label class="form-check-label" for="sortPosition">Sortuj po pozycji Ceneo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortGooglePosition" value="googlePosition">
                                <label class="form-check-label" for="sortGooglePosition">Sortuj po pozycji Google</label>
                            </div>
                        }
                        else if (googleOffers == totalOffers)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortGooglePosition" value="googlePosition">
                                <label class="form-check-label" for="sortGooglePosition">Sortuj po pozycji Google</label>
                            </div>
                        }
                        else if (ceneoOffers == totalOffers)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPosition" value="position">
                                <label class="form-check-label" for="sortPosition">Sortuj po pozycji Ceneo</label>
                            </div>
                        }
                    </div>
                    <div style="margin-top: 16px; display:flex; justify-content:center; gap:6px;">
                        <button type="button" class="Button-Page-Small" style="white-space: nowrap;" id="presetButton" onclick="openCompetitorsModal()">

                            @if (!string.IsNullOrEmpty(ViewBag.ActivePresetName))
                            {

                                <span id="activePresetDisplay">
                                    Presety - @ViewBag.ActivePresetName
                                </span>
                            }
                            else
                            {

                                <span id="activePresetDisplay">
                                    Presety - Widok PriceSafari
                                </span>
                            }
                        </button>
                        @if (!string.IsNullOrEmpty(googleUrl))
                        {
                            <a href="@googleUrl" class="Button-Page-Small" target="_blank">
                                <img src="~/images/GoogleShopping.png" alt="Channel Icon" style="width:18px; height:18px;" /> Google
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(url))
                        {
                            <a href="@url" class="Button-Page-Small" target="_blank">
                                <img src="~/images/Ceneo.png" alt="Channel Icon" style="width:18px; height:18px;" /> Ceneo
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(externalUrl))
                        {
                            <a href="@externalUrl" class="Button-Page-Small" target="_blank">
                                <img src="~/images/Click-b.svg" alt="Channel Icon" style="width:20px; height:20px;" /> Strona
                            </a>
                        }
                    </div>
                </div>
            </div>
            <div style="display:flex; width:50%; height:130px; align-self:flex-end; margin-right:14px;">
                <canvas id="priceChart" width="100" height="100"></canvas>
            </div>
        </div>


        <div id="priceTableContainer" class="Vert-table" style="display: block;">
            <table class="table-orders" id="priceTable">
                <thead>
                    <tr>
                        <th></th>
                      
                        <th id="storeHeader">Sklep (@totalOffers)</th>
                        <th>Cena</th>
                        <th>Różnica</th>
                        <th>Pozycja</th>
                        <th>Bid</th>
                        <th>Koszt wysyłki</th>
                        <th>Dostępność</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var priceDifference = item.Price - Model.Min(m => m.Price);
                        var isUniqueBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) == 1;
                        var isSharedBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) > 1;
                        var savings = isUniqueBestPrice ? Model.Where(m => m.Price > item.Price).OrderBy(m => m.Price).FirstOrDefault()?.Price - item.Price : (decimal?)null;

                        decimal priceDifferencePLN = item.Price - basePrice;
                        decimal percentageDifference = (basePrice > 0) ? ((item.Price - basePrice) / basePrice) * 100 : 0;

                        string getColorClass(decimal priceDifference, bool isUniqueBestPrice, bool isSharedBestPrice, decimal? savings)
                        {
                            if (isUniqueBestPrice && savings >= 0.01m && savings <= setPrice1)
                            {
                                return "prIdeal";
                            }
                            if (isUniqueBestPrice)
                            {
                                return "prToLow";
                            }
                            if (isSharedBestPrice)
                            {
                                return "prGood";
                            }
                            if (priceDifference <= 0)
                            {
                                return "prGood";
                            }
                            else if (priceDifference < setPrice2)
                            {
                                return "prMid";
                            }
                            else
                            {
                                return "prToHigh";
                            }
                        }

                        var colorClass = getColorClass(priceDifference, isUniqueBestPrice, isSharedBestPrice, savings);
                        var shippingCost = ""; // Zmienna do przechowywania tekstu wyświetlanego w tabeli
                        if (item.ShippingCostNum == null)
                        {
                            shippingCost = "Brak danych";
                        }
                        else if (item.ShippingCostNum == 0)
                        {
                            shippingCost = "Free";
                        }
                        else // Gdy ShippingCostNum > 0 (teraz już wiemy, że to koszt wysyłki)
                        {
                            shippingCost = $"{item.ShippingCostNum} PLN"; // <--- TERAZ ZAWSZE WYŚWIETLAMY WARTOSĆ BEZPOŚREDNIO
                        }

                        string getAvailabilityClass(int? availabilityNum)
                        {
                            if (availabilityNum == null)
                            {
                                return "BD";
                            }
                            if (availabilityNum == 1)
                            {
                                return "Availability1Day";
                            }
                            if (availabilityNum == 3)
                            {
                                return "Availability3Days";
                            }
                            if (availabilityNum == 7)
                            {
                                return "Availability7Days";
                            }
                            if (availabilityNum == 14)
                            {
                                return "Availability14Days";
                            }
                            return "";
                        }

                        var availabilityClass = getAvailabilityClass(item.AvailabilityNum);

                        <tr class="price-row @colorClass" data-store-name="@item.StoreName" data-price="@item.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)" data-position="@item.Position">
                            <td>
                                <div class="color-bar @colorClass"></div>
                            </td>
                            <td class="store-name">
                                @item.StoreName
                            </td>
                            <td class="store-price">@item.Price PLN</td>
                            <td>
                                @if (item.StoreName != storeName && priceDifferencePLN != 0)
                                {
                                    var priceDiffFormatted = priceDifferencePLN.ToString("+#,##0.00;-#,##0.00") + " PLN";
                                    var percentageDiffFormatted = percentageDifference.ToString("+#,##0.00;-#,##0.00") + " %";
                                    var diffText = $"{priceDiffFormatted} ({percentageDiffFormatted})";
                                    if (priceDifferencePLN < 0)
                                    {
                                        <div class="priceBox-diff-up">@diffText</div>
                                    }
                                    else if (priceDifferencePLN > 0)
                                    {
                                        <div class="priceBox-diff-down">@diffText</div>
                                    }
                                    else
                                    {
                                        <div class="priceBox-diff-neutral">@diffText</div>
                                    }
                                }
                                else
                                {
                                    <div class="priceBox-diff-neutral">0,00 PLN (0,00 %)</div>
                                }
                            </td>
                            <td>
                                @if (item.Position != null)
                                {
                                    @if (item.IsGoogle == true)
                                    {
                                        <div class="Position-Google">Poz. Google @item.Position</div>
                                    }
                                    else
                                    {
                                        <div class="Position">Poz. Ceneo @item.Position</div>
                                    }
                                }
                                else
                                {
                                    <div class="Position" style="background-color: #414141;">Schowany</div>
                                }
                            </td>
                            <td>
                                @if (item.IsBidding == "1")
                                {
                                    <div class="Bidding">Bid</div>
                                }
                            </td>
                            <td>
                                @if (item.ShippingCostNum == null)
                                {
                                    <div class="BD">Brak danych</div>
                                }
                                else if (item.ShippingCostNum == 0)
                                {
                                    <div class="FreeShipping">Free</div>
                                }
                                else
                                {
                                    <div class="PaidShipping">@shippingCost</div>
                                }
                            </td>
                            <td>
                                <div class="@availabilityClass">
                                    @if (item.AvailabilityNum == 1)
                                    {
                                        <div>Wysyłka w 1 dzień</div>
                                    }
                                    else if (item.AvailabilityNum == 3)
                                    {
                                        <div>Wysyłka w 3 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 7)
                                    {
                                        <div>Wysyłka w 7 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 14)
                                    {
                                        <div>Wysyłka w 14 dni</div>
                                    }
                                    else if (item.AvailabilityNum == null)
                                    {
                                        <div>Brak danych</div>
                                    }
                                </div>
                            </td>
                            <td class="data-chanel">
                                <img src="@Url.Content(item.IsGoogle ? "~/images/GoogleShopping.png" : "~/images/Ceneo.png")" alt="Channel Icon" style="width:24px; height:24px;" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div id="trendChartContainer" class="price-trend-section">
            <div class="price-trend__main-panel">
                <div class="price-trend__chart-area">
                    <div id="trendChart" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="price-trend__controls">
                    <div class="price-trend__alpha-slider-wrapper">
                        <input type="range"
                               id="grayAlphaRange"
                               min="0"
                               max="0.6"
                               step="0.01"
                               value="0.3">
                    </div>
                    <button type="button" id="exportExcelBtn" class="Button-Page-Small" title="Eksportuj dane historii cen do pliku Excel">
                        <i class="fas fa-file-excel" style="margin-right: 5px;"></i> Excel
                    </button>
                </div>
            </div>
            <div id="customTrendTooltip" class="price-trend__tooltip-panel">
            </div>
        </div>
    </div>
</div>

<div class="modal-sim fade" id="competitorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog-sim" role="document">
        <div class="modal-simulation">

            <div class="modal-header">

                <div class="price-box-column-name">Presety</div>

                <div style="display:flex; gap:10px;">

                    <button id="addNewPresetBtn" class="Button-Page-Small-bl">Dodaj nowy preset</button>
                    <button type="button" class="close" data-dismiss="modal" style="width:33px; height:33px;" aria-label="Zamknij">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

            </div>

            <div class="modal-body">

                <div style="display:flex; justify-content:space-between; gap:24px;">

                    <div style="display:flex; flex-direction:column;">
                        <select id="presetSelect" style="width:460px;" class="DropDown"></select>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; width:460px;">
                            <div>

                                <span id="activateButtonContainer"></span>

                            </div>
                            <div style="display:flex; gap:5px;">
                                <span id="editButtonContainer"></span>
                                <span id="deleteButtonContainer"></span>
                            </div>
                        </div>

                        <div id="newPresetSection" style="display:none; margin-bottom: 20px;">
                        </div>

                        <div style="display:flex; flex-direction:column; width:460px; border: 1px solid #EDEDED; padding:16px; border-radius:4px; margin-top:12px;">

                            <input type="text" id="competitorSearchInput" class="storeSearch" placeholder="Wyszukaj sklep konkurenta" />

                            <div style="display:flex; justify-content:space-between">
                                <div>
                                    <div class="Category-Container-Select">Źródło danych</div>
                                    <div class="store-section">

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="googleCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="googleCheckbox"><img src="/images/GoogleShopping.png" alt="Google Icon" style="width:16px; height:16px; align-self:center; margin-right:6px;">Google</label>
                                        </div>

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="ceneoCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="ceneoCheckbox"><img src="/images/Ceneo.png" alt="Ceneo Icon" style="width:16px; height:16px; align-self:center; margin-right:6px;">Ceneo</label>
                                        </div>
                                    </div>
                                </div>
                                <div>

                                    <div class="Category-Container-Select">Niezdefiniowane sklepy</div>
                                    <div class="store-section">

                                        <div class="form-check">
                                            <input class="form-check-input bidFilter" type="checkbox" id="useUnmarkedStoresCheckbox">
                                            <label class="form-check-label" style="display:flex; justify-content:center;" for="useUnmarkedStoresCheckbox">Wyświetlaj</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div style="display:flex; flex-direction:column; width:460px; margin-top:24px;">

                            <p style="margin-bottom:24px; font-size:15px;">
                                <strong>Presety umożliwiają filtrowanie wyświetlanych sklepów na podstawie zaawansowanych filtrów.</strong><br><br>
                                Aktywny preset automatycznie wpływa na widok główny – ukrywa lub pokazuje wybrane sklepy.
                                Jeśli wykluczysz np. Allegro, to nawet jeśli oferuje najniższą cenę, nie zostanie pokazane. System wybierze kolejny najtańszy sklep.
                                Opcja "Niezdefiniowane sklepy" pozwala masowo ustawić, czy wyświetlać sklepy, które nie mają przypisanej widoczności.
                            </p>

                            <div style="display:flex; margin-bottom:12px; font-size:15px;">
                                <div class="filterCompetitors-true" style="margin-right:8px;"><i class="fas fa-check"></i></div>
                                <p>
                                    Kliknij aby wyświetlać dany sklep.
                                </p>
                            </div>
                            <div style="display:flex; margin-bottom:12px; font-size:15px;">
                                <div class="filterCompetitors-false" style="margin-right:8px;"><i class="fas fa-times"></i></div>
                                <p>
                                    Kliknij aby ukryć dany sklep.
                                </p>
                            </div>

                            <div style="display:flex; margin-bottom:0px; font-size:15px;">
                                <div class="filterCompetitors-back" style="margin-right:8px;"><i class="fas fa-undo"></i></div>
                                <p>
                                    Cofnij zmianę dla wybranego sklepu.
                                </p>
                            </div>

                            <p style="margin-top:24px; font-size:15px;">
                                Wszystkie sklepy oznaczone kolorem jasnozielonym lub zielonym będą wyświetlane.
                                Sklepy oznaczone kolorem jasnoczerwonym lub czerwonym będą ukryte.
                                Kolor szary oznacza, że sklepy z danego źródła danych nie będą wyświetlane.
                            </p>

                        </div>

                    </div>
                    <div style="display: flex;
            flex-wrap: nowrap;
            gap: 24px;
            width: 100%;
            align-items: stretch;
            justify-content: space-between;">

                        <div style="flex: 1;">
                            <div class="table-scroll"
                                 style="max-height: 80vh;
                    min-height: 80vh;
                    overflow: auto;">
                                <table class="table-orders"
                                       style="width: 100%;
                          min-width: 500px;
                          white-space: nowrap;
                          table-layout: auto;">
                                    <thead>
                                        <tr>
                                            <th>
                                                <img src="/images/GoogleShopping.png"
                                                     alt="Google Icon"
                                                     style="width:17px; height:17px; margin-right:6px; margin-bottom:4px;">
                                                Sklepy Google
                                            </th>
                                            <th>Produkty</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="googleCompetitorsTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div style="flex: 1;">
                            <div class="table-scroll"
                                 style="max-height: 80vh;
                    min-height: 80vh;
                    overflow: auto;">
                                <table class="table-orders"
                                       style="width: 100%;
                          min-width: 500px;
                          white-space: nowrap;
                          table-layout: auto;">
                                    <thead>
                                        <tr>
                                            <th>
                                                <img src="/images/Ceneo.png"
                                                     alt="Ceneo Icon"
                                                     style="width:17px; height:17px; margin-right:4px; margin-bottom:4px;">
                                                Sklepy Ceneo
                                            </th>
                                            <th>Produkty</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ceneoCompetitorsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script>
    Chart.register(window['chartjs-plugin-annotation']);
</script>

<script>
    var priceHistoryPageContext = 'details';
       var storeId = '@storeId';
</script>
<script src="~/js/member/CompetitorModal.js"></script>

<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loader"></div>
</div>

<script>

    var pricesData = @Html.Raw(ViewBag.PricesDataJson ?? "[]");
    var chart;

    document.addEventListener("DOMContentLoaded", function () {

        const rows = Array.from(document.querySelectorAll(".price-row"));
        const observedStoreName = document.querySelector(".Vert").getAttribute("data-store-name").toLowerCase().trim();
        const headerEl = document.getElementById("storeHeader");

        function highlightObservedStore() {
            rows.forEach(function (row) {
                const storeName = row.getAttribute("data-store-name").toLowerCase().trim();
                if (storeName === observedStoreName) {
                    row.querySelector(".store-name").style.fontWeight = "bold";
                    row.querySelector(".store-price").style.fontWeight = "bold";
                } else {
                    row.querySelector(".store-name").style.fontWeight = "normal";
                    row.querySelector(".store-price").style.fontWeight = "normal";
                }
            });
        }

        function sortRowsByPrice() {

            rows.forEach(row => row.style.display = '');
            rows.sort((a, b) => {
                let priceA = parseFloat(a.getAttribute("data-price"));
                let priceB = parseFloat(b.getAttribute("data-price"));
                if (isNaN(priceA)) priceA = Infinity;
                if (isNaN(priceB)) priceB = Infinity;
                if (priceA === priceB) {
                    const storeA = a.getAttribute("data-store-name").toLowerCase();
                    const storeB = b.getAttribute("data-store-name").toLowerCase();
                    return storeA.localeCompare(storeB);
                }
                return priceA - priceB;
            });
            const tbody = document.querySelector("#priceTable tbody");
            rows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + rows.length + ")";
            highlightObservedStore();
        }

        function sortRowsByCeneoPosition() {

            const filteredRows = rows.filter(row => row.querySelector(".Position-Google") === null);
            filteredRows.sort((a, b) => {
                const posA = parseInt(a.getAttribute("data-position")) || Infinity;
                const posB = parseInt(b.getAttribute("data-position")) || Infinity;
                return posA - posB;
            });

            rows.forEach(row => {
                row.style.display = filteredRows.indexOf(row) === -1 ? 'none' : '';
            });
            const tbody = document.querySelector("#priceTable tbody");
            filteredRows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + filteredRows.length + " - Ceneo)";
            highlightObservedStore();
        }

        function sortRowsByGooglePosition() {

            const filteredRows = rows.filter(row => row.querySelector(".Position-Google") !== null);
            filteredRows.sort((a, b) => {
                const posA = parseInt(a.getAttribute("data-position")) || Infinity;
                const posB = parseInt(b.getAttribute("data-position")) || Infinity;
                return posA - posB;
            });

            rows.forEach(row => {
                row.style.display = filteredRows.indexOf(row) === -1 ? 'none' : '';
            });
            const tbody = document.querySelector("#priceTable tbody");
            filteredRows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + filteredRows.length + " - Google)";
            highlightObservedStore();
        }

        function handleSortChange(event) {
            if (event.target.id === "sortPrice") {
                sortRowsByPrice();
            } else if (event.target.id === "sortPosition") {
                sortRowsByCeneoPosition();
            } else if (event.target.id === "sortGooglePosition") {
                sortRowsByGooglePosition();
            }
        }

        document.getElementById("sortPrice").addEventListener("click", handleSortChange);

        if(document.getElementById("sortPosition")){
            document.getElementById("sortPosition").addEventListener("click", handleSortChange);
        }
        if(document.getElementById("sortGooglePosition")){
            document.getElementById("sortGooglePosition").addEventListener("click", handleSortChange);
        }

        sortRowsByPrice();
        highlightObservedStore();

        var myStoreName = "@storeName";
        createChart(pricesData, myStoreName);
    });

    function createChart(pricesData, myStore) {
        const sortedData = pricesData.sort((a, b) => b.price - a.price);
        const sortedPrices = sortedData.map(item => item.price);
        const sortedStores = sortedData.map(item => item.store);
        const myStoreNormalized = myStore.toLowerCase().trim();

        const barColors = sortedData.map(item => {
            const storeNormalized = item.store.toLowerCase().trim();
            if (storeNormalized === myStoreNormalized) {
                if (item.isGoogle) {
                    return 'rgba(72, 142, 255, 0.6)';
                } else {
                    return 'rgba(255, 100, 0, 0.6)';
                }
            }
            return 'rgba(34, 34, 34, 0.4)';
        });

        const borderColors = sortedData.map(item => {
            const storeNormalized = item.store.toLowerCase().trim();
            if (storeNormalized === myStoreNormalized) {
                if (item.isGoogle) {
                    return 'rgba(72, 142, 255, 1)';
                } else {
                    return 'rgba(255, 100, 0, 1)';
                }
            }
            return 'rgba(34, 34, 34, 1)';
        });

        const ctx = document.getElementById('priceChart').getContext('2d');
        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedStores,
                datasets: [{
                    label: 'Cena PLN',
                    data: sortedPrices,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value + ' PLN';
                            }
                        }
                    },
                    x: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
</script>

<script>
    let productId = @ViewBag.ProductId;
    let myStoreLower = "@storeName".toLowerCase().trim();
    let lastHoverParams = null;

    let highlightedStores = [];
    let storeColorMap = {};
    let lastHighlightedStore = null;
    let hiddenStores = [];

     const highlightColors = [
        'rgba(255, 128, 0, 1)',
        'rgba(76, 175, 80, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(244, 67, 54, 1)',
        'rgba(0, 150, 136, 1)',
        'rgba(255, 193, 7, 1)',
        'rgba(0, 188, 212, 1)',
        'rgba(139, 195, 74, 1)',
        'rgba(121, 85, 72, 1)',
        'rgba(233, 30, 99, 1)'
    ];

    const myStoreColor = 'rgba(54, 162, 235, 1)';
    const defaultGrayColor = 'rgba(128, 128, 128, {alpha})';

        const UNIFORM_LINE_WIDTH = 2.3;
    const UNIFORM_EMPHASIS_LINE_WIDTH = 2.3;

    let defaultGrayAlpha = 0.3;
    let echartsTrendChart = null;
    let currentTimelineData = null;
    let currentChartOptions = null;
    const defaultCustomTooltipContent = 'Najedź na punkt na wykresie...';

    function updateCustomTooltipPanel(htmlContent) {
        const panelDiv = document.getElementById('customTrendTooltip');
        if (panelDiv) {
            panelDiv.innerHTML = htmlContent || defaultCustomTooltipContent;
        } else {
            console.error("Element '#customTrendTooltip' not found!");
        }
    }

        function recalculateYAxisRange() {
        if (!currentChartOptions || !currentChartOptions.series) {

            return null;
        }

        let minPrice = Number.POSITIVE_INFINITY;
        let maxPrice = Number.NEGATIVE_INFINITY;
        let hasVisibleData = false;

        currentChartOptions.series.forEach(series => {
            const storeLower = series.name.toLowerCase().trim();

            if (!hiddenStores.includes(storeLower)) {
                series.data.forEach(dataPoint => {
                    const price = dataPoint.value;
                    if (price !== null && price !== undefined) {
                        hasVisibleData = true;
                        if (price < minPrice) minPrice = price;
                        if (price > maxPrice) maxPrice = price;
                    }
                });
            }
        });

        if (!hasVisibleData || !isFinite(minPrice)) {

             console.warn("No visible data points found after filtering. Using default Y-axis range.");
             return { min: 0, max: 100 };
        }

         if (!isFinite(maxPrice) || maxPrice <= minPrice) {
             maxPrice = minPrice + 100;
         }

        const padding = (maxPrice - minPrice) * 0.05;

        const finalMin = Math.max(0, minPrice - padding);
        const finalMax = maxPrice + padding;

        return { min: finalMin, max: finalMax };
    }

    function findNextFreeColorIndex() {
        for (let i = 0; i < highlightColors.length; i++) {
            let used = Object.values(storeColorMap).includes(i);
            if (!used) return i;
        }
        return null;
    }

        function hideStoreFromChart(storeName) {
        if (!echartsTrendChart || !currentTimelineData) {
            console.warn("Chart not ready or no data to hide store.");
            return;
        }

        const storeLower = storeName.toLowerCase().trim();

        if (!hiddenStores.includes(storeLower)) {
            hiddenStores.push(storeLower);
        }

        const highlightedIndex = highlightedStores.indexOf(storeLower);
        if (highlightedIndex > -1) {

            highlightedStores.splice(highlightedIndex, 1);

            delete storeColorMap[storeLower];

            if (lastHighlightedStore === storeLower) {
                lastHighlightedStore = highlightedStores.length > 0 ? highlightedStores[highlightedStores.length - 1] : null;
            }
        }

        updateEchartsStylesAndZ();
    const newYAxisRange = recalculateYAxisRange();
       if (newYAxisRange && currentChartOptions && currentChartOptions.yAxis) {

           currentChartOptions.yAxis.min = newYAxisRange.min;
           currentChartOptions.yAxis.max = newYAxisRange.max;

           echartsTrendChart.setOption({
               yAxis: {
                   min: newYAxisRange.min,
                   max: newYAxisRange.max

               }
           });
       }

       if (lastHoverParams) {
           const updatedPanelHtml = generateTooltipPanelHtml(lastHoverParams);
           updateCustomTooltipPanel(updatedPanelHtml || defaultCustomTooltipContent);
       }
    }

        function getSeriesStyleAndZ(storeNameLower) {
        if (hiddenStores.includes(storeNameLower)) {
            return {
                lineStyle: { color: 'transparent', width: 0 },
                itemStyle: { color: 'transparent' },
                z: 0
            };
        }
        const isMyStore = storeNameLower === myStoreLower;
        const isHighlighted = highlightedStores.includes(storeNameLower);
        const isLastHighlighted = storeNameLower === lastHighlightedStore;
        const colorIndex = storeColorMap[storeNameLower];

        let color = defaultGrayColor.replace('{alpha}', defaultGrayAlpha);
        let z = 1;

        if (isMyStore) {
            color = myStoreColor;
            z = 3;
        } else if (isHighlighted && colorIndex !== undefined && colorIndex !== null) {
            color = highlightColors[colorIndex];
            z = 2;
        }

        if (isLastHighlighted) {
            z = 4;
        }

        return {

            lineStyle: { color: color, width: UNIFORM_LINE_WIDTH },
            itemStyle: { color: color },
            z: z
        };
    }

    function generateTooltipPanelHtml(params) {
     if (!params || params.length === 0) {
         return null;
     }

     const date = params[0].axisValueLabel;
     let items = [];

     params.forEach(param => {
         const priceVal = param.data.value;

         const sourceVal = param.data.source;

         const storeName = param.seriesName;
         const storeLower = storeName.toLowerCase().trim();

         if (hiddenStores.includes(storeLower)) {
             return;
         }

         if (priceVal !== null && priceVal !== undefined) {

              const currentSeriesStyle = getSeriesStyleAndZ(storeLower);

             items.push({
                 storeName: storeName,
                 price: priceVal,
                 source: sourceVal,
                 isHighlighted: highlightedStores.includes(storeLower),
                 isMyStore: (storeLower === myStoreLower),
                 isLastHighlighted: (storeLower === lastHighlightedStore),
                 colorIndex: storeColorMap[storeLower],
                 markerColor: currentSeriesStyle.itemStyle.color

             });
         }
     });

        items.sort((a, b) => {
            if (a.price !== b.price) {
                return a.price - b.price;
            }
            return a.storeName.localeCompare(b.storeName);
        });

       let panelHtml = `<div style="font-weight:bold; margin-bottom:4px;">Data: ${date}</div>`;
    if (items.length > 0) {
        panelHtml += `<table style="width:100%; border-collapse:collapse; font-size: 0.85rem;">`;
        items.forEach(item => {
            let colorText = 'rgba(50, 50, 50, 1)';
            let fontWeight = 'normal';
            const storeLower = item.storeName.toLowerCase().trim();

             if (storeLower === myStoreLower) {
                 colorText = myStoreColor;
                 fontWeight = 'bold';
             } else if (highlightedStores.includes(storeLower) && item.colorIndex != null) {
                 colorText = highlightColors[item.colorIndex];
                 fontWeight = 'bold';
             }

            let displayName = item.storeName;
            if (displayName.length > 23) displayName = displayName.substring(0, 20) + '...';

            let iconHtml = (item.source === 'google')
                 ? `<img src="/images/GoogleShopping.png" alt="G" style="width:14px;height:14px;margin-right:4px; vertical-align: middle;" title="Google Shopping" />`
                    : `<img src="/images/Ceneo.png" alt="C" style="width:14px;height:14px;margin-right:4px; vertical-align: middle;" title="Ceneo" />`;

            const escapedStoreName = item.storeName.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');

            const removeButtonHtml = `
                <span class="remove-store-btn" title="Ukryj sklep '${item.storeName}' z wykresu"
                      style="cursor: pointer; color: #aaa; margin-left: 8px; font-weight: bold; padding: 0 4px; display: inline-block; vertical-align: middle;"
                      onmouseover="this.style.color='red'"
                      onmouseout="this.style.color='#aaa'"
                      onclick="event.stopPropagation(); hideStoreFromChart('${escapedStoreName}');">
                      &times;
                </span>`;

            panelHtml += `
                <tr style="border-bottom:1px solid #eee; cursor:pointer;"
                    onclick="event.stopPropagation(); toggleStoreHighlight('${escapedStoreName}');">
                    <td style="padding: 3px 2px; color:${colorText}; font-weight:${fontWeight}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${item.storeName}">
                        <span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.markerColor}; vertical-align: middle;"></span>
                        ${iconHtml}${displayName}
                    </td>
                    <td style="padding: 3px 2px; text-align:right; color:${colorText}; font-weight:${fontWeight}; white-space:nowrap;">
                        ${item.price.toFixed(2)} PLN
                        ${removeButtonHtml}
                    </td>
                </tr>
            `;
        });
        panelHtml += `</table>`;
    } else {

         const hasAnyDataForDate = params.some(p => p.data.value !== null && p.data.value !== undefined);
         if(hasAnyDataForDate) {
             panelHtml += `<div style="color: #666; font-style: italic;">Wszystkie widoczne sklepy nie miały oferty w tej dacie lub zostały ukryte.</div>`;
         } else {
            panelHtml += `<div style="color: #666; font-style: italic;">Brak danych dla tej daty.</div>`;
         }
    }
    return panelHtml;
    }

       function prepareEchartsSeries(dataByInstance, allDates, allInstances) {

        const SINGLE_POINT_SIZE = 10;
        const MULTI_POINT_EMPHASIS_SIZE = 12;
        const SINGLE_POINT_EMPHASIS_SIZE = 14;

        return allInstances.map(instanceId => {
            const [storeName, source] = instanceId.split('|');
            const storeLower = storeName.toLowerCase().trim();

            const initialStyleAndZ = getSeriesStyleAndZ(storeLower);

            let validDataPointsCount = 0;

            const data = allDates.map(date => {
                const price = dataByInstance[instanceId]?.[date] ?? null;
                if (price !== null && price !== undefined) {
                    validDataPointsCount++;
                }
                return { value: price, source: source, storeName: storeName };
            });

            let showSymbolDefault = false;
            let symbolSizeDefault = 6;
            let symbolSizeEmphasis = MULTI_POINT_EMPHASIS_SIZE;

            if (validDataPointsCount === 1) {
                showSymbolDefault = true;
                symbolSizeDefault = SINGLE_POINT_SIZE;
                symbolSizeEmphasis = SINGLE_POINT_EMPHASIS_SIZE;
            }

            return {
                name: storeName,
                _instanceId: instanceId,
                _source: source,
                type: 'line',
                data: data,
                connectNulls: false,
                smooth: 0.30,

                showSymbol: showSymbolDefault,
                symbol: 'circle',
                symbolSize: symbolSizeDefault,

               emphasis: {
        focus: 'series',
        symbolSize: symbolSizeEmphasis,
        lineStyle: {
            width: UNIFORM_EMPHASIS_LINE_WIDTH

        },
        itemStyle: {

            color: initialStyleAndZ.itemStyle.color,
            borderColor: 'rgba(255, 255, 255, 0.7)',
            borderWidth: 1,
            opacity: 1
        }
    },
    lineStyle: initialStyleAndZ.lineStyle,
    itemStyle: {
        color: initialStyleAndZ.itemStyle.color
    },
    z: initialStyleAndZ.z
            };
        });
    }
    function drawEchartsTrendChart(timelineData) {
        currentTimelineData = timelineData;

        const chartDom = document.getElementById('trendChart');
        if (!chartDom) {
            console.error("ECharts container 'trendChart' not found!");
            return;
        }

        if (echartsTrendChart) {
            echartsTrendChart.dispose();
            echartsTrendChart = null;
        }

        echartsTrendChart = echarts.init(chartDom);

    let allDatesSet = new Set();
    let allInstancesSet = new Set();
    let dataByInstance = {};

    timelineData.forEach(entry => {
        const date = entry.scrapDate;
        allDatesSet.add(date);
        entry.pricesByStore.forEach(ps => {
            if (ps.storeName && ps.source && ps.price !== null && ps.price !== undefined) {
                const storeName = ps.storeName;
                const source = ps.source;
                const price = ps.price;
                const instanceId = `${storeName}|${source}`;
                allInstancesSet.add(instanceId);
                if (!dataByInstance[instanceId]) {
                    dataByInstance[instanceId] = {};
                }
                dataByInstance[instanceId][date] = price;
            }
        });
    });

    const chartContainerElement = document.getElementById('trendChartContainer');

    if (chartContainerElement && typeof ResizeObserver !== 'undefined') {
        const resizeObserver = new ResizeObserver(entries => {

            if (echartsTrendChart && $('#trendChartContainer').is(':visible')) {
                 console.log('ResizeObserver detected container resize, resizing ECharts.');

                 echartsTrendChart.resize({
                    animation: {
                        duration: 200,
                        easing: 'quadraticInOut'
                    }
                 });
            }
        });

        resizeObserver.observe(chartContainerElement);

    } else if (!chartContainerElement) {

    }
     else {

    }

    let allDates = Array.from(allDatesSet).sort();
    let allInstances = Array.from(allInstancesSet);

    allInstances.sort((a, b) => {
        const [nameA, sourceA] = a.split('|');
        const [nameB, sourceB] = b.split('|');
        const nameALower = nameA.toLowerCase().trim();
        const nameBLower = nameB.toLowerCase().trim();
        if (nameALower === myStoreLower && nameBLower !== myStoreLower) return -1;
        if (nameBLower === myStoreLower && nameALower !== myStoreLower) return 1;
        const nameCompare = nameA.localeCompare(nameB);
        if (nameCompare !== 0) return nameCompare;
        return sourceA.localeCompare(sourceB);
    });

    let globalMinPrice = Number.POSITIVE_INFINITY;
    let globalMaxPrice = Number.NEGATIVE_INFINITY;
    Object.values(dataByInstance).forEach(datesMap => {
        Object.values(datesMap).forEach(price => {
            if (price < globalMinPrice) globalMinPrice = price;
            if (price > globalMaxPrice) globalMaxPrice = price;
        });
    });

     if (!isFinite(globalMinPrice)) globalMinPrice = 0;
     if (!isFinite(globalMaxPrice) || globalMaxPrice <= globalMinPrice) {
         globalMaxPrice = globalMinPrice + 100;
     } else {
         const padding = (globalMaxPrice - globalMinPrice) * 0.05;
         globalMinPrice = Math.max(0, globalMinPrice - padding);
         globalMaxPrice = globalMaxPrice + padding;
     }

    const seriesData = prepareEchartsSeries(dataByInstance, allDates, allInstances);

    const polishMonths = [
        'sty', 'lut', 'mar', 'kwi', 'maj', 'cze',
        'lip', 'sie', 'wrz', 'paź', 'lis', 'gru'
    ];

    function formatDateToPolishDM(dateString) {
        try {

            const parts = dateString.split('-');
            if (parts.length === 3) {
                const day = parseInt(parts[2], 10);
                const monthIndex = parseInt(parts[1], 10) - 1;
                if (!isNaN(day) && monthIndex >= 0 && monthIndex < 12) {
                    return `${day} ${polishMonths[monthIndex]}`;
                }
            }

            return dateString;
        } catch (e) {
            console.error("Error formatting date:", dateString, e);
            return dateString;
        }
    }

    currentChartOptions = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross',
                snap: true,
                label: { backgroundColor: '#6a7985' }
            },

            formatter: function (params) {
                lastHoverParams = params;
                const panelHtml = generateTooltipPanelHtml(params);
                updateCustomTooltipPanel(panelHtml || defaultCustomTooltipContent);
                return '';
            },

        },
        xAxis: {
            type: 'category',
            data: allDates,
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#E8E8E8',
                    type: 'dashed',
                    width: 1,
                    opacity: 1.0
                }
            },
            boundaryGap: false,
              axisLabel: {

                formatter: function (value) {

                    return formatDateToPolishDM(value);
                },

                fontSize: 11,
                color: '#666'

            }

        },
            yAxis: {
            type: 'value',
            min: globalMinPrice,
            max: globalMaxPrice,
            axisLabel: {
                 show: false,
                 formatter: function (value) {  }
            },
            scale: true,
            axisPointer: {
                show: true,
                snap: true
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#E8E8E8',
                    type: 'dashed',
                    width: 1,
                    opacity: 1.0
                }
            }
        },
        grid: {
            left: '3%',
            right: '4%',

            bottom: '80px',
            containLabel: true
        },
        series: seriesData,
        animationEasing: 'quadraticInOut',
        animationDuration: 600,

    dataZoom: [
        {
            type: 'slider',
            xAxisIndex: 0,
            start: 0,
            end: 100,
            bottom: '10px',
            height: 25,
            showDetail: true,
            realtime: true,
            filterMode: 'filter',

            backgroundColor: 'rgba(240, 240, 240, 0.6)',
            borderColor: '#cccccc',
            fillerColor: 'rgba(180, 180, 180, 0.4)',
            handleStyle: {
                color: '#a7a7a7',
                borderColor: '#747474',
                borderWidth: 1
            },
            dataBackground: {
                lineStyle: { color: 'transparent' },
                areaStyle: { color: '#ebebeb' }
            },
            selectedDataBackground: {
                lineStyle: { color: 'transparent' },
                areaStyle: { color: '#dcdcdc' }
            },

            showMoveHandle: false,

            moveHandleIcon: 'none',
            moveHandleStyle: {
                color: 'transparent',
                opacity: 0
            },

            emphasis: {
                fillerColor: 'rgba(180, 180, 180, 0.6)',
                handleStyle: {
                    color: '#747474',
                    borderColor: '#505050'
                },
                moveHandleStyle: {
                    color: 'transparent',
                    opacity: 0
                }
            },
             labelFormatter: function (value) {

                    let dateStr = '';

                    if (typeof value === 'number' && value >= 0 && value < allDates.length) {

                        dateStr = allDates[value];
                    } else if (typeof value === 'string') {

                         dateStr = value;
                    } else {

                         return '';
                    }

                    return formatDateToPolishDM(dateStr);
                }

        },
        {
            type: 'inside',
            xAxisIndex: 0,
            start: 0,
            end: 100,
            zoomOnMouseWheel: true,
            moveOnMouseMove: true,
            preventDefaultMouseMove: true
        }
    ]
    };

        echartsTrendChart.setOption(currentChartOptions);

        echartsTrendChart.on('click', function (params) {
         if (params && params.seriesName) {
             const clickedStoreName = params.seriesName;

             toggleStoreHighlight(clickedStoreName);
         }
     });

        echartsTrendChart.on('mouseout', function () {

        });

        window.addEventListener('resize', () => {
            if (echartsTrendChart) {
                echartsTrendChart.resize();
            }
        });

        updateCustomTooltipPanel(null);
    }

    function toggleStoreHighlight(storeName) {
        if (!echartsTrendChart || !currentTimelineData) {
            console.warn("Chart not ready or no data to toggle highlight.");
            return;
        }
        let sLower = storeName.toLowerCase().trim();
        let idx = highlightedStores.indexOf(sLower);

        if (idx >= 0) {
            highlightedStores.splice(idx, 1);
            delete storeColorMap[sLower];
            if (lastHighlightedStore === sLower) {
                 lastHighlightedStore = highlightedStores.length > 0 ? highlightedStores[highlightedStores.length - 1] : null;
            }
        } else {
            if (sLower === myStoreLower) {
                 console.log("Kliknięto własny sklep - brak dodatkowego podświetlenia.");
                 lastHighlightedStore = sLower;
            } else if (highlightedStores.length >= highlightColors.length) {
                 alert(`Możesz zaznaczyć maks. ${highlightColors.length} sklepów do porównania `);
                 return;
            } else {
                 let cIndex = findNextFreeColorIndex();
                 if (cIndex === null) {
                     alert("Brak wolnych kolorów do podświetlenia!");
                     return;
                 }
                 if (!highlightedStores.includes(sLower)) {
                     highlightedStores.push(sLower);
                 }
                 storeColorMap[sLower] = cIndex;
                 lastHighlightedStore = sLower;
            }
        }

        updateEchartsStylesAndZ();

        if (lastHoverParams) {

            const updatedPanelHtml = generateTooltipPanelHtml(lastHoverParams);
            if (updatedPanelHtml) {
                 updateCustomTooltipPanel(updatedPanelHtml);
            }
        }

    }

    function updateEchartsStylesAndZ() {
        if (!echartsTrendChart || !currentChartOptions || !currentChartOptions.series) return;

        const updatedSeries = currentChartOptions.series.map(series => {
            const storeLower = series.name.toLowerCase().trim();
            const styleAndZ = getSeriesStyleAndZ(storeLower);

            const currentEmphasis = series.emphasis || {};
            const currentEmphasisItemStyle = currentEmphasis.itemStyle || {};
            const currentEmphasisLineStyle = currentEmphasis.lineStyle || {};

            const DEBUG_STORE_NAME = "NAZWA_SKLEPU_Z_JEDNYM_PUNKTEM";
            if (series.name === DEBUG_STORE_NAME) {
                 console.log(`[${series.name}] Emphasis PRZED aktualizacją:`, JSON.stringify(currentEmphasis));
                 console.log(`[${series.name}] Styl normalny (itemStyle.color):`, styleAndZ.itemStyle.color);
            }

            const newEmphasis = {
                ...currentEmphasis,
                lineStyle: {
                    ...currentEmphasisLineStyle,
                    width: UNIFORM_EMPHASIS_LINE_WIDTH
                },
                itemStyle: {
                    ...currentEmphasisItemStyle,
                    color: styleAndZ.itemStyle.color,
                    opacity: 1
                }
            };

             if (series.name === DEBUG_STORE_NAME) {
                 console.log(`[${series.name}] Emphasis PO aktualizacji (przed setOption):`, JSON.stringify(newEmphasis));
             }

            return {
                ...series,
                lineStyle: styleAndZ.lineStyle,
                itemStyle: styleAndZ.itemStyle,
                emphasis: newEmphasis,
                z: styleAndZ.z
            };
        });

        currentChartOptions.series = updatedSeries;

        console.log("Aktualizowanie opcji wykresu...");
        echartsTrendChart.setOption({
            series: updatedSeries
        });
        console.log("Opcje wykresu zaktualizowane.");
    }

    document.addEventListener("DOMContentLoaded", function () {
         const $exportExcelBtn = $('#exportExcelBtn');
        const $showTableBtn = $('#showTableBtn');
        const $showChartBtn = $('#showChartBtn');
        const $tableContainer = $('#priceTableContainer');
        const $chartContainer = $('#trendChartContainer');
        const $customTooltipPanel = $('#customTrendTooltip');

        $showTableBtn.on('click', function () {
            $chartContainer.hide();
            $customTooltipPanel.hide();
            $tableContainer.show();
            $showTableBtn.removeClass('button-inactive').addClass('button-active');
            $showChartBtn.removeClass('button-active').addClass('button-inactive');
        });

        $showChartBtn.on('click', function () {
            $tableContainer.hide();
            $chartContainer.show();
            $customTooltipPanel.show();
            $showChartBtn.removeClass('button-inactive').addClass('button-active');
            $showTableBtn.removeClass('button-active').addClass('button-inactive');

            if ($chartContainer.is(':visible')) {
                 if (!echartsTrendChart && currentTimelineData) {
                     if (document.getElementById('trendChart')) {
                          drawEchartsTrendChart(currentTimelineData);
                     } else {
                          console.error("Target div 'trendChart' not found when trying to redraw.");
                     }
                 } else if (!echartsTrendChart) {
                      if (document.getElementById('trendChart')) {
                          loadTrendDataAndDrawEcharts();
                      } else {
                          console.error("Target div 'trendChart' not found on initial load.");
                      }
                 } else {
                     echartsTrendChart.resize();
                 }
            }
        });

    if ($exportExcelBtn.length) {
        $exportExcelBtn.on('click', function() {

            if (!currentTimelineData) {
                alert("Dane historii cen nie zostały jeszcze załadowane. Proszę najpierw kliknąć przycisk 'Wykres'.");

            } else {
                exportChartDataToExcel();
            }
        });
    }

        const grayAlphaRange = document.getElementById("grayAlphaRange");
        if (grayAlphaRange) {
            grayAlphaRange.addEventListener("input", function (e) {
                defaultGrayAlpha = parseFloat(e.target.value);
                updateEchartsStylesAndZ();

                 if (lastHoverParams) {
                    const updatedPanelHtml = generateTooltipPanelHtml(lastHoverParams);
                    if (updatedPanelHtml) {
                         updateCustomTooltipPanel(updatedPanelHtml);
                    }
                 }
            });
        }

         $showTableBtn.click();

    });

    function loadTrendDataAndDrawEcharts() {
         if ($('#trendChartContainer').is(':visible')) {
              $('#loadingOverlay').show();
         }

        $.ajax({
            url: '@Url.Action("GetPriceTrendData", "PriceHistory")',
            type: 'GET',
            data: { productId: productId },
            success: function(response) {
                if (response && response.timelineData && Array.isArray(response.timelineData)) {
                     currentTimelineData = response.timelineData;
                     if ($('#trendChartContainer').is(':visible') && document.getElementById('trendChart')) {
                          drawEchartsTrendChart(currentTimelineData);
                     } else {
                          console.log("Chart container not visible, data stored for later drawing.");
                     }
                } else {
                     alert("Otrzymano nieprawidłowy format danych trendu.");
                     console.error("Invalid timeline data received:", response);
                     updateCustomTooltipPanel('<div style="color:red;">Błąd ładowania danych.</div>');
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert("Błąd pobierania danych trendu: " + errorThrown);
                console.error("AJAX Error:", textStatus, errorThrown);
                 updateCustomTooltipPanel('<div style="color:red;">Błąd ładowania danych.</div>');
            },
            complete: function() {
                 $('#loadingOverlay').hide();
            }
        });
    }

    function rgbaToHex(rgba) {

        if (typeof rgba !== 'string' || !rgba.toLowerCase().startsWith('rgba')) {
            return null;
        }
        const parts = rgba.substring(rgba.indexOf('(') + 1, rgba.lastIndexOf(')')).split(/,\s*/);
        if (parts.length < 3) {
            return null;
        }
        try {
            const r = parseInt(parts[0], 10);
            const g = parseInt(parts[1], 10);
            const b = parseInt(parts[2], 10);
            if (isNaN(r) || isNaN(g) || isNaN(b) || r < 0 || r > 255 || g < 0 || g > 255 || b < 0 || b > 255) {
                return null;
            }
            const toHex = c => ('0' + c.toString(16)).slice(-2);
            const hex = `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();

            return hex;
        } catch (e) {
            return null;
        }
    }

    function getExcelColorForStoreWithInfo(storeKey, currentStoreInfo) {

        if (!currentStoreInfo || !storeKey || !currentStoreInfo[storeKey]) {

            return null;
        }

        const name = currentStoreInfo[storeKey].name;
        const storeLower = name.toLowerCase().trim();

        let colorToConvert = null;

        const isMy = (typeof myStoreLower !== 'undefined' && storeLower === myStoreLower);

        if (isMy && typeof myStoreColor !== 'undefined') {
            colorToConvert = myStoreColor;

        }

        const isHighlighted = (typeof highlightedStores !== 'undefined' && Array.isArray(highlightedStores) && highlightedStores.includes(storeLower));

         if (!isMy && isHighlighted) {
            if (typeof storeColorMap !== 'undefined' && typeof highlightColors !== 'undefined' && Array.isArray(highlightColors)) {
                const colorIndex = storeColorMap[storeLower];

                if (colorIndex !== undefined && colorIndex !== null && colorIndex < highlightColors.length) {
                    colorToConvert = highlightColors[colorIndex];

                } else {

                }
            } else {

            }
        }

        if (colorToConvert) {
            const hexColor = rgbaToHex(colorToConvert);

            return hexColor;
        }

        return null;
    }

    async function exportChartDataToExcel() {
        console.log("==============================================");
        console.log("Rozpoczynanie eksportu do Excel używając ExcelJS (uwzględniając zoom)...");

        if (!currentTimelineData || currentTimelineData.length === 0) {
            alert("Brak danych historii cen do wyeksportowania. Najpierw załaduj widok wykresu.");
            console.warn("Brak danych w currentTimelineData do eksportu.");
            return;
        }
        if (!echartsTrendChart) {
            alert("Instancja wykresu nie jest dostępna. Najpierw załaduj widok wykresu.");
            console.warn("Instancja echartsTrendChart nie znaleziona.");
            return;
        }
         if (typeof hiddenStores === 'undefined' || !Array.isArray(hiddenStores)) {
            console.warn("Zmienna hiddenStores nie jest zdefiniowana jako tablica. Eksportowane będą wszystkie dane.");
        }

        const allDates = new Set();
        const storeData = {};
        const localStoreInfo = {};

        currentTimelineData.forEach(entry => {
            const date = entry.scrapDate;
            allDates.add(date);
            entry.pricesByStore.forEach(ps => {
                if (ps.price !== null && ps.price !== undefined && ps.storeName && ps.source) {
                    const storeKey = `${ps.storeName}|${ps.source}`;
                    const storeLower = ps.storeName.toLowerCase().trim();
                    let isHidden = (typeof hiddenStores !== 'undefined' && Array.isArray(hiddenStores) && hiddenStores.includes(storeLower));
                    if (!isHidden) {
                        if (!storeData[storeKey]) {
                            storeData[storeKey] = {};
                            localStoreInfo[storeKey] = { name: ps.storeName, source: ps.source };
                        }
                        storeData[storeKey][date] = ps.price;
                    }
                }
            });
        });

        const sortedDates = Array.from(allDates).sort();

        console.log("Odczytywanie aktualnego zakresu zoomu z wykresu...");
        const option = echartsTrendChart.getOption();
        let zoomStartIndex = 0;
        let zoomEndIndex = sortedDates.length - 1;
        let dateRangeAvailable = false;

        if (option && option.dataZoom && Array.isArray(option.dataZoom) && option.dataZoom.length > 0) {

            const dataZoomConfig = option.dataZoom.find(dz => dz.xAxisIndex === 0 || typeof dz.xAxisIndex === 'undefined');

            if (dataZoomConfig && typeof dataZoomConfig.start !== 'undefined' && typeof dataZoomConfig.end !== 'undefined') {
                 const totalDates = sortedDates.length;

                 zoomStartIndex = Math.floor(totalDates * (dataZoomConfig.start / 100));

                 zoomEndIndex = Math.ceil(totalDates * (dataZoomConfig.end / 100)) - 1;

                 zoomStartIndex = Math.max(0, zoomStartIndex);
                 zoomEndIndex = Math.min(totalDates - 1, zoomEndIndex);
                 if(zoomStartIndex > zoomEndIndex && totalDates > 0) {
                     zoomEndIndex = zoomStartIndex;
                     console.warn("Obliczony startIndex był większy niż endIndex, skorygowano.");
                 }

                 console.log(`Zoom wykryty: start=${dataZoomConfig.start}%, end=${dataZoomConfig.end}%. Obliczone indeksy [${zoomStartIndex}, ${zoomEndIndex}] w tablicy ${totalDates} dat.`);
                 dateRangeAvailable = true;
            } else {
                 console.warn("Nie można odczytać wartości 'start'/'end' z konfiguracji dataZoom.");
            }
        } else {
            console.warn("Nie znaleziono konfiguracji dataZoom w opcjach wykresu.");
        }

        const filteredDates = sortedDates.slice(zoomStartIndex, zoomEndIndex + 1);

        if (filteredDates.length === 0 && sortedDates.length > 0) {
            alert("Brak danych w wybranym zakresie dat na wykresie do wyeksportowania.");
            console.warn("Tablica dat po filtracji jest pusta.");
            return;
        } else if(filteredDates.length === 0 && sortedDates.length === 0) {
             alert("Brak jakichkolwiek danych historycznych do wyeksportowania.");
             console.warn("Brak jakichkolwiek dat do przetworzenia.");
             return;
        }
        console.log(`Eksportowany zakres dat: ${filteredDates.length} dni, od ${filteredDates[0]} do ${filteredDates[filteredDates.length - 1]}`);

        const sortedStoreKeys = Object.keys(storeData).sort((a, b) => {

             if (!localStoreInfo[a] || !localStoreInfo[b]) return 0;
            const nameA = localStoreInfo[a].name.toLowerCase();
            const nameB = localStoreInfo[b].name.toLowerCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            const sourceA = localStoreInfo[a].source.toLowerCase();
            const sourceB = localStoreInfo[b].source.toLowerCase();
            if (sourceA < sourceB) return -1;
            if (sourceA > sourceB) return 1;
            return 0;
        });

         if (sortedStoreKeys.length === 0) {
            alert("Brak widocznych danych sklepów do wyeksportowania (mogły zostać ukryte).");
            console.warn("Brak kluczy sklepów do eksportu po odfiltrowaniu ukrytych sklepów.");
            return;
        }
        console.log(`Przygotowano ${sortedStoreKeys.length} wierszy danych (sklepów).`);

        try {
            console.log("Tworzenie skoroszytu ExcelJS...");
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Historia Cen (Przestawiona)");

            console.log("Definiowanie kolumn dla przefiltrowanych dat...");
            const columns = [
                { header: 'Sklep', key: 'store', width: 35 },
                { header: 'Źródło', key: 'source', width: 10 }
            ];
            filteredDates.forEach(date => {
                columns.push({
                    header: date,
                    key: date,
                    width: 12,
                    style: { numFmt: '#,##0.00', alignment: { horizontal: 'right' } }
                });
            });
            worksheet.columns = columns;
            console.log(`Zdefiniowano ${columns.length} kolumn.`);

            console.log("Dodawanie wierszy i aplikowanie stylów...");
            let stylesAppliedCount = 0;
            sortedStoreKeys.forEach(storeKey => {
                const info = localStoreInfo[storeKey];
                const prices = storeData[storeKey];
                const rowData = { store: info.name, source: info.source };

                filteredDates.forEach(date => {
                    rowData[date] = prices[date] !== undefined ? prices[date] : null;
                });

                const row = worksheet.addRow(rowData);
                const hexColor = getExcelColorForStoreWithInfo(storeKey, localStoreInfo);

                if (hexColor) {
                    stylesAppliedCount++;
                    const excelJsFillStyle = { type: 'pattern', pattern:'solid', fgColor:{ argb:'FF' + hexColor.substring(1) } };
                    row.eachCell({ includeEmpty: true }, function(cell) { cell.fill = excelJsFillStyle; });
                }
            });
            console.log(`Style kolorów tła zaaplikowane dla ${stylesAppliedCount} wierszy.`);

            console.log("Generowanie bufora pliku Excel...");
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

            const productNameJs = @Html.Raw(Json.Serialize(ViewBag.ProductName ?? "Produkt"));
            const productNameSafe = productNameJs.replace(/[^a-z0-9_]/gi, '_').substring(0, 50);
            const startDate = filteredDates[0];
            const endDate = filteredDates[filteredDates.length - 1];

            const fileName = `PriceSafari_${productNameSafe}_historia_${startDate}_do_${endDate}.xlsx`;
            console.log("Generowanie linku do pobrania pliku:", fileName);

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => { URL.revokeObjectURL(link.href); }, 100);

            console.log("Pobieranie pliku zainicjowane przez ExcelJS.");

        } catch (error) {
            console.error("Błąd podczas generowania pliku Excel za pomocą ExcelJS:", error);
            alert("Wystąpił błąd podczas tworzenia pliku Excel...");
        }
    }

</script>