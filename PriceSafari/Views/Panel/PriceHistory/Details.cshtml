@model IEnumerable<PriceSafari.Models.PriceHistoryClass>

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    ViewData["Title"] = "Szczegóły Cen";

    var scrapHistory = ViewBag.ScrapHistory as PriceSafari.Models.ScrapHistoryClass;
    var productName = ViewBag.ProductName as string;
    var storeName = ViewBag.StoreName as string;
    var url = ViewBag.Url;
    var googleUrl = ViewBag.GoogleUrl;
    var setPrice1 = ViewBag.SetPrice1;
    var setPrice2 = ViewBag.SetPrice2;
    var externalUrl = ViewBag.ExternalUrl as string;
    var img = ViewBag.Img as string;
    decimal basePrice = 0;

    var totalOffers = Model.Count();
    var googleOffers = Model.Count(x => x.IsGoogle == true);
    var ceneoOffers = totalOffers - googleOffers;

    var myStorePrice = Model.FirstOrDefault(p => string.Equals(p.StoreName, storeName, StringComparison.OrdinalIgnoreCase));
    if (myStorePrice != null)
    {
        basePrice = myStorePrice.Price;
    }
}

<div class="Vert" data-store-name="@storeName">
    <div class="Page-Box">
        <div style="display:flex; width:100%; justify-content:space-between;">
            <div style="font-weight: 300; font-size: 22px;">
                @productName
            </div>
            <div style="margin-top:4px;">
                <button type="button" id="showTableBtn" class="button-active">
                    Ranking
                </button>
                <button type="button" id="showChartBtn" class="button-inactive">
                    Wykres
                </button>
            </div>
        </div>

        <div class="form-check-orders" style="margin-bottom:16px;">
            <div>
                <p><strong>Wykonano:</strong> @scrapHistory?.Date.ToString("dd.MM.yyyy")</p>
            </div>
        </div>
        <div class="price-box-space" style="gap:32px;">
            <div style="display:flex; width:100%; gap:48px; margin-bottom:8px;">
                @if (!string.IsNullOrEmpty(img))
                {
                    <div style="display:flex;">
                        <img src="@img" style="height: 130px; width: 130px;" />
                    </div>
                }
                <div class="price-box-column-name" style="align-content:flex-end;">
                    <div class="store-section">
                        <!-- Zawsze wyświetlamy sortowanie po cenie -->
                        <div class="form-check">
                            <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPrice" value="price" checked>
                            <label class="form-check-label" for="sortPrice">Sortuj po cenie</label>
                        </div>
                        @if (googleOffers > 0 && ceneoOffers > 0)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPosition" value="position">
                                <label class="form-check-label" for="sortPosition">Sortuj po pozycji Ceneo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortGooglePosition" value="googlePosition">
                                <label class="form-check-label" for="sortGooglePosition">Sortuj po pozycji Google</label>
                            </div>
                        }
                        else if (googleOffers == totalOffers)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortGooglePosition" value="googlePosition">
                                <label class="form-check-label" for="sortGooglePosition">Sortuj po pozycji Google</label>
                            </div>
                        }
                        else if (ceneoOffers == totalOffers)
                        {
                            <div class="form-check">
                                <input class="form-check-input sortFilter" type="radio" name="sortOption" id="sortPosition" value="position">
                                <label class="form-check-label" for="sortPosition">Sortuj po pozycji Ceneo</label>
                            </div>
                        }
                    </div>
                    <div style="margin-top: 16px;">
                        @if (!string.IsNullOrEmpty(googleUrl))
                        {
                            <a href="@googleUrl" class="Button-Page-Small-bl" target="_blank">
                                Google
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(url))
                        {
                            <a href="@url" class="Button-Page-Small-o" target="_blank">
                                Ceneo
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(externalUrl))
                        {
                            <a href="@externalUrl" class="Button-Page-Small" target="_blank">
                                Twoja strona
                            </a>
                        }
                    </div>
                </div>
            </div>
            <div style="display:flex; width:50%; height:130px; align-self:flex-end; margin-right:14px;">
                <canvas id="priceChart" width="100" height="100"></canvas>
            </div>
        </div>

        <!-- 1. Kontener z TABELĄ (domyślnie widoczny) -->
        <div id="priceTableContainer" class="Vert-table" style="display: block;">
            <table class="table-orders" id="priceTable">
                <thead>
                    <tr>
                        <th></th>
                        <!-- Nadajemy id, by łatwo móc zmieniać tekst nagłówka -->
                        <th id="storeHeader">Sklep (@totalOffers)</th>
                        <th>Cena</th>
                        <th>Różnica</th>
                        <th>Pozycja</th>
                        <th>Bid</th>
                        <th>Koszt wysyłki</th>
                        <th>Dostępność</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var priceDifference = item.Price - Model.Min(m => m.Price);
                        var isUniqueBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) == 1;
                        var isSharedBestPrice = item.Price == Model.Min(m => m.Price) && Model.Count(m => m.Price == item.Price) > 1;
                        var savings = isUniqueBestPrice ? Model.Where(m => m.Price > item.Price).OrderBy(m => m.Price).FirstOrDefault()?.Price - item.Price : (decimal?)null;

                        decimal priceDifferencePLN = item.Price - basePrice;
                        decimal percentageDifference = (basePrice > 0) ? ((item.Price - basePrice) / basePrice) * 100 : 0;

                        string getColorClass(decimal priceDifference, bool isUniqueBestPrice, bool isSharedBestPrice, decimal? savings)
                        {
                            if (isUniqueBestPrice && savings >= 0.01m && savings <= setPrice1)
                            {
                                return "prIdeal";
                            }
                            if (isUniqueBestPrice)
                            {
                                return "prToLow";
                            }
                            if (isSharedBestPrice)
                            {
                                return "prGood";
                            }
                            if (priceDifference <= 0)
                            {
                                return "prGood";
                            }
                            else if (priceDifference < setPrice2)
                            {
                                return "prMid";
                            }
                            else
                            {
                                return "prToHigh";
                            }
                        }

                        var colorClass = getColorClass(priceDifference, isUniqueBestPrice, isSharedBestPrice, savings);
                        var shippingCost = "";
                        if (item.ShippingCostNum == null)
                        {
                            shippingCost = "Brak danych";
                        }
                        else if (item.ShippingCostNum == 0)
                        {
                            shippingCost = "Free";
                        }
                        else
                        {

                            if (item.IsGoogle)
                            {
                                var cost = item.ShippingCostNum - item.Price;
                                shippingCost = cost <= 0 ? "Free" : $"{cost} PLN";
                            }

                            else
                            {
                                shippingCost = $"{item.ShippingCostNum} PLN";
                            }
                        }

                        string getAvailabilityClass(int? availabilityNum)
                        {
                            if (availabilityNum == null)
                            {
                                return "BD";
                            }
                            if (availabilityNum == 1)
                            {
                                return "Availability1Day";
                            }
                            if (availabilityNum == 3)
                            {
                                return "Availability3Days";
                            }
                            if (availabilityNum == 7)
                            {
                                return "Availability7Days";
                            }
                            if (availabilityNum == 14)
                            {
                                return "Availability14Days";
                            }
                            return "";
                        }

                        var availabilityClass = getAvailabilityClass(item.AvailabilityNum);

                        <tr class="price-row @colorClass" data-store-name="@item.StoreName" data-price="@item.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)" data-position="@item.Position">
                            <td>
                                <div class="color-bar @colorClass"></div>
                            </td>
                            <td class="store-name">
                                @item.StoreName
                            </td>
                            <td class="store-price">@item.Price PLN</td>
                            <td>
                                @if (item.StoreName != storeName && priceDifferencePLN != 0)
                                {
                                    var priceDiffFormatted = priceDifferencePLN.ToString("+#,##0.00;-#,##0.00") + " PLN";
                                    var percentageDiffFormatted = percentageDifference.ToString("+#,##0.00;-#,##0.00") + " %";
                                    var diffText = $"{priceDiffFormatted} ({percentageDiffFormatted})";
                                    if (priceDifferencePLN < 0)
                                    {
                                        <div class="priceBox-diff-up">@diffText</div>
                                    }
                                    else if (priceDifferencePLN > 0)
                                    {
                                        <div class="priceBox-diff-down">@diffText</div>
                                    }
                                    else
                                    {
                                        <div class="priceBox-diff-neutral">@diffText</div>
                                    }
                                }
                                else
                                {
                                    <div class="priceBox-diff-neutral">0,00 PLN (0,00 %)</div>
                                }
                            </td>
                            <td>
                                @if (item.Position != null)
                                {
                                    @if (item.IsGoogle == true)
                                    {
                                        <div class="Position-Google">Poz. Google @item.Position</div>
                                    }
                                    else
                                    {
                                        <div class="Position">Poz. Ceneo @item.Position</div>
                                    }
                                }
                                else
                                {
                                    <div class="Position" style="background-color: #414141;">Schowany</div>
                                }
                            </td>
                            <td>
                                @if (item.IsBidding == "1")
                                {
                                    <div class="Bidding">Bid</div>
                                }
                            </td>
                            <td>
                                @if (item.ShippingCostNum == null)
                                {
                                    <div class="BD">Brak danych</div>
                                }
                                else if (item.ShippingCostNum == 0)
                                {
                                    <div class="FreeShipping">Free</div>
                                }
                                else
                                {
                                    <div class="PaidShipping">@shippingCost</div>
                                }
                            </td>
                            <td>
                                <div class="@availabilityClass">
                                    @if (item.AvailabilityNum == 1)
                                    {
                                        <div>Wysyłka w 1 dzień</div>
                                    }
                                    else if (item.AvailabilityNum == 3)
                                    {
                                        <div>Wysyłka w 3 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 7)
                                    {
                                        <div>Wysyłka w 7 dni</div>
                                    }
                                    else if (item.AvailabilityNum == 14)
                                    {
                                        <div>Wysyłka w 14 dni</div>
                                    }
                                    else if (item.AvailabilityNum == null)
                                    {
                                        <div>Brak danych</div>
                                    }
                                </div>
                            </td>
                            <td class="data-chanel">
                                <img src="@Url.Content(item.IsGoogle ? "~/images/GoogleShopping.png" : "~/images/Ceneo.png")" alt="Channel Icon" style="width:24px; height:24px;" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Kontener WYKRESU + TOOLTIPA -->
        <div id="trendChartContainer">
            <div class="chart-column">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="range-container" style="margin-top:10px;">
                    <input type="range"
                           id="grayAlphaRange"
                           min="0"
                           max="0.6"
                           step="0.01"
                           value="0.3">
                </div>
            </div>
            <div id="customTrendTooltip">
                <!-- Tutaj JavaScript wstawia tabelkę z danymi -->
            </div>
        </div>
    </div>
</div>

<!-- Skrypty zewnętrzne -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>

    Chart.register(window['chartjs-plugin-annotation']);
</script>

<script>

    var pricesData = @Html.Raw(ViewBag.PricesDataJson ?? "[]");
    var chart;

    document.addEventListener("DOMContentLoaded", function () {

        const rows = Array.from(document.querySelectorAll(".price-row"));
        const observedStoreName = document.querySelector(".Vert").getAttribute("data-store-name").toLowerCase().trim();
        const headerEl = document.getElementById("storeHeader");

        function highlightObservedStore() {
            rows.forEach(function (row) {
                const storeName = row.getAttribute("data-store-name").toLowerCase().trim();
                if (storeName === observedStoreName) {
                    row.querySelector(".store-name").style.fontWeight = "bold";
                    row.querySelector(".store-price").style.fontWeight = "bold";
                } else {
                    row.querySelector(".store-name").style.fontWeight = "normal";
                    row.querySelector(".store-price").style.fontWeight = "normal";
                }
            });
        }

        function sortRowsByPrice() {

            rows.forEach(row => row.style.display = '');
            rows.sort((a, b) => {
                let priceA = parseFloat(a.getAttribute("data-price"));
                let priceB = parseFloat(b.getAttribute("data-price"));
                if (isNaN(priceA)) priceA = Infinity;
                if (isNaN(priceB)) priceB = Infinity;
                if (priceA === priceB) {
                    const storeA = a.getAttribute("data-store-name").toLowerCase();
                    const storeB = b.getAttribute("data-store-name").toLowerCase();
                    return storeA.localeCompare(storeB);
                }
                return priceA - priceB;
            });
            const tbody = document.querySelector("#priceTable tbody");
            rows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + rows.length + ")";
            highlightObservedStore();
        }

        function sortRowsByCeneoPosition() {

            const filteredRows = rows.filter(row => row.querySelector(".Position-Google") === null);
            filteredRows.sort((a, b) => {
                const posA = parseInt(a.getAttribute("data-position")) || Infinity;
                const posB = parseInt(b.getAttribute("data-position")) || Infinity;
                return posA - posB;
            });

            rows.forEach(row => {
                row.style.display = filteredRows.indexOf(row) === -1 ? 'none' : '';
            });
            const tbody = document.querySelector("#priceTable tbody");
            filteredRows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + filteredRows.length + " - Ceneo)";
            highlightObservedStore();
        }

        function sortRowsByGooglePosition() {

            const filteredRows = rows.filter(row => row.querySelector(".Position-Google") !== null);
            filteredRows.sort((a, b) => {
                const posA = parseInt(a.getAttribute("data-position")) || Infinity;
                const posB = parseInt(b.getAttribute("data-position")) || Infinity;
                return posA - posB;
            });

            rows.forEach(row => {
                row.style.display = filteredRows.indexOf(row) === -1 ? 'none' : '';
            });
            const tbody = document.querySelector("#priceTable tbody");
            filteredRows.forEach(row => tbody.appendChild(row));

            headerEl.textContent = "Sklep (" + filteredRows.length + " - Google)";
            highlightObservedStore();
        }

        function handleSortChange(event) {
            if (event.target.id === "sortPrice") {
                sortRowsByPrice();
            } else if (event.target.id === "sortPosition") {
                sortRowsByCeneoPosition();
            } else if (event.target.id === "sortGooglePosition") {
                sortRowsByGooglePosition();
            }
        }

        document.getElementById("sortPrice").addEventListener("click", handleSortChange);

        if(document.getElementById("sortPosition")){
            document.getElementById("sortPosition").addEventListener("click", handleSortChange);
        }
        if(document.getElementById("sortGooglePosition")){
            document.getElementById("sortGooglePosition").addEventListener("click", handleSortChange);
        }

        sortRowsByPrice();
        highlightObservedStore();

        var myStoreName = "@storeName";
        createChart(pricesData, myStoreName);
    });

    function createChart(pricesData, myStore) {
        const sortedData = pricesData.sort((a, b) => b.price - a.price);
        const sortedPrices = sortedData.map(item => item.price);
        const sortedStores = sortedData.map(item => item.store);
        const myStoreNormalized = myStore.toLowerCase().trim();

        const barColors = sortedData.map(item => {
            const storeNormalized = item.store.toLowerCase().trim();
            if (storeNormalized === myStoreNormalized) {
                if (item.isGoogle) {
                    return 'rgba(72, 142, 255, 0.6)';
                } else {
                    return 'rgba(255, 100, 0, 0.6)';
                }
            }
            return 'rgba(34, 34, 34, 0.4)';
        });

        const borderColors = sortedData.map(item => {
            const storeNormalized = item.store.toLowerCase().trim();
            if (storeNormalized === myStoreNormalized) {
                if (item.isGoogle) {
                    return 'rgba(72, 142, 255, 1)';
                } else {
                    return 'rgba(255, 100, 0, 1)';
                }
            }
            return 'rgba(34, 34, 34, 1)';
        });

        const ctx = document.getElementById('priceChart').getContext('2d');
        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedStores,
                datasets: [{
                    label: 'Cena PLN',
                    data: sortedPrices,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value + ' PLN';
                            }
                        }
                    },
                    x: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
</script>

<style>

    #trendChartContainer {
        display: flex;
        width: 100%;
        height: 65vh;
        margin-top: 10px;
    }

    .chart-column {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .chart-container {
        flex: 1 1 auto;
        min-height: 0;
    }

    #trendChart {
        max-width: 100%;
        height: 100%;
    }

    .range-container {
        margin-top: 8px;
    }

    #grayAlphaRange {
        width: 200px;
    }

    #customTrendTooltip {
        width: 400px;
        flex-shrink: 0;
        border-radius: 4px;
        margin-top: 8px;
        height: 64vh;
        overflow-y: auto;
        padding: 16px;
        background: #fefefe;
        border: 1px solid #ccc;
        font-size: 0.9rem;
        display: none;
    }

        #customTrendTooltip::-webkit-scrollbar {
            width: 4px;
        }

        #customTrendTooltip::-webkit-scrollbar-track {
            background: #fff;
        }

        #customTrendTooltip::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 5px;
        }

            #customTrendTooltip::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

    #showTableBtn {
        display: inline-flex;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        border-radius: 4px;
    }

    #showChartBtn {
        display: inline-flex;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        border-radius: 4px;
    }

    .button-active {
        background-color: #222222;
        color: white;
    }

    .button-inactive {
        background-color: #e3e3e3;
        color: #222222;
    }

    #grayAlphaRange {
        width: 300px;
        appearance: none;
        background: transparent;
        outline: none;
    }

        #grayAlphaRange::-webkit-slider-thumb {
            appearance: none;
            width: 15px;
            height: 15px;
            background-color: #666;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            margin-top: -5px;
        }

        #grayAlphaRange::-webkit-slider-runnable-track {
            background: #ccc;
            height: 5px;
            border-radius: 5px;
        }

        #grayAlphaRange::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background-color: #666;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        #grayAlphaRange::-moz-range-track {
            background: #ccc;
            height: 5px;
            border-radius: 5px;
        }

        #grayAlphaRange::-ms-thumb {
            width: 15px;
            height: 15px;
            background-color: #666;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            margin-top: 0px;
        }

        #grayAlphaRange::-ms-track {
            background: transparent;
            border-color: transparent;
            color: transparent;
            height: 5px;
            border-radius: 5px;
        }

        #grayAlphaRange::-ms-fill-lower {
            background: #ccc;
            border-radius: 5px;
        }

        #grayAlphaRange::-ms-fill-upper {
            background: #ccc;
            border-radius: 5px;
        }

</style>

<script>

    let productId = @ViewBag.ProductId;
    let myStoreLower = "@storeName".toLowerCase().trim();

    let highlightedStores = [];
    let storeColorMap = {};
    let lastHighlightedStore = null;

    const highlightColors = [
        'rgba(54, 162, 235, 1)',
        'rgba(255, 128, 0, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(100, 200, 100, 1)',
        'rgba(255, 51, 153, 1)',
        'rgba(255, 204, 0, 1)'
    ];

    let defaultGrayAlpha = 0.3;
    window.trendChartRef = null;
    window.currentTooltipDate = null;

    document.addEventListener("DOMContentLoaded", function () {
        const $showTableBtn = $('#showTableBtn');
        const $showChartBtn = $('#showChartBtn');
        const $tableContainer = $('#priceTableContainer');
        const $chartContainer = $('#trendChartContainer');

        $chartContainer.hide();

        $showTableBtn.on('click', function () {
            $chartContainer.hide();
            $tableContainer.show();
            $showTableBtn.removeClass('button-inactive').addClass('button-active');
            $showChartBtn.removeClass('button-active').addClass('button-inactive');
        });

        $showChartBtn.on('click', function () {
            $tableContainer.hide();
            $chartContainer.show();
            $showChartBtn.removeClass('button-inactive').addClass('button-active');
            $showTableBtn.removeClass('button-active').addClass('button-inactive');

            if (!window.trendChartRef) {
                loadTrendDataAndDrawChart();
            } else {

            }
        });

        const grayAlphaRange = document.getElementById("grayAlphaRange");
        if (grayAlphaRange) {
            grayAlphaRange.addEventListener("input", function (e) {
                defaultGrayAlpha = parseFloat(e.target.value);

                updateHighlightedLines();
            });
        }

        $('#showOnlyMyStoreBtn').on('click', function () {  });
        $('#showAllStoresBtn').on('click', function () {  });
    });

    function loadTrendDataAndDrawChart() {

        $.ajax({
            url: '@Url.Action("GetPriceTrendData", "PriceHistory")',
            type: 'GET',
            data: { productId: productId },
            success: function(response) {

                if (response && response.timelineData) {
                      drawTrendChart(response.timelineData);
                } else {

                      alert("Błąd formatu danych trendu!");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {

                alert("Błąd pobierania danych trendu!");
            }
        });
    }

    function drawTrendChart(timelineData) {

        const ctx = document.getElementById("trendChart").getContext("2d");

        let allDatesSet = new Set();
        timelineData.forEach(item => allDatesSet.add(item.scrapDate));
        let allDates = Array.from(allDatesSet).sort();

        let allStoresSet = new Set();
        timelineData.forEach(item => {
            item.pricesByStore.forEach(ps => allStoresSet.add(ps.storeName));
        });
        let allStores = Array.from(allStoresSet);

        let priceMap = {};
        timelineData.forEach(entry => {
            let date = entry.scrapDate;
            if (!priceMap[date]) priceMap[date] = {};
            entry.pricesByStore.forEach(ps => {
                priceMap[date][ps.storeName] = { price: ps.price, source: ps.source };
            });
        });

        let globalMinPrice = Number.POSITIVE_INFINITY;
        let globalMaxPrice = Number.NEGATIVE_INFINITY;
        timelineData.forEach(entry => {
            entry.pricesByStore.forEach(ps => {
                if (ps.price !== null && ps.price < globalMinPrice) globalMinPrice = ps.price;
                if (ps.price !== null && ps.price > globalMaxPrice) globalMaxPrice = ps.price;
            });
        });
        if (!isFinite(globalMinPrice)) globalMinPrice = 0;
        if (!isFinite(globalMaxPrice) || globalMaxPrice === globalMinPrice) globalMaxPrice = globalMinPrice + 100;

        let datasets = allStores.map(store => {
            let dataArray = [];
            let sourceArray = [];
            let pointRadii = [];
            let pointHoverRadii = [];
            const storeLower = store.toLowerCase().trim();

            allDates.forEach((date) => {
                const obj = priceMap[date]?.[store];
                const price = (obj && obj.price !== null && obj.price !== undefined) ? obj.price : null;
                const source = (obj && obj.source !== null && obj.source !== undefined) ? obj.source : null;
                dataArray.push(price);
                sourceArray.push(source);
            });

            const defaultPointRadius = 3;
            const hoverPointRadius = 3;
            for (let i = 0; i < dataArray.length; i++) {
                const currentPoint = dataArray[i];
                const prevPoint = (i > 0) ? dataArray[i - 1] : null;
                const nextPoint = (i < dataArray.length - 1) ? dataArray[i + 1] : null;
                let isTrulyIsolated = false;
                if (currentPoint !== null) {
                    const noPrevConnection = (i === 0 || prevPoint === null);
                    const noNextConnection = (i === dataArray.length - 1 || nextPoint === null);
                    isTrulyIsolated = noPrevConnection && noNextConnection;
                }
                pointRadii.push(isTrulyIsolated ? defaultPointRadius : 0);
                pointHoverRadii.push(isTrulyIsolated ? hoverPointRadius : 0);
            }

            let initialBorderColor = `rgba(128,128,128,${defaultGrayAlpha})`;
            let initialPointColor = initialBorderColor;
            let initialBorderWidth = 2;
            if (storeLower === myStoreLower) {
                initialBorderColor = 'rgba(197,0,0,1)';
                initialPointColor = initialBorderColor;
                initialBorderWidth = 2.5;
            }

            return {
                label: store,
                data: dataArray,
                sourceByIndex: sourceArray,
                borderColor: initialBorderColor,
                borderWidth: initialBorderWidth,
                fill: false,
                spanGaps: false,
                pointRadius: pointRadii,
                pointHoverRadius: pointHoverRadii,
                pointBackgroundColor: initialPointColor,
                pointBorderColor: initialPointColor,
                customPointRadii: pointRadii,
                customPointHoverRadii: pointHoverRadii,
                tension: 0.0,
                cubicInterpolationMode: 'monotone'
            };
        });

        datasets.sort((a, b) => {
            const priorityA = getStorePriority(a.label);
            const priorityB = getStorePriority(b.label);
            return priorityA - priorityB;
        });

       if (window.trendChartRef instanceof Chart) {

           window.trendChartRef.destroy();
           window.trendChartRef = null;
       }

        window.trendChartRef = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allDates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 600, easing: 'easeInOutQuad' },
                scales: {
                    x: { type: 'category', title: { display: false }, grid: { display: true, color: 'rgba(0,0,0,0.06)' } },
                    y: {
                        suggestedMin: globalMinPrice,
                        suggestedMax: globalMaxPrice,
                        grid: { display: true, color: 'rgba(0,0,0,0.06)' },
                        ticks: { callback: function(value) { return value + ' PLN'; } }
                    }
                },
                onHover: function(e) { e.native.target.style.cursor = 'crosshair'; },
                onClick: function(evt, elements, chart) {
                     if (!chart.data.labels || !chart.data.labels.length) return;
                     const canvasPos = Chart.helpers.getRelativePosition(evt, chart);
                     const xScale = chart.scales.x;
                     const labels = chart.data.labels;
                     let floatIndex = xScale.getValueForPixel(canvasPos.x);
                     let nearestIndex = Math.round(floatIndex);
                     nearestIndex = Math.max(0, Math.min(labels.length - 1, nearestIndex));
                     let xLabel = labels[nearestIndex];
                     if (!xLabel) return;

                     if (chart.config.options.plugins.annotation?.annotations?.crosshairLine) {
                         chart.config.options.plugins.annotation.annotations.crosshairLine.value = nearestIndex;
                         chart.update('none');
                         refreshCustomTooltip(chart, xLabel);
                     }
                },
                interaction: { mode: 'index', intersect: false, axis: 'x' },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false, external: externalTooltipHandler },
                    annotation: {
                        annotations: {
                            crosshairLine: {
                                type: 'line',
                                mode: 'vertical',
                                scaleID: 'x',
                                value: null,
                                borderColor: 'rgba(80,80,80,0.7)',
                                borderWidth: 2,
                                borderDash: [4,2],
                                hitRadius: 8,
                                draggable: true,
                                adjustScaleRange: false,
                                display: (ctx) => ctx.chart.config.options.plugins.annotation.annotations.crosshairLine.value != null,
                                enter: (ctx) => { ctx.chart.canvas.style.cursor = 'ew-resize'; },
                                leave: (ctx) => { ctx.chart.canvas.style.cursor = 'crosshair'; },
                                drag: function({chart, element}) {
                                     const labels = chart.data.labels;
                                     let nearestIndex = Math.round(element.value);
                                     nearestIndex = Math.max(0, Math.min(labels.length - 1, nearestIndex));
                                     let xLabel = labels[nearestIndex];
                                     if(xLabel) {
                                          refreshCustomTooltip(chart, xLabel);
                                     }
                                },

                            }
                        }
                    }
                }
            }
        });

        const defaultXValue = allDates[allDates.length - 1] || null;
        if (window.trendChartRef && defaultXValue) {
            let idxDefault = window.trendChartRef.data.labels.indexOf(defaultXValue);
            if (idxDefault < 0 && window.trendChartRef.data.labels.length > 0) {
                idxDefault = window.trendChartRef.data.labels.length - 1;
            }

            if (idxDefault >= 0) {
                if (window.trendChartRef.config.options.plugins.annotation?.annotations?.crosshairLine) {
                    window.trendChartRef.config.options.plugins.annotation.annotations.crosshairLine.value = idxDefault;

                    window.trendChartRef.update('none');
                    refreshCustomTooltip(window.trendChartRef, window.trendChartRef.data.labels[idxDefault]);

                } else {

                }
            }
        }

         updateHighlightedLines();
    }

    function findNextFreeColorIndex() {
        for (let i = 0; i < highlightColors.length; i++) {
            let used = Object.values(storeColorMap).includes(i);
            if (!used) return i;
        }
        return null;
    }

    function getStorePriority(datasetLabel) {
        const storeLower = datasetLabel.toLowerCase().trim();
        const isOurStore = (storeLower === myStoreLower);
        const isHighlighted = highlightedStores.includes(storeLower);
        const isLastHighlighted = (storeLower === lastHighlightedStore);

        if (isLastHighlighted) {
             return 4;
        }
        if (isOurStore) {
            return 3;
        }
        if (isHighlighted) {
            return 2;
        }
        return 1;
    }

    function sortDatasetsForDrawing(chart) {
        if (!chart || !chart.data || !chart.data.datasets) {

            return;
        }
        chart.data.datasets.sort((a, b) => {
            const priorityA = getStorePriority(a.label);
            const priorityB = getStorePriority(b.label);
            return priorityA - priorityB;
        });
    }

    function toggleStoreHighlight(storeName) {
        if (!window.trendChartRef) {

             return;
        }
        let sLower = storeName.toLowerCase().trim();
        let idx = highlightedStores.indexOf(sLower);

        if (idx >= 0) {

            highlightedStores.splice(idx, 1);
            delete storeColorMap[sLower];

            if (lastHighlightedStore === sLower) {
                lastHighlightedStore = highlightedStores.length > 0 ? highlightedStores[highlightedStores.length - 1] : null;

            }
        } else {

            if (highlightedStores.length >= highlightColors.length) {
                alert(`Możesz zaznaczyć maks. ${highlightColors.length} sklepów do porównania!`);
                return;
            }
            let cIndex = findNextFreeColorIndex();
            if (cIndex === null) {
                alert("Brak wolnych kolorów!");
                return;
            }
            if (!highlightedStores.includes(sLower)) {
                 highlightedStores.push(sLower);
            }
            storeColorMap[sLower] = cIndex;
            lastHighlightedStore = sLower;

        }

        sortDatasetsForDrawing(window.trendChartRef);

        updateHighlightedLines();

        if (window.currentTooltipDate) {
            refreshCustomTooltip(window.trendChartRef, window.currentTooltipDate);
        }
    }

    function updateHighlightedLines() {
        if (!window.trendChartRef) return;
        let chart = window.trendChartRef;

        chart.data.datasets.forEach(ds => {

             if (!ds.customPointRadii || !ds.customPointHoverRadii) {

                 ds.pointRadius = 0;
                 ds.pointHoverRadius = 0;
             } else {
                  ds.pointRadius = ds.customPointRadii;
                  ds.pointHoverRadius = ds.customPointHoverRadii;
             }

            let storeLower = ds.label.toLowerCase().trim();
            let cIndex = storeColorMap[storeLower];
            let isHighlighted = highlightedStores.includes(storeLower);
            let isOurStore = (storeLower === myStoreLower);
            let isLastHighlighted = (storeLower === lastHighlightedStore);

            let newBorderColor;
            let newPointColor;
    let newBorderWidth;

        if (isLastHighlighted && cIndex != null) {

            newBorderColor = highlightColors[cIndex];
            newBorderWidth = 4.0;
        } else if (isOurStore) {

            newBorderColor = 'rgba(197,0,0,1)';
            newBorderWidth = 4.0;
        } else if (isHighlighted && cIndex != null) {

            newBorderColor = highlightColors[cIndex];
            newBorderWidth = 4.0;
        } else {

            newBorderColor = `rgba(128,128,128,${defaultGrayAlpha})`;
            newBorderWidth = 2;
        }

            newPointColor = newBorderColor;

            ds.borderColor = newBorderColor;
            ds.borderWidth = newBorderWidth;
            ds.pointBackgroundColor = newPointColor;
            ds.pointBorderColor = newPointColor;
        });

          if (chart && chart.data && chart.data.datasets) {


  

    }

            chart.update('none');
    setTimeout(() => {

        if (window.trendChartRef) {
             chart.update('none');
        }
    }, 0);
    }

    function refreshCustomTooltip(chart, xLabel) {
        window.currentTooltipDate = xLabel;

        const tooltipEl = document.getElementById('customTrendTooltip');
        if (!tooltipEl) return;

        const labels = chart.data.labels;
        const dataIndex = labels.indexOf(xLabel);
        if (dataIndex < 0) {
             tooltipEl.style.display = 'none';
             return;
        }

        let items = [];

        chart.data.datasets.forEach(ds => {
            if (ds.hidden) return;
            const priceVal = ds.data[dataIndex];
            const sourceVal = ds.sourceByIndex ? ds.sourceByIndex[dataIndex] : null;

            if (priceVal !== null && priceVal !== undefined) {
                items.push({
                    storeName: ds.label,
                    price: priceVal,
                    source: sourceVal,

                    isHighlighted: highlightedStores.includes(ds.label.toLowerCase().trim()),
                    isMyStore: (ds.label.toLowerCase().trim() === myStoreLower),
                    isLastHighlighted: (ds.label.toLowerCase().trim() === lastHighlightedStore),
                    colorIndex: storeColorMap[ds.label.toLowerCase().trim()]
                });
            }
        });

        items.sort((a, b) => {
            if (a.price !== b.price) return a.price - b.price;
            return a.storeName.localeCompare(b.storeName);
        });

        let html = `<div style="font-weight:bold; margin-bottom:4px;">Data: ${xLabel}</div>`;
        if (items.length > 0) {
             html += `<table style="width:100%; border-collapse:collapse; font-size: 0.85rem;">`;
             items.forEach(item => {
                 let colorText = 'black';
                 let fontWeight = 'normal';
                 let bgColor = 'transparent';

                 if (item.isLastHighlighted && item.colorIndex != null) {
                     colorText = highlightColors[item.colorIndex];
                     fontWeight = 'bold';

                 } else if (item.isMyStore) {
                     colorText = 'rgba(197, 0, 0, 1)';
                     fontWeight = 'bold';

                 } else if (item.isHighlighted && item.colorIndex != null) {
                     colorText = highlightColors[item.colorIndex];

                 }

                 let displayName = item.storeName;
                 if (displayName.length > 35) displayName = displayName.substring(0, 32) + '...';

                 let iconHtml = (item.source === 'google')
                     ? `<img src="/images/GoogleShopping.png" alt="G" style="width:14px;height:14px;margin-right:4px; vertical-align: middle;" />`
                     : `<img src="/images/Ceneo.png" alt="C" style="width:14px;height:14px;margin-right:4px; vertical-align: middle;" />`;

                 html += `
                     <tr style="border-bottom:1px solid #eee; cursor:pointer; background-color: ${bgColor};"
                         onclick="event.stopPropagation(); toggleStoreHighlight('${item.storeName.replace(/'/g, "\\'")}')">
                         <td style="padding: 3px 2px; color:${colorText}; font-weight:${fontWeight}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                             ${iconHtml}${displayName}
                         </td>
                         <td style="padding: 3px 2px; text-align:right; color:${colorText}; font-weight:${fontWeight}; white-space:nowrap;">
                             ${item.price.toFixed(2)} PLN
                         </td>
                     </tr>
                 `;
             });
             html += `</table>`;
        } else {
             html += `<div style="color: #666; font-style: italic;">Brak danych dla tej daty.</div>`;
        }

        tooltipEl.innerHTML = html;
        tooltipEl.style.display = 'block';
    }

    function externalTooltipHandler(context) {
        const { chart, tooltip } = context;

         if (tooltip.opacity === 0) {

         }
    }

</script>