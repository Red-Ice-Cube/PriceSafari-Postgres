@model PriceSafari.Controllers.MemberControllers.FlagsController.FlagsListViewModel

@{
    ViewData["Title"] = "Zarządzanie Flagami";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="Vert">
    <div class="Vert-full" style="flex-direction:row;">
        <div style="display:flex; flex-direction:column; width:100%;">
            <div class="Order-Container-Title">
                Flagi (Porównywarki Cen) - @Model.StoreName
            </div>
            <div class="bar-List" style="max-height:64px; margin-top:32px;">
                <button class="Button-Page-Small create-flag-btn" data-marketplace="false">+ Nowa Flaga</button>
            </div>
            <div class="Vert-table">
                <table class="table-orders">
                    <thead>
                        <tr>
                            <th>Flaga</th>
                            <th>Typ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.StandardFlags)
                        {
                            <tr data-id="@item.FlagId" data-name="@item.FlagName" data-color="@item.FlagColor" data-marketplace="@item.IsMarketplace.ToString().ToLower()" class="flag-row">
                                <td>
                                    @{
                                        var color = item.FlagColor;
                                        var r = Convert.ToInt32(color.Substring(1, 2), 16);
                                        var g = Convert.ToInt32(color.Substring(3, 2), 16);
                                        var b = Convert.ToInt32(color.Substring(5, 2), 16);
                                        var rgbaColor = $"rgba({r}, {g}, {b}, 0.3)";
                                    }
                                    <div class="flag" style="background-color: @rgbaColor; color:@item.FlagColor; border: 2px solid @item.FlagColor;">
                                        @item.FlagName
                                    </div>
                                </td>
                                <td><img src="~/images/Ceneo.png" alt="Ceneo" style="height:20px; width:20px;" /><img src="~/images/GoogleShopping.png" alt="Google" style="height:20px; width:20px;" /></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (Model.HasAllegro)
        {

            <div style="display:flex; flex-direction:column; width:100%;">
                <div class="Order-Container-Title">
                    Flagi (Marketplace) - @Model.StoreName
                </div>
                <div class="bar-List" style="max-height:64px; margin-top:32px;">
                    <button class="Button-Page-Small create-flag-btn" data-marketplace="true">+ Nowa Flage</button>
                </div>
                <div class="Vert-table">
                    <table class="table-orders">
                        <thead>
                            <tr>
                                <th>Flaga</th>
                                <th>Typ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.MarketplaceFlags)
                            {
                                <tr data-id="@item.FlagId" data-name="@item.FlagName" data-color="@item.FlagColor" data-marketplace="@item.IsMarketplace.ToString().ToLower()" class="flag-row">
                                    <td>
                                        @{
                                            var color = item.FlagColor;
                                            var r = Convert.ToInt32(color.Substring(1, 2), 16);
                                            var g = Convert.ToInt32(color.Substring(3, 2), 16);
                                            var b = Convert.ToInt32(color.Substring(5, 2), 16);
                                            var rgbaColor = $"rgba({r}, {g}, {b}, 0.3)";
                                        }
                                        <div class="flag" style="background-color: @rgbaColor; color:@item.FlagColor; border: 2px solid @item.FlagColor;">
                                            @item.FlagName
                                        </div>
                                    </td>
                                    <td><img src="~/images/AllegroIcon.png" alt="Allegro" style="height:20px; width:20px;" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>


        }
    </div>
   
</div>

<div class="modal fade" id="editFlagModal" tabindex="-1" role="dialog" aria-labelledby="editFlagModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="editFlagModalLabel">Edytuj Flagę</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="editFlagForm">
                    <input type="hidden" id="editFlagId" />
                    <input type="hidden" id="editIsMarketplace" />

                    <div class="form-group mb-3">
                        <label for="editFlagName" class="control-label">Nazwa</label>
                        <input type="text" id="editFlagName" class="form-control" maxlength="16" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="editFlagColor" class="control-label">Kolor</label>
                        <input type="color" id="editFlagColor" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="Button-Page-Small-r" id="deleteFlag">Usuń Flagę</button>
                <button type="button" class="Button-Page-Small-b" id="saveFlagChanges">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createFlagModal" tabindex="-1" role="dialog" aria-labelledby="createFlagModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="price-box-column-name" id="createFlagModalLabel">Nowa Flaga</div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="createFlagForm">
                    <input type="hidden" id="createIsMarketplace" />
                    <div class="form-group mb-3">
                        <label for="createFlagName" class="control-label">Nazwa</label>
                        <input type="text" id="createFlagName" class="form-control" maxlength="16" />
                    </div>
                    <div class="form-group">
                        <label for="createFlagColor" class="control-label">Kolor</label>
                        <input type="color" id="createFlagColor" class="form-control" value="#2a72d9" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="Button-Action-Small" id="createFlag">Utwórz Flagę</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            // Otwieranie modala edycji
            $('.flag-row').on('click', function () {
                $('#editFlagId').val($(this).data('id'));
                $('#editFlagName').val($(this).data('name'));
                $('#editFlagColor').val($(this).data('color'));

                // --- POPRAWKA ---
                // Bezpośrednio pobieramy wartość boolean z atrybutu data-
                var isMarketplace = $(this).data('marketplace');
                $('#editIsMarketplace').val(isMarketplace);

                $('#editFlagModal').modal('show');
            });

            // Otwieranie modala tworzenia
            $('.create-flag-btn').on('click', function () {
                var isMarketplace = $(this).data('marketplace');
                $('#createIsMarketplace').val(isMarketplace);
                $('#createFlagName').val('');
                $('#createFlagColor').val('#2a72d9');
                $('#createFlagModalLabel').text(isMarketplace ? 'Nowa Flaga Marketplace' : 'Nowa Flaga Porównywarek');
                $('#createFlagModal').modal('show');
            });

            // Zapisywanie zmian (aktualizacja)
            $('#saveFlagChanges').on('click', function () {
                var flagData = {
                    id: $('#editFlagId').val(),
                    flagName: $('#editFlagName').val(),
                    flagColor: $('#editFlagColor').val(),
                    // Ta linia jest już poprawna i zadziała z poprawką powyżej
                    isMarketplace: $('#editIsMarketplace').val() === 'true'
                };

                $.ajax({
                    url: '@Url.Action("UpdateFlag", "Flags")',
                    type: 'POST',
                    data: flagData,
                    success: function () { location.reload(); },
                    error: function () { alert('Błąd podczas aktualizacji flagi'); }
                });
            });

            // Tworzenie nowej flagi
            $('#createFlag').on('click', function () {
                var flagData = {
                    FlagName: $('#createFlagName').val(),
                    FlagColor: $('#createFlagColor').val(),
                    IsMarketplace: $('#createIsMarketplace').val() === 'true',
                    StoreId: @Model.StoreId
                };

                $.ajax({
                    url: '@Url.Action("Create", "Flags")',
                    type: 'POST',
                    data: flagData,
                    success: function () { location.reload(); },
                    error: function () { alert('Błąd podczas tworzenia flagi'); }
                });
            });

            // Usuwanie flagi
            $('#deleteFlag').on('click', function () {
                if (!confirm('Czy na pewno chcesz usunąć tę flagę?')) return;

                $.ajax({
                    url: '@Url.Action("Delete", "Flags")',
                    type: 'POST',
                    data: { id: $('#editFlagId').val() },
                    success: function () { location.reload(); },
                    error: function () { alert('Błąd podczas usuwania flagi'); }
                });
            });
        });
    </script>
}