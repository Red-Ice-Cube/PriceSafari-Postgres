@model PriceSafari.Models.ViewModels.SafariReportAnalysisViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var flagsList = (List<PriceSafari.Models.FlagsClass>)ViewBag.Flags;
    var myStoreName = Model.StoreName;
}

<div class="Vert">
    <div class="Vert-full">

        <div class="Horizontal">
            <div class="order-upper-box">

                <input type="text" id="productSearch" placeholder="Wyszukaj produkt" class="product-search-box" />

                <select id="categoryFilter" class="DropDown">
                    <option value="">Wszystkie kategorie</option>
                </select>
                <select id="regionFilter" class="DropDown">
                    <option value="">Wszystkie regiony</option>
                    @foreach (var region in (Dictionary<int, string>)ViewBag.Regions)
                    {
                        if (region.Key == (int?)ViewBag.RegionId)
                        {
                            <option value="@region.Key" selected>@region.Value</option>
                        }
                        else
                        {
                            <option value="@region.Key">@region.Value</option>
                        }
                    }
                </select>

                <!-- Classification Controls -->
                <div class="classification-controls">
                    <!-- Threshold Inputs -->
                    <div class="threshold-settings">
                        <label for="threshold1">Tańsze o:</label>
                        <input type="number" id="threshold1" value="10.00" step="0.01" min="0.00">

                        <label for="threshold2">Droższe o:</label>
                        <input type="number" id="threshold2" value="5.00" step="0.01" min="0.00">
                    </div>

                    <!-- Use Price Difference Checkbox -->
                    <div>
                        <label>
                            <input class="diffCheckBox" type="checkbox" id="usePriceDifference" checked>
                            Użyj różnicy kwotowej
                        </label>
                    </div>

                    <!-- Classification Filters -->
                    <div class="classification-filters">
                        <div class="form-check">
                            <input class="form-check-input colorFilter" type="checkbox" id="prGoodCheckbox" value="prGood" checked>
                            <label class="form-check-label" for="prGoodCheckbox">Tańsze o więcej niż próg</label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input colorFilter" type="checkbox" id="prGrayCheckbox" value="prGray" checked>
                            <label class="form-check-label" for="prGrayCheckbox">W podobnej cenie</label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input colorFilter" type="checkbox" id="prToHighCheckbox" value="prToHigh" checked>
                            <label class="form-check-label" for="prToHighCheckbox">Droższe o więcej niż próg</label>
                        </div>
                    </div>
                </div>

                <div class="SimpleSpace">
                    <div class="SimpleHorizontal">
                        <div class="form-check-orders">
                            <div>
                                <p><strong>Raport cenowy:</strong> @Model.ReportName</p>
                                <p><strong>Data utworzenia:</strong> @Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</p>
                            </div>
                        </div>
                        <div class="form-check-orders">
                            <div>
                                <p><strong>Sklep:</strong> @Model.StoreName</p>
                                <p><strong>Odrzucone:</strong> <span id="missedProductsCount">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="Vert-table">
            <div id="priceContainer" class="price-container">
                @foreach (var item in Model.ProductPrices)
                {
                    var priceDifference = Math.Round(item.CalculatedPrice - item.OurCalculatedPrice, 2);

                    decimal? percentageDifference = null;
                    if (item.OurCalculatedPrice != 0)
                    {
                        percentageDifference = Math.Round(((item.CalculatedPrice - item.OurCalculatedPrice) / item.OurCalculatedPrice) * 100, 2);
                    }

                    var colorClass = "prGray"; // Default class

                    <div class="price-box @colorClass"
                         data-category="@item.Category"
                         data-pricedifference="@priceDifference.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                         data-percdifference="@(percentageDifference?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "null")"
                         data-colorclass="@colorClass"
                         onclick="window.open('@Url.Action("ProductPriceDetails", "Safari", new { reportId = ViewBag.ReportId, productId = item.ProductId, regionId = ViewBag.RegionId })', '_blank')">

                        <div class="price-box-space">
                            <div class="price-box-column-name">
                                @item.ProductName
                            </div>
                            <button class="assign-flag-button" data-product-id="@item.ProductId">+ Przypisz flagi</button>
                        </div>
                        <div class="price-box-column-category" style="margin-top:4px; margin-bottom:4px;">
                            @item.Category
                        </div>
                        <div class="price-box-data">
                            <div class="color-bar @colorClass" style="margin-right:16px; min-height:84px; max-height:84px;"></div>

                            @if (!string.IsNullOrEmpty(item.Product.MainUrl))
                            {
                                <img data-src="@item.Product.MainUrl" alt="@item.ProductName" class="product-image lazy-load" style="height:84px; width:84px;" />
                            }
                            else
                            {
                                <img data-src="/images/no-image.png" alt="Brak zdjęcia" class="product-image lazy-load" />
                            }
                            <div class="price-box-column" style="margin-left:8px;">
                                <div class="price-box-column-text">
                                    <span style="font-weight: 500;">@item.CalculatedPrice.ToString("0.00") zł</span><br />
                                    @item.StoreName
                                </div>
                                <div class="price-box-column-text">
                                    <div style="display:flex;">
                                        <img src="~/images/@(item.RegionName).png" alt="@item.RegionName" style="display:flex; align-self:center; width: 32px; height: 22px; margin-right:8px;" />
                                        @item.RegionName
                                    </div>
                                </div>
                            </div>

                            <div class="price-box-column">
                                @if (item.OurCalculatedPrice != 0)
                                {
                                    <div class="price-box-column-text">
                                        <span style="font-weight: 500;">@item.OurCalculatedPrice.ToString("0.00") zł</span><br />
                                        @myStoreName
                                    </div>
                                    <div class="price-box-column-text">
                                        <div style="display:flex;">
                                            <img src="~/images/@(item.OurRegionName).png" alt="@item.OurRegionName" style="display:flex; align-self:center; width: 32px; height: 22px; margin-right:8px;" />
                                            @item.OurRegionName
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="price-box-column-text">
                                        <span style="font-weight: 500;">Brak Ceny</span><br />
                                        @myStoreName
                                    </div>
                                }
                            </div>

                            @if (item.OurCalculatedPrice != 0)
                            {
                                <div class="price-box-column-action">
                                    <p class="price-diff-display"></p>
                                </div>
                            }

                            <div class="flags-container">
                                @if (item.FlagIds.Any())
                                {
                                    foreach (var flagId in item.FlagIds)
                                    {
                                        var flag = flagsList.FirstOrDefault(f => f.FlagId == flagId);
                                        if (flag != null)
                                        {
                                            <span class="flag" style="color:@flag.FlagColor; border: 2px solid @flag.FlagColor; background-color:@HexToRgba(flag.FlagColor, 0.3);">@flag.FlagName</span>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Section -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const lazyLoadImages = document.querySelectorAll('.lazy-load');
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        });

        lazyLoadImages.forEach(img => {
            observer.observe(img);
        });

        // Category Filter Initialization
        const categories = new Set();
        document.querySelectorAll('.price-box-column-category').forEach(categoryElement => {
            const category = categoryElement.textContent.trim();
            if (category) {
                categories.add(category);
            }
        });

        const categoryDropdown = document.getElementById('categoryFilter');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryDropdown.appendChild(option);
        });

        let allProducts = Array.from(document.querySelectorAll('.price-box'));
        const searchInput = document.getElementById('productSearch');

        // Sanitize String Function
        function sanitizeString(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
        }

        // Highlight Matches Function
        function highlightMatches(productName, searchTerm) {
            if (!searchTerm) return productName;

            const sanitizedSearchTerm = searchTerm.replace(/[^a-zA-Z0-9\s/.-]/g, '').trim().toLowerCase();
            const regex = new RegExp(`(${sanitizedSearchTerm.split('').join('\\s*')})`, 'gi'); // Allows gaps
            return productName.replace(regex, '<span style="color: #9400D3; font-weight: bold;">$1</span>');
        }

        // Filter Products Function
        function filterProducts() {
            const searchTerm = sanitizeString(searchInput.value.trim());
            const selectedCategory = categoryDropdown.value;

            let filteredProducts = [];

            allProducts.forEach(productBox => {
                const productNameElement = productBox.querySelector('.price-box-column-name');
                const productName = productNameElement.textContent.trim();
                const productCategory = productBox.getAttribute('data-category');
                const sanitizedProductName = sanitizeString(productName);

                const matchesSearch = sanitizedProductName.includes(searchTerm);
                const matchesCategory = selectedCategory === '' || productCategory === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    filteredProducts.push({
                        productBox: productBox,
                        productNameElement: productNameElement,
                        exactMatch: sanitizedProductName === searchTerm,
                        matchIndex: sanitizedProductName.indexOf(searchTerm)
                    });
                } else {
                    productBox.style.display = 'none'; // Hide non-matching products
                }
            });

            // Sort and Display Filtered Products
            filteredProducts.sort((a, b) => {
                if (a.exactMatch && !b.exactMatch) return -1;
                if (!a.exactMatch && b.exactMatch) return 1;
                return a.matchIndex - b.matchIndex;
            });

            filteredProducts.forEach(item => {
                item.productNameElement.innerHTML = highlightMatches(item.productNameElement.textContent, searchInput.value);
                item.productBox.style.display = 'block';
            });

            // Apply Classification Filters
            filterByClassification();
        }

        searchInput.addEventListener('input', filterProducts);
        categoryDropdown.addEventListener('change', filterProducts);

        // Classification Logic
        const threshold1Input = document.getElementById('threshold1');
        const threshold2Input = document.getElementById('threshold2');
        const usePriceDifferenceCheckbox = document.getElementById('usePriceDifference');
        const colorFilters = document.querySelectorAll('.colorFilter');

        function classifyProducts() {
            let thresholdCheaper = parseFloat(threshold1Input.value);
            let thresholdMoreExpensive = parseFloat(threshold2Input.value);
            const usePriceDifference = usePriceDifferenceCheckbox.checked;

            // Handle invalid inputs
            if (isNaN(thresholdCheaper) || thresholdCheaper < 0) thresholdCheaper = 0;
            if (isNaN(thresholdMoreExpensive) || thresholdMoreExpensive < 0) thresholdMoreExpensive = 0;

            allProducts.forEach(productBox => {
                const priceDifference = parseFloat(productBox.getAttribute('data-pricedifference')) || 0;
                const percentageDifferenceAttr = productBox.getAttribute('data-percdifference');
                let percentageDifference = percentageDifferenceAttr !== 'null' ? parseFloat(percentageDifferenceAttr) : null;

                let differenceValue = usePriceDifference ? priceDifference : (percentageDifference !== null ? percentageDifference : 0);

                // Round differenceValue to 2 decimal places
                differenceValue = parseFloat(differenceValue.toFixed(2));

                let colorClass = 'prGray'; // Default class (grey)

                if (differenceValue <= -thresholdCheaper) {
                    // Competitor is cheaper by at least thresholdCheaper
                    colorClass = 'prGood'; // Green
                } else if (differenceValue >= thresholdMoreExpensive) {
                    // Competitor is more expensive by at least thresholdMoreExpensive
                    colorClass = 'prToHigh'; // Red
                } else {
                    // Price difference is within thresholds
                    colorClass = 'prGray'; // Grey
                }

                // Update Class and Data Attribute
                productBox.classList.remove('prToHigh', 'prGood', 'prGray');
                productBox.classList.add(colorClass);
                productBox.setAttribute('data-colorclass', colorClass);

                // Update Price Difference Display
                const priceDiffDisplay = productBox.querySelector('.price-diff-display');
                if (priceDiffDisplay) {
                    const epsilon = 0.005;

                    const roundedPriceDifference = parseFloat(priceDifference.toFixed(2));
                    let priceDiffText = '';

                    if (Math.abs(roundedPriceDifference) < epsilon) {
                        priceDiffText += 'Cena taka sama<br>';
                    } else if (roundedPriceDifference < 0) {
                        priceDiffText += `Taniej o: ${Math.abs(roundedPriceDifference).toFixed(2)} zł<br>`;
                    } else {
                        priceDiffText += `Drożej o: ${roundedPriceDifference.toFixed(2)} zł<br>`;
                    }

                    if (percentageDifference !== null) {
                        const roundedPercentageDifference = parseFloat(percentageDifference.toFixed(2));
                        if (Math.abs(roundedPercentageDifference) < epsilon) {
                            priceDiffText += 'Cena taka sama';
                        } else if (roundedPercentageDifference < 0) {
                            priceDiffText += `Taniej o: ${Math.abs(roundedPercentageDifference).toFixed(2)} %`;
                        } else {
                            priceDiffText += `Drożej o: ${roundedPercentageDifference.toFixed(2)} %`;
                        }
                    } else {
                        priceDiffText += 'Brak danych procentowych';
                    }

                    priceDiffDisplay.innerHTML = priceDiffText;
                }
            });
        }

        function filterByClassification() {
            const selectedClasses = Array.from(colorFilters)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            allProducts.forEach(productBox => {
                const colorClass = productBox.getAttribute('data-colorclass');
                if (selectedClasses.includes(colorClass)) {
                    if (productBox.style.display !== 'none') {
                        productBox.style.display = 'block';
                    }
                } else {
                    productBox.style.display = 'none';
                }
            });
        }

        function updateProducts() {
            classifyProducts();
            filterProducts(); // This function calls filterByClassification() internally
        }

        // Event listeners
        threshold1Input.addEventListener('input', updateProducts);
        threshold2Input.addEventListener('input', updateProducts);
        usePriceDifferenceCheckbox.addEventListener('change', updateProducts);
        colorFilters.forEach(checkbox => checkbox.addEventListener('change', updateProducts));

        // Initial Load
        updateProducts();
    });
</script>

<script>
    document.getElementById('regionFilter').addEventListener('change', function () {
        var selectedRegionId = this.value;
        var url = new URL(window.location.href);

        if (selectedRegionId) {
            url.searchParams.set('regionId', selectedRegionId);
        } else {
            url.searchParams.delete('regionId');
        }

        window.location.href = url.toString();
    });
</script>

@functions {
    string HexToRgba(string hex, double alpha)
    {
        int r = 0, g = 0, b = 0;
        if (hex.Length == 7)
        {
            r = int.Parse(hex.Substring(1, 2), System.Globalization.NumberStyles.HexNumber);
            g = int.Parse(hex.Substring(3, 2), System.Globalization.NumberStyles.HexNumber);
            b = int.Parse(hex.Substring(5, 2), System.Globalization.NumberStyles.HexNumber);
        }
        return $"rgba({r}, {g}, {b}, {alpha.ToString(System.Globalization.CultureInfo.InvariantCulture)})";
    }
}
