@model PriceSafari.Models.ViewModels.SafariReportAnalysisViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var flagsList = (List<PriceSafari.Models.FlagsClass>)ViewBag.Flags;
    var myStoreName = Model.StoreName;
}

<div class="Vert">
    <div class="Vert-full">

        <div class="Horizontal">
            <div class="order-upper-box">

                <input type="text" id="productSearch" placeholder="Wyszukaj produkt" class="product-search-box" />

                <select id="categoryFilter" class="DropDown">
                    <option value="">Wszystkie kategorie</option>
                </select>

                <div class="SimpleSpace">
                    <div class="SimpleHorizontal">
                        <div class="form-check-orders">
                            <div>

                                <p><strong>Raport cenowy:</strong> @Model.ReportName</p>
                                <p><strong>Data utworzenia:</strong> @Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</p>
                            </div>
                        </div>
                        <div class="form-check-orders">

                            <div>
                                <p><strong>Sklep:</strong> @Model.StoreName</p>
                                <p><strong>Odrzucone:</strong> <span id="missedProductsCount">0</span></p>
                            </div>

                        </div>
                    </div>

                </div>

            </div>
        </div>

        <div class="Vert-table">
            <div id="priceContainer" class="price-container">
                @foreach (var item in Model.ProductPrices)
                {
                    var priceDifference = Math.Round(item.CalculatedPrice - item.OurCalculatedPrice, 2);
                    var percentageDifference = item.OurCalculatedPrice != 0
                    ? Math.Round(((item.CalculatedPrice - item.OurCalculatedPrice) / item.OurCalculatedPrice) * 100, 2)
                    : 0;

                    var colorClass = item.OurCalculatedPrice == 0 ? "prGray" : GetColorClass(priceDifference, percentageDifference);

                    <div class="price-box @colorClass" data-category="@item.Category" onclick="window.location.href='@Url.Action("ProductPriceDetails", "Safari", new { reportId = ViewBag.ReportId, productId = item.ProductId })'">
                        <div class="price-box-space">
                            <div class="price-box-column-name">
                                @item.ProductName
                            </div>
                            <button class="assign-flag-button" data-product-id="@item.ProductId">+ Przypisz flagi</button>
                        </div>
                        <div class="price-box-column-category" style="margin-top:4px; margin-bottom:4px;">
                            @item.Category
                        </div>
                        <div class="price-box-data">
                            <div class="color-bar @colorClass" style="margin-right:16px; min-height:84px; max-height:84px;"></div>

                            @if (!string.IsNullOrEmpty(item.Product.MainUrl))
                            {
                                <img data-src="@item.Product.MainUrl" alt="@item.ProductName" class="product-image lazy-load" style="height:84px; width:84px;" />
                            }
                            else
                            {
                                <img data-src="/images/no-image.png" alt="Brak zdjęcia" class="product-image lazy-load" />
                            }
                            <div class="price-box-column" style="margin-left:8px;">
                                <div class="price-box-column-text">
                                    <span style="font-weight: 500;">@item.CalculatedPrice.ToString("0.00") zł</span><br />
                                    @item.StoreName
                                </div>
                                <div class="price-box-column-text">
                                    <div style="display:flex;">
                                        <img src="~/images/@(item.RegionName).png" alt="@item.RegionName" style="display:flex; align-self:center; width: 32px; height: 22px; margin-right:8px;" />
                                        @item.RegionName
                                    </div>
                                </div>
                            </div>

                            <div class="price-box-column">
                                @if (item.OurCalculatedPrice != 0)
                                {
                                    <div class="price-box-column-text">
                                        <span style="font-weight: 500;">@item.OurCalculatedPrice.ToString("0.00") zł</span><br />
                                        @myStoreName
                                    </div>
                                    <div class="price-box-column-text">
                                        <div style="display:flex;">
                                            <img src="~/images/@(item.OurRegionName).png" alt="@item.OurRegionName" style="display:flex; align-self:center; width: 32px; height: 22px; margin-right:8px;" />
                                            @item.OurRegionName
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="price-box-column-text">
                                        <span style="font-weight: 500;">Brak Ceny</span><br />
                                        @myStoreName
                                    </div>
                                }
                            </div>

                            @if (item.OurCalculatedPrice != 0)
                            {
                                <div class="price-box-column-action">
                                    @if (priceDifference < 0)
                                    {
                                        <p>Taniej o: @Math.Abs(priceDifference).ToString("0.00") zł</p>
                                        <p>Taniej o: @Math.Abs(percentageDifference).ToString("0.00") %</p>
                                    }
                                    else if (priceDifference > 0)
                                    {
                                        <p>Masz najtańszą cene o: @priceDifference.ToString("0.00") zł</p>
                                        <p>Masz najtańszą cene o: @percentageDifference.ToString("0.00") %</p>
                                    }
                                    else
                                    {
                                        <p>Brak działań</p>
                                    }
                                </div>
                            }

                            <div class="flags-container">
                                @if (item.FlagIds.Any())
                                {
                                    foreach (var flagId in item.FlagIds)
                                    {
                                        var flag = flagsList.FirstOrDefault(f => f.FlagId == flagId);
                                        if (flag != null)
                                        {
                                            <span class="flag" style="color:@flag.FlagColor; border: 2px solid @flag.FlagColor; background-color:@HexToRgba(flag.FlagColor, 0.3);">@flag.FlagName</span>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const lazyLoadImages = document.querySelectorAll('.lazy-load');
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        });

        lazyLoadImages.forEach(img => {
            observer.observe(img);
        });

        // Zbieranie unikalnych kategorii i wypełnianie dropdownu
        const categories = new Set();
        document.querySelectorAll('.price-box-column-category').forEach(categoryElement => {
            const category = categoryElement.textContent.trim();
            if (category) {
                categories.add(category);
            }
        });

        const categoryDropdown = document.getElementById('categoryFilter');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryDropdown.appendChild(option);
        });

        let allProducts = Array.from(document.querySelectorAll('.price-box'));
        const searchInput = document.getElementById('productSearch');

        // Funkcja, która sanitizuje string (usuwa spacje, znaki specjalne itp.)
        function sanitizeString(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
        }

        // Funkcja, która podświetla pasujące fragmenty
        function highlightMatches(productName, searchTerm) {
            if (!searchTerm) return productName;

            const sanitizedSearchTerm = searchTerm.replace(/[^a-zA-Z0-9\s/.-]/g, '').trim().toLowerCase();
            const regex = new RegExp(`(${sanitizedSearchTerm.split('').join('\\s*')})`, 'gi'); // Dopuszcza przerwy
            return productName.replace(regex, '<span style="color: #9400D3; font-weight: bold;">$1</span>');
        }

        // Główna funkcja do filtrowania produktów po nazwie i kategorii
        function filterProducts() {
            const searchTerm = sanitizeString(searchInput.value.trim());
            const selectedCategory = categoryDropdown.value;

            let filteredProducts = [];

            allProducts.forEach(productBox => {
                const productNameElement = productBox.querySelector('.price-box-column-name');
                const productName = productNameElement.textContent.trim();
                const productCategory = productBox.getAttribute('data-category');
                const sanitizedProductName = sanitizeString(productName);

                // Filtrujemy po nazwie produktu i wybranej kategorii
                const matchesSearch = sanitizedProductName.includes(searchTerm);
                const matchesCategory = selectedCategory === '' || productCategory === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    filteredProducts.push({
                        productBox: productBox,
                        productNameElement: productNameElement,
                        exactMatch: sanitizedProductName === searchTerm,
                        matchIndex: sanitizedProductName.indexOf(searchTerm)
                    });
                } else {
                    productBox.style.display = 'none'; // Ukrywanie elementów, które nie pasują
                }
            });

            // Sortowanie: dokładne dopasowania wcześniej, potem na podstawie indeksu dopasowania
            filteredProducts.sort((a, b) => {
                if (a.exactMatch && !b.exactMatch) return -1;
                if (!a.exactMatch && b.exactMatch) return 1;
                return a.matchIndex - b.matchIndex;
            });

            // Wyświetlanie i podświetlanie wyników
            filteredProducts.forEach(item => {
                item.productNameElement.innerHTML = highlightMatches(item.productNameElement.textContent, searchInput.value);
                item.productBox.style.display = 'block';
            });
        }

        searchInput.addEventListener('input', filterProducts);
        categoryDropdown.addEventListener('change', filterProducts);
    });
</script>

@functions {
    string GetColorClass(decimal priceDifference, decimal percentageDifference)
    {
        if (priceDifference < 0)
        {
            if (Math.Abs(priceDifference) <= 2.00m)
                return "prGood";
            else if (Math.Abs(priceDifference) <= 5.00m)
                return "prMid";
            else
                return "prToHigh";
        }
        else if (priceDifference > 0)
        {
            if (priceDifference <= 2.00m)
                return "prIdeal";
            else
                return "prToLow";
        }
        else
        {
            return "prGood";
        }
    }

    string HexToRgba(string hex, double alpha)
    {
        int r = 0, g = 0, b = 0;
        if (hex.Length == 7)
        {
            r = int.Parse(hex.Substring(1, 2), System.Globalization.NumberStyles.HexNumber);
            g = int.Parse(hex.Substring(3, 2), System.Globalization.NumberStyles.HexNumber);
            b = int.Parse(hex.Substring(5, 2), System.Globalization.NumberStyles.HexNumber);
        }
        return $"rgba({r}, {g}, {b}, {alpha})";
    }
}