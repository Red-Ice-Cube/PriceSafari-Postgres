@model PriceSafari.Models.ViewModels.ProductPriceDetailsViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    int position = 1;
    var countryProductCounts = Model.Prices
        .GroupBy(p => p.RegionName)
        .ToDictionary(g => g.Key, g => g.Count());

    // Get the base price from your own store
    decimal basePrice = 0;
    var myStorePrice = Model.Prices.FirstOrDefault(p => string.Equals(p.StoreName, Model.MyStore, StringComparison.OrdinalIgnoreCase));
    if (myStorePrice != null)
    {
        basePrice = myStorePrice.CalculatedPrice;
    }
}

<div class="Vert">
    <div class="Page-Box">
        <div class="price-box-space">
            <div class="price-box-column-name">
                @Model.ProductName
                <div class="form-check-orders" style="margin: 16px;">
                    <div>
                        <p><strong>Raport:</strong> @Model?.RaportName</p>
                        <p><strong>Sklep:</strong> @Model.MyStore</p>
                    </div>
                </div>
                <div style="margin-top: 50px;">
                    <select id="countryFilter" class="DropDown" style="width: 220px;" onchange="filterByCountry()">
                        @if (ViewBag.SelectedRegionName == null)
                        {
                            <option value="All" selected>
                                Wszystkie kraje (@Model.Prices.Count())
                            </option>
                        }
                        else
                        {
                            <option value="All">
                                Wszystkie kraje (@Model.Prices.Count())
                            </option>
                        }

                        @foreach (var country in countryProductCounts)
                        {
                            if (country.Key == (string)ViewBag.SelectedRegionName)
                            {
                                <option value="@country.Key" selected>
                                    @country.Key (@country.Value)
                                </option>
                            }
                            else
                            {
                                <option value="@country.Key">
                                    @country.Key (@country.Value)
                                </option>
                            }
                        }
                    </select>

                    <button type="button" class="Button-Page-Small-bl" id="locateStoreButton">
                        Zlokalizuj mnie
                    </button>
                    <button type="button" class="Button-Page-Small-b" onclick="window.open('@Model.GoogleProductUrl', '_blank')">
                        Google Products
                    </button>
                </div>
            </div>
            <div style="display:flex; width:50%; height:180px;">
                <canvas id="priceChart" width="100%" height="100"></canvas>
            </div>
            @if (!string.IsNullOrEmpty(Model.ProductImg))
            {
                <div>
                    <img src="@Model.ProductImg" style="height: 180px; width: 180px;" />
                </div>
            }
        </div>

        <!-- Table with offers -->
        <div class="Vert-table">
            <table class="table-orders">
                <thead>
                    <tr>
                        <th>Sklep</th>
                        <th>Pozycja</th>
                        <th>Kraj</th>
                        <th>Cena PLN</th>
                        <th>Różnica</th> <!-- New column for price difference -->                  
                        <th>Dostawa PLN</th>
                        <th>Cena</th>
                        <th>Dostawa</th>
                        <th>Ofert</th>
                    </tr>
                </thead>
                <tbody id="offersTableBody">
                    @foreach (var price in Model.Prices)
                    {
                        decimal priceDifference = 0;
                        decimal percentageDifference = 0;

                        if (basePrice > 0 && price.CalculatedPrice > 0 && price.StoreName != Model.MyStore)
                        {
                            priceDifference = price.CalculatedPrice - basePrice;
                            percentageDifference = (priceDifference / basePrice) * 100;
                        }

                        <tr data-country="@price.RegionName" data-store="@price.StoreName">

                            <td>
                                @if (string.Equals(price.StoreName, Model.MyStore, StringComparison.OrdinalIgnoreCase))
                                {
                                    <strong>@price.StoreName</strong>
                                }
                                else
                                {
                                    @price.StoreName
                                }
                            </td>
                            <td><div class="Position">Msc @position</div></td>
                            <td>
                                <div style="display:flex;">
                                    <img src="~/images/@(price.RegionName).png" alt="@price.RegionName" style="display:flex; align-self:center; width: 32px; height: 22px; margin-right:8px;" />
                                    @price.RegionName
                                </div>
                            </td>
                            <td>@price.CalculatedPrice.ToString("0.00") PLN</td>
                            <td>
                                @if (price.StoreName != Model.MyStore && basePrice > 0 && price.CalculatedPrice > 0)
                                {
                                    var priceDiffFormatted = priceDifference.ToString("+#,##0.00;-#,##0.00");
                                    var percentageDiffFormatted = percentageDifference.ToString("+#,##0.00;-#,##0.00");

                                    var diffText = $"{priceDiffFormatted} PLN ({percentageDiffFormatted}%)";

                                    if (priceDifference < 0)
                                    {
                                        <div class="priceBox-diff-up">@diffText</div>
                                    }
                                    else if (priceDifference > 0)
                                    {
                                        <div class="priceBox-diff-down">@diffText</div>
                                    }
                                    else
                                    {
                                        <div class="priceBox-diff-neutral">@diffText</div>
                                    }
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>

                            <td>
                                @if ((price.CalculatedPriceWithDelivery - price.CalculatedPrice) == 0)
                                {
                                    <div class="FreeShipping">Free</div>
                                }
                                else
                                {
                                    <div class="PaidShipping">@((price.CalculatedPriceWithDelivery - price.CalculatedPrice).ToString("0.00")) PLN</div>
                                }
                            </td>
                            <td>@price.Price.ToString("0.00") @price.Currency</td>
                            <td>
                                @if ((price.PriceWithDelivery - price.Price) == 0)
                                {
                                    <div class="FreeShipping">Free</div>
                                }
                                else
                                {
                                    <div class="PaidShipping">@((price.PriceWithDelivery - price.Price).ToString("0.00")) @price.Currency</div>
                                }
                            </td>
                            <td>
                                <button type="button" class="Button-Page-Small" onclick="window.open('@price.OfferUrl', '_blank')">
                                    Oferta
                                </button>
                            </td>
                        </tr>
                        position++;
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- JavaScript for filtering offers and updating the chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var chart; // Global variable to hold the chart instance

    function filterByCountry() {
        var selectedCountry = document.getElementById('countryFilter').value;
        var rows = document.querySelectorAll('#offersTableBody tr');
        var myStore = '@Model.MyStore'.toLowerCase();

        var pricesData = [];
        var position = 1;

        rows.forEach(function (row) {
            var country = row.getAttribute('data-country');
            var storeName = row.getAttribute('data-store').trim();
            var storeNameLower = storeName.toLowerCase();
            var priceCell = row.querySelector('td:nth-child(4)');
            var priceText = priceCell.textContent.trim().replace('PLN', '').trim();
            var price = parseFloat(priceText.replace(',', '.'));

            var isMyStore = storeNameLower === myStore;

            // Determine if the row should be displayed
            if (selectedCountry === 'All' || country === selectedCountry || isMyStore) {
                row.style.display = '';

                // Update position number
                var positionCell = row.querySelector('.Position');
                positionCell.textContent = 'Msc ' + position;
                position++;

                // Collect data for the chart
                pricesData.push({ price: price, store: storeName });

            } else {
                row.style.display = 'none';
            }
        });

        // Update the chart with the new data
        createChart(pricesData, myStore);
    }

    function createChart(pricesData, myStore) {
        // Sort data from highest to lowest price
        const sortedData = pricesData.sort((a, b) => b.price - a.price);

        const sortedPrices = sortedData.map(item => item.price);
        const sortedStores = sortedData.map(item => item.store);

        const barColors = sortedStores.map(store => {
            return store.toLowerCase() === myStore ? 'rgba(65, 199, 199, 0.4)' : 'rgba(34, 34, 34, 0.4)';
        });

        const borderColors = sortedStores.map(store => {
            return store.toLowerCase() === myStore ? 'rgba(65, 199, 199, 1)' : 'rgba(34, 34, 34, 1)';
        });

        const ctx = document.getElementById('priceChart').getContext('2d');

        // Destroy existing chart instance if it exists
        if (chart) {
            chart.destroy();
        }

        // Create new chart
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedStores,
                datasets: [{
                    label: 'Cena PLN',
                    data: sortedPrices,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value + ' PLN';
                            }
                        }
                    },
                    x: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Apply the filter and update chart when the page loads
    document.addEventListener("DOMContentLoaded", function () {
        filterByCountry();
    });

    // Update chart when the country filter changes
    document.getElementById('countryFilter').addEventListener('change', filterByCountry);

    // "Locate Me" button functionality
    document.getElementById('locateStoreButton').addEventListener('click', function () {
        var tableContainer = document.querySelector('.Vert-table');
        var rows = document.querySelectorAll('table.table-orders tbody tr');
        var found = false;

        rows.forEach(function (row) {
            var storeCell = row.querySelector('td strong');
            if (storeCell && row.style.display !== 'none') {
                var rowOffset = row.offsetTop - tableContainer.offsetTop;
                tableContainer.scrollTo({
                    top: rowOffset - (tableContainer.clientHeight / 2) + (row.clientHeight / 2),
                    behavior: 'smooth'
                });

                row.style.backgroundColor = 'lightgray';
                setTimeout(function () {
                    row.style.transition = 'background-color 1s ease';
                    row.style.backgroundColor = '';
                }, 1000);

                found = true;
            }
        });

        if (!found) {
            alert('Nie znaleziono Twojego sklepu.');
        }
    });
</script>
