@model List<PriceSafari.Models.PriceSafariReport>
@using Microsoft.AspNetCore.Identity
@inject UserManager<PriceSafariUser> UserManager

@{
    ViewData["Title"] = "Raporty Safari";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var storeId = ViewBag.StoreId;
    var reportCountries = ViewBag.ReportCountries as Dictionary<int, List<string>>;

    var user = await UserManager.GetUserAsync(User);
    bool hasCreateReportPermission = user?.AccesToCreateSafari ?? false;
}

<div class="Vert">
    <div class="Vert-full">
        <div class="price-box-space">
            <div class="Order-Container-Title">
                Raporty Safari dla sklepu @ViewBag.StoreName
            </div>
            @if (hasCreateReportPermission)
            {
                <a href="@Url.Action("Index", "Safari", new { storeId = ViewBag.StoreId })" class="Button-Action-Small">Dodaj raport</a>
            }
            else
            {
                <button type="button" class="Button-Action-Small" onclick="alert('Twoje uprawnienia nie pozwalają na tworzenie nowych raportów.')">Dodaj raport</button>
            }

        </div>

        @if (Model.Any())
        {
            <div class="Vert-table">
                <table class="table-orders">
                    <thead>
                        <tr>
                            <th>Raport</th>
                            <th>Zlecono</th>
                            <th>Przygotowano</th>
                            <th>Status</th>
                            <th>Produkty</th>
                            <th>Kraje</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var report in Model)
                        {
                            <tr data-url="@Url.Action("SafariReportAnalysis", "Safari", new { reportId = report.ReportId })" style="cursor:pointer;">
                                <td style="font-size:19px; font-weight:300;">@report.ReportName</td>
                                <td>@report.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>@(report.ReadyDate?.ToString("yyyy-MM-dd HH:mm") ?? "W przygotowaniu")</td>
                                <td>
                                    @if (report.Prepared == true)
                                    {
                                        <span style="color: green;">Gotowy</span>
                                    }
                                    else
                                    {
                                        <span style="color: red;">Nieprzygotowany</span>
                                    }
                                </td>
                                <td>@(report.ProductIds?.Count() ?? 0)</td>
                                <td id="flags-@report.ReportId"></td> <!-- Miejsce, gdzie wstawimy flagi -->
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        
    </div>
</div>
<div id="loadingOverlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;">
    <div id="loadingMessage" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 24px; border-radius: 8px; width:400px; color: black; font-size: 16px; z-index: 1000;">
        <p>Raport <span id="reportName"></span></p>
        <div id="progressBarContainer" style="width: 100%; margin-top:12px; margin-bottom:12px; border-radius:4px; background-color: #ddd;">
            <div id="progressBar" style="width: 0%; height: 16px; background-color: #202430;   border-radius:4px;"></div>
        </div>
        <p id="progressText">0%</p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>
<script>
    var connection = new signalR.HubConnectionBuilder().withUrl("/reportProgressHub").build();
    var isProcessing = false; // Flaga, aby zapobiegać wielokrotnym kliknięciom

    connection.start().then(function () {
        console.log("SignalR connected.");
    }).catch(function (err) {
        return console.error(err.toString());
    });

    connection.on("ReceiveProgress", function (message, percentage) {
        console.log("Message received:", message, percentage); // Dodaj to do debugowania
        document.getElementById("progressText").innerText = message + " " + percentage + "%";
        document.getElementById("progressBar").style.width = percentage + "%";

        if (percentage === 100) {
            document.getElementById("progressText").innerText = "Wczytywanie zakończone.";
            isProcessing = false;
            setTimeout(hideLoadingOverlay, 1500); // Ukryj nakładkę po zakończeniu
        }
    });


    // Obsługa kliknięcia w wiersz tabeli (ładowanie raportu)
    document.querySelectorAll("tr[data-url]").forEach(function (row) {
        row.addEventListener("click", function () {
            if (!isProcessing) {
                isProcessing = true; // Zapobiega wielokrotnym kliknięciom
                var url = row.getAttribute("data-url");
                var reportName = row.querySelector('td').innerText;

                if (url) {
                    showLoadingOverlay(reportName); // Pokaż nakładkę
                    startProgress(); // Uruchom pasek postępu

                    // Przekierowanie do SafariReportAnalysis
                    window.location.href = url;
                }
            }
        });
    });

    function startProgress() {
        var progressBarContainer = document.getElementById("progressBarContainer");
        var progressText = document.getElementById("progressText");

        if (progressBarContainer && progressText) {
            progressBarContainer.style.display = "block";
            progressText.style.display = "block";
            document.getElementById("progressBar").style.width = "0%";
        }
    }

    // Wyświetlanie nakładki z okienkiem ładowania i paskiem postępu
    function showLoadingOverlay(reportName) {
        document.getElementById("reportName").innerText = reportName; // Ustaw nazwę raportu
        document.getElementById("loadingOverlay").style.display = "block";
    }

    // Ukrywanie nakładki po zakończeniu ładowania
    function hideLoadingOverlay() {
        document.getElementById("loadingOverlay").style.display = "none";
    }

    // Załadowanie flag dla raportów
    var reportCountries = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(reportCountries));
    Object.keys(reportCountries).forEach(function (reportId) {
        var flagsContainer = document.getElementById('flags-' + reportId);
        if (flagsContainer) {
            reportCountries[reportId].forEach(function (flag) {
                var img = document.createElement('img');
                img.src = '/images/' + flag + '.png';
                img.alt = flag;
                img.style.height = '22px';
                img.style.width = '32px';
                img.style.marginRight = '5px';
                flagsContainer.appendChild(img);
            });
        }
    });
</script>



