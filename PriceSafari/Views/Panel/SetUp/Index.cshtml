@model PriceSafari.Models.ViewModels.SetUpViewModel
@{
    ViewData["Title"] = "Konfiguracja Konta";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}
<style>

    .setup-options-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .setup-option {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .setup-option-header {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

        .setup-option-header:hover {
            background-color: #f8f9fa;
        }

    .source-logo {
        width: 48px;
        height: 48px;
        margin-right: 1.5rem;
    }

    .header-text h4 {
        margin-bottom: 3px;
        font-weight: 600;
    }

    .header-text p {
        margin: 0;
        color: #6c757d;
        font-size: 1.0rem;
        font-weight: 400;
    }


    .header-title {
        margin: 0;
        color: #4B4B4B;
        font-size: 21px;
        margin-bottom: 18px;
        font-weight: 400;
    }

    .arrow-icon {
        margin-left: auto;
        font-size: 1.2rem;
        transition: transform 0.3s ease-in-out;
    }

        .arrow-icon.rotated {
            transform: rotate(180deg);
        }

    .setup-option-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        padding: 0 1.5rem;
    }

        .setup-option-content.open {
            max-height: 5000px;
            padding: 1.5rem;
            padding-top: 0;
            border-top: 1px solid #dee2e6;
            transition: max-height 0.8s ease-in-out, padding 0.4s ease-in-out;
        }

    .form-message {
        margin-bottom: 1rem;
        font-weight: 500;
    }

        .form-message.success {
            color: #198754;
        }

        .form-message.error {
            color: #dc3545;
        }

    .setup-content-grid {
        display: grid;
        grid-template-columns: minmax(0, 2fr) 1fr;
        gap: 2rem;
        align-items: start;
        padding: 24px 16px;
    }

        .setup-content-grid > * {
            min-width: 0;
        }

    .setup-description {
        border-radius: 0.5rem;
        padding: 1.5rem;
        font-size: 0.9rem;
        min-width: 500px;
        width: 100%;
        color: #5C5C5C;
    }

        .setup-description h5 {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .setup-description a {
            font-weight: 400;
        }

        .setup-description p {
            font-weight: 400;
            font-size: 16px;
        }

    .status-in-progress {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #41C7C7;
        font-weight: 500;
    }

    .form-submitted-info {
        background-color: #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        text-align: center;
        color: #495057;
        border: 1px solid #dee2e6;
    }

    .xml-preview-container {
        background-color: #222222;
        color: #abb2bf;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.75rem;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow: auto;
    }

        .xml-preview-container.error-message {
            white-space: pre-wrap;
            color: #ff6b6b;
        }

        .xml-preview-container pre {
            margin: 0;
            padding: 0;
            white-space: pre;
        }

        .xml-preview-container .tag {
            color: #e06c75;
        }

        .xml-preview-container .attr-name {
            color: #d19a66;
        }

        .xml-preview-container .attr-value {
            color: #98c379;
        }

        .xml-preview-container ul {
            list-style-type: none;
            padding-left: 20px;
            margin: 0;
        }

        .xml-preview-container li {
            padding: 1px 0;
        }

        .xml-preview-container .text-node {
            color: #abb2bf;
            padding-left: 20px;
            white-space: normal;
        }

    .Vert-fluid {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 24px;
        border-radius: 8px;
        padding: 24px;
        background: #FFF;
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.15);
        min-height: 97vh;
        min-width: 956px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

    .modal-content {
        background-color: #ffffff;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
        text-align: left;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        gap: 0px;
    }

    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }

    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
    }

    .modal-content p {
        margin-bottom: 1rem;
        font-size: 1rem;
        color: #4b5563;
        line-height: 1.6;
    }

    .modal-buttons {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        justify-content: space-between;
    }

        .modal-buttons .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

    .modal-details {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        text-align: left;
        font-size: 0.9rem;
        color: #495057;
    }

        .modal-details p {
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .modal-details ul {
            list-style-position: inside;
            padding-left: 0.5rem;
            margin-bottom: 1rem;
        }

        .modal-details li {
            margin-bottom: 0.5rem;
        }

        .modal-details .modal-warning {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0;
        }
</style>
<div class="Vert">
    <div class="Date">
        <div class="Order-Container-Title">Witaj w konfiguratorze konta, @Model.UserName!</div>

    </div>
</div>

<div class="Vert">
    <div class="Vert-fluid">
        <div class="row g-4">
            <div class="col-12">

                <p class="header-title">Wybierz i skonfiguruj źródła danych, które chcesz monitorować.</p>

                <div class="setup-options-container">

                    <div class="setup-option">
                        <div class="setup-option-header" data-target="#ceneo-content">
                            <img src="~/images/Ceneo.png" alt="Ceneo" class="source-logo" />
                            <div class="header-text">
                                <h4>Monitoring Ceneo</h4>
                                @if (Model.IsCeneoSubmitted)
                                {
                                    <p>
                                        <i class="fas fa-check-circle" style="color: #41C7C7;"></i> Wszystko gotowe! Zaczynamy przygotowywać Twoje konto.
                                    </p>
                                }
                                else
                                {
                                    <p>Podaj nazwę sklepu i link do feedu produktowego.</p>
                                }
                            </div>
                            @if (Model.IsCeneoSubmitted)
                            {
                                <div class="status-in-progress ms-auto">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    <span>W przygotowaniu...</span>
                                </div>
                            }
                            else
                            {
                                <i class="fas fa-chevron-down arrow-icon"></i>
                            }
                        </div>
                        <div class="setup-option-content" id="ceneo-content">
                            <div class="setup-content-grid">
                                <form id="ceneo-form" style="display:flex; max-width:100%; flex-direction:column;">
                                    @Html.AntiForgeryToken()
                                    <div class="mb-3">
                                        <label for="ceneoStoreName" class="form-label">Nazwa Twojego sklepu w Ceneo</label>
                                        <input type="text" class="form-control" name="StoreName" value="@Model.PendingStoreNameCeneo" required @(Model.IsCeneoSubmitted ? "readonly" : "")>
                                    </div>
                                    <div class="mb-3">
                                        <label for="ceneoFeedUrl" class="form-label">Adres URL feedu produktowego dla Ceneo</label>
                                        <div style="display: flex; gap:8px;">
                                            <input type="url" class="form-control" name="FeedUrl" id="ceneoFeedUrl" value="@Model.PendingCeneoFeedUrl" required @(Model.IsCeneoSubmitted ? "readonly" : "")>
                                            <button type="button" class="Button-Page-Small-b" style="height:38.18px; margin-top:8px; text-wrap:nowrap;" data-feed-url-id="ceneoFeedUrl" data-preview-id="ceneo-xml-preview">Pokaż podgląd</button>
                                        </div>

                                    </div>

                                    <div class="mb-3">

                                        <div class="xml-preview-container" id="ceneo-xml-preview">
                                            Wklej link i kliknij "Pokaż pogląd", aby zobaczyć podgląd Twojego pliku XML.
                                        </div>
                                    </div>

                                    <div id="ceneo-message" class="form-message"></div>
                                    @if (!Model.IsCeneoSubmitted)
                                    {

                                        <button type="submit" class="Button-Page-Small-bl" style="height:38.18px;">Rozpocznij monitoring Ceneo</button>
                                    }
                                    else
                                    {

                                        <div class="form-submitted-info">
                                            <p class="mb-0">
                                                Dziękujemy za przesłanie danych! Rozpoczynamy monitoring 500 pierwszych produktów z przesłanego feedu w serwisie Ceneo. Zebranie informacji oraz przygotowanie Twojego konta może potrwać do 48 godzin. Gdy wszystko będzie gotowe, otrzymasz od nas powiadomienie mailowe.
                                            </p>

                                        </div>
                                    }
                                </form>

                                <div class="setup-description">
                                    <h5>Gdzie znaleźć feed produktowy Ceneo?</h5>
                                    <p>Możesz przesłać nam URL feedu produktowego wskazanego bezpośrednio w Ceneo. Sprawdź <a href="https://pricesafari.pl/Guide/FeedCeneo" style="color:#41C7C7; " target="_blank">ten poradnik</a> jeżeli nie wiesz gdzie znaleźć feed produktowy. Po przesłaniu feedu zmapujemy z niego pierwsze 500 produktów.</p>
                                    <p>Feed produktowy powinien zawierać następujące informacje:</p>
                                    <ul>
                                        <li><b>ID</b> produktu</li>
                                        <li><b>URL</b> prowadzący do produktu na Twojej stronie</li>
                                        <li><b>Kod EAN/GTIN</b> produktu</li>
                                        <li><b>URL obrazu</b> produktu</li>
                                    </ul>
                                    <p>Produkty bez kodu EAN/GTIN nie będą brane pod uwagę. Jeżeli więcej niż jeden produkt posiada ten sam kod EAN/GTIN, pod uwagę brane będzie tylko pierwsze wystąpienie.</p>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setup-option">
                        <div class="setup-option-header" data-target="#google-content">
                            <img src="~/images/GoogleShopping.png" alt="Google Shopping" class="source-logo" />
                            <div class="header-text">
                                <h4>Monitoring Google Shopping</h4>
                                @if (Model.IsGoogleSubmitted)
                                {
                                    <p>
                                        <i class="fas fa-check-circle" style="color: #41C7C7;"></i> Wszystko gotowe! Zaczynamy przygotowywać Twoje konto.
                                    </p>
                                }
                                else
                                {
                                    <p>Podaj nazwę sklepu i link do feedu produktowego.</p>
                                }
                            </div>
                            @if (Model.IsGoogleSubmitted)
                            {
                                <div class="status-in-progress ms-auto">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    <span>W przygotowaniu...</span>
                                </div>
                            }
                            else
                            {
                                <i class="fas fa-chevron-down arrow-icon"></i>
                            }
                        </div>
                        <div class="setup-option-content" id="google-content">
                            <div class="setup-content-grid">

                                <form id="google-form" style="display:flex; max-width:100%; flex-direction:column;">
                                    @Html.AntiForgeryToken()
                                    <div class="mb-3">
                                        <label class="form-label">Nazwa Twojego sklepu</label>
                                        <input type="text" class="form-control" name="StoreName" value="@Model.PendingStoreNameGoogle" required @(Model.IsGoogleSubmitted ? "readonly" : "")>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Adres URL feedu produktowego dla Google</label>
                                        <div style="display: flex; gap:8px;">
                                            <input type="url" class="form-control" name="FeedUrl" id="googleFeedUrl" value="@Model.PendingGoogleFeedUrl" required @(Model.IsGoogleSubmitted ? "readonly" : "")>
                                            <button type="button" class="Button-Page-Small-b" style="height:38.18px; margin-top:8px; text-wrap:nowrap;" data-feed-url-id="googleFeedUrl" data-preview-id="google-xml-preview">Pokaż podgląd</button>
                                        </div>

                                    </div>

                                    <div class="mb-3">

                                        <div class="xml-preview-container" id="google-xml-preview">
                                            Wklej link i kliknij "Pokaż pogląd", aby zobaczyć podgląd Twojego pliku XML.
                                        </div>
                                    </div>

                                    <div id="google-message" class="form-message"></div>
                                    @if (!Model.IsGoogleSubmitted)
                                    {
                                        <button type="submit" class="Button-Page-Small-bl" style="height:38.18px;">Rozpocznij monitoring Google Shopping</button>
                                    }
                                    else
                                    {
                                        <div class="form-submitted-info">
                                            <p class="mb-0">
                                                Dziękujemy za przesłanie danych! Rozpoczynamy monitoring 500 pierwszych produktów z przesłanego feedu w Google Shopping. Zebranie informacji oraz przygotowanie Twojego konta może potrwać do 24 godzin. Gdy wszystko będzie gotowe, otrzymasz od nas powiadomienie mailowe.
                                            </p>
                                        </div>
                                    }
                                </form>
                                <div class="setup-description">

                                    <h5>Gdzie znaleźć feed produktowy Google?</h5>
                                    <p>Możesz przesłać nam URL feedu produktowego wskazanego bezpośrednio w Twoim Google Merchant Center. Sprawdź <a href="https://pricesafari.pl/Guide/FeedGMC" style="color:#41C7C7; " target="_blank">ten poradnik</a> jeżeli nie wiesz gdzie znaleźć feed produktowy. Po przesłaniu feedu zmapujemy z niego pierwsze 500 produktów.</p>
                                    <p>Feed produktowy powinien zawierać następujące informacje:</p>
                                    <ul>
                                        <li><b>ID</b> produktu</li>
                                        <li><b>URL</b> prowadzący do produktu na Twojej stronie</li>
                                        <li><b>Kod EAN/GTIN</b> produktu</li>
                                        <li><b>URL obrazu</b> produktu</li>
                                    </ul>
                                    <p>Produkty bez kodu EAN/GTIN nie będą brane pod uwagę. Jeżeli więcej niż jeden produkt posiada ten sam kod EAN/GTIN, pod uwagę brane będzie tylko pierwsze wystąpienie.</p>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="confirmation-modal">
    <div class="modal-content">

        <h3><i class="fas fa-check-circle" style="color: #41C7C7;"></i> Potwierdzenie zapisu</h3>

        <p id="modal-text">
            Czy na pewno chcesz zapisać tę konfigurację? Po zapisaniu, jej edycja nie będzie możliwa.
        </p>

        <div class="modal-details">
            <p>
                Zanim zatwierdzisz, upewnij się, że Twój feed produktowy jest poprawny.
                <strong>Zmapujemy z niego pierwsze 500 produktów.</strong>
            </p>

            <p style="margin-bottom: 0.5rem;"><strong>Feed produktowy powinien zawierać:</strong></p>
            <ul>
                <li><strong>ID</strong> produktu</li>
                <li><strong>URL</strong> prowadzący do produktu na Twojej stronie</li>
                <li><strong>Kod EAN/GTIN</strong> produktu</li>
                <li><strong>URL obrazu</strong> produktu</li>
            </ul>

            <p class="modal-warning">
                Produkty bez kodu EAN/GTIN nie będą brane pod uwagę. Jeżeli produkt ma ten sam kod EAN/GTIN co inny, pod uwagę weźmiemy tylko pierwsze wystąpienie.
            </p>
        </div>
        <div class="modal-buttons">
            <button class="Button-Page-Small" id="modal-cancel">Anuluj</button>
            <button class="Button-Page-Small-bl" id="modal-confirm">Tak, zapisz i kontynuuj</button>
        </div>

    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

             function sanitizeInputs() {

                const inputsToSanitize = document.querySelectorAll('#ceneo-form input[type="text"], #ceneo-form input[type="url"], #google-form input[type="text"], #google-form input[type="url"]');

                inputsToSanitize.forEach(input => {

                    input.addEventListener('blur', () => {
                        input.value = input.value.trim();
                    });
                });
            }
            sanitizeInputs();

            document.querySelectorAll('.setup-option-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = document.querySelector(header.dataset.target);
                    const arrow = header.querySelector('.arrow-icon');
                    content.classList.toggle('open');
                    if (arrow) {
                        arrow.classList.toggle('rotated');
                    }
                });
            });

        const modalOverlay = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('modal-confirm');
        const cancelBtn = document.getElementById('modal-cancel');
        let formToSubmit = null;

        const showConfirmationModal = (formElement) => {
            if (formElement) {
                formToSubmit = formElement;
            }
            modalOverlay.classList.add('visible');
        };

        const hideConfirmationModal = () => {
            modalOverlay.classList.remove('visible');
            formToSubmit = null;
        };

        const handleConfirm = () => {
            if (formToSubmit) {

                submitForm(formToSubmit);
            }
            hideConfirmationModal();
        };

        cancelBtn.addEventListener('click', hideConfirmationModal);
        confirmBtn.addEventListener('click', handleConfirm);

        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) {
                hideConfirmationModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modalOverlay.classList.contains('visible')) {
                hideConfirmationModal();
            }
        });

        function setupFormListener(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', event => {
                    event.preventDefault();
                    showConfirmationModal(form);
                });
            }
        }

              function formatXml(xmlString) {

                const attributeRegex = /(\s[\w:-]+=)((".*?")|('.*?'))/gs;
                let sanitizedXmlString = xmlString.replace(attributeRegex, (match, attrName, attrValueWithQuotes) => {
                    const quoteChar = attrValueWithQuotes.substring(0, 1);
                    const valueContent = attrValueWithQuotes.substring(1, attrValueWithQuotes.length - 1);
                    const sanitizedValueContent = valueContent
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;');
                    return attrName + quoteChar + sanitizedValueContent + quoteChar;
                });

                let openTags = [];
                (sanitizedXmlString.match(/<[^>]+>/g) || []).forEach(tag => {
                    if (tag.startsWith('<?') || tag.startsWith('<!') || tag.endsWith('/>')) return;
                    if (tag.startsWith('</')) {
                        const tagNameMatch = tag.match(/<\/([^\s>]+)/);
                        if (tagNameMatch && openTags.length > 0 && tagNameMatch[1] === openTags[openTags.length - 1]) {
                             openTags.pop();
                        }
                    } else {
                        const tagNameMatch = tag.match(/<([^\s>]+)/);
                        if (tagNameMatch) {
                            openTags.push(tagNameMatch[1]);
                        }
                    }
                });
                let closingTags = '';
                while(openTags.length > 0) {
                    closingTags += `</${openTags.pop()}>`;
                }
                const fixedXmlString = sanitizedXmlString + closingTags;

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(fixedXmlString, "application/xml");
                const parserError = xmlDoc.querySelector("parsererror");

        if (parserError) {
            console.error("Błąd parsowania XML:", parserError.textContent);
            return `<pre class="parser-error">Struktura pliku XML jest nieprawidłowa. Upewnij się, że został on poprawnie wygenerowany i nie jest zabezpieczony hasłem.</pre>`;
        }

                const container = document.createElement('div');
                const rootElement = xmlDoc.documentElement;
                if (rootElement && rootElement.nodeName !== 'parsererror') {
                     container.appendChild(createNodeTree(rootElement));
                } else {
                     return `<pre class="parser-error">Nie udało się znaleźć głównego elementu w pliku XML.</pre>`;
                }

                return `<pre>${container.innerHTML}</pre>`;
            }

            function createNodeTree(node) {
                const ul = document.createElement('ul');
                const li = document.createElement('li');
                const header = document.createElement('div');

                const tagName = `<span class="tag">&lt;${node.nodeName}</span>`;
                let attributes = '';

                if (node.attributes.length > 0) {
                    for (const attr of node.attributes) {
                        const escapedValue = attr.value.replace(/"/g, '&quot;');
                        attributes += ` <span class="attr-name">${attr.name}</span>=<span class="attr-value">"${escapedValue}"</span>`;
                    }
                }

                const isSelfClosing = node.children.length === 0 && !node.textContent.trim();
                const closingChar = isSelfClosing ? ' /&gt;' : '&gt;';

                header.innerHTML = tagName + attributes + `<span class="tag">${closingChar}</span>`;
                li.appendChild(header);

                if (node.children.length > 0) {
                    for (const child of node.children) {
                        li.appendChild(createNodeTree(child));
                    }
                } else if (node.textContent.trim()) {
                    const textContent = document.createElement('div');
                    textContent.className = 'text-node';
                    textContent.textContent = node.textContent.trim();
                    li.appendChild(textContent);
                }

                if (!isSelfClosing) {
                    const closingTag = document.createElement('div');
                    closingTag.innerHTML = `<span class="tag">&lt;/${node.nodeName}&gt;</span>`;
                    li.appendChild(closingTag);
                }

                ul.appendChild(li);
                return ul;
            }

          async function verifyFeed(feedUrlId, previewId) {
            const urlInput = document.getElementById(feedUrlId);
            const previewContainer = document.getElementById(previewId);
            const url = urlInput.value.trim();

            if (!url) {
                previewContainer.textContent = 'Najpierw wklej adres URL feedu.';
                return false;
            }

            previewContainer.classList.remove('error-message');
            previewContainer.innerHTML = '<div class="d-flex align-items-center"><span class="spinner-border spinner-border-sm me-2" role="status"></span><span>Wczytywanie podglądu... Może to potrwać chwilę.</span></div>';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000);

            try {
                const response = await fetch('@Url.Action("FetchXmlFeed", "SetUp")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('form input[name="__RequestVerificationToken"]').value },
                    body: JSON.stringify({ url }),
                    signal: controller.signal
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(errText || `${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const PREVIEW_CHAR_LIMIT = 50000;
                let receivedLength = 0;
                let receivedChunks = [];
                let wasTruncated = false;

                while(true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    receivedChunks.push(value);
                    receivedLength += value.length;
                    if (receivedLength >= PREVIEW_CHAR_LIMIT) {
                        wasTruncated = true;
                        reader.cancel().catch(() => {});
                        break;
                    }
                }
                clearTimeout(timeoutId);
                const blob = new Blob(receivedChunks);
                let previewText = await blob.text();

                if (previewText.trim() === '') {
                    previewContainer.textContent = 'Otrzymano pustą odpowiedź od serwera.';
                    return false;
                }

                const lastTagStart = previewText.lastIndexOf('<');
                const lastTagEnd = previewText.lastIndexOf('>');
                if (lastTagStart > lastTagEnd) {
                    previewText = previewText.substring(0, lastTagStart);
                }
                const lastCdataStart = previewText.lastIndexOf('<![CDATA[');
                const lastCdataEnd = previewText.lastIndexOf(']]>');
                if (lastCdataStart > -1 && lastCdataStart > lastCdataEnd) {
                    previewText = previewText.substring(0, lastCdataStart);
                }
                let formattedHtml = formatXml(previewText);
                if (wasTruncated) {
                    const commentHtml = `<div style="color: #28a745; margin-top: 10px; font-style: italic;">(Wyświetlono podgląd. Cały plik jest prawdopodobnie większy.)</div>`;
                    const lastPreIndex = formattedHtml.lastIndexOf('</pre>');
                    if (lastPreIndex !== -1) {
                         formattedHtml = formattedHtml.slice(0, lastPreIndex) + commentHtml + formattedHtml.slice(lastPreIndex);
                    } else {
                         formattedHtml += commentHtml;
                    }
                }
                previewContainer.innerHTML = formattedHtml;

                return true;

            } catch (err) {
                previewContainer.classList.add('error-message');
                previewContainer.innerText =
                    err.name === 'AbortError'
                        ? 'Przekroczono limit czasu (2 min). Serwer źródłowy odpowiada zbyt wolno.'
                        : `Nie udało się wczytać feedu: ${err.message}`;
                console.error('Feed verification error:', err);

                return false;
            }
        }

               document.querySelectorAll('button[data-feed-url-id]').forEach(btn => {
            const previewId = btn.dataset.previewId;
            const previewContainer = document.getElementById(previewId);

            const originalPreviewContent = previewContainer.innerHTML;

            btn.addEventListener('click', async (event) => {
                const currentButton = event.currentTarget;

                const currentState = currentButton.dataset.state || 'hidden';

                if (currentState === 'hidden') {

                    const originalButtonText = currentButton.textContent;
                    currentButton.textContent = 'Wczytywanie...';
                    currentButton.disabled = true;

                    const success = await verifyFeed(currentButton.dataset.feedUrlId, previewId);

                    currentButton.disabled = false;
                    if (success) {

                        currentButton.textContent = 'Ukryj podgląd';
                        currentButton.dataset.state = 'shown';
                    } else {

                        currentButton.textContent = originalButtonText;
                        currentButton.dataset.state = 'hidden';
                    }
                } else {

                    previewContainer.innerHTML = originalPreviewContent;
                    previewContainer.classList.remove('error-message');
                    currentButton.textContent = 'Pokaż podgląd';
                    currentButton.dataset.state = 'hidden';
                }
            });
        });

        async function submitForm(form) {
            const messageDiv = form.querySelector('.form-message');
            const formData = new FormData(form);
            const url = form.id === 'ceneo-form'
                ? '@Url.Action("SaveCeneo", "SetUp")'
                : '@Url.Action("SaveGoogleShopping", "SetUp")';
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.querySelector('form input[name="__RequestVerificationToken"]').value },
                    body: new URLSearchParams(formData)
                });
                const data = await response.json();

                if (data.success) {

                    window.location.reload();
                } else {
                    messageDiv.textContent = data.message;
                    messageDiv.className = 'form-message error';
                }
            } catch (error) {
                messageDiv.textContent = 'Wystąpił błąd sieci. Spróbuj ponownie.';
                messageDiv.className = 'form-message error';
                console.error('Submit form error:', error);
            }
        }

            setupFormListener('ceneo-form');
            setupFormListener('google-form');
        });
    </script>
}