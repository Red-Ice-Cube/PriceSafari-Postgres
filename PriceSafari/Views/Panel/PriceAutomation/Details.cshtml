@using PriceSafari.Models.ViewModels
@using Microsoft.AspNetCore.Identity
@using PriceSafari.Models

@model AutomationDetailsViewModel
@inject UserManager<PriceSafariUser> UserManager

@{
    ViewData["Title"] = $"Szczegóły Reguły: {Model.RuleName}";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var user = await UserManager.GetUserAsync(User);
    bool canEdit = user?.AccesToEditPriceAutomation ?? false;
    string noAccessMessage = "Nie masz uprawnień aby zarządzać regułami automatyzacji cen. Skontaktuj sie z nami biuro@pricesafari.pl";

    bool isCompetitiveness = Model.StrategyMode == AutomationStrategyMode.Competitiveness;

    string strategyClass = isCompetitiveness ? "strategy-comp" : "strategy-prof";
    string strategyIconClass = isCompetitiveness ? "fa-bolt" : "fa-dollar-sign";
    string strategyLabel = isCompetitiveness ? "Lider Rynku" : "Rentowność";

    string statusClass = Model.IsActive ? "status-active-color" : "status-inactive-color";
    string statusLabel = Model.IsActive ? "Aktywny" : "Wyłączony";

    string borderClass = Model.SourceType == AutomationSourceType.PriceComparison ? "border-left-info" : "border-left-warning";

    bool isMarketplace = Model.SourceType == AutomationSourceType.Marketplace;
    int total = Model.TotalProducts > 0 ? Model.TotalProducts : 1;
    int successCount = Model.CountMet + Model.CountMaintained + Model.CountLimited;
    int blockedCount = Model.CountBlocked;
    int percentSuccess = Model.SuccessRate;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
@Html.AntiForgeryToken()

<style>
    .limit-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff !important;
        margin-right: 6px;
        min-width: 55px;
        height: 22px;
        gap: 4px;
    }

    .badge-purchase {
        background-color: #282828;
    }

    .badge-min {
        background-color: rgba(171, 37, 32, 1);
    }

    .badge-max {
        background-color: rgba(0, 145, 123, 1);
    }

    .limit-price-text {
        font-weight: 500;
        font-size: 13px;
    }

    .rank-icon {
        width: 12px;
        height: 12px;
        vertical-align: middle;
        margin-right: 5px;
    }

    .rank-row {
        display: flex;
        align-items: center;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff !important;
        width: 124px;
        min-width: 120px;
        height: 24px;
        gap: 4px;
    }

    .status-ok {
        background-color: rgba(0, 145, 123, 1);
    }

    .status-maintained {
        background-color: rgba(13, 110, 253, 0.7);
    }

    .status-limited {
        background-color: #f6c23e;
        color: #fff !important;
    }

    .status-blocked {
        background-color: #6C757D;
    }

    .status-neutral {
        background-color: #858796;
    }

    .status-text {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .price-row-block {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .price-row-space {
        display: flex;
        align-items: center;
        gap: 4px;
        justify-content: space-between;
    }

    .price-main-style {
        font-weight: 500;
        font-size: 17px;
        color: #000;
    }

    .price-green {
        color: #169A23 !important;
    }

    .commission-stack-badge {
        width: 52px;
    }

    .price-badge {
        width: 52px;
    }

    .text-muted {
        font-size: 12px;
    }

    .column-flex-min-gap {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .dynamics-stat {
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        margin-right: 10px;
    }

    .purchase-wrapper {
        position: relative;
        min-width: 185px;
    }

    .price-actions-display {
        display: inline-flex;
        margin-right: 6px;
        vertical-align: middle;
        opacity: 0.4;
        transition: opacity 0.2s;
    }

    .purchase-row:hover .price-actions-display {
        opacity: 1;
    }

    .edit-trigger {
        cursor: pointer;
        font-size: 10px;
        color: #343a40;
    }

        .edit-trigger:hover {
            color: #1d2124;
        }

    .edit-disabled {
        cursor: not-allowed;
        font-size: 10px;
        color: #ccc;
    }

    .price-edit-input {
        width: 75px;
        padding: 2px 5px;
        border: 1px solid #d1d3e2;
        border-radius: 4px;
        font-size: 13px;
        color: #6e707e;
        height: 26px;
    }

    .btn-action-icon {
        background: none;
        border: none;
        padding: 2px 4px;
        cursor: pointer;
        color: #858796;
        transition: color 0.2s;
        font-size: 13px;
    }

        .btn-action-icon:hover {
            color: #5a5c69;
        }

        .btn-action-icon.save-btn:hover {
            color: #1cc88a;
        }

        .btn-action-icon.delete-btn-inner:hover {
            color: #e74a3b;
        }

    .d-none {
        display: none !important;
    }

    .product-name-wrap {
        white-space: normal !important;
        word-wrap: break-word;
        width: 250px;
        line-height: 1.3;
    }

    .simulationProductTitle {
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease-in-out;
    }

        .simulationProductTitle:hover {
            color: #41C7C7 !important;
            text-decoration: none;
        }

    .btn-disabled-access {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: auto !important;
    }

    .status-box-dashed {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        width: 124px;
        min-width: 120px;
        height: 24px;
        gap: 4px;
        background-color: transparent;
        border-style: dashed;
        border-width: 2px;
        text-transform: uppercase;
    }

    .status-dashed-success {
        border-color: #1cc88a;
        color: #1cc88a !important;
    }

    .status-dashed-danger {
        border-color: #e74a3b;
        color: #e74a3b !important;
    }

    .status-dashed-secondary {
        border-color: #858796;
        color: #858796 !important;
    }

    .header-info-box {
        display: inline-flex;
        padding: 4px 16px;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        background: #e3e3e3;
        min-height: 34px;
        gap: 12px;
        margin-left: 15px;
    }

    .strategy-text {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .strategy-comp {
        color: rgba(113, 96, 232, 1);
    }

    .strategy-prof {
        color: #0d2c56;
    }

    .header-separator {
        color: #bbb;
        font-weight: 300;
        font-size: 16px;
    }

    .status-indicator-text {
        font-weight: 600;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-active-color {
        color: #1cc88a;
    }

    .status-inactive-color {
        color: #e74a3b;
    }

    .Chart-Box-a {
        display: flex;
        flex-grow: 1;
        min-height: 320px;
        padding: 24px;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        align-self: stretch;
        gap: 24px;
        border-radius: 8px;
        background: #FFF;
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.05);
        min-width: 200px;
    }

    .kpi-container {
        display: flex;
        gap: 16px;
        width: 100%;
        flex-wrap: wrap;
    }

    .kpi-card {
        flex: 1;
        min-width: 280px;
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        position: relative;
        overflow: hidden;
    }

    .kpi-accent-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
    }

    .kpi-title {
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #858796;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kpi-value-big {
        font-size: 28px;
        font-weight: 700;
        color: #5a5c69;
        line-height: 1.2;
    }

    .kpi-subtext {
        font-size: 12px;
        color: #858796;
        margin-top: 6px;
        font-weight: 500;
    }

    .dynamics-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 5px;
    }

    .dynamics-item {
        display: flex;
        flex-direction: column;
    }

    .dynamics-val {
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .dynamics-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #a0a0a0;
        margin-top: 2px;
    }

    .mini-progress-bg {
        width: 100%;
        height: 6px;
        background: #e3e3e3;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
    }

    .mini-progress-fill {
        height: 100%;
        background: #33A795;
        border-radius: 3px;
    }

    .btn-icon-settings {
        font-size: 24px;
        color: #858796;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        text-decoration: none !important;
        outline: none !important;
        box-shadow: none !important;
    }

        .btn-icon-settings:hover {
            color: #5a5c69;
            transform: rotate(30deg);
            text-decoration: none !important;
        }

        .btn-icon-settings.disabled {
            color: #d1d3e2;
            cursor: not-allowed;
        }

            .btn-icon-settings.disabled:hover {
                color: #d1d3e2;
                transform: none;
            }

    .period-selector-group {
        background-color: #e3e3e3;
        border-radius: 6px;
        padding: 4px;
        display: inline-flex;
        gap: 2px;
    }

    .period-btn-custom {
        border: none;
        background: transparent;
        color: #858796;
        font-size: 11px;
        font-weight: 700;
        padding: 6px 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none !important;
    }

        .period-btn-custom:hover:not(.active) {
            color: #5a5c69;
            background-color: rgba(255,255,255, 0.5);
        }

        .period-btn-custom.active {
            background-color: #ffffff;
            color: #222222;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
</style>

<div class="View">

    <div class="Vert">
        <div class="Date" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">

            <div style="display: flex; align-items: center;">
                <div class="Order-Container-Title" style="font-size: 23px;">
                   Automat cenowy <strong>@Model.RuleName</strong>
               
                </div>

             
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">

               

                <div class="header-info-box">
                    <div class="strategy-text @strategyClass">
                        <i class="fa-solid @strategyIconClass"></i> @strategyLabel
                    </div>

                    <span class="header-separator">|</span>

                    <div class="status-indicator-text @statusClass">
                        <i class="fa-solid fa-circle" style="font-size: 6px;"></i> @statusLabel
                    </div>
                </div>
                @if (canEdit)
                {
                    <a asp-controller="AutomationRules" asp-action="Edit" asp-route-id="@Model.RuleId"
                       class="btn-icon-settings"
                       title="Konfiguruj Regułę">
                        <i class="fas fa-cog"></i>
                    </a>
                }
                else
                {
                    <a href="#" onclick="showNoAccessAlert(); return false;"
                       class="btn-icon-settings disabled"
                       title="Brak uprawnień do edycji">
                        <i class="fas fa-cog"></i>
                    </a>
                }
            </div>

        </div>
    </div>




    <div class="Vert">
        <div class="kpi-container">

        
            

                <div class="kpi-card">
                  
                    <div class="kpi-title">
                        Przypisane Produkty
                        <i class="fas fa-cube text-gray-400"></i>
                    </div>
                    <div class="kpi-value-big">@Model.TotalProducts</div>

                    <div class="kpi-subtext" style="display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-clock" style="font-size: 12px; width: 12px; text-align: center;"></i>
                        <span>Aktualizacja: @(Model.LastScrapDate.HasValue? Model.LastScrapDate.Value.ToString("dd.MM HH:mm") : "-")</span>
                    </div>

                    <div class="kpi-subtext" style="display:flex; align-items:center; gap:6px; margin-top:3px;">
                        <i class="fas fa-store" style="font-size: 12px; width: 12px; text-align: center;"></i>
                        <span>Sklep: @Model.StoreName</span>
                    </div>
                </div>

            <div class="kpi-card">
          

                <div class="kpi-title">
                    Skuteczność Reguły
                    <span style="color:#33A795;">@percentSuccess%</span>
                </div>

                <div class="d-flex align-items-end gap-2">
                    <div class="kpi-value-big text-gray-800">@successCount</div>
                    <div class="kpi-subtext mb-1">ofert przeliczonych</div>
                </div>

                <div class="mini-progress-bg">
                    <div class="mini-progress-fill" style="width: @percentSuccess%"></div>
                </div>

                <div class="kpi-subtext mt-2">
                    <span class="text-danger font-weight-bold" title="Liczba zablokowanych"><i class="fas fa-ban mr-1"></i> @blockedCount</span> zablokowanych
                </div>
            </div>

            <div class="kpi-card">
             

                <div class="kpi-title">
                    Dynamika Zmian
                    <i class="fas fa-chart-bar text-gray-400"></i>
                </div>

                <div class="dynamics-row">
                    <div class="dynamics-item">
                        <div class="dynamics-val text-danger">
                            <i class="fas fa-arrow-up fa-xs"></i> @Model.CountIncreased
                        </div>
                        <div class="dynamics-label">Podwyżki</div>
                    </div>

                    <div class="dynamics-item" style="border-left: 1px solid #eee; padding-left: 15px;">
                        <div class="dynamics-val text-success">
                            <i class="fas fa-arrow-down fa-xs"></i> @Model.CountDecreased
                        </div>
                        <div class="dynamics-label">Obniżki</div>
                    </div>

                    <div class="dynamics-item" style="border-left: 1px solid #eee; padding-left: 15px;">
                        <div class="dynamics-val text-primary">
                            <i class="fas fa-circle fa-xs" style="font-size: 8px;"></i> @Model.CountMaintained
                        </div>
                        <div class="dynamics-label">Założenia utrzymane</div>
                    </div>
                </div>

                <div class="kpi-subtext mt-2">
                    Zoptymalizowano cenę w <strong>@(Model.CountIncreased + Model.CountDecreased)</strong> ofertach
                </div>
            </div>

        </div>
    </div>








    <div class="Vert">
        <div class="Chart-Box-a" style="width: 100%; min-height: 400px;">

            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div class="kpi-title">
                    Historia Wykonań Reguły
                 
                </div>
                <div class="period-selector-group">
                    <button type="button" class="period-btn-custom active history-btn" data-days="7">7 Analiz</button>
                    <button type="button" class="period-btn-custom history-btn" data-days="14">14 Analiz</button>
                    <button type="button" class="period-btn-custom history-btn" data-days="30">30 Analiz</button>
                </div>
            </div>

            <div style="display: flex; width: 100%; gap: 20px; flex-wrap: wrap;">

                <div style="flex: 1; min-width: 300px; height: 320px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                    <div id="chartEffectiveness" style="width: 100%; height: 100%;"></div>
                </div>

                <div style="flex: 1; min-width: 300px; height: 320px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                    <div id="chartDynamics" style="width: 100%; height: 100%;"></div>
                </div>

            </div>
        </div>
    </div>











    <div class="Vert">
        <div class="Date" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">

            <div style="display: flex; align-items: center;">
                <input type="text" id="productSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj produkt">

                @if (canEdit)
                {
                    <button class="btn btn-success btn-sm" onclick="executeAutomation()">
                        <i class="fas fa-play"></i> Wykonaj Automatyzację 
                    </button>
                }
                else
                {
                    <button class="btn btn-success btn-sm btn-disabled-access" onclick="showNoAccessAlert()">
                        <i class="fas fa-play"></i> Wykonaj Automatyzację
                    </button>
                }
            </div>

            <div>


                <div id="selectionContainer" class="selection-container">
                    <span id="selectedProductsCounter" class="ProductCount" style="width:126px; height:33.99px;">Wybrano: 0</span>
                    <button id="selectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Zaznacz wszystkie widoczne produkty">
                        <i class="fa-solid fa-square-check"></i>
                    </button>
                    <button id="deselectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Odznacz wszystkie widoczne produkty">
                        <i class="fa-solid fa-square-xmark"></i>
                    </button>
                    <button id="showSelectedProductsBtn" class="Button-Page-Small" style="width:89.25px;">Akcje</button>
                </div>




            </div>

        </div>
    </div>


    <div class="Vert">
      
        <div class="Vert-full">
            <div class="Vert-table" style="height: 90vh;">
                <table class="table-orders" id="automationTable" width="100%">
                    <thead>
                        <tr>
                            @if (!isMarketplace)
                            {
                                <th style="width: 50px;"></th>
                            }
                            <th style="width: 250px;">Produkt</th>
                            <th style="width: 200px; min-width: 190px;">Limity Cenowe</th>
                            <th style="min-width: 225px;">Dane z rynku - Twoja oferta</th>
                            @if (Model.StrategyMode == AutomationStrategyMode.Competitiveness)
                            {
                                <th style="min-width: 225px;">Najlepszy Rywal</th>
                            }
                            else
                            {
                                <th style="min-width: 225px;">Mediana Rynku</th>
                            }
                            <th style="min-width: 130px; width: 140px;">Zmiana</th>
                            <th class="bg-gradient-light border-left-primary" style="min-width: 225px;">Wyznaczona Cena</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Products)
                        {
                            <tr>
                                @if (!isMarketplace)
                                {
                                    <td class="text-center align-middle">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" alt="img" style="max-height: 40px; max-width: 40px;" />
                                        }
                                        else
                                        {
                                            <i class="fas fa-image text-gray-400"></i>
                                        }
                                    </td>
                                }

                                <td class="align-middle">
                                    <div class="font-weight-bold product-name-wrap" title="@item.Name">
                                        @{
                                            string linkUrl = null;
                                            if (isMarketplace)
                                            {
                                                linkUrl = $"/AllegroPriceHistory/Details?storeId={Model.StoreId}&productId={item.ProductId}";
                                            }
                                            else if (Model.LatestScrapId.HasValue)
                                            {
                                                linkUrl = $"/PriceHistory/Details?scrapId={Model.LatestScrapId}&productId={item.ProductId}";
                                            }
                                        }
                                        @if (!string.IsNullOrEmpty(linkUrl))
                                        {
                                            <a href="@linkUrl" target="_blank" rel="noopener noreferrer" class="simulationProductTitle">
                                                @item.Name
                                            </a>
                                        }
                                        else
                                        {
                                            @item.Name
                                        }
                                    </div>
                                    <div class="small text-muted mb-1 mt-1">
                                        @item.Identifier
                                        @if (item.ApiAllegroPriceFromUser.HasValue)
                                        {
                                            <span class="text-xs ml-1 text-gray-500" title="Cena bazowa w API (przed dopłatami)">(API: @item.ApiAllegroPriceFromUser)</span>
                                        }
                                    </div>
                                    <div class="mt-2">
                                   
                                        <button class="select-product-btn"
                                                data-product-id="@item.ProductId"
                                                data-product-name="@item.Name"
                                                style="font-size: 11px; padding: 2px 8px; width: 100px; pointer-events: auto;">
                                            Zaznacz
                                        </button>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <div class="purchase-wrapper"
                                         data-id="@item.ProductId"
                                         data-store-id="@Model.StoreId"
                                         data-is-marketplace="@isMarketplace.ToString().ToLower()">

                                        <div class="display-mode">
                                            @if (item.PurchasePrice.HasValue)
                                            {
                                                <div class="bg-light p-2 rounded border purchase-row">
                                                    @if (item.MaxPriceLimit.HasValue)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="limit-badge badge-max">MAX <i class="fa-solid fa-arrow-up"></i></span>
                                                            <span class="limit-price-text" style="color: rgba(0, 145, 123, 1);">@item.MaxPriceLimit.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    }
                                                    @if (item.MinPriceLimit.HasValue)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center @(item.MaxPriceLimit.HasValue ? "border-top pt-1 mt-1" : "mb-1")">
                                                            <span class="limit-badge badge-min">MIN <i class="fa-solid fa-arrow-down"></i></span>
                                                            <span class="limit-price-text" style="color: rgba(171, 37, 32, 1);">@item.MinPriceLimit.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    }

                                                    <div class="d-flex justify-content-between align-items-center @(item.MinPriceLimit.HasValue || item.MaxPriceLimit.HasValue ? "border-top pt-1 mt-1" : "")">
                                                        <span class="limit-badge badge-purchase">Zakup</span>
                                                        <div class="d-flex align-items-center">
                                                            <span class="price-actions-display">
                                                               
                                                                @if (canEdit)
                                                                {
                                                                    <i class="fas fa-pencil-alt edit-btn edit-trigger" title="Edytuj cenę zakupu"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="fas fa-lock edit-disabled" title="Brak uprawnień do edycji" onclick="showNoAccessAlert()"></i>
                                                                }
                                                            </span>
                                                            <span class="limit-price-text val-display" style="color: #282828;">@item.PurchasePrice.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center text-gray-400 small purchase-row py-2 border rounded bg-light">
                                                    <span class="ml-2 cursor-pointer" title="Dodaj cenę zakupu">
                                                      
                                                        @if (canEdit)
                                                        {
                                                            <i class="fas fa-plus-circle text-gray-500 edit-btn edit-trigger" style="font-size: 12px;"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-plus-circle text-gray-300" style="font-size: 12px; cursor: not-allowed;" onclick="showNoAccessAlert()"></i>
                                                        }
                                                    </span>
                                                    Brak ceny zakupu
                                                </div>
                                            }
                                        </div>

                                   
                                        <div class="edit-mode d-none bg-white p-2 rounded border shadow-sm" style="position:absolute; z-index:10; width:100%; top:50%; left:0; transform: translateY(-50%);">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <input type="number" step="0.01" class="price-edit-input" value="@(item.PurchasePrice?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "")" placeholder="0.00">

                                                <div class="d-flex ml-1">
                                                    <button class="btn-action-icon save-btn" type="button" title="Zapisz">
                                                        <i class="fas fa-check"></i>
                                                    </button>

                                                    <button class="btn-action-icon cancel-btn" type="button" title="Anuluj">
                                                        <i class="fas fa-times"></i>
                                                    </button>

                                                    @if (item.PurchasePrice.HasValue)
                                                    {
                                                        <button class="btn-action-icon delete-btn-inner ml-1 border-left pl-2" type="button" title="Usuń cenę zakupu">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="align-middle text-right">
                                    <div class="price-row-block">
                                        <span class="price-main-style @(item.IsBestPriceGuarantee ? "price-green" : "")">
                                            @(item.CurrentPrice.HasValue? item.CurrentPrice.Value.ToString("F2")  : "-") PLN
                                        </span>
                                        @if (item.HasCheaperOwnOffer)
                                        {
                                            <span class="text-danger mr-1"
                                                  data-toggle="tooltip"
                                                  title="UWAGA: Posiadasz inną, tańszą ofertę podpiętą pod ten sam katalog!"
                                                  style="cursor: help; font-size: 14px;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                        }
                                        @if (item.IsBestPriceGuarantee)
                                        {
                                            <div title="Gwarancja Najniższej Ceny">
                                                <img src="/images/TopPrice.png" alt="Gwarancja" style="width: 18px; height: 18px; vertical-align: middle;">
                                            </div>
                                        }
                                        @if (item.IsSuperPrice)
                                        {
                                            <div class="SuperPrice">SUPERCENA</div>
                                        }
                                        @if (item.IsTopOffer)
                                        {
                                            <div class="TopOffer">Top</div>
                                        }
                                      
                                    </div>
                                    <div class="small text-muted ">@Model.StoreName</div>
                                    @if (item.CommissionAmount.HasValue)
                                    {
                                        <div class="Commission-stack">
                                            <span class="commission-stack-badge">Prowizja</span>
                                            <p>
                                                @item.CommissionAmount.Value.ToString("F2") PLN
                                                @if (item.IsCommissionIncluded)
                                                {
                                                    <span style="font-weight: 400; color: #555;"> | uwzg.</span>
                                                }
                                                else
                                                {

                                                    <span style="font-weight: 400; color: #999;"> | nieuwzg.</span>
                                                }
                                            </p>
                                        </div>
                                    }
                                    @if (item.CurrentMarkupAmount.HasValue && item.CurrentMarkupPercent.HasValue)
                                    {
                                        <div class="price-box-diff-margin-ib @(item.CurrentMarkupAmount > 0 ? "price-box-diff-margin-ib-positive" : "price-box-diff-margin-ib-negative")" style="margin-top: 4px; width: 100%;">
                                            <span class="price-badge @(item.CurrentMarkupAmount > 0 ? "price-badge-positive" : "price-badge-negative")">Narzut</span>
                                            <p>@item.CurrentMarkupAmount.Value.ToString("F2") PLN (@item.CurrentMarkupPercent.Value.ToString("F2")%)</p>
                                        </div>
                                    }
                                    @if (item.IsSubsidyActive && item.ApiAllegroPriceFromUser.HasValue)
                                    {
                                        <div class="subsidy-stack" style="margin-top: 4px;">
                                            <span class="subsidy-stack-badge">Kampania z dopł. | Twoja cena</span>
                                            <p>@item.ApiAllegroPriceFromUser.Value.ToString("F2") PLN</p>
                                        </div>
                                    }
                                </td>

                                <td class="align-middle text-right">
                                    @if (Model.StrategyMode == AutomationStrategyMode.Competitiveness)
                                    {
                                        @if (item.BestCompetitorPrice.HasValue)
                                        {
                                            <div class="price-row-block">
                                                <span class="price-main-style @(item.CompetitorIsBestPriceGuarantee ? "price-green" : "")">
                                                    @item.BestCompetitorPrice.Value.ToString("F2") PLN
                                                </span>
                                                @if (item.CompetitorIsBestPriceGuarantee)
                                                {
                                                    <div title="Gwarancja Najniższej Ceny Rywala">
                                                        <img src="/images/TopPrice.png" alt="Gwarancja" style="width: 18px; height: 18px; vertical-align: middle;">
                                                    </div>
                                                }
                                                @if (item.CompetitorIsSuperPrice)
                                                {
                                                    <div class="SuperPrice">SUPERCENA</div>
                                                }
                                                @if (item.CompetitorIsTopOffer)
                                                {
                                                    <div class="TopOffer">Top</div>
                                                }
                                            </div>
                                            <div class="small text-muted">@item.CompetitorName</div>
                                        }
                                        else
                                        {
                                            <span class="badge badge-light">Brak konkurencji</span>
                                        }
                                    }
                                    else
                                    {
                                        @if (item.MarketAveragePrice.HasValue)
                                        {
                                            <span class="price-main-style">@item.MarketAveragePrice.Value.ToString("F2") PLN</span>
                                        }
                                    }
                                </td>

                                <td class="align-middle text-center">
                                    <div class="price-row-block">
                                        @if (item.PriceChange.HasValue && item.PriceChange.Value != 0 && item.Status != AutomationCalculationStatus.Blocked)
                                        {
                                            @if (item.PriceChange.Value < 0)
                                            {
                                                <span class="price-main-style text-success" style="display: inline-flex; align-items: center;">
                                                    <i class="fas fa-arrow-down" style="margin-right: 5px; font-weight: 900; font-size: 0.8em;"></i>
                                                    @Math.Abs(item.PriceChange.Value).ToString("F2") PLN
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="price-main-style text-danger" style="display: inline-flex; align-items: center;">
                                                    <i class="fas fa-arrow-up" style="margin-right: 5px; font-weight: 900; font-size: 0.8em;"></i>
                                                    @item.PriceChange.Value.ToString("F2") PLN
                                                </span>
                                            }
                                        }
                                        else if (item.Status == AutomationCalculationStatus.TargetMaintained)
                                        {
                                            <span class="price-main-style" style="display: inline-flex; align-items: center; color: rgba(13, 110, 253, 0.7);">
                                                <i class="no-change-icon-turquoise" style="font-style:normal;"></i>
                                                Brak zmian
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="price-main-style" style="color:#6C757D;">Blokada</span>
                                        }
                                    </div>
                                    <div class="column-flex-min-gap">
                                        @if (Model.SourceType == AutomationSourceType.Marketplace)
                                        {
                                            <div class="rank-row">
                                                <img src="/images/AllegroIcon.png" alt="Allegro" class="rank-icon">
                                                <span class="text-muted">@item.CurrentRankingAllegro</span>
                                                <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                <span class="text-muted">@item.NewRankingAllegro</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="rank-row">
                                                <img src="/images/GoogleShopping.png" alt="Google" class="rank-icon">
                                                <span class="text-muted">@item.CurrentRankingGoogle</span>
                                                <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                <span class="text-muted">@item.NewRankingGoogle</span>
                                            </div>
                                            <div class="rank-row">
                                                <img src="/images/Ceneo.png" alt="Ceneo" class="rank-icon">
                                                <span class="text-muted">@item.CurrentRankingCeneo</span>
                                                <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                <span class="text-muted">@item.NewRankingCeneo</span>
                                            </div>
                                        }
                                    </div>
                                </td>

                                <td class="align-middle text-right bg-light border-left-primary">
                                    <div class="d-flex flex-column" style="width:100%;">
                                        <div class="price-row-space">
                                            @if (item.Status == AutomationCalculationStatus.Blocked)
                                            {
                                                <div class="price-main-style" style="color:#6C757D;">
                                                    @(item.SuggestedPrice?.ToString("F2") ?? "-") PLN
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="price-main-style @(item.IsMarginWarning ? "text-warning" : "text-success")">
                                                    @(item.SuggestedPrice.HasValue? item.SuggestedPrice.Value.ToString("F2") : "-") PLN
                                                </span>
                                            }

                                            @switch (item.Status)
                                            {
                                                case AutomationCalculationStatus.TargetMet:
                                                    <div class="status-badge status-ok">
                                                        <i class="fas fa-check mr-2"></i> Cel Osiągnięty
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.TargetMaintained:
                                                    <div class="status-badge status-maintained">
                                                        <i class="fas fa-check-circle mr-2"></i> Cel Utrzymany
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.PriceLimited:
                                                    <div class="status-badge status-limited">
                                                        <i class="fas fa-filter mr-2"></i> Limit Ceny
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.Blocked:
                                                    <div class="status-badge status-blocked">
                                                        <i class="fas fa-times mr-2"></i> @item.BlockReason
                                                    </div>
                                                    break;
                                                default:
                                                    <span class="badge badge-light border px-3 py-2">Brak danych</span>
                                                    break;
                                            }
                                        </div>
                                        <div class="small text-muted ">@Model.StoreName</div>
                                        @if (item.CommissionAmount.HasValue)
                                        {
                                            <div class="Commission-stack">
                                                <span class="commission-stack-badge">Prowizja</span>
                                                <p>
                                                    @item.CommissionAmount.Value.ToString("F2") PLN
                                                    @if (item.IsCommissionIncluded)
                                                    {
                                                        <span style="font-weight: 400; color: #555;"> | uwzg.</span>
                                                    }
                                                    else
                                                    {

                                                        <span style="font-weight: 400; color: #999;"> | nieuwzg.</span>
                                                    }
                                                </p>
                                            </div>
                                        }
                                        @if (item.SuggestedPrice.HasValue && item.MarkupAmount.HasValue)
                                        {
                                            <div class="price-box-diff-margin-ib @(item.MarkupAmount > 0 ? "price-box-diff-margin-ib-positive" : "price-box-diff-margin-ib-negative")" style="margin-top: 4px; width: 100%;">
                                                <span class="price-badge @(item.MarkupAmount > 0 ? "price-badge-positive" : "price-badge-negative")">Narzut</span>
                                                <p>@item.MarkupAmount.Value.ToString("F2") PLN (@item.MarkupPercent.Value.ToString("F2")%)</p>
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td class="align-middle text-center">
                                    <div class="d-flex flex-column align-items-center" style="gap: 4px;">

                                        @if (item.IsAlreadyUpdated)
                                        {
                                      
                                            <div class="status-box-dashed status-dashed-success" title="Cena wgrana: @(item.UpdateDate?.ToString("dd.MM HH:mm") ?? "-")">
                                                <i class="fas fa-check mr-1"></i> WGRANO
                                            </div>

                                         
                                            @if (item.UpdateDate.HasValue)
                                            {
                                                <div style="font-size: 10px; color: #858796; line-height: 1.1;">
                                                    @item.UpdateDate.Value.ToString("dd.MM")<br>
                                                    @item.UpdateDate.Value.ToString("HH:mm")
                                                </div>
                                            }

                                         
                                            @if (item.UpdatedPrice.HasValue)
                                            {
                                                <div style="font-size: 11px; color: #1cc88a; font-weight: 700; margin-top: 2px;">
                                                    @item.UpdatedPrice.Value.ToString("F2") PLN
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                          
                                            @if (item.Status != AutomationCalculationStatus.Blocked && item.SuggestedPrice.HasValue)
                                            {
                                                <div class="status-box-dashed status-dashed-danger">
                                                    <i class="fas fa-times mr-1"></i> NIE WGRANO
                                                </div>
                                                <span class="text-xs text-gray-400">Oczekuje</span>
                                            }
                                            else
                                            {
                                              
                                                <div class="status-box-dashed status-dashed-secondary">
                                                    <i class="fas fa-ban mr-1"></i> BLOKADA
                                                </div>
                                            }
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_MassAction.cshtml")
@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>

    <script>
        const storeId = @Model.StoreId;
        const currentRuleId = @Model.RuleId;

        const isAllegroContext = '@(Model.SourceType == AutomationSourceType.Marketplace)' === 'True';
        const sourceTypeInt = isAllegroContext ? 1 : 0;

        let selectedProductIds = new Set();
        let selectedProductNames = new Map();
        let selectedProductIdentifiers = new Map();

        function showNoAccessAlert() {
            alert('@Html.Raw(noAccessMessage)');
        }

        function showLoading() { $('#loadingOverlay').css('display', 'flex'); }
        function hideLoading() { $('#loadingOverlay').hide(); }

        function updateCounter() {

            const count = selectedProductIds.size;
            $('#selectedProductsCounter').text(`Wybrano: ${count}`);

            const modalCounter = document.getElementById('selectedProductsModalCounter');
            if (modalCounter) modalCounter.textContent = count;

            const automationCount = document.getElementById('automationProductCountDisplay');
            if (automationCount) automationCount.textContent = count;
        }

              function updateBtnState(btn, isSelected) {
            if (isSelected) {
                btn.text('Wybrano');
                btn.addClass('selected');
            } else {
                btn.text('Zaznacz');
                btn.removeClass('selected');
            }
        }

        function updateVisibleProductSelectionButtons() {
            $('.select-product-btn').each(function() {
                const btn = $(this);
                const pid = btn.data('product-id').toString();
                if (selectedProductIds.has(pid)) {
                    updateBtnState(btn, true);
                } else {
                    updateBtnState(btn, false);
                }
            });
        }

        function renderSelectedList() {
            const container = document.getElementById('selectedProductsList');
            container.innerHTML = '';

            if (selectedProductIds.size === 0) {
                container.innerHTML = '<div class="alert alert-info text-center">Nie zaznaczono żadnych produktów.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table-orders';
            table.innerHTML = `<thead><tr><th style="width: 70%;">Nazwa Produktu</th><th>ID/EAN</th><th class="text-center">Akcja</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            selectedProductIds.forEach(productId => {
                const name = selectedProductNames.get(productId) || '---';

                const identifier = selectedProductIdentifiers.get(productId) || '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${name}</td>
                  <td>${identifier}</td>
                  <td class="text-center align-middle">
                      <button class="btn btn-danger btn-sm remove-selection-btn" data-product-id="${productId}" title="Usuń z zaznaczonych" style="padding: 2px 6px;">
                          <i class="fa-solid fa-trash-can"></i>
                      </button>
                  </td>`;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function renderAutomationRulesInModal(rules, totalSelected) {
            console.log("Renderowanie reguł...", rules);
            const container = document.getElementById('automationRulesListContainer');
            if (!container) return;

            container.innerHTML = '';

            const totalAssignedInSelection = rules ? rules.reduce((sum, r) => sum + r.matchingCount, 0) : 0;
            const totalUnassignedInSelection = totalSelected - totalAssignedInSelection;

            const statsHeader = document.createElement('div');
            statsHeader.style.cssText = `
                background-color: #f8f9fa; border: 1px solid #e3e6f0; border-radius: 8px;
                padding: 15px; margin-bottom: 20px; display: flex;
                justify-content: space-around; align-items: center; text-align: center;
            `;

            statsHeader.innerHTML = `
                <div>
                    <div style="font-size: 11px; color: #858796; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Łącznie zaznaczone</div>
                    <div style="font-size: 20px; font-weight: 700; color: #5a5c69;">${totalSelected}</div>
                </div>
                <div style="border-left: 1px solid #e3e6f0; height: 30px;"></div>
                <div>
                    <div style="font-size: 11px; color: #858796; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Przypisane do reguły</div>
                    <div style="font-size: 20px; font-weight: 700; color: #5a5c69;">${totalAssignedInSelection}</div>
                </div>
                <div style="border-left: 1px solid #e3e6f0; height: 30px;"></div>
                <div>
                    <div style="font-size: 11px; color: #e74a3b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Nieprzypisane</div>
                    <div style="font-size: 20px; font-weight: 700; color: #e74a3b;">${Math.max(0, totalUnassignedInSelection)}</div>
                </div>
            `;
            container.appendChild(statsHeader);

            const unassignDiv = document.createElement('div');
            const hasAssignments = totalAssignedInSelection > 0;

            unassignDiv.className = 'automation-rule-item';
            unassignDiv.style.cssText = `
                border: 1px dashed ${hasAssignments ? '#e74a3b' : '#ccc'};
                border-radius: 8px; padding: 10px 15px;
                cursor: ${hasAssignments ? 'pointer' : 'default'};
                background-color: #fff;
                display: flex; justify-content: space-between; align-items: center;
                transition: background-color 0.2s; margin-bottom: 20px; opacity: ${hasAssignments ? '1' : '0.6'};
            `;

            if (hasAssignments) {
                unassignDiv.onmouseover = () => { unassignDiv.style.backgroundColor = '#fff5f5'; };
                unassignDiv.onmouseout = () => { unassignDiv.style.backgroundColor = '#fff'; };
                unassignDiv.addEventListener('click', () => {
                    confirmAndUnassignRules();
                });
            }

            unassignDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="width:6px; height:45px; background-color:${hasAssignments ? '#e74a3b' : '#ccc'}; border-radius:3px;"></div>
                    <div>
                        <div style="font-weight:600; font-size:15px; color:${hasAssignments ? '#e74a3b' : '#888'};">Brak Automatyzacji (Odepnij)</div>
                        <div style="font-size:13px; color:#666; margin-top:2px;">
                            ${hasAssignments ? `Odepnij <strong>${totalAssignedInSelection}</strong> zaznaczonych produktów od ich obecnych reguł.` : 'Żaden z zaznaczonych produktów nie jest przypisany do reguły.'}
                        </div>
                    </div>
                </div>
                  <button class="Button-Page-Small-r" type="button" style="pointer-events:none; ${!hasAssignments ? 'background-color:#ccc; border-color:#ccc;' : ''}">Odepnij</button>
            `;
            container.appendChild(unassignDiv);

            if (!rules || rules.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.innerHTML = `<div class="alert alert-warning" style="text-align:center;">Brak zdefiniowanych innych reguł.</div>`;
                container.appendChild(emptyDiv);
                return;
            }

            rules.sort((a, b) => a.name.localeCompare(b.name, 'pl', { sensitivity: 'base' }));

            rules.forEach(rule => {

                const statusColor = rule.isActive ? '#1cc88a' : '#e74a3b';
                const statusText = rule.isActive ? 'Aktywna' : 'Nieaktywna';

                const isCompetitiveness = rule.strategyMode === 0;
                const strategyIcon = isCompetitiveness ? '<i class="fa-solid fa-bolt" style="color:#888;"></i>' : '<i class="fa-solid fa-dollar-sign" style="color:#888;"></i>';
                const strategyName = isCompetitiveness ? "Lider Rynku" : "Rentowność";

                const globalTotalInRule = rule.totalCount;
                const selectedAlreadyInRule = rule.matchingCount;
                const toBeAdded = totalSelected - selectedAlreadyInRule;

                let backgroundStyle = selectedAlreadyInRule > 0 ? '#fcfcfc' : '#fff';
                let borderStyle = '#e3e6f0';

                const div = document.createElement('div');
                div.className = 'automation-rule-item';
                div.style.cssText = `
                    border: 1px solid ${borderStyle}; border-radius: 8px; padding: 12px 15px;
                    cursor: pointer; background: ${backgroundStyle};
                    display: flex; justify-content: space-between; align-items: center;
                    transition: background-color 0.2s, border-color 0.2s; margin-bottom: 10px;
                `;

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; flex-grow: 1;">
                        <div style="width:6px; height:45px; background-color:${rule.colorHex}; border-radius:3px; flex-shrink: 0;"></div>
                        <div style="flex-grow: 1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600; font-size:16px; color:#333;">${rule.name}</div>
                                <div style="font-size:12px; color:#888; display:flex; align-items:center; gap:8px;">
                                    <span style="display:flex; align-items:center; gap:4px;">${strategyIcon} ${strategyName}</span>
                                    <span style="color:#e3e6f0;">|</span>
                                    <span style="color:${statusColor}; font-weight:500; display:flex; align-items:center; gap:4px;"><i class="fa-solid fa-circle" style="font-size:6px;"></i> ${statusText}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap: 15px; margin-top:6px; font-size:13px; color:#666; align-items: center; flex-wrap: wrap;">
                                <span title="Całkowita liczba produktów w tej regule"><i class="fa-solid fa-database" style="color:#999; margin-right:4px;"></i> Razem: <strong>${globalTotalInRule}</strong></span>
                                <span style="color:#e3e6f0;">|</span>
                                <span title="Ile z zaznaczonych jest tutaj"><i class="fa-solid fa-check-double" style="color:#999; margin-right:4px;"></i> Wybranych: <strong>${selectedAlreadyInRule}</strong></span>
                                <span style="color:#e3e6f0;">|</span>
                                <span title="Ile zostanie dodanych">Zostanie dodanych: <strong style="color:#1cc88a;">+${toBeAdded}</strong></span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-left: 20px;">
                        <button class="Button-Page-Small-bl assign-rule-btn" type="button" style="pointer-events:none; white-space:nowrap; padding: 5px 15px;">Wybierz</button>
                    </div>
                `;

                div.addEventListener('click', () => {
                    confirmAndAssignRule(rule.id, rule.name);
                });

                container.appendChild(div);
            });
        }

        function confirmAndAssignRule(targetRuleId, ruleName) {
            if (!confirm(`Czy na pewno chcesz przypisać ${selectedProductIds.size} produktów do grupy "${ruleName}"?\n\nJeśli produkty były w innych grupach, zostaną przeniesione.`)) {
                return;
            }
            executeAutomationAction('/AutomationRules/AssignProducts', { RuleId: targetRuleId });
        }

        function confirmAndUnassignRules() {
            if (!confirm(`Czy na pewno chcesz usunąć przypisanie do reguł automatyzacji dla ${selectedProductIds.size} produktów?`)) {
                return;
            }
            executeAutomationAction('/AutomationRules/UnassignProducts', {});
        }

        function executeAutomationAction(url, extraData) {
            $('#automationSelectionModal').modal('hide');
            showLoading();

            const productIdsArray = Array.from(selectedProductIds).map(id => parseInt(id));

            const payload = {
                ProductIds: productIdsArray,
                IsAllegro: isAllegroContext,
                ...extraData
            };

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    hideLoading();
                    alert(res.message || 'Operacja zakończona sukcesem.');

                    location.reload();
                },
                error: function(xhr) {
                    hideLoading();
                    alert('Błąd: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));

                    setTimeout(() => $('#automationSelectionModal').modal('show'), 500);
                }
            });
        }

        $(document).ready(function() {

            $(document).on('click', '.select-product-btn', function(e) {
                e.stopPropagation();
                const btn = $(this);
                const pid = btn.data('product-id').toString();
                const pname = btn.data('product-name');

                const row = btn.closest('tr');
                const identifierText = row.find('.small.text-muted').text().trim();

                if (selectedProductIds.has(pid)) {
                    selectedProductIds.delete(pid);
                    selectedProductNames.delete(pid);
                    selectedProductIdentifiers.delete(pid);
                    updateBtnState(btn, false);
                } else {
                    selectedProductIds.add(pid);
                    selectedProductNames.set(pid, pname);
                    selectedProductIdentifiers.set(pid, identifierText);
                    updateBtnState(btn, true);
                }
                updateCounter();
            });

            $('#selectAllVisibleBtn').on('click', function() {
                $('.select-product-btn').each(function() {
                    const btn = $(this);
                    const pid = btn.data('product-id').toString();
                    const pname = btn.data('product-name');
                    const row = btn.closest('tr');
                    const identifierText = row.find('.small.text-muted').text().trim();

                    if (!selectedProductIds.has(pid)) {
                        selectedProductIds.add(pid);
                        selectedProductNames.set(pid, pname);
                        selectedProductIdentifiers.set(pid, identifierText);
                        updateBtnState(btn, true);
                    }
                });
                updateCounter();
            });

            $('#deselectAllVisibleBtn').on('click', function() {
                $('.select-product-btn').each(function() {
                    const btn = $(this);
                    const pid = btn.data('product-id').toString();

                    if (selectedProductIds.has(pid)) {
                        selectedProductIds.delete(pid);
                        selectedProductNames.delete(pid);
                        selectedProductIdentifiers.delete(pid);
                        updateBtnState(btn, false);
                    }
                });
                updateCounter();
            });

            $('#showSelectedProductsBtn').on('click', function() {
                if (selectedProductIds.size === 0) {
                    alert('Nie zaznaczono żadnych produktów.');
                    return;
                }
                renderSelectedList();
                $('#selectedProductsModal').modal('show');
            });

            $(document).on('click', '.remove-selection-btn', function(e) {
                e.stopPropagation();
                const pid = $(this).data('product-id').toString();
                selectedProductIds.delete(pid);
                selectedProductNames.delete(pid);
                selectedProductIdentifiers.delete(pid);

                const mainBtn = $(`.select-product-btn[data-product-id="${pid}"]`);
                if(mainBtn.length) updateBtnState(mainBtn, false);

                updateCounter();
                renderSelectedList();
            });

            $(document).on('click', '#openBulkAutomationModalBtn', function() {
                if (selectedProductIds.size === 0) {
                    alert('Nie zaznaczono żadnych produktów.');
                    return;
                }

                $('#selectedProductsModal').modal('hide');
                showLoading();

                const productIdsArray = Array.from(selectedProductIds).map(id => parseInt(id));

                fetch(`/AutomationRules/GetRulesStatusForProducts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        StoreId: storeId,
                        SourceType: sourceTypeInt,
                        IsAllegro: isAllegroContext,
                        ProductIds: productIdsArray
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Błąd sieci");
                    return response.json();
                })
                .then(rules => {
                    renderAutomationRulesInModal(rules, selectedProductIds.size);
                    hideLoading();
                    $('#automationSelectionModal').modal('show');
                })
                .catch(error => {
                    console.error('Błąd pobierania reguł:', error);
                    hideLoading();
                    alert('Błąd komunikacji z serwerem.');

                    $('#selectedProductsModal').modal('show');
                });
            });

            $(document).on('click', '#openBulkFlagModalBtn', function() {
                alert("Zarządzanie flagami dla tego widoku zostanie dodane wkrótce.");
            });

            $(document).on('click', '.edit-btn', function(e) {
                e.preventDefault(); e.stopPropagation();
                var wrapper = $(this).closest('.purchase-wrapper');
                $('.edit-mode').addClass('d-none'); $('.display-mode').removeClass('d-none');
                wrapper.find('.display-mode').addClass('d-none'); wrapper.find('.edit-mode').removeClass('d-none');
                var inp = wrapper.find('input'); inp.val(inp.val()); inp.focus();
            });
            $(document).on('click', '.cancel-btn', function(e) {
                e.preventDefault();
                $(this).closest('.purchase-wrapper').find('.edit-mode').addClass('d-none').end().find('.display-mode').removeClass('d-none');
            });
            $(document).on('click', '.save-btn', function(e) {
                e.preventDefault();
                var wrap = $(this).closest('.purchase-wrapper');
                var val = wrap.find('input').val().replace(',', '.');
                if(val==='' || isNaN(val) || parseFloat(val)<0) { alert("Błędna cena."); return; }
                sendPriceUpdate(wrap, parseFloat(val), $(this));
            });
            $(document).on('click', '.delete-btn-inner', function(e) {
                e.preventDefault();
                if(confirm("Usunąć cenę zakupu?")) sendPriceUpdate($(this).closest('.purchase-wrapper'), null, $(this));
            });
            $(document).on('keypress', '.price-edit-input', function(e) {
                if(e.which == 13) { e.preventDefault(); $(this).closest('.edit-mode').find('.save-btn').click(); }
            });
        });

        function sendPriceUpdate(wrapper, priceValue, btnElement) {
            var productId = wrapper.data('id');
            var storeId = wrapper.data('store-id');
            var isMktStr = String(wrapper.data('is-marketplace')).toLowerCase();
            var isMarketplaceBool = (isMktStr === 'true');

            var token = $('input[name="__RequestVerificationToken"]').val();
            if (!token) { alert("Brak tokenu CSRF."); return; }

            var url = isMarketplaceBool
                ? '@Url.Action("UpdateAllegroPurchasePrice", "AllegroProduct")?storeId=' + storeId
                : '@Url.Action("UpdatePurchasePrice", "Product")?storeId=' + storeId;

            var payload = isMarketplaceBool
                ? { AllegroProductId: parseInt(productId), NewPrice: priceValue }
                : { ProductId: parseInt(productId), NewPrice: priceValue };

            var originalContent = btnElement.html();
            btnElement.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                headers: { 'RequestVerificationToken': token },
                data: JSON.stringify(payload),
                success: function(response) {
                    if(response.success) location.reload();
                    else { alert("Błąd: " + response.message); btnElement.html(originalContent).prop('disabled', false); }
                },
                error: function(xhr) {
                    alert("Błąd serwera.");
                    btnElement.html(originalContent).prop('disabled', false);
                }
            });
        }

        function executeAutomation() {
            if (!confirm("Czy na pewno chcesz wykonać automatyzację?")) { return; }
            var btn = $(event.target).closest('button');
            var originalText = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Przetwarzanie...');

            $.ajax({
                url: '@Url.Action("ExecuteAutomation", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: currentRuleId }),
                success: function(r) {
                    if(r.count === 0) alert("Wykonano, ale brak zmian do aktualizacji.");
                    else alert("Sukces! Zaktualizowano " + r.count + " ofert.");
                    location.reload();
                },
                error: function(xhr) {
                    alert("Błąd: " + (xhr.responseText || xhr.statusText));
                    btn.prop('disabled', false).html(originalText);
                }
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <script>
        var chartEff = null;
        var chartDyn = null;

        function showChartLoading() {
            if (chartEff) chartEff.showLoading();
            if (chartDyn) chartDyn.showLoading();
        }

        function hideChartLoading() {
            if (chartEff) chartEff.hideLoading();
            if (chartDyn) chartDyn.hideLoading();
        }

        function loadHistoryData(limit) {
            showChartLoading();

            $.ajax({
                url: '@Url.Action("GetAutomationHistory", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: @Model.RuleId, Limit: limit }),
                success: function(data) {
                    hideChartLoading();
                    renderEffectivenessChart(data);
                    renderDynamicsChart(data);
                },
                error: function(xhr, status, error) {
                    hideChartLoading();
                    console.error("Błąd pobierania danych:", error);
                }
            });
        }

              function renderEffectivenessChart(data) {
            if (!chartEff) return;

            var option = {
                title: { text: 'Skuteczność Reguły', left: 'center', textStyle: { fontSize: 13 } },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },

                legend: { bottom: 0, data: ['Spełnione', 'Niespełnione/Blok'] },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '35px', containLabel: true },
                xAxis: { type: 'category', data: data.dates },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'Spełnione',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {

                            color: 'rgba(0, 145, 123, 0.8)',
                            borderColor: 'rgba(0, 145, 123, 1)',
                            borderWidth: 1,
                            borderRadius: 0
                        },
                        data: data.targetMet
                    },
                    {
                        name: 'Niespełnione/Blok',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: 'rgba(108, 117, 125, 0.8)',
                            borderColor: '#6C757D',
                            borderWidth: 1,
                            borderRadius: 0
                        },
                        data: data.targetUnmet
                    }

                ]
            };
            chartEff.setOption(option);
        }

        function renderDynamicsChart(data) {
            if (!chartDyn) return;

            var option = {
                title: { text: 'Dynamika Zmian', left: 'center', textStyle: { fontSize: 13 } },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { bottom: 0, data: ['Podwyżki', 'Utrzymane', 'Obniżki', 'Razem'] },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '35px', containLabel: true },
                xAxis: { type: 'category', data: data.dates },
                yAxis: { type: 'value' },
                series: [

                    {
                        name: 'Obniżki',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: 'rgba(25, 135, 84, 0.8)',
                            borderColor: '#198754',
                            borderWidth: 1,
                            borderRadius: 0
                        },
                        data: data.decreased
                    },

                    {
                        name: 'Utrzymane',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: 'rgba(13, 110, 253, 0.8)',
                            borderColor: '#0d6efd',
                            borderWidth: 1,
                            borderRadius: 0
                        },
                        data: data.maintained
                    },

                    {
                        name: 'Podwyżki',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: 'rgba(231, 74, 59, 0.8)',
                            borderColor: '#e74a3b',
                            borderWidth: 1,
                            borderRadius: 0
                        },
                        data: data.increased
                    },

                    {
                        name: 'Razem',
                        type: 'line',
                        data: data.totalProducts,
                        symbol: 'none',
                        itemStyle: { color: '#000000' },
                        lineStyle: {
                            type: 'dashed',
                            width: 3,
                            color: '#000000'
                        }
                    }
                ]
            };
            chartDyn.setOption(option);
        }

        $(document).ready(function() {
            var elemEff = document.getElementById('chartEffectiveness');
            var elemDyn = document.getElementById('chartDynamics');

            if (elemEff && elemDyn) {
                chartEff = echarts.init(elemEff);
                chartDyn = echarts.init(elemDyn);

                loadHistoryData(7);

                window.addEventListener('resize', function() {
                    chartEff.resize();
                    chartDyn.resize();
                });
            }

            $('.history-btn').click(function() {
                $('.history-btn').removeClass('active');
                $(this).addClass('active');
                var days = $(this).data('days');
                loadHistoryData(days);
            });
        });
    </script>
}