@using PriceSafari.Models.ViewModels
@using Microsoft.AspNetCore.Identity
@using PriceSafari.Models

@model AutomationDetailsViewModel
@inject UserManager<PriceSafariUser> UserManager

@{
    ViewData["Title"] = $"Szczegóły Reguły: {Model.RuleName}";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var user = await UserManager.GetUserAsync(User);
    bool canEdit = user?.AccesToEditPriceAutomation ?? false;
    string noAccessMessage = "Nie masz uprawnień aby zarządzać regułami automatyzacji cen. Skontaktuj sie z nami biuro@pricesafari.pl";

    bool isCompetitiveness = Model.StrategyMode == AutomationStrategyMode.Competitiveness;

    string strategyClass = isCompetitiveness ? "strategy-comp" : "strategy-prof";
    string strategyIconClass = isCompetitiveness ? "fa-bolt" : "fa-dollar-sign";
    string strategyLabel = isCompetitiveness ? "Lider Rynku" : "Rentowność";

    string statusClass = Model.IsActive ? "status-active-color" : "status-inactive-color";
    string statusLabel = Model.IsActive ? "Aktywny" : "Wyłączony";

    string borderClass = Model.SourceType == AutomationSourceType.PriceComparison ? "border-left-info" : "border-left-warning";

    bool isMarketplace = Model.SourceType == AutomationSourceType.Marketplace;
    int total = Model.TotalProducts > 0 ? Model.TotalProducts : 1;
    int successCount = Model.CountMet + Model.CountMaintained + Model.CountLimited;
    int blockedCount = Model.CountBlocked;
    int percentSuccess = Model.SuccessRate;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
@Html.AntiForgeryToken()

<style>
    .limit-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff !important;
        margin-right: 6px;
        min-width: 55px;
        height: 22px;
        gap: 4px;
    }

    .badge-purchase {
        background-color: #282828;
    }

    .badge-min {
        background-color: rgba(171, 37, 32, 1);
    }

    .badge-max {
        background-color: rgba(0, 145, 123, 1);
    }

    .limit-price-text {
        font-weight: 500;
        font-size: 13px;
    }

    .rank-icon {
        width: 12px;
        height: 12px;
        vertical-align: middle;
        margin-right: 5px;
    }

    .rank-row {
        display: flex;
        align-items: center;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff !important;
        width: 124px;
        min-width: 120px;
        height: 24px;
        gap: 4px;
    }

    .status-ok {
        background-color: rgba(0, 145, 123, 1);
    }

    .status-maintained {
        background-color: rgba(13, 110, 253, 0.7);
    }

    .status-limited {
        background-color: #f6c23e;
        color: #fff !important;
    }

    .status-blocked {
        background-color: #6C757D;
    }

    .status-neutral {
        background-color: #858796;
    }

    .status-text {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .price-row-block {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .price-row-space {
        display: flex;
        align-items: center;
        gap: 4px;
        justify-content: space-between;
    }

    .price-main-style {
        font-weight: 500;
        font-size: 17px;
        color: #000;
    }

    .price-green {
        color: #169A23 !important;
    }

    .commission-stack-badge {
        width: 52px;
    }

    .price-badge {
        width: 52px;
    }

    .text-muted {
        font-size: 12px;
    }

    .column-flex-min-gap {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .dynamics-stat {
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        margin-right: 10px;
    }

    .purchase-wrapper {
        position: relative;
        min-width: 190px;
    }

    .price-actions-display {
        display: inline-flex;
        margin-right: 6px;
        vertical-align: middle;
        opacity: 0.4;
        transition: opacity 0.2s;
    }

    .purchase-row:hover .price-actions-display {
        opacity: 1;
    }

    .edit-trigger {
        cursor: pointer;
        font-size: 10px;
        color: #343a40;
    }

        .edit-trigger:hover {
            color: #1d2124;
        }

    .edit-disabled {
        cursor: not-allowed;
        font-size: 10px;
        color: #ccc;
    }

    .price-edit-input {
        width: 75px;
        padding: 2px 5px;
        border: 1px solid #d1d3e2;
        border-radius: 4px;
        font-size: 13px;
        color: #6e707e;
        height: 26px;
    }

    .btn-action-icon {
        background: none;
        border: none;
        padding: 2px 4px;
        cursor: pointer;
        color: #858796;
        transition: color 0.2s;
        font-size: 13px;
    }

        .btn-action-icon:hover {
            color: #5a5c69;
        }

        .btn-action-icon.save-btn:hover {
            color: #1cc88a;
        }

        .btn-action-icon.delete-btn-inner:hover {
            color: #e74a3b;
        }

    .d-none {
        display: none !important;
    }

    .product-name-wrap {
        white-space: normal !important;
        word-wrap: break-word;
        width: 250px;
        line-height: 1.3;
    }

    .simulationProductTitle {
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease-in-out;
    }

        .simulationProductTitle:hover {
            color: #41C7C7 !important;
            text-decoration: none;
        }

    .btn-disabled-access {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: auto !important;
    }

    .status-box-dashed {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        width: 124px;
        min-width: 120px;
        height: 24px;
        gap: 4px;
        background-color: transparent;
        border-style: dashed;
        border-width: 2px;
        text-transform: uppercase;
    }

    .status-dashed-success {
        border-color: #1cc88a;
        color: #1cc88a !important;
    }

    .status-dashed-danger {
        border-color: #e74a3b;
        color: #e74a3b !important;
    }

    .status-dashed-secondary {
        border-color: #858796;
        color: #858796 !important;
    }

    .header-info-box {
        display: inline-flex;
        padding: 4px 16px;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        border: 2px dashed #f1f3f9;
        min-height: 34px;
        gap: 12px;
        margin-left: 15px;
    }

    .strategy-text {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .strategy-comp {
        color: rgba(113, 96, 232, 1);
    }

    .strategy-prof {
        color: #0d2c56;
    }

    .header-separator {
        color: #bbb;
        font-weight: 300;
        font-size: 16px;
    }

    .status-indicator-text {
        font-weight: 600;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-active-color {
        color: #1cc88a;
    }

    .status-inactive-color {
        color: #e74a3b;
    }

    .Chart-Box-a {
        display: flex;
        flex-grow: 1;
        min-height: 500px;
        padding: 24px;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        align-self: stretch;
        gap: 24px;
        border-radius: 8px;
        background: #FFF;
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.05);
        min-width: 200px;
    }

    .kpi-container {
        display: flex;
        gap: 16px;
        width: 100%;
        flex-wrap: wrap;
    }

    .kpi-card {
        flex: 1;
        min-width: 280px;
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        position: relative;
        overflow: hidden;
    }

    .kpi-accent-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
    }

    .kpi-title {
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #858796;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kpi-value-big {
        font-size: 28px;
        font-weight: 700;
        color: #5a5c69;
        line-height: 1.2;
    }

    .kpi-subtext {
        font-size: 12px;
        color: #858796;
        margin-top: 6px;
        font-weight: 500;
    }

    .dynamics-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 5px;
    }

    .dynamics-item {
        display: flex;
        flex-direction: column;
    }

    .dynamics-val {
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .dynamics-label {
        font-size: 10px;
        text-transform: uppercase;
        color: #a0a0a0;
        margin-top: 2px;
    }

    .mini-progress-bg {
        width: 100%;
        height: 6px;
        background: #e3e3e3;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
    }

    .mini-progress-fill {
        height: 100%;
        background: #33A795;
        border-radius: 3px;
    }

    .btn-icon-settings {
        font-size: 24px;
        color: #858796;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        text-decoration: none !important;
        outline: none !important;
        box-shadow: none !important;
    }

        .btn-icon-settings:hover {
            color: #5a5c69;
            transform: rotate(30deg);
            text-decoration: none !important;
        }

        .btn-icon-settings.disabled {
            color: #d1d3e2;
            cursor: not-allowed;
        }

            .btn-icon-settings.disabled:hover {
                color: #d1d3e2;
                transform: none;
            }

    .period-selector-group {
        background-color: #e3e3e3;
        border-radius: 6px;
        padding: 4px;
        display: inline-flex;
        gap: 2px;
    }

    .period-btn-custom {
        border: none;
        background: transparent;
        color: #858796;
        font-size: 11px;
        font-weight: 700;
        padding: 6px 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none !important;
    }

        .period-btn-custom:hover:not(.active) {
            color: #5a5c69;
            background-color: rgba(255,255,255, 0.5);
        }

        .period-btn-custom.active {
            background-color: #ffffff;
            color: #222222;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

    .highlighted-text {
        background-color: rgba(255, 235, 59, 0.6);
        font-weight: bold;
        color: #000;
        border-radius: 2px;
        padding: 0 2px;
    }

    .filter-toolbar-wrapper {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 0;
    }

    .filter-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-start;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: #f8f9fc;
        border-radius: 6px;
        border: 1px solid #e3e6f0;
    }

    .filter-group-label {
        font-size: 11px;
        font-weight: 700;
        color: #858796;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-right: 4px;
        white-space: nowrap;
    }

    .filter-group-divider {
        width: 1px;
        height: 28px;
        background: #e3e6f0;
        margin: 0 4px;
    }

    .filter-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        color: #5a5c69;
        background: #fff;
        border: 1px solid #d1d3e2;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

        .filter-btn:hover {
            background: #f2f2f2;
            border-color: #e0e0e0;
        }

        .filter-btn.active {
            background: #282828;
            color: #fff;
            border-color: #282828;
        }

            .filter-btn.active:hover {
                background: #000;
                border-color: #000;
            }

        .filter-btn .filter-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 18px;
            padding: 0 5px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .filter-btn.active .filter-count {
            background: rgba(255, 255, 255, 0.25);
        }

        .filter-btn[data-filter-key="increase"].active {
            background: #DC3545;
            border-color: #DC3545;
        }

        .filter-btn[data-filter-key="decrease"].active {
            background: #198754;
            border-color: #198754;
        }

        .filter-btn[data-filter-key="maintained"].active {
            background: rgba(13, 110, 253, 0.7);
            border-color: rgba(13, 110, 253, 0.7);
        }

        .filter-btn[data-filter-key="blocked"].active {
            background: #6C757D;
            border-color: #6C757D;
        }

        .filter-btn[data-filter-key="TargetMet"].active {
            background: rgba(0, 145, 123, 1);
            border-color: rgba(0, 145, 123, 1);
        }

        .filter-btn[data-filter-key="TargetMaintained"].active {
            background: rgba(13, 110, 253, 0.7);
            border-color: rgba(13, 110, 253, 0.7);
        }

        .filter-btn[data-filter-key="has-purchase"].active {
            background: #282828;
            border-color: #282828;
        }

        .filter-btn[data-filter-key="PriceLimited"].active {
            background: #f6c23e;
            border-color: #f6c23e;
            color: #333;
        }

        .filter-btn[data-filter-key="Blocked"].active {
            background: #6C757D;
            border-color: #6C757D;
        }

        .filter-btn[data-filter-key="updated-yes"].active {
            background: #1cc88a;
            border-color: #1cc88a;
        }

        .filter-btn[data-filter-key="updated-no"].active {
            background: #e74a3b;
            border-color: #e74a3b;
        }

        .filter-btn[data-filter-key="missing-own"].active {
            background: #fd7e14;
            border-color: #fd7e14;
        }

        .filter-btn[data-filter-key="no-competition"].active {
            background: #6f42c1;
            border-color: #6f42c1;
        }

    .filter-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e3e6f0;
    }

    .filter-summary-text {
        font-size: 13px;
        color: #858796;
    }

    .filter-reset-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        font-size: 12px;
        font-weight: 600;
        color: #e74a3b;
        background: #fff;
        border: 1px solid #e74a3b;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .filter-reset-btn:hover {
            background: #e74a3b;
            color: #fff;
        }

    .filter-btn[data-filter-key="LimitFloor"].active {
        background: #e74a3b;
        border-color: #e74a3b;
    }

    .filter-btn[data-filter-key="LimitCeiling"].active {
        background: #f6c23e;
        border-color: #f6c23e;
        color: #333;
    }

    tr.filter-hidden {
        display: none !important;
    }
</style>

<div class="View">

    <div class="Vert">
        <div class="Date" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">

            <div style="display: flex; align-items: center;">
                <div class="Order-Container-Title" style="font-size: 23px;">
                   Automat cenowy <strong>@Model.RuleName</strong>
               
                </div>

             
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">

               

                <div class="header-info-box">
                    <div class="strategy-text @strategyClass">
                        <i class="fa-solid @strategyIconClass"></i> @strategyLabel
                    </div>

                    <span class="header-separator">|</span>

                    <div class="status-indicator-text @statusClass">
                        <i class="fa-solid fa-circle" style="font-size: 6px;"></i> @statusLabel
                    </div>
                </div>
                @if (canEdit)
                {
                    <a asp-controller="AutomationRules" asp-action="Edit" asp-route-id="@Model.RuleId"
                       class="btn-icon-settings"
                       title="Konfiguruj Regułę">
                        <i class="fas fa-cog"></i>
                    </a>
                }
                else
                {
                    <a href="#" onclick="showNoAccessAlert(); return false;"
                       class="btn-icon-settings disabled"
                       title="Brak uprawnień do edycji">
                        <i class="fas fa-cog"></i>
                    </a>
                }
            </div>

        </div>
    </div>




    <div class="Vert">
        <div class="kpi-container">

        
            

                <div class="kpi-card">
                  
                    <div class="kpi-title">
                        Przypisane Produkty
                        <i class="fas fa-cube text-gray-400"></i>
                    </div>
                    <div class="kpi-value-big">@Model.TotalProducts</div>

                    <div class="kpi-subtext" style="display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-clock" style="font-size: 12px; width: 12px; text-align: center;"></i>
                        <span>Aktualizacja: @(Model.LastScrapDate.HasValue? Model.LastScrapDate.Value.ToString("dd.MM HH:mm") : "-")</span>
                    </div>

                    <div class="kpi-subtext" style="display:flex; align-items:center; gap:6px; margin-top:3px;">
                        <i class="fas fa-store" style="font-size: 12px; width: 12px; text-align: center;"></i>
                        <span>Sklep: @Model.StoreName</span>
                    </div>
                </div>

            <div class="kpi-card">
          

                <div class="kpi-title">
                    Skuteczność Reguły
                    <span style="color:#33A795;">@percentSuccess%</span>
                </div>

                <div class="d-flex align-items-end gap-2">
                    <div class="kpi-value-big text-gray-800">@successCount</div>
                    <div class="kpi-subtext mb-1">ofert przeliczonych</div>
                </div>

                <div class="mini-progress-bg">
                    <div class="mini-progress-fill" style="width: @percentSuccess%"></div>
                </div>

                <div class="kpi-subtext mt-2">
                    <span class="text-danger font-weight-bold" title="Liczba zablokowanych"><i class="fas fa-ban mr-1"></i> @blockedCount</span> zablokowanych
                </div>
            </div>

            <div class="kpi-card">
             

                <div class="kpi-title">
                    Dynamika Zmian
                    <i class="fas fa-chart-bar text-gray-400"></i>
                </div>

                <div class="dynamics-row">
                    <div class="dynamics-item">
                        <div class="dynamics-val text-danger">
                            <i class="fas fa-arrow-up fa-xs"></i> @Model.CountIncreased
                        </div>
                        <div class="dynamics-label">Podwyżki</div>
                    </div>

                    <div class="dynamics-item" style="border-left: 1px solid #eee; padding-left: 15px;">
                        <div class="dynamics-val text-success">
                            <i class="fas fa-arrow-down fa-xs"></i> @Model.CountDecreased
                        </div>
                        <div class="dynamics-label">Obniżki</div>
                    </div>

                    <div class="dynamics-item" style="border-left: 1px solid #eee; padding-left: 15px;">
                        <div class="dynamics-val text-primary">
                            <i class="fas fa-circle fa-xs" style="font-size: 8px;"></i> @Model.CountMaintained
                        </div>
                        <div class="dynamics-label">Założenia utrzymane</div>
                    </div>
                </div>

                <div class="kpi-subtext mt-2">
                    Zoptymalizowano cenę w <strong>@(Model.CountIncreased + Model.CountDecreased)</strong> ofertach
                </div>
            </div>

        </div>
    </div>








    <div class="Vert">
        <div class="Chart-Box-a" style="width: 100%; min-height: 400px;">

            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px;">
                <div style="display:flex; align-items:center; gap: 20px;">
                    <div class="kpi-title" style="margin-bottom:0;">
                        Analiza Automatu
                    </div>

                    <div class="period-selector-group">
                        <button type="button" id="viewModeExec" class="period-btn-custom active"
                                onclick="switchChartMode('execution')">
                            <i class="fas fa-chart-bar" style="margin-right: 4px;"></i> Wykonania
                        </button>

                        @if (isMarketplace)
                        {
                            <button type="button" id="viewModeSales" class="period-btn-custom"
                                    onclick="switchChartMode('sales')">
                                <i class="fas fa-chart-line" style="margin-right: 4px;"></i> Sprzedaż
                            </button>

                            <button type="button" id="viewModeBadges" class="period-btn-custom"
                                    onclick="switchChartMode('badges')">
                                <i class="fas fa-medal" style="margin-right: 4px;"></i> Odznaki
                            </button>
                        }

                        <button type="button" id="viewModePosition" class="period-btn-custom"
                                onclick="switchChartMode('position')">
                            <i class="fas fa-trophy" style="margin-right: 4px;"></i> Pozycja cenowa
                        </button>
                    </div>

                </div>

                <div class="period-selector-group">
                    <button type="button" class="period-btn-custom active history-btn" data-days="7">7 Analiz</button>
                    <button type="button" class="period-btn-custom history-btn" data-days="14">14 Analiz</button>
                    <button type="button" class="period-btn-custom history-btn" data-days="30">30 Analiz</button>
                </div>
            </div>


            <div id="executionChartsContainer" style="display: flex; width: 100%; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px; height: 400px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                    <div id="chartEffectiveness" style="width: 100%; height: 100%;"></div>
                </div>
                <div style="flex: 1; min-width: 300px; height: 400px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                    <div id="chartDynamics" style="width: 100%; height: 100%;"></div>
                </div>
            </div>

            <div id="salesChartContainer" style="display: none; width: 100%; height: 400px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                <div id="chartSales" style="width: 100%; height: 100%;"></div>
            </div>

            <div id="badgeChartContainer" style="display: none; width: 100%; height: 400px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                <div id="chartBadges" style="width: 100%; height: 100%;"></div>
            </div>

            @* --- NOWY KONTENER: POZYCJA CENOWA --- *@
            <div id="positionChartContainer" style="display: none; width: 100%; height: 400px; border: 1px solid #e3e6f0; border-radius: 8px; padding: 10px;">
                <div id="chartPosition" style="width: 100%; height: 100%;"></div>
            </div>

        </div>
    </div>










    <div class="Vert">
        <div class="Date" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">

            <div style="display: flex; align-items: center; gap:6px;">
                <input type="text" id="productSearch" style="max-width:150px; height:33.99px;" placeholder="Wyszukaj produkt">
                @if (canEdit)
                {
                    @if (Model.IsActive)
                    {
                        <button class="btn btn-success btn-sm shadow-sm"
                                onclick="executeAutomation()"
                                title="Wymuś natychmiastowe przeliczenie reguły"
                                style="display: inline-flex; align-items: center; gap: 8px; font-weight: 600; padding-left: 12px; padding-right: 12px; height:34px;">
                            <i class="fas fa-play"></i>
                            <span>Aktualizuj ceny teraz</span>
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-secondary btn-sm shadow-sm"
                                title="Reguła musi być aktywna, aby można było ją wykonać ręcznie."
                                onclick="return false;"
                                style="cursor: not-allowed; opacity: 0.6; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; padding-left: 12px; padding-right: 12px; height:34px;">
                            <i class="fas fa-play"></i>
                            <span>Aktualizuj ceny teraz</span>
                        </button>
                    }
                }
                else
                {
                    <button class="btn btn-success btn-sm btn-disabled-access shadow-sm"
                            onclick="showNoAccessAlert()"
                            style="display: inline-flex; align-items: center; gap: 8px; font-weight: 600; padding-left: 12px; padding-right: 12px; height:34px;">
                        <i class="fas fa-play"></i>
                        <span>Aktualizuj ceny teraz</span>
                    </button>
                }
            </div>

            <div>


                <div id="selectionContainer" class="selection-container">
                    <span id="selectedProductsCounter" class="ProductCount" style="width:126px; height:33.99px;">Wybrano: 0</span>
                    <button id="selectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Zaznacz wszystkie widoczne produkty">
                        <i class="fa-solid fa-square-check"></i>
                    </button>
                    <button id="deselectAllVisibleBtn" class="Button-Page-Small" style="width:48px;" title="Odznacz wszystkie widoczne produkty">
                        <i class="fa-solid fa-square-xmark"></i>
                    </button>
                    <button id="showSelectedProductsBtn" class="Button-Page-Small" style="width:89.25px;">Akcje</button>
                </div>




            </div>

        </div>
    </div>

    <div class="Vert">
        <div class="filter-toolbar-wrapper">
            <div class="filter-toolbar" id="filterToolbar">
           
            </div>
            <div class="filter-summary" id="filterSummary">
                <span class="filter-summary-text">Wyświetlane: <strong id="visibleCount">0</strong> z <strong id="totalCount">0</strong></span>
                <button class="filter-reset-btn" id="resetFiltersBtn" style="display: none;">
                    <i class="fas fa-times"></i> Resetuj filtry
                </button>
            </div>
        </div>
        <div class="Vert-full">
            <div class="Vert-table" style="height: 90vh;">
                <table class="table-orders" id="automationTable" width="100%">
                    <thead>
                        <tr>
                            @if (!isMarketplace)
                            {
                                <th style="width: 50px;"></th>
                            }
                            <th style="width: 250px;">Produkt</th>
                            <th style="width: 200px; min-width: 195px;">Limity Cenowe</th>
                            <th style="min-width: 225px;">Dane z rynku - Twoja oferta</th>
                            @if (Model.StrategyMode == AutomationStrategyMode.Competitiveness)
                            {
                                <th style="min-width: 225px;">Najlepszy Rywal</th>
                            }
                            else
                            {
                                <th style="min-width: 225px;">Mediana Rynku</th>
                            }
                            <th style="min-width: 150px; width: 150px;">Zmiana</th>
                            <th class="bg-gradient-light border-left-primary" style="min-width: 225px;">Wyznaczona Cena</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Products)
                        {

                            string priceChangeType = "none";
                            if (item.Status == AutomationCalculationStatus.Blocked)
                            {
                                priceChangeType = "blocked";
                            }
                            else if (item.PriceChange.HasValue && item.PriceChange.Value > 0)
                            {
                                priceChangeType = "increase";
                            }
                            else if (item.PriceChange.HasValue && item.PriceChange.Value < 0)
                            {
                                priceChangeType = "decrease";
                            }
                            else if (item.Status == AutomationCalculationStatus.TargetMaintained)
                            {
                                priceChangeType = "maintained";
                            }

                            string limitType = "none";

                            if (item.Status == AutomationCalculationStatus.PriceLimited && item.SuggestedPrice.HasValue)
                            {
                                if (item.MinPriceLimit.HasValue &&
                                Math.Abs(item.SuggestedPrice.Value - item.MinPriceLimit.Value) < 0.01m)
                                {
                                    limitType = "floor";
                                }
                                else if (item.MaxPriceLimit.HasValue &&
                                Math.Abs(item.SuggestedPrice.Value - item.MaxPriceLimit.Value) < 0.01m)
                                {
                                    limitType = "ceiling";
                                }
                                else
                                {
                                    if (item.MinPriceLimit.HasValue && item.MaxPriceLimit.HasValue)
                                    {
                                        decimal distToMin = Math.Abs(item.SuggestedPrice.Value - item.MinPriceLimit.Value);
                                        decimal distToMax = Math.Abs(item.SuggestedPrice.Value - item.MaxPriceLimit.Value);
                                        limitType = distToMin < distToMax ? "floor" : "ceiling";
                                    }
                                    else if (item.MinPriceLimit.HasValue)
                                    {
                                        limitType = "floor";
                                    }
                                    else if (item.MaxPriceLimit.HasValue)
                                    {
                                        limitType = "ceiling";
                                    }
                                }
                            }

                            else if (item.Status == AutomationCalculationStatus.Blocked && item.BlockReason == "Blokada Narzutu")
                            {
                                limitType = "floor";
                            }

                            bool isMissingOwnOffer = item.IsMissingPlatformWarning ||
                            (item.BlockReason != null && item.BlockReason.StartsWith("Brak oferty"));

                            bool isNoCompetition = !item.BestCompetitorPrice.HasValue ||
                            item.BlockReason == "Brak Danych";

                         
                            string marginBadgeClass = "price-badge-positive";
                            string marginBoxClass = "price-box-diff-margin-ib-positive";
                            bool isMarginIssue = false; 

                            if (item.CurrentMarkupAmount.HasValue && item.CurrentMarkupPercent.HasValue)
                            {
                                decimal currentMarginPercent = item.CurrentMarkupPercent.Value;
                                decimal currentMarginAmount = item.CurrentMarkupAmount.Value;

                                
                                if (currentMarginAmount < 0)
                                {
                                    marginBadgeClass = "price-badge-negative";
                                    marginBoxClass = "price-box-diff-margin-ib-negative";
                                    isMarginIssue = true; 
                                }
                                
                                else if (Model.EnforceMinimalMarkup)
                                {
                                    bool isBelowLimit = false;

                                    if (Model.IsMinimalMarkupPercent)
                                    {
                                   
                                        if (currentMarginPercent < Model.MinimalMarkupValue)
                                        {
                                            isBelowLimit = true;
                                        }
                                    }
                                    else
                                    {
                                   
                                        if (currentMarginAmount < Model.MinimalMarkupValue)
                                        {
                                            isBelowLimit = true;
                                        }
                                    }

                                    if (isBelowLimit)
                                    {
                                        marginBadgeClass = "price-badge-warning";            
                                        marginBoxClass = "price-box-diff-margin-ib-warning"; 
                                        isMarginIssue = true; 
                                    }
                                }
                            }


                            <tr data-price-change="@priceChangeType"
                                data-status="@item.Status.ToString()"
                                data-limit-type="@limitType"
                                data-block-reason="@(item.BlockReason ?? "")"
                                data-has-guarantee="@item.IsBestPriceGuarantee.ToString().ToLower()"
                                data-is-super-price="@item.IsSuperPrice.ToString().ToLower()"
                                data-is-top-offer="@item.IsTopOffer.ToString().ToLower()"
                                data-has-cheaper-own="@item.HasCheaperOwnOffer.ToString().ToLower()"
                                data-is-subsidy="@(item.IsSubsidyActive.ToString().ToLower())"
                                data-is-campaign="@(item.IsInAnyCampaign.ToString().ToLower())"
                                data-is-updated="@item.IsAlreadyUpdated.ToString().ToLower()"
                                data-has-purchase-price="@item.PurchasePrice.HasValue.ToString().ToLower()"
                                data-is-commission-included="@(item.IsCommissionIncluded.ToString().ToLower())"
                                data-has-margin-warning="@isMarginIssue.ToString().ToLower()"
                                data-missing-own-offer="@isMissingOwnOffer.ToString().ToLower()"
                                data-no-competition="@isNoCompetition.ToString().ToLower()">
                                @if (!isMarketplace)
                                {
                                    <td class="text-center align-middle">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" alt="img" style="max-height: 40px; max-width: 40px;" />
                                        }
                                        else
                                        {
                                            <i class="fas fa-image text-gray-400"></i>
                                        }
                                    </td>
                                }

                                <td class="align-middle">
                                    <div class="font-weight-bold product-name-wrap" title="@item.Name">
                                        @{
                                            string linkUrl = null;
                                            if (isMarketplace)
                                            {
                                                linkUrl = $"/AllegroPriceHistory/Details?storeId={Model.StoreId}&productId={item.ProductId}";
                                            }
                                            else if (Model.LatestScrapId.HasValue)
                                            {
                                                linkUrl = $"/PriceHistory/Details?scrapId={Model.LatestScrapId}&productId={item.ProductId}";
                                            }
                                        }
                                        @if (!string.IsNullOrEmpty(linkUrl))
                                        {
                                            <a href="@linkUrl" target="_blank" rel="noopener noreferrer" class="simulationProductTitle">
                                                @item.Name
                                            </a>
                                        }
                                        else
                                        {
                                            @item.Name
                                        }
                                    </div>
                                    <div class="small text-muted mb-1 mt-1">
                                        @item.Identifier
                                        @if (item.ApiAllegroPriceFromUser.HasValue)
                                        {
                                            <span class="text-xs ml-1 text-gray-500" title="Cena bazowa w API (przed dopłatami)">(API: @item.ApiAllegroPriceFromUser)</span>
                                        }
                                    </div>
                                    <div class="mt-2">

                                        <button class="select-product-btn"
                                                data-product-id="@item.ProductId"
                                                data-product-name="@item.Name"
                                                style="font-size: 11px; padding: 2px 8px; width: 100px; pointer-events: auto;">
                                            Zaznacz
                                        </button>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <div class="purchase-wrapper"
                                         data-id="@item.ProductId"
                                         data-store-id="@Model.StoreId"
                                         data-is-marketplace="@isMarketplace.ToString().ToLower()">

                                        <div class="display-mode">
                                            @if (item.PurchasePrice.HasValue)
                                            {
                                                <div class="bg-light p-2 rounded border purchase-row">
                                                    @if (item.MaxPriceLimit.HasValue)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="limit-badge badge-max">MAX <i class="fa-solid fa-arrow-up"></i></span>
                                                            <span class="limit-price-text" style="color: rgba(0, 145, 123, 1);">@item.MaxPriceLimit.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    }
                                                    @if (item.MinPriceLimit.HasValue)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center @(item.MaxPriceLimit.HasValue ? "border-top pt-1 mt-1" : "mb-1")">
                                                            <span class="limit-badge badge-min">MIN <i class="fa-solid fa-arrow-down"></i></span>
                                                            <span class="limit-price-text" style="color: rgba(171, 37, 32, 1);">@item.MinPriceLimit.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    }

                                                    <div class="d-flex justify-content-between align-items-center @(item.MinPriceLimit.HasValue || item.MaxPriceLimit.HasValue ? "border-top pt-1 mt-1" : "")">
                                                        <span class="limit-badge badge-purchase">Zakup</span>
                                                        <div class="d-flex align-items-center">
                                                            <span class="price-actions-display">

                                                                @if (item.PurchasePriceUpdatedDate.HasValue)
                                                                {
                                                                    <i class="fas fa-clock mr-1"
                                                                       style="font-size: 10px; color: #858796; cursor: help; margin-right:4px;"
                                                                       data-toggle="tooltip"
                                                                       title="Cena zakupu została zaktualizowana: @item.PurchasePriceUpdatedDate.Value.ToString("dd.MM.yyyy HH:mm")">
                                                                    </i>
                                                                }

                                                                @if (canEdit)
                                                                {
                                                                    <i class="fas fa-pencil-alt edit-btn edit-trigger" title="Edytuj cenę zakupu"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="fas fa-lock edit-disabled" title="Brak uprawnień do edycji" onclick="showNoAccessAlert()"></i>
                                                                }
                                                            </span>
                                                            <span class="limit-price-text val-display" style="color: #282828;">@item.PurchasePrice.Value.ToString("F2") PLN</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center text-gray-400 small purchase-row py-2 border rounded bg-light">
                                                    <span class="ml-2 cursor-pointer" title="Dodaj cenę zakupu">

                                                        @if (canEdit)
                                                        {
                                                            <i class="fas fa-plus-circle text-gray-500 edit-btn edit-trigger" style="font-size: 12px;"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-plus-circle text-gray-300" style="font-size: 12px; cursor: not-allowed;" onclick="showNoAccessAlert()"></i>
                                                        }
                                                    </span>
                                                    Brak ceny zakupu
                                                </div>
                                            }
                                        </div>

                                        <div class="edit-mode d-none bg-white p-2 rounded border shadow-sm" style="position:absolute; z-index:10; width:100%; top:50%; left:0; transform: translateY(-50%);">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <input type="number" step="0.01" class="price-edit-input" value="@(item.PurchasePrice?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "")" placeholder="0.00">

                                                <div class="d-flex ml-1">
                                                    <button class="btn-action-icon save-btn" type="button" title="Zapisz">
                                                        <i class="fas fa-check"></i>
                                                    </button>

                                                    <button class="btn-action-icon cancel-btn" type="button" title="Anuluj">
                                                        <i class="fas fa-times"></i>
                                                    </button>

                                                    @if (item.PurchasePrice.HasValue)
                                                    {
                                                        <button class="btn-action-icon delete-btn-inner ml-1 border-left pl-2" type="button" title="Usuń cenę zakupu">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="align-middle text-right">
                                    <div class="price-row-block">
                                        <span class="price-main-style @(item.IsBestPriceGuarantee ? "price-green" : "")">
                                            @(item.CurrentPrice.HasValue? item.CurrentPrice.Value.ToString("F2")  : "-") PLN
                                        </span>
                                        @if (item.HasCheaperOwnOffer)
                                        {
                                            <span class="text-danger mr-1"
                                                  data-toggle="tooltip"
                                                  title="UWAGA: Posiadasz inną, tańszą ofertę podpiętą pod ten sam katalog!"
                                                  style="cursor: help; font-size: 14px;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                        }
                                        @if (item.IsBestPriceGuarantee)
                                        {
                                            <div title="Gwarancja Najniższej Ceny">
                                                <img src="/images/TopPrice.png" alt="Gwarancja" style="width: 18px; height: 18px; vertical-align: middle;">
                                            </div>
                                        }
                                        @if (item.IsSuperPrice)
                                        {
                                            <div class="SuperPrice">SUPERCENA</div>
                                        }
                                        @if (item.IsTopOffer)
                                        {
                                            <div class="TopOffer">Top</div>
                                        }

                                    </div>
                                    <div class="small text-muted ">@Model.StoreName</div>
                                    @if (item.CommissionAmount.HasValue)
                                    {
                                        <div class="Commission-stack">
                                            <span class="commission-stack-badge">Prowizja</span>
                                            <p>
                                                @item.CommissionAmount.Value.ToString("F2") PLN
                                                @if (item.IsCommissionIncluded)
                                                {
                                                    <span style="font-weight: 400; color: #555;"> | uwzg.</span>
                                                }
                                                else
                                                {

                                                    <span style="font-weight: 400; color: #999;"> | nieuwzg.</span>
                                                }
                                            </p>
                                        </div>
                                    }
                                    @if (item.CurrentMarkupAmount.HasValue && item.CurrentMarkupPercent.HasValue)
                                    {
                                        <div class="price-box-diff-margin-ib @marginBoxClass" style="margin-top: 4px; width: 100%;">

                                            <span class="price-badge @marginBadgeClass">Narzut</span>

                                            <p>@item.CurrentMarkupAmount.Value.ToString("F2") PLN (@item.CurrentMarkupPercent.Value.ToString("F2")%)</p>
                                        </div>
                                    }

                                    @if (item.ApiAllegroPriceFromUser.HasValue)
                                    {

                                        if (item.IsSubsidyActive)
                                        {
                                            <div class="subsidy-stack" style="margin-top: 4px;">
                                                <span class="subsidy-stack-badge">Dopłaty | Twoja cena</span>
                                                <p>@item.ApiAllegroPriceFromUser.Value.ToString("F2") PLN</p>
                                            </div>
                                        }

                                        else if (item.IsInAnyCampaign)
                                        {
                                            <div class="Campaign-stack" style="margin-top: 4px;">
                                                <span class="campaign-stack-badge">Kampania | Twoja cena</span>
                                                <p>@item.ApiAllegroPriceFromUser.Value.ToString("F2") PLN</p>
                                            </div>
                                        }
                                    }
                                </td>

                                <td class="align-middle text-right">
                                    @if (Model.StrategyMode == AutomationStrategyMode.Competitiveness)
                                    {
                                        @if (item.BestCompetitorPrice.HasValue)
                                        {
                                            <div class="price-row-block">
                                                <span class="price-main-style @(item.CompetitorIsBestPriceGuarantee ? "price-green" : "")">
                                                    @item.BestCompetitorPrice.Value.ToString("F2") PLN
                                                </span>
                                                @if (item.CompetitorIsBestPriceGuarantee)
                                                {
                                                    <div title="Gwarancja Najniższej Ceny Rywala">
                                                        <img src="/images/TopPrice.png" alt="Gwarancja" style="width: 18px; height: 18px; vertical-align: middle;">
                                                    </div>
                                                }
                                                @if (item.CompetitorIsSuperPrice)
                                                {
                                                    <div class="SuperPrice">SUPERCENA</div>
                                                }
                                                @if (item.CompetitorIsTopOffer)
                                                {
                                                    <div class="TopOffer">Top</div>
                                                }
                                            </div>
                                            <div class="small text-muted">@item.CompetitorName</div>
                                        }
                                        else
                                        {
                                            <span class="small text-muted">Brak konkurencji</span>
                                        }
                                    }
                                    else
                                    {
                                        @if (item.MarketAveragePrice.HasValue)
                                        {
                                            <span class="price-main-style">@item.MarketAveragePrice.Value.ToString("F2") PLN</span>
                                        }
                                    }
                                </td>

                                <td class="align-middle text-center">
                                    <div class="price-row-block">
                                        @if (item.PriceChange.HasValue && item.PriceChange.Value != 0 && item.Status != AutomationCalculationStatus.Blocked)
                                        {
                                            @if (item.PriceChange.Value < 0)
                                            {
                                                <span class="price-main-style text-success" style="display: inline-flex; align-items: center;">
                                                    <i class="fas fa-arrow-down" style="margin-right: 5px; font-weight: 900; font-size: 0.8em;"></i>
                                                    @Math.Abs(item.PriceChange.Value).ToString("F2") PLN
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="price-main-style text-danger" style="display: inline-flex; align-items: center;">
                                                    <i class="fas fa-arrow-up" style="margin-right: 5px; font-weight: 900; font-size: 0.8em;"></i>
                                                    @item.PriceChange.Value.ToString("F2") PLN
                                                </span>
                                            }
                                        }
                                        else if (item.Status == AutomationCalculationStatus.TargetMaintained)
                                        {
                                            <span class="price-main-style" style="display: inline-flex; align-items: center; color: rgba(13, 110, 253, 0.7);">
                                                <i class="no-change-icon-turquoise" style="font-style:normal;"></i>
                                                Brak zmian
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="price-main-style" style="color:#6C757D;">Blokada</span>
                                        }
                                    </div>
                                    <div class="column-flex-min-gap">
                                        @if (Model.SourceType == AutomationSourceType.Marketplace)
                                        {
                                            <div class="rank-row">
                                                <img src="/images/AllegroIcon.png" alt="Allegro" class="rank-icon">
                                                <span class="text-muted">@item.CurrentRankingAllegro</span>
                                                <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                <span class="text-muted">@item.NewRankingAllegro</span>
                                            </div>
                                        }
                                        else
                                        {
                                            @if (!string.IsNullOrEmpty(item.CurrentRankingGoogle) && item.CurrentRankingGoogle != "-")
                                            {
                                                <div class="rank-row">
                                                    <img src="/images/GoogleShopping.png" alt="Google" class="rank-icon">
                                                    <span class="text-muted">@item.CurrentRankingGoogle</span>
                                                    @if (!string.IsNullOrEmpty(item.NewRankingGoogle))
                                                    {
                                                        <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                        <span class="text-muted">@item.NewRankingGoogle</span>
                                                    }
                                                </div>
                                            }

                                            @if (!string.IsNullOrEmpty(item.CurrentRankingCeneo) && item.CurrentRankingCeneo != "-")
                                            {
                                                <div class="rank-row">
                                                    <img src="/images/Ceneo.png" alt="Ceneo" class="rank-icon">
                                                    <span class="text-muted">@item.CurrentRankingCeneo</span>
                                                    @if (!string.IsNullOrEmpty(item.NewRankingCeneo))
                                                    {
                                                        <i class="fas fa-arrow-right fa-xs text-gray-400 mx-1"></i>
                                                        <span class="text-muted">@item.NewRankingCeneo</span>
                                                    }
                                                </div>
                                            }

                                            @if ((string.IsNullOrEmpty(item.CurrentRankingGoogle) || item.CurrentRankingGoogle == "-") &&
                                                                                (string.IsNullOrEmpty(item.CurrentRankingCeneo) || item.CurrentRankingCeneo == "-"))
                                            {
                                                <span class="text-xs text-gray-400">-</span>
                                            }
                                        }
                                    </div>
                                </td>

                                <td class="align-middle text-right bg-light border-left-primary">
                                    <div class="d-flex flex-column" style="width:100%;">
                                        <div class="price-row-space">
                                            @if (item.Status == AutomationCalculationStatus.Blocked)
                                            {
                                                <div class="price-main-style" style="color:#6C757D;">
                                                    @(item.SuggestedPrice?.ToString("F2") ?? "-") PLN
                                                </div>
                                            }
                                            else
                                            {
                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="price-main-style @(item.IsMarginWarning ? "text-warning" : "text-success")">
                                                        @(item.SuggestedPrice.HasValue? item.SuggestedPrice.Value.ToString("F2") : "-") PLN
                                                    </span>
                                                    @if (item.IsMissingPlatformWarning)
                                                    {
                                                        <span class="text-warning"
                                                              style="cursor: help; font-size: 14px;"
                                                              data-toggle="tooltip"
                                                              data-html="true"
                                                              title="Uwaga! Twoja oferta nie jest widoczna na platformie @item.MissingPlatformName, gdzie znajduje się Twój rywal. Cena została wyliczona na podstawie danych z innego źródła.">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                        </span>
                                                    }
                                                    @if (item.IsSuggestedDifferentFromUpdated)
                                                    {
                                                        <span class="text-warning"
                                                              style="cursor: help; font-size: 14px;"
                                                              data-toggle="tooltip"
                                                              data-html="true"
                                                              title="Uwaga! Aktualnie wyliczona cena różni się od ceny już wgranej. Zmieniły się warunki (np. krok cenowy, preset danych) lub ustawienia reguły tego automatu cenowego.">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                        </span>
                                                    }
                                                </div>
                                            }

                                            @switch (item.Status)
                                            {
                                                case AutomationCalculationStatus.TargetMet:
                                                    <div class="status-badge status-ok">
                                                        <i class="fas fa-check mr-2"></i> Cel Osiągnięty
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.TargetMaintained:
                                                    <div class="status-badge status-maintained">
                                                        <i class="fas fa-check-circle mr-2"></i> Cel Utrzymany
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.PriceLimited:
                                                    <div class="status-badge status-limited">
                                                        <i class="fas fa-filter mr-2"></i> Limit Ceny
                                                    </div>
                                                    break;
                                                case AutomationCalculationStatus.Blocked:
                                                    <div class="status-badge status-blocked">
                                                        <i class="fas fa-times mr-2"></i> @item.BlockReason
                                                    </div>
                                                    break;
                                                default:
                                                    <span class="badge badge-light border px-3 py-2">Brak danych</span>
                                                    break;
                                            }
                                        </div>
                                        <div class="small text-muted ">@Model.StoreName</div>

                                        @{

                                            bool showUpdatedCommission = item.IsAlreadyUpdated && item.UpdatedCommissionAmount.HasValue;

                                            decimal? commissionToDisplay = showUpdatedCommission ? item.UpdatedCommissionAmount : item.CommissionAmount;

                                            decimal? salesPriceForCalc = item.UpdatedPrice ?? item.SuggestedPrice;

                                            decimal? finalMarkupAmount = item.MarkupAmount;
                                            decimal? finalMarkupPercent = item.MarkupPercent;

                                            if (salesPriceForCalc.HasValue && item.PurchasePrice.HasValue && item.PurchasePrice.Value > 0)
                                            {

                                                decimal commissionCost = (item.IsCommissionIncluded && commissionToDisplay.HasValue) ? commissionToDisplay.Value : 0;

                                                finalMarkupAmount = salesPriceForCalc.Value - item.PurchasePrice.Value - commissionCost;

                                                finalMarkupPercent = (finalMarkupAmount.Value / item.PurchasePrice.Value) * 100;
                                            }
                                        }
                                        @if (commissionToDisplay.HasValue)
                                        {
                                            <div class="Commission-stack" title="@(showUpdatedCommission ? "To jest potwierdzona prowizja po aktualizacji ceny" : "Szacowana prowizja dla obecnej ceny")">
                                                <span class="commission-stack-badge"
                                                      style="@(showUpdatedCommission ? "background-color:#1cc88a; color:white;" : "")">
                                                    @(showUpdatedCommission ? "Prowizja" : "Prowizja")
                                                </span>
                                                <p>
                                                    @commissionToDisplay.Value.ToString("F2") PLN

                                                    @if (item.IsCommissionIncluded)
                                                    {
                                                        @if (showUpdatedCommission)
                                                        {
                                                            <span style="font-weight: 400; color: #1cc88a;"> | akt. uwzg.</span>
                                                        }
                                                        else
                                                        {
                                                            <span style="font-weight: 400; color: #555;"> | uwzg.</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        @if (showUpdatedCommission)
                                                        {
                                                            <span style="font-weight: 400; color: #1cc88a;"> | akt. nieuwzg.</span>
                                                        }
                                                        else
                                                        {
                                                            <span style="font-weight: 400; color: #555"> | nieuwzg.</span>
                                                        }
                                                    }
                                                </p>
                                            </div>
                                        }
                                        @if (finalMarkupAmount.HasValue && finalMarkupPercent.HasValue)
                                        {
                                            <div class="price-box-diff-margin-ib @(finalMarkupAmount.Value > 0 ? "price-box-diff-margin-ib-positive" : "price-box-diff-margin-ib-negative")" style="margin-top: 4px; width: 100%;">
                                                <span class="price-badge @(finalMarkupAmount.Value > 0 ? "price-badge-positive" : "price-badge-negative")">Narzut</span>
                                                <p>@finalMarkupAmount.Value.ToString("F2") PLN (@finalMarkupPercent.Value.ToString("F2")%)</p>
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td class="align-middle text-center">
                                    <div class="d-flex flex-column align-items-center" style="gap: 4px;">

                                        @if (item.IsAlreadyUpdated)
                                        {
                                      
                                            <div class="status-box-dashed status-dashed-success" title="Cena wgrana: @(item.UpdateDate?.ToString("dd.MM HH:mm") ?? "-")">
                                                <i class="fas fa-check mr-1"></i> WGRANO
                                            </div>

                                         
                                            @if (item.UpdateDate.HasValue)
                                            {
                                                <div style="font-size: 10px; color: #858796; line-height: 1.1;">
                                                    @item.UpdateDate.Value.ToString("dd.MM")<br>
                                                    @item.UpdateDate.Value.ToString("HH:mm")
                                                </div>
                                            }

                                         
                                            @if (item.UpdatedPrice.HasValue)
                                            {
                                                <div style="font-size: 11px; color: #1cc88a; font-weight: 700; margin-top: 2px;">
                                                    @item.UpdatedPrice.Value.ToString("F2") PLN
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                          
                                            @if (item.Status != AutomationCalculationStatus.Blocked && item.SuggestedPrice.HasValue)
                                            {
                                                <div class="status-box-dashed status-dashed-danger">
                                                    <i class="fas fa-times mr-1"></i> NIE WGRANO
                                                </div>
                                                <span class="text-xs text-gray-400">Oczekuje</span>
                                            }
                                            else
                                            {
                                              
                                                <div class="status-box-dashed status-dashed-secondary">
                                                    <i class="fas fa-ban mr-1"></i> BLOKADA
                                                </div>
                                            }
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_MassAction.cshtml")
@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>

    <script>
        const storeId = @Model.StoreId;
        const currentRuleId = @Model.RuleId;

        const isAllegroContext = '@(Model.SourceType == AutomationSourceType.Marketplace)' === 'True';
        const sourceTypeInt = isAllegroContext ? 1 : 0;

        let selectedProductIds = new Set();
        let selectedProductNames = new Map();
        let selectedProductIdentifiers = new Map();

        function showNoAccessAlert() {
            alert('@Html.Raw(noAccessMessage)');
        }

        function showLoading() { $('#loadingOverlay').css('display', 'flex'); }
        function hideLoading() { $('#loadingOverlay').hide(); }

        function updateCounter() {

            const count = selectedProductIds.size;
            $('#selectedProductsCounter').text(`Wybrano: ${count}`);

            const modalCounter = document.getElementById('selectedProductsModalCounter');
            if (modalCounter) modalCounter.textContent = count;

            const automationCount = document.getElementById('automationProductCountDisplay');
            if (automationCount) automationCount.textContent = count;
        }

              function updateBtnState(btn, isSelected) {
            if (isSelected) {
                btn.text('Wybrano');
                btn.addClass('selected');
            } else {
                btn.text('Zaznacz');
                btn.removeClass('selected');
            }
        }

        function updateVisibleProductSelectionButtons() {
            $('.select-product-btn').each(function() {
                const btn = $(this);
                const pid = btn.data('product-id').toString();
                if (selectedProductIds.has(pid)) {
                    updateBtnState(btn, true);
                } else {
                    updateBtnState(btn, false);
                }
            });
        }

        function renderSelectedList() {
            const container = document.getElementById('selectedProductsList');
            container.innerHTML = '';

            if (selectedProductIds.size === 0) {
                container.innerHTML = '<div class="alert alert-info text-center">Nie zaznaczono żadnych produktów.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table-orders';
            table.innerHTML = `<thead><tr><th style="width: 70%;">Nazwa Produktu</th><th>ID/EAN</th><th class="text-center">Akcja</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            selectedProductIds.forEach(productId => {
                const name = selectedProductNames.get(productId) || '---';

                const identifier = selectedProductIdentifiers.get(productId) || '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${name}</td>
                  <td>${identifier}</td>
                  <td class="text-center align-middle">
                      <button class="btn btn-danger btn-sm remove-selection-btn" data-product-id="${productId}" title="Usuń z zaznaczonych" style="padding: 2px 6px;">
                          <i class="fa-solid fa-trash-can"></i>
                      </button>
                  </td>`;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function renderAutomationRulesInModal(rules, totalSelected) {
            console.log("Renderowanie reguł...", rules);
            const container = document.getElementById('automationRulesListContainer');
            if (!container) return;

            container.innerHTML = '';

            const totalAssignedInSelection = rules ? rules.reduce((sum, r) => sum + r.matchingCount, 0) : 0;
            const totalUnassignedInSelection = totalSelected - totalAssignedInSelection;

            const statsHeader = document.createElement('div');
            statsHeader.style.cssText = `
                background-color: #f8f9fa; border: 1px solid #e3e6f0; border-radius: 8px;
                padding: 15px; margin-bottom: 20px; display: flex;
                justify-content: space-around; align-items: center; text-align: center;
            `;

            statsHeader.innerHTML = `
                <div>
                    <div style="font-size: 11px; color: #858796; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Łącznie zaznaczone</div>
                    <div style="font-size: 20px; font-weight: 700; color: #5a5c69;">${totalSelected}</div>
                </div>
                <div style="border-left: 1px solid #e3e6f0; height: 30px;"></div>
                <div>
                    <div style="font-size: 11px; color: #858796; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Przypisane do reguły</div>
                    <div style="font-size: 20px; font-weight: 700; color: #5a5c69;">${totalAssignedInSelection}</div>
                </div>
                <div style="border-left: 1px solid #e3e6f0; height: 30px;"></div>
                <div>
                    <div style="font-size: 11px; color: #e74a3b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Nieprzypisane</div>
                    <div style="font-size: 20px; font-weight: 700; color: #e74a3b;">${Math.max(0, totalUnassignedInSelection)}</div>
                </div>
            `;
            container.appendChild(statsHeader);

            const unassignDiv = document.createElement('div');
            const hasAssignments = totalAssignedInSelection > 0;

            unassignDiv.className = 'automation-rule-item';
            unassignDiv.style.cssText = `
                border: 1px dashed ${hasAssignments ? '#e74a3b' : '#ccc'};
                border-radius: 8px; padding: 10px 15px;
                cursor: ${hasAssignments ? 'pointer' : 'default'};
                background-color: #fff;
                display: flex; justify-content: space-between; align-items: center;
                transition: background-color 0.2s; margin-bottom: 20px; opacity: ${hasAssignments ? '1' : '0.6'};
            `;

            if (hasAssignments) {
                unassignDiv.onmouseover = () => { unassignDiv.style.backgroundColor = '#fff5f5'; };
                unassignDiv.onmouseout = () => { unassignDiv.style.backgroundColor = '#fff'; };
                unassignDiv.addEventListener('click', () => {
                    confirmAndUnassignRules();
                });
            }

            unassignDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="width:6px; height:45px; background-color:${hasAssignments ? '#e74a3b' : '#ccc'}; border-radius:3px;"></div>
                    <div>
                        <div style="font-weight:600; font-size:15px; color:${hasAssignments ? '#e74a3b' : '#888'};">Brak Automatyzacji (Odepnij)</div>
                        <div style="font-size:13px; color:#666; margin-top:2px;">
                            ${hasAssignments ? `Odepnij <strong>${totalAssignedInSelection}</strong> zaznaczonych produktów od ich obecnych reguł.` : 'Żaden z zaznaczonych produktów nie jest przypisany do reguły.'}
                        </div>
                    </div>
                </div>
                  <button class="Button-Page-Small-r" type="button" style="pointer-events:none; ${!hasAssignments ? 'background-color:#ccc; border-color:#ccc;' : ''}">Odepnij</button>
            `;
            container.appendChild(unassignDiv);

            if (!rules || rules.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.innerHTML = `<div class="alert alert-warning" style="text-align:center;">Brak zdefiniowanych innych reguł.</div>`;
                container.appendChild(emptyDiv);
                return;
            }

            rules.sort((a, b) => a.name.localeCompare(b.name, 'pl', { sensitivity: 'base' }));

            rules.forEach(rule => {

                const statusColor = rule.isActive ? '#1cc88a' : '#e74a3b';
                const statusText = rule.isActive ? 'Aktywna' : 'Nieaktywna';

                const isCompetitiveness = rule.strategyMode === 0;
                const strategyIcon = isCompetitiveness ? '<i class="fa-solid fa-bolt" style="color:#888;"></i>' : '<i class="fa-solid fa-dollar-sign" style="color:#888;"></i>';
                const strategyName = isCompetitiveness ? "Lider Rynku" : "Rentowność";

                const globalTotalInRule = rule.totalCount;
                const selectedAlreadyInRule = rule.matchingCount;
                const toBeAdded = totalSelected - selectedAlreadyInRule;

                let backgroundStyle = selectedAlreadyInRule > 0 ? '#fcfcfc' : '#fff';
                let borderStyle = '#e3e6f0';

                const div = document.createElement('div');
                div.className = 'automation-rule-item';
                div.style.cssText = `
                    border: 1px solid ${borderStyle}; border-radius: 8px; padding: 12px 15px;
                    cursor: pointer; background: ${backgroundStyle};
                    display: flex; justify-content: space-between; align-items: center;
                    transition: background-color 0.2s, border-color 0.2s; margin-bottom: 10px;
                `;

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; flex-grow: 1;">
                        <div style="width:6px; height:45px; background-color:${rule.colorHex}; border-radius:3px; flex-shrink: 0;"></div>
                        <div style="flex-grow: 1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600; font-size:16px; color:#333;">${rule.name}</div>
                                <div style="font-size:12px; color:#888; display:flex; align-items:center; gap:8px;">
                                    <span style="display:flex; align-items:center; gap:4px;">${strategyIcon} ${strategyName}</span>
                                    <span style="color:#e3e6f0;">|</span>
                                    <span style="color:${statusColor}; font-weight:500; display:flex; align-items:center; gap:4px;"><i class="fa-solid fa-circle" style="font-size:6px;"></i> ${statusText}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap: 15px; margin-top:6px; font-size:13px; color:#666; align-items: center; flex-wrap: wrap;">
                                <span title="Całkowita liczba produktów w tej regule"><i class="fa-solid fa-database" style="color:#999; margin-right:4px;"></i> Razem: <strong>${globalTotalInRule}</strong></span>
                                <span style="color:#e3e6f0;">|</span>
                                <span title="Ile z zaznaczonych jest tutaj"><i class="fa-solid fa-check-double" style="color:#999; margin-right:4px;"></i> Wybranych: <strong>${selectedAlreadyInRule}</strong></span>
                                <span style="color:#e3e6f0;">|</span>
                                <span title="Ile zostanie dodanych">Zostanie dodanych: <strong style="color:#1cc88a;">+${toBeAdded}</strong></span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-left: 20px;">
                        <button class="Button-Page-Small-bl assign-rule-btn" type="button" style="pointer-events:none; white-space:nowrap; padding: 5px 15px;">Wybierz</button>
                    </div>
                `;

                div.addEventListener('click', () => {
                    confirmAndAssignRule(rule.id, rule.name);
                });

                container.appendChild(div);
            });
        }

        function confirmAndAssignRule(targetRuleId, ruleName) {
            if (!confirm(`Czy na pewno chcesz przypisać ${selectedProductIds.size} produktów do grupy "${ruleName}"?\n\nJeśli produkty były w innych grupach, zostaną przeniesione.`)) {
                return;
            }
            executeAutomationAction('/AutomationRules/AssignProducts', { RuleId: targetRuleId });
        }

        function confirmAndUnassignRules() {
            if (!confirm(`Czy na pewno chcesz usunąć przypisanie do reguł automatyzacji dla ${selectedProductIds.size} produktów?`)) {
                return;
            }
            executeAutomationAction('/AutomationRules/UnassignProducts', {});
        }

        function executeAutomationAction(url, extraData) {
            $('#automationSelectionModal').modal('hide');
            showLoading();

            const productIdsArray = Array.from(selectedProductIds).map(id => parseInt(id));

            const payload = {
                ProductIds: productIdsArray,
                IsAllegro: isAllegroContext,
                ...extraData
            };

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    hideLoading();
                    alert(res.message || 'Operacja zakończona sukcesem.');

                    location.reload();
                },
                error: function(xhr) {
                    hideLoading();
                    alert('Błąd: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));

                    setTimeout(() => $('#automationSelectionModal').modal('show'), 500);
                }
            });
        }

        $(document).ready(function() {

            $(document).on('click', '.select-product-btn', function(e) {
                e.stopPropagation();
                const btn = $(this);
                const pid = btn.data('product-id').toString();
                const pname = btn.data('product-name');

                const row = btn.closest('tr');
                const identifierText = row.find('.small.text-muted').text().trim();

                if (selectedProductIds.has(pid)) {
                    selectedProductIds.delete(pid);
                    selectedProductNames.delete(pid);
                    selectedProductIdentifiers.delete(pid);
                    updateBtnState(btn, false);
                } else {
                    selectedProductIds.add(pid);
                    selectedProductNames.set(pid, pname);
                    selectedProductIdentifiers.set(pid, identifierText);
                    updateBtnState(btn, true);
                }
                updateCounter();
            });

            $('#selectAllVisibleBtn').on('click', function() {
                $('.select-product-btn').each(function() {
                    const btn = $(this);
                    const pid = btn.data('product-id').toString();
                    const pname = btn.data('product-name');
                    const row = btn.closest('tr');
                    const identifierText = row.find('.small.text-muted').text().trim();

                    if (!selectedProductIds.has(pid)) {
                        selectedProductIds.add(pid);
                        selectedProductNames.set(pid, pname);
                        selectedProductIdentifiers.set(pid, identifierText);
                        updateBtnState(btn, true);
                    }
                });
                updateCounter();
            });

            $('#deselectAllVisibleBtn').on('click', function() {
                $('.select-product-btn').each(function() {
                    const btn = $(this);
                    const pid = btn.data('product-id').toString();

                    if (selectedProductIds.has(pid)) {
                        selectedProductIds.delete(pid);
                        selectedProductNames.delete(pid);
                        selectedProductIdentifiers.delete(pid);
                        updateBtnState(btn, false);
                    }
                });
                updateCounter();
            });

            $('#showSelectedProductsBtn').on('click', function() {
                if (selectedProductIds.size === 0) {
                    alert('Nie zaznaczono żadnych produktów.');
                    return;
                }
                renderSelectedList();
                $('#selectedProductsModal').modal('show');
            });

            $(document).on('click', '.remove-selection-btn', function(e) {
                e.stopPropagation();
                const pid = $(this).data('product-id').toString();
                selectedProductIds.delete(pid);
                selectedProductNames.delete(pid);
                selectedProductIdentifiers.delete(pid);

                const mainBtn = $(`.select-product-btn[data-product-id="${pid}"]`);
                if(mainBtn.length) updateBtnState(mainBtn, false);

                updateCounter();
                renderSelectedList();
            });

            $(document).on('click', '#openBulkAutomationModalBtn', function() {
                if (selectedProductIds.size === 0) {
                    alert('Nie zaznaczono żadnych produktów.');
                    return;
                }

                $('#selectedProductsModal').modal('hide');
                showLoading();

                const productIdsArray = Array.from(selectedProductIds).map(id => parseInt(id));

                fetch(`/AutomationRules/GetRulesStatusForProducts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        StoreId: storeId,
                        SourceType: sourceTypeInt,
                        IsAllegro: isAllegroContext,
                        ProductIds: productIdsArray
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Błąd sieci");
                    return response.json();
                })
                .then(rules => {
                    renderAutomationRulesInModal(rules, selectedProductIds.size);
                    hideLoading();
                    $('#automationSelectionModal').modal('show');
                })
                .catch(error => {
                    console.error('Błąd pobierania reguł:', error);
                    hideLoading();
                    alert('Błąd komunikacji z serwerem.');

                    $('#selectedProductsModal').modal('show');
                });
            });

            $(document).on('click', '#openBulkFlagModalBtn', function() {
                alert("Zarządzanie flagami dla tego widoku zostanie dodane wkrótce.");
            });

            $(document).on('click', '.edit-btn', function(e) {
                e.preventDefault(); e.stopPropagation();
                var wrapper = $(this).closest('.purchase-wrapper');
                $('.edit-mode').addClass('d-none'); $('.display-mode').removeClass('d-none');
                wrapper.find('.display-mode').addClass('d-none'); wrapper.find('.edit-mode').removeClass('d-none');
                var inp = wrapper.find('input'); inp.val(inp.val()); inp.focus();
            });
            $(document).on('click', '.cancel-btn', function(e) {
                e.preventDefault();
                $(this).closest('.purchase-wrapper').find('.edit-mode').addClass('d-none').end().find('.display-mode').removeClass('d-none');
            });
            $(document).on('click', '.save-btn', function(e) {
                e.preventDefault();
                var wrap = $(this).closest('.purchase-wrapper');
                var val = wrap.find('input').val().replace(',', '.');
                if(val==='' || isNaN(val) || parseFloat(val)<0) { alert("Błędna cena."); return; }
                sendPriceUpdate(wrap, parseFloat(val), $(this));
            });
            $(document).on('click', '.delete-btn-inner', function(e) {
                e.preventDefault();
                if(confirm("Usunąć cenę zakupu?")) sendPriceUpdate($(this).closest('.purchase-wrapper'), null, $(this));
            });
            $(document).on('keypress', '.price-edit-input', function(e) {
                if(e.which == 13) { e.preventDefault(); $(this).closest('.edit-mode').find('.save-btn').click(); }
            });
        });

        function sendPriceUpdate(wrapper, priceValue, btnElement) {
            var productId = wrapper.data('id');
            var storeId = wrapper.data('store-id');
            var isMktStr = String(wrapper.data('is-marketplace')).toLowerCase();
            var isMarketplaceBool = (isMktStr === 'true');

            var token = $('input[name="__RequestVerificationToken"]').val();
            if (!token) { alert("Brak tokenu CSRF."); return; }

            var url = isMarketplaceBool
                ? '@Url.Action("UpdateAllegroPurchasePrice", "AllegroProduct")?storeId=' + storeId
                : '@Url.Action("UpdatePurchasePrice", "Product")?storeId=' + storeId;

            var payload = isMarketplaceBool
                ? { AllegroProductId: parseInt(productId), NewPrice: priceValue }
                : { ProductId: parseInt(productId), NewPrice: priceValue };

            var originalContent = btnElement.html();
            btnElement.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                headers: { 'RequestVerificationToken': token },
                data: JSON.stringify(payload),
                success: function(response) {
                    if(response.success) location.reload();
                    else { alert("Błąd: " + response.message); btnElement.html(originalContent).prop('disabled', false); }
                },
                error: function(xhr) {
                    alert("Błąd serwera.");
                    btnElement.html(originalContent).prop('disabled', false);
                }
            });
        }

        function executeAutomation() {
            if (!confirm("Czy na pewno chcesz wykonać automatyzację?")) { return; }
            var btn = $(event.target).closest('button');
            var originalText = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Przetwarzanie...');

            $.ajax({
                url: '@Url.Action("ExecuteAutomation", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: currentRuleId }),
                success: function(r) {
                    if(r.count === 0) alert("Wykonano, ale brak zmian do aktualizacji.");
                    else alert("Sukces! Zaktualizowano " + r.count + " ofert.");
                    location.reload();
                },
                error: function(xhr) {
                    alert("Błąd: " + (xhr.responseText || xhr.statusText));
                    btn.prop('disabled', false).html(originalText);
                }
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>



    <script>
        // =============================================
        // ZMIENNE GLOBALNE I KONFIGURACJA
        // =============================================
        var chartEff = null;
        var chartDyn = null;
        var chartSales = null;
        var chartBadges = null;
        var chartPosition = null;
        var currentLimit = 7;
        var currentMode = 'execution';

        const isMarketplaceContext = '@(Model.SourceType == AutomationSourceType.Marketplace)' === 'True';
        const totalProductsInRuleNow = parseInt('@Model.TotalProducts') || 0;
                const loaderConfig = {
            text: 'Ładowanie...',   // Twój tekst
            color: '#000000',       // Kolor "kręciołka" (czarny)
            textColor: '#000000',   // Kolor tekstu (czarny)
            maskColor: 'rgba(255, 255, 255, 0.8)', // Białe tło z lekką przezroczystością
            zlevel: 0
        };
        // =============================================
        // HELPERY DO TOOLTIPÓW (UJEDNOLICENIE)
        // =============================================

        // 1. Nagłówek z datą
        function tooltipDateHeader(date) {
            return '<div style="font-weight:700; font-size:13px; margin-bottom:8px; color:#333; border-bottom: 1px solid #f0f0f0; padding-bottom:6px;">'
                 + '<i class="fas fa-calendar-alt" style="margin-right:6px; color:#858796;"></i>' + date + '</div>';
        }

        // 2. Nagłówek sekcji (małe litery, uppercase)
        function tooltipSectionHeader(title) {
            return '<div style="font-size:10px; color:#858796; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; margin-top:6px;">' + title + '</div>';
        }

        // 3. Standardowy wiersz danych: Kropka | Nazwa | Wartość | Jednostka | (opcjonalne sub-info)
        function tooltipRow(marker, label, value, unit, bold, subValue) {
            var style = bold ? 'font-weight:700; color:#333;' : 'font-weight:600; color:#555;';
            var subHtml = subValue ? '<span style="color:#999; font-weight:400; font-size:10px; margin-left:4px;">' + subValue + '</span>' : '';

            return '<div style="display:flex; justify-content:space-between; align-items:center; padding:2px 0;">'
                 + '  <span style="font-size:12px;">' + (marker || '') + ' ' + label + '</span>'
                 + '  <span style="' + style + '">' + value + (unit || '') + subHtml + '</span>'
                 + '</div>';
        }

        // 4. Szary separator
        function tooltipSeparator() {
            return '<div style="border-top:1px solid #f0f0f0; margin:8px 0;"></div>';
        }

        // 5. Pasek pokrycia danych (zielony/żółty/czerwony)
        function buildCoverageBar(covered, total, label) {
            if (!total || total === 0) return '';
            var pct = Math.round((covered / total) * 100);
            // Kolory: >90% zielony, >60% żółty, poniżej czerwony
            var barColor = pct >= 90 ? '#1cc88a' : pct >= 60 ? '#f6c23e' : '#e74a3b';
            // Tło paska (jaśniejsza wersja koloru)
            var barBg = pct >= 90 ? 'rgba(28,200,138,0.15)' : pct >= 60 ? 'rgba(246,194,62,0.15)' : 'rgba(231,74,59,0.15)';

            return ''
                + '<div style="margin-top:8px;">'
                + '  <div style="font-size:10px; color:#999; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:2px;">' + label + '</div>'
                + '  <div style="display:flex; align-items:center; gap:8px;">'
                + '    <div style="flex:1; height:6px; background:#e3e3e3; border-radius:3px; overflow:hidden;">'
                + '      <div style="width:' + pct + '%; height:100%; background:' + barColor + '; border-radius:3px;"></div>'
                + '    </div>'
                + '    <span style="font-size:11px; font-weight:700; color:' + barColor + ';">' + pct + '%</span>'
                + '  </div>'
                + '  <div style="text-align:right; font-size:10px; color:#bbb; margin-top:1px;">' + covered + ' z ' + total + ' produktów</div>'
                + '</div>';
        }

        function switchChartMode(mode) {
            currentMode = mode;

            // 1. Resetujemy klasę 'active' na przyciskach
            $('#viewModeExec, #viewModeSales, #viewModeBadges, #viewModePosition')
                .removeClass('active');

            // 2. Ukrywamy wszystkie kontenery
            $('#executionChartsContainer, #salesChartContainer, #badgeChartContainer, #positionChartContainer').hide();

            // 3. Logika włączania
            if (mode === 'execution') {
                $('#viewModeExec').addClass('active');
                $('#executionChartsContainer').css('display', 'flex');

                if (chartEff) chartEff.resize();
                if (chartDyn) chartDyn.resize();

                // --- TO JEST TA ZMIANA ---
                // Wymuszamy załadowanie danych dla aktualnie wybranego okresu (currentLimit)
                loadHistoryData(currentLimit);
                // -------------------------
            }
            else if (mode === 'sales') {
                $('#viewModeSales').addClass('active');
                $('#salesChartContainer').show();
                if (!chartSales) chartSales = echarts.init(document.getElementById('chartSales'));
                chartSales.resize();
                loadSalesHistoryData(currentLimit);
            }
            else if (mode === 'badges') {
                $('#viewModeBadges').addClass('active');
                $('#badgeChartContainer').show();
                if (!chartBadges) chartBadges = echarts.init(document.getElementById('chartBadges'));
                chartBadges.resize();
                loadBadgeHistoryData(currentLimit);
            }
            else if (mode === 'position') {
                $('#viewModePosition').addClass('active');
                $('#positionChartContainer').show();
                if (!chartPosition) chartPosition = echarts.init(document.getElementById('chartPosition'));
                chartPosition.resize();
                loadPricePositionHistoryData(currentLimit);
            }
        }

        function showChartLoading() {
            if (currentMode === 'execution') {
                if (chartEff) chartEff.showLoading('default', loaderConfig);
                if (chartDyn) chartDyn.showLoading('default', loaderConfig);
            } else if (currentMode === 'sales') {
                if (chartSales) chartSales.showLoading('default', loaderConfig);
            } else if (currentMode === 'badges') {
                if (chartBadges) chartBadges.showLoading('default', loaderConfig);
            } else if (currentMode === 'position') {
                if (chartPosition) chartPosition.showLoading('default', loaderConfig);
            }
        }

        function hideChartLoading() {
            if (chartEff) chartEff.hideLoading();
            if (chartDyn) chartDyn.hideLoading();
            if (chartSales) chartSales.hideLoading();
            if (chartBadges) chartBadges.hideLoading();
            if (chartPosition) chartPosition.hideLoading();
        }

        function loadHistoryData(limit) {
            if (currentMode === 'sales') { loadSalesHistoryData(limit); return; }
            if (currentMode === 'badges') { loadBadgeHistoryData(limit); return; }
            if (currentMode === 'position') { loadPricePositionHistoryData(limit); return; }

            showChartLoading();
            $.ajax({
                url: '@Url.Action("GetAutomationHistory", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: parseInt(@Model.RuleId), Limit: limit }),
                success: function (data) {
                    hideChartLoading();
                    renderEffectivenessChart(data);
                    renderDynamicsChart(data);
                },
                error: function (xhr) { hideChartLoading(); console.error(xhr); }
            });
        }

        function loadSalesHistoryData(limit) {
            if (!chartSales) chartSales = echarts.init(document.getElementById('chartSales'));
            chartSales.showLoading('default', loaderConfig);

            $.ajax({
                url: '@Url.Action("GetAutomationSalesHistory", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: parseInt(@Model.RuleId), Limit: limit }),
                success: function (data) {
                    chartSales.hideLoading();
                    renderSalesChart(data);
                },
                error: function (xhr) {
                    chartSales.hideLoading();
                    console.error("Błąd Sales:", xhr.responseText);
                }
            });
        }

        function loadBadgeHistoryData(limit) {
            if (!chartBadges) chartBadges = echarts.init(document.getElementById('chartBadges'));
            chartBadges.showLoading('default', loaderConfig);

            $.ajax({
                url: '@Url.Action("GetAutomationBadgeHistory", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: parseInt(@Model.RuleId), Limit: limit }),
                success: function (data) {
                    chartBadges.hideLoading();
                    renderBadgeChart(data);
                },
                error: function (xhr) { chartBadges.hideLoading(); console.error(xhr); }
            });
        }

        function loadPricePositionHistoryData(limit) {
            if (!chartPosition) chartPosition = echarts.init(document.getElementById('chartPosition'));
            chartPosition.showLoading('default', loaderConfig);

            $.ajax({
                url: '@Url.Action("GetAutomationPricePositionHistory", "PriceAutomation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ RuleId: parseInt(@Model.RuleId), Limit: limit }),
                success: function (data) {
                    chartPosition.hideLoading();
                    renderPricePositionChart(data);
                },
                error: function (xhr) {
                    chartPosition.hideLoading();
                    console.error("Błąd Position:", xhr.responseText);
                }
            });
        }

        function calculateSharedMax(arrays) {
            let maxVal = 0;
            // Przeszukujemy wszystkie tablice danych
            arrays.forEach(arr => {
                if (arr && Array.isArray(arr)) {
                    let localMax = Math.max(...arr);
                    if (localMax > maxVal) maxVal = localMax;
                }
            });

            // Dodajemy 5-10% zapasu, żeby wykres nie dotykał sufitu
            // Jeśli max to 0, ustawiamy np. 10 jako domyślną skalę
            return maxVal > 0 ? Math.ceil(maxVal * 1.1) : 10;
        }

        // =============================================
        // RENDER: EFFECTIVENESS (SKUTECZNOŚĆ)
        // =============================================
        function renderEffectivenessChart(data) {
            if (!chartEff) return;
            var totalInRuleFallback = totalProductsInRuleNow;

            var option = {
                title: {
                    text: 'Skuteczność Reguły',
                    left: 'center',
                    textStyle: { fontSize: 13, fontWeight: 'bold', color: '#5a5c69' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e3e6f0',
                    borderWidth: 1,
                    textStyle: { color: '#333', fontSize: 12 },
                    padding: [12, 16],
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; min-width: 200px;',
                           // Wewnątrz funkcji renderEffectivenessChart(data) -> obiekt option -> tooltip:

                        formatter: function (params) {
                            var date = params[0].axisValueLabel;

                            var met = 0, unmet = 0;
                            params.forEach(function (item) {
                                if (item.seriesName === 'Spełnione') met = item.value;
                                if (item.seriesName === 'Niespełnione / Blokady') unmet = item.value;
                            });

                            var calculatedSum = met + unmet;
                            var pctMet = calculatedSum > 0 ? ((met / calculatedSum) * 100).toFixed(0) : 0;

                            // Budowanie HTML
                            var html = tooltipDateHeader(date);

                            html += tooltipSectionHeader('Status Wykonania');
                            html += tooltipRow(params[0]?.marker, 'Spełnione', met, '', true);
                            html += tooltipRow(params[1]?.marker, 'Niespełnione', unmet, '', false);

                            html += tooltipSeparator();

                            // Wskaźnik skuteczności (TO ZOSTAJE)
                            var effColor = pctMet >= 80 ? '#1cc88a' : pctMet >= 50 ? '#f6c23e' : '#e74a3b';
                            html += '<div style="display:flex; justify-content:space-between; align-items:center;">'
                                  + '  <span style="font-size:12px; color:#555;">Skuteczność:</span>'
                                  + '  <span style="font-size:14px; font-weight:700; color:' + effColor + ';">' + pctMet + '%</span>'
                                  + '</div>';

                            // USUNIĘTO: Pasek pokrycia danych (buildCoverageBar)

                            return html;
                        }
                },
                legend: { bottom: 0, data: ['Spełnione', 'Niespełnione / Blokady'] },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '40px', containLabel: true },
                xAxis: { type: 'category', data: data.dates, axisLabel: { fontSize: 10 } },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } } },
                       // Wewnątrz funkcji renderEffectivenessChart(data) -> obiekt option -> series:

                series: [
                    {
                        name: 'Spełnione',
                        type: 'bar',
                        stack: 'total',
                        // ZMIANA: Prosty kolor, brak zaokrągleń
                        itemStyle: {
                            color: '#00917B'
                        },
                        data: data.targetMet
                    },
                    {
                        name: 'Niespełnione / Blokady',
                        type: 'bar',
                        stack: 'total',
                        // ZMIANA: Prosty kolor, brak zaokrągleń
                        itemStyle: {
                            color: '#6C757D'
                        },
                        data: data.targetUnmet
                    }
                ]
            };
            chartEff.setOption(option, true);
        }

        // =============================================
        // RENDER: DYNAMICS (DYNAMIKA)
        // =============================================
        function renderDynamicsChart(data) {
            if (!chartDyn) return;

            var option = {
                title: {
                    text: 'Dynamika Zmian',
                    left: 'center',
                    textStyle: { fontSize: 13, fontWeight: 'bold', color: '#5a5c69' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e3e6f0',
                    borderWidth: 1,
                    textStyle: { color: '#333', fontSize: 12 },
                    padding: [12, 16],
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; min-width: 200px;',
                    formatter: function (params) {
                        var date = params[0].axisValueLabel;
                        var decreased = 0, maintained = 0, increased = 0, total = 0;

                        params.forEach(function (item) {
                            if (item.seriesName === 'Obniżki') decreased = item.value;
                            else if (item.seriesName === 'Utrzymane') maintained = item.value;
                            else if (item.seriesName === 'Podwyżki') increased = item.value;
                            else if (item.seriesName === 'Razem w regule') total = item.value;
                        });

                        var changed = decreased + increased;

                        // HTML
                        var html = tooltipDateHeader(date);

                        html += tooltipSectionHeader('Zmiany Cenowe');

                        params.forEach(function (item) {
                            if (item.seriesName !== 'Razem w regule') {
                                html += tooltipRow(item.marker, item.seriesName, item.value, '', false);
                            }
                        });

                        html += tooltipSeparator();

                        // Podsumowanie
                        html += '<div style="display:flex; justify-content:space-between; font-size:11px; color:#666;">'
                              + '  <span>Zoptymalizowano cen:</span>'
                              + '  <span style="font-weight:700;">' + changed + '</span>'
                              + '</div>';

                        // Używamy helpera paska pokrycia, ale tutaj pokrycie to 100% (wszystkie produkty w regule są analizowane)
                        // więc użyjemy go jako ładnego paska totalu
                        html += '<div style="margin-top:6px; padding-top:4px; border-top:1px dashed #eee; font-size:10px; color:#999; display:flex; justify-content:space-between;">'
                              + 'Razem produktów w regule: <strong>' + total + '</strong>'
                              + '</div>';

                        return html;
                    }
                },
                legend: { bottom: 0, data: ['Obniżki', 'Utrzymane', 'Podwyżki', 'Razem w regule'], textStyle: { fontSize: 11 } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '40px', containLabel: true },
                xAxis: { type: 'category', data: data.dates, axisLabel: { fontSize: 10 } },
                yAxis: { type: 'value', axisLabel: { fontSize: 10 }, splitLine: { lineStyle: { color: '#f0f0f0' } } },
                series: [
                    { name: 'Obniżki', type: 'bar', stack: 'total', itemStyle: { color: 'rgba(25, 135, 84, 0.85)' }, data: data.decreased },
                    { name: 'Utrzymane', type: 'bar', stack: 'total', itemStyle: { color: 'rgba(13, 110, 253, 0.7)' }, data: data.maintained },
                    { name: 'Podwyżki', type: 'bar', stack: 'total', itemStyle: { color: 'rgba(231, 74, 59, 0.85)' }, barBorderRadius: [3, 3, 0, 0], data: data.increased },
                    { name: 'Razem w regule', type: 'line', data: data.totalProducts, symbol: 'none', itemStyle: { color: '#333' }, lineStyle: { color: '#333', width: 2, type: 'dashed', opacity: 0.6 } }
                ]
            };
            chartDyn.setOption(option, true);
        }
        // =============================================
            // RENDER: SALES (SPRZEDAŻ) - BEZ "TWOJE AKTYWNE OFERTY"
            // =============================================
            function renderSalesChart(data) {
                if (!data || !chartSales) return;
                var totalInRule = data.totalProductsInRule || totalProductsInRuleNow;

                var option = {
                    title: {
                        text: 'Sprzedaż: Twoje oferty vs Cały rynek',
                        subtext: 'Dane dla ' + totalInRule + ' produktów obecnie w automacie',
                        left: 'center',
                        textStyle: { fontSize: 13, fontWeight: 'bold', color: '#5a5c69' },
                        subtextStyle: { fontSize: 11, color: '#999' }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } },
                        backgroundColor: 'rgba(255, 255, 255, 0.98)',
                        borderColor: '#e3e6f0',
                        borderWidth: 1,
                        textStyle: { color: '#333', fontSize: 12 },
                        padding: [12, 16],
                        // Zachowane min-width dla spójności z wykresem skuteczności
                        extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; min-width: 250px;',
                        formatter: function (params) {
                            var date = params[0].axisValueLabel;
                            var marketVal = 0, myVal = 0, productsWithData = 0;

                            params.forEach(function (item) {
                                if (item.seriesName === 'Cały Rynek (Katalog)') marketVal = item.value;
                                else if (item.seriesName === 'Twoja Sprzedaż') myVal = item.value;
                                else if (item.seriesName === 'Katalogi z danymi') productsWithData = item.value;
                            });

                            var html = tooltipDateHeader(date);

                            html += tooltipSectionHeader('Wolumen Sprzedaży');

                            var myMarker = params.find(p => p.seriesName === 'Twoja Sprzedaż')?.marker;
                            var marketMarker = params.find(p => p.seriesName === 'Cały Rynek (Katalog)')?.marker;

                            html += tooltipRow(myMarker, 'Twoja sprzedaż', myVal, ' szt.', true);
                            html += tooltipRow(marketMarker, 'Cały rynek', marketVal, ' szt.', false);

                            // Udział w rynku
                            var sharePercent = (marketVal > 0) ? ((myVal / marketVal) * 100).toFixed(1) + '%' : '0.0%';
                            html += '<div style="margin-top:4px; padding:4px 8px; background:rgba(255,152,0,0.1); border-radius:4px; display:flex; justify-content:space-between; align-items:center;">'
                                  + '  <span style="font-size:11px; color:#ff9800;"><i class="fas fa-chart-pie" style="margin-right:4px;"></i>Twój udział w rynku</span>'
                                  + '  <span style="font-size:13px; font-weight:700; color:#ff9800;">' + sharePercent + '</span>'
                                  + '</div>';

                            html += tooltipSeparator();

                            // Pasek pokrycia
                            html += buildCoverageBar(productsWithData, totalInRule, 'Katalogi z danymi w analizie');

                            return html;
                        }
                    },
                    legend: {
                        bottom: 0,
                        // Usunięto 'Twoje aktywne oferty' z legendy
                        data: ['Twoja Sprzedaż', 'Cały Rynek (Katalog)', 'Katalogi z danymi'],
                        textStyle: { fontSize: 11 }
                    },
                    grid: { left: '3%', right: '4%', bottom: '12%', top: '70px', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: data.dates, axisLabel: { fontSize: 10 } },
                    yAxis: [
                        { type: 'value', name: 'Sprzedaż (szt.)', position: 'left', nameTextStyle: { fontSize: 10, color: '#999' }, axisLabel: { formatter: '{value}', fontSize: 10 }, splitLine: { show: true, lineStyle: { color: '#f0f0f0' } } },
                        { type: 'value', name: 'Liczba ofert', position: 'right', minInterval: 1, nameTextStyle: { fontSize: 10, color: '#999' }, axisLine: { show: false }, axisLabel: { formatter: '{value}', color: '#999', fontSize: 10 }, splitLine: { show: false } }
                    ],
                    series: [
                        {
                            name: 'Cały Rynek (Katalog)',
                            type: 'line',
                            yAxisIndex: 0,
                            data: data.marketSales,
                            smooth: true,
                            symbol: 'none',
                            itemStyle: { color: '#000000' },
                            lineStyle: { width: 2, color: '#000000' }
                        },
                        {
                            name: 'Twoja Sprzedaż',
                            type: 'line',
                            yAxisIndex: 0,
                            data: data.mySales,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 8,
                            itemStyle: { color: '#ff9800', borderColor: '#fff', borderWidth: 2 },
                            lineStyle: { width: 3, color: '#ff9800' },
                            areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(255, 152, 0, 0.5)' }, { offset: 1, color: 'rgba(255, 152, 0, 0.03)' }]) }
                        },
                        // USUNIĘTO SERIĘ: Twoje aktywne oferty
                        {
                            name: 'Katalogi z danymi',
                            type: 'line',
                            yAxisIndex: 1,
                            data: data.productsWithDataCount,
                            smooth: false,
                            symbol: 'none',
                              itemStyle: { color: '#777777' },
                                lineStyle: { width: 1.5, color: '#777777', type: 'dotted' }
                        }
                    ]
                };
                chartSales.setOption(option, true);
            }


           function renderBadgeChart(data) {
            if (!data || !chartBadges) return;
            var totalInRule = data.totalProductsInRule || totalProductsInRuleNow;

            // --- OBLICZANIE WSPÓLNEJ SKALI (1:1) ---
            // Zbieramy wszystkie serie, aby znaleźć najwyższy punkt
            var allDataArrays = [
                data.topOfferCounts,
                data.superPriceCounts,
                data.bestPriceGuaranteeCounts,
                data.campaignCounts,
                data.subsidyCounts,
                data.coveredProductsCounts // Szara linia
            ];
            // calculateSharedMax musi być zdefiniowane w skrypcie (helper z poprzedniego kroku)
            var commonMax = calculateSharedMax(allDataArrays);
            // ---------------------------------------

            var option = {
                title: {
                    text: 'Trendy Odznak i Promocji',
                    subtext: 'Dane dla ' + totalInRule + ' produktów obecnie w automacie',
                    left: 'center',
                    textStyle: { fontSize: 13, fontWeight: 'bold', color: '#5a5c69' },
                    subtextStyle: { fontSize: 11, color: '#999' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e3e6f0',
                    borderWidth: 1,
                    padding: [12, 16],
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; min-width: 250px;',
                    formatter: function (params) {
                        var date = params[0].axisValueLabel;

                        var coveredProducts = 0;
                        var badgeValues = {};
                        params.forEach(function (item) {
                            if (item.seriesName === 'Katalogi z danymi') {
                                coveredProducts = item.value;
                            } else {
                                badgeValues[item.seriesName] = item;
                            }
                        });

                        var html = tooltipDateHeader(date);
                        html += tooltipSectionHeader('Aktywne Odznaki');

                        var badgeOrder = ['Top Oferta', 'Super Cena', 'Gwarancja Ceny', 'Kampania', 'Dopłaty'];
                        badgeOrder.forEach(function (name) {
                            var item = badgeValues[name];
                            if (item) {
                                var pctOfCovered = coveredProducts > 0 ? ((item.value / coveredProducts) * 100).toFixed(0) + '%' : '-';
                                html += tooltipRow(item.marker, name, item.value, '', false, '(' + pctOfCovered + ' ofert)');
                            }
                        });

                        html += tooltipSeparator();
                        html += buildCoverageBar(coveredProducts, totalInRule, 'Katalogi z danymi');

                        return html;
                    }
                },
                legend: {
                    bottom: 0,
                    data: ['Top Oferta', 'Super Cena', 'Gwarancja Ceny', 'Kampania', 'Dopłaty', 'Katalogi z danymi'],
                    textStyle: { fontSize: 11 }
                },
                grid: { left: '3%', right: '4%', bottom: '12%', top: '70px', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: data.dates, axisLabel: { fontSize: 10 } },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Liczba odznak',
                        // ZMIANA: Skala 1:1
                        min: 0,
                        max: commonMax,
                        minInterval: 1,
                        nameTextStyle: { fontSize: 10, color: '#999' },
                        axisLabel: { fontSize: 10 },
                        splitLine: { lineStyle: { color: '#f0f0f0' } }
                    },
                    {
                        type: 'value',
                        name: 'Liczba ofert',
                        position: 'right',
                        // ZMIANA: Skala 1:1
                        min: 0,
                        max: commonMax,
                        minInterval: 1,
                        nameTextStyle: { fontSize: 10, color: '#999' },
                        axisLine: { show: false },
                        axisLabel: { formatter: '{value}', color: '#999', fontSize: 10 },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    { name: 'Top Oferta', type: 'line', data: data.topOfferCounts, smooth: true, itemStyle: { color: '#ff9800' }, symbol: 'circle', symbolSize: 6 },
                    { name: 'Super Cena', type: 'line', data: data.superPriceCounts, smooth: true, itemStyle: { color: '#155724' }, symbol: 'circle', symbolSize: 6 },
                    { name: 'Gwarancja Ceny', type: 'line', data: data.bestPriceGuaranteeCounts, smooth: true, itemStyle: { color: '#4caf50' }, symbol: 'circle', symbolSize: 6 },
                    { name: 'Kampania', type: 'line', data: data.campaignCounts, smooth: true, itemStyle: { color: '#ffc107' }, lineStyle: { type: 'dashed' }, symbol: 'circle', symbolSize: 6 },
                    { name: 'Dopłaty', type: 'line', data: data.subsidyCounts, smooth: true, itemStyle: { color: '#1cc88a' }, lineStyle: { type: 'dotted' }, symbol: 'circle', symbolSize: 6 },
                    {
                        name: 'Katalogi z danymi',
                        type: 'line',
                        yAxisIndex: 1,
                        data: data.coveredProductsCounts,
                        smooth: false,
                        symbol: 'none',
                            itemStyle: { color: '#777777' },
                            lineStyle: { width: 1.5, color: '#777777', type: 'dotted' },
                        z: 0
                    }
                ]
            };
            chartBadges.setOption(option, true);
        }

            function renderPricePositionChart(data) {
            if (!data || !chartPosition) return;
            var totalInRule = data.totalProductsInRule || totalProductsInRuleNow;

            var colors = {
                top1Solo: '#2e59d9',
                top1ExAequo: '#1cc88a',
                pos2to3: '#f6c23e',
                pos4to5: '#fd7e14',
                pos6to10: '#e74a3b',
                pos11plus: '#852b24',
                notRanked: '#777777'
            };

            // --- OBLICZANIE WSPÓLNEJ SKALI ---
            // Zbieramy wszystkie tablice danych, które będą na wykresie
            var allDataArrays = [
                data.top1Solo,
                data.top1ExAequo,
                data.position2to3,
                data.position4to5,
                data.position6to10,
                data.position11Plus,
                data.productsWithDataCount // Nasza szara linia
            ];
            var commonMax = calculateSharedMax(allDataArrays);
            // ---------------------------------

            var option = {
                title: {
                    text: 'Pozycja Cenowa w Czasie',
                    subtext: 'Dane dla ' + totalInRule + ' produktów obecnie w automacie',
                    left: 'center',
                    textStyle: { fontSize: 13, fontWeight: 'bold', color: '#5a5c69' },
                    subtextStyle: { fontSize: 11, color: '#999' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'line', lineStyle: { color: '#999', type: 'dashed' } },
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e3e6f0',
                    borderWidth: 1,
                    padding: [12, 16],
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; max-width: 360px;',
                    formatter: function (params) {
                        var date = params[0].axisValueLabel;
                        var values = {};
                        var rankedCount = 0;

                        params.forEach(function (item) {
                            values[item.seriesName] = { val: item.value, marker: item.marker };
                            if (item.seriesName !== 'Katalogi z danymi') {
                                rankedCount += item.value;
                            }
                        });

                        var realTotal = totalInRule;

                        var html = tooltipDateHeader(date);
                        html += tooltipSectionHeader('Rozkład Pozycji');

                        var order = ['Top 1 (lider)', 'Top 1 (ex aequo)', 'Pozycja 2–3', 'Pozycja 4–5', 'Pozycja 6–10', 'Pozycja 11+'];
                        order.forEach(function (name) {
                            var item = values[name];
                            if (!item) return;
                            var pct = realTotal > 0 ? ((item.val / realTotal) * 100).toFixed(0) + '%' : '0%';
                            html += tooltipRow(item.marker, name, item.val, '', false, '(' + pct + ')');
                        });

                        html += tooltipSeparator();
                        html += buildCoverageBar(rankedCount, realTotal, 'Produkty z pozycją cenową');

                        return html;
                    }
                },
                legend: {
                    bottom: 0,
                    data: ['Top 1 (lider)', 'Top 1 (ex aequo)', 'Pozycja 2–3', 'Pozycja 4–5', 'Pozycja 6–10', 'Pozycja 11+', 'Katalogi z danymi'],
                    textStyle: { fontSize: 11 }
                },
                grid: { left: '3%', right: '4%', bottom: '14%', top: '70px', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: data.dates, axisLabel: { fontSize: 10 } },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Liczba produktów',
                        // ZMIANA: Wymuszona skala
                        min: 0,
                        max: commonMax,
                        nameTextStyle: { fontSize: 10, color: '#999' },
                        axisLabel: { fontSize: 10 },
                        splitLine: { lineStyle: { color: '#f0f0f0' } }
                    },
                    {
                        type: 'value',
                        name: 'Liczba ofert',
                        position: 'right',
                        // ZMIANA: Wymuszona identyczna skala
                        min: 0,
                        max: commonMax,
                        nameTextStyle: { fontSize: 10, color: '#999' },
                        axisLine: { show: false },
                        axisLabel: { formatter: '{value}', color: '#999', fontSize: 10 },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    { name: 'Top 1 (lider)', type: 'line', smooth: true, itemStyle: { color: colors.top1Solo }, symbol: 'circle', symbolSize: 6, width: 3, data: data.top1Solo },
                    { name: 'Top 1 (ex aequo)', type: 'line', smooth: true, itemStyle: { color: colors.top1ExAequo }, symbol: 'circle', symbolSize: 6, width: 3, data: data.top1ExAequo },
                    { name: 'Pozycja 2–3', type: 'line', smooth: true, itemStyle: { color: colors.pos2to3 }, symbol: 'circle', symbolSize: 6, width: 3, data: data.position2to3 },
                    { name: 'Pozycja 4–5', type: 'line', smooth: true, itemStyle: { color: colors.pos4to5 }, symbol: 'circle', symbolSize: 6, width: 3, data: data.position4to5 },
                    { name: 'Pozycja 6–10', type: 'line', smooth: true, itemStyle: { color: colors.pos6to10 }, symbol: 'circle', symbolSize: 6, width: 3, data: data.position6to10 },
                    { name: 'Pozycja 11+', type: 'line', smooth: true, itemStyle: { color: colors.pos11plus }, symbol: 'circle', symbolSize: 6, width: 3, data: data.position11Plus },
                    {
                        name: 'Katalogi z danymi',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: false,
                        itemStyle: { color: colors.notRanked },
                        lineStyle: { width: 1.5, color: colors.notRanked, type: 'dotted' },
                        symbol: 'none',
                        data: data.productsWithDataCount
                    }
                ]
            };
            chartPosition.setOption(option, true);
        }
        // =============================================
        // INIT
        // =============================================
        $(document).ready(function () {
            var elemEff = document.getElementById('chartEffectiveness');
            var elemDyn = document.getElementById('chartDynamics');

            if (elemEff && elemDyn) {
                chartEff = echarts.init(elemEff);
                chartDyn = echarts.init(elemDyn);
                loadHistoryData(currentLimit);
            }

            $('.history-btn').click(function () {
                $('.history-btn').removeClass('active');
                $(this).addClass('active');
                currentLimit = $(this).data('days');

                if (currentMode === 'badges') loadBadgeHistoryData(currentLimit);
                else if (currentMode === 'sales') loadSalesHistoryData(currentLimit);
                else if (currentMode === 'position') loadPricePositionHistoryData(currentLimit);
                else loadHistoryData(currentLimit);
            });

            window.addEventListener('resize', function () {
                if (chartEff) chartEff.resize();
                if (chartDyn) chartDyn.resize();
                if (chartSales) chartSales.resize();
                if (chartBadges) chartBadges.resize();
                if (chartPosition) chartPosition.resize();
            });
        });
    </script>

    <script>
        // =============================================
        // TABLE SEARCH LOGIC
        // =============================================
        document.addEventListener("DOMContentLoaded", function () {

            const searchInput = document.getElementById('productSearch');
            const tableBody = document.querySelector('#automationTable tbody');

            let tableRows = [];

            function initTableData() {
                const rows = tableBody.querySelectorAll('tr');
                tableRows = Array.from(rows).map(row => {
                    const nameContainer = row.querySelector('.product-name-wrap');
                    const codeContainer = row.querySelector('.small.text-muted');

                    return {
                        element: row,
                        nameEl: nameContainer,
                        codeEl: codeContainer,
                        originalNameHtml: nameContainer ? nameContainer.innerHTML : '',
                        originalCodeHtml: codeContainer ? codeContainer.innerHTML : '',
                        searchText: ((nameContainer ? nameContainer.textContent : '') + ' ' +
                                     (codeContainer ? codeContainer.textContent : '')).toLowerCase().replace(/\s+/g, ' ')
                    };
                });
            }

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function highlightMatches(html, searchTerm) {
                if (!searchTerm) return html;
                const regex = new RegExp(`(${escapeRegExp(searchTerm)})(?![^<]+>)`, 'gi');
                return html.replace(regex, '<span class="highlighted-text">$1</span>');
            }

            function filterRows() {
                const rawTerm = searchInput.value.trim();
                const searchTerm = rawTerm.toLowerCase();
                const highlightTerm = rawTerm;

                let visibleCount = 0;

                tableRows.forEach(rowObj => {
                    const isFilterHidden = rowObj.element.classList.contains('filter-hidden');
                    const matchesSearch = rowObj.searchText.includes(searchTerm) || searchTerm === '';

                    if (matchesSearch && !isFilterHidden) {
                        rowObj.element.style.display = '';
                        visibleCount++;

                        if (searchTerm !== '') {
                            if (rowObj.nameEl) rowObj.nameEl.innerHTML = highlightMatches(rowObj.originalNameHtml, highlightTerm);
                            if (rowObj.codeEl) rowObj.codeEl.innerHTML = highlightMatches(rowObj.originalCodeHtml, highlightTerm);
                        } else {
                            if (rowObj.nameEl) rowObj.nameEl.innerHTML = rowObj.originalNameHtml;
                            if (rowObj.codeEl) rowObj.codeEl.innerHTML = rowObj.originalCodeHtml;
                        }
                    } else if (!isFilterHidden) {
                        rowObj.element.style.display = 'none';
                    }
                });

                const visibleEl = document.getElementById('visibleCount');
                if (visibleEl) {
                    const visible = Array.from(document.querySelectorAll('#automationTable tbody tr'))
                        .filter(row => row.style.display !== 'none' && !row.classList.contains('filter-hidden')).length;
                    visibleEl.textContent = visible;
                }
            }

            if (tableBody) {
                initTableData();
                searchInput.addEventListener('input', debounce(filterRows, 300));
            }
        });
    </script>

    <script>
        // =============================================
        // FILTER SYSTEM LOGIC
        // =============================================
        const FilterSystem = (function() {
            const isMarketplace = @(isMarketplace.ToString().ToLower());

            const filterGroups = [
                {
                    id: 'price-changes',
                    label: 'Zmiany cen',
                    filters: [
                        { key: 'increase', label: 'Podwyżki', icon: 'fa-arrow-up', attr: 'data-price-change', value: 'increase' },
                        { key: 'decrease', label: 'Obniżki', icon: 'fa-arrow-down', attr: 'data-price-change', value: 'decrease' },
                        { key: 'maintained', label: 'Bez zmian', icon: 'fa-equals', attr: 'data-price-change', value: 'maintained' },
                        { key: 'blocked', label: 'Zablokowane', icon: 'fa-ban', attr: 'data-price-change', value: 'blocked' }
                    ]
                },
                {
                    id: 'status',
                    label: 'Status',
                    filters: [
                        { key: 'TargetMet', label: 'Cel osiągnięty', icon: 'fa-check', attr: 'data-status', value: 'TargetMet' },
                        { key: 'TargetMaintained', label: 'Cel utrzymany', icon: 'fa-check-circle', attr: 'data-status', value: 'TargetMaintained' },
                        { key: 'LimitFloor', label: 'Limit (podłoga)', icon: 'fa-arrow-down', attr: 'data-limit-type', value: 'floor' },
                        { key: 'LimitCeiling', label: 'Limit (sufit)', icon: 'fa-arrow-up', attr: 'data-limit-type', value: 'ceiling' },
                        { key: 'Blocked', label: 'Blokada', icon: 'fa-times', attr: 'data-status', value: 'Blocked' }
                    ]
                },
                {
                    id: 'upload-status',
                    label: 'Wgranie',
                    filters: [
                        { key: 'updated-yes', label: 'Wgrano', icon: 'fa-cloud-upload-alt', attr: 'data-is-updated', value: 'true' },
                        { key: 'updated-no', label: 'Nie wgrano', icon: 'fa-clock', attr: 'data-is-updated', value: 'false' }
                    ]
                },
                {
                    id: 'data-issues',
                    label: 'Uwagi',
                    filters: [
                        { key: 'missing-own', label: 'Brak Twojej oferty', icon: 'fa-store-slash', attr: 'data-missing-own-offer', value: 'true' },
                        { key: 'no-competition', label: 'Brak konkurencji', icon: 'fa-users-slash', attr: 'data-no-competition', value: 'true' },
                        { key: 'has-purchase', label: 'Ma cenę zakupu', icon: 'fa-tag', attr: 'data-has-purchase-price', value: 'true' },
                        { key: 'no-purchase', label: 'Brak ceny zakupu', icon: 'fa-tag', attr: 'data-has-purchase-price', value: 'false' },
                        { key: 'margin-warning', label: 'Ostrzeżenie narzutu', icon: 'fa-exclamation', attr: 'data-has-margin-warning', value: 'true' }
                    ]
                },
                {
                    id: 'marketplace',
                    label: 'Allegro',
                    showIf: isMarketplace,
                    filters: [
                        { key: 'guarantee', label: 'Gwarancja najniższej ceny', icon: 'fa-shield-alt', attr: 'data-has-guarantee', value: 'true' },
                        { key: 'top-offer', label: 'Top oferta', icon: 'fa-star', attr: 'data-is-top-offer', value: 'true' },
                        { key: 'super-price', label: 'Supercena', icon: 'fa-bolt', attr: 'data-is-super-price', value: 'true' },
                        { key: 'campaign', label: 'Kampania', icon: 'fa-bullhorn', attr: 'data-is-campaign', value: 'true' },
                        { key: 'subsidy', label: 'Dopłaty', icon: 'fa-hand-holding-usd', attr: 'data-is-subsidy', value: 'true' },
                        { key: 'cheaper-own', label: 'Tańsza własna', icon: 'fa-exclamation-triangle', attr: 'data-has-cheaper-own', value: 'true' }
                    ]
                }
            ];

            let activeFilters = new Map();
            let allRows = [];

            function init() {
                const tableBody = document.querySelector('#automationTable tbody');
                if (!tableBody) return;

                allRows = Array.from(tableBody.querySelectorAll('tr'));

                buildFilterUI();
                updateCounts();
                bindEvents();
            }

            function buildFilterUI() {
                const toolbar = document.getElementById('filterToolbar');
                if (!toolbar) return;

                toolbar.innerHTML = '';

                filterGroups.forEach(group => {
                    if (group.showIf === false) return;

                    const groupHasProducts = group.filters.some(filter => {
                        return countMatching(filter.attr, filter.value) > 0;
                    });

                    const groupEl = document.createElement('div');
                    groupEl.className = 'filter-group';
                    groupEl.dataset.groupId = group.id;

                    const labelEl = document.createElement('span');
                    labelEl.className = 'filter-group-label';
                    labelEl.innerHTML = `${group.label}`;

                    groupEl.appendChild(labelEl);

                    group.filters.forEach(filter => {
                        const count = countMatching(filter.attr, filter.value);

                        const btn = document.createElement('button');
                        btn.className = 'filter-btn';
                        btn.dataset.filterKey = filter.key;
                        btn.dataset.filterAttr = filter.attr;
                        btn.dataset.filterValue = filter.value;
                        btn.dataset.groupId = group.id;

                        btn.innerHTML = `
                            <i class="fas ${filter.icon}" style="font-size: 10px;"></i>
                            ${filter.label}
                            <span class="filter-count">${count}</span>
                        `;

                        if (count === 0) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        }

                        groupEl.appendChild(btn);
                    });

                    toolbar.appendChild(groupEl);
                });

                updateTotalCount();
            }

            function countMatching(attr, value) {
                return allRows.filter(row => row.getAttribute(attr) === value).length;
            }

            function updateCounts() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const attr = btn.dataset.filterAttr;
                    const value = btn.dataset.filterValue;
                    const count = countMatching(attr, value);
                    const countEl = btn.querySelector('.filter-count');
                    if (countEl) countEl.textContent = count;
                });
            }

            function updateTotalCount() {
                const totalEl = document.getElementById('totalCount');
                const visibleEl = document.getElementById('visibleCount');

                if (totalEl) totalEl.textContent = allRows.length;
                if (visibleEl) {
                    const visible = allRows.filter(row => !row.classList.contains('filter-hidden')).length;
                    visibleEl.textContent = visible;
                }
            }

            function bindEvents() {
                document.getElementById('filterToolbar').addEventListener('click', function(e) {
                    const btn = e.target.closest('.filter-btn');
                    if (!btn || btn.disabled) return;

                    const key = btn.dataset.filterKey;
                    const attr = btn.dataset.filterAttr;
                    const value = btn.dataset.filterValue;

                    toggleFilter(key, attr, value, btn);
                });

                document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            }

            function toggleFilter(key, attr, value, btn) {
                if (activeFilters.has(key)) {
                    activeFilters.delete(key);
                    btn.classList.remove('active');
                } else {
                    activeFilters.set(key, { attr, value });
                    btn.classList.add('active');
                }

                applyFilters();
                updateGroupIndicators();
                updateResetButton();
            }

            function applyFilters() {
                if (activeFilters.size === 0) {
                    allRows.forEach(row => row.classList.remove('filter-hidden'));
                } else {
                    const filtersByAttr = new Map();

                    activeFilters.forEach((filterData, key) => {
                        if (!filtersByAttr.has(filterData.attr)) {
                            filtersByAttr.set(filterData.attr, []);
                        }
                        filtersByAttr.get(filterData.attr).push(filterData.value);
                    });

                    allRows.forEach(row => {
                        let visible = true;

                        filtersByAttr.forEach((values, attr) => {
                            const rowValue = row.getAttribute(attr);
                            if (!values.includes(rowValue)) {
                                visible = false;
                            }
                        });

                        if (visible) {
                            row.classList.remove('filter-hidden');
                        } else {
                            row.classList.add('filter-hidden');
                        }
                    });
                }

                updateTotalCount();

                // Jeśli funkcja z innego skryptu istnieje, wywołaj ją
                if (typeof updateVisibleProductSelectionButtons === 'function') {
                    updateVisibleProductSelectionButtons();
                }
            }

            function updateGroupIndicators() {
                document.querySelectorAll('.filter-group').forEach(group => {
                    const hasActive = group.querySelector('.filter-btn.active');
                    group.classList.toggle('has-active', !!hasActive);
                });
            }

            function updateResetButton() {
                const resetBtn = document.getElementById('resetFiltersBtn');
                if (resetBtn) {
                    resetBtn.style.display = activeFilters.size > 0 ? 'inline-flex' : 'none';
                }
            }

            function resetFilters() {
                activeFilters.clear();

                document.querySelectorAll('.filter-btn.active').forEach(btn => {
                    btn.classList.remove('active');
                });

                allRows.forEach(row => row.classList.remove('filter-hidden'));

                updateGroupIndicators();
                updateResetButton();
                updateTotalCount();
            }

            return {
                init,
                resetFilters,
                getActiveFilters: () => Array.from(activeFilters.keys())
            };
        })();

        $(document).ready(function() {
            FilterSystem.init();
        });
    </script>

  

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const searchInput = document.getElementById('productSearch');
            const tableBody = document.querySelector('#automationTable tbody');

            let tableRows = [];

            function initTableData() {
                const rows = tableBody.querySelectorAll('tr');
                tableRows = Array.from(rows).map(row => {

                    const nameContainer = row.querySelector('.product-name-wrap');

                    const codeContainer = row.querySelector('.small.text-muted');

                    return {
                        element: row,
                        nameEl: nameContainer,
                        codeEl: codeContainer,

                        originalNameHtml: nameContainer ? nameContainer.innerHTML : '',
                        originalCodeHtml: codeContainer ? codeContainer.innerHTML : '',

                        searchText: ((nameContainer ? nameContainer.textContent : '') + ' ' +
                                     (codeContainer ? codeContainer.textContent : '')).toLowerCase().replace(/\s+/g, ' ')
                    };
                });
            }

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function highlightMatches(html, searchTerm) {
                if (!searchTerm) return html;

                const regex = new RegExp(`(${escapeRegExp(searchTerm)})(?![^<]+>)`, 'gi');

                return html.replace(regex, '<span class="highlighted-text">$1</span>');
            }

            function filterRows() {
                const rawTerm = searchInput.value.trim();
                const searchTerm = rawTerm.toLowerCase();
                const highlightTerm = rawTerm;

                let visibleCount = 0;

                tableRows.forEach(rowObj => {

                    const isFilterHidden = rowObj.element.classList.contains('filter-hidden');

                    const matchesSearch = rowObj.searchText.includes(searchTerm) || searchTerm === '';

                    if (matchesSearch && !isFilterHidden) {
                        rowObj.element.style.display = '';
                        visibleCount++;

                        if (searchTerm !== '') {
                            if (rowObj.nameEl) {
                                rowObj.nameEl.innerHTML = highlightMatches(rowObj.originalNameHtml, highlightTerm);
                            }
                            if (rowObj.codeEl) {
                                rowObj.codeEl.innerHTML = highlightMatches(rowObj.originalCodeHtml, highlightTerm);
                            }
                        } else {
                            if (rowObj.nameEl) rowObj.nameEl.innerHTML = rowObj.originalNameHtml;
                            if (rowObj.codeEl) rowObj.codeEl.innerHTML = rowObj.originalCodeHtml;
                        }
                    } else if (!isFilterHidden) {
                        rowObj.element.style.display = 'none';
                    }
                });

                const visibleEl = document.getElementById('visibleCount');
                if (visibleEl) {
                    const visible = Array.from(document.querySelectorAll('#automationTable tbody tr'))
                        .filter(row => row.style.display !== 'none' && !row.classList.contains('filter-hidden')).length;
                    visibleEl.textContent = visible;
                }
            }

            if (tableBody) {
                initTableData();

                searchInput.addEventListener('input', debounce(filterRows, 300));
            }
        });
    </script>
   
}