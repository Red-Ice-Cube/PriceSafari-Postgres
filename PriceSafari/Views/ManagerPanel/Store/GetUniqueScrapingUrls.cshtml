@model IEnumerable<CoOfrClass>

@{
    ViewBag.Title = "Unikalne URL do Scrapowania";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var totalUrls = ViewBag.TotalUrlsCount;
    var scrapedUrlsCount = ViewBag.ScrapedUrlsCount;
    var totalProducts = Model.Sum(item => item.ProductIds != null ? item.ProductIds.Count : 0);
}

<div class="Vert" data-store-id="uniqueUrls">
    <div class="Vert-full">
        <div class="Order-Container-Title">
            Lista unikalnych URL do scrapowania
            <div class="bar-List">
                <div>
                    <strong>Łączna liczba URL: </strong><span id="totalUrlCount">@totalUrls</span>
                </div>
                <div>
                    <strong>Łączna liczba produktów: </strong><span id="totalProductCount">@totalProducts</span>
                </div>
                <div>
                    <strong>Zescrapowane URL: </strong><span id="scrapedUrlCount">@scrapedUrlsCount</span>
                </div>
                <div>
                    <strong>Postęp scrapowania: </strong><span id="scrapingProgress">@scrapedUrlsCount / @totalUrls</span>
                </div>
                <div>
                    <strong>Łączna liczba cen: </strong><span id="totalPricesCount">0</span>
                </div>
                <div>
                    <strong>Łączna liczba odrzuconych: </strong><span id="totalRejectedCount">0</span>
                </div>
            </div>
        </div>
        <div class="bar-List">
            <form asp-action="GroupAndSaveUniqueUrls" asp-controller="PriceScraping" method="post">
                <button type="submit" class="Button-Page-Small-b">Scal produkty</button>
            </form>
            <form id="captchaScrapingForm" asp-action="StartScrapingWithCaptchaHandling" asp-controller="PriceScraping" method="post">
                <button type="submit" class="Button-Page-Small-bl">Rozpocznij scrapowanie Ceneo</button>
            </form>
            <form id="googleScrapingForm" asp-action="StartScraping" asp-controller="GoogleMainPriceScraper" method="post">
                <button type="submit" class="Button-Page-Small-bl">Rozpocznij scrapowanie Google</button>
            </form>

            <button id="stopScrapingButton" class="Button-Page-Small-y">Przerwij scrapowanie</button>
            <form id="clearRejectedAndScrapedForm" asp-controller="PriceScraping" asp-action="ClearRejectedAndScrapedProducts" method="post">
                <button type="submit" class="Button-Page-Small-o">Resetuj odrzucone statusy</button>
            </form>
            <form asp-action="ClearCoOfrPriceHistories" asp-controller="PriceScraping" method="post">
                <button type="submit" class="Button-Page-Small-r">Usuń zescrapowane dane</button>
            </form>
        </div>
    

        <div class="order-upper-box">
            <div class="chart-box">
                <div class="chart-container-cam">
                    <div class="progress-bar">
                        <div id="progressBarInner" class="progress-bar-inner"></div>
                    </div>
                </div>
                <div id="progressText" class="mt-2"></div>
                <div id="completionMessage" class="mt-2" style="display: none;"></div>
                <div class="chart-container-cam">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>
        </div>
        <div class="Vert-table">
            <table id="initialTable" class="table-orders">
                <thead>
                    <tr>
                        <th>URL Ceneo</th>
                        <th>URL Google</th>
                        <th>Id</th>
                        <th>Zescrapowane Ceneo</th>
                        <th>Odrzucone Ceneo</th>
                        <th>Liczba Cen Ceneo</th>
                        <th>Zescrapowane Google</th>
                        <th>Odrzucone Google</th>
                        <th>Liczba Cen Google</th>
                    </tr>
                </thead>
                <tbody id="scrapingTableBody">
                    @foreach (var item in Model)
                    {
                        var rowId = $"row-{item.Id}";
                        // Determine the row class based on scraping status
                        var rowClass = item.IsScraped || item.GoogleIsScraped ? "scraped-row" : "unscraped-row";
                        // You can customize the rowClass further based on your highlighting logic
                        <tr id="@rowId" class="product-row @rowClass">
                            <td>@item.OfferUrl</td>
                            <td>@item.GoogleOfferUrl</td>
                            <td>@(item.ProductIds != null ? string.Join(", ", item.ProductIds) : "Brak danych")</td>
                            <td>@(item.IsScraped ? "Tak" : "Nie")</td>
                            <td>@(item.IsRejected ? "Tak" : "Nie")</td>
                            <td>@item.PricesCount</td>
                            <td>@(item.GoogleIsScraped ? "Tak" : "Nie")</td>
                            <td>@(item.GoogleIsRejected ? "Tak" : "Nie")</td>
                            <td>@item.GooglePricesCount</td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>

@section Scripts {
    <style>
        #speedChart {
            width: 100% !important;
            height: 200px !important;
        }

        .unscraped-row {
            background-color: #f0f0f0; /* Light gray for unscraped rows */
        }

        .scraped-row {
            background-color: #d1e7dd; /* Light green for scraped rows */
        }

        .scraped-ceneo {
            background-color: #d1e7dd; /* Light green */
        }

        .scraped-google {
            background-color: #cfe2ff; /* Light blue */
        }

        .rejected-row {
            background-color: #f8d7da; /* Light red for rejected rows */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.11/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
                  document.addEventListener("DOMContentLoaded", function () {
            var ctx = document.getElementById('speedChart').getContext('2d');

            var gradientFill1 = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight);
            gradientFill1.addColorStop(0, 'rgba(14, 126, 135, 0.2)');
            gradientFill1.addColorStop(1, 'rgba(14, 126, 135, 0.6)');

            var speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Zebrane produkty na sekundę:',
                        data: [],
                        backgroundColor: gradientFill1,
                        borderColor: 'rgba(14, 126, 135, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: false,
                                text: 'Sekundy',
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: false,
                                text: 'Zebrane produkty',
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0,
                            hoverRadius: 6,
                            hoverBorderWidth: 2
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: 'rgba(0, 69, 82, 1)',
                                font: {
                                    size: 15
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    var label = context.dataset.label || '';
                                    var value = context.parsed.y;
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });

            var connection = new signalR.HubConnectionBuilder().withUrl("/scrapingHub").build();
            var scrapingComplete = false;

            var offerUrlToRowId = {};
            var googleOfferUrlToRowId = {};

            // Tworzenie mapowania podczas ładowania strony
            document.querySelectorAll('#scrapingTableBody tr').forEach(function (row) {
                var rowId = row.id;
                var offerUrl = row.cells[0].innerText.trim();
                var googleOfferUrl = row.cells[1].innerText.trim();

                if (offerUrl) {
                    offerUrlToRowId[offerUrl] = rowId;
                }
                if (googleOfferUrl) {
                    googleOfferUrlToRowId[googleOfferUrl] = rowId;
                }
            });

            function updateRowClass(row) {
                var ceneoScraped = row.cells[3].innerText === "Tak";
                var googleScraped = row.cells[6].innerText === "Tak";
                var ceneoRejected = row.cells[4].innerText === "Tak";
                var googleRejected = row.cells[7].innerText === "Tak";

                var rowClass = "";

                if (ceneoRejected || googleRejected) {
                    rowClass = "rejected-row";
                } else if (ceneoScraped && googleScraped) {
                    rowClass = "scraped-row"; // Oba zescrapowane
                } else if (ceneoScraped) {
                    rowClass = "scraped-ceneo";
                } else if (googleScraped) {
                    rowClass = "scraped-google";
                } else {
                    rowClass = "unscraped-row";
                }

                row.className = "product-row " + rowClass;
            }

            // Funkcja obsługująca aktualizacje z obu scraperów
            connection.on("ReceiveScrapingUpdate", function () {
                var args = arguments;
                if (args.length === 4) {
                    // Dane z Ceneo scraper (bez 'source')
                    var offerUrl = args[0];
                    var isScraped = args[1];
                    var isRejected = args[2];
                    var pricesCount = args[3];

                    var rowId = offerUrlToRowId[offerUrl];

                    var row = document.getElementById(rowId);

                    if (row) {
                        // Aktualizacja komórek dla Ceneo
                        row.cells[3].innerText = isScraped ? "Tak" : "Nie"; // Zescrapowane Ceneo
                        row.cells[4].innerText = isRejected ? "Tak" : "Nie"; // Odrzucone Ceneo
                        row.cells[5].innerText = pricesCount; // Liczba Cen Ceneo

                        // Aktualizacja klasy wiersza
                        updateRowClass(row);
                    }
                } else if (args.length === 5) {
                    // Dane z Google scraper (z 'source')
                    var coOfrId = args[0];
                    var isScraped = args[1];
                    var isRejected = args[2];
                    var pricesCount = args[3];
                    var source = args[4];

                    if (source === "Google") {
                        var rowId = "row-" + coOfrId;

                        var row = document.getElementById(rowId);

                        if (row) {
                            // Aktualizacja komórek dla Google
                            row.cells[6].innerText = isScraped ? "Tak" : "Nie"; // Zescrapowane Google
                            row.cells[7].innerText = isRejected ? "Tak" : "Nie"; // Odrzucone Google
                            row.cells[8].innerText = pricesCount; // Liczba Cen Google

                            // Aktualizacja klasy wiersza
                            updateRowClass(row);
                        }
                    }
                }
            });

            connection.on("ReceiveProgressUpdate", function (totalScraped, uniqueProducts, elapsedSeconds, rejectedCount) {
                if (scrapingComplete) return;

                var percentage = Math.round((totalScraped / uniqueProducts) * 100);
                var progressBarInner = document.getElementById("progressBarInner");
                var progressText = document.getElementById("progressText");
                var completionMessage = document.getElementById("completionMessage");

                progressBarInner.style.width = percentage + "%";
                progressBarInner.innerHTML = percentage + "%";
                progressText.innerHTML = `Zbieranie cen ${totalScraped}/${uniqueProducts} produktów (${rejectedCount} odrzuconych)`;

                var currentTime = Math.floor(elapsedSeconds);

                var speed = (totalScraped / elapsedSeconds).toFixed(2);

                if (speedChart.data.labels.length > 0 && currentTime === speedChart.data.labels[speedChart.data.labels.length - 1]) {
                    var lastIndex = speedChart.data.labels.length - 1;
                    speedChart.data.datasets[0].data[lastIndex] = (parseFloat(speedChart.data.datasets[0].data[lastIndex]) + parseFloat(speed)) / 2;
                } else {
                    speedChart.data.labels.push(currentTime);
                    speedChart.data.datasets[0].data.push(parseFloat(speed));
                }

                speedChart.update();

                if (totalScraped === uniqueProducts) {
                    completionMessage.style.display = "block";
                    completionMessage.innerHTML = `Zebrano ceny dla ${totalScraped}/${uniqueProducts} produktów (${rejectedCount} odrzuconych).`;
                    completionMessage.style.color = "#0E7E87";

                    progressBarInner.style.backgroundColor = "#0E7E87";

                    progressText.style.display = "none";

                    scrapingComplete = true;
                }
            });

            connection.start().catch(function (err) {
                return console.error(err.toString());
            });

            $('#scrapingForm').on('submit', function (e) {
                e.preventDefault();
                var form = $(this);
                var url = form.attr('action');

                $.ajax({
                    url: url,
                    method: 'POST',
                    success: function () {
                        console.log('Scraping started successfully');
                    },
                    error: function () {
                        console.error('Error starting scraping');
                    }
                });
            });

            $('#stopScrapingButton').on('click', function () {
                $.ajax({
                    url: '/PriceScraping/StopScraping',
                    method: 'POST',
                    success: function () {
                        console.log('Scraping stopped successfully');
                    },
                    error: function () {
                        console.error('Error stopping scraping');
                    }
                });
            });

            function updateCounters() {
                var rows = document.querySelectorAll("#scrapingTableBody tr");
                var totalUrls = rows.length;
                var totalProductIds = 0;
                var totalPricesCountCeneo = 0;
                var totalPricesCountGoogle = 0;
                var totalRejectedCountCeneo = 0;
                var totalRejectedCountGoogle = 0;

                rows.forEach(function (row) {
                    totalProductIds += row.querySelectorAll('td')[2].textContent.split(', ').length;

                    totalPricesCountCeneo += parseInt(row.querySelectorAll('td')[5].innerText) || 0;
                    totalPricesCountGoogle += parseInt(row.querySelectorAll('td')[8].innerText) || 0;

                    if (row.querySelectorAll('td')[4].innerText === "Tak") {
                        totalRejectedCountCeneo++;
                    }
                    if (row.querySelectorAll('td')[7].innerText === "Tak") {
                        totalRejectedCountGoogle++;
                    }
                });

                document.getElementById("totalUrlCount").textContent = totalUrls;
                document.getElementById("totalProductCount").textContent = totalProductIds;
                document.getElementById("totalPricesCount").textContent = totalPricesCountCeneo + totalPricesCountGoogle;
                document.getElementById("totalRejectedCount").textContent = totalRejectedCountCeneo + totalRejectedCountGoogle;
            }
        });


    </script>
}
