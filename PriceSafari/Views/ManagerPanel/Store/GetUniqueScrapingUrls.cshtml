@model IEnumerable<CoOfrClass>

@{
    ViewBag.Title = "Unikalne URL do Scrapowania";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var totalUrls = Model.Count();
    var totalProducts = Model.Sum(item => item.ProductIds != null ? item.ProductIds.Count : 0);
    var scrapedUrlsCountCeneo = Model.Count(item => item.IsScraped);
    var scrapedUrlsCountGoogle = Model.Count(item => item.GoogleIsScraped);
    var totalPricesCountCeneo = Model.Sum(item => item.PricesCount);
    var totalPricesCountGoogle = Model.Sum(item => item.GooglePricesCount);
    var totalRejectedCountCeneo = Model.Count(item => item.IsRejected);
    var totalRejectedCountGoogle = Model.Count(item => item.GoogleIsRejected);
}

<div class="Vert" data-store-id="uniqueUrls">
    <div class="Vert-full" style="height:auto;">
        <div class="Order-Container-Title">
            Lista unikalnych URL do scrapowania
            <div class="bar-List">
                <div>
                    <strong>Łącznie URL: </strong><span id="totalUrlCount">@totalUrls</span>
                </div>
                <div>
                    <strong>Łącznie produktów: </strong><span id="totalProductCount">@totalProducts</span>
                </div>
                <div>
                    <strong>Zescrap. URL Ceneo: </strong><span id="scrapedUrlCountCeneo">@scrapedUrlsCountCeneo</span>
                </div>
                <div>
                    <strong>Zescrap. URL Google: </strong><span id="scrapedUrlCountGoogle">@scrapedUrlsCountGoogle</span>
                </div>
                <div>
                    <strong>Łącznie cen Ceneo: </strong><span id="totalPricesCountCeneo">@totalPricesCountCeneo</span>
                </div>
                <div>
                    <strong>Łącznie cen Google: </strong><span id="totalPricesCountGoogle">@totalPricesCountGoogle</span>
                </div>
                <div>
                    <strong>Łącznie odrzuc. Ceneo: </strong><span id="totalRejectedCountCeneo">@totalRejectedCountCeneo</span>
                </div>
                <div>
                    <strong>Łącznie odrzuc. Google: </strong><span id="totalRejectedCountGoogle">@totalRejectedCountGoogle</span>
                </div>
                <div id="controlXYCountdown" style="display:none;
                      background-color: rgba(0, 128, 0, 0.1);
                      border: 2px solid #008000;
                      color: #008000;
                      font-weight:400;
                      border-radius:4px;
                      padding: 8px;">
                    Uruchomienie ControlXY za <span id="controlXYCounter">10</span> sekund...
                </div>

                <div id="controlXYWarning" style="display:none;
                      background-color: rgba(255, 0, 0, 0.1);
                      border: 2px solid #ff0000;
                      color: #ff0000;
                      font-weight:600;
                      border-radius:4px;
                      padding: 8px;">
                    UWAGA! Kontrola XY jest włączona!
                </div>

            </div>

        </div>
        <div class="bar-List">
            <form asp-action="GroupAndSaveUniqueUrls" asp-controller="PriceScraping" method="post">
                <button type="submit" class="Button-Page-Small-b">Scal produkty</button>
            </form>
            <form id="captchaScrapingForm" asp-action="StartScrapingWithCaptchaHandling" asp-controller="PriceScraping" method="post">
                <button type="submit" class="Button-Page-Small-bl">Rozpocznij scrapowanie Ceneo</button>
            </form>
            <form id="googleScrapingForm" asp-action="StartScraping" asp-controller="GoogleMainPriceScraper" method="post">
                <button type="submit" class="Button-Page-Small-bl">Rozpocznij scrapowanie Google</button>
            </form>


            <div class="scraper-status-panel" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #fff; margin: 0 0 10px 0;">🐍 Python Google Scrapers</h4>

                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button id="startPythonScrapingBtn" class="Button-Page-Small-bl">
                        ▶️ Start Python Scraping
                    </button>
                    <button id="stopPythonScrapingBtn" class="Button-Page-Small-r">
                        ⏹️ Stop Python Scraping
                    </button>
                    <button id="refreshScraperStatusBtn" class="Button-Page-Small-b">
                        🔄 Odśwież status
                    </button>
                </div>

                <div id="pythonScraperStatus" style="margin-top: 15px; color: #ccc;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div>
                            <strong>Status:</strong>
                            <span id="scrapingEnabledStatus" style="color: #ff6b6b;">Wyłączone</span>
                        </div>
                        <div>
                            <strong>Aktywne scrapery:</strong>
                            <span id="activeScrapersCount">0</span>
                        </div>
                        <div>
                            <strong>Postęp:</strong>
                            <span id="pythonProgress">0%</span>
                        </div>
                        <div>
                            <strong>Pozostało:</strong>
                            <span id="remainingTasks">-</span>
                        </div>
                    </div>

                    <div id="scrapersList" style="margin-top: 10px; font-size: 12px;"></div>
                </div>
            </div>


            <button id="stopScrapingCeneoButton" class="Button-Page-Small-y">Przerwij scrapowanie Ceneo</button>
            <button id="stopScrapingGoogleButton" class="Button-Page-Small-y">Przerwij scrapowanie Google</button>


            <form id="clearRejectedAndScrapedFormCeneo"
                  asp-controller="PriceScraping"
                  asp-action="ClearRejectedAndScrapedProductsCeneo"
                  method="post">
                <button type="submit" class="Button-Page-Small-o">Resetuj odrzucone Ceneo</button>
            </form>

            <form id="clearRejectedAndScrapedFormGoogle"
                  asp-controller="PriceScraping"
                  asp-action="ClearRejectedAndScrapedProductsGoogle"
                  method="post">
                <button type="submit" class="Button-Page-Small-o">Resetuj odrzucone Google</button>
            </form>

            <form asp-action="ClearCoOfrPriceHistoriesCeneo" asp-controller="PriceScraping" method="post" style="display: inline-block;">
                <button type="submit" class="Button-Page-Small-r">Usuń dane Ceneo</button>
            </form>

            <form asp-action="ClearCoOfrPriceHistoriesGoogle" asp-controller="PriceScraping" method="post" style="display: inline-block;">
                <button type="submit" class="Button-Page-Small-r">Usuń dane Google</button>
            </form>
        </div>
        <div class="chart-box">
            <div class="chart-container-cam">
                <div class="progress-bar">
                    <div id="progressBarInner" class="progress-bar-inner"></div>
                </div>
            </div>
            <div id="progressText" class="mt-2"></div>
            <div id="completionMessage" class="mt-2" style="display: none;"></div>
            <div class="chart-container-cam">
                <canvas id="speedChart"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="Vert">
    <div class="Vert-full">
        <div class="Vert-table" style="height:90vh;">
            <table id="initialTable" class="table-orders">
                <thead>
                    <tr>
                        <th>URL Ceneo</th>
                        <th>URL Google</th>
                        <th>Id Ce</th>
                        <th>Id Go</th>
                        <th>Zescrapowane Ceneo</th>
                        <th>Odrzucone Ceneo</th>
                        <th>Liczba Cen Ceneo</th>
                        <th>Zescrapowane Google</th>
                        <th>Odrzucone Google</th>
                        <th>Liczba Cen Google</th>
                    </tr>
                </thead>
                <tbody id="scrapingTableBody">
                    @foreach (var item in Model)
                    {
                        var rowId = $"row-{item.Id}";
                        string rowClass;

                        if (item.IsRejected || item.GoogleIsRejected)
                        {
                            rowClass = "rejected-row";
                        }
                        else if (item.IsScraped && item.GoogleIsScraped)
                        {
                            rowClass = "scraped-both";
                        }
                        else if (item.IsScraped)
                        {
                            rowClass = "scraped-ceneo";
                        }
                        else if (item.GoogleIsScraped)
                        {
                            rowClass = "scraped-google";
                        }
                        else
                        {
                            rowClass = "unscraped-row";
                        }

                        <tr id="@rowId" class="product-row @rowClass">
                            <td>@item.OfferUrl</td>

                            <td>
                                @item.GoogleOfferUrl
                                @if (item.UseWRGA)
                                {
                                    <span class="badge-tag badge-wrga">WRGA</span>
                                }
                                @if (item.UseGPID)
                                {
                                    <span class="badge-tag badge-gpid">GPID</span>
                                }
                            </td>
                            <td>@(item.ProductIds != null ? string.Join(", ", item.ProductIds) : "Brak danych")</td>
                            <td>@(item.ProductIdsGoogle != null ? string.Join(", ", item.ProductIdsGoogle) : "Brak danych")</td>
                            <td>@(item.IsScraped ? "Tak" : "Nie")</td>
                            <td>@(item.IsRejected ? "Tak" : "Nie")</td>
                            <td>@item.PricesCount</td>
                            <td>@(item.GoogleIsScraped ? "Tak" : "Nie")</td>
                            <td>@(item.GoogleIsRejected ? "Tak" : "Nie")</td>
                            <td>@item.GooglePricesCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
</div>




@section Scripts {
    <style>
        /* === NOWE STYLE DLA BADGE'Y WRGA / GPID === */
        .badge-tag {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
            text-transform: uppercase;
            line-height: 1;
        }

        .badge-wrga {
            background-color: #dc3545; /* Czerwony */
            border: 1px solid #b02a37;
        }

        .badge-gpid {
            background-color: #6f42c1; /* Fioletowy */
            border: 1px solid #59359a;
        }
        /* ========================================== */

        #speedChart {
            width: 100% !important;
            height: 200px !important;
        }

        .product-row:hover {
            filter: brightness(85%) !important;
        }

        .unscraped-row {
            background-color: ghostwhite;
        }

        .scraped-ceneo {
            background-color: #FFE5B4; /* Light orange */
        }

        .scraped-google {
            background-color: #cfe2ff; /* Light blue */
        }

        .scraped-both {
            background-color: #D8BFD8; /* Light purple */
        }

        .rejected-row {
            background-color: #f8d7da; /* Light red for rejected rows */
        }

        .product-row td {
            padding: 8px;
        }

        .bar-List {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

            .bar-List div {
                margin-right: 20px;
            }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.11/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            // ============================================================
            // CHART.JS SETUP
            // ============================================================
            var ctx = document.getElementById('speedChart').getContext('2d');

            var gradientFill1 = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight);
            gradientFill1.addColorStop(0, 'rgba(14, 126, 135, 0.2)');
            gradientFill1.addColorStop(1, 'rgba(14, 126, 135, 0.6)');

            var speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Zebrane produkty na sekundę:',
                        data: [],
                        backgroundColor: gradientFill1,
                        borderColor: 'rgba(14, 126, 135, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    }
                }
            });

            // ============================================================
            // SIGNALR SETUP
            // ============================================================
            var connection = new signalR.HubConnectionBuilder().withUrl("/scrapingHub").build();
            var scrapingComplete = false;

            var offerUrlToRowId = {};
            var coOfrIdToRowId = {};

            document.querySelectorAll('#scrapingTableBody tr').forEach(function (row) {
                var rowId = row.id;
                var offerUrl = row.cells[0].innerText.trim();
                var coOfrId = rowId.replace('row-', '');
                if (offerUrl) offerUrlToRowId[offerUrl] = rowId;
                if (coOfrId) coOfrIdToRowId[coOfrId] = rowId;
            });

            function updateRowClass(row) {
                var ceneoScraped = row.cells[4].innerText === "Tak";
                var ceneoRejected = row.cells[5].innerText === "Tak";
                var googleScraped = row.cells[7].innerText === "Tak";
                var googleRejected = row.cells[8].innerText === "Tak";

                var rowClass = "";
                if (ceneoRejected || googleRejected) {
                    rowClass = "rejected-row";
                } else if (ceneoScraped && googleScraped) {
                    rowClass = "scraped-both";
                } else if (ceneoScraped) {
                    rowClass = "scraped-ceneo";
                } else if (googleScraped) {
                    rowClass = "scraped-google";
                } else {
                    rowClass = "unscraped-row";
                }
                row.className = "product-row " + rowClass;
            }

            connection.on("ReceiveScrapingUpdate", function () {
                var args = arguments;
                if (args.length === 4) {
                    var offerUrl = args[0];
                    var isScraped = args[1];
                    var isRejected = args[2];
                    var pricesCount = args[3];

                    var rowId = offerUrlToRowId[offerUrl];
                    var row = document.getElementById(rowId);

                    if (row) {
                        row.cells[4].innerText = isScraped ? "Tak" : "Nie";
                        row.cells[5].innerText = isRejected ? "Tak" : "Nie";
                        row.cells[6].innerText = pricesCount;
                        updateRowClass(row);
                        updateCounters();
                    }
                } else if (args.length === 5) {
                    var coOfrId = args[0];
                    var isScraped = args[1];
                    var isRejected = args[2];
                    var pricesCount = args[3];
                    var source = args[4];

                    if (source === "Google") {
                        var rowId = coOfrIdToRowId[coOfrId];
                        var row = document.getElementById(rowId);

                        if (row) {
                            row.cells[7].innerText = isScraped ? "Tak" : "Nie";
                            row.cells[8].innerText = isRejected ? "Tak" : "Nie";
                            row.cells[9].innerText = pricesCount;
                            updateRowClass(row);
                            updateCounters();
                        }
                    }
                }
            });

            connection.on("ReceiveProgressUpdate", function (totalScraped, uniqueProducts, elapsedSeconds, rejectedCount) {
                if (scrapingComplete) return;

                var percentage = Math.round((totalScraped / uniqueProducts) * 100);
                var progressBarInner = document.getElementById("progressBarInner");
                var progressText = document.getElementById("progressText");
                var completionMessage = document.getElementById("completionMessage");

                progressBarInner.style.width = percentage + "%";
                progressBarInner.innerHTML = percentage + "%";
                progressText.innerHTML = `Zbieranie cen ${totalScraped}/${uniqueProducts} produktów (${rejectedCount} odrzuconych)`;

                var currentTime = Math.floor(elapsedSeconds);
                var speed = (totalScraped / elapsedSeconds).toFixed(2);

                if (speedChart.data.labels.length > 0 && currentTime === speedChart.data.labels[speedChart.data.labels.length - 1]) {
                    var lastIndex = speedChart.data.labels.length - 1;
                    speedChart.data.datasets[0].data[lastIndex] = (parseFloat(speedChart.data.datasets[0].data[lastIndex]) + parseFloat(speed)) / 2;
                } else {
                    speedChart.data.labels.push(currentTime);
                    speedChart.data.datasets[0].data.push(parseFloat(speed));
                }
                speedChart.update();

                if (totalScraped === uniqueProducts) {
                    completionMessage.style.display = "block";
                    completionMessage.innerHTML = `Zebrano ceny dla ${totalScraped}/${uniqueProducts} produktów (${rejectedCount} odrzuconych).`;
                    completionMessage.style.color = "#0E7E87";
                    progressBarInner.style.backgroundColor = "#0E7E87";
                    progressText.style.display = "none";
                    scrapingComplete = true;
                }
            });

            connection.on("ReceiveControlXYCountdown", function(startValue) {
                var countdownDiv = document.getElementById("controlXYCountdown");
                var counterSpan = document.getElementById("controlXYCounter");
                var warningDiv = document.getElementById("controlXYWarning");

                countdownDiv.style.display = "block";
                var timeLeft = startValue;
                counterSpan.textContent = timeLeft;

                var intervalId = setInterval(function() {
                    timeLeft--;
                    counterSpan.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(intervalId);
                        countdownDiv.style.display = "none";
                        setTimeout(function() {
                            warningDiv.style.display = "block";
                            setTimeout(function() {
                                warningDiv.style.display = "none";
                            }, 15000);
                        }, 1000);
                    }
                }, 1000);
            });

            connection.start().catch(function (err) {
                console.error(err.toString());
            });

            // ============================================================
            // CENEO / GOOGLE C# SCRAPING FORMS
            // ============================================================
            $('#captchaScrapingForm').on('submit', function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr('action'),
                    method: 'POST',
                    success: function () { console.log('Ceneo scraping started'); },
                    error: function () { console.error('Error starting Ceneo scraping'); }
                });
            });

            $('#googleScrapingForm').on('submit', function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: form.attr('action'),
                    method: 'POST',
                    success: function () { console.log('Google C# scraping started'); },
                    error: function () { console.error('Error starting Google C# scraping'); }
                });
            });

            $('#stopScrapingCeneoButton').on('click', function () {
                $.ajax({
                    url: '/PriceScraping/StopScraping',
                    method: 'POST',
                    success: function () { console.log('Ceneo scraping stopped'); },
                    error: function () { console.error('Error stopping Ceneo scraping'); }
                });
            });

            $('#stopScrapingGoogleButton').on('click', function () {
                $.ajax({
                    url: '/GoogleMainPriceScraper/StopScrapingGoogle',
                    method: 'POST',
                    success: function () { console.log('Google C# scraping stopped'); },
                    error: function () { console.error('Error stopping Google C# scraping'); }
                });
            });

            // ============================================================
            // PYTHON SCRAPER CONTROL (NOWY SYSTEM)
            // ============================================================
            function updatePythonScraperStatus() {
                $.get('/api/google-scrape/status', function(data) {
                    console.log('[Python Status]', data);

                    // Status włączenia
                    if (data.isEnabled) {
                        $('#scrapingEnabledStatus').text('Włączone').css('color', '#51cf66');
                    } else {
                        $('#scrapingEnabledStatus').text('Wyłączone').css('color', '#ff6b6b');
                    }

                    // Liczniki
                    $('#activeScrapersCount').text(data.activeScrapersCount);
                    $('#pythonProgress').text(data.progressPercent + '%');
                    $('#remainingTasks').text(data.remainingTasks);

                    // Lista scraperów
                    var scrapersHtml = '';
                    if (data.activeScrapers && data.activeScrapers.length > 0) {
                        scrapersHtml = '<div style="margin-top: 5px;">';
                        data.activeScrapers.forEach(function(s) {
                            var statusIcon = s.isWorking ? '🟢' : '🟡';
                            var ago = s.secondsAgo + 's ago';
                            scrapersHtml += '<span style="margin-right: 15px;">' +
                                statusIcon + ' ' + s.scraperName +
                                ' (📊 ' + s.tasksProcessed + ' | ⏱️ ' + ago + ')</span>';
                        });
                        scrapersHtml += '</div>';
                    }
                    $('#scrapersList').html(scrapersHtml);

                }).fail(function(xhr, status, error) {
                    console.error('Failed to get scraper status:', status, error);
                });
            }

            // START PYTHON SCRAPING
            $('#startPythonScrapingBtn').on('click', function() {
                console.log('[Python] Kliknięto START');

                $.ajax({
                    url: '/api/google-scrape/start',
                    method: 'POST',
                    success: function(data) {
                        console.log('[Python] Start response:', data);
                        alert('Python scraping started: ' + data.message);
                        updatePythonScraperStatus();
                    },
                    error: function(xhr, status, error) {
                        console.error('[Python] Start error:', status, error);
                        alert('Błąd startu: ' + error);
                    }
                });
            });

            // STOP PYTHON SCRAPING
            $('#stopPythonScrapingBtn').on('click', function() {
                console.log('[Python] Kliknięto STOP');

                $.ajax({
                    url: '/api/google-scrape/stop',
                    method: 'POST',
                    success: function(data) {
                        console.log('[Python] Stop response:', data);
                        alert('Python scraping stopped: ' + data.message);
                        updatePythonScraperStatus();
                    },
                    error: function(xhr, status, error) {
                        console.error('[Python] Stop error:', status, error);
                        alert('Błąd stopu: ' + error);
                    }
                });
            });

            // REFRESH STATUS
            $('#refreshScraperStatusBtn').on('click', function() {
                console.log('[Python] Odświeżam status');
                updatePythonScraperStatus();
            });

            // Auto-refresh co 5s
            setInterval(updatePythonScraperStatus, 5000);

            // Initial load
            updatePythonScraperStatus();

            // ============================================================
            // COUNTERS UPDATE
            // ============================================================
            function updateCounters() {
                var rows = document.querySelectorAll("#scrapingTableBody tr");
                var totalUrls = rows.length;
                var totalProductIds = 0;
                var totalPricesCountCeneo = 0;
                var totalPricesCountGoogle = 0;
                var totalRejectedCountCeneo = 0;
                var totalRejectedCountGoogle = 0;
                var scrapedUrlsCountCeneo = 0;
                var scrapedUrlsCountGoogle = 0;

                rows.forEach(function (row) {
                    var productIdsCe = row.cells[2].innerText;
                    totalProductIds += productIdsCe === "Brak danych" ? 0 : productIdsCe.split(', ').length;

                    totalPricesCountCeneo += parseInt(row.cells[6].innerText) || 0;
                    totalPricesCountGoogle += parseInt(row.cells[9].innerText) || 0;

                    if (row.cells[4].innerText === "Tak") scrapedUrlsCountCeneo++;
                    if (row.cells[7].innerText === "Tak") scrapedUrlsCountGoogle++;
                    if (row.cells[5].innerText === "Tak") totalRejectedCountCeneo++;
                    if (row.cells[8].innerText === "Tak") totalRejectedCountGoogle++;
                });

                document.getElementById("totalUrlCount").textContent = totalUrls;
                document.getElementById("totalProductCount").textContent = totalProductIds;
                document.getElementById("totalPricesCountCeneo").textContent = totalPricesCountCeneo;
                document.getElementById("totalPricesCountGoogle").textContent = totalPricesCountGoogle;
                document.getElementById("totalRejectedCountCeneo").textContent = totalRejectedCountCeneo;
                document.getElementById("totalRejectedCountGoogle").textContent = totalRejectedCountGoogle;
                document.getElementById("scrapedUrlCountCeneo").textContent = scrapedUrlsCountCeneo;
                document.getElementById("scrapedUrlCountGoogle").textContent = scrapedUrlsCountGoogle;
            }

            // Initial counters update
            updateCounters();

            console.log('[INIT] Wszystkie event handlery podpięte!');
        });
    </script>
}