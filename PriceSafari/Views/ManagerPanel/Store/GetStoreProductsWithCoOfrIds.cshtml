@model StoreProductsViewModel

@{
    ViewBag.Title = "Produkty sklepu " + Model.StoreName;
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    bool apiEnabled = ViewBag.FetchExtendedData ?? false;
}

<style>
    /* Wymuszenie kolorów dla tabeli */
    .table-fix-contrast td {
        vertical-align: middle !important;
        color: #343a40 !important; /* Ciemny tekst w komórkach */
    }

    /* Stylizacja Badges (Etykiet) - WYMUSZENIE KONTRASTU */
    .badge-custom {
        font-size: 0.85rem;
        padding: 0.5em 0.8em;
        border-radius: 4px;
        font-weight: 600;
        display: inline-block;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Lekki cień dla lepszej widoczności */
    }

    /* Kolory tła dla poszczególnych stanów */
    .bg-force-success {
        background-color: #28a745 !important;
        color: #ffffff !important;
    }

    .bg-force-secondary {
        background-color: #6c757d !important;
        color: #ffffff !important;
    }

    .bg-force-warning {
        background-color: #ffc107 !important;
        color: #212529 !important; /* Ciemny tekst na żółtym tle */
    }

    /* Styl linków */
    .link-icon {
        font-size: 1.3rem;
        margin: 0 5px;
        text-decoration: none !important;
        transition: transform 0.2s;
        display: inline-block;
    }

        .link-icon:hover {
            transform: scale(1.2);
        }

    .ceneo-color {
        color: #ff7f00;
    }

    .google-color {
        color: #4285F4;
    }

    .text-muted-light {
        color: #adb5bd;
    }
</style>

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded shadow-sm border">
        <div>
            <h2 class="h4 mb-0 text-dark">Produkty sklepu: <span class="text-primary font-weight-bold">@Model.StoreName</span></h2>
        </div>
        <div>
            <a href="@Url.Action("Index", "Store")" class="btn btn-secondary shadow-sm">
                <i class="fas fa-arrow-left"></i> Wróć
            </a>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-cogs mr-2"></i> Operacje</h5>
        </div>
        <div class="card-body bg-light">
            <div class="row">

                @if (apiEnabled)
                {
                    <div class="col-md-4 mb-2">
                        <div class="card h-100 border-success shadow-sm">
                            <div class="card-body p-3 text-center">
                                <h6 class="text-success font-weight-bold">1. Pobierz ceny z API</h6>
                                <p class="small text-muted mb-3">Pobiera aktualne ceny (netto/brutto) ze sklepu.</p>
                                <form asp-action="RunApiBotForStore" asp-controller="PriceScraping" method="post">
                                    <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
                                    <button type="submit" class="btn btn-success btn-block font-weight-bold shadow-sm">
                                        <i class="fas fa-robot"></i> Uruchom API Bot
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-2">
                        <div class="card h-100 border-danger shadow-sm">
                            <div class="card-body p-3 text-center">
                                <h6 class="text-danger font-weight-bold">Reset Danych API</h6>
                                <p class="small text-muted mb-3">Czyści statusy API (wymusza ponowne pobranie).</p>
                                <form asp-action="ClearApiDataForStore" asp-controller="PriceScraping" method="post">
                                    <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
                                    <button type="submit" class="btn btn-outline-danger btn-block shadow-sm" onclick="return confirm('Czy na pewno chcesz wyczyścić pobrane ceny z API?');">
                                        <i class="fas fa-trash-alt"></i> Wyczyść
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="col-md-8 mb-2">
                        <div class="alert alert-warning h-100 d-flex align-items-center justify-content-center shadow-sm">
                            <span><i class="fas fa-info-circle fa-lg mr-2"></i> API wyłączone dla tego sklepu.</span>
                        </div>
                    </div>
                }

                <div class="col-md-4 mb-2">
                    <div class="card h-100 border-primary shadow-sm">
                        <div class="card-body p-3 text-center">
                            <h6 class="text-primary font-weight-bold">2. Przetwórz Sklep (Mapowanie)</h6>
                            <p class="small text-muted mb-3">Zapisuje wszystkie dane do historii cen.</p>
                            <form asp-action="MapCoOfrToPriceHistory" asp-controller="PriceScraping" method="post">
                                <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
                                <button type="submit" class="btn btn-primary btn-block font-weight-bold shadow-sm">
                                    <i class="fas fa-save"></i> Zapisz do Historii
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 table-fix-contrast table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 60px;" class="text-center">ID</th>
                            <th style="min-width: 300px;">Produkt</th>
                            <th class="text-center" style="width: 160px;">Status / CoOfr</th>
                            <th class="text-center" style="width: 130px;">Linki</th>
                            @if (apiEnabled)
                            {
                                <th class="bg-info border-info text-white text-center" style="width: 120px;">Ext. ID</th>
                                <th class="bg-info border-info text-white text-center" style="width: 140px;">Status API</th>
                                <th class="bg-info border-info text-white text-center" style="width: 140px;">Cena API</th>
                            }
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        @foreach (var product in Model.Products)
                        {
                            <tr>
                                <td class="text-center font-weight-bold text-secondary">@product.ProductId</td>

                                <td title="@product.ProductName">
                                    <div class="d-flex align-items-center" style="height: 100%;">
                                        <span class="font-weight-bold" style="font-size: 0.95rem;">
                                            @if (product.ProductName.Length > 80)
                                            {
                                                @product.ProductName.Substring(0, 80)
                                        
                                                <span>...</span>
                                            }
                                            else
                                            {
                                                @product.ProductName
                                            }
                                        </span>
                                    </div>
                                </td>

                                <td class="text-center">
                                    @if (product.CoOfrId.HasValue)
                                    {
                                        <span class="badge-custom bg-force-success">
                                            <i class="fas fa-check"></i> OK (@product.CoOfrId)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge-custom bg-force-warning">Brak CoOfr</span>
                                    }
                                </td>

                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(product.OfferUrl))
                                    {
                                        <a href="@product.OfferUrl" target="_blank" class="link-icon ceneo-color" title="Ceneo" data-toggle="tooltip">
                                            <i class="fas fa-shopping-bag"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <i class="fas fa-shopping-bag link-icon text-muted-light" style="opacity: 0.3"></i>
                                    }

                                    @if (!string.IsNullOrEmpty(product.GoogleOfferUrl))
                                    {
                                        <a href="@product.GoogleOfferUrl" target="_blank" class="link-icon google-color" title="Google" data-toggle="tooltip">
                                            <i class="fab fa-google"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <i class="fab fa-google link-icon text-muted-light" style="opacity: 0.3"></i>
                                    }
                                </td>

                                @if (apiEnabled)
                                {
                                    <td class="text-center">
                                        @if (product.HasApiDataEntry)
                                        {
                                            <code class="px-2 py-1 rounded border bg-light text-dark font-weight-bold" style="font-size: 0.9em;">@product.ApiExternalId</code>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (product.HasApiDataEntry)
                                        {
                                            @if (product.ApiProcessed)
                                            {
                                                <span class="badge-custom bg-force-success w-100">
                                                    <i class="fas fa-check-circle"></i> Gotowe
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge-custom bg-force-secondary w-100">
                                                    <i class="fas fa-clock"></i> Oczekuje
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted small">N/A</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (product.ApiPrice.HasValue)
                                        {
                                            <span class="text-success font-weight-bold" style="font-size: 1.1em;">
                                                @product.ApiPrice PLN
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>