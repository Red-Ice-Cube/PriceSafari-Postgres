@using PriceSafari.Models.SchedulePlan
@model PriceSafari.Models.SchedulePlan.SchedulePlan

@{
    ViewData["Title"] = "Kalendarz (co 10 min)";

    // 7 kolumn (pon-nd)
    var days = new[]
    {
        new { Name = "Monday",    Detail = Model.Monday,    DayDetailId = Model.MondayId },
        new { Name = "Tuesday",   Detail = Model.Tuesday,   DayDetailId = Model.TuesdayId },
        new { Name = "Wednesday", Detail = Model.Wednesday, DayDetailId = Model.WednesdayId },
        new { Name = "Thursday",  Detail = Model.Thursday,  DayDetailId = Model.ThursdayId },
        new { Name = "Friday",    Detail = Model.Friday,    DayDetailId = Model.FridayId },
        new { Name = "Saturday",  Detail = Model.Saturday,  DayDetailId = Model.SaturdayId },
        new { Name = "Sunday",    Detail = Model.Sunday,    DayDetailId = Model.SundayId }
    };

    // Funkcja: wyszukujemy Zadanie, które startuje EXACT w tym slocie
    Func<DayDetail, int, int, ScheduleTask> findTask = (dd, hr, mn) =>
    {
        if (dd == null || dd.Tasks == null) return null;
        return dd.Tasks.FirstOrDefault(t => t.StartTime.Hours == hr
                                         && t.StartTime.Minutes == mn);
    };
}

<h2>Kalendarz 10-minutowy</h2>
<p>(W tym przykładzie pokazujemy TYLKO te zadania, które startują w danym slocie)</p>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Godzina</th>
            <th>Pon</th>
            <th>Wt</th>
            <th>Śr</th>
            <th>Czw</th>
            <th>Pt</th>
            <th>So</th>
            <th>Nd</th>
        </tr>
    </thead>
    <tbody>
        @for (int hour = 0; hour < 24; hour++)
        {
            for (int minute = 0; minute < 60; minute += 10)
            {
                <tr>
                    <td>@($"{hour:00}:{minute:00}")</td>

                    @foreach (var day in days)
                    {
                        var task = findTask(day.Detail, hour, minute);

                        if (task == null)
                        {
                            // sprawdzamy, czy ten slot jest w czyimś przedziale [StartTime, EndTime)?
                            bool isOccupied = day.Detail?.Tasks?.Any(t =>
                            new TimeSpan(hour, minute, 0) >= t.StartTime &&
                            new TimeSpan(hour, minute, 0) < t.EndTime
                            ) ?? false;

                            if (isOccupied)
                            {
                                // Pokoloruj lub zablokuj
                                <td style="background:#ddd;">
                                    Zajęte
                                </td>
                            }
                            else
                            {
                                // Wolny slot
                                <td>
                                    <a asp-action="AddTask"
                                       asp-route-dayDetailId="@day.DayDetailId"
                                       asp-route-hour="@hour"
                                       asp-route-min="@minute"
                                       class="btn btn-sm btn-success">
                                        Dodaj
                                    </a>
                                </td>
                            }
                        }
                        else
                        {
                            // W tym slocie startuje zadanie
                            var duration = task.EndTime - task.StartTime;
                            var minutesTotal = duration.TotalMinutes;
                            <td style="background:#ffecb3;">
                                <strong>@task.SessionName</strong><br />
                                @($"{task.StartTime:hh\\:mm} - {task.EndTime:hh\\:mm}")
                                <br />
                                Sklepy: @string.Join(", ", task.TaskStores.Select(ts => ts.Store.StoreName))
                                <br />
                                Base=@(task.BaseEnabled ? "T" : "F"),
                                Url=@(task.UrlEnabled ? "T" : "F"),
                                Goo=@(task.GoogleEnabled ? "T" : "F"),
                                Cen=@(task.CeneoEnabled ? "T" : "F")

                                <hr />
                                <a asp-action="EditTask" asp-route-taskId="@task.Id" class="btn btn-sm btn-info">
                                    Edytuj
                                </a>

                                <form asp-action="DeleteTask" method="post" style="display:inline;">
                                    <input type="hidden" name="taskId" value="@task.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Czy na pewno usunąć zadanie?')">
                                        Usuń
                                    </button>
                                </form>
                            </td>

                        }
                    }
                </tr>
            }
        }
    </tbody>
</table>
