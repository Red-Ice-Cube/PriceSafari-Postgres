@model PriceSafari.Models.ManagerViewModels.ManagerUserProfileViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<style>

    .top-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 24px;
        align-items: start;
    }

    .info-card {
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .info-card-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #343a40;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .info-line {
        display: flex;
        align-items: center;
        font-size: 14px;
        margin-bottom: 1.25rem;
        color: #4B4B4B;
        gap: 8px;
    }

    .info-line-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
    }

        .info-line-icon img {
            width: 100%;
            height: 100%;
        }

        .info-line-icon .fas {
            font-size: 18px;
            color: #6c757d;
            width: 20px;
            text-align: center;
        }

    .info-line strong {
        color: #212529;
        min-width: 140px;
        flex-shrink: 0;
    }

    .info-line span, .info-line a, .info-line div {
        word-break: break-all;
    }

    .feed-grid {
        display: flex;
        gap: 32px;
        flex-direction: column;
    }

    .actions-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

        .actions-container .btn {
            min-width: 180px;
        }

    .status-badge {
        display: inline-block;
        padding: 0.3em 0.65em;
        font-size: 80%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        color: #fff;
    }

    .status-active {
        background-color: #28a745;
    }

    .status-pending {
        background-color: #ffc107;
        color: #212529;
    }

    .status-inactive {
        background-color: #6c757d;
    }

</style>

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Profil użytkownika
            </div>
            <partial name="_ManageNavCol" />
        </div>

        <div class="Column-Form">
            @Html.AntiForgeryToken()
            <div class="campaign-box-head-name" style="font-size: 26px; color: #4B4B4B; font-weight:300; margin-bottom: 2rem;">
                Konto @Model.UserName @Model.UserSurname
            </div>
            <div style="display:flex; gap:24px;">
                <div class="top-grid">
                    <div class="info-card">
                        <div class="info-card-header">Dane podstawowe</div>
                        <div class="info-line">
                            <div class="info-line-icon"><img src="~/images/Affiliate.svg" /></div>
                            <strong>Kod Partnera:</strong> <span>@Model.UserCode</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><img src="~/images/Mail.svg" /></div>
                            <strong>E-mail:</strong> <span>@Model.UserEmail</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-phone-alt"></i></div>
                            <strong>Telefon:</strong>
                            <span>@(string.IsNullOrEmpty(Model.PhoneNumber) ? "Brak danych" : Model.PhoneNumber)</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-user-tag"></i></div>
                            <strong>Rola w systemie:</strong>
                            <div>
                                @if (Model.Role == "Admin")
                                {
                                    <div class="AdminStyle">@Model.Role</div>
                                }
                                else if (Model.Role == "Manager")
                                {
                                    <div class="ManagerStyle">@Model.Role</div>
                                }
                                else if (Model.Role == "Member")
                                {
                                    <div class="MemberStyle">@Model.Role</div>
                                }
                                else if (Model.Role == "PreMember")
                                {
                                    <div class="PreMemberStyle">@Model.Role</div>
                                }
                                else
                                {
                                    <span>@Model.Role</span>
                                }
                            </div>
                            <div>
                                @if (Model.Role == "PreMember")
                                {
                                    <form asp-action="PromoteToMember" method="post" asp-antiforgery="true" class="mb-0">
                                        <input type="hidden" name="codePAR" value="@Model.UserCode" />
                                        <button type="submit" class="btn btn-sm btn-outline-success">Zmień na Member</button>
                                    </form>
                                }
                            </div>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><img src="~/images/Time.svg" /></div>
                            <strong>Data dołączenia:</strong> <span>@Model.UserJoin.ToString("g")</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">Status i Aktywność</div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-shield-alt"></i></div>
                            <strong>Status konta:</strong>
                            <div>
                                @switch (Model.UserStatus)
                                {
                                    case UserStatus.Active:
                                        <span class="status-badge status-active">Aktywne</span>
                                        break;
                                    case UserStatus.PendingEmailVerification:
                                    case UserStatus.PendingSetup:
                                    case UserStatus.AwaitingAdminApproval:
                                    case UserStatus.Onboarding:
                                        <span class="status-badge status-pending">Oczekujące (@Model.UserStatus.ToString())</span>
                                        break;
                                    case UserStatus.Inactive:
                                        <span class="status-badge status-inactive">Nieaktywne</span>
                                        break;
                                }
                            </div>
                        </div>

                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-sign-in-alt"></i></div>
                            <strong>Ostatnie logowanie:</strong>
                            <span>@(Model.LastLogin.HasValue? Model.LastLogin.Value.ToString("g") : "Brak danych")</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-list-ol"></i></div>
                            <strong>Liczba logowań:</strong> <span>@Model.LoginCount</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-user-check"></i></div>
                            <strong>Weryfikacja Partnera:</strong> <span>@(Model.Verification ? "Zatwierdzony" : "Czeka na weryfikację")</span>
                        </div>
                        <div class="info-line">
                            <div class="info-line-icon"><i class="fas fa-paper-plane"></i></div>
                            <strong>Powiadomienie:</strong>
                            <div>
                                <button id="send-panel-ready-email-btn"
                                        class="btn btn-sm btn-outline-primary"
                                        data-user-code-par="@Model.UserCode" data-controller-url="@Url.Action("SendPanelReadyEmail", "ManagerAffiliate")">
                                    Wyślij e-mail "Panel Gotowy"
                                </button>
                                <small id="email-status-text" class="form-text text-muted" style="display:none; margin-top: 5px;"></small>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">Akcje</div>
                        <div class="actions-container">
                            @if (Model.Status)
                            {
                                <form asp-action="BlockUser" method="post" asp-antiforgery="true">
                                    <input type="hidden" name="codePAR" value="@Model.UserCode" />
                                    <button type="submit" class="btn btn-warning">Zablokuj użytkownika</button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="UnblockUser" method="post" asp-antiforgery="true">
                                    <input type="hidden" name="codePAR" value="@Model.UserCode" />
                                    <button type="submit" class="btn btn-success">Odblokuj użytkownika</button>
                                </form>
                            }

                            @if (!Model.Verification)
                            {
                                <form asp-action="VerifyUser" method="post">
                                    <input type="hidden" name="codePAR" value="@Model.UserCode" />
                                    <button type="submit" class="btn btn-primary">Zaakceptuj weryfikację</button>
                                </form>
                            }

                            <form asp-action="HardDeleteUser" method="post" asp-antiforgery="true"
                                  onsubmit="return confirm('Ta operacja TRWALE usunie konto i wszystkie dane powiązane. Kontynuować?');">
                                <input type="hidden" name="codePAR" value="@Model.UserCode" />
                                <button type="submit" class="btn btn-danger">
                                    Usuń konto na stałe
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-header">Konfiguracja Feedów Produktowych</div>
                    <div class="feed-grid">
                        <div>
                            <h5>Ceneo</h5>
                            <hr />
                            @if (Model.CeneoFeedSubmittedOn.HasValue)
                            {
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-check-circle" style="color: green;"></i></div>
                                    <strong>Status:</strong> <span>Dane przesłane</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-calendar-alt"></i></div>
                                    <strong>Data przesłania:</strong> <span>@Model.CeneoFeedSubmittedOn.Value.ToString("g")</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-store"></i></div>
                                    <strong>Nazwa sklepu:</strong> <span>@Model.CeneoStoreName</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-link"></i></div>
                                    <strong>URL Feedu:</strong> <a href="@Model.CeneoFeedUrl" target="_blank">@Model.CeneoFeedUrl</a>
                                </div>
                            }
                            else
                            {
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-hourglass-half"></i></div>
                                    Użytkownik nie podał jeszcze danych dla Ceneo.
                                </div>
                            }
                        </div>
                        <div>
                            <h5>Google Shopping</h5>
                            <hr />
                            @if (Model.GoogleFeedSubmittedOn.HasValue)
                            {
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-check-circle" style="color: green;"></i></div>
                                    <strong>Status:</strong> <span>Dane przesłane</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-calendar-alt"></i></div>
                                    <strong>Data przesłania:</strong> <span>@Model.GoogleFeedSubmittedOn.Value.ToString("g")</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-store"></i></div>
                                    <strong>Nazwa sklepu:</strong> <span>@Model.GoogleStoreName</span>
                                </div>
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-link"></i></div>
                                    <strong>URL Feedu:</strong> <a href="@Model.GoogleFeedUrl" target="_blank">@Model.GoogleFeedUrl</a>
                                </div>
                            }
                            else
                            {
                                <div class="info-line">
                                    <div class="info-line-icon"><i class="fas fa-hourglass-half"></i></div>
                                    Użytkownik nie podał jeszcze danych dla Google Shopping.
                                </div>
                            }
                        </div>
                        <h5>Allegro</h5>
                        <hr />
                        @if (Model.AllegroSubmittedOn.HasValue)
                        {
                            <div class="info-line">
                                <div class="info-line-icon"><i class="fas fa-check-circle" style="color: green;"></i></div>
                                <strong>Status:</strong> <span>Dane przesłane</span>
                            </div>
                            <div class="info-line">
                                <div class="info-line-icon"><i class="fas fa-calendar-alt"></i></div>
                                <strong>Data przesłania:</strong> <span>@Model.AllegroSubmittedOn.Value.ToString("g")</span>
                            </div>
                            <div class="info-line">
                                <div class="info-line-icon"><img src="~/images/AllegroIcon.png" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-shopping-bag\'></i>';" /></div>
                                <strong>Nazwa sklepu:</strong> <span>@Model.AllegroStoreName</span>
                            </div>
                        }
                        else
                        {
                            <div class="info-line">
                                <div class="info-line-icon"><i class="fas fa-hourglass-half"></i></div>
                                Użytkownik nie podał jeszcze danych dla Allegro.
                            </div>
                        }
                    </div>
                    </div>
                </div>

                <div class="info-card" style="width: 560px;">
                    <div class="info-card-header">Wiadomość dla Użytkownika</div>

                    @if (Model.UserMessageId.HasValue)
                    {
                        <div style="padding-bottom: 1rem; border-bottom: 1px solid #e9ecef; margin-bottom: 1rem;">
                            <div class="info-line" style="margin-bottom: 0.5rem;">
                                <div class="info-line-icon"><i class="fas fa-calendar-alt"></i></div>
                                <strong>Data utworzenia:</strong>
                                <span>@Model.UserMessageCreatedAt?.ToString("g")</span>
                            </div>
                            <div class="info-line mb-0">
                                <div class="info-line-icon"><i class="fas fa-eye"></i></div>
                                <strong>Status przeczytania:</strong>
                                @if (Model.UserMessageIsRead)
                                {
                                    <span class="status-badge status-active">Przeczytana</span>
                                }
                                else
                                {
                                    <span class="status-badge status-pending">Oczekuje</span>
                                }
                            </div>
                        </div>
                    }

                    <div style="margin-top: 1rem;">
                        <textarea id="messageEditor">@Html.Raw(Model.UserMessageContent)</textarea>
                    </div>

                    <div class="actions-container" style="margin-top: 1rem; justify-content: flex-end;">
                        @if (Model.UserMessageId.HasValue)
                        {
                            <button id="deleteMessageBtn" class="btn btn-danger" data-message-id="@Model.UserMessageId">Usuń wiadomość</button>
                        }
                        <button id="saveMessageBtn" class="btn btn-primary" data-user-code-par="@Model.UserCode" data-message-id="@Model.UserMessageId">Zapisz wiadomość</button>
                    </div>
                    <small id="message-status-text" class="form-text text-muted" style="display:none; margin-top: 5px; text-align: right;"></small>
                </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.tiny.cloud/1/rsom30sn5tjqgz1iq9v5dkrz3lh5neqdcxvhewzzttaolkgh/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sendButton = document.getElementById('send-panel-ready-email-btn');
            const statusText = document.getElementById('email-status-text');
            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

            if (!sendButton) return;

            const userCodePar = sendButton.dataset.userCodePar;
            const actionUrl = sendButton.dataset.controllerUrl;

            const localStorageKey = `panelReadyEmailSent_${userCodePar}`;

            function updateButtonState(state, message) {

                 if (state === 'sent') {
                    sendButton.disabled = true;
                    sendButton.classList.remove('btn-outline-primary');
                    sendButton.classList.add('btn-success');
                    sendButton.innerHTML = '<i class="fas fa-check"></i> Wysłano';
                    statusText.innerText = message || `Powiadomienie zostało wysłane.`;
                    statusText.style.display = 'block';
                } else if (state === 'sending') {
                    sendButton.disabled = true;
                    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Wysyłanie...';
                } else if (state === 'error') {
                    sendButton.disabled = false;
                    sendButton.innerHTML = 'Wyślij e-mail "Panel Gotowy"';
                    statusText.innerText = message || 'Wystąpił błąd. Spróbuj ponownie.';
                    statusText.style.display = 'block';
                    setTimeout(() => { statusText.style.display = 'none'; }, 5000);
                }
            }

            const emailAlreadySent = localStorage.getItem(localStorageKey);
            if (emailAlreadySent) {
                updateButtonState('sent', 'Powiadomienie zostało już wysłane w tej sesji przeglądarki.');
            }

            sendButton.addEventListener('click', function () {
                updateButtonState('sending');

                fetch(actionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiForgeryToken
                    },

                    body: JSON.stringify({ codePAR: userCodePar })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return response.text().then(text => { throw new Error(text || 'Odpowiedź serwera nie jest pomyślna.') });
                })
                .then(data => {
                    console.log('Sukces:', data.message);
                    localStorage.setItem(localStorageKey, 'true');
                    updateButtonState('sent');
                })
                .catch(error => {
                    console.error('Błąd fetch:', error);
                    updateButtonState('error', 'Wystąpił błąd. Sprawdź konsolę deweloperską (F12) po szczegóły.');
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            tinymce.init({
                selector: '#messageEditor',
                plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste code help wordcount',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                height: 590
            });

            const saveBtn = document.getElementById('saveMessageBtn');
            const deleteBtn = document.getElementById('deleteMessageBtn');
            const statusText = document.getElementById('message-status-text');
            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    const content = tinymce.get('messageEditor').getContent();
                    const codePAR = this.dataset.userCodePar;

                    statusText.innerText = 'Zapisywanie...';
                    statusText.style.display = 'block';

                    fetch('@Url.Action("AddOrUpdateUserMessage", "ManagerAffiliate")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiForgeryToken
                        },
                        body: JSON.stringify({ codePAR: codePAR, content: content })
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            statusText.innerText = body.message;

                            this.dataset.messageId = body.messageId;

                             if (!document.getElementById('deleteMessageBtn')) {
                                location.reload();
                             }
                        } else {
                            statusText.innerText = `Błąd: ${body.message}`;
                        }
                    })
                    .catch(error => {
                        statusText.innerText = 'Wystąpił błąd sieciowy.';
                        console.error('Error:', error);
                    });
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (!confirm('Czy na pewno chcesz usunąć tę wiadomość?')) {
                        return;
                    }

                    const messageId = parseInt(this.dataset.messageId, 10);
                    statusText.innerText = 'Usuwanie...';
                    statusText.style.display = 'block';

                    fetch('@Url.Action("DeleteUserMessage", "ManagerAffiliate")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiForgeryToken
                        },
                        body: JSON.stringify({ messageId: messageId })
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            statusText.innerText = body.message;
                            tinymce.get('messageEditor').setContent('');
                            this.style.display = 'none';
                            saveBtn.dataset.messageId = '';
                        } else {
                            statusText.innerText = `Błąd: ${body.message}`;
                        }
                    })
                     .catch(error => {
                        statusText.innerText = 'Wystąpił błąd sieciowy.';
                        console.error('Error:', error);
                    });
                });
            }
        });
    </script>
}