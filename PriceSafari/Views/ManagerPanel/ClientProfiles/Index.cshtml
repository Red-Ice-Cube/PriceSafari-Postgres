@model IEnumerable<PriceSafari.Models.ClientProfile>
@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var users = Model.Where(m => m.CreatedByUser != null)
                     .GroupBy(m => m.CreatedByUser.Id)
                     .Select(g => g.First().CreatedByUser);
}

<style>
    .checkbox-cell {
        cursor: pointer;
    }

    .select-client {
        cursor: pointer;
    }
</style>


<div class="Page-Box" style="min-width:1440px;">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category" style="min-width:128px;">
            <div class="Category-Box-Title">
                Kontakty
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">

            <div class="product-upper-box" style="justify-content: flex-start; gap:16px;">
                <a asp-action="Create" class="Button-Page-Small">Dodaj profil</a>
                <button type="button" class="Button-Page-Small-gr" onclick="exportToCsv()">Eksportuj do CSV</button>
                <a asp-action="Index" asp-controller="ClientProfileScraper" class="Button-Page-Small-r">Scraper Klientów</a>
                <a asp-controller="EmailTemplates" asp-action="Index" class="Button-Page-Small-b" style="background-color:blueviolet">Szablony Wiadomości</a>
                <input type="text" id="accountSearch" placeholder="Wyszukaj firmę">

                <div style="display:flex; flex-direction:column;">
                    <input type="date" class="dateSelect" id="startDate" placeholder="Data od (Nadanie)" />
                    <input type="date" class="dateSelect" id="endDate" placeholder="Data do (Nadanie)" />Wprowa
                </div>

                <select id="createdByFilter" class="DropDown">
                    <option value="">Wszystkie osoby</option>
                    @foreach (var user in users)
                    {
                        <option value="@user.Id.ToString()">@user.PartnerName @user.PartnerSurname</option>
                    }
                </select>

                <select id="statusFilter" class="DropDown">
                    <option value="">Wszystkie statusy</option>
                    @foreach (var status in Enum.GetValues(typeof(PriceSafari.Models.ClientStatus)).Cast<PriceSafari.Models.ClientStatus>())
                    {
                        <option value="@((int)status)">@GetStatusDisplayName(status)</option>
                    }
                </select>

                <select id="sourceFilter" class="DropDown">
                    <option value="">Wszystkie źródła</option>
                    @foreach (var source in Enum.GetValues(typeof(PriceSafari.Models.ClientSource)).Cast<PriceSafari.Models.ClientSource>())
                    {
                        <option value="@((int)source)">@GetSourceDisplayName(source)</option>
                    }
                </select>

                <button type="button" class="Button-Page-Small-b" onclick="sendEmails()">Kokpit wiadomości E-mail</button>
            </div>

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">@TempData["SuccessMessage"]</div>
            }

            <div class="Vert-table">
                <table class="table-orders">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>ID</th>
                            <th>Data Dodania</th>
                            <th>Firma (<span id="accountsCount">0</span>)</th>
                            <th>Email</th>
                            <th>Url</th>
                            <th>Produkty</th>
                            <th>Status</th>
                            <th>Wysłano</th>
                            <th>Nadanie</th>
                            <th>Dodał</th>
                            <th>Źródło</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-contact-id="@item.ClientProfileId" data-contact="@item.ClientProfileId" data-createdby="@item.CreatedByUser?.Id.ToString()" data-status="@((int)item.Status)"
                                data-nadanie="@(item.LastEmailSentDate.HasValue? item.LastEmailSentDate.Value.ToString("yyyy-MM-dd HH:mm") : "")"
                                data-source="@((int)item.Source)">

                                <td class="checkbox-cell">
                                    <input type="checkbox" name="selectedClientIds" value="@item.ClientProfileId" class="select-client" />
                                </td>

                                <td>@item.ClientProfileId</td>
                                <td>@item.CreationDate.ToString("dd-MM-yyyy")</td>
                                <td>@item.CeneoProfileName</td>
                                <td>
                                    @{
                                        var emailAddresses = item.CeneoProfileEmail
                                        ?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                        .Select(e => e.Trim());
                                    }
                                    @if (emailAddresses != null && emailAddresses.Any())
                                    {
                                        foreach (var email in emailAddresses)
                                        {
                                            <div>@email</div>
                                        }
                                    }
                                    else
                                    {
                                        <span>Brak adresu email</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.CeneoProfileUrl))
                                    {
                                        <a href="@item.CeneoProfileUrl" target="_blank" class="Button-Page-Small" onclick="event.stopPropagation()">Ceneo</a>
                                    }
                                    else
                                    {
                                        <span>N/A</span>
                                    }
                                </td>
                                <td>@(item.CeneoProfileProductCount.HasValue? item.CeneoProfileProductCount.ToString() : "N/A")</td>
                                <td>
                                    <span class="badge" style="background-color:@GetStatusColor(item.Status)">
                                        @GetStatusDisplayName(item.Status)
                                    </span>
                                </td>
                                <td>@item.EmailSentCount</td>
                                <td>@(item.LastEmailSentDate.HasValue? item.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "Brak")</td>
                                <td>@item.CreatedByUser?.PartnerName @item.CreatedByUser?.PartnerSurname</td>
                                <td>@GetSourceDisplayName(item.Source)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.table-orders tr[data-contact]').forEach(row => {
        row.addEventListener('click', function (event) {
            if (event.target.closest('.checkbox-cell')) {
                return;
            }
            var clientId = this.getAttribute('data-contact-id');
            window.location.href = '/ClientProfile/Edit/' + clientId;
        });
    });

    function calculateAccounts() {
        let accountsCount = $('.table-orders tbody tr:visible').length;
        document.getElementById('accountsCount').innerText = accountsCount;
    }

    document.querySelectorAll('.checkbox-cell').forEach(cell => {
        cell.addEventListener('click', function (event) {
            var checkbox = this.querySelector('.select-client');
            if (event.target === checkbox) {
                return;
            }
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        });
    });

    document.getElementById('select-all').addEventListener('change', function () {
        var isChecked = this.checked;
        var rows = document.querySelectorAll('.table-orders tbody tr');
        rows.forEach(function (row) {
            var style = window.getComputedStyle(row);
            if (style.display !== 'none') {
                var checkbox = row.querySelector('.select-client');
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            }
        });
    });

    $(document).ready(function () {
        function filterTable() {
            var searchText = $('#accountSearch').val().toLowerCase();
            var selectedUserId = $('#createdByFilter').val();
            var selectedStatus = $('#statusFilter').val();
            var selectedSource = $('#sourceFilter').val(); // Nowy filtr dla źródła

            var startDateVal = $('#startDate').val();
            var endDateVal   = $('#endDate').val();

            var startDate = startDateVal ? new Date(startDateVal) : null;
            var endDate   = endDateVal   ? new Date(endDateVal)   : null;

            $('.table-orders tbody tr').each(function () {
                var contactName = $(this).find('td:nth-child(4)').text().toLowerCase(); // 'Firma' column
                var createdByUserId = $(this).data('createdby') ? $(this).data('createdby').toString() : '';
                var status = $(this).data('status') !== undefined ? $(this).data('status').toString() : '';
                var source = $(this).data('source') !== undefined ? $(this).data('source').toString() : ''; // Pobieranie źródła

                var nadanieVal = $(this).data('nadanie');
                var rowDate = nadanieVal ? new Date(nadanieVal) : null;

                var matchesSearch = contactName.indexOf(searchText) > -1;
                var matchesUser = selectedUserId === '' || createdByUserId == selectedUserId;
                var matchesStatus = selectedStatus === '' || status == selectedStatus;
                var matchesSource = selectedSource === '' || source == selectedSource; // Filtr po źródle

                var matchesDate = true;
                if (startDate && (!rowDate || rowDate < startDate)) {
                    matchesDate = false;
                }
                if (endDate && (!rowDate || rowDate > endDate)) {
                    matchesDate = false;
                }

                var shouldShow = matchesSearch && matchesUser && matchesStatus && matchesDate && matchesSource;
                $(this).toggle(shouldShow);
            });

            calculateAccounts();
            $('#select-all').prop('checked', false);
        }

        $('#startDate').on('change', filterTable);
        $('#endDate').on('change', filterTable);
        $('#accountSearch').on('keyup', filterTable);
        $('#createdByFilter').on('change', filterTable);
        $('#statusFilter').on('change', filterTable);
        $('#sourceFilter').on('change', filterTable); // Podłączanie zdarzenia do nowego filtra źródła

        calculateAccounts();
    });

    function exportToCsv() {
        const emails = [];
        document.querySelectorAll('.select-client:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                const emailDivs = row.querySelectorAll('td:nth-child(5) div');
                emailDivs.forEach(div => {
                    emails.push(div.textContent.trim());
                });
            }
        });

        if (emails.length === 0) {
            alert('Wybierz klientów, aby wyeksportować ich adresy e-mail!');
            return;
        }

        let csvContent = "Email\n";
        csvContent += emails.join("\n");

        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        link.setAttribute("href", url);
        link.setAttribute("download", "eksport_maili.csv");
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function sendEmails() {
        var selectedIds = [];
        document.querySelectorAll('.select-client:checked')
            .forEach(checkbox => selectedIds.push(parseInt(checkbox.value)));

        if (selectedIds.length === 0) {
            alert('Wybierz klientów!');
            return;
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/ClientProfile/PrepareEmails';

        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = '__RequestVerificationToken';
        tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
        form.appendChild(tokenInput);

        selectedIds.forEach(id => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'SelectedClientIds';
            hidden.value = id;
            form.appendChild(hidden);
        });

        document.body.appendChild(form);
        form.submit();
    }
</script>


@functions {
    public string GetStatusColor(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "#17a2b8",
            PriceSafari.Models.ClientStatus.Mail => "#ffc107",
            PriceSafari.Models.ClientStatus.Urabiany => "#28a745",
            PriceSafari.Models.ClientStatus.Spotkanie => "#007bff",
            PriceSafari.Models.ClientStatus.Testuje => "#6f42c1",
            PriceSafari.Models.ClientStatus.ZaDużaRyba => "#004552",
            PriceSafari.Models.ClientStatus.Płotka => "#C823CB",
            PriceSafari.Models.ClientStatus.Frajer => "#000",
            PriceSafari.Models.ClientStatus.Ojebane => "#dc3545",
            _ => "#6c757d"
        };
    }

    public string GetStatusDisplayName(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "Nowy Kontakt",
            PriceSafari.Models.ClientStatus.Mail => "Wysłano Maila",
            PriceSafari.Models.ClientStatus.Urabiany => "Rozmowy w toku",
            PriceSafari.Models.ClientStatus.Spotkanie => "Umówiono Spotkanie",
            PriceSafari.Models.ClientStatus.Testuje => "Testuje oprogramowanie",
            PriceSafari.Models.ClientStatus.ZaDużaRyba => "ZaDużaRyba - Produktów w chuj",
            PriceSafari.Models.ClientStatus.Płotka => "Płotka - Mało produktów",
            PriceSafari.Models.ClientStatus.Frajer => "Klient frajer",
            PriceSafari.Models.ClientStatus.Ojebane => "Oprogramowanie ojebane",
            _ => "Nieznany"
        };
    }

    // Nowa funkcja do wyświetlania nazwy źródła
    public string GetSourceDisplayName(PriceSafari.Models.ClientSource source)
    {
        return source switch
        {
            PriceSafari.Models.ClientSource.Ceneo => "Ceneo",
            PriceSafari.Models.ClientSource.Google => "Google",
            _ => "Nieznane"
        };
    }
}
@Html.AntiForgeryToken()