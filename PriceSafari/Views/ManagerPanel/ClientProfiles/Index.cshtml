@model IEnumerable<PriceSafari.Models.ClientProfile>

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    // Get distinct users who have created profiles
    var users = Model.Where(m => m.CreatedByUser != null)
                     .GroupBy(m => m.CreatedByUser.Id)
                     .Select(g => g.First().CreatedByUser);
}

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Kontakty
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">
            <div class="product-upper-box">
                <div>
                    <a class="Button-Page-Small" asp-action="Create">Dodaj nowy profil</a>
                </div>
                <div class="order-search-box">
                    <input type="text" id="accountSearch" placeholder="Wyszukaj firmę">
                    <select id="createdByFilter" class="DropDown">
                        <option value="">Wszystkie osoby</option>
                        @foreach (var user in users)
                        {
                            <option value="@user.Id.ToString()">@user.PartnerName @user.PartnerSurname</option>
                        }
                    </select>

                    <select id="statusFilter" class="DropDown">
                        <option value="">Wszystkie statusy</option>
                        @foreach (var status in Enum.GetValues(typeof(PriceSafari.Models.ClientStatus)).Cast<PriceSafari.Models.ClientStatus>())
                        {
                            <option value="@((int)status)">@GetStatusDisplayName(status)</option>
                        }
                    </select>
                </div>
               
            </div>
            <div class="Vert-table">
                <table class="table-orders">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data Dodania</th>
                            <th>Firma (<span id="accountsCount">0</span>)</th>
                            <th>Email</th>
                            <th>Telefon</th>
                            <th>Url</th>
                            <th>Produkty</th>
                            <th>Status</th>
                            <th>Dodał</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-contact="@item.ClientProfileId" data-createdby="@item.CreatedByUser?.Id.ToString()" data-status="@((int)item.Status)" style="cursor:pointer;">
                                <td>@item.ClientProfileId</td>
                                <td>@item.CreationDate.ToString("dd-MM-yyyy")</td>
                                <td>@item.CeneoProfileName</td>
                                <td>@item.CeneoProfileEmail</td>
                                <td>@item.CeneoProfileTelephone</td>
                                <td>@item.CeneoProfileUrl</td>
                                <td>@item.CeneoProfileProductCount</td>
                                <td>
                                    <span class="badge" style="background-color:@GetStatusColor(item.Status)">
                                        @GetStatusDisplayName(item.Status)
                                    </span>
                                </td>
                                <td>@item.CreatedByUser?.PartnerName @item.CreatedByUser?.PartnerSurname</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Enable row click to navigate to Edit page
        document.querySelectorAll('.table-orders tr[data-contact]').forEach(row => {
            row.addEventListener('click', function () {
                var clientId = this.getAttribute('data-contact');
                window.location.href = '/ClientProfile/Edit/' + clientId;
            });
        });

        // Initial calculation of accounts
        calculateAccounts();
    });

    function calculateAccounts() {
        let accountsCount = $('.table-orders tbody tr:visible').length;
        document.getElementById('accountsCount').innerText = accountsCount;
    }

    $(document).ready(function () {
        function filterTable() {
            var searchText = $('#accountSearch').val().toLowerCase();
            var selectedUserId = $('#createdByFilter').val();
            var selectedStatus = $('#statusFilter').val();

            $('.table-orders tbody tr').each(function () {
                var contactName = $(this).find('td:nth-child(3)').text().toLowerCase(); // 'Firma' column
                var createdByUserId = $(this).data('createdby') ? $(this).data('createdby').toString() : '';
                var status = $(this).data('status') !== undefined ? $(this).data('status').toString() : '';

                var matchesSearch = contactName.indexOf(searchText) > -1;
                var matchesUser = selectedUserId === '' || createdByUserId == selectedUserId;
                var matchesStatus = selectedStatus === '' || status == selectedStatus;

                $(this).toggle(matchesSearch && matchesUser && matchesStatus);
            });

            // Recalculate accounts count
            calculateAccounts();
        }

        // Attach event handlers
        $('#accountSearch').on('keyup', filterTable);
        $('#createdByFilter').on('change', filterTable);
        $('#statusFilter').on('change', filterTable);
    });
</script>

@functions {
    public string GetStatusColor(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "#17a2b8",
            PriceSafari.Models.ClientStatus.Mail => "#ffc107",
            PriceSafari.Models.ClientStatus.Urabiany => "#28a745",
            PriceSafari.Models.ClientStatus.Spotkanie => "#007bff",
            PriceSafari.Models.ClientStatus.Testuje => "#6f42c1",
            PriceSafari.Models.ClientStatus.Frajer => "#000",
            PriceSafari.Models.ClientStatus.Ojebane => "#dc3545",
            _ => "#6c757d"
        };
    }

    public string GetStatusDisplayName(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "Nowy Kontakt",
            PriceSafari.Models.ClientStatus.Mail => "Wysłano Maila",
            PriceSafari.Models.ClientStatus.Urabiany => "Rozmowy w toku",
            PriceSafari.Models.ClientStatus.Spotkanie => "Umówiono Spotkanie",
            PriceSafari.Models.ClientStatus.Testuje => "Testuje oprogramowanie",
            PriceSafari.Models.ClientStatus.Frajer => "Klient frajer",
            PriceSafari.Models.ClientStatus.Ojebane => "Oprogramowanie ojebane",
            _ => "Nieznany"
        };
    }
}
