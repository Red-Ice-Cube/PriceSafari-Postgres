


@model IEnumerable<PriceSafari.Models.ClientProfile>
@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";  
    var users = Model.Where(m => m.CreatedByUser != null)
                     .GroupBy(m => m.CreatedByUser.Id)
                     .Select(g => g.First().CreatedByUser);
}

<style>
    .checkbox-cell {
        cursor: pointer;
    }
    

    .select-client {
        cursor: pointer;
    }
</style>


<div class="Page-Box" style="min-width:1440px;">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category" style="min-width:128px;">
            <div class="Category-Box-Title">
                Kontakty
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">

            <div class="product-upper-box" style="justify-content: flex-start; gap:16px;">
                <a asp-action="Create" class="Button-Page-Small">Dodaj profil</a>
                <button type="button" class="Button-Page-Small-gr" onclick="exportToCsv()">Eksportuj do CSV</button>
                <a asp-action="Index" asp-controller="ClientProfileScraper" class="Button-Page-Small-r">Scraper Klientów</a>
               
                
                    <input type="text" id="accountSearch" placeholder="Wyszukaj firmę">

                    <div style="display:flex; flex-direction:column;">
                        <input type="date" class="dateSelect" id="startDate" placeholder="Data od (Nadanie)" />
                        <input type="date" class="dateSelect" id="endDate" placeholder="Data do (Nadanie)" />
                    </div>

                    <select id="createdByFilter" class="DropDown">
                        <option value="">Wszystkie osoby</option>
                        @foreach (var user in users)
                        {
                            <option value="@user.Id.ToString()">@user.PartnerName @user.PartnerSurname</option>
                        }
                    </select>

                    <select id="statusFilter" class="DropDown">
                        <option value="">Wszystkie statusy</option>
                        @foreach (var status in Enum.GetValues(typeof(PriceSafari.Models.ClientStatus)).Cast<PriceSafari.Models.ClientStatus>())
                        {
                            <option value="@((int)status)">@GetStatusDisplayName(status)</option>
                        }
                    </select>

                

                    <button type="button" class="Button-Page-Small-b" onclick="sendEmails()">Kokpit wiadomości E-mail</button>
             

               
            </div>

            <!-- Display any messages -->
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">@TempData["SuccessMessage"]</div>
            }

            <div class="Vert-table">
                <table class="table-orders">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>ID</th>
                            <th>Data Dodania</th>
                            <th>Firma (<span id="accountsCount">0</span>)</th>
                            <th>Email</th>
                            <th>Url</th>
                            <th>Produkty</th>
                            <th>Status</th>
                            <th>Wysłano</th>
                            <th>Nadanie</th>
                            <th>Dodał</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-contact-id="@item.ClientProfileId" data-contact="@item.ClientProfileId" data-createdby="@item.CreatedByUser?.Id.ToString()" data-status="@((int)item.Status)"
                                data-nadanie="@(item.LastEmailSentDate.HasValue ? item.LastEmailSentDate.Value.ToString("yyyy-MM-dd HH:mm") : "")">
                                

                                <td class="checkbox-cell">
                                    <input type="checkbox" name="selectedClientIds" value="@item.ClientProfileId" class="select-client" />
                                </td>

                                <td>@item.ClientProfileId</td>
                                <td>@item.CreationDate.ToString("dd-MM-yyyy")</td>
                                <td>@item.CeneoProfileName</td>
                                <td>
                                    @{
                                        var emailAddresses = item.CeneoProfileEmail
                                        ?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                        .Select(e => e.Trim());
                                    }
                                    @if (emailAddresses != null && emailAddresses.Any())
                                    {
                                        foreach (var email in emailAddresses)
                                        {
                                            <div>@email</div>
                                        }
                                    }
                                    else
                                    {
                                        <span>Brak adresu email</span>
                                    }
                                </td>


                                <td>
                                    <a href="@item.CeneoProfileUrl" target="_blank" class="Button-Page-Small" onclick="event.stopPropagation()">Ceneo</a>
                                </td>
                                <td>@item.CeneoProfileProductCount</td>
                                <td>
                                    <span class="badge" style="background-color:@GetStatusColor(item.Status)">
                                        @GetStatusDisplayName(item.Status)
                                    </span>
                                </td>
                                <td>@item.EmailSentCount</td>
                                <td>@(item.LastEmailSentDate.HasValue ? item.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "Brak")</td>
                                <td>@item.CreatedByUser?.PartnerName @item.CreatedByUser?.PartnerSurname</td>
                            </tr>
                          
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.table-orders tr[data-contact]').forEach(row => {
        row.addEventListener('click', function (event) {
            // Sprawdź, czy kliknięty element lub jego rodzice mają klasę 'checkbox-cell'
            if (event.target.closest('.checkbox-cell')) {
                // Jeśli tak, nie rób nic (już obsłużyliśmy kliknięcie w checkbox)
                return;
            }

            var clientId = this.getAttribute('data-contact-id');
            window.location.href = '/ClientProfile/Edit/' + clientId;
        });
    });

    // Funkcja do przeliczania liczby kont
    function calculateAccounts() {
        let accountsCount = $('.table-orders tbody tr:visible').length;
        document.getElementById('accountsCount').innerText = accountsCount;
    }

    

    document.querySelectorAll('.checkbox-cell').forEach(cell => {
        cell.addEventListener('click', function (event) {
            // Znajdź checkbox wewnątrz klikniętego td
            var checkbox = this.querySelector('.select-client');

            // Jeśli kliknięto checkbox bezpośrednio, zachowaj jego domyślne działanie
            if (event.target === checkbox) {
                return;
            }

            // Przełączamy stan checkboxa, jeśli kliknięto poza checkboxem, ale w obrębie td
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        });
    });


    // Obsługa checkboxa "Zaznacz wszystkie"
    document.getElementById('select-all').addEventListener('change', function () {
        var isChecked = this.checked;
        var rows = document.querySelectorAll('.table-orders tbody tr');
        rows.forEach(function (row) {
            var style = window.getComputedStyle(row);
            if (style.display !== 'none') {
                var checkbox = row.querySelector('.select-client');
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            }
        });
    });

     $(document).ready(function () {
        function filterTable() {
            var searchText = $('#accountSearch').val().toLowerCase();
            var selectedUserId = $('#createdByFilter').val();
            var selectedStatus = $('#statusFilter').val();

            // Pobieramy zakres dat z inputów
            var startDateVal = $('#startDate').val();
            var endDateVal   = $('#endDate').val();

            // Jeśli pola nie są uzupełnione, będą null-ami
            var startDate = startDateVal ? new Date(startDateVal) : null;
            var endDate   = endDateVal   ? new Date(endDateVal)   : null;

            $('.table-orders tbody tr').each(function () {
                var contactName = $(this).find('td:nth-child(4)').text().toLowerCase(); // 'Firma' column
                var createdByUserId = $(this).data('createdby') ? $(this).data('createdby').toString() : '';
                var status = $(this).data('status') !== undefined ? $(this).data('status').toString() : '';

                // Odczytujemy datę z atrybutu data-nadanie
                var nadanieVal = $(this).data('nadanie'); // np. "2024-02-28 10:30"
                // Jeśli puste, to wiersz nie ma ustawionej daty
                var rowDate = nadanieVal ? new Date(nadanieVal) : null;

                // Dotychczasowe filtry
                var matchesSearch = contactName.indexOf(searchText) > -1;
                var matchesUser = selectedUserId === '' || createdByUserId == selectedUserId;
                var matchesStatus = selectedStatus === '' || status == selectedStatus;

                var matchesDate = true; // domyślnie true

                if (startDate && (!rowDate || rowDate < startDate)) {
                    matchesDate = false;
                }
                if (endDate && (!rowDate || rowDate > endDate)) {
                    matchesDate = false;
                }

                var shouldShow = matchesSearch && matchesUser && matchesStatus && matchesDate;
                $(this).toggle(shouldShow);
            });

            // Przeliczenie liczby kont po zastosowaniu filtru
            calculateAccounts();

            // Zresetuj checkbox "Zaznacz wszystkie" po filtrowaniu
            $('#select-all').prop('checked', false);
        }

        // Podłączamy zdarzenia do naszych inputów dat
        $('#startDate').on('change', filterTable);
        $('#endDate').on('change', filterTable);

        // Pozostałe zdarzenia
        $('#accountSearch').on('keyup', filterTable);
        $('#createdByFilter').on('change', filterTable);
        $('#statusFilter').on('change', filterTable);

        // Na starcie przelicz liczbę kont
        calculateAccounts();
    });



        function exportToCsv() {
        // 1. Zbierz wszystkie e-maile z zaznaczonych i widocznych wierszy
        const emails = [];
        document.querySelectorAll('.select-client:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');

            // Upewnij się, że przetwarzamy tylko widoczne wiersze (po filtrowaniu)
            if (row.style.display !== 'none') {
                // Znajdź wszystkie divy z emailami w 5. kolumnie (td)
                const emailDivs = row.querySelectorAll('td:nth-child(5) div');
                emailDivs.forEach(div => {
                    emails.push(div.textContent.trim());
                });
            }
        });

        // 2. Sprawdź, czy cokolwiek zostało wybrane
        if (emails.length === 0) {
            alert('Wybierz klientów, aby wyeksportować ich adresy e-mail!');
            return;
        }

        // 3. Przygotuj zawartość pliku CSV
        // Dodajemy nagłówek kolumny
        let csvContent = "Email\n";
        // Dodajemy każdy email w nowej linii
        csvContent += emails.join("\n");

        // 4. Stwórz i pobierz plik CSV
        // Używamy BOM, aby Excel poprawnie rozpoznał kodowanie UTF-8
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        link.setAttribute("href", url);
        link.setAttribute("download", "eksport_maili.csv");
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function sendEmails() {
        var selectedIds = [];
        document.querySelectorAll('.select-client:checked')
            .forEach(checkbox => selectedIds.push(parseInt(checkbox.value)));

        if (selectedIds.length === 0) {
            alert('Wybierz klientów!');
            return;
        }

        // Tworzysz formularz w locie
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/ClientProfile/PrepareEmails';

        // Dodaj token antyforgery
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = '__RequestVerificationToken';
        tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
        form.appendChild(tokenInput);

        // Dodaj ID klientów
        selectedIds.forEach(id => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'SelectedClientIds';
            hidden.value = id;
            form.appendChild(hidden);
        });

        document.body.appendChild(form);
        form.submit();
    }

</script>



@functions {
    public string GetStatusColor(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "#17a2b8",
            PriceSafari.Models.ClientStatus.Mail => "#ffc107",
            PriceSafari.Models.ClientStatus.Urabiany => "#28a745",
            PriceSafari.Models.ClientStatus.Spotkanie => "#007bff",
            PriceSafari.Models.ClientStatus.Testuje => "#6f42c1",
            PriceSafari.Models.ClientStatus.ZaDużaRyba => "#004552",
            PriceSafari.Models.ClientStatus.Płotka => "#C823CB",
            PriceSafari.Models.ClientStatus.Frajer => "#000",
            PriceSafari.Models.ClientStatus.Ojebane => "#dc3545",
            _ => "#6c757d"
        };
    }

    public string GetStatusDisplayName(PriceSafari.Models.ClientStatus status)
    {
        return status switch
        {
            PriceSafari.Models.ClientStatus.Nowy => "Nowy Kontakt",
            PriceSafari.Models.ClientStatus.Mail => "Wysłano Maila",
            PriceSafari.Models.ClientStatus.Urabiany => "Rozmowy w toku",
            PriceSafari.Models.ClientStatus.Spotkanie => "Umówiono Spotkanie",
            PriceSafari.Models.ClientStatus.Testuje => "Testuje oprogramowanie",
            PriceSafari.Models.ClientStatus.ZaDużaRyba => "ZaDużaRyba - Produktów w chuj",
            PriceSafari.Models.ClientStatus.Płotka => "Płotka - Mało produktów",
            PriceSafari.Models.ClientStatus.Frajer => "Klient frajer",
            PriceSafari.Models.ClientStatus.Ojebane => "Oprogramowanie ojebane",
            _ => "Nieznany"
        };
    }
}

<!-- Include the anti-forgery token -->
@Html.AntiForgeryToken()

