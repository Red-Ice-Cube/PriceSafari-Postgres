@model SendEmailViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<script src="https://cdn.tiny.cloud/1/rsom30sn5tjqgz1iq9v5dkrz3lh5neqdcxvhewzzttaolkgh/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Wysyłka
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">

            <form method="post" asp-action="ConfirmSendEmails">
                @Html.AntiForgeryToken()

                @foreach (var clientId in Model.SelectedClientIds)
                {
                    <input type="hidden" name="SelectedClientIds" value="@clientId" />
                }

                <div style="margin-bottom: 15px; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="font-weight:bold; color: #333;">Wybierz konto wysyłkowe:</label><br />
                    <select name="SenderAccount" style="padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="Biuro" selected>Biuro (biuro@pricesafari.pl)</option>
                        <option value="Jakub">Jakub</option>
                    </select>
                </div>

                <input type="hidden" id="HiddenSelectedMailType" name="SelectedMailType" value="@Model.SelectedMailType" />

                <div class="Vert-table" style="height:20vh;">
                    <table class="table-orders">
                        <thead>
                            <tr>
                                <th>Klienci (@Model.Clients.Count)</th>
                                <th>E-mail</th>
                                <th>Ilość produktów</th>
                                <th>Wysłane</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var client in Model.Clients)
                            {
                                <tr>
                                    <td>@client.CeneoProfileName</td>
                                    <td>@client.CeneoProfileEmail</td>
                                    <td>@client.CeneoProfileProductCount</td>
                                    <td>@client.EmailSentCount</td>
                                    <td>@(client.LastEmailSentDate.HasValue? client.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <input type="hidden" id="HiddenSelectedMailType" name="SelectedMailType" value="@Model.SelectedMailType" />

                <div style="margin-bottom: 15px; margin-top: 15px;">
                    <label style="font-weight:bold;">Wybierz szablon wiadomości:</label><br />
                    <select id="SelectedMailType" style="padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px;">
                        @if (Model.AvailableTemplates != null)
                        {
                            foreach (var template in Model.AvailableTemplates)
                            {
                                <!option value="@template.Id" @(template.Id == Model.SelectedMailType ? "selected" : "")>
                                @template.Name
                                </!option>
                            }
                        }
                        else
                        {
                            <option value="0">Brak szablonów w bazie</option>
                        }
                    </select>
                </div>

                <div>
                    <label style="font-weight:bold;">Treść wiadomości (edytowalna):</label>
                    <textarea id="EmailContentEditor" name="EmailContent">
                        @Html.Raw(Model.EmailContent)
                    </textarea>
                </div>

                <div style="margin-top: 20px;">
                    <label for="EmailSubject" style="font-weight:bold;">Temat Emaila:</label><br />
                    <input type="text" name="EmailSubject" id="EmailSubject" value="@Model.EmailSubject" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
                </div>

                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    Dostępne zmienne: <strong>{ProductCount}</strong> (liczba produktów), <strong>{ClientName}</strong> (nazwa firmy).
                </p>

                <button type="submit" class="Button-Page-Small-r" style="margin-top:10px;">Wyślij E-maile</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Inicjalizacja TinyMCE
    tinymce.init({
        selector: '#EmailContentEditor',
        height: 600,
        plugins: 'image link code lists',
        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | code',
        verify_html: false
    });

    $(document).ready(function() {
        // Obsługa zmiany szablonu
        $('#SelectedMailType').change(function() {
            var selectedTemplateId = $(this).val();
            console.log("Wybrano ID szablonu:", selectedTemplateId);

            // Aktualizujemy hidden input (żeby formularz wiedział co wysłać, choć teraz ważniejszy jest Content)
            $('#HiddenSelectedMailType').val(selectedTemplateId);

            var selectedClientIds = [];
            $('input[name="SelectedClientIds"]').each(function() {
                selectedClientIds.push(parseInt($(this).val()));
            });

            // Pobieramy treść i temat z bazy
            $.ajax({
                url: '/ClientProfile/ChangeMailTypeAjax',
                type: 'POST',
                data: {
                    mailType: parseInt(selectedTemplateId), // To teraz ID z bazy
                    selectedClientIds: selectedClientIds
                },
                traditional: true,
                success: function (response) {
                    if (response) {
                        // 1. Aktualizacja TinyMCE
                        if (response.content) {
                            if (tinymce.get('EmailContentEditor')) {
                                tinymce.get('EmailContentEditor').setContent(response.content);
                            } else {
                                $('#EmailContentEditor').val(response.content);
                            }
                        }

                        // 2. Aktualizacja Tematu
                        if (response.subject) {
                            $('#EmailSubject').val(response.subject);
                        }
                    }
                },
                error: function (xhr) {
                    console.error("Błąd AJAX:", xhr);
                    alert('Nie udało się pobrać treści szablonu.');
                }
            });
        });
    });
</script>