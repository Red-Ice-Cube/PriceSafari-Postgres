@model SendEmailViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<script src="https://cdn.tiny.cloud/1/rsom30sn5tjqgz1iq9v5dkrz3lh5neqdcxvhewzzttaolkgh/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Wysyłka
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">

            <form method="post" asp-action="ConfirmSendEmails">
                @Html.AntiForgeryToken()

                @foreach (var clientId in Model.SelectedClientIds)
                {
                    <input type="hidden" name="SelectedClientIds" value="@clientId" />
                }

                <div class="Vert-table" style="height:20vh;">
                    <table class="table-orders">
                        <thead>
                            <tr>
                                <th>Klienci (@Model.Clients.Count)</th>
                                <th>E-mail</th>
                                <th>Ilość produktów</th>
                                <th>Liczba Wysłanych Emaili</th>
                                <th>Data Ostatniego Emaila</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var client in Model.Clients)
                            {
                                <tr>
                                    <td>@client.CeneoProfileName</td>
                                    <td>
                                        @{
                                            var emailAddresses = client.CeneoProfileEmail
                                            ?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                            .Select(e => e.Trim());
                                        }
                                        @if (emailAddresses != null && emailAddresses.Any())
                                        {
                                            foreach (var email in emailAddresses)
                                            {
                                                <div>@email</div>
                                            }
                                        }
                                        else
                                        {
                                            <span>Brak adresu email</span>
                                        }
                                    </td>
                                    <td>@client.CeneoProfileProductCount</td>
                                    <td>@client.EmailSentCount</td>
                                    <td>@(client.LastEmailSentDate.HasValue? client.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "Brak")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <input type="hidden" id="HiddenSelectedMailType" name="SelectedMailType" value="@Model.SelectedMailType" />

                <div id="mailTypeDropdownContainer" style="margin-bottom: 10px; margin-top: 10px;">
                </div>

                <div>
                    <label>Treść wiadomości (edytowalna):</label>
                    <textarea id="EmailContentEditor" name="EmailContent">
                        @Html.Raw(Model.EmailContent)
                    </textarea>
                </div>

                <div style="margin-top: 20px;">
                    <label for="EmailSubject">Temat Emaila:</label><br />
                    <input type="text" name="EmailSubject" id="EmailSubject" value="@Model.EmailSubject" style="width: 100%; padding: 5px;" />
                </div>

                <p style="margin-top: 10px;">
                    Treść wiadomości zawiera zastępniki, np.:<br />
                    <strong>{ProductCount}</strong> – zostanie zastąpione liczbą produktów klienta (tylko w tych mailach, gdzie to ma sens)<br />
                    <strong>{ClientName}</strong> – zostanie zastąpione nazwą klienta.
                </p>

                <button type="submit" class="Button-Page-Small-r">Wyślij E-maile</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Inicjalizacja TinyMCE - musi być poza document.ready w niektórych przypadkach, ale tutaj jest OK
    // Ważne: Selector musi pasować do ID textarea powyżej (#EmailContentEditor)
    tinymce.init({
        selector: '#EmailContentEditor',
        height: 600,
        plugins: 'image link code lists',
        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | code',
        verify_html: false
    });

    $(document).ready(function() {
        console.log("document.ready - start!");

        // Generowanie dropdown
        var mailTypes = [
            { value: 1, text: 'Mail 1' },
            { value: 2, text: 'Mail 2' },
            { value: 3, text: 'Mail 3' }
        ];
        var dropdownHtml = '<label>Wybierz szablon:</label><br />' +
                           '<select id="SelectedMailType" style="padding: 5px;">';
        mailTypes.forEach(function(item) {
            dropdownHtml += '<option value="' + item.value + '">' + item.text + '</option>';
        });
        dropdownHtml += '</select>';

        $('#mailTypeDropdownContainer').html(dropdownHtml);

        // Ustawienie początkowej wartości selecta
        var initialType = $('#HiddenSelectedMailType').val();
        if(initialType) {
            $('#SelectedMailType').val(initialType);
        }

        // Obsługa zmiany rodzaju maila
        $('#SelectedMailType').change(function() {
            var selectedMailType = $(this).val();
            console.log("Zmieniono mailType na:", selectedMailType);

            // Ustaw hidden input dla typu maila
            $('#HiddenSelectedMailType').val(selectedMailType);

            var selectedClientIds = [];
            $('input[name="SelectedClientIds"]').each(function() {
                selectedClientIds.push(parseInt($(this).val()));
            });

            // Pobieranie nowej treści AJAXem
            $.ajax({
                url: '/ClientProfile/ChangeMailTypeAjax',
                type: 'POST',
                data: {
                    mailType: parseInt(selectedMailType),
                    selectedClientIds: selectedClientIds
                },
                traditional: true,
                success: function (response) {
                    console.log("Odebrano z serwera:", response);
                    if (response && response.content) {

                        // Aktualizacja TinyMCE
                        if (tinymce.get('EmailContentEditor')) {
                            tinymce.get('EmailContentEditor').setContent(response.content);
                        } else {
                            $('#EmailContentEditor').val(response.content);
                        }

                    } else {
                        console.warn("W odpowiedzi brak klucza 'content'.", response);
                    }
                },
                error: function (xhr) {
                    console.error("Błąd AJAX:", xhr);
                    alert('Błąd podczas pobierania treści maila.');
                }
            });
        });
    });
</script>