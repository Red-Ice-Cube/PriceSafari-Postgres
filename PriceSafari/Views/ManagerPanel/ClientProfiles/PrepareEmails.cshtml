@model SendEmailViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Wysyłka
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">



            





            <!-- Formularz wysyłający wybrane typy maila do ConfirmSendEmails -->
            <form method="post" asp-action="ConfirmSendEmails">
                @Html.AntiForgeryToken()

                <!-- Ukryte ID klientów -->
                @foreach (var clientId in Model.SelectedClientIds)
                {
                    <input type="hidden" name="SelectedClientIds" value="@clientId" />
                }



                <!-- Ukryte pole dla EmailContent -->
                <input type="hidden" name="EmailContent" value="@Model.EmailContent" />


                <div class="Vert-table" style="height:20vh;">


                    <table class="table-orders">
                        <thead>
                            <tr>

                                <th>Klienci (@Model.Clients.Count)</th>
                                <th>E-mail</th>
                                <th>Ilość produktów</th>
                                <th>Liczba Wysłanych Emaili</th>
                                <th>Data Ostatniego Emaila</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var client in Model.Clients)
                            {
                                <tr>

                                    <td>@client.CeneoProfileName</td>
                                    <td>
                                        @{
                                            var emailAddresses = client.CeneoProfileEmail
                                            ?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                            .Select(e => e.Trim());
                                        }
                                        @if (emailAddresses != null && emailAddresses.Any())
                                        {
                                            foreach (var email in emailAddresses)
                                            {
                                                <div>@email</div>
                                            }
                                        }
                                        else
                                        {
                                            <span>Brak adresu email</span>
                                        }
                                    </td>

                                    <td>@client.CeneoProfileProductCount</td>
                                    <td>@client.EmailSentCount</td>
                                    <td>@(client.LastEmailSentDate.HasValue ? client.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "Brak")</td>



                                </tr>

                            }
                        </tbody>
                    </table>
                </div>


                <!-- Ukryte pole do SelectedMailType (zostanie wypełnione w JS) -->
                <input type="hidden" id="HiddenSelectedMailType" name="SelectedMailType" value="@Model.SelectedMailType" />

                <!-- Kontener, w którym utworzymy dropdown z JS -->
                <div id="mailTypeDropdownContainer" style="margin-bottom: 2px;">
                    
                </div>
                <div>
               
                    <div id="mailContentPreview" style="border: 1px solid #ccc; padding: 10px; max-height: 700px; overflow-y: auto;">
                        @Html.Raw(Model.EmailContent)
                    </div>
                </div>


                <div style="margin-top: 20px;">
                    <label for="EmailSubject">Temat Emaila:</label><br />
                    <input type="text" name="EmailSubject" id="EmailSubject" value="@Model.EmailSubject" />
                </div>

                <p style="margin-top: 10px;">
                    Treść wiadomości zawiera zastępniki, np.:<br />
                    <strong>{ProductCount}</strong> – zostanie zastąpione liczbą produktów klienta (tylko w tych mailach, gdzie to ma sens)
                </p>

                <button type="submit" class="Button-Page-Small-r">Wyślij E-maile</button>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        console.log("document.ready - start!");

        // Generowanie dropdown
        var mailTypes = [
            { value: 1, text: 'Mail 1' },
            { value: 2, text: 'Mail 2' },
            { value: 3, text: 'Mail 3' }
        ];
        var dropdownHtml = '<label>Wybierz rodzaj maila (JS):</label><br />' +
                           '<select id="SelectedMailType">';
        mailTypes.forEach(function(item) {
            dropdownHtml += '<option value="' + item.value + '">' + item.text + '</option>';
        });
        dropdownHtml += '</select>';

        $('#mailTypeDropdownContainer').html(dropdownHtml);

        // Obsługa zmiany rodzaju maila
        $('#SelectedMailType').change(function() {
            var selectedMailType = $(this).val();
            console.log("Zmieniono mailType na:", selectedMailType);

            // Ustaw hidden input w formularzu:
            $('#HiddenSelectedMailType').val(selectedMailType);

            // Zbierz ID klientów:
            var selectedClientIds = [];
            $('input[name="SelectedClientIds"]').each(function() {
                selectedClientIds.push(parseInt($(this).val()));
            });

               $.ajax({
        url: '/ClientProfile/ChangeMailTypeAjax',
        type: 'POST',
        data: {
            mailType: parseInt(selectedMailType),
            selectedClientIds: selectedClientIds
        },
        traditional: true, // <- aby listy przesyłały się w formacie ?selectedClientIds=2&selectedClientIds=3
        success: function (response) {
            // Tutaj mamy dostęp do danych zwróconych przez kontroler
            console.log("Odebrano z serwera:", response);
            if (response && response.content) {
                // 1) Podmień w <div id="mailContentPreview"> nową treść
                $('#mailContentPreview').html(response.content);

                // 2) Podmień w hidden input name="EmailContent", by wysłać poprawną treść w ConfirmSendEmails
                $('input[name="EmailContent"]').val(response.content);
            } else {
                console.warn("W odpowiedzi brak klucza 'content'.", response);
            }
        },
        error: function (xhr) {
            console.error("Błąd AJAX:", xhr);
            alert('Błąd podczas pobierania treści maila.');
        }
    });


        });

        // Ustaw wartość dropdownu z modelu i wywołaj .change(), aby wstępnie pobrać treść
        var initialSelectedType = parseInt($('#HiddenSelectedMailType').val());
        $('#SelectedMailType').val(initialSelectedType).trigger('change');
    });
</script>
