@model SendEmailViewModel

@{
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="Page-Box">
    <div class="Page-Box-Container">
        <div class="Page-Box-Category">
            <div class="Category-Box-Title">
                Wysyłka
            </div>
            <partial name="_ContactNavCol" />
        </div>
        <div class="Horizontal">



            





            <!-- Formularz wysyłający wybrane typy maila do ConfirmSendEmails -->
            <form method="post" asp-action="ConfirmSendEmails">
                @Html.AntiForgeryToken()

                <!-- Ukryte ID klientów -->
                @foreach (var clientId in Model.SelectedClientIds)
                {
                    <input type="hidden" name="SelectedClientIds" value="@clientId" />
                }



                <!-- Ukryte pole dla EmailContent -->
                <input type="hidden" name="EmailContent" value="@Model.EmailContent" />


                <div class="Vert-table" style="height:30vh;">


                    <table class="table-orders">
                        <thead>
                            <tr>

                                <th>Klienci (@Model.Clients.Count)</th>
                                <th>E-mail</th>
                                <th>Ilość produktów</th>
                                <th>Liczba Wysłanych Emaili</th>
                                <th>Data Ostatniego Emaila</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var client in Model.Clients)
                            {
                                <tr>

                                    <td>@client.CeneoProfileName</td>
                                    <td>
                                        @{
                                            var emailAddresses = client.CeneoProfileEmail
                                            ?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                            .Select(e => e.Trim());
                                        }
                                        @if (emailAddresses != null && emailAddresses.Any())
                                        {
                                            foreach (var email in emailAddresses)
                                            {
                                                <div>@email</div>
                                            }
                                        }
                                        else
                                        {
                                            <span>Brak adresu email</span>
                                        }
                                    </td>

                                    <td>@client.CeneoProfileProductCount</td>
                                    <td>@client.EmailSentCount</td>
                                    <td>@(client.LastEmailSentDate.HasValue ? client.LastEmailSentDate.Value.ToString("dd-MM-yyyy HH:mm") : "Brak")</td>



                                </tr>

                            }
                        </tbody>
                    </table>
                </div>


                <!-- Ukryte pole do SelectedMailType (zostanie wypełnione w JS) -->
                <input type="hidden" id="HiddenSelectedMailType" name="SelectedMailType" value="@Model.SelectedMailType" />

                <!-- Kontener, w którym utworzymy dropdown z JS -->
                <div id="mailTypeDropdownContainer" style="margin-bottom: 10px;">
                    <!-- Tu JS wstawi <select> z opcjami -->
                </div>

                <div>
                    <label>Treść Emaila (podgląd HTML):</label><br />
                    <div id="mailContentPreview" style="border: 1px solid #ccc; padding: 10px;">
                        <!-- Początkowa treść maila z modelu -->
                        @Html.Raw(Model.EmailContent)
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label for="EmailSubject">Temat Emaila:</label><br />
                    <input type="text" name="EmailSubject" id="EmailSubject" value="@Model.EmailSubject" />
                </div>

                <p style="margin-top: 10px;">
                    Treść wiadomości zawiera zastępniki, np.:<br />
                    <strong>{ProductCount}</strong> – zostanie zastąpione liczbą produktów klienta (tylko w tych mailach, gdzie to ma sens)
                </p>

                <button type="submit" class="Button-Page-Small-r">Wyślij E-maile</button>
            </form>
        </div>
    </div>
</div>



<script>
    // Pierwszy log - czy w ogóle dotarliśmy do tego miejsca:
    console.log("Skrypt JS został wczytany. Sprawdzamy jQuery:", typeof $);

    // Tablica dostępnych maili:
    var mailTypes = [
        { value: 1, text: 'Mail 1' },
        { value: 2, text: 'Mail 2' },
        { value: 3, text: 'Mail 3' }
    ];

    $(document).ready(function() {
        // Drugi log - czy document.ready w ogóle się wywołuje:
        console.log("document.ready - start!");

        // 1) Generujemy dropdown w JS:
        var dropdownHtml = '<label>Wybierz rodzaj maila (JS):</label><br />' +
                           '<select id="SelectedMailType">';
        mailTypes.forEach(function(item) {
            dropdownHtml += '<option value="' + item.value + '">' + item.text + '</option>';
        });
        dropdownHtml += '</select>';

        console.log("Wygenerowany kod dropdown:", dropdownHtml);

        // Wstawiamy dropdown do kontenera
        $('#mailTypeDropdownContainer').html(dropdownHtml);
        console.log("Dropdown dodany do #mailTypeDropdownContainer.");

        // 2) Podpinamy zdarzenie change() pod nasz select
        $('#SelectedMailType').change(function() {
            var selectedMailType = $(this).val();
            console.log("Zmieniono mailType na:", selectedMailType);

            // Ustawiamy hidden input w formularzu:
            $('#HiddenSelectedMailType').val(selectedMailType);

            // Zbieramy ID klientów:
            var selectedClientIds = [];
            $('input[name="SelectedClientIds"]').each(function() {
                selectedClientIds.push(parseInt($(this).val()));
            });

            console.log("Wywołujemy AJAX -> /ClientProfile/ChangeMailTypeAjax z parametrami:", {
                mailType: parseInt(selectedMailType),
                selectedClientIds: selectedClientIds
            });

            $.ajax({
                url: '/ClientProfile/ChangeMailTypeAjax',
                type: 'POST',
                data: JSON.stringify({
                    mailType: parseInt(selectedMailType),
                    selectedClientIds: selectedClientIds
                }),
                contentType: 'application/json; charset=utf-8',
                success: function(response) {
                    console.log("Odebrano z serwera:", response);
                    if (response.content) {
                        $('#mailContentPreview').html(response.content);
                    } else {
                        console.warn("W odpowiedzi brak klucza 'content'.", response);
                    }
                },
                error: function(xhr) {
                    console.error("Błąd AJAX:", xhr);
                    alert('Błąd podczas pobierania treści maila.');
                }
            });
        });

        // 3) Inicjalizujemy dropdown z wstępną wartością (z naszego ukrytego inputa)
        var initialSelectedType = parseInt($('#HiddenSelectedMailType').val());
        console.log("Wstępna wartość (SelectedMailType) =", initialSelectedType);

        // Ustawiamy tę wartość w dropdown i wywołujemy change() - by pobrało initial content
        $('#SelectedMailType').val(initialSelectedType).trigger('change');
    });
</script>
