@model IEnumerable<PriceSafari.Models.ProductClass>

@{
    ViewData["Title"] = "Lista Produktów";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<h2>Lista Produktów dla sklepu @ViewBag.StoreName</h2>

<a asp-controller="GoogleScraper" asp-action="GoogleProducts" asp-route-storeId="@ViewBag.StoreId" class="btn btn-info">Produkty na Google Shopping</a>

<div class="filters">
    <div class="form-group">
        <label>Produkt na Google Shopping:</label>
        <select id="onGoogleFilter" class="form-control">
            <option value="all">Wszystkie</option>
            <option value="true">Tak</option>
            <option value="false">Nie</option>
        </select>
    </div>
    <div class="form-group">
        <label>URL Oferty:</label>
        <select id="hasUrlFilter" class="form-control">
            <option value="all">Wszystkie</option>
            <option value="true">Tak</option>
            <option value="false">Nie</option>
        </select>
    </div>
    <div class="form-group">
        <label>Google URL:</label>
        <select id="hasGoogleUrlFilter" class="form-control">
            <option value="all">Wszystkie</option>
            <option value="true">Tak</option>
            <option value="false">Nie</option>
        </select>
    </div>
    <div class="form-group">
        <label>Nazwa w Sklepie:</label>
        <select id="hasProductNameInStoreFilter" class="form-control">
            <option value="all">Wszystkie</option>
            <option value="true">Tak</option>
            <option value="false">Nie</option>
        </select>
    </div>

    <form asp-action="ValidateGoogleUrls" method="post">
        <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
        <button type="submit" class="btn btn-warning">Validate Google URLs</button>
    </form>
    <button onclick="filterProducts()" class="btn btn-primary">Filtruj</button>

    <form asp-action="SetOnGoogleForAll" method="post" class="mt-3 form-inline">
        <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
        <div class="form-group mr-2">
            <button type="submit" class="btn btn-success">Ustaw na Google dla produktów z nazwą</button>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="ignoreUrlRequirement" id="ignoreUrlRequirement" value="true">
            <label class="form-check-label" for="ignoreUrlRequirement">
                Ustaw mimo braku URL
            </label>
        </div>
    </form>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Nazwa Produktu</th>
            <th>URL Oferty</th>
            <th>Ean</th>
            <th>Google URL</th>
            <th>Produkt na Google</th>
            <th>Nazwa w Sklepie</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody id="productTableBody">
        @foreach (var product in Model)
        {
            <tr>
                <td>@product.ProductName</td>
                <td><a href="@product.Url" target="_blank">@product.Url</a></td>
                <td>@product.Ean</td>
                <td>@product.GoogleUrl</td>
                <td>@product.OnGoogle.ToString().ToLower()</td>
                <td>@product.ProductNameInStoreForGoogle</td>
                <td>
                    <form asp-action="UpdateProductNameInStoreForGoogle" method="post">
                        <input type="hidden" name="productId" value="@product.ProductId" />
                        <input type="text" name="productNameInStoreForGoogle" value="@product.ProductNameInStoreForGoogle" class="form-control" />
                        <button type="submit" class="btn btn-primary">Aktualizuj</button>
                    </form>
                </td>
                <td>
                    <form asp-action="ToggleGoogleStatus" method="post">
                        <input type="hidden" name="productId" value="@product.ProductId" />
                        <button type="submit" class="btn btn-primary">@(product.OnGoogle ? "Usuń z Google" : "Dodaj do Google")</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        // Sprawdź, czy Twój skrypt filtrowania nie wymaga poprawek w indeksach komórek.
        // Wygląda na to, że indeksy w oryginalnym kodzie mogły być nieprawidłowe.
        // Poniżej poprawiona wersja z prawidłowymi indeksami komórek (kolumn).
        function filterProducts() {
            var onGoogleFilter = document.getElementById("onGoogleFilter").value;
            var hasUrlFilter = document.getElementById("hasUrlFilter").value;
            var hasGoogleUrlFilter = document.getElementById("hasGoogleUrlFilter").value;
            var hasProductNameInStoreFilter = document.getElementById("hasProductNameInStoreFilter").value;

            var rows = document.querySelectorAll("#productTableBody tr");

            rows.forEach(row => {
                var urlCell = row.cells[1];
                var googleUrlCell = row.cells[3];
                var onGoogleCell = row.cells[4];
                var productNameInStoreCell = row.cells[5];

                var onGoogle = onGoogleCell.textContent.trim().toLowerCase();
                var hasUrl = urlCell.querySelector("a") && urlCell.querySelector("a").href.trim() !== "" && !urlCell.querySelector("a").href.endsWith("#");
                var hasGoogleUrl = googleUrlCell.textContent.trim() !== "";
                var hasProductNameInStore = productNameInStoreCell.textContent.trim() !== "";

                var show = true;

                if (onGoogleFilter !== "all" && onGoogle !== onGoogleFilter) {
                    show = false;
                }

                if (hasUrlFilter !== "all" && ((hasUrlFilter === "true" && !hasUrl) || (hasUrlFilter === "false" && hasUrl))) {
                    show = false;
                }

                if (hasGoogleUrlFilter !== "all" && ((hasGoogleUrlFilter === "true" && !hasGoogleUrl) || (hasGoogleUrlFilter === "false" && hasGoogleUrl))) {
                    show = false;
                }

                if (hasProductNameInStoreFilter !== "all" && ((hasProductNameInStoreFilter === "true" && !hasProductNameInStore) || (hasProductNameInStoreFilter === "false" && hasProductNameInStore))) {
                    show = false;
                }

                row.style.display = show ? "" : "none";
            });
        }
    </script>
}