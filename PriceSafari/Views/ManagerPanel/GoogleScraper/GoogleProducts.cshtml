@model IEnumerable<PriceSafari.Models.ProductClass>

@{
    ViewData["Title"] = "Lista Produktów";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var storeId = ViewBag.StoreId;
}

<h2 class="mt-4 mb-4">Products for Google Scraping</h2>

<div class="mb-3 p-3 border rounded bg-light" id="scrapingOptions">
    <h4>Opcje Uruchomienia Bota</h4>
    <div class="row g-3 align-items-end">

        <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="allowManualCaptchaSolving" style="background-color: #fd7e14; border-color: #fd7e14;">
            <label class="form-check-label" for="allowManualCaptchaSolving">
                <strong>Włącz tryb ręcznego rozwiązywania CAPTCHA</strong> (Gdy bot trafi na CAPTCHA, poczeka 30s na ręczne rozwiązanie zamiast resetować sieć)
            </label>
        </div>

        <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="useFirstMatchLogic">
            <label class="form-check-label" for="useFirstMatchLogic">
                <strong>Włącz tryb "Pierwszy Trafiony"</strong> (szybki, mniej dokładny - przypisuje pierwszy znaleziony produkt w Google)
            </label>
        </div>

        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="ensureNameMatch">
            <label class="form-check-label" for="ensureNameMatch">
                <strong>Tryb Pośredni:</strong> Upewnij się, że w nazwie wyniku występuje wyszukiwany parametr (np. Kod produktu)
            </label>
        </div>
        <div class="form-check form-switch mt-2 ms-4" id="compareOnlyCurrentProductCodeContainer" style="display: none;">
            <input class="form-check-input" type="checkbox" id="compareOnlyCurrentProductCode">
            <label class="form-check-label" for="compareOnlyCurrentProductCode">
                Porównuj kod tylko aktualnie wyszukiwanego produktu (Ogranicza dopasowanie do własnego kodu. Zwiększa dokładność, zmniejsza szybkość).
            </label>
        </div>
        <div class="col-md-3">
            <label for="numberOfConcurrentScrapers" class="form-label">Liczba scraperów (wątków):</label>
            <input type="number" class="form-control" id="numberOfConcurrentScrapers" value="7" min="1">
        </div>
        <div class="col-md-3">
            <label for="maxCidsToProcessPerProduct" class="form-label">Max CIDów / Wyników:</label>
            <input type="number" class="form-control" id="maxCidsToProcessPerProduct" value="5" min="1">
            <small class="text-muted">Dla Multi-Catalog zalecane 8-10</small>
        </div>
        <div class="col-md-3">
            <label for="searchTermSource" class="form-label">Źródło terminu wyszukiwania:</label>
            <select class="form-select" id="searchTermSource">
                <option value="ProductName" selected>Nazwa produktu</option>
                <option value="ProductUrl">URL produktu</option>
                <option value="Ean">Kod EAN</option>
                <option value="ProducerCode">Kod producenta</option>
            </select>
        </div>
        <div class="col-md-3" id="productNameOptionsContainer">
            <div class="mb-2">
                <label for="productNamePrefix" class="form-label">Prefix dla nazwy produktu (opcjonalnie):</label>
                <input type="text" class="form-control" id="productNamePrefix" placeholder="np. sklep">
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="appendProducerCode">
                <label class="form-check-label" for="appendProducerCode">
                    Dołącz kod producenta do nazwy
                </label>
            </div>
        </div>
    </div>
</div>

<div class="d-flex mb-3 flex-wrap">
    <button id="startScraping" class="btn btn-primary me-2 mb-2">Uruchom BOT (Główny)</button>

    <button id="startMultiCatalogScraping" class="btn btn-info me-2 mb-2 text-white">
        <i class="bi bi-collection"></i> Szukaj Dodatkowych Katalogów (Multi)
    </button>

    <button id="stopScrapingButton" class="btn me-2 mb-2" style="background-color: purple; color: white;">Zatrzymaj BOTa</button>

    <div class="vr mx-2"></div>

    <button id="updatePendingStatuses" class="btn btn-secondary me-2 mb-2">Przelicz korekty</button>
    <button id="resetNotFoundStatuses" class="btn btn-warning me-2 mb-2">Resetuj nieznalezione</button>
    <button id="resetIncorrectGoogleStatuses" class="btn btn-danger me-2 mb-2">Resetuj Błędne Google</button>
    <button id="clearGoogleUrls" class="btn btn-danger mb-2">Wyczyść Google URLs</button>
</div>

<h3>Podsumowanie</h3>
<div class="d-flex mb-3">
    <p class="me-4">Liczba produktów znalezionych: <span id="foundCount" class="badge bg-success">0</span></p>
    <p class="me-4">Liczba produktów do znalezienia: <span id="pendingCount" class="badge bg-secondary">0</span></p>
    <p>Liczba produktów nieznalezionych: <span id="notFoundCount" class="badge bg-danger">0</span></p>
</div>

<table class="table table-bordered table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="selectAllProducts" /></th>
            <th>Product Name</th>
            <th>EAN</th>
            <th>Kod Producenta</th>
            <th>Product URL</th>
            <th>Status</th>
            <th>Google URL</th>
            <th>Akcja</th>
            <th>GID/CID</th>
        </tr>
    </thead>
    <tbody id="productTable">
    </tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log("Document ready, loading products...");
            loadProducts();

            // === UI LOGIC ===
            function toggleIntermediateOptions() {
                if ($('#ensureNameMatch').is(':checked')) {
                    $('#compareOnlyCurrentProductCodeContainer').show();
                } else {
                    $('#compareOnlyCurrentProductCodeContainer').hide();
                }
            }

            $('#searchTermSource').change(function () {
                if ($(this).val() === 'ProductName') {
                    $('#productNameOptionsContainer').show();
                } else {
                    $('#productNameOptionsContainer').hide();
                }
            }).trigger('change');

            $('#ensureNameMatch').change(toggleIntermediateOptions).trigger('change');

            $('#selectAllProducts').click(function () {
                $('.product-checkbox').prop('checked', this.checked);
            });

            // === BUTTON HANDLERS ===

            // 1. STANDARD SCRAPING
            $('#startScraping').click(function () {
                startScrapingProcess('@Url.Action("StartScrapingForProducts", "GoogleScraper")');
            });

            // 2. MULTI-CATALOG SCRAPING (NOWY PRZYCISK)
            $('#startMultiCatalogScraping').click(function () {
                // Dla trybu Multi warto wymusić nieco większą liczbę CIDów
                let maxCids = parseInt($('#maxCidsToProcessPerProduct').val(), 10);
                if(maxCids < 5) {
                    if(!confirm("Tryb Multi-Catalog działa najlepiej przy sprawdzaniu min. 5-8 wyników. Czy kontynuować z obecną liczbą (" + maxCids + ")?")) return;
                }
                startScrapingProcess('@Url.Action("StartScrapingForAdditionalCatalogs", "GoogleScraper")');
            });

            $('#stopScrapingButton').click(function () {
                if (confirm("Czy na pewno chcesz zatrzymać proces scrapowania?")) {
                    sendPostRequest('@Url.Action("StopScraping", "GoogleScraper")', {}, "Wysłano żądanie zatrzymania.");
                }
            });

            $('#updatePendingStatuses').click(() => sendPostRequest('@Url.Action("UpdatePendingProducts", "GoogleScraper")', { storeId: '@storeId' }, "Zaktualizowano statusy."));
            $('#resetNotFoundStatuses').click(() => sendPostRequest('@Url.Action("ResetNotFoundProducts", "GoogleScraper")', { storeId: '@storeId' }, "Zresetowano nieznalezione."));
            $('#resetIncorrectGoogleStatuses').click(() => sendPostRequest('@Url.Action("ResetIncorrectGoogleStatuses", "GoogleScraper")', { storeId: '@storeId' }, "Zresetowano błędne statusy."));
            $('#clearGoogleUrls').click(() => sendPostRequest('@Url.Action("ClearGoogleUrls", "GoogleScraper")', { storeId: '@storeId' }, "Wyczyszczono URL Google."));


            // === CORE FUNCTIONS ===

            function loadProducts() {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GoogleProducts", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (products) {
                        updateTable(products);
                    },
                    error: function (xhr) {
                        console.error("Error loading products: ", xhr.responseText);
                    }
                });
            }

            // Główna funkcja uruchamiająca scrapowanie (używana przez oba przyciski)
            function startScrapingProcess(actionUrl) {
                var selectedProductIds = [];
                $('.product-checkbox:checked').each(function () {
                    selectedProductIds.push(parseInt($(this).val(), 10));
                });

                var termSource = $('#searchTermSource').val();
                var prefix = $('#productNamePrefix').val();

                var scrapingData = {
                    storeId: '@storeId',
                    productIds: selectedProductIds,
                    numberOfConcurrentScrapers: parseInt($('#numberOfConcurrentScrapers').val(), 10),
                    maxCidsToProcessPerProduct: parseInt($('#maxCidsToProcessPerProduct').val(), 10),
                    // Dla nowego endpointu nazwa parametru w kontrolerze to maxCidsToProcess, ale MVC zmapuje to jeśli nazwy są podobne lub jeśli dodasz alias w JS.
                    // Najbezpieczniej wysłać oba lub ujednolicić w kontrolerze.
                    maxCidsToProcess: parseInt($('#maxCidsToProcessPerProduct').val(), 10), // Dla nowego kontrolera

                    searchTermSource: termSource,
                    useFirstMatchLogic: $('#useFirstMatchLogic').is(':checked'),
                    ensureNameMatch: $('#ensureNameMatch').is(':checked'),
                    compareOnlyCurrentProductCode: $('#compareOnlyCurrentProductCode').is(':checked'),
                    allowManualCaptchaSolving: $('#allowManualCaptchaSolving').is(':checked'),
                    appendProducerCode: $('#appendProducerCode').is(':checked')
                };

                if (termSource === 'ProductName' && prefix && prefix.trim() !== '') {
                    scrapingData.productNamePrefix = prefix;
                }

                $.ajax({
                    type: "POST",
                    url: actionUrl,
                    data: scrapingData,
                    traditional: true,
                    success: function (response) {
                        alert("Rozpoczęto: " + response);
                    },
                    error: function (xhr) {
                        alert("Błąd: " + xhr.responseText);
                    }
                });
            }

            function sendPostRequest(url, data, successMsg) {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    success: function () {
                        console.log(successMsg);
                        loadProducts();
                    },
                    error: function (xhr) {
                        console.error("Error: ", xhr.responseText);
                    }
                });
            }

         // === TABLE RENDERING (Z PEŁNYMI URLAMI) ===
            function updateTable(products) {
                $('#productTable').empty();
                var foundCount = 0;
                var pendingCount = 0;
                var notFoundCount = 0;

                $.each(products, function (index, product) {
                    // Licznik
                    var badge = '<span class="badge bg-secondary">Pending</span>';
                    if (product.foundOnGoogle === true) {
                        badge = '<span class="badge bg-success">Found</span>';
                        foundCount++;
                    } else if (product.foundOnGoogle === false) {
                        badge = '<span class="badge bg-danger">Not Found</span>';
                        notFoundCount++;
                    } else {
                        pendingCount++;
                    }

                    var googleLinkHtml = product.generatedGoogleUrl ? `<a href="${product.generatedGoogleUrl}" target="_blank" class="btn btn-sm btn-outline-primary">Szukaj</a>` : '';

                    // ZMIANA TUTAJ: Wyświetlamy product.googleUrl zamiast słowa "Link"
                    // Dodano style="word-break: break-all; font-size: 0.8rem;" aby długi link mieścił się w komórce
                    var mainGoogleUrl = product.googleUrl ? `<a href="${product.googleUrl}" target="_blank" style="word-break: break-all; font-size: 0.85rem;">${product.googleUrl}</a>` : '';

                    // 1. GŁÓWNY WIERSZ
                    var row = `
                        <tr id="productRow-${product.productId}">
                            <td><input type="checkbox" class="product-checkbox" value="${product.productId}" /></td>
                            <td><small>${product.productNameInStoreForGoogle || ''}</small></td>
                            <td>${product.ean || ''}</td>
                            <td class="fw-bold text-primary">${product.producerCode || ''}</td>
                            <td><a href="${product.url || '#'}" target="_blank">Sklep</a></td>
                            <td>${badge}</td>
                            <td>${mainGoogleUrl}</td> <td>${googleLinkHtml}</td>
                            <td><small>${product.googleGid || ''}</small></td>
                        </tr>`;

                    $('#productTable').append(row);

                    // 2. WIERSZE DODATKOWE (MULTI-CATALOG)
                    if (product.googleCatalogs && product.googleCatalogs.length > 0) {
                        $.each(product.googleCatalogs, function(i, cat) {
                            var subRow = `
                                <tr style="background-color: #e8f4f8;">
                                    <td></td>
                                    <td colspan="4" class="text-end text-muted">
                                        <i class="bi bi-arrow-return-right"></i> Dodatkowy katalog (${i+1}):
                                    </td>
                                    <td><span class="badge bg-info text-dark">Extra</span></td>

                                    <td>
                                        <a href="${cat.googleUrl}" target="_blank" style="word-break: break-all; font-size: 0.85rem;">
                                            ${cat.googleUrl}
                                        </a>
                                    </td>

                                    <td></td>
                                    <td><small class="text-muted">${cat.googleGid || cat.googleCid}</small></td>
                                </tr>
                            `;
                            $('#productTable').append(subRow);
                        });
                    }
                });

                $('#foundCount').text(foundCount);
                $('#pendingCount').text(pendingCount);
                $('#notFoundCount').text(notFoundCount);
            }
        });
    </script>
}