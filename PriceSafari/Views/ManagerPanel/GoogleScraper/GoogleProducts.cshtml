@model IEnumerable<PriceSafari.Models.ProductClass>

@{
    ViewData["Title"] = "Lista Produktów";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var storeId = ViewBag.StoreId;
}

<h2 class="mt-4 mb-4">Products for Google Scraping</h2>

<div class="mb-3 p-3 border rounded bg-light" id="scrapingOptions">
    <h4>Opcje Uruchomienia Bota</h4>
    <div class="row g-3 align-items-end">

        <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="allowManualCaptchaSolving" style="background-color: #fd7e14; border-color: #fd7e14;">
            <label class="form-check-label" for="allowManualCaptchaSolving">
                <strong>Włącz tryb ręcznego rozwiązywania CAPTCHA</strong> (Gdy bot trafi na CAPTCHA, poczeka 30s na ręczne rozwiązanie zamiast resetować sieć)
            </label>
        </div>
        <div class="col-md-3">
            <label for="searchModeUdm" class="form-label">Tryb widoku Google (UDM):</label>
            <select class="form-select" id="searchModeUdm">
                <option value="3" selected>Standardowy (udm=3)</option>
                <option value="28">Alternatywny / Siatka (udm=28)</option>
            </select>
            <small class="text-muted">Zmień, jeśli scraper nie znajduje wyników.</small>
        </div>
        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="filterMultiCatalog">
            <label class="form-check-label" for="filterMultiCatalog">
                <strong class="text-info">Pokaż tylko produkty z dodatkowymi katalogami (Multi-Catalog)</strong>
            </label>
        </div>
        <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="useFirstMatchLogic">
            <label class="form-check-label" for="useFirstMatchLogic">
                <strong>Włącz tryb "Pierwszy Trafiony"</strong> (szybki, mniej dokładny - przypisuje pierwszy znaleziony produkt w Google)
            </label>
        </div>

        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="ensureNameMatch">
            <label class="form-check-label" for="ensureNameMatch">
                <strong>Tryb Pośredni:</strong> Upewnij się, że w nazwie wyniku występuje wyszukiwany parametr (np. Kod produktu)
            </label>
        </div>
        <div class="form-check form-switch mt-2 ms-4" id="compareOnlyCurrentProductCodeContainer" style="display: none;">
            <input class="form-check-input" type="checkbox" id="compareOnlyCurrentProductCode">
            <label class="form-check-label" for="compareOnlyCurrentProductCode">
                Porównuj kod tylko aktualnie wyszukiwanego produktu (Ogranicza dopasowanie do własnego kodu. Zwiększa dokładność, zmniejsza szybkość).
            </label>
        </div>
        <div class="col-md-3">
            <label for="numberOfConcurrentScrapers" class="form-label">Liczba scraperów (wątków):</label>
            <input type="number" class="form-control" id="numberOfConcurrentScrapers" value="7" min="1">
        </div>
        <div class="col-md-3">
            <label for="maxCidsToProcessPerProduct" class="form-label">Max CIDów / Wyników:</label>
            <input type="number" class="form-control" id="maxCidsToProcessPerProduct" value="5" min="1">
            <small class="text-muted">Dla Multi-Catalog zalecane 8-10</small>
        </div>
        <div class="col-md-3">
            <label for="searchTermSource" class="form-label">Źródło terminu wyszukiwania:</label>
            <select class="form-select" id="searchTermSource">
                <option value="ProductName" selected>Nazwa produktu</option>
                <option value="ProductUrl">URL produktu</option>
                <option value="Ean">Kod EAN</option>
                <option value="ProducerCode">Kod producenta</option>
            </select>
        </div>
        <div class="col-md-3" id="productNameOptionsContainer">
            <div class="mb-2" id="prefixContainer">
                <label for="productNamePrefix" class="form-label">Prefix (np. nazwa sklepu):</label>
                <input type="text" class="form-control" id="productNamePrefix" placeholder="np. sklep">
            </div>

            <div class="form-check" id="appendCodeContainer">
                <input class="form-check-input" type="checkbox" id="appendProducerCode">
                <label class="form-check-label" for="appendProducerCode">
                    Dołącz kod producenta do nazwy
                </label>
            </div>
        </div>
    </div>
</div>

<div class="d-flex mb-3 flex-wrap">
    <button id="startScraping" class="btn btn-primary me-2 mb-2">Uruchom BOT (Główny)</button>

    <button id="startMultiCatalogScraping" class="btn btn-info me-2 mb-2 text-white">
        <i class="bi bi-collection"></i> Szukaj Dodatkowych Katalogów (Multi)
    </button>

    <button id="stopScrapingButton" class="btn me-2 mb-2" style="background-color: purple; color: white;">Zatrzymaj BOTa</button>

    <div class="vr mx-2"></div>

    <button id="updatePendingStatuses" class="btn btn-secondary me-2 mb-2">Przelicz korekty</button>
    <button id="resetNotFoundStatuses" class="btn btn-warning me-2 mb-2">Resetuj nieznalezione</button>
    <button id="resetIncorrectGoogleStatuses" class="btn btn-danger me-2 mb-2">Resetuj Błędne Google</button>
    <button id="clearGoogleUrls" class="btn btn-danger mb-2">Wyczyść Google URLs</button>
</div>

<h3>Podsumowanie</h3>
<div class="d-flex mb-3">
    <p class="me-4">Liczba produktów znalezionych: <span id="foundCount" class="badge bg-success">0</span></p>
    <p class="me-4">Liczba produktów do znalezienia: <span id="pendingCount" class="badge bg-secondary">0</span></p>
    <p>Liczba produktów nieznalezionych: <span id="notFoundCount" class="badge bg-danger">0</span></p>
</div>

<table class="table table-bordered table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="selectAllProducts" /></th>
            <th>Product Name</th>
            <th>EAN</th>
            <th>Kod Producenta</th>
            <th>Product URL</th>
            <th>Status</th>
            <th>Google URL</th>
            <th>Akcja</th>
            <th>GID/CID</th>
        </tr>
    </thead>
    <tbody id="productTable">
    </tbody>
</table>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Zmienna do przechowywania pobranych danych, aby filtrować bez przeładowania
            let cachedProducts = [];

            console.log("Document ready, loading products...");
            loadProducts();

            // === UI LOGIC ===
            function toggleIntermediateOptions() {
                if ($('#ensureNameMatch').is(':checked')) {
                    $('#compareOnlyCurrentProductCodeContainer').show();
                } else {
                    $('#compareOnlyCurrentProductCodeContainer').hide();
                }
            }

            // Obsługa zmiany filtra "Pokaż tylko Multi-Catalog"
            $('#filterMultiCatalog').change(function() {
                updateTable(cachedProducts);
            });

          $('#searchTermSource').change(function () {
                var source = $(this).val();

                // 1. Prefix pokazujemy dla Nazwy, EAN i Kodu Producenta (ukrywamy dla URL)
                if (source === 'ProductUrl') {
                    $('#prefixContainer').hide();
                } else {
                    $('#prefixContainer').show();
                }

                // 2. "Dołącz kod producenta" ma sens TYLKO gdy szukamy po Nazwie
                if (source === 'ProductName') {
                    $('#appendCodeContainer').show();
                } else {
                    $('#appendCodeContainer').hide();
                    $('#appendProducerCode').prop('checked', false); // Opcjonalnie odznaczamy
                }
            }).trigger('change');

            $('#ensureNameMatch').change(toggleIntermediateOptions).trigger('change');

            $('#selectAllProducts').click(function () {
                $('.product-checkbox').prop('checked', this.checked);
            });

            // === BUTTON HANDLERS ===

            $('#startScraping').click(function () {
                startScrapingProcess('@Url.Action("StartScrapingForProducts", "GoogleScraper")');
            });

            $('#startMultiCatalogScraping').click(function () {
                let maxCids = parseInt($('#maxCidsToProcessPerProduct').val(), 10);
                if(maxCids < 5) {
                    if(!confirm("Tryb Multi-Catalog działa najlepiej przy sprawdzaniu min. 5-8 wyników. Kontynuować?")) return;
                }
                startScrapingProcess('@Url.Action("StartScrapingForAdditionalCatalogs", "GoogleScraper")');
            });

            $('#stopScrapingButton').click(function () {
                if (confirm("Czy na pewno chcesz zatrzymać proces scrapowania?")) {
                    sendPostRequest('@Url.Action("StopScraping", "GoogleScraper")', {}, "Wysłano żądanie zatrzymania.");
                }
            });

            $('#updatePendingStatuses').click(() => sendPostRequest('@Url.Action("UpdatePendingProducts", "GoogleScraper")', { storeId: '@storeId' }, "Zaktualizowano statusy."));
            $('#resetNotFoundStatuses').click(() => sendPostRequest('@Url.Action("ResetNotFoundProducts", "GoogleScraper")', { storeId: '@storeId' }, "Zresetowano nieznalezione."));
            $('#resetIncorrectGoogleStatuses').click(() => sendPostRequest('@Url.Action("ResetIncorrectGoogleStatuses", "GoogleScraper")', { storeId: '@storeId' }, "Zresetowano błędne statusy."));
            $('#clearGoogleUrls').click(() => sendPostRequest('@Url.Action("ClearGoogleUrls", "GoogleScraper")', { storeId: '@storeId' }, "Wyczyszczono URL Google."));


            // === CORE FUNCTIONS ===

            function loadProducts() {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GoogleProducts", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (products) {
                        cachedProducts = products; // Zapisujemy do pamięci
                        updateTable(products);
                    },
                    error: function (xhr) {
                        console.error("Error loading products: ", xhr.responseText);
                    }
                });
            }

            function startScrapingProcess(actionUrl) {
                var selectedProductIds = [];
                $('.product-checkbox:checked').each(function () {
                    selectedProductIds.push(parseInt($(this).val(), 10));
                });

                var maxCidsValue = parseInt($('#maxCidsToProcessPerProduct').val(), 10);

                      var scrapingData = {
                        storeId: '@storeId',
                        productIds: selectedProductIds,
                        numberOfConcurrentScrapers: parseInt($('#numberOfConcurrentScrapers').val(), 10),

                        // Parametry ilościowe (naprawione w poprzednim kroku):
                        maxCidsToProcessPerProduct: parseInt($('#maxCidsToProcessPerProduct').val(), 10),
                        maxCidsToProcess: parseInt($('#maxCidsToProcessPerProduct').val(), 10),

                        // NOWY PARAMETR:
                        searchModeUdm: parseInt($('#searchModeUdm').val(), 10),

                        searchTermSource: $('#searchTermSource').val(),
                        useFirstMatchLogic: $('#useFirstMatchLogic').is(':checked'),
                        ensureNameMatch: $('#ensureNameMatch').is(':checked'),
                        compareOnlyCurrentProductCode: $('#compareOnlyCurrentProductCode').is(':checked'),
                        allowManualCaptchaSolving: $('#allowManualCaptchaSolving').is(':checked'),
                        appendProducerCode: $('#appendProducerCode').is(':checked'),
                        productNamePrefix: $('#productNamePrefix').val()
                    };

                $.ajax({
                    type: "POST",
                    url: actionUrl,
                    data: scrapingData,
                    traditional: true,
                    success: function (response) {
                        alert("Rozpoczęto: " + response);
                    },
                    error: function (xhr) {
                        alert("Błąd: " + xhr.responseText);
                    }
                });
            }

            function sendPostRequest(url, data, successMsg) {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    success: function () {
                        console.log(successMsg);
                        loadProducts();
                    }
                });
            }

          // === TABLE RENDERING Z FILTROWANIEM ===
            function updateTable(products) {
                const tableBody = $('#productTable');
                tableBody.empty();

                const onlyMulti = $('#filterMultiCatalog').is(':checked');

                let foundCount = 0;
                let pendingCount = 0;
                let notFoundCount = 0;

                $.each(products, function (index, product) {
                    const hasExtraCatalogs = product.googleCatalogs && product.googleCatalogs.length > 0;

                    if (onlyMulti && !hasExtraCatalogs) {
                        return true;
                    }

                    if (product.foundOnGoogle === true) foundCount++;
                    else if (product.foundOnGoogle === false) notFoundCount++;
                    else pendingCount++;

                    // Badge statusu (Found/Pending)
                    let statusBadge = '<span class="badge bg-secondary">Pending</span>';
                    if (product.foundOnGoogle === true) statusBadge = '<span class="badge bg-success">Found</span>';
                    else if (product.foundOnGoogle === false) statusBadge = '<span class="badge bg-danger">Not Found</span>';

                    // Naklejka typu dla produktu głównego
                    let typeBadge = '';
                    if (product.googleCid) {
                        typeBadge = '<span class="badge bg-success" style="font-size: 0.7rem;">KATALOG</span>';
                    } else if (product.googleHid) {
                        typeBadge = '<span class="badge bg-warning text-dark" style="font-size: 0.7rem;">OFERTA</span>';
                    }

                    // Identyfikatory jeden pod drugim
                    let mainIdsHtml = `
                        <div style="font-size: 0.75rem; line-height: 1.2;">
                            ${product.googleGid ? `GID: ${product.googleGid}<br/>` : ''}
                            ${product.googleCid ? `CID: ${product.googleCid}<br/>` : ''}
                            ${product.googleHid ? `HID: ${product.googleHid}` : ''}
                        </div>`;

                    let googleLinkHtml = product.generatedGoogleUrl ? `<a href="${product.generatedGoogleUrl}" target="_blank" class="btn btn-sm btn-outline-primary">Szukaj</a>` : '';
                    let mainGoogleUrl = product.googleUrl ? `<a href="${product.googleUrl}" target="_blank" style="word-break: break-all; font-size: 0.85rem;">${product.googleUrl}</a>` : '';

                    // 1. Wiersz główny
                    let row = `
                        <tr id="productRow-${product.productId}" class="${hasExtraCatalogs ? 'table-info' : ''}">
                            <td><input type="checkbox" class="product-checkbox" value="${product.productId}" /></td>
                            <td><small>${product.productNameInStoreForGoogle || ''}</small><br/>${typeBadge}</td>
                            <td>${product.ean || ''}</td>
                            <td class="fw-bold text-primary">${product.producerCode || ''}</td>
                            <td><a href="${product.url || '#'}" target="_blank">Sklep</a></td>
                            <td>${statusBadge}</td>
                            <td>${mainGoogleUrl}</td>
                            <td>${googleLinkHtml}</td>
                            <td>${mainIdsHtml}</td>
                        </tr>`;

                    tableBody.append(row);

                    // 2. Wiersze dodatkowe (Multi-Catalog)
                    if (hasExtraCatalogs) {
                        $.each(product.googleCatalogs, function(i, cat) {
                            // Generowanie URL dynamicznie na podstawie typu
                            let dynamicUrl = '';
                            let subTypeBadge = '';

                            if (cat.isExtendedOfferByHid) {
                                // Typ Oferta (przez HID)
                                let name = encodeURIComponent(product.productNameInStoreForGoogle);
                                dynamicUrl = `https://www.google.com/search?q=${name}&udm=28#oshopproduct=gid:${cat.googleGid},hid:${cat.googleHid},pvt:hg,pvo:3&oshop=apv`;
                                subTypeBadge = '<span class="badge bg-warning text-dark" style="font-size: 0.6rem;">OFERTA</span>';
                            } else {
                                // Typ Katalog (przez CID)
                                dynamicUrl = `https://www.google.com/shopping/product/${cat.googleCid}`;
                                subTypeBadge = '<span class="badge bg-success" style="font-size: 0.6rem;">KATALOG</span>';
                            }

                            let subIdsHtml = `
                                <div style="font-size: 0.7rem; line-height: 1.1;">
                                    ${cat.googleGid ? `Gid: ${cat.googleGid}<br/>` : ''}
                                    ${cat.googleCid ? `Cid: ${cat.googleCid}<br/>` : ''}
                                    ${cat.googleHid ? `Hid: ${cat.googleHid}` : ''}
                                </div>`;

                            let subRow = `
                                <tr style="background-color: #f0faff;">
                                    <td></td>
                                    <td colspan="4" class="text-end text-muted small">
                                        <i class="bi bi-arrow-return-right"></i> Dodatkowy (${i+1}):
                                    </td>
                                    <td>${subTypeBadge}</td>
                                    <td>
                                        <a href="${dynamicUrl}" target="_blank" style="word-break: break-all; font-size: 0.8rem;">
                                            Link do Google
                                        </a>
                                    </td>
                                    <td></td>
                                    <td>${subIdsHtml}</td>
                                </tr>`;
                            tableBody.append(subRow);
                        });
                    }
                });

                // Aktualizacja podsumowania
                $('#foundCount').text(foundCount);
                $('#pendingCount').text(pendingCount);
                $('#notFoundCount').text(notFoundCount);
            }
        });
    </script>
}