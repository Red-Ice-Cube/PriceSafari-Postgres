@model IEnumerable<PriceSafari.Models.ProductClass>

@{
    ViewData["Title"] = "Lista Produktów";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
    var storeId = ViewBag.StoreId;
}

<h2 class="mt-4 mb-4">Products for Google Scraping</h2>

@* NOWA SEKCJA Z OPCJAMI SCRAPOWANIA *@
<div class="mb-3 p-3 border rounded bg-light" id="scrapingOptions">
    <h4>Opcje Uruchomienia Bota</h4>
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="numberOfConcurrentScrapers" class="form-label">Liczba scraperów (wątków):</label>
            <input type="number" class="form-control" id="numberOfConcurrentScrapers" value="7" min="1">
        </div>
        <div class="col-md-3">
            <label for="maxCidsToProcessPerProduct" class="form-label">Max CIDów na produkt:</label>
            <input type="number" class="form-control" id="maxCidsToProcessPerProduct" value="5" min="1">
        </div>
        <div class="col-md-3">
            <label for="searchTermSource" class="form-label">Źródło terminu wyszukiwania:</label>
            <select class="form-select" id="searchTermSource">
                <option value="ProductName" selected>Nazwa produktu</option>
                <option value="ProductUrl">URL produktu</option>
            </select>
        </div>
        <div class="col-md-3" id="productNamePrefixContainer">
            <label for="productNamePrefix" class="form-label">Prefix dla nazwy produktu (opcjonalnie):</label>
            <input type="text" class="form-control" id="productNamePrefix" placeholder="np. k3design.pl">
        </div>
    </div>
</div>

<div class="d-flex mb-3 flex-wrap">
    @* Dodano flex-wrap dla lepszego RWD *@
    <button id="startScraping" class="btn btn-primary me-2 mb-2">Uruchom BOT z powyższymi opcjami</button>
    @* NOWY PRZYCISK ZATRZYMANIA *@
    <button id="stopScrapingButton" class="btn me-2 mb-2" style="background-color: purple; color: white;">Zatrzymaj BOTa</button>

    <button id="updatePendingStatuses" class="btn btn-secondary me-2 mb-2">Przelicz korekty</button>
    <button id="resetNotFoundStatuses" class="btn btn-warning me-2 mb-2">Resetuj nieznalezione</button>
    <button id="resetIncorrectGoogleStatuses" class="btn btn-danger me-2 mb-2">Resetuj Niepoprawnie znalezione produkty Google</button>
    <button id="clearGoogleUrls" class="btn btn-danger mb-2">Wyczyść Google URLs</button> @* Usunięto me-2, jeśli to ostatni *@
</div>


<h3>Podsumowanie</h3>
<div class="d-flex mb-3">
    <p class="me-4">Liczba produktów znalezionych: <span id="foundCount" class="badge bg-success">0</span></p>
    <p class="me-4">Liczba produktów do znalezienia: <span id="pendingCount" class="badge bg-secondary">0</span></p>
    <p>Liczba produktów nieznalezionych: <span id="notFoundCount" class="badge bg-danger">0</span></p>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Product Name</th>
            <th>Product URL</th>
            <th>Found on Google</th>
            <th>Google URL</th>
        </tr>
    </thead>
    <tbody id="productTable">
    </tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log("Document ready, loading products...");
            loadProducts(); // Ładowanie produktów przy wejściu na stronę

            // Obsługa widoczności pola prefixu
            $('#searchTermSource').change(function() {
                if ($(this).val() === 'ProductName') {
                    $('#productNamePrefixContainer').show();
                } else {
                    $('#productNamePrefixContainer').hide();
                    // Opcjonalnie wyczyść wartość prefixu, gdy jest ukryty
                    // $('#productNamePrefix').val('');
                }
            }).trigger('change'); // Wywołaj raz przy ładowaniu, aby ustawić stan początkowy

            // Start scraping button
            $('#startScraping').click(function () {
                console.log("Start Scraping button clicked.");
                startScraping();
            });

            $('#stopScrapingButton').click(function () {
                console.log("Stop Scraping button clicked.");
                if (confirm("Czy na pewno chcesz zatrzymać proces scrapowania? Bieżące zmiany zostaną zapisane.")) {
                    stopScrapingProcess();
                }
            });

            // ... (reszta handerów dla przycisków bez zmian) ...
            // Update pending statuses button
            $('#updatePendingStatuses').click(function () {
                console.log("Update Pending Statuses button clicked.");
                updatePendingProducts();
            });

            // Reset Not Found statuses button
            $('#resetNotFoundStatuses').click(function () {
                console.log("Reset Not Found Statuses button clicked.");
                resetNotFoundProducts();
            });

             $('#resetIncorrectGoogleStatuses').click(function () {
                console.log("Reset Incorrect Google Statuses button clicked.");
                resetIncorrectGoogleStatuses();
            });

            $('#clearGoogleUrls').click(function () {
                console.log("Clear Google URLs button clicked.");
                clearGoogleUrls();
            });


            function loadProducts() {
                console.log("Sending GET request to load products...");
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GoogleProducts", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (products) {
                        console.log("Received products from server:", products);
                        updateTable(products); // Aktualizacja tabeli i liczników
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading products: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                    }
                });
            }

            function startScraping() {
                console.log("Sending POST request to start scraping...");

                // Pobranie wartości z nowych pól formularza
                var concurrentScrapers = $('#numberOfConcurrentScrapers').val();
                var maxCids = $('#maxCidsToProcessPerProduct').val();
                var termSource = $('#searchTermSource').val();
                var prefix = $('#productNamePrefix').val();

                // Przygotowanie danych do wysłania
                var scrapingData = {
                    storeId: '@storeId',
                    numberOfConcurrentScrapers: parseInt(concurrentScrapers, 10), // Konwersja na liczbę
                    maxCidsToProcessPerProduct: parseInt(maxCids, 10),       // Konwersja na liczbę
                    searchTermSource: termSource
                };

                // Dodaj prefix tylko jeśli źródłem jest nazwa produktu i prefix nie jest pusty
                if (termSource === 'ProductName' && prefix && prefix.trim() !== '') {
                    scrapingData.productNamePrefix = prefix;
                }
                // Jeśli searchTermSource to ProductUrl, productNamePrefix nie jest potrzebny
                // (backend i tak go zignoruje lub ustawi na null, jeśli wyślemy pusty)


                $.ajax({
                    type: "POST",
                    url: '@Url.Action("StartScrapingForProducts", "GoogleScraper")',
                    data: scrapingData, // Użycie zaktualizowanych danych
                    success: function (response) {
                        console.log("Scraping started successfully. Response:", response);
                        // Możesz tu dodać jakieś powiadomienie dla użytkownika
                        alert("Rozpoczęto scrapowanie: " + response);
                     
                    },
                    error: function (xhr, status, error) {
                        console.error("Error starting scraping: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                        alert("Błąd podczas uruchamiania scrapowania: " + xhr.responseText);
                    }
                });
            }


             // NOWA FUNKCJA DO ZATRZYMYWANIA SCRAPOWANIA
            function stopScrapingProcess() {
                console.log("Sending POST request to stop scraping...");
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("StopScraping", "GoogleScraper")', // Endpoint zdefiniowany jako [HttpPost("stop")]
                    // Dla tego żądania nie są potrzebne dodatkowe dane
                    success: function (response) {
                        console.log("Stop request sent successfully. Response:", response);
                        alert("Wysłano żądanie zatrzymania scrapowania. " + response);
                        // Możesz rozważyć dodanie logiki do UI, np. zablokowanie przycisku "Uruchom"
                        // lub odświeżenie listy produktów po pewnym czasie.
                    },
                    error: function (xhr, status, error) {
                        console.error("Error sending stop request: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                        alert("Błąd podczas wysyłania żądania zatrzymania: " + xhr.responseText);
                    }
                });
            }

            // ... (reszta funkcji JavaScript: updatePendingProducts, resetNotFoundProducts, itd. bez zmian) ...
            function updatePendingProducts() {
                console.log("Sending POST request to update pending products...");
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdatePendingProducts", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (response) {
                        console.log("Pending products updated successfully.");
                        loadProducts();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error updating pending products: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                    }
                });
            }

            function resetNotFoundProducts() {
                console.log("Sending POST request to reset not found products...");
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ResetNotFoundProducts", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (response) {
                        console.log("Not Found products reset successfully.");
                        loadProducts();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error resetting not found products: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                    }
                });
            }

            function resetIncorrectGoogleStatuses() {
                console.log("Sending POST request to reset incorrect Google statuses...");
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ResetIncorrectGoogleStatuses", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (response) {
                        console.log("Incorrect Google statuses reset successfully.");
                        loadProducts();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error resetting incorrect Google statuses: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                    }
                });
            }

            function clearGoogleUrls() {
                console.log("Sending POST request to clear Google URLs...");
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ClearGoogleUrls", "GoogleScraper")',
                    data: { storeId: '@storeId' },
                    success: function (response) {
                        console.log("Google URLs cleared successfully.");
                        loadProducts();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error clearing Google URLs: ", error);
                        console.error("Response status: ", status);
                        console.error("Response details: ", xhr.responseText);
                    }
                });
            }

            function updateTable(products) {
                console.log("Updating product table...");

                $('#productTable').empty();
                var foundCount = 0;
                var pendingCount = 0;
                var notFoundCount = 0;

                $.each(products, function (index, product) {
                    console.log("Processing product:", product);

                    var foundOnGoogleBadge = '<span class="badge bg-secondary">Pending</span>';
                    if (product.foundOnGoogle === true) {
                        foundOnGoogleBadge = '<span class="badge bg-success">Found</span>';
                        foundCount++;
                    } else if (product.foundOnGoogle === false) {
                        foundOnGoogleBadge = '<span class="badge bg-danger">Not Found</span>';
                        notFoundCount++;
                    } else {
                        pendingCount++;
                    }

                    var googleUrl = product.googleUrl || '';

                    var row = '<tr id="productRow-' + product.productId + '">' +
                        '<td>' + product.productNameInStoreForGoogle + '</td>' +
                        '<td><a href="' + product.url + '" target="_blank">' + product.url + '</a></td>' +
                        '<td>' + foundOnGoogleBadge + '</td>' +
                        '<td><a href="' + googleUrl + '" target="_blank">' + googleUrl + '</a></td>' +
                        '</tr>';

                    $('#productTable').append(row);
                });

                console.log("Updating counts: Found:", foundCount, "Pending:", pendingCount, "Not Found:", notFoundCount);
                updateProductCounts(foundCount, pendingCount, notFoundCount);
            }

            function updateProductCounts(foundCount, pendingCount, notFoundCount) {
                console.log("Updating UI counts...");
                $('#foundCount').text(foundCount);
                $('#pendingCount').text(pendingCount);
                $('#notFoundCount').text(notFoundCount);
            }
        });
    </script>
}