@using PriceSafari.Models
@model PriceSafari.Models.AutomationRule

@{
    bool isEdit = Model.Id > 0;
    ViewData["Title"] = isEdit ? "Edycja Reguły" : "Nowa Reguła";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<style>
    .mode-switch-container {
        display: flex;
        background-color: #f1f3f9;
        border-radius: 8px;
        padding: 4px;
        width: fit-content;
        margin-bottom: 20px;
    }

    .mode-switch-btn {
        border: none;
        background: transparent;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        color: #858796;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .mode-switch-btn.active {
            background-color: #fff;
            color: #4e73df;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

            .mode-switch-btn.active i {
                color: #4e73df;
            }

    .preset-selection-box {
        border: 1px dashed #d1d3e2;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background-color: #f8f9fc;
        transition: all 0.2s;
    }

        .preset-selection-box:hover {
            border-color: #4e73df;
            background-color: #fff;
        }

    .preset-name-display {
        font-weight: 700;
        color: #4e73df;
        font-size: 1.1em;
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        @(isEdit ? "Edytuj regułę automatyzacji" : "Kreator nowej reguły")
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="@(isEdit ? "Edit" : "Create")" method="post" id="automationRuleForm">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="StoreId" />
                        <input type="hidden" asp-for="CompetitorPresetId" id="CompetitorPresetId" />
                        <input type="hidden" asp-for="StrategyMode" id="StrategyModeInput" />

                        <h5 class="font-weight-bold text-gray-800 mb-3">1. Podstawowe informacje</h5>
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="small font-weight-bold">Nazwa reguły</label>
                                    <input asp-for="Name" class="form-control" placeholder="np. Agresywna walka o Top 3" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="small font-weight-bold">Kolor etykiety</label>
                                    <div class="input-group">
                                        <input asp-for="ColorHex" type="color" class="form-control" style="height: 38px; padding: 2px; max-width: 60px;" id="ColorHexInput" />
                                        <input type="text" class="form-control" value="@Model.ColorHex" readonly style="background-color:#fff;" id="ColorHexText">
                                    </div>
                                    <span asp-validation-for="ColorHex" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="small font-weight-bold">Źródło Danych</label>
                            <select asp-for="SourceType" class="form-control" id="SourceTypeSelect" asp-items="Html.GetEnumSelectList<PriceSafari.Models.AutomationSourceType>()">
                            </select>
                            <small class="form-text text-muted">
                                Wybór źródła determinuje dostępne presety konkurencji. Zmiana źródła zresetuje wybrany preset.
                            </small>
                        </div>

                        <hr class="my-4" />

                        <h5 class="font-weight-bold text-gray-800 mb-3">2. Strategia cenowa</h5>

                        <div class="mode-switch-container">
                            <button type="button" class="mode-switch-btn @(Model.StrategyMode == AutomationStrategyMode.Competitiveness ? "active" : "")"
                                    onclick="setStrategyMode(0, this)">
                                <i class="fa-solid fa-bolt"></i> Lider Rynku
                            </button>

                            <button type="button" class="mode-switch-btn @(Model.StrategyMode == AutomationStrategyMode.Profit ? "active" : "")"
                                    onclick="setStrategyMode(1, this)">
                                <i class="fa-solid fa-dollar-sign"></i> Rentowność
                            </button>
                        </div>
                        <p class="small text-muted" id="strategyDescription">
                            @(Model.StrategyMode == AutomationStrategyMode.Competitiveness
                                                        ? "Strategia nastawiona na zdobycie jak najwyższej pozycji w rankingu cenowym."
                                                        : "Strategia nastawiona na maksymalizację marży przy zachowaniu akceptowalnego poziomu sprzedaży.")
                        </p>

                        <hr class="my-4" />

                        <h5 class="font-weight-bold text-gray-800 mb-3">3. Konkurencja (Preset)</h5>
                        <p class="mb-3">Wybierz zestaw filtrów konkurencji dla tej reguły.</p>

                        <div class="preset-selection-box" id="openPresetSelectorBtn">
                            <div class="mb-2 text-gray-500 small text-uppercase font-weight-bold">Wybrany Preset</div>
                            <div class="preset-name-display" id="selectedPresetName">
                                @(Model.CompetitorPreset != null ? Model.CompetitorPreset.PresetName : "Domyślny (Wszystkie sklepy)")
                            </div>
                            <div class="mt-2 btn btn-sm btn-outline-primary">
                                <i class="fas fa-list"></i> Zmień Preset
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-group form-check mb-0">
                                <input class="form-check-input" asp-for="IsActive" />
                                <label class="form-check-label" asp-for="IsActive">
                                    Reguła aktywna
                                </label>
                            </div>

                            <div>
                                <a asp-action="Index" asp-route-storeId="@Model.StoreId" asp-route-filterType="@Model.SourceType" class="btn btn-secondary mr-2">Anuluj</a>
                                <button type="submit" class="btn btn-success px-4">
                                    <i class="fas fa-save"></i> Zapisz regułę
                                </button>
                            </div>
                        </div>
                    </form>
                    <div asp-validation-summary="All" class="alert alert-danger"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="dynamicModalContainer">
    @if (Model.SourceType == PriceSafari.Models.AutomationSourceType.Marketplace)
    {
        @await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_PresetyMarketPlace.cshtml", null, new ViewDataDictionary(ViewData) { { "StoreId", Model.StoreId } })
    }
    else
    {
        @await Html.PartialAsync("~/Views/Shared/PartialViewsPanel/_PresetyPriceComparison.cshtml", null, new ViewDataDictionary(ViewData) { { "StoreId", Model.StoreId } })
    }
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var storeId = @Model.StoreId;
        window.presetContext = 'automationRule';
        var presetTypeContext = @((int)Model.SourceType);
        var getModalUrl = '@Url.Action("GetModalPartial", "AutomationRules")';
    </script>

    <script src="~/js/member/CompetitorModal.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // A. Obsługa przycisku otwierania modala
            var btnOpen = document.getElementById('openPresetSelectorBtn');
            if (btnOpen) {
                btnOpen.addEventListener('click', function() {
                    var modalEl = document.getElementById('competitorModal');
                    if (!modalEl) {
                        alert("Błąd: Modal nie został załadowany.");
                        return;
                    }

                    if (typeof window.openCompetitorsModal === 'function') {
                        window.openCompetitorsModal();
                    }
                });
            }

            // B. Obsługa zmiany źródła danych
            var selectSource = document.getElementById('SourceTypeSelect');
            if (selectSource) {
                selectSource.addEventListener('change', async function() {
                    const newType = parseInt(this.value);
                    presetTypeContext = newType;

                    var inputId = document.getElementById('CompetitorPresetId');
                    var labelName = document.getElementById('selectedPresetName');
                    if(inputId) inputId.value = '';
                    if(labelName) labelName.innerText = "Domyślny (Wszystkie sklepy)";
                    if (window.currentPreset) window.currentPreset = null;

                    await loadModalHTML(newType);
                });
            }

            // C. Obsługa koloru
            var colorInput = document.getElementById('ColorHexInput');
            if(colorInput){
                colorInput.addEventListener('input', function() {
                    document.getElementById('ColorHexText').value = this.value;
                });
            }
        });

        // Funkcja ładowania HTML
        async function loadModalHTML(typeValue) {
            try {
                const response = await fetch(`${getModalUrl}?type=${typeValue}&storeId=${storeId}`);
                if (!response.ok) throw new Error("Błąd sieci");

                const html = await response.text();
                var container = document.getElementById('dynamicModalContainer');
                if (container) {
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error("Błąd ładowania modala:", error);
            }
        }

        // =======================================================================
        // POPRAWIONA FUNKCJA ZAMYKANIA (Rozwiązuje problem $(...).modal is not a function)
        // =======================================================================
        window.selectPresetForAutomation = function(presetId, presetName) {
            // 1. Ustaw dane w formularzu
            var inputId = document.getElementById('CompetitorPresetId');
            var labelName = document.getElementById('selectedPresetName');

            if(inputId) inputId.value = presetId;
            if(labelName) labelName.innerText = presetName;

            // 2. Zamknij modal "ręcznie" (Vanilla JS) - działa zawsze
            var m = document.getElementById('competitorModal');
            if (m) {
                // Usuwamy klasy Bootstrapa
                m.classList.remove('show');
                m.style.display = 'none';
                m.setAttribute('aria-hidden', 'true');
                m.removeAttribute('aria-modal');
                m.removeAttribute('role');
            }

            // 3. Posprzątaj tło (Backdrop) i Scrollbara na body
            var backdrops = document.getElementsByClassName('modal-backdrop');
            while(backdrops.length > 0){
                backdrops[0].parentNode.removeChild(backdrops[0]);
            }

            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        };

        // Zmiana trybu strategii
        window.setStrategyMode = function(modeValue, btn) {
            var input = document.getElementById('StrategyModeInput');
            if(input) input.value = modeValue;

            document.querySelectorAll('.mode-switch-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            const desc = document.getElementById('strategyDescription');
            if(desc) {
                desc.innerText = modeValue === 0
                    ? "Strategia nastawiona na zdobycie jak najwyższej pozycji w rankingu cenowym."
                    : "Strategia nastawiona na maksymalizację marży przy zachowaniu akceptowalnego poziomu sprzedaży.";
            }
        }
    </script>
}