



@model AllegroScrapeViewModel
@using PriceSafari.Models.ManagerViewModels
@using PriceSafari.ScrapersControllers
@using PriceSafari.Services.AllegroServices
@using System.Text.Json;
@{
    ViewData["Title"] = "Scrapowanie Ofert Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<style>
    .scraper-card {
        transition: all 0.3s ease;
        border-left: 4px solid #6c757d;
    }

        .scraper-card.status-busy {
            border-left-color: #17a2b8;
        }

        .scraper-card.status-idle {
            border-left-color: #28a745;
        }

        .scraper-card.status-offline {
            border-left-color: #dc3545;
        }

        .scraper-card.status-stopped {
            border-left-color: #ffc107;
        }
        /* NOWY STATUS DLA NUKE */
        .scraper-card.status-resettingnetwork {
            border-left-color: #6f42c1;
            background-color: #f8f3ff;
        }

    .log-entry {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        padding: 4px 8px;
        border-bottom: 1px solid #eee;
    }

        .log-entry.level-error {
            background-color: #ffe6e6;
        }

        .log-entry.level-warning {
            background-color: #fff3cd;
        }

        .log-entry.level-success {
            background-color: #d4edda;
        }

        .log-entry.level-info {
            background-color: #f8f9fa;
        }

        .log-entry.level-nuke {
            background-color: #e2d9f3;
            border-left: 3px solid #6f42c1;
        }
    /* Styl dla logów NUKE */

    .stat-mini {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .progress-thin {
        height: 4px;
    }

    .scraper-actions button {
        padding: 2px 8px;
        font-size: 0.75rem;
    }

    .ip-badge {
        font-family: monospace;
        font-size: 0.7rem;
        background: #eee;
        padding: 2px 4px;
        border-radius: 3px;
    }
</style>

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Zeskanowane URL</div>
                        <div id="stats-scraped" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.ScrapedUrls / @Model.Stats.TotalUrls</div>
                        <div class="progress progress-thin mt-2">
                            @{
                                var scrapedPercent = Model.Stats.TotalUrls > 0 ? (double)Model.Stats.ScrapedUrls / Model.Stats.TotalUrls * 100 : 0;
                            }
                            <div class="progress-bar bg-success" style="width: @scrapedPercent.ToString("F1")%"></div>
                        </div>
                    </div>
                    <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Zebrane Ceny</div>
                        <div id="stats-prices" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.TotalPricesCollected</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-tags fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Odrzucone URL</div>
                        <div id="stats-rejected" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.RejectedUrls</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-times-circle fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Prędkość / Czas</div>
                        <div id="stats-speed" class="h5 mb-0 font-weight-bold text-gray-800">---</div>
                        <div id="stats-timer" class="text-xs text-muted">00:00:00</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-tachometer-alt fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-toggle-on"></i> Panel Sterowania</h5>
                <div>
                    @if (Model.CurrentStatus == ScrapingProcessStatus.Running)
                    {
                        <span id="process-status-badge" class="badge bg-success">URUCHOMIONY</span>
                    }
                    else
                    {
                        <span id="process-status-badge" class="badge bg-danger">ZATRZYMANY</span>
                    }
                </div>
            </div>
            <div class="card-body" id="process-control-panel">
                @{
                    var anyScraperOnline = Model.ActiveScrapers.Any(s => s.Status != ScraperLiveStatus.Offline && s.Status != ScraperLiveStatus.Stopped);
                }

                <div class="mb-3">
                    <form id="stop-form" asp-controller="AllegroScrape" asp-action="StopScraping" method="post" class="d-inline" style="@(Model.CurrentStatus == ScrapingProcessStatus.Running ? "" : "display:none;")">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger"><i class="fas fa-stop-circle"></i> Zatrzymaj</button>
                    </form>

                    <form id="start-form" asp-controller="AllegroScrape" asp-action="StartScraping" method="post" class="d-inline" style="@(Model.CurrentStatus == ScrapingProcessStatus.Running ? "display:none;" : "")">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success" id="start-scraping-btn" disabled="@(!anyScraperOnline)">
                            <i class="fas fa-play-circle"></i> Uruchom
                        </button>
                    </form>

                    <form asp-action="PrepareUrls" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Przygotuj URL-e</button>
                    </form>
                </div>

                <div class="mb-2">
                    <form asp-action="TriggerApiProcessing" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-secondary">
                            <i class="fas fa-database"></i> Pobierz z API
                        </button>
                    </form>

                    <form asp-action="ClearApiData" method="post" class="d-inline" onsubmit="return confirm('Wyczyścić dane API?');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eraser"></i> Wyczyść API
                        </button>
                    </form>

                    <form asp-action="DeleteAll" method="post" class="d-inline" onsubmit="return confirm('USUNĄĆ WSZYSTKIE oferty?');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> Usuń wszystko</button>
                    </form>
                </div>

                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <span id="dashboard-scrapers-online">0</span> scraperów online |
                        <span id="dashboard-active-batches">0</span> aktywnych paczek |
                        <span id="dashboard-batches-done">0</span> ukończonych |
                        <span id="dashboard-nukes-total">0</span> restartów sieci (NUKE)
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-robot"></i> Scrapery</h5>
                <small class="text-muted">Timeout paczki: @AllegroScrapeManager.BatchTimeoutSeconds s</small>
            </div>
            <div class="card-body" id="scrapers-container" style="max-height: 350px; overflow-y: auto;">
                @if (!Model.ScrapersDetails.Any())
                {
                    <p class="text-muted" id="no-scrapers-info">Brak aktywnych scraperów. Uruchom skrypt Python.</p>
                }
                else
                {
                    @foreach (var scraper in Model.ScrapersDetails)
                    {
                        // Renderowanie początkowe (HTML) jest robione przez JS, tutaj placeholder
                        // Możesz skopiować logikę z JS jeśli chcesz renderowanie SSR
                        <div class="scraper-placeholder" data-scraper-name="@scraper.Name">Loading...</div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal"></i> Logi (ostatnie 50)</h5>
                <button class="btn btn-sm btn-outline-secondary" id="clear-logs-btn">
                    <i class="fas fa-eraser"></i> Wyczyść widok
                </button>
            </div>
            <div class="card-body p-0" id="logs-container" style="max-height: 200px; overflow-y: auto;">
                @if (Model.RecentLogs.Any())
                {
                    @foreach (var log in Model.RecentLogs)
                    {
                        <div class="log-entry level-@log.Level.ToLower()">
                            <span class="text-muted">[@log.Timestamp.ToLocalTime().ToString("HH:mm:ss")]</span>
                            <strong>[@log.ScraperName]</strong>
                            @if (!string.IsNullOrEmpty(log.BatchId))
                            {
                                <code>@log.BatchId</code>
                            }
                            @log.Message
                        </div>
                    }
                }
                else
                {
                    <div class="p-3 text-muted text-center">Brak logów</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list-ul"></i> Przygotowane Oferty (<span id="prepared-offers-count">@Model.PreparedOffers.Count</span>)</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="max-height: 60vh;">
            <table class="table table-striped table-sm table-hover">
                <thead class="table-dark" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 35%;">URL Oferty Allegro</th>
                        <th style="width: 15%;">Powiązane ID</th>
                        <th class="text-center" style="width: 10%;">Status Scrap.</th>
                        <th class="text-center" style="width: 30%;">Dane API</th>
                        <th class="text-center" style="width: 10%;">Zebrane</th>
                    </tr>
                </thead>
                <tbody id="offers-table-body">
                    @if (Model.PreparedOffers.Any())
                    {
                        @foreach (var offer in Model.PreparedOffers)
                        {
                            <tr id="offer-row-@offer.Id">
                                <td>
                                    <a href="@offer.AllegroOfferUrl" target="_blank" rel="noopener noreferrer" title="@offer.AllegroOfferUrl">
                                        @(offer.AllegroOfferUrl.Length > 60 ? offer.AllegroOfferUrl.Substring(0, 60) + "..." : offer.AllegroOfferUrl)
                                    </a>
                                </td>
                                <td>@string.Join(", ", offer.AllegroProductIds)</td>
                                <td class="text-center status-cell">
                                    @if (offer.IsProcessing)
                                    {
                                        <span class="badge bg-primary"><i class="fas fa-spinner fa-spin me-1"></i>Przetwarzanie</span>
                                    }
                                    else if (offer.IsRejected)
                                    {
                                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Odrzucona</span>
                                    }
                                    else if (offer.IsScraped)
                                    {
                                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>Zeskanowana</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Oczekuje</span>
                                    }
                                </td>
                                <td class="text-center api-data-cell" style="font-size: 0.85rem;">
                                    @if (offer.IsApiProcessed == true)
                                    {
                                        <div class="d-flex flex-column align-items-start pl-3">
                                            <div><strong>User:</strong> <span class="text-success">@offer.ApiAllegroPriceFromUser?.ToString("F2") zł</span></div>
                                            <div><strong>Allegro:</strong> <span class="text-primary">@offer.ApiAllegroPrice?.ToString("F2") zł</span></div>
                                            <div><strong>Prowizja:</strong> <span class="text-danger">@offer.ApiAllegroCommission?.ToString("F2") zł</span></div>
                                            <div class="mt-1">
                                                @if (offer.IsSubsidyActive == true)
                                                {
                                                    <span class="badge bg-info">DOPŁATA</span>
                                                }
                                                @if (offer.AnyPromoActive == true)
                                                {
                                                    <span class="badge bg-warning text-dark">PROMO</span>
                                                }
                                                @if (!string.IsNullOrEmpty(offer.AllegroEan))
                                                {
                                                    <span class="badge bg-secondary">EAN</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Brak danych API</span>
                                    }
                                </td>
                                <td class="text-center prices-cell">
                                    <span class="badge bg-info">@offer.CollectedPricesCount</span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="no-offers-row">
                            <td colspan="5" class="text-center text-muted">Brak przygotowanych ofert. Kliknij "Przygotuj URL-e".</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const initialState = @Html.Raw(Json.Serialize(new
            {
                        stats = Model.Stats,
                        scrapingStartTime = AllegroScrapeManager.ScrapingStartTime,
                        scrapingEndTime = AllegroScrapeManager.ScrapingEndTime,
                        isInitiallyRunning = Model.CurrentStatus == ScrapingProcessStatus.Running,
                        initialScrapers = Model.ScrapersDetails // Przekazujemy scrapery na start
            }));

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/scrapingHub")
            .withAutomaticReconnect()
            .build();

            let stats = {
                total: initialState.stats.totalUrls,
                scraped: initialState.stats.scrapedUrls,
                rejected: initialState.stats.rejectedUrls,
                prices: initialState.stats.totalPricesCollected
            };

            let scrapingStartTime = initialState.scrapingStartTime ? new Date(initialState.scrapingStartTime) : null;
            let scrapingEndTime = initialState.scrapingEndTime ? new Date(initialState.scrapingEndTime) : null;
            let timerInterval = null;

            // Inicjalizacja scraperów na start (żeby nie było pusto przed pierwszym sygnałem)
            if (initialState.initialScrapers && initialState.initialScrapers.length > 0) {
                 const container = document.getElementById('scrapers-container');
                 const placeholder = document.getElementById('no-scrapers-info');
                 if (placeholder) placeholder.remove();

                 initialState.initialScrapers.forEach(scraper => renderScraper(scraper));
            }

            // === HELPERS ===

            function formatDuration(seconds) {
                if (seconds < 0) seconds = 0;
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            function updateStatsDisplay() {
                document.getElementById('stats-scraped').textContent = `${stats.scraped} / ${stats.total}`;
                document.getElementById('stats-prices').textContent = stats.prices;
                document.getElementById('stats-rejected').textContent = stats.rejected;

                const percent = stats.total > 0 ? (stats.scraped / stats.total * 100) : 0;
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) progressBar.style.width = `${percent.toFixed(1)}%`;
            }

            function updateTimerAndSpeed(isFinalUpdate = false) {
                if (!scrapingStartTime) return;
                const endTime = scrapingEndTime || new Date();
                const elapsedSeconds = (endTime - scrapingStartTime) / 1000;
                document.getElementById('stats-timer').textContent = formatDuration(elapsedSeconds);

                const processedCount = stats.scraped + stats.rejected;
                if (elapsedSeconds > 1 && processedCount > 0) {
                    const speedPerSecond = processedCount / elapsedSeconds;
                    document.getElementById('stats-speed').textContent = `${speedPerSecond.toFixed(2)} URL/s`;
                }
            }

            function startTimer() {
                if (timerInterval) clearInterval(timerInterval);
                if (scrapingStartTime) {
                    scrapingEndTime = null;
                    updateTimerAndSpeed();
                    timerInterval = setInterval(() => updateTimerAndSpeed(false), 1000);
                }
            }

            function stopTimer() {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = null;
                updateTimerAndSpeed(true);
            }

            function getStatusBadgeClass(status) {
                switch (status.toLowerCase()) {
                    case 'busy': return 'bg-info';
                    case 'idle': return 'bg-success';
                    case 'stopped': return 'bg-warning text-dark';
                    case 'resettingnetwork': return 'bg-primary'; // Fioletowy dla NUKE
                    case 'offline': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            function updateStartButtonState() {
                const startButton = document.getElementById('start-scraping-btn');
                const isRunning = document.getElementById('process-status-badge')?.classList.contains('bg-success');
                if (!startButton) return;

                const onlineScrapers = document.querySelectorAll('.scraper-card:not(.status-offline):not(.status-stopped)').length;
                startButton.disabled = isRunning || onlineScrapers === 0;
            }

            // === RENDER SCRAPER ===

            function renderScraper(scraper) {
                const container = document.getElementById('scrapers-container');
                let card = document.getElementById(`scraper-card-${scraper.name}`);

                // Usuń placeholder
                const placeholder = document.getElementById('no-scrapers-info');
                if (placeholder) placeholder.remove();

                const statusLower = scraper.status.toLowerCase();
                const hibernationBadge = scraper.isManuallyPaused
                    ? '<span class="badge bg-warning text-dark ms-1">HIBERNACJA</span>' : '';

                // NOWE: Badge dla NUKE
                const nukeBadge = scraper.status === 'ResettingNetwork'
                    ? '<span class="badge bg-light text-dark border ms-1"><i class="fas fa-radiation"></i> NUKE</span>'
                    : '';

                const pauseResumeBtn = scraper.isManuallyPaused
                    ? `<form action="/AllegroScrape/ResumeScraper" method="post" class="d-inline">
                          <input type="hidden" name="__RequestVerificationToken" value="${document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''}" />
                          <input type="hidden" name="scraperName" value="${scraper.name}" />
                          <button type="submit" class="btn btn-outline-success btn-sm" title="Wznów"><i class="fas fa-play"></i></button>
                        </form>`
                    : `<form action="/AllegroScrape/PauseScraper" method="post" class="d-inline">
                          <input type="hidden" name="__RequestVerificationToken" value="${document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''}" />
                          <input type="hidden" name="scraperName" value="${scraper.name}" />
                          <button type="submit" class="btn btn-outline-warning btn-sm" title="Zatrzymaj"><i class="fas fa-pause"></i></button>
                        </form>`;

                const batchInfo = scraper.currentBatchId
                    ? `<div class="mt-1 stat-mini">
                          <i class="fas fa-spinner fa-spin"></i>
                          Paczka: <code class="scraper-current-batch">${scraper.currentBatchId}</code>
                          (<span class="scraper-batch-urls">${scraper.activeBatchTaskCount || 0}</span> URLi)
                        </div>`
                    : '';

                const timeoutInfo = scraper.batchesTimedOut > 0
                    ? `<span class="text-danger ms-1">(<span class="scraper-timeouts">${scraper.batchesTimedOut}</span> timeout)</span>` : '';

                const nukeInfo = scraper.nukeCount > 0
                    ? `<span class="text-primary ms-1" title="Liczba resetów sieci"><i class="fas fa-radiation"></i> ${scraper.nukeCount}</span>` : '';

                const lastSeen = new Date(scraper.lastCheckIn).toLocaleTimeString('pl-PL');
                const ipInfo = scraper.currentIpAddress ? `<span class="ip-badge ms-2" title="Aktualne IP"><i class="fas fa-network-wired"></i> ${scraper.currentIpAddress}</span>` : '';

                const cardHtml = `
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${scraper.name}</strong>
                                <span class="badge ms-2 scraper-status-badge ${getStatusBadgeClass(scraper.status)}">${scraper.status}</span>
                                ${hibernationBadge}
                                ${nukeBadge}
                            </div>
                            <div class="scraper-actions">${pauseResumeBtn}</div>
                        </div>

                        <div class="row mt-2 stat-mini">
                            <div class="col-4">
                                <i class="fas fa-check text-success"></i> <span class="scraper-urls-success">${scraper.totalUrlsSuccess}</span> OK
                                <i class="fas fa-times text-danger ms-2"></i> <span class="scraper-urls-failed">${scraper.totalUrlsFailed}</span> błędy
                            </div>
                            <div class="col-4">
                                <i class="fas fa-tachometer-alt"></i> <span class="scraper-speed">${(scraper.urlsPerMinute || 0).toFixed(1)}</span> URL/min
                            </div>
                            <div class="col-4">
                                <i class="fas fa-boxes"></i> Paczka #${scraper.currentBatchNumber}
                                ${timeoutInfo} ${nukeInfo}
                            </div>
                        </div>

                        ${batchInfo}

                        <div class="mt-1 stat-mini text-muted d-flex justify-content-between">
                            <span><i class="fas fa-clock"></i> Ostatni kontakt: <span class="scraper-last-seen">${lastSeen}</span></span>
                            ${ipInfo}
                        </div>
                    </div>
                `;

                if (!card) {
                    card = document.createElement('div');
                    card.id = `scraper-card-${scraper.name}`;
                    card.className = `scraper-card card mb-2 status-${statusLower}`;
                    card.dataset.scraperName = scraper.name;
                    container.appendChild(card);
                } else {
                    card.className = `scraper-card card mb-2 status-${statusLower}`;
                }

                card.innerHTML = cardHtml;
                updateStartButtonState();
            }

            // === RENDER LOGS ===

            function renderLogs(logs) {
                const container = document.getElementById('logs-container');
                if (!logs || logs.length === 0) {
                    container.innerHTML = '<div class="p-3 text-muted text-center">Brak logów</div>';
                    return;
                }

                container.innerHTML = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('pl-PL');
                    const batchCode = log.batchId ? `<code>${log.batchId}</code> ` : '';
                    return `<div class="log-entry level-${log.level.toLowerCase()}">
                        <span class="text-muted">[${time}]</span>
                        <strong>[${log.scraperName}]</strong>
                        ${batchCode}${log.message}
                    </div>`;
                }).join('');

                container.scrollTop = 0;
            }

            // === RENDER OFFER ROW ===

            function renderOfferRowStatus(offer) {
                if (offer.isProcessing) return '<span class="badge bg-primary"><i class="fas fa-spinner fa-spin me-1"></i>Przetwarzanie</span>';
                if (offer.isRejected) return '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Odrzucona</span>';
                if (offer.isScraped) return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Zeskanowana</span>';
                return '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Oczekuje</span>';
            }

            // === SIGNALR HANDLERS ===

            connection.on("UpdateDetailScraperStatus", renderScraper);

            connection.on("UpdateScrapingProcessStatus", (statusUpdate) => {
                const statusBadge = document.getElementById('process-status-badge');
                const startForm = document.getElementById('start-form');
                const stopForm = document.getElementById('stop-form');

                const isRunning = statusUpdate.status === 'Running';
                statusBadge.textContent = isRunning ? 'URUCHOMIONY' : 'ZATRZYMANY';
                statusBadge.className = isRunning ? 'badge bg-success' : 'badge bg-danger';

                startForm.style.display = isRunning ? 'none' : 'd-inline';
                stopForm.style.display = isRunning ? 'd-inline' : 'none';

                if (isRunning && statusUpdate.startTime) {
                    scrapingStartTime = new Date(statusUpdate.startTime);
                    startTimer();
                } else {
                    scrapingEndTime = statusUpdate.endTime ? new Date(statusUpdate.endTime) : new Date();
                    stopTimer();
                }
                updateStartButtonState();
            });

            connection.on("UpdateAllegroOfferRow", (offer) => {
                const row = document.getElementById(`offer-row-${offer.id}`);
                if (row) {
                    const oldStatus = {
                        isScraped: row.querySelector('.status-cell .bg-success') !== null,
                        isRejected: row.querySelector('.status-cell .bg-danger') !== null
                    };
                    const oldPriceCount = parseInt(row.querySelector('.prices-cell .badge').textContent) || 0;

                    row.querySelector('.status-cell').innerHTML = renderOfferRowStatus(offer);
                    row.querySelector('.prices-cell').innerHTML = `<span class="badge bg-info">${offer.collectedPricesCount || 0}</span>`;

                    if (!oldStatus.isScraped && offer.isScraped) stats.scraped++;
                    if (oldStatus.isScraped && !offer.isScraped) stats.scraped--;
                    if (!oldStatus.isRejected && offer.isRejected) stats.rejected++;
                    if (oldStatus.isRejected && !offer.isRejected) stats.rejected--;
                    stats.prices += (offer.collectedPricesCount || 0) - oldPriceCount;

                    updateStatsDisplay();
                }
            });

            connection.on("UpdateLogs", renderLogs);

            connection.on("UpdateDashboard", (dashboard) => {
                document.getElementById('dashboard-scrapers-online').textContent = dashboard.scrapersOnline || 0;
                document.getElementById('dashboard-active-batches').textContent = dashboard.activeBatchesCount || 0;
                document.getElementById('dashboard-batches-done').textContent = dashboard.totalBatchesProcessed || 0;
                // Dodane:
                const nukeSpan = document.getElementById('dashboard-nukes-total');
                if (nukeSpan) nukeSpan.textContent = dashboard.totalNukeEvents || 0;
            });

            connection.on("UpdateStats", (newStats) => {
                stats.total = newStats.totalUrls;
                stats.scraped = newStats.scrapedUrls;
                stats.rejected = newStats.rejectedUrls;
                stats.prices = newStats.totalPricesCollected;
                updateStatsDisplay();
            });

            // === CLEAR LOGS ===
            document.getElementById('clear-logs-btn')?.addEventListener('click', () => {
                document.getElementById('logs-container').innerHTML = '<div class="p-3 text-muted text-center">Logi wyczyszczone</div>';
            });

            // === START SIGNALR ===

            async function startSignalR() {
                try {
                    await connection.start();
                    console.log("SignalR Connected ✅");
                    updateStartButtonState();
                    updateStatsDisplay();
                    if (initialState.isInitiallyRunning && scrapingStartTime) startTimer();
                } catch (err) {
                    console.error("SignalR Connection Error:", err);
                    setTimeout(startSignalR, 5000);
                }
            }

            connection.onclose(async () => {
                console.log("SignalR Disconnected. Reconnecting...");
                await startSignalR();
            });

            startSignalR();
        });
    </script>
}