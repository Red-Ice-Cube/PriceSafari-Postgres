@model AllegroScrapeViewModel
@using PriceSafari.Models.ManagerViewModels
@using PriceSafari.ScrapersControllers // Potrzebne dla enumów
@{
    ViewData["Title"] = "Scrapowanie Ofert Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-toggle-on"></i> Panel Sterowania Procesem</h4>
            </div>
            <div class="card-body">
                <p>
                    Aktualny status:
                    @if (Model.CurrentStatus == ScrapingProcessStatus.Running)
                    {
                        <span class="badge bg-success">URUCHOMIONY</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">ZATRZYMANY</span>
                    }
                </p>
                @if (Model.CurrentStatus == ScrapingProcessStatus.Running)
                {
                    <form asp-action="StopScraping" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger"><i class="fas fa-stop-circle"></i> Zatrzymaj Scrapowanie</button>
                    </form>
                }
                else
                {
                    <form asp-action="StartScraping" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success"><i class="fas fa-play-circle"></i> Uruchom Scrapowanie</button>
                    </form>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-robot"></i> Aktywne Scrapery Ofert</h4>
            </div>
            <div class="card-body" id="detail-scrapers-list">
                @if (!Model.ActiveScrapers.Any())
                {
                    <p class="text-muted">Brak aktywnych scraperów. Uruchom skrypt w Pythonie.</p>
                }
                @foreach (var scraper in Model.ActiveScrapers)
                {
                    <p id="scraper-@scraper.Name">
                        <strong>@scraper.Name:</strong>
                        @if (scraper.Status == ScraperLiveStatus.Busy)
                        {
                            <span class="badge bg-info">Pracuje (Zadanie @scraper.CurrentTaskId)</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Czeka na zadanie</span>
                        }
                        <small class="text-muted"> widziano: @scraper.LastCheckIn.ToLocalTime().ToString("HH:mm:ss")</small>
                    </p>
                }
            </div>
        </div>
    </div>
</div>

<hr />

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4><i class="fas fa-list-ul"></i> Przygotowane Oferty do Scrapowania (@Model.PreparedOffers.Count)</h4>
        <div>
            <form asp-action="PrepareUrls" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Przygotuj / Scal URL-e</button>
            </form>
            <form asp-action="DeleteAll" method="post" class="d-inline" onsubmit="return confirm('Czy na pewno chcesz usunąć WSZYSTKIE przygotowane oferty?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i> Usuń Wszystkie</button>
            </form>
        </div>
    </div>
    <div class="card-body" style="max-height: 60vh; overflow-y: auto;">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th style="width: 50%;">URL Oferty Allegro</th>
                    <th style="width: 25%;">Powiązane ID Produktów</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Zebrane Oferty</th>
                </tr>
            </thead>
            <tbody id="offers-table-body">
                @if (Model.PreparedOffers.Any())
                {
                    @foreach (var offer in Model.PreparedOffers)
                    {
                        <tr id="offer-row-@offer.Id">
                            <td><a href="@offer.AllegroOfferUrl" target="_blank" rel="noopener noreferrer" title="@offer.AllegroOfferUrl">@offer.AllegroOfferUrl.Substring(0, Math.Min(offer.AllegroOfferUrl.Length, 80))...</a></td>
                            <td>@string.Join(", ", offer.AllegroProductIds)</td>
                            <td class="text-center">
                                @if (offer.IsRejected)
                                {
                                    <span class="badge bg-danger" title="Scraper napotkał błąd i odrzucił ten URL.">❌ Odrzucona</span>
                                }
                                else if (offer.IsScraped)
                                {
                                    <span class="badge bg-success" title="Scrapowanie zakończone.">✅ Zeskanowana</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark" title="Oczekuje na przetworzenie.">⏳ Oczekuje</span>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">@offer.CollectedPricesCount</span>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted">Brak przygotowanych ofert. Kliknij przycisk "Przygotuj / Scal URL-e".</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        // JS do obsługi SignalR (prosta wersja, do rozbudowy)
        const connection = new signalR.HubConnectionBuilder().withUrl("/scrapingHub").build();

        // Funkcja do aktualizacji wiersza w tabeli
        connection.on("UpdateAllegroOfferRow", (offer) => {
            const row = document.getElementById(`offer-row-${offer.id}`);
            if (row) {
                let statusHtml = '';
                if (offer.isRejected) {
                    statusHtml = '<span class="badge bg-danger" title="Scraper napotkał błąd i odrzucił ten URL.">❌ Odrzucona</span>';
                } else if (offer.isScraped) {
                    statusHtml = '<span class="badge bg-success" title="Scrapowanie zakończone.">✅ Zeskanowana</span>';
                } else {
                    statusHtml = '<span class="badge bg-warning text-dark" title="Oczekuje na przetworzenie.">⏳ Oczekuje</span>';
                }
                row.cells[2].innerHTML = statusHtml;
                row.cells[3].innerHTML = `<span class="badge bg-info">${offer.collectedPricesCount}</span>`;
            }
        });

        // Tu można dodać logikę do aktualizacji listy scraperów
        connection.on("UpdateDetailScraperStatus", (scraper) => {
            console.log("Otrzymano status scrapera:", scraper);
       
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
}