@model AllegroScrapeViewModel
@using PriceSafari.Models.ManagerViewModels
@using PriceSafari.ScrapersControllers
@using System.Text.Json;
@{
    ViewData["Title"] = "Scrapowanie Ofert Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Zeskanowane URL</div>
                        <div id="stats-scraped" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.ScrapedUrls / @Model.Stats.TotalUrls</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Zebrane Ceny</div>
                        <div id="stats-prices" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.TotalPricesCollected</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tags fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Odrzucone URL</div>
                        <div id="stats-rejected" class="h5 mb-0 font-weight-bold text-gray-800">@Model.Stats.RejectedUrls</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Prędkość / Czas</div>
                        <div id="stats-speed" class="h5 mb-0 font-weight-bold text-gray-800">---</div>
                        <div id="stats-timer" class="text-xs text-muted">00:00:00</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-toggle-on"></i> Panel Sterowania</h5>
                <div>
                    Aktualny status:
                    @if (Model.CurrentStatus == ScrapingProcessStatus.Running)
                    {
                        <span id="process-status-badge" class="badge bg-success">URUCHOMIONY</span>
                    }
                    else
                    {
                        <span id="process-status-badge" class="badge bg-danger">ZATRZYMANY</span>
                    }
                </div>
            </div>
            <div class="card-body" id="process-control-panel">
                @{
                    var anyScraperOnline = Model.ActiveScrapers.Any(s => s.Status != ScraperLiveStatus.Offline);
                }

                <form id="stop-form" asp-controller="AllegroScrape" asp-action="StopScraping" method="post" class="d-inline" style="@(Model.CurrentStatus == ScrapingProcessStatus.Running ? "" : "display:none;")">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger"><i class="fas fa-stop-circle"></i> Zatrzymaj Scrapowanie</button>
                </form>

                <form id="start-form" asp-controller="AllegroScrape" asp-action="StartScraping" method="post" class="d-inline" style="@(Model.CurrentStatus == ScrapingProcessStatus.Running ? "display:none;" : "")">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-success" id="start-scraping-btn" disabled="@(!anyScraperOnline)" title="@(anyScraperOnline ? "Uruchom proces scrapowania" : "Nie można uruchomić - brak aktywnych scraperów")">
                        <i class="fas fa-play-circle"></i> Uruchom Scrapowanie
                    </button>
                </form>
                <form asp-action="PrepareUrls" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Przygotuj / Scal URL-e</button>
                </form>
                <form asp-action="DeleteAll" method="post" class="d-inline" onsubmit="return confirm('Czy na pewno chcesz usunąć WSZYSTKIE przygotowane oferty?');">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger"><i class="fas fa-trash"></i> Usuń Wszystkie</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot"></i> Aktywne Scrapery Ofert</h5>
            </div>
            <div class="card-body" id="detail-scrapers-list" style="min-height: 125px;">
                @if (!Model.ActiveScrapers.Any())
                {
                    <p class="text-muted" id="no-scrapers-info">Brak aktywnych scraperów. Uruchom skrypt w Pythonie.</p>
                }
                @foreach (var scraper in Model.ActiveScrapers.OrderBy(s => s.Name))
                {
                    <div class="scraper-entry" id="scraper-@scraper.Name">
                        <strong>@scraper.Name:</strong>
                        <span class="badge @(scraper.Status == ScraperLiveStatus.Busy ? "bg-info" : scraper.Status == ScraperLiveStatus.Offline ? "bg-secondary" : "bg-success")">
                            @scraper.Status.ToString()
                        </span>
                        @if (scraper.Status == ScraperLiveStatus.Busy)
                        {
                            <small class="text-muted scraper-task-info">(Pracuje nad: @scraper.CurrentTaskId)</small>
                        }
                        <small class="text-muted scraper-last-seen"> widziano: @scraper.LastCheckIn.ToLocalTime().ToString("HH:mm:ss")</small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list-ul"></i> Przygotowane Oferty do Scrapowania (<span id="prepared-offers-count">@Model.PreparedOffers.Count</span>)</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="max-height: 60vh;">
            <table class="table table-striped table-sm table-hover">
                <thead class="table-dark" style="position: sticky; top: 0;">
                    <tr>
                        <th style="width: 50%;">URL Oferty Allegro</th>
                        <th style="width: 25%;">Powiązane ID Produktów</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Zebrane Oferty</th>
                    </tr>
                </thead>
                <tbody id="offers-table-body">
                    @if (Model.PreparedOffers.Any())
                    {
                        @foreach (var offer in Model.PreparedOffers)
                        {
                            <tr id="offer-row-@offer.Id">
                                <td><a href="@offer.AllegroOfferUrl" target="_blank" rel="noopener noreferrer" title="@offer.AllegroOfferUrl">@(offer.AllegroOfferUrl.Length > 80 ? offer.AllegroOfferUrl.Substring(0, 80) + "..." : offer.AllegroOfferUrl)</a></td>
                                <td>@string.Join(", ", offer.AllegroProductIds)</td>
                                <td class="text-center status-cell">
                                    @if (offer.IsProcessing)
                                    {
                                        <span class="badge bg-primary"><i class="fas fa-spinner fa-spin me-1"></i>Przetwarzanie</span>
                                    }
                                    else if (offer.IsRejected)
                                    {
                                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Odrzucona</span>
                                    }
                                    else if (offer.IsScraped)
                                    {
                                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>Zeskanowana</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Oczekuje</span>
                                    }
                                </td>
                                <td class="text-center prices-cell">
                                    <span class="badge bg-info">@offer.CollectedPricesCount</span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="no-offers-row">
                            <td colspan="4" class="text-center text-muted">Brak przygotowanych ofert. Kliknij przycisk "Przygotuj / Scal URL-e".</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const initialState = @Html.Raw(Json.Serialize(new
            {
                        stats = Model.Stats,
                        scrapingStartTime = AllegroScrapeManager.ScrapingStartTime,
                        scrapingEndTime = AllegroScrapeManager.ScrapingEndTime,
                        isInitiallyRunning = Model.CurrentStatus == ScrapingProcessStatus.Running
            }));

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/scrapingHub")
        .withAutomaticReconnect()
        .build();

            let stats = {
                total: initialState.stats.totalUrls,
                scraped: initialState.stats.scrapedUrls,
                rejected: initialState.stats.rejectedUrls,
                prices: initialState.stats.totalPricesCollected
            };

            let scrapingStartTime = initialState.scrapingStartTime ? new Date(initialState.scrapingStartTime) : null;
            let scrapingEndTime = initialState.scrapingEndTime ? new Date(initialState.scrapingEndTime) : null;
            let timerInterval = null;

            const scraperStatusMap = {
                0: { name: 'Czeka', class: 'bg-success' },
                1: { name: 'Pracuje', class: 'bg-info' },
                2: { name: 'Offline', class: 'bg-secondary' },
                3: { name: 'Resetuje', class: 'bg-warning text-dark' }
            };

            function updateStatsDisplay() {
                document.getElementById('stats-scraped').textContent = `${stats.scraped} / ${stats.total}`;
                document.getElementById('stats-prices').textContent = stats.prices;
                document.getElementById('stats-rejected').textContent = stats.rejected;
            }

            function formatDuration(seconds) {
                if (seconds < 0) seconds = 0;
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }

            function updateTimerAndSpeed(isFinalUpdate = false) {
                if (!scrapingStartTime) return;

                const endTime = scrapingEndTime || new Date();
                const elapsedSeconds = (endTime - scrapingStartTime) / 1000;

                document.getElementById('stats-timer').textContent = formatDuration(elapsedSeconds);

                const processedCount = stats.scraped + stats.rejected;
                if (elapsedSeconds > 1 && processedCount > 0) {
                    const speedPerSecond = processedCount / elapsedSeconds;
                    document.getElementById('stats-speed').textContent = `${speedPerSecond.toFixed(2)} URL/s`;
                } else if (isFinalUpdate) {
                     document.getElementById('stats-speed').textContent = '---';
                } else if (!isFinalUpdate && document.getElementById('process-status-badge').classList.contains('bg-success')) {
                    document.getElementById('stats-speed').textContent = 'Obliczanie...';
                }
            }

            function startTimer() {
                if (timerInterval) clearInterval(timerInterval);
                if (scrapingStartTime) {
                    scrapingEndTime = null;
                    updateTimerAndSpeed();
                    timerInterval = setInterval(() => updateTimerAndSpeed(false), 1000);
                }
            }

            function stopTimer() {
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = null;

                updateTimerAndSpeed(true);
            }

            function updateStartButtonState() {
                const startButton = document.getElementById('start-scraping-btn');
                const isRunning = document.getElementById('process-status-badge').classList.contains('bg-success');
                if (!startButton) return;

                const onlineScrapers = document.querySelectorAll('.scraper-entry .badge:not(.bg-secondary)').length;

                if (isRunning || onlineScrapers === 0) {
                    startButton.disabled = true;
                    startButton.title = isRunning ? 'Proces jest już uruchomiony' : 'Nie można uruchomić - brak aktywnych scraperów';
                } else {
                    startButton.disabled = false;
                    startButton.title = 'Uruchom proces scrapowania';
                }
            }

            function renderScraper(scraper) {
                const list = document.getElementById('detail-scrapers-list');
                let entry = document.getElementById(`scraper-${scraper.name}`);
                const statusInfo = scraperStatusMap[scraper.status] || { name: 'Nieznany', class: 'bg-dark' };
                const taskInfo = scraper.status === 1 && scraper.currentTaskId ? `<small class="text-muted scraper-task-info">(Paczka od #${scraper.currentTaskId})</small>` : '';
                const lastSeen = new Date(scraper.lastCheckIn).toLocaleTimeString();
                const innerHtml = `<strong>${scraper.name}:</strong> <span class="badge ${statusInfo.class}">${statusInfo.name}</span> ${taskInfo} <small class="text-muted scraper-last-seen"> widziano: ${lastSeen}</small>`;

                if (!entry) {
                    const placeholder = document.getElementById('no-scrapers-info');
                    if (placeholder) placeholder.remove();
                    entry = document.createElement('div');
                    entry.id = `scraper-${scraper.name}`;
                    entry.className = 'scraper-entry';
                    list.appendChild(entry);
                }
                entry.innerHTML = innerHtml;
                updateStartButtonState();
            }

            function renderOfferRowStatus(offer) {
                if (offer.isProcessing) {
                    return '<span class="badge bg-primary"><i class="fas fa-spinner fa-spin me-1"></i>Przetwarzanie</span>';
                }
                if (offer.isRejected) {
                    return '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Odrzucona</span>';
                }
                if (offer.isScraped) {
                    return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Zeskanowana</span>';
                }
                return '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Oczekuje</span>';
            }

            connection.on("UpdateDetailScraperStatus", renderScraper);

            connection.on("UpdateScrapingProcessStatus", (statusUpdate) => {
                const statusBadge = document.getElementById('process-status-badge');
                const startForm = document.getElementById('start-form');
                const stopForm = document.getElementById('stop-form');
                if (!statusBadge || !startForm || !stopForm) return;

                const isRunning = statusUpdate.status === 'Running';
                statusBadge.textContent = isRunning ? 'URUCHOMIONY' : 'ZATRZYMANY';
                statusBadge.className = isRunning ? 'badge bg-success' : 'badge bg-danger';

                startForm.style.display = isRunning ? 'none' : 'd-inline';
                stopForm.style.display = isRunning ? 'd-inline' : 'none';

                if (isRunning && statusUpdate.startTime) {
                    scrapingStartTime = new Date(statusUpdate.startTime);
                    startTimer();
                } else {
                    scrapingStartTime = null;
                    stopTimer();
                }
                updateStartButtonState();
            });

            connection.on("UpdateAllegroOfferRow", (offer) => {
                const row = document.getElementById(`offer-row-${offer.id}`);
                if (row) {
                    const oldStatus = {
                        isScraped: row.querySelector('.status-cell .bg-success') !== null,
                        isRejected: row.querySelector('.status-cell .bg-danger') !== null
                    };
                    const oldPriceCount = parseInt(row.querySelector('.prices-cell .badge').textContent) || 0;

                    row.querySelector('.status-cell').innerHTML = renderOfferRowStatus(offer);
                    row.querySelector('.prices-cell').innerHTML = `<span class="badge bg-info">${offer.collectedPricesCount || 0}</span>`;

                    if (!oldStatus.isScraped && offer.isScraped) stats.scraped++;
                    if (oldStatus.isScraped && !offer.isScraped) stats.scraped--;

                    if (!oldStatus.isRejected && offer.isRejected) stats.rejected++;
                    if (oldStatus.isRejected && !offer.isRejected) stats.rejected--;

                    stats.prices += (offer.collectedPricesCount || 0) - oldPriceCount;

                    updateStatsDisplay();
                }
            });

            async function startSignalR() {
                try {
                    await connection.start();
                    console.log("SignalR Connected. ✅");

                    updateStartButtonState();
                    updateStatsDisplay();
                    if (scrapingStartTime) {
                        startTimer();
                    }
                } catch (err) {
                    console.error("SignalR Connection Error: ", err);
                    setTimeout(startSignalR, 5000);
                }
            };

            connection.onclose(async () => {
                console.log("SignalR Disconnected. Trying to reconnect...");
                await startSignalR();
            });

            startSignalR();
        });
    </script>
}