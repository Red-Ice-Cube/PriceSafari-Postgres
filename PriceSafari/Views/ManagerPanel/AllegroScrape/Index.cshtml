@model List<PriceSafari.Models.AllegroOfferToScrape>
@{
    ViewData["Title"] = "Przygotowanie Ofert Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<h1>@ViewData["Title"]</h1>
<p>
    W tym miejscu możesz przygotować listę unikalnych adresów URL ofert Allegro do dalszego, szczegółowego scrapowania.
    Proces ten pobiera wszystkie produkty zebrane przez pierwszy scraper i grupuje je.
</p>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" role="alert">@TempData["SuccessMessage"]</div>
}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4><i class="fas fa-list-ul"></i> Przygotowane Oferty do Scrapowania (@Model.Count)</h4>
        <div>
            <form asp-action="PrepareUrls" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary"><i class="fas fa-cogs"></i> Przygotuj / Scal URL-e</button>
            </form>
            <form asp-action="DeleteAll" method="post" class="d-inline" onsubmit="return confirm('Czy na pewno chcesz usunąć WSZYSTKIE przygotowane oferty?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i> Usuń Wszystkie</button>
            </form>
        </div>
    </div>
    <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th style="width: 50%;">URL Oferty Allegro</th>
                    <th style="width: 25%;">Powiązane ID Produktów</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Zebrane Oferty</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Any())
                {
                    @foreach (var offer in Model)
                    {
                        <tr>
                            <td><a href="@offer.AllegroOfferUrl" target="_blank" rel="noopener noreferrer" title="@offer.AllegroOfferUrl">@offer.AllegroOfferUrl.Substring(0, Math.Min(offer.AllegroOfferUrl.Length, 80))...</a></td>
                            <td>@string.Join(", ", offer.AllegroProductIds)</td>
                            <td class="text-center">
                                @if (offer.IsRejected)
                                {
                                    <span class="badge bg-danger" title="Scraper napotkał błąd (np. 404) i odrzucił ten URL.">❌ Odrzucona</span>
                                }
                                else if (offer.IsScraped)
                                {
                                    <span class="badge bg-success" title="Scrapowanie tego URL-a zostało zakończone.">✅ Zeskanowana</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark" title="Oczekuje na przetworzenie przez scrapera.">⏳ Oczekuje</span>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">@offer.CollectedPricesCount</span>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted">Brak przygotowanych ofert. Kliknij przycisk "Przygotuj / Scal URL-e".</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>