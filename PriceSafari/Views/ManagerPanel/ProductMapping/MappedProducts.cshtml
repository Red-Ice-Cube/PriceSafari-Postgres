@using PriceSafari.Controllers.ManagerControllers  <!-- o ile tam jest klasa MappedProductViewModel -->
@model IEnumerable<PriceSafari.Controllers.ManagerControllers.ProductMappingController.MappedProductViewModel>

@{
    ViewData["Title"] = "Zmapowane Produkty";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var storeId = ViewBag.StoreId ?? 0;
    var storeName = ViewBag.StoreName as string ?? "(brak nazwy sklepu)";

    // Przykładowe statystyki
    var totalCount = Model.Count();
    var googleCount = Model.Count(p => p.HasGoogle);
    var ceneoCount = Model.Count(p => p.HasCeneo);
    var googleCeneoCount = Model.Count(p => p.HasGoogle && p.HasCeneo);
    var notFoundCount = Model.Count(p => !p.HasGoogle && !p.HasCeneo);

    var ceneoImgCount = Model.Count(p => !string.IsNullOrEmpty(p.MainUrlCeneo));
    var googleImgCount = Model.Count(p => !string.IsNullOrEmpty(p.MainUrlGoogle));
    var ceneoNameCount = Model.Count(p => !string.IsNullOrEmpty(p.NameCeneo));
    var googleNameCount = Model.Count(p => !string.IsNullOrEmpty(p.NameGoogle));
    var ceneoEanCount = Model.Count(p => !string.IsNullOrEmpty(p.EanCeneo));
    var googleEanCount = Model.Count(p => !string.IsNullOrEmpty(p.EanGoogle));
    var urlCount = Model.Count(p => !string.IsNullOrEmpty(p.Url));
    var externalIdCount = Model.Count(p => p.ExternalId.HasValue);
}

<h2>Zmapowane Produkty dla sklepu @storeName</h2>
<p>
    Łącznie: @totalCount<br />
    - tylko Google: @googleCount<br />
    - tylko Ceneo: @ceneoCount<br />
    - oba (Google + Ceneo): @googleCeneoCount<br />
    - brak: @notFoundCount
</p>

<!-- Przykładowe formularze (usuwanie produktów, itp.) -->
<form asp-action="RemoveAllProductsForStore" asp-controller="ProductMapping" method="post" class="mt-3">
    <input type="hidden" name="storeId" value="@storeId" />
    <button type="submit" class="btn btn-danger">
        Usuń wszystkie produkty tego sklepu
    </button>
</form>

<form asp-action="RemoveWordFromProductNamesCeneo" method="post" class="mt-3">
    <div class="form-group">
        <label for="wordToRemove">Słowo do usunięcia z nazw produktów:</label>
        <input type="text" class="form-control" id="wordToRemove" name="wordToRemove" placeholder="Wpisz słowo" required>
    </div>
    <button type="submit" class="btn btn-danger">Usuń słowo z nazw produktów</button>
</form>

<form asp-action="CreateOrUpdateProductsFromProductMap" method="post" class="mt-3">
    <input type="hidden" name="storeId" value="@storeId" />
    <div class="form-group mt-2">
        <label>
            <input type="checkbox" name="addGooglePrices" value="true" />
            Dodaj ceny Google (Price + Delivery)
        </label>
    </div>
    <button type="submit" class="btn btn-primary">
        Utwórz lub zaktualizuj produkty
    </button>
</form>

<form method="post" action="@Url.Action("MapProducts", "ProductMapping", new { storeId })" class="mt-3">
    <button type="submit" class="btn btn-primary">Mapuj Produkty</button>
</form>

<hr />

<!-- Filtry status -->
<div class="p-2 mb-3" style="border:1px solid #ccc;">
    <h4>Filtry isScrapable / isRejected</h4>
    <label class="mr-3">
        <input type="checkbox" class="status-filter" data-status="active" />
        Aktywny (isScrapable && !isRejected)
    </label>
    <label class="mr-3">
        <input type="checkbox" class="status-filter" data-status="inactive" />
        Nieaktywny (!isScrapable && !isRejected)
    </label>
    <label class="mr-3">
        <input type="checkbox" class="status-filter" data-status="active-rejected" />
        Odrzucony (isScrapable && isRejected)
    </label>
    <label class="mr-3">
        <input type="checkbox" class="status-filter" data-status="inactive-rejected" />
        Wyłączony (!isScrapable && isRejected)
    </label>
</div>

<!-- Filtry platform -->
<div class="p-2 mb-3" style="border:1px solid #ccc;">
    <h4>Filtry platform (Google/Ceneo)</h4>
    <label class="mr-3">
        <input type="checkbox" class="platform-filter" data-platform="google" />
        Google
    </label>
    <label class="mr-3">
        <input type="checkbox" class="platform-filter" data-platform="ceneo" />
        Ceneo
    </label>
    <label class="mr-3">
        <input type="checkbox" class="platform-filter" data-platform="google-ceneo" />
        Google &amp; Ceneo
    </label>
    <label class="mr-3">
        <input type="checkbox" class="platform-filter" data-platform="not-found" />
        Nie znalezione
    </label>
</div>

<!-- Nowy filtr: różnica w cenie != 0 -->
<div class="p-2 mb-3" style="border:1px solid #ccc;">
    <h4>Filtr różnicy w cenie</h4>
    <label>
        <input type="checkbox" id="show-differences" />
        Pokaż tylko produkty, gdzie różnica w cenie (G - C) jest różna od zera
    </label>
</div>

<button id="remove-filtered" class="btn btn-danger mb-3">
    Usuń odfiltrowane
</button>

<hr />

<!-- Tabela produktów -->
<table class="table table-bordered table-striped" id="product-table">
    <thead>
        <tr>
            <th>Zdjęcie (Ceneo) (@ceneoImgCount)</th>
            <th>Zdjęcie (Google) (@googleImgCount)</th>
            <th>Nazwa (Ceneo) (@ceneoNameCount)</th>
            <th>Nazwa (Google) (@googleNameCount)</th>
            <th>EAN (Ceneo) (@ceneoEanCount)</th>
            <th>EAN (Google) (@googleEanCount)</th>
            <th>URL Produktu (@urlCount)</th>
            <th>URL Ceneo</th>
            <th>URL Google</th>
            <th>IsScrapable</th>
            <th>IsRejected</th>
            <th>External ID (@externalIdCount)</th>
            <th>Cena Google</th>
            <th>Cena Ceneo</th>
            <th>Różnica (G - C)</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var productVm in Model)
        {
            bool hasGoogle = productVm.HasGoogle;
            bool hasCeneo = productVm.HasCeneo;

            // Kategoria platformy
            string platformCategory;
            if (hasGoogle && hasCeneo) platformCategory = "google-ceneo";
            else if (hasGoogle) platformCategory = "google";
            else if (hasCeneo) platformCategory = "ceneo";
            else platformCategory = "not-found";

            // Kategoria statusu
            string statusCategory;
            if (productVm.IsScrapable && productVm.IsRejected) statusCategory = "active-rejected";
            else if (productVm.IsScrapable && !productVm.IsRejected) statusCategory = "active";
            else if (!productVm.IsScrapable && productVm.IsRejected) statusCategory = "inactive-rejected";
            else statusCategory = "inactive";

            // Dla nowego filtra w JS odczytujemy PriceDifference i umieszczamy w atrybucie data-diff
            string diffValue = productVm.PriceDifference.HasValue
            ? productVm.PriceDifference.Value.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)
            : "";

            <tr data-product-id="@productVm.ProductId"
                data-platform="@platformCategory"
                data-status="@statusCategory"
                data-diff="@diffValue">
                <td>
                    @if (!string.IsNullOrEmpty(productVm.MainUrlCeneo))
                    {
                        <img src="@productVm.MainUrlCeneo" alt="CeneoImg" style="width:90px; height:90px; object-fit:contain;" />
                    }
                    else
                    {
                        <div style="width:90px; height:90px; background-color:#f7f7f7;">Brak</div>
                    }
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.MainUrlGoogle))
                    {
                        <img src="@productVm.MainUrlGoogle" alt="GoogleImg" style="width:90px; height:90px; object-fit:contain;" />
                    }
                    else
                    {
                        <div style="width:90px; height:90px; background-color:#f7f7f7;">Brak</div>
                    }
                </td>
                <td>
                    <div style="max-width:200px; white-space:normal;">
                        @if (!string.IsNullOrEmpty(productVm.NameCeneo))
                        {
                            @productVm.NameCeneo
                        }
                        else
                        {
                            <span>(brak)</span>
                        }
                    </div>
                </td>
                <td>
                    <div style="max-width:200px; white-space:normal;">
                        @if (!string.IsNullOrEmpty(productVm.NameGoogle))
                        {
                            @productVm.NameGoogle
                        }
                        else
                        {
                            <span>(brak)</span>
                        }
                    </div>
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.EanCeneo))
                    {
                        @productVm.EanCeneo
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.EanGoogle))
                    {
                        @productVm.EanGoogle
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.Url))
                    {
                        <a href="@productVm.Url" target="_blank">Link</a>
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.UrlCeneo))
                    {
                        <a href="@productVm.UrlCeneo" target="_blank">Link</a>
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (!string.IsNullOrEmpty(productVm.UrlGoogle))
                    {
                        <a href="@productVm.UrlGoogle" target="_blank">Link</a>
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>@productVm.IsScrapable</td>
                <td>@productVm.IsRejected</td>
                <td>
                    @if (productVm.ExternalId.HasValue)
                    {
                        @productVm.ExternalId
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (productVm.LastGooglePrice.HasValue)
                    {
                        @productVm.LastGooglePrice.Value.ToString("F2")
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (productVm.LastCeneoPrice.HasValue)
                    {
                        @productVm.LastCeneoPrice.Value.ToString("F2")
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    @if (productVm.PriceDifference.HasValue)
                    {
                        @productVm.PriceDifference.Value.ToString("F2")
                    }
                    else
                    {
                        <span>(brak)</span>
                    }
                </td>
                <td>
                    <a href="/PriceHistory/Details?productId=@productVm.ProductId&amp;scrapId=@productVm.ScrapId" target="_blank">
                        Szczegóły
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Checkboxy status
            const statusCheckboxes = document.querySelectorAll('.status-filter');
            // Checkboxy platform
            const platformCheckboxes = document.querySelectorAll('.platform-filter');
            // Checkbox "Pokaż tylko różnice w cenie"
            const showDifferencesCheckbox = document.getElementById('show-differences');
            // Przycisk "Usuń odfiltrowane"
            const removeFilteredBtn = document.getElementById('remove-filtered');

            function applyFilters() {
                // 1) Zbierz zaznaczone statusy
                const selectedStatuses = Array.from(statusCheckboxes)
                    .filter(ch => ch.checked)
                    .map(ch => ch.getAttribute('data-status'));

                // 2) Zbierz zaznaczone platformy
                const selectedPlatforms = Array.from(platformCheckboxes)
                    .filter(ch => ch.checked)
                    .map(ch => ch.getAttribute('data-platform'));

                // 3) Czy chcemy pokazywać tylko niezerowe różnice
                const showDifferences = showDifferencesCheckbox.checked;

                // 4) Przelatujemy przez wszystkie wiersze
                const rows = document.querySelectorAll('#product-table tbody tr');
                let visibleCount = 0;

                rows.forEach(row => {
                    const rowStatus = row.getAttribute('data-status');
                    const rowPlatform = row.getAttribute('data-platform');
                    // Wartość data-diff
                    const diffStr = row.getAttribute('data-diff');

                    // A) Filtr isScrapable/isRejected
                    let statusMatch = (selectedStatuses.length === 0 || selectedStatuses.includes(rowStatus));

                    // B) Filtr platformy
                    let platformMatch = (selectedPlatforms.length === 0 || selectedPlatforms.includes(rowPlatform));

                    // C) Filtr różnicy w cenie
                    let differenceMatch = true;
                    if (showDifferences) {
                        // parseFloat
                        let diff = parseFloat(diffStr);
                        if (isNaN(diff) || diff === 0) {
                            differenceMatch = false;
                        }
                    }

                    // Jeśli wszystkie trzy filtry "match" -> wiersz widoczny
                    if (statusMatch && platformMatch && differenceMatch) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Wyświetlamy liczbę widocznych (opcjonalne)
                const countSpan = document.getElementById('visible-count');
                if (countSpan) {
                    countSpan.textContent = visibleCount.toString();
                }
            }

            // Podpinamy eventy
            statusCheckboxes.forEach(ch => ch.addEventListener('change', applyFilters));
            platformCheckboxes.forEach(ch => ch.addEventListener('change', applyFilters));
            showDifferencesCheckbox.addEventListener('change', applyFilters);

            // Usuwanie odfiltrowanych
            removeFilteredBtn.addEventListener('click', () => {
                const rows = document.querySelectorAll('#product-table tbody tr');
                const visibleIds = [];

                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const prodId = row.getAttribute('data-product-id');
                        if (prodId) {
                            visibleIds.push(parseInt(prodId));
                        }
                    }
                });

                if (visibleIds.length === 0) {
                    alert("Brak widocznych produktów do usunięcia.");
                    return;
                }
                if (!confirm("Czy na pewno usunąć " + visibleIds.length + " widocznych produktów?")) {
                    return;
                }

                fetch('@Url.Action("RemoveSelectedProducts", "ProductMapping")?storeId=' + @storeId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(visibleIds)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        rows.forEach(row => {
                            if (row.style.display !== 'none') {
                                row.remove();
                            }
                        });
                        alert("Usunięto widoczne produkty.");
                    } else {
                        alert("Błąd podczas usuwania: " + data.message);
                    }
                })
                .catch(err => console.error(err));
            });

            // Inicjalne wywołanie
            applyFilters();
        });
    </script>
}
