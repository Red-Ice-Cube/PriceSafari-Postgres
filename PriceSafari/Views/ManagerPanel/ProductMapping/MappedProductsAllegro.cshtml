@using PriceSafari.Controllers.ManagerControllers
@model IEnumerable<PriceSafari.Controllers.ManagerControllers.ProductMappingController.MappedProductAllegroViewModel>
@using System.Globalization

@{
    ViewData["Title"] = "Produkty Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";

    var storeId = ViewBag.StoreId ?? 0;
    var storeName = ViewBag.StoreName as string ?? "(Brak nazwy sklepu)";

    var totalCount = Model.Count();
    var activeCount = Model.Count(p => p.IsScrapable && !p.IsRejected);
    var rejectedCount = Model.Count(p => p.IsRejected);
    var inactiveCount = Model.Count(p => !p.IsScrapable && !p.IsRejected);
    var duplicateCount = Model.Count(p => p.IsDuplicate);

    var eanCount = Model.Count(p => !string.IsNullOrEmpty(p.Ean));
    var marginPriceCount = Model.Count(p => p.MarginPrice.HasValue);
}

<div class="container-fluid">
    <h2 class="mt-4">Produkty Allegro dla sklepu: <span class="text-warning">@storeName</span></h2>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <i class="fas fa-chart-pie me-1"></i> Statystyki Allegro
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul>
                        <li>Łącznie produktów: <strong>@totalCount</strong></li>
                        <li class="text-success">Aktywne (Scrapable): @activeCount</li>
                        <li class="text-danger">Odrzucone (Rejected): @rejectedCount</li>
                        <li class="text-muted">Nieaktywne: @inactiveCount</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul>
                        <li>Zdefiniowany EAN: @eanCount</li>
                        <li>Z ceną minimalną (Margin): @marginPriceCount</li>
                        <li class="text-warning fw-bold">Wykryte duplikaty ID: @duplicateCount</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter me-1"></i> Filtry Wyświetlania
        </div>
        <div class="card-body">
            <div class="row align-items-center g-3">

                <div class="col-md-5">
                    <h5 class="mb-2">Status produktu</h5>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input status-filter" type="checkbox" id="statusActive" data-status="active" checked>
                        <label class="form-check-label text-success fw-bold" for="statusActive">Aktywne</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input status-filter" type="checkbox" id="statusInactive" data-status="inactive" checked>
                        <label class="form-check-label text-muted" for="statusInactive">Nieaktywne</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input status-filter" type="checkbox" id="statusRejected" data-status="rejected" checked>
                        <label class="form-check-label text-danger fw-bold" for="statusRejected">Odrzucone</label>
                    </div>
                </div>

                <div class="col-md-3 border-start ps-4">
                    <h5 class="mb-2">Problemy</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showDuplicatesOnly">
                        <label class="form-check-label fw-bold text-warning" for="showDuplicatesOnly">
                            <i class="fas fa-clone"></i> Pokaż tylko duplikaty ID
                        </label>
                    </div>
                </div>

                <div class="col-md-4 border-start ps-4">
                    <h5 class="mb-2">Szukaj w URL (Offer ID)</h5>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="urlSearchInput" class="form-control" placeholder="Wpisz fragment linku lub ID...">
                    </div>
                    <small class="text-muted">Np. wpisz 'offerId' aby znaleźć stary typ linków</small>
                </div>

            </div>

            <div class="mt-3 border-top pt-3">
                <button id="remove-filtered" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-trash-alt me-1"></i> Usuń widoczne na liście
                </button>
                <span id="visible-count" class="ms-3 text-muted">(@totalCount widocznych)</span>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fab fa-allegro me-1 text-warning"></i> Lista Produktów Allegro
        </div>
        <div class="card-body table-responsive">
            <table class="table table-bordered table-hover" id="allegro-table" style="width: 100%;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 20%">Nazwa Produktu</th>
                        <th>Allegro ID</th>
                        <th>EAN</th>
                        <th>Cena Margin</th>
                        <th>Data dodania</th>
                        <th>Scrap?</th>
                        <th>Reject?</th>
                        <th style="width: 25%">Pełny Link (URL)</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted p-4">Brak produktów Allegro dla tego sklepu.</td>
                        </tr>
                    }
                    @foreach (var item in Model)
                    {
                        string statusCategory = "inactive";
                        if (item.IsRejected) { statusCategory = "rejected"; }
                        else if (item.IsScrapable) { statusCategory = "active"; }

                        // Dodajemy data-url aby JS mógł szybko filtrować
                        <tr data-product-id="@item.AllegroProductId"
                            data-status="@statusCategory"
                            data-is-duplicate="@item.IsDuplicate.ToString().ToLower()"
                            data-url="@(item.Url ?? "")">

                            <td>
                                <strong>@item.ProductName</strong>
                                @if (item.IsDuplicate)
                                {
                                    <span class="badge bg-warning text-dark ms-2">Duplikat</span>
                                }
                            </td>
                            <td class="text-primary font-monospace">
                                @(item.IdOnAllegro ?? "-")
                            </td>
                            <td>@(item.Ean ?? "-")</td>
                            <td>
                                @(item.MarginPrice.HasValue? item.MarginPrice.Value.ToString("C2", new CultureInfo("pl-PL")) : "-")
                            </td>
                            <td>@item.AddedDate.ToString("yyyy-MM-dd")</td>

                            <td class="text-center">
                                @if (item.IsScrapable)
                                {
                                    <i class="fas fa-check-circle text-success"></i>
                                }
                                else
                                {
                                    <i class="fas fa-times-circle text-muted"></i>
                                }
                            </td>
                            <td class="text-center">
                                @if (item.IsRejected)
                                {
                                    <i class="fas fa-ban text-danger"></i>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>

                            <td style="word-break: break-all; font-size: 0.85em;">
                                @if (!string.IsNullOrEmpty(item.Url))
                                {
                                    <div>
                                        <a href="@item.Url" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt me-1"></i> Otwórz
                                        </a>
                                    </div>
                                    <div class="text-muted mt-1">
                                        @item.Url
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-muted small">@item.AllegroProductId</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusCheckboxes = document.querySelectorAll('.status-filter');
            const duplicateCheckbox = document.getElementById('showDuplicatesOnly');
            const urlSearchInput = document.getElementById('urlSearchInput'); // Nowy input

            const tableRows = document.querySelectorAll('#allegro-table tbody tr');
            const visibleCountSpan = document.getElementById('visible-count');
            const removeFilteredBtn = document.getElementById('remove-filtered');

            const storeNameForJs = @Json.Serialize(storeName);
            const currentStoreId = @Json.Serialize(storeId);

            function applyFilters() {
                // 1. Pobierz wybrane statusy
                const selectedStatuses = Array.from(statusCheckboxes)
                    .filter(ch => ch.checked).map(ch => ch.dataset.status);

                // 2. Pobierz stan checkboxa duplikatów
                const showOnlyDuplicates = duplicateCheckbox.checked;

                // 3. Pobierz tekst z wyszukiwarki URL (małe litery)
                const searchText = urlSearchInput.value.toLowerCase().trim();

                let visibleRowCount = 0;

                tableRows.forEach(row => {
                    if (!row.dataset.status) return;

                    const rowStatus = row.dataset.status;
                    const isDuplicate = row.dataset.isDuplicate === 'true';
                    const rowUrl = (row.dataset.url || "").toLowerCase(); // Pobieramy URL z atrybutu

                    let shouldShow = false;

                    // Logika Statusów
                    if (rowStatus === 'rejected') {
                        shouldShow = selectedStatuses.includes('rejected');
                    } else {
                        shouldShow = selectedStatuses.includes(rowStatus);
                    }

                    // Logika Duplikatów (AND)
                    if (showOnlyDuplicates && !isDuplicate) {
                        shouldShow = false;
                    }

                    // Logika Wyszukiwarki URL (AND)
                    if (searchText && !rowUrl.includes(searchText)) {
                        shouldShow = false;
                    }

                    // Finalne zastosowanie
                    if (shouldShow) {
                        row.style.display = '';
                        visibleRowCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                if (visibleCountSpan) {
                    visibleCountSpan.textContent = `(${visibleRowCount} widocznych)`;
                }
            }

            // Event Listeners
            statusCheckboxes.forEach(ch => ch.addEventListener('change', applyFilters));

            if (duplicateCheckbox) {
                duplicateCheckbox.addEventListener('change', applyFilters);
            }

            // Listener dla wyszukiwarki (reaguje na wpisywanie)
            if (urlSearchInput) {
                urlSearchInput.addEventListener('input', applyFilters);
            }

            // Logika usuwania (bez zmian)
            if (removeFilteredBtn) {
                removeFilteredBtn.addEventListener('click', () => {
                    const visibleIds = [];
                    tableRows.forEach(row => {
                        if (row.style.display !== 'none' && row.dataset.productId) {
                            visibleIds.push(parseInt(row.dataset.productId, 10));
                        }
                    });

                    if (visibleIds.length === 0) {
                        alert("Brak widocznych produktów do usunięcia.");
                        return;
                    }

                    if (!confirm(`Czy na pewno usunąć ${visibleIds.length} widocznych produktów Allegro ze sklepu ${storeNameForJs}?`)) {
                        return;
                    }

                    const removeUrl = `@Url.Action("RemoveSelectedAllegroProducts", "ProductMapping")?storeId=${currentStoreId}`;

                    fetch(removeUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(visibleIds)
                    })
                    .then(async response => {
                        const data = await response.json();
                        if (data.success) {
                            alert(`Usunięto ${data.count} produktów.`);
                            tableRows.forEach(row => {
                                if (row.dataset.productId && visibleIds.includes(parseInt(row.dataset.productId))) {
                                    row.remove();
                                }
                            });
                            applyFilters();
                        } else {
                            alert("Błąd: " + data.message);
                        }
                    })
                    .catch(err => alert("Błąd komunikacji: " + err));
                });
            }

            applyFilters();
        });
    </script>
}