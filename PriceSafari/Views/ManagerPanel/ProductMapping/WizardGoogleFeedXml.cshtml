@{
    Layout = null; // Brak layoutu – uproszczenie
    var storeId = ViewBag.StoreId ?? 0;
    // Mapowania z bazy (JSON)
    var existingMappingsJson = ViewBag.ExistingMappings as string ?? "[]";
}

<h2>Wizard Mapping - storeId=@storeId</h2>

<!-- PRZYCISK USUWANIA MAPOWAŃ (opcjonalny) -->
<form asp-action="ClearGoogleMappings"
      asp-controller="GoogleImportWizardXml"
      method="post"
      style="margin-bottom:10px;">
    <input type="hidden" name="storeId" value="@storeId" />
    <button type="submit" style="background:red; color:white; padding:6px;">
        Usuń wszystkie mapowania
    </button>
</form>

<!-- PRZYCISK do wyciągania produktów z XML (na froncie) -->
<button id="extractProducts" style="margin-top:10px;">
    Wyciągnij produkty z XML (FRONT)
</button>

<!-- Podgląd wygenerowanej listy ProductMap -->
<pre id="productMapsPreview"
     style="border:1px solid #ccc; margin-top:10px; padding:10px;">
</pre>

<!-- Przycisk do wysłania do bazy (Create/Update ProductMap) -->
<button id="saveProductMapsInDb" style="margin-top:10px;">
    Zapisz w ProductMap
</button>

<!-- Tabela z mapowaniami (Field / Xpath / Liczba / Wartość) -->
<table id="mappingTable" border="1" cellpadding="5" style="border-collapse: collapse;">
    <thead>
        <tr>
            <th>Field</th>
            <th>XPath</th>
            <th>Liczba węzłów</th>
            <th>Wartość pierwszego</th>
        </tr>
    </thead>
    <tbody>
        <!-- wypełniane dynamicznie w JS -->
    </tbody>
</table>

<div style="margin-top:10px;">
    <label>Wybierz Pole: </label>
    <select id="fieldSelector">
        <option value="ExternalId">ExternalId</option>
        <option value="Url">Url</option>
        <option value="GoogleEan">GoogleEan</option>
        <option value="GoogleImage">GoogleImage</option>
        <option value="GoogleExportedName">GoogleExportedName</option>
    </select>

    <button id="saveMapping" style="margin-left:10px;">Zapisz Mapowanie</button>
    <button id="reloadMappings" style="margin-left:10px;">Załaduj mapowania</button>
</div>

<!-- Miejsce na drzewo XML -->
<div id="xmlContainer"
     style="margin-top:20px; border:1px solid #ccc; padding:10px;">
</div>

<script>
    //------------------------------------------------------------------
    // 1) Inicjowanie
    //------------------------------------------------------------------
    let storeId = "@storeId";
    let existingMappingsJson = `@existingMappingsJson`;
    let existingMappings = [];

    try {
        if (existingMappingsJson.trim() !== "") {
            existingMappings = JSON.parse(existingMappingsJson);
        }
    } catch(e) {
        console.error("Błąd parsowania existingMappings:", e);
    }
    console.log("Mapowania z bazy (Razor):", existingMappings);

    // mappingForField => fieldName -> { xpath, nodeCount, firstValue }
    let mappingForField = {
        "ExternalId": null,
        "Url": null,
        "GoogleEan": null,
        "GoogleImage": null,
        "GoogleExportedName": null
    };

    // Wczytanie dotychczasowych mapowań
    existingMappings.forEach(m => {
        mappingForField[m.fieldName] = {
            xpath: m.localName,
            nodeCount: 0,
            firstValue: ""
        };
    });

    let proxyUrl = `/GoogleImportWizardXml/ProxyXml?storeId=${storeId}`;
    let xmlDoc = null;

    //------------------------------------------------------------------
    // 2) Pobieranie XML i tworzenie drzewka
    //------------------------------------------------------------------
    fetch(proxyUrl)
      .then(r => r.text())
      .then(xmlString => {
          let parser = new DOMParser();
          xmlDoc = parser.parseFromString(xmlString, "application/xml");
          if (xmlDoc.documentElement.nodeName === "parsererror") {
              document.getElementById("xmlContainer").innerText =
                  "Błąd parsowania XML:\n" + xmlDoc.documentElement.textContent;
              return;
          }
          buildXmlTree(xmlDoc.documentElement, "");
          applyExistingMappings();
      })
      .catch(err => {
          document.getElementById("xmlContainer").innerText =
              "Błąd pobierania XML:\n" + err;
      });

    function buildXmlTree(node, parentPath) {
        let container = document.getElementById("xmlContainer");
        if (!parentPath && container.querySelector("ul") === null) {
            let ulRoot = document.createElement("ul");
            ulRoot.appendChild(createLi(node, parentPath));
            container.appendChild(ulRoot);
        } else {
            let rootUl = container.querySelector("ul");
            rootUl.appendChild(createLi(node, parentPath));
        }
    }

    function createLi(node, parentPath) {
        let li = document.createElement("li");
        li.classList.add("xml-node");

        let nodeName = node.nodeName;
        let currentPath = parentPath ? parentPath + "/" + nodeName : "/" + nodeName;

        li.setAttribute("data-xpath", currentPath);

        let b = document.createElement("b");
        b.innerText = nodeName;
        li.appendChild(b);

        if (node.children.length === 0 && node.textContent.trim()) {
            let span = document.createElement("span");
            span.innerText = " : " + node.textContent.trim();
            li.appendChild(span);
        }

        if (node.children.length > 0) {
            let ul = document.createElement("ul");
            Array.from(node.children).forEach(child => {
                ul.appendChild(createLi(child, currentPath));
            });
            li.appendChild(ul);
        }
        return li;
    }

    // Klik w drzewo => przypisanie do field
    document.addEventListener("click", function(e){
        let el = e.target.closest(".xml-node");
        if (!el) return;
        let xPath = el.getAttribute("data-xpath");
        let selectedField = document.getElementById("fieldSelector").value;

        // Usuwamy stare highlight
        document.querySelectorAll(`.highlight-${selectedField}`).forEach(x => {
            x.classList.remove(`highlight-${selectedField}`);
        });

        let sameNodes = document.querySelectorAll(`.xml-node[data-xpath='${xPath}']`);
        sameNodes.forEach(n => n.classList.add(`highlight-${selectedField}`));

        let count = sameNodes.length;
        let firstVal = "";
        if (count > 0) {
            let sp = sameNodes[0].querySelector("span");
            if (sp) {
                firstVal = sp.innerText.replace(/^(\s*:\s*)/, "").trim();
            }
        }

        mappingForField[selectedField] = {
            xpath: xPath,
            nodeCount: count,
            firstValue: firstVal
        };
        renderMappingTable();
    });

    //------------------------------------------------------------------
    // 3) Highlight, tabela mapowań
    //------------------------------------------------------------------
    function applyExistingMappings() {
        for (let fieldName in mappingForField) {
            let info = mappingForField[fieldName];
            if (!info || !info.xpath) continue;

            let xPath = info.xpath;
            let sameNodes = document.querySelectorAll(`.xml-node[data-xpath='${xPath}']`);
            let count = sameNodes.length;
            let firstVal = "";
            if (count > 0) {
                let sp = sameNodes[0].querySelector("span");
                if (sp) {
                    firstVal = sp.innerText.replace(/^(\s*:\s*)/, "").trim();
                }
            }
            info.nodeCount = count;
            info.firstValue = firstVal;
            sameNodes.forEach(n => n.classList.add(`highlight-${fieldName}`));
        }
        renderMappingTable();
    }

    function clearAllHighlights() {
        Object.keys(mappingForField).forEach(field => {
            document.querySelectorAll(`.highlight-${field}`).forEach(el => {
                el.classList.remove(`highlight-${field}`);
            });
        });
    }

    function renderMappingTable() {
        let tbody = document.getElementById("mappingTable").querySelector("tbody");
        tbody.innerHTML = "";

        for (let fieldName in mappingForField) {
            let info = mappingForField[fieldName];
            let tr = document.createElement("tr");
            if (!info) {
                tr.innerHTML = `
                  <td>${fieldName}</td>
                  <td>-</td>
                  <td>0</td>
                  <td>-</td>
                `;
            } else {
                tr.innerHTML = `
                  <td>${fieldName}</td>
                  <td>${info.xpath || "-"}</td>
                  <td>${info.nodeCount || 0}</td>
                  <td>${info.firstValue || "-"}</td>
                `;
            }
            tbody.appendChild(tr);
        }
    }

    //------------------------------------------------------------------
    // 4) Zapis mapowań (GoogleFieldMapping) i ich przeładowanie
    //------------------------------------------------------------------
    document.getElementById("saveMapping").addEventListener("click", function(){
        let finalMappings = [];
        for (let fieldName in mappingForField) {
            let info = mappingForField[fieldName];
            if (info && info.xpath) {
                finalMappings.push({
                    fieldName: fieldName,
                    localName: info.xpath
                });
            }
        }
        fetch(`/GoogleImportWizardXml/SaveGoogleMappings?storeId=${storeId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalMappings)
        })
        .then(r => r.json())
        .then(d => alert(d.message))
        .catch(err => console.error(err));
    });

    document.getElementById("reloadMappings").addEventListener("click", function(){
        fetch(`/GoogleImportWizardXml/GetGoogleMappings?storeId=${storeId}`)
          .then(r => r.json())
          .then(data => {
              console.log("Odebrano mapowania z bazy (reload):", data);
              clearAllHighlights();
              Object.keys(mappingForField).forEach(f => mappingForField[f] = null);
              data.forEach(m => {
                  mappingForField[m.fieldName] = {
                      xpath: m.localName,
                      nodeCount: 0,
                      firstValue: ""
                  };
              });
              applyExistingMappings();
          })
          .catch(err => console.error("Błąd getGoogleMappings:", err));
    });

    //------------------------------------------------------------------
    // 5) Wyciąganie listy ProductMap (FRONT) i wysyłanie do bazy
    //------------------------------------------------------------------
    document.getElementById("extractProducts").addEventListener("click", function(){
        if (!xmlDoc) {
            alert("Nie wczytano XML!");
            return;
        }
        // Zakładamy <item>; jeśli <entry>, zmieniamy
        let items = xmlDoc.getElementsByTagName("item");
        let productMaps = [];

        for (let i = 0; i < items.length; i++) {
            let itemNode = items[i];
            // Budujemy obiekt w stylu ProductMap:
            let pm = {
                StoreId: storeId.toString(), // np. "3"
                ExternalId: getValueByField(itemNode, "ExternalId"),
                Url: getValueByField(itemNode, "Url"),
                // Pola z Ceneo (Ean, MainUrl, ExportedName) pomijamy, bo chcemy tylko Google-limited
                Ean: null,
                MainUrl: null,
                ExportedName: null,

                // Interesują nas 4:
                GoogleEan: getValueByField(itemNode, "GoogleEan"),
                GoogleImage: getValueByField(itemNode, "GoogleImage"),
                GoogleExportedName: getValueByField(itemNode, "GoogleExportedName")
            };
            productMaps.push(pm);
        }

        console.log("Wyciągnięto productMaps(front):", productMaps);
        document.getElementById("productMapsPreview").textContent =
            JSON.stringify(productMaps, null, 2);
    });

    function getValueByField(itemNode, fieldName) {
        let mapInfo = mappingForField[fieldName];
        if (!mapInfo || !mapInfo.xpath) return null;

        // "/rss/channel/item/g:id" -> obcinamy "/rss/channel/item/"
        let trimmed = mapInfo.xpath.replace("/rss/channel/item/", "");

        // Dodatkowo, jeśli trimmed zaczyna się od "g:", usuwamy "g:"
        // bo w localName jest "id", a nie "g:id"
        if (trimmed.startsWith("g:")) {
            trimmed = trimmed.substring(2); // usuwa "g:"
        }

        // Szukamy child-a w itemNode, localName == trimmed
        let child = Array.from(itemNode.children)
            .find(e => e.localName === trimmed);
        return child ? child.textContent.trim() : null;
    }

    // Zapis do bazy (np. /ProductMapping/SaveProductMapsFromFront)
    document.getElementById("saveProductMapsInDb").addEventListener("click", function(){
        let text = document.getElementById("productMapsPreview").textContent;
        if (!text) {
            alert("Brak productMaps do zapisania!");
            return;
        }
        let productMaps;
        try {
            productMaps = JSON.parse(text);
        } catch(e) {
            alert("Błędny JSON w #productMapsPreview!");
            return;
        }

        fetch("/GoogleImportWizardXml/SaveProductMapsFromFront", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(productMaps)
        })
        .then(r => r.json())
        .then(data => {
            alert("Zapisano: " + data.message);
        })
        .catch(err => console.error(err));
    });

    // Na start: pusty rendering
    renderMappingTable();
</script>

<style>
    .xml-node {
        cursor: pointer;
        margin: 3px 0;
    }

    /* Podświetlenia w zależności od field */
    .highlight-ExternalId {
        background-color: rgba(255, 0, 0, 0.1);
    }

    .highlight-Url {
        background-color: rgba(0, 255, 0, 0.1);
    }

    .highlight-GoogleEan {
        background-color: rgba(0, 0, 255, 0.1);
    }

    .highlight-GoogleImage {
        background-color: rgba(255, 165, 0, 0.1);
    }

    .highlight-GoogleExportedName {
        background-color: rgba(255, 255, 0, 0.2);
    }

    #mappingTable th, #mappingTable td {
        padding: 6px 12px;
        text-align: left;
    }
</style>
