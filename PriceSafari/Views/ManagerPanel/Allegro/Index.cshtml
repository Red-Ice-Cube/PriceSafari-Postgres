@model PriceSafari.Models.ManagerViewModels.AllegroGatherViewModel
@using PriceSafari.ScrapersControllers
@{
    ViewData["Title"] = "Panel Zbierania Ofert Allegro";
    Layout = "~/Views/Shared/_PanelLayout.cshtml";
}

<style>
    #log-container {
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 0.85em;
        background-color: #2b3035;
        color: #d8dee9;
        padding: 15px;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse; /* Nowe logi pojawiają się na górze */
    }

    .log-entry {
        margin-bottom: 5px;
        word-break: break-word;
    }

    .log-time {
        color: #88c0d0;
    }

    .log-level-INFO {
        color: #d8dee9;
    }

    .log-level-WARN {
        color: #ebcb8b;
    }

    .log-level-ERROR {
        color: #bf616a;
        font-weight: bold;
    }

    .log-level-DEBUG {
        color: #8fbcbb;
    }

    .remove-scraper-btn {
        cursor: pointer;
        color: #bf616a;
        margin-left: 10px;
        font-weight: bold;
        user-select: none; /* Zapobiega zaznaczaniu tekstu przycisku */
    }

        .remove-scraper-btn:hover {
            color: #d08770;
        }
</style>

<h1>@ViewData["Title"]</h1>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" role="alert">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger" role="alert">@TempData["ErrorMessage"]</div>
}

    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Aktywne Scrapery</h4>
            </div>
            <div class="card-body" id="scrapers-list-container">
                @if (!Model.ActiveScrapers.Any())
                {
                    <p class="text-muted">Brak aktywnych scraperów. Uruchom skrypt w Pythonie, aby się tu pojawił.</p>
                }
                @foreach (var scraper in Model.ActiveScrapers.Values.OrderBy(s => s.Name))
                {
                    <div id="scraper-@scraper.Name.ToUpper()">
                        <strong class="me-2">@scraper.Name:</strong>
                        <span class="badge @(scraper.Status == ScraperLiveStatus.Idle ? "bg-success" : (scraper.Status == ScraperLiveStatus.Offline ? "bg-secondary" : "bg-info"))">
       
                        </span>
                        @if (scraper.Status == ScraperLiveStatus.Busy)
                        {
                            <small class="ms-1 text-muted">(Pracuje nad: @scraper.CurrentTaskUsername)</small>
                        }
                        @if (scraper.Status == ScraperLiveStatus.Offline)
                        {
                            <span class="remove-scraper-btn" data-scraper-name="@scraper.Name" title="Usuń z listy">❌</span>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="card mb-2">
            <div class="card-header">
                <h4><i class="fas fa-tasks"></i> Panel Sterowania Zadaniami</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nazwa Sklepu</th>
                            <th>Nazwa Allegro</th>
                            <th>Status Zadania</th>
                            <th style="width: 150px;">Akcja</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var store in Model.ScrapableStores)
                        {
                            <tr>
                                <td>@store.StoreName</td>
                                <td>@store.StoreNameAllegro</td>
                                <td id="task-status-container-@store.StoreNameAllegro">
                                    @if (Model.ActiveTasks.TryGetValue(store.StoreNameAllegro, out var taskState))
                                    {
                                        <div>
                                            @if (taskState.Status == ScrapingStatus.Running)
                                            {
                                                <span class="spinner-border spinner-border-sm text-primary me-1" role="status" aria-hidden="true"></span>
                                            }
                                            <span class="badge @(taskState.Status == ScrapingStatus.Running ? "bg-success" : (taskState.Status == ScrapingStatus.Cancelled ? "bg-danger" : "bg-warning text-dark"))">
                                                @* Tłumaczenia zostaną wstawione przez JS *@
                                                @taskState.Status.ToString()
                                            </span>
                                            @if (!string.IsNullOrEmpty(taskState.AssignedScraperName))
                                            {
                                                <span class="badge bg-dark">@taskState.AssignedScraperName</span>
                                            }
                                            @if (taskState.CollectedOffersCount > 0)
                                            {
                                                <span class="fw-bold">(@taskState.CollectedOffersCount)</span>
                                            }
                                        </div>
                                        <small class="text-muted fst-italic">@taskState.LastProgressMessage</small>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Bezczynny</span>
                                    }
                                </td>
                                <td id="task-action-container-@store.StoreNameAllegro">
                                    @if (AllegroTaskManager.ActiveTasks.ContainsKey(store.StoreNameAllegro))
                                    {
                                        <form asp-action="CancelScraping" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="storeId" value="@store.StoreId" />
                                            <button type="submit" class="btn btn-warning btn-sm">Przerwij</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form asp-action="StartScraping" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="storeId" value="@store.StoreId" />
                                            <button type="submit" class="btn btn-primary btn-sm"> Scrapuj</button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
   

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4><i class="fas fa-list-ul"></i> Zebrane Produkty (@Model.ScrapedProducts.Count)</h4>
        <form asp-action="DeleteAllProducts" method="post" onsubmit="return confirm('Czy na pewno chcesz usunąć WSZYSTKIE zebrane produkty?');">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-danger btn-sm">Usuń Wszystkie</button>
        </form>
    </div>
    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Nazwa Produktu</th>
                    <th>Sklep</th>
                    <th>Data Dodania</th>
                    <th>Link</th>
                </tr>
            </thead>
            <tbody id="scraped-products-table-body">
                @if (Model.ScrapedProducts.Any())
                {
                    @foreach (var product in Model.ScrapedProducts)
                    {
                        <tr>
                            <td>@product.AllegroProductName</td>
                            <td>@product.Store.StoreName</td>
                            <td>@product.AddedDate.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                            <td><a href="@product.AllegroOfferUrl" target="_blank" rel="noopener noreferrer">Otwórz</a></td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="no-products-row">
                        <td colspan="4" class="text-center">Brak zebranych produktów.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const connection = new signalR.HubConnectionBuilder().withUrl("/scrapingHub").withAutomaticReconnect().build();
            const logContainer = document.getElementById('log-container');
            const maxLogEntries = 150;

              const scraperStatusNames = { 0: "Bezczynny", 1: "Zajęty", 2: "Offline", 3: "Resetowanie sieci" };
            const scraperStatusColors = { 0: "bg-success", 1: "bg-info", 2: "bg-secondary", 3: "bg-warning text-dark" };
            const taskStatusNames = { 0: "Oczekujący", 1: "Uruchomiony", 2: "Anulowane" };
            const taskStatusColors = { 0: "bg-warning text-dark", 1: "bg-success", 2: "bg-danger" };


            // --- Funkcje Pomocnicze ---
            function addLog(time, message, level) {
                if (!logContainer) return;
                const logEntry = document.createElement('p');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-level-${level}">[${level}] ${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
                logContainer.prepend(logEntry);
                if (logContainer.childElementCount > maxLogEntries) { logContainer.lastChild.remove(); }
            }

            function renderTaskStatus(container, taskState) {
                const countHtml = taskState.collectedOffersCount > 0 ? `<span class="fw-bold">(${taskState.collectedOffersCount})</span>` : '';
                const scraperHtml = taskState.assignedScraperName ? `<span class="badge bg-dark">${taskState.assignedScraperName}</span>` : '';
                const spinnerHtml = taskState.status === 1 ? '<span class="spinner-border spinner-border-sm text-primary me-1" role="status" aria-hidden="true"></span>' : '';

                container.innerHTML = `
                    <div>
                        ${spinnerHtml}
                        <span class="badge ${taskStatusColors[taskState.status]}">${taskStatusNames[taskState.status]}</span>
                        ${scraperHtml}
                        ${countHtml}
                    </div>
                    <small class="text-muted fst-italic">${taskState.lastProgressMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</small>`;
            }

            // --- Handlery Zdarzeń SignalR ---
            connection.on("ReceiveLog", addLog);

            connection.on("UpdateScraperStatus", (scraper) => {
                const container = document.getElementById('scrapers-list-container');
                let scraperDiv = document.getElementById(`scraper-${scraper.name.toUpperCase()}`);
                if (!scraperDiv) {
                    const welcomeText = container.querySelector('p');
                    if (welcomeText) welcomeText.remove();
                    scraperDiv = document.createElement('div');
                    scraperDiv.id = `scraper-${scraper.name.toUpperCase()}`;
                    container.appendChild(scraperDiv);
                }

                // Dodajemy ikonę w zależności od statusu
                let iconHtml = '';
                if (scraper.status === 1) { // Zajęty
                    iconHtml = '<span class="spinner-border spinner-border-sm text-primary me-1" role="status" aria-hidden="true"></span>';
                } else if (scraper.status === 3) { // Resetowanie sieci
                    iconHtml = '<i class="fas fa-sync-alt fa-spin me-1"></i>';
                }

                const taskText = scraper.status === 1 || scraper.status === 3 ? `(Pracuje nad: ${scraper.currentTaskUsername})` : "";
                const removeBtn = scraper.status === 2 ? `<span class="remove-scraper-btn" data-scraper-name="${scraper.name}" title="Usuń z listy">❌</span>` : '';

                scraperDiv.innerHTML = `
                    <strong class="me-2">${scraper.name}:</strong>
                    ${iconHtml}
                    <span class="badge ${scraperStatusColors[scraper.status]}">${scraperStatusNames[scraper.status]}</span>
                    <small class="ms-1 text-muted">${taskText}</small>
                    ${removeBtn}`;
            });

            connection.on("ScraperRemoved", (scraperName) => {
                const scraperDiv = document.getElementById(`scraper-${scraperName.toUpperCase()}`);
                if(scraperDiv) scraperDiv.remove();
            });

            connection.on("UpdateTaskProgress", (username, taskState) => {
                const statusContainer = document.getElementById(`task-status-container-${username}`);
                const actionContainer = document.getElementById(`task-action-container-${username}`);
                if (statusContainer) renderTaskStatus(statusContainer, taskState);
                if (actionContainer) actionContainer.innerHTML = document.getElementById(`cancel-form-template-${username}`).innerHTML;
            });

            connection.on("TaskFinished", (username) => {
                const statusContainer = document.getElementById(`task-status-container-${username}`);
                const actionContainer = document.getElementById(`task-action-container-${username}`);
                if (statusContainer) statusContainer.innerHTML = `<span class="badge bg-secondary">${taskStatusNames[0]}</span>`; // Powrót do "Bezczynny"
                if (actionContainer) actionContainer.innerHTML = document.getElementById(`start-form-template-${username}`).innerHTML;
            });

            // --- Obsługa Zdarzeń na Stronie ---
            document.getElementById('scrapers-list-container').addEventListener('click', function(e) {
                if (e.target && e.target.matches('.remove-scraper-btn')) {
                    const scraperName = e.target.dataset.scraperName;
                    if (confirm(`Czy na pewno chcesz usunąć scrapera '${scraperName}' z listy?`)) {
                        fetch(`/api/allegro-gather/remove-scraper/${scraperName}`, {
                            method: 'POST',
                            headers: { 'X-Api-Key': 'twoj-super-tajny-klucz-api-123' }
                        });
                    }
                }
            });

            // --- Uruchomienie Połączenia ---
            async function start() {
                try {
                    await connection.start();
                    addLog(new Date().toLocaleTimeString(), "Połączono z serwerem SignalR.", "DEBUG");
                } catch (err) {
                    console.error("SignalR Connection Error: ", err);
                    addLog(new Date().toLocaleTimeString(), "Błąd połączenia z SignalR. Próbuję ponownie...", "ERROR");
                    setTimeout(start, 5000);
                }
            };
            connection.onclose(async () => {
                 addLog(new Date().toLocaleTimeString(), "Połączenie z SignalR zostało zerwane. Próbuję połączyć ponownie...", "WARN");
                await start();
            });
            start();
        });
    </script>

    @foreach (var store in Model.ScrapableStores)
    {
        <template id="start-form-template-@store.StoreNameAllegro">
            <form asp-action="StartScraping" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="storeId" value="@store.StoreId" />
                <button type="submit" class="btn btn-primary btn-sm">🚀 Scrapuj</button>
            </form>
        </template>
        <template id="cancel-form-template-@store.StoreNameAllegro">
            <form asp-action="CancelScraping" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="storeId" value="@store.StoreId" />
                <button type="submit" class="btn btn-warning btn-sm">🛑 Przerwij</button>
            </form>
        </template>
    }
}